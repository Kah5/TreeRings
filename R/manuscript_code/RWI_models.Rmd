---
title: "BAI_models"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rjags)
library(ggplot2)
library(caTools)
library(ggridges)
library(tidyr)
library(reshape2)
library(dplyr)
library(cowplot)


# some initial data checking:
directory <- "Users/kah/Documents/TreeRings"
full.ghcn <- read.csv(paste0("outputs/data/rwi_age_dbh_ghcn.csv"))
hist(full.ghcn$RWI)

hist(log(full.ghcn$RWI))
```

# Separate Testing and training Datasets:

# 1. initial data cleaning & checking
# 2. create dummy variables for cohort and age classes
# 3. remove NA values for lagged RWI
# 4. add in additional climate/stand information

```{r}

summary(full.ghcn)

# get all records that have all RWI and don't have negative diams or NA diams
full.ghcn <- full.ghcn[!is.na(full.ghcn$RWI) & full.ghcn$DBH > 0 & !is.na(full.ghcn$DBH),]



#DI <- as.vector( full.ghcn$JJA.pdsi )
ageclass <- as.numeric( full.ghcn$ageclass)
Age <- as.numeric( full.ghcn$Age)
n     <- length(full.ghcn$RWI)
DBH <- full.ghcn$DBH
full.ghcn$DBH.scaled = as.vector(scale(full.ghcn$DBH, center = TRUE, scale = TRUE))
site <- full.ghcn$site
SpecCode <- full.ghcn$SpecCode


rwi.ghcn <- read.csv("outputs/full_ghcn_all_months_rwi.csv")
rwi.prism <- read.csv("outputs/full_prism_all_months_rwi.csv")


# calculate JJA VPD for each year
rwi.prism$jja.VPDmax <- rowMeans(rwi.prism[,c("Month_vpdmax_6", "Month_vpdmax_7", "Month_vpdmax_8")])
rwi.prism$jja.VPDmin <- rowMeans(rwi.prism[,c("Month_vpdmin_6", "Month_vpdmin_7", "Month_vpdmin_8")])

# calculate JJA BAL for each year
rwi.prism$jja.BAL <- rowMeans(rwi.prism[,c("Month_BAL_6", "Month_BAL_7", "Month_BAL_8")])

# calculate total precip for each year
rwi.ghcn$MAP.prism <- rowSums(rwi.prism[,c("Month_pcp_1","Month_pcp_2", "Month_pcp_3","Month_pcp_4","Month_pcp_5","Month_pcp_6", "Month_pcp_7", "Month_pcp_8", "Month_pcp_9", "Month_pcp_10", "Month_pcp_11", "Month_pcp_12")])


# get moving window of past 5, 10, 15 years of climate

prism.df <- read.csv( "outputs/full_prism_all_months.csv")

# create function to get the water year
wtr_yr <- function(df, start_month=9) {
  # Convert dates into POSIXlt
  #dates.posix = as.POSIXlt(dates)
  # Year offset
  offset = ifelse(df$month >= start_month - 1, 1, 0)
  # Water year
  adj.year = df$Year + offset
  # Return the water year
  adj.year
}


long.prism <- unique(prism.df[,c("site", "Year","PRISM_pcp_1","PRISM_pcp_2", "PRISM_pcp_3","PRISM_pcp_4","PRISM_pcp_5","PRISM_pcp_6", "PRISM_pcp_7", "PRISM_pcp_8", "PRISM_pcp_9", "PRISM_pcp_10", "PRISM_pcp_11", "PRISM_pcp_12"),]) %>%
  group_by(site, Year) %>%
  arrange(site, Year) %>% gather(key = precip, value = value, PRISM_pcp_1:PRISM_pcp_12)

long.prism$ month <- do.call(rbind, stringr::str_split(string = long.prism$precip, pattern = "_"))[,3]# get the month value
long.prism$climate <- do.call(rbind, stringr::str_split(string = long.prism$precip, pattern = "_"))[,2]# get the cliimate variable 

# use wtr_year function to get water year as a column
long.prism$wtr.year <- wtr_yr(long.prism)

# get total precipitation for each water year:
long.prism.wy.MAP <- long.prism %>% group_by(site, wtr.year) %>% summarise(MAP.wy = sum(value, na.rm=TRUE) )

colnames(long.prism.wy.MAP) <- c("site", "Year", "MAP.wy")

prism.df$MAP <- rowSums(prism.df[,c("PRISM_pcp_1","PRISM_pcp_2", "PRISM_pcp_3","PRISM_pcp_4","PRISM_pcp_5","PRISM_pcp_6", "PRISM_pcp_7", "PRISM_pcp_8", "PRISM_pcp_9", "PRISM_pcp_10", "PRISM_pcp_11", "PRISM_pcp_12")])

prism.df <- merge(prism.df, long.prism.wy.MAP, by = c("site", "Year"))
# plot wy vs map, its pretty much a 1:1 relationship, with noise, so it shouldnt change results that much
ggplot(prism.df, aes(MAP, MAP.wy, color = site))+geom_point()+geom_abline(yintercept = 0, slope = 1)

prism.df <- prism.df %>% select(-MAP) 
prism.df <- prism.df %>% rename(MAP = MAP.wy) # rename so we use WY MAP from now on

require(dplyr)
MAP.roll.means <- unique(prism.df[,c("site", "Year", "MAP"),]) %>%
  group_by(site, Year) %>%
  arrange(site, Year) %>%
  dplyr::mutate(MAP.5 = zoo::rollmean(x = MAP, 5, align = "right", fill = NA),
         MAP.10 = zoo::rollmean(x = MAP, 10, align = "right", fill = NA), 
         MAP.15 = zoo::rollmean(x = MAP, 15, align = "right", fill = NA))

colnames(MAP.roll.means) <- c("site", "year", "MAP", "MAP.5", "MAP.10", "MAP.15")


prism.df$Tmean <- rowMeans(prism.df[,c("PRISM_tavg_1","PRISM_tavg_2", "PRISM_tavg_3","PRISM_tavg_4","PRISM_tavg_5","PRISM_tavg_6", "PRISM_tavg_7", "PRISM_tavg_8", "PRISM_tavg_9", "PRISM_tavg_10", "PRISM_tavg_11", "PRISM_tavg_12")])


require(dplyr)
Tmean.roll.means <- unique(prism.df[,c("site", "Year", "Tmean"),]) %>%
  group_by(site, Year) %>%
  arrange(site, Year) %>% 
 dplyr:: mutate(Tmean.5 = zoo::rollmean(x = Tmean, 5, align = "right", fill = NA),
         Tmean.10 = zoo::rollmean(x = Tmean, 10, align = "right", fill = NA), 
         Tmean.15 = zoo::rollmean(x = Tmean, 15, align = "right", fill = NA))

colnames(Tmean.roll.means) <- c("site", "year", "Tmean", "Tmean.5", "Tmean.10", "Tmean.15")

ggplot(Tmean.roll.means, aes(year, Tmean.15, color = site))+geom_point()+geom_line()+stat_smooth()





rwi.ghcn$MAP.ghcn <- rowSums(rwi.ghcn[,c("Month_pcp_1","Month_pcp_2", "Month_pcp_3","Month_pcp_4","Month_pcp_5","Month_pcp_6", "Month_pcp_7", "Month_pcp_8", "Month_pcp_9", "Month_pcp_10", "Month_pcp_11", "Month_pcp_12")])

# make sure the prism pcp, temp values are specified in columns, so when we merge df, it won't be a huge deal:
colnames(rwi.prism)[12:59] <- paste0("prism_",colnames(rwi.prism)[12:59])
rwi.prism.sub <- rwi.prism[,!colnames(rwi.prism) %in% c("DBH", "dbhclass", "ageclass", "SpecCode", "RWI", "RWI_1", "RWI_2", "RWI_3")]
rwi.ghcn.sub <- rwi.ghcn[,!colnames(rwi.ghcn) %in% c("DBH", "dbhclass", "ageclass", "SpecCode", "RWI", "RWI_1", "RWI_2", "RWI_3")]
# merge rwi.ghcn and rwi.prism
full.clim <- merge(rwi.ghcn.sub, rwi.prism.sub, by = c("year", "site", "ID"))

# merge to full.ghcn
full.ghcn <- merge(full.ghcn, full.clim, by = c("ID", "year", "site" ))

full.ghcn$site_age <- paste0(full.ghcn$site, "-", full.ghcn$ageclass)
full.ghcn$site_age.code <- as.numeric(as.factor(full.ghcn$site_age))

# merge the lagged mean prism climates to full.ghcn
full.ghcn <- merge(full.ghcn, MAP.roll.means[,c("site", "year", "MAP.5", "MAP.10", "MAP.15")], by = c("site", "year"))

#DI <- as.vector( full.ghcn$JJA.pdsi )
ageclass <- as.numeric( full.ghcn$ageclass)
Age <- as.numeric( full.ghcn$Age)
n     <- length(full.ghcn$RWI)
DBH <- full.ghcn$DBH.x
full.ghcn$DBH.scaled = as.vector(scale(full.ghcn$DBH, center = TRUE, scale = TRUE))
site <- full.ghcn$site
SpecCode <- full.ghcn$SpecCode
plot <- unique(full.ghcn$site)

# convert Tmax to Celcius
 #full.ghcn$JUNTmax <- 5/9 * (full.ghcn$JUNTmax - 32)


# standardise predictor variables to have mean 0 and sd = 1
DI.scaled = scale(full.ghcn$JJA.pdsi, center= TRUE, scale=TRUE)
DBH.scaled = scale(full.ghcn$DBH, center= TRUE, scale=TRUE)
full.ghcn$T.scaled = as.vector(scale(full.ghcn$JUNTmax, center= TRUE, scale=TRUE))
full.ghcn$DI.scaled = as.vector(scale(full.ghcn$JJA.pdsi, center = TRUE, scale = TRUE))
full.ghcn$DBH.scaled = as.vector(scale(full.ghcn$DBH, center = TRUE, scale = TRUE))
full.ghcn$SP6.scaled = as.vector(scale(full.ghcn$SP06_6, center = TRUE, scale = TRUE))
full.ghcn$SP6.scaled = as.vector(scale(full.ghcn$SP06_6, center = TRUE, scale = TRUE))
full.ghcn$SP1.scaled = as.vector(scale(full.ghcn$SP01_6, center = TRUE, scale = TRUE))

full.ghcn$MAP.5.scaled = as.vector(scale(full.ghcn$MAP.5, center = TRUE, scale = TRUE))
full.ghcn$MAP.15.scaled = as.vector(scale(full.ghcn$MAP.15, center = TRUE, scale = TRUE))
full.ghcn$MAP.10.scaled = as.vector(scale(full.ghcn$MAP.10, center = TRUE, scale = TRUE))


full.ghcn$jja.VPDmax.scaled <- as.vector(scale(full.ghcn$jja.VPDmax, center = TRUE, scale = TRUE))
full.ghcn$jja.BAL.scaled <- as.vector(scale(full.ghcn$jja.BAL, center = TRUE, scale = TRUE))
full.ghcn$MAP.scaled = as.vector(scale(full.ghcn$MAP.prism, center = TRUE, scale = TRUE))

MAP.scaled <- scale(full.ghcn$MAP.prism, center = TRUE, scale = TRUE)
T.scaled <- scale(full.ghcn$JUNTmax, center= TRUE, scale=TRUE)
MAP.5.scaled <- scale(full.ghcn$MAP.5, center = TRUE, scale = TRUE)
MAP.15.scaled <- scale(full.ghcn$MAP.15, center = TRUE, scale = TRUE)
MAP.10.scaled<-  scale(full.ghcn$MAP.10, center = TRUE, scale = TRUE)

SP1.scaled <- scale(full.ghcn$SP01_6, center = TRUE, scale = TRUE)
SP6.scaled <- scale(full.ghcn$SP06_6, center = TRUE, scale = TRUE)



# alternative scaling-> center on site level means:
full.ghcn$prism_tmax_jja <- rowMeans(full.ghcn[, c("prism_Month_tmax_6", "prism_Month_tmax_7", "prism_Month_tmax_8")])
full.ghcn.unique <- unique(full.ghcn[, c("site", "JUNTmax", "MAP.prism", "prism_Month_tmax_6", "prism_tmax_jja", "jja.VPDmax")])
site.means <- full.ghcn.unique %>% group_by(site) %>% summarise(site.tmax = mean(JUNTmax, na.rm = TRUE),
                                                         site.sd.tmax = sd(JUNTmax, na.rm = TRUE),
                                                         site.MAP = mean(MAP.prism, na.rm = TRUE), 
                                                         site.sd.MAP = sd (MAP.prism, na.rm = TRUE),
                                                         site.DBH = mean(DBH, na.rm=TRUE), 
                                                         site.tmax.prism = mean(prism_Month_tmax_6), 
                                                         site.tmax.prism.jja = mean(prism_tmax_jja), 
                                                         site.VPDmax = mean(jja.VPDmax))


full.ghcn <- left_join(full.ghcn, site.means, by = "site")

# scale data by site means for climate variables 
full.ghcn$T.scaled2 <- (full.ghcn$JUNTmax - full.ghcn$site.tmax)/full.ghcn$site.sd.tmax
full.ghcn$MAP.scaled2 <- (full.ghcn$MAP.prism - full.ghcn$site.MAP)/full.ghcn$site.sd.MAP
full.ghcn$T.prism.scaled2 <- (full.ghcn$prism_Month_tmax_6 - full.ghcn$site.tmax.prism)/full.ghcn$site.tmax.prism
full.ghcn$T.prism.JJA.scaled2 <- (full.ghcn$prism_tmax_jja - full.ghcn$site.tmax.prism.jja)/full.ghcn$site.tmax.prism.jja
full.ghcn$jja.VPDmax.scaled2 <- (full.ghcn$jja.VPDmax - full.ghcn$site.VPDmax)/full.ghcn$site.VPDmax


ggplot(full.ghcn, aes(Year, jja.VPDmax.scaled, color = site))+geom_point()+stat_smooth(method = "lm")
ggplot(full.ghcn, aes(Year, JUNTmin, color = site))+geom_point()+stat_smooth(method = "lm")
ggplot(full.ghcn, aes(Year, MAP.scaled, color = site))+geom_point()+stat_smooth(method = "lm")


ggplot(full.ghcn, aes(T.scaled, log(RWI), color = ID))+stat_smooth(method = "lm", se = FALSE)+theme(legend.position = "none")
ggplot(full.ghcn, aes(T.prism.JJA.scaled, log(RWI), color = ageclass))+geom_point()+stat_smooth(method = "lm")
ggplot(full.ghcn, aes(T.prism.scaled, log(RWI), color = ageclass))+geom_point()+stat_smooth(method = "lm")



#full.ghcn$MAP.scaled <- (full.ghcn$MAP.prism - full.ghcn$site.MAP)/full.ghcn$site.MAP

#full.ghcn$DBH.scaled <- (full.ghcn$DBH - full.ghcn$site.DBH)/full.ghcn$site.DBH

# need to define site level structures, if not already defined:

if(! "structure" %in% colnames(full.ghcn)){
  
  structure <- data.frame(site = c("AVO","BON","COR",  "ENG",  "GLA",  "GLL1", "GLL2", "GLL3","GLL4", "HIC",  "MOU",  "PLE",  "PVC",  "STC",  "TOW", "UNC" ),
                        structure = c("Forest", "Savanna", "Forest", "Forest", "Savanna", "Forest", "Savanna", "Savanna", "Forest", "Savanna", "Forest","Savanna", "Savanna", "Savanna", "Forest", "Savanna"))
full.ghcn <- merge(full.ghcn, structure, by = "site")
}



#struct.cohort and struct.cohort.code (if it doesnt alread exist)

if(! "struct.cohort" %in% colnames(full.ghcn)){

full.ghcn$struct.cohort <- paste0(full.ghcn$ageclass,"-", full.ghcn$structure)
full.ghcn$struct.cohort.code <- ifelse(full.ghcn$struct.cohort %in% "Past-Forest", 1,
       ifelse(full.ghcn$struct.cohort %in% "Modern-Forest", 2, 
               ifelse(full.ghcn$struct.cohort %in% "Past-Savanna", 3,
                     ifelse(full.ghcn$struct.cohort %in% "Modern-Savanna", 4,"NA" ))))

}


write.csv(full.ghcn, "outputs/full.ghcn.sites.struct.before.splitting.csv", row.names = FALSE)


# omit NA values for RWI - 1:
ghcn.clean <- full.ghcn[!is.na(full.ghcn$RWI_1) & !is.na(full.ghcn$RWI_2) & !is.na(full.ghcn$DBH),]

# save ghcn.clean for later use:
saveRDS(ghcn.clean, "outputs/growth_model/ghcn.clean.full.data.rds")

# split training and testing datasets:
msk <- caTools::sample.split( ghcn.clean, SplitRatio = 3/4, group = NULL )

train.full <- ghcn.clean[msk,]
test.full <- ghcn.clean[!msk,]

# create a dataste the elimates yrs 1900-1950 for the modern and 1950-present for past:

mod.post <- ghcn.clean[ghcn.clean$ageclass %in% "Modern" & ghcn.clean$Year >= 1950,]
past.pre <- ghcn.clean[ghcn.clean$ageclass %in% "Past" & ghcn.clean$Year < 1950,]

sub.ghcn<- rbind(mod.post, past.pre)

msk <- caTools::sample.split( sub.ghcn, SplitRatio = 3/4, group = NULL )

train <- sub.ghcn[msk,]
test <- sub.ghcn[!msk,]

# get dry and wet years and separate by ageclass:
dry <- quantile(ghcn.clean$JJA.pdsi, 0.25) # value of the driest years
wet <- quantile(ghcn.clean$JJA.pdsi, 0.75) # value of the wettest years

pre.dry <- ghcn.clean[ghcn.clean$year < 1950 & ghcn.clean$Jul.pdsi <= dry & ghcn.clean$ageclass %in% "Past",]
pre.dry$class <- "pre-1950"
pre.dry$climclass <- "Dry_0.25"

post.dry <- ghcn.clean[ghcn.clean$year >=1950 & ghcn.clean$Jul.pdsi <= dry & ghcn.clean$ageclass %in% "Modern" ,]
post.dry$class <- "post-1950"
post.dry$climclass <- "Dry_0.25"

pre.wet <- ghcn.clean[ghcn.clean$year < 1950 & ghcn.clean$Jul.pdsi >= wet & ghcn.clean$ageclass %in% "Past",]
pre.wet$class <- "pre-1950"
pre.wet$climclass <- "Wet_0.25"
post.wet <- ghcn.clean[ghcn.clean$year >=1950 & ghcn.clean$Jul.pdsi >= wet & ghcn.clean$ageclass %in% "Modern" ,]
post.wet$class <- "post-1950"
post.wet$climclass <- "Wet_0.25"

# combine the pre and post dry data sets:
dry.yrs <- rbind(post.dry, pre.dry)

msk <- sample.split( dry.yrs, SplitRatio = 3/4, group = NULL )

train.dry <- dry.yrs[msk,]
test.dry <- dry.yrs[!msk,]

# now get dry years for sites where we have both ageclasses

dry.yrs.paired <- dry.yrs[!dry.yrs$site %in% c("COR","GLL4", "HIC", "PLE", "PVC", "STC", "TOW"),]
msk <- sample.split( dry.yrs.paired, SplitRatio = 3/4, group = NULL )

train.dry.pair <- dry.yrs.paired[msk,]
test.dry.pair <- dry.yrs.paired[!msk,]


#---------------Develop test and training sets for the stable isotope data-------------------
# read in the d13 data:


d13 <- read.csv("outputs/stable_isotopes/merged_d13_growth.csv")
d13 <- read.csv("outputs/stable_isotopes/merged_d13_growth_v2.csv")

d13 <- d13[!is.na(d13$DBH),]

d13 %>% group_by( site, ageclass, ID)%>% summarise(n = n(), 
                                                     iWUE.mean = mean(iWUE, na.rm =TRUE))

d13 %>% group_by(ageclass)%>% summarise(n = n(), 
                                                     iWUE.mean = mean(iWUE, na.rm =TRUE))

climate.wue <- ghcn.clean %>% dplyr::select(-ageclass)

full.iso <- merge(unique(climate.wue ), d13[,c("site", "ID", "year","Cor.d13C.suess", "iWUE", "ageclass")], by = c("site", "ID", "year"), all.y = TRUE)

full.iso %>% group_by(ageclass)%>% summarise(n = n(), 
                                                     iWUE.mean = mean(iWUE, na.rm =TRUE))


full.iso$iWUE.scaled <- as.numeric(scale(full.iso$iWUE))
d13index <- !is.na(full.ghcn$Cor.d13C.suess)

# split into testing and training:
library(caTools)
#full.iso <- full.ghcn[!is.na(full.ghcn$iWUE) & !full.ghcn$site %in% "BON",]
#full.iso <- full.ghcn
iWUE.med <- full.iso %>% group_by(struct.cohort, struct.cohort.code) %>% summarise(iWUEmean = median(iWUE, na.rm =TRUE))
full.iso %>% group_by(ageclass) %>% summarise(iWUEmean = median(iWUE, na.rm =TRUE))

full.iso<- full.iso[!is.na(full.iso$DBH),]
full.iso<- full.iso[!is.na(full.iso$ageclass),]

msk <- sample.split( full.iso, SplitRatio = 3/4, group = NULL )

train.iso <- full.iso[msk,]
test.iso <- full.iso[!msk,]

saveRDS(full.iso, 'data/full_WUE_dataset_v2.rds')
saveRDS(train.iso, 'data/train_WUE_dataset_v2.rds')
saveRDS(test.iso, 'data/test_WUE_dataset_v2.rds')

# ------read in estimates of future total precipiation & tmax to project tree growth in the future:
rcp85 <- read.csv("outputs/rcp8.5_mean_Pr_TMAX_proj_sites.csv")

# scale to the same scale as t.scaled
rcp85$Tx_50.scaled <- as.numeric(scale(rcp85$Tx_85_50GS, attr(T.scaled, "scaled:center"), attr(T.scaled, "scaled:scale")))

rcp85$Tx_70.scaled <- as.numeric(scale(rcp85$Tx_85_70GS, attr(T.scaled, "scaled:center"), attr(T.scaled, "scaled:scale")))

# scale to the same scale as MAP.scaled

#scaled.new <- scale(rcp85$Tx_85_50GS, center = mean(full.ghcn$JUNTmax), scale = attr(T.scaled, "scaled:scale"))
#scaled.new2 <- scale(rcp85$Tx_85_50GS, attr(full.ghcn$JUNTmax, "scaled:center"))

rcp85$Pr_85_50.scaled <- as.numeric(scale(rcp85$Pr_85_50, attr(MAP.scaled, "scaled:center"), attr(MAP.scaled, "scaled:scale")))
rcp85$PR_85_70.scaled <- as.numeric(scale(rcp85$Pr_85_70, attr(MAP.scaled, "scaled:center"), attr(MAP.scaled, "scaled:scale")))


if(! "structure" %in% colnames(rcp85)){
  
  structure <- data.frame(site = c("AVO","BON","COR",  "ENG",  "GLA",  "GLL1", "GLL2", "GLL3","GLL4", "HIC",  "MOU",  "PLE",  "PVC",  "STC",  "TOW", "UNC" ),
                        structure = c("Forest", "Savanna", "Forest", "Forest", "Savanna", "Forest", "Savanna", "Savanna", "Forest", "Savanna", "Forest","Savanna", "Savanna", "Savanna", "Forest", "Savanna"))
rcp85 <- merge(rcp85, structure, by = "site")

}
rcp85$ageclass <- "Modern"

if(! "struct.cohort" %in% colnames(rcp85)){

rcp85$struct.cohort <- paste0(rcp85$ageclass,"-", rcp85$structure)
rcp85$struct.cohort.code <- ifelse(rcp85$struct.cohort %in% "Past-Forest", 1,
       ifelse(rcp85$struct.cohort %in% "Modern-Forest", 2, 
               ifelse(rcp85$struct.cohort %in% "Past-Savanna", 3,
                     ifelse(rcp85$struct.cohort %in% "Modern-Savanna", 4,"NA" ))))

}

```



## Initial bayesian linear regression of climate on Basal Area Index
# this model assumes all trees across all species + sites + forest types have the same relationship with PDSI
```{r}

# population model for the response of each BAI to each year of climate:
population_model <- "model{

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1 +  beta2*DI.scaled[i] + beta3*DBH.scaled[i] +  beta4*T.scaled[i] 



}

# Assume normal priors for betas (because they could be negative or positive)

beta1 ~ dnorm(0, 0.001)
beta2 ~ dnorm(0, 0.001)
beta3 ~ dnorm(0,0.001)
beta4 ~ dnorm(0,0.001)


# Non-informative Prior for the inverse variances
inv.var   ~ dgamma(0.01, 0.01)
sigma     <- 1/sqrt(inv.var)


for(i in 1:np){
# process model
Yp[i]   ~ dnorm(gfuncp[i], inv.var) # where Yi is already log transformed

# function g()
gfuncp[i] <- beta1 +  beta2*DI.scaled.p[i] + beta3*DBH.scaled.p[i] + beta4*T.scaled.p[i] # use Drought index


}


}"


# fit jags model:
reg.model.age <- jags.model(textConnection(population_model), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled,T.scaled = train$T.scaled, np = length(test$RWI), DI.scaled.p = test$DI.scaled, DBH.scaled.p = test$DBH.scaled, T.scaled.p = test$T.scaled), n.chains = 3)

update(reg.model.age, 1000); # Burnin for 1000 samples to start, then go higher later

# get samples
samp <- coda.samples(reg.model.age, 
                     variable.names=c("beta1", "beta2", "beta3", "beta4", "sigma", "Yp"), 
                    n.chains = 3, n.iter=2000)

gelman.diag(samp)
traceplot(samp)
# this still does it for Y as well
dic.full <- dic.samples(reg.model.age, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/basic_reg_DIC.rds")

#Extract the samples for each parameter

 samps       <- samp[[1]]
 Yp.samps    <- samps[,1:length(test$X)] 
 alpha.samps <- samps[,(length(test$X)+1)]
 beta.samps  <- samps[,(length(test$X)+2):((length(test$X)+4))]
 sigma.samps <- samps[,(length(test$X)+5)]

 
# caluculate 95% CI for alpha and beta samps 
alpha.025 <- quantile(alpha.samps, 0.025)
alpha.975 <- quantile(alpha.samps, 0.975)
beta1.025 <- quantile(beta.samps[,1], 0.025)
beta1.975 <- quantile(beta.samps[,1], 0.975)
beta2.025 <- quantile(beta.samps[,2], 0.025)
beta2.975 <- quantile(beta.samps[,2], 0.975)



a <- data.frame('alpha' = alpha.samps, 'beta.drought' = beta.samps[,1], 'Beta.dbh' = beta.samps[,2], 'Beta.JunT' = beta.samps[,3])
colnames(a)<- c("alpha", "beta.drought", "beta.dbh", "beta.temp")
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))

# make dot + 95% CI plots for each param
a.mplots <- ggplot(a.m, aes(value, color = variable))+geom_density(alpha = 0.5)+theme_black()

a.m.mean <- apply(as.matrix(a[,1:4]), 2, mean)
a.m.lower <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
a.m.upper <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.a.m <- data.frame(a.m.mean, a.m.lower, a.m.upper)

#plot.dat.a.m$class <- row.names(plot.dat.a.m)

a.m.dots <- ggplot(plot.dat.a.m, aes(x = a.m.mean, y = row.names(plot.dat.a.m)))+geom_errorbarh( xmin = a.m.lower, xmax = a.m.upper,height = 0, size = 2)+geom_point(size = 3)+geom_vline(xintercept = 0, linetype = "dashed")+coord_flip()+theme(legend.position = "none")+xlab("Parameter Estimates")+ylab("Parameters")+theme_bw()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg/Parameter_estimates.png")
a.m.dots
dev.off()

# plot predicted vs. observed
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/basic_reg/pred_vs_obs.png")
p.o.plot
dev.off()

# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "basic_reg", 
         model.structure = "beta1 +  beta2*DI.scaled[i] + beta3*DBH.scaled[i] +  beta4*T.scaled[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

#write summary out for later comparison
write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)



# Compute the posterior mean for the plug-in predictions  

 beta.mn  <- colMeans(beta.samps)
 sigma.mn <- mean(sigma.samps)
 alpha.mn <- mean(alpha.samps) 
 
 plot(colMeans(exp(Yp.samps)), test$RWI)
 abline(a = 0, b = 1, col = "red")

 
  DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.25)
  DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.25)
 
 # something like:
 Xp <- expand.grid(DIprobe, DBHprobe)
 #Xp <- as.matrix(Xp)
# Plot the Posterior Predictive Density and plug-in
np <- length(Xp$Var1)
ypred <- list()
 for(j in 1:np){

   # PPD
   #plot(density(Yp.samps[,j]),xlab="Y",main="PPD")

   # Plug-in
   mu <- alpha.mn+sum(Xp[j,]*beta.mn)
   ypred[[j]]  <- rnorm(20000, mu, sigma.mn)
   
    
  
   # Truth
   #abline(v=mean(ypred),col=3,lwd=2)

   #legend("topright",c("PPD","Plug-in","Truth"),col=1:3,lty=1,inset=0.05)
}

ypred.df <- data.frame(do.call(rbind, ypred))

Xp$MeanY <- exp(rowMeans(ypred.df)) # get the means of the posterior to plot the overall effects of DBH + DI on predicted growth

# Todo: unscale Drought and DBH indices

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg/Ypred_by_drought.png")
ggplot(Xp, aes(Var1, MeanY, color = Var2))+geom_point()+xlab("Drought Index")+ylab("predicted growth")
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg/Ypred_by_DBH.png")
ggplot(Xp, aes(Var2, MeanY))+geom_point()+xlab("DBH Index")+ylab("predicted growth")
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg/Ypred_by_drought_DBH.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)
dev.off()

#set.seed(13)
m <- 10000
chains <- samp[[1]][,1:4]
chains2 <- samp[[2]][,1:4]

postDraws <- chains[sample(nrow(chains),size=m,replace=TRUE),]



# Sample m draws of y.rep (n obs each) from likelihood p(y|theta), using thetas sampled above. Approximates posterior predictive distribution p(y.rep|y)
n <- nrow(full.ghcn)
y.rep <- matrix(NA, nrow=n, ncol=m)
for (i in 1:m){
  y.rep[,i] <- rnorm(n = n, postDraws[i,"fit"], postDraws[i,"fit.new"])
}

# check to see if the predicted yrep alighs with data y max
T1.y <- max(Y)
T1.yrep <- apply(y.rep, 2, max)
hist(T1.yrep)


abline(v=T1.y,col="red",lwd=2)


pppval.max <- sum(T1.yrep>=T1.y)/m
print(pppval.max)

# quick check to see how params compare to OLS 
summary(lm(Y ~ full.ghcn$DI.scaled))

# plot mcmc + the parameter distn
coda:::plot.mcmc(samp)
samp.basic.reg <- samp
# save a data frame with beta2 sensitivity and the 
samp.basic.reg.df <- summary(samp)
  
samp.basic.df.sum<- data.frame(mean = samp.df$statistics[2,"Mean"], 
           ci.low = samp.df$quantiles[2,"2.5%"], 
           ci.high = samp.df$quantiles[2,"97.5%"])
  


```

# Model random effects for sites for slopes and intercepts
```{r}

population_model_site_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[SITE[i]] + beta2[SITE[i]]*DI.scaled[i] + beta3[SITE[i]]*DBH.scaled[i]   # use Drought index as a scaled variable 

#res[i] <- Y[i] - gfunc[i]   
#emp.new[i] ~ dnorm(gfunc[i], sigma)
#res.new[i] <- emp.new[i] - gfunc[i]
}



# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(S)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
}

# use normal hyperpriors for each hyperparamters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.0001, 0.0001)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.001, 0.001)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.001, 0.001)
sigma_beta3 <- 1/sqrt(inv_beta3)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)

# predicted Y's
for(i in 1:np){
# process model
Yp[i]   ~ dnorm(gfuncp[i], inv.var) # where Yi is already log transformed

# function g()
gfuncp[i] <- beta1[SITEp[i]] + beta2[SITEp[i]]*DI.scaled.p[i] + beta3[SITEp[i]]*DBH.scaled.p[i]   # use Drought index as a scaled variable 

}




}"





reg.model.by_s <- jags.model(textConnection(population_model_site_re), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled, SITE = as.numeric(train$site_age.code), S = unique(train$site_age.code), np = length(test$RWI), DI.scaled.p = test$DI.scaled, DBH.scaled.p = test$DI.scaled,SITEp = as.numeric(test$site_age.code)), n.chains = 3, n.adapt = 100)

update(reg.model.by_s, 1000); # Burnin for 1000 samples to start, then go higher later

samp.plot.re <- coda.samples(reg.model.by_s, 
                     variable.names=c("beta1", "beta2","beta3","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3", "Yp"), 
                    n.chains = 3, n.iter=3000)


dic.full <- dic.samples(reg.model.by_s, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/basic_reg_site_re_DIC.rds")

#summary(samp.plot.re)
#plot(samp.plot.re)

#gelman.diag(samp.plot.re)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.plot.re[[1]]
 Yp.samps    <- samps[,1:length(test$X)] 
 alpha.samps <- samps[,(length(test$X)+1): (length(test$X)+25)]
 beta.samps  <- samps[,(length(test$X)+26):((length(test$X)+75))]
 sigma.samps <- samps[,(length(test$X)+76)]

 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs.r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/basic_reg_cohort_re/pred_vs_obs.png")
p.o.plot
dev.off()

# calculate MSE & BIAS:

# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)
# write model summary output to a file!

model.summary <- data.frame(model = "basic_reg_site_re", 
                            model.structure = "beta1[SITE[i]] + beta2[SITE[i]]*DI.scaled[i] + beta3[SITE[i]]*DBH.scaled[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)




# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(unique(full.ghcn$site_age)[order(unique(full.ghcn$site_age.code))]))
a$num <- rownames(a)
 
a.m <- melt(a, id.vars=c("num"))
split.list <- strsplit(as.character(a.m$variable),split = "-")
split.list.df <- do.call(rbind, split.list)
a.m$site <- split.list.df[,1]
a.m$ageclass <- split.list.df[,2]
alpha.mplots <- ggplot(a.m, aes(value, fill = ageclass))+geom_density(alpha = 0.5)+theme_black()+xlab("Random Intercepts")+facet_wrap(~site)


b2 <- data.frame(beta.samps[,1:25])
colnames(b2) <- c(paste0(unique(full.ghcn$site_age)[order(unique(full.ghcn$site_age.code))]))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.m <- melt(b2, id.vars=c("num"))
split.list <- strsplit(as.character(b2.m$variable),split = "-")
split.list.df <- do.call(rbind, split.list)
b2.m$site <- split.list.df[,1]
b2.m$ageclass <- split.list.df[,2]
b2.mplots <- ggplot(b2.m, aes(value, fill = ageclass))+geom_density(alpha = 0.5)+theme_black()+xlab("Drought Index sensitivity")+facet_wrap(~site)


b2.mplots <-ggplot(b2.m, aes(value,1, fill = ageclass))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 18)+scale_fill_manual(values = c("Past"='#d73027',
"Modern"='#4575b4'))+facet_wrap(~site)

b2.mean <- apply(as.matrix(b2[,1:25]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:25]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:25]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
split.list <- strsplit(as.character(row.names(plot.dat.b2)),split = "-")
split.list.df <- do.call(rbind, split.list)
plot.dat.b2$site <- split.list.df[,1]
plot.dat.b2$ageclass <- split.list.df[,2]
#plot.dat.b2$class <- row.names(plot.dat.b2)
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels = c("Past", "Modern"))

b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='#d73027',
"Modern"='#4575b4'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")+facet_wrap(~site)

png(height = 4, width = 8, units = "in", res= 300, "outputs/growth_model/basic_reg_site_re/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots, b2.mplots+coord_flip() +xlim(-0.01, 0.075)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()))
dev.off()
 
 
 
# Compute the posterior mean for the plug-in predictions  

 beta1.mn  <- colMeans(beta1.samps)
 beta2.mn  <- colMeans(beta2.samps)
 sigma.mn <- mean(sigma.samps)
 alpha1.mn <- colMeans(alpha.samps) 


# Plot the Posterior Predictive Density and plug-in
# want to plaot posteror predictive distributions:
 
# can probe either within the JAGS model or in R after the model runs:
 # specify "x probe" values for DBH + DI:
 #xprobe <- matrix(rep(-2.102618, 3.321394))
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe, site = 1:16)
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:





 Xp <- full.probe
 np <- length(Xp$Var1)
 ypred <- list()
 for(j in 1:np){

   # PPD
   #plot(density(Yp.samps[,j]),xlab="Y",main="PPD")

   
   mu <- alpha1.mn[Xp[j,3]] + beta1.mn[Xp[j,3]]*Xp[j,1] + beta2.mn[Xp[j,3]]*Xp[j,2]   # use
   #mu <- alpha1.mn+sum(Xp[j,1]*beta1.mn, Xp[j,2]*beta2.mn)
   ypred[[j]]  <- rnorm(20000, mu, sigma.mn)
  # lines(density(y),col=2)

   # Truth
   #abline(v=Y[j],col=3,lwd=2)

   #legend("topright",c("PPD","Plug-in","Truth"),col=1:3,lty=1,inset=0.05)
}

ypred.df <- do.call(rbind, ypred)

Xp$MeanY <- exp(rowMeans(ypred.df)) # get the means of the posterior to plot the overall effects of D
#DBH + DI on predicted growth

# Todo: unscale Drought and DBH indices

png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/basic_reg_site_re/Ypred_by_drought_site.png")
ggplot(Xp, aes(Var1,MeanY, color = as.factor(site)))+geom_point()+xlab("Drought Index")+ylab("predicted growth")
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_site_re/Ypred_by_DBH.png")
ggplot(Xp, aes(Var2,MeanY,color = as.factor(site)))+geom_point()+xlab("DBH Index")+ylab("predicted growth")
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_site_re/Ypred_by_drought_DBH_site.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~as.factor(site))
dev.off()

# since site 10 is variable, remove:

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_site_re/Ypred_by_drought_DBH_site_site_10_omitted.png")
ggplot(Xp[Xp$site != 10,], aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~as.factor(site))
dev.off()


```


#this is a model with cohort effects and re effects @ the cohort level rather than the site level:

```{r}



# this model is specified in basically the same as the site level model, but we replace site with "cohort"
population_model_cohort_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[cohort[i]] + beta2[cohort[i]]*DI.scaled[i] + beta3[cohort[i]]*DBH.scaled[i]   # use Drought index as a scaled variable 


r1[i] <- Y[i] - gfunc[i]   
}

RSS[1] <- sum(r1^2)

# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(c in 1:length(C)){
beta1[c] ~ dnorm(mu_beta1, inv_beta1)
beta2[c] ~ dnorm(mu_beta2, inv_beta2)
beta3[c] ~ dnorm(mu_beta3, inv_beta3)

r2[c] <- beta1[c] - mu_beta1
r3[c] <- beta2[c] - mu_beta2
r4[c] <- beta3[c] - mu_beta3
}


RSS[2] <- sum(r2^2)
RSS[3] <- sum(r3^2)
RSS[4] <- sum(r4^2)

# use normal hyperpriors for each hyperparamters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.001, 0.001)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.001, 0.001)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.001, 0.001)
sigma_beta3 <- 1/sqrt(inv_beta3)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)



  
# Contrasts:
    betadiff <- beta2[1]-beta2[2] # difference in modes of pitcher and 1st base positions
    #betadiffProb <- step(betadiff) # returns a 1 if c1Minusc3 > 0


# get Ypred for test data:
for(i in 1:np){
Yp[i]   ~ dnorm(gfuncp[i], inv.var) # where Yi is already log transformed

# function g()
gfuncp[i] <- beta1[cohort.p[i]] + beta2[cohort.p[i]]*DI.scaled.p[i] + beta3[cohort.p[i]]*DBH.scaled.p[i]   # use Drought index as a scaled variable 

}


}"






reg.model.by_age <- jags.model(textConnection(population_model_cohort_re), 
                    data = list(Y= log(train$RWI), n=length(train$RWI), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled, cohort = as.numeric(train$ageclass), C = unique(train$ageclass), np=length(train$year), DI.scaled.p = train$DI.scaled, DBH.scaled.p = train$DBH.scaled, cohort.p = as.numeric(train$ageclass)), n.chains = 3, n.adapt = 100)


update(reg.model.by_age, 1000); # Burnin for 1000 samples to start, then go higher later

samp.age.re <- coda.samples(reg.model.by_age, 
                     variable.names=c("beta1", "beta2","beta3","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3", "betadiff", "Yp", "RSS[1]", "RSS[2]", "RSS[3]", "RSS[4]"), 
                    n.chains = 3, n.iter=2000, thin = 10)

dic.full <- dic.samples(reg.model.by_age, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/basic_reg_cohort_re_DIC.rds")


#summary(samp.age.re)
#plot(samp.age.re)

#gelman.diag(samp.age.re)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.age.re[[1]]
 RSS <- samps[,1:5]
 samps <- samps[,5:(length(test$year)+15)]
 Yp.samps    <- samps[,1:length(test$year)] 
 alpha.samps <- samps[,(length(test$year)+1):(length(test$year)+2)] # one alpha for each of 16 sites
 beta1.samps  <- samps[,(length(test$year)+3):(length(test$year)+4)]
 beta2.samps <- samps[,(length(test$year)+5):(length(test$year)+6)]
 beta.diff.samps <- samps[,(length(test$year)+7)]
 sigma.samps <- samps[,(length(test$year)+8)]
 sigma_betas <- samps[,(length(test$year)+9):(length(test$year)+11)]

 #RSS:
  rss0 <- function(x) crossprod(x-mean(x))
## Data level
1-mean(RSS[,1])/rss0(Y)
1-mean(RSS[,2])/rss0(Y)
1-mean(RSS[,3])/rss0(Y)
1-mean(RSS[,4])/rss0(Y)
1-mean(RSS[,5])/rss0(Y)
## Group level
1-mean(RSS[,2])/mean(apply(alpha.samps, 1, rss0))
1-mean(RSS[,3])/mean(apply(beta1.samps, 1, rss0))

# plot predicted vs. observed test data:
 png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/basic_reg_cohort_re/Ypred_vs_obs.png")
 plot(colMeans(exp(Yp.samps)), test$RWI, xlab = "Mean Posterior Predicted Growth", ylab = "Observed Tree Ring Growth")
 abline(a = 0, b = 1, col = "red")
 dev.off()
 
 
 
 # plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps))~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/basic_reg_cohort_re/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "basic_reg_cohort_re", 
                            model.summary = "beta1[cohort[i]] + beta2[cohort[i]]*DI.scaled[i] + beta3[cohort[i]]*DBH.scaled[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)

 
png("outputs/growth_model/basic_reg_cohort_re/marginal_alphas.png")
par(mfrow=c(1,3))
hist(alpha.samps[,1], main = "alpha Forest")
hist(alpha.samps[,2], main = "alpha Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/basic_reg_cohort_re/marginal_beta1s.png")
par(mfrow=c(1,3))
hist(beta1.samps[,1], main = "beta2 Forest")
hist(beta1.samps[,2], main = "beta2 Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()


png("outputs/growth_model/basic_reg_cohort_re/marginal_beta1_diff.png")

hist(beta1.diffs, main = "Difference between savanna and forest beta1")
abline(v=0,col="red")
dev.off()

png("outputs/growth_model/basic_reg_cohort_re/marginal_beta2s.png")
par(mfrow=c(1,3))
hist(beta2.samps[,1], main = "beta3 Forest")
hist(beta2.samps[,2], main = "beta3 Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0("alpha-",c("Modern", "Past")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_black()+xlab("Random Intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c("Modern", "Past")))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_black()+xlab("Drought Index sensitivity")


b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 18)+scale_fill_manual(values = c("Past"='#d73027',
"Modern"='#4575b4'))

b2.mean <- apply(as.matrix(b2[,1:2]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:2]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:2]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)
plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c("Past", "Modern"))

b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.01, 0.075)+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='#d73027',
"Modern"='#4575b4'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

png(height = 4, width = 8, units = "in", res= 300, "outputs/growth_model/basic_reg_cohort_re/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots, b2.mplots+coord_flip() +xlim(-0.01, 0.075)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()))
dev.off()


b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0("beta3-",c("Modern", "Past")))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_black()+xlab("DBH Index sensitivity")

library(cowplot)
png(width = 4, height = 6, units = "in", res = 300, "outputs/growth_model/basic_reg_cohort_re/param_marginal_distn_by_struct.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots, ncol = 1)
dev.off()

 
# Compute the posterior mean for the plug-in predictions  

 beta1.mn  <- colMeans(beta1.samps)
 beta2.mn  <- colMeans(beta2.samps)
 sigma.mn <- mean(sigma.samps)
 alpha1.mn <- colMeans(alpha.samps) 


# Plot the Posterior Predictive Density and plug-in
# want to plaot posteror predictive distributions:
 
# can probe either within the JAGS model or in R after the model runs:
 # specify "x probe" values for DBH + DI:
 #xprobe <- matrix(rep(-2.102618, 3.321394))
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  cohort= 1:2)
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:





 Xp <- full.probe
 np <- length(Xp$Var1)
 ypred <- list()
 for(j in 1:np){

   # PPD
   #plot(density(Yp.samps[,j]),xlab="Y",main="PPD")

   
   mu <- alpha1.mn[Xp[j,3]] + beta1.mn[Xp[j,3]]*Xp[j,1] + beta2.mn[Xp[j,3]]*Xp[j,2]   # use
   #mu <- alpha1.mn+sum(Xp[j,1]*beta1.mn, Xp[j,2]*beta2.mn)
   ypred[[j]]  <- rnorm(20000, mu, sigma.mn)
  # lines(density(y),col=2)

   # Truth
   #abline(v=Y[j],col=3,lwd=2)

   #legend("topright",c("PPD","Plug-in","Truth"),col=1:3,lty=1,inset=0.05)
}

ypred.df <- do.call(rbind, ypred)

Xp$MeanY <- exp(rowMeans(ypred.df)) # get the means of the posterior to plot the overall effects of 
Xp$cohort <- ifelse(Xp$cohort == 1, "Past", "Modern")
#DBH + DI on predicted growth

# Todo: unscale Drought and DBH indices

png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/basic_reg_cohort_re/Ypred_by_drought_site_cohort.png")
ggplot(Xp, aes(Var1,MeanY, color = as.factor(cohort)))+geom_point()+xlab("Drought Index")+ylab("predicted growth")
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_cohort_re/Ypred_by_DBH_cohort.png")
ggplot(Xp, aes(Var2,MeanY,color = as.factor(cohort)))+geom_point()+xlab("DBH Index")+ylab("predicted growth")+theme_black()
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_cohort_re/Ypred_by_drought_DBH_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~as.factor(cohort))+theme_black()
dev.off()


```


#this is a model with structure effects and re effects @ the structure (forest vs. savanna) level rather than the site level:

```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
population_model_structure_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[structure[i]] + beta2[structure[i]]*DI.scaled[i] + beta3[structure[i]]*DBH.scaled[i]   # use Drought index as a scaled variable 

res[i] <- Y[i] - gfunc[i]   
emp.new[i] ~ dnorm(gfunc[i], sigma)
res.new[i] <- emp.new[i] - gfunc[i]
}



# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
}

# use normal hyperpriors for each hyperparamters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


for(i in 1:np){
# process model
Yp[i]   ~ dnorm(gfuncp[i], inv.var) # where Yi is already log transformed

# function g()
gfuncp[i] <- beta1[structure.p[i]] + beta2[structure.p[i]]*DI.scaled.p[i] + beta3[structure.p[i]]*DBH.scaled.p[i]   # use Drought index as a scaled variable 

}




}"





reg.model.by_structure <- jags.model(textConnection(population_model_structure_re), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled, structure = as.numeric(train$structure), SF = unique(train$structure), np=length(test$year), DI.scaled.p = test$DI.scaled, DBH.scaled.p = test$DBH.scaled, structure.p = as.numeric(test$structure)), n.chains = 3, n.adapt = 100)

update(reg.model.by_structure, 1000); # Burnin for 1000 samples to start, then go higher later

samp.structure.re <- coda.samples(reg.model.by_structure, 
                     variable.names=c("beta1", "beta2","beta3","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3", "Yp"), 
                    n.chains = 3, n.iter=20000, thin = 15)


dic.full <- dic.samples(reg.model.by_structure, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/basic_reg_structure_re_DIC.rds")


# not run b/c takes too long with Yp as outputs
#summary(samp.structure.re)
#plot(samp.structure.re)

#gelman.diag(samp.structure.re)
#acfplot(samp.structure.re)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.re[[1]]
 saveRDS(samps, "outputs/growth_model/basic_reg_structure_re/samps.rds")
 Yp.samps    <- samps[,1:length(test$site)] 
 alpha.samps <- samps[,(length(test$site)+1):(length(test$site)+2)] # one alpha for each of 16 sites
 beta1.samps  <- samps[,(length(test$site)+3):(length(test$site)+4)]
 beta2.samps <- samps[,(length(test$site)+5):(length(test$site)+6)]
 sigma.samps <- samps[,(length(test$site)+7)]
 sigma_betas <- samps[,(length(test$site)+8):(length(test$site)+10)]
 
 # derived quantities:
 beta1.diffs <- beta1.samps[,1] - beta2.samps[,2]
hist(beta1.diffs)


 # plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value), 0.975),
                                                 ci.lo = quantile(exp(value), 0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps))~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/basic_reg_structure_re/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "basic_reg_structure_re", 
                            model.summary = "beta1[structure[i]] + beta2[structure[i]]*DI.scaled[i] + beta3[structure[i]]*DBH.scaled[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


 
# plot marginal distributions of each parameter:

png("outputs/growth_model/basic_reg_structure_re/marginal_alphas.png")
par(mfrow=c(1,3))
hist(alpha.samps[,1], main = "alpha Forest")
hist(alpha.samps[,2], main = "alpha Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/basic_reg_structure_re/marginal_beta1s.png")
par(mfrow=c(1,3))
hist(beta1.samps[,1], main = "beta2 Forest")
hist(beta1.samps[,2], main = "beta2 Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()


png("outputs/growth_model/basic_reg_structure_re/marginal_beta1_diff.png")

hist(beta1.diffs, main = "Difference between savanna and forest beta1")
abline(v=0,col="red")
dev.off()

png("outputs/growth_model/basic_reg_structure_re/marginal_beta2s.png")
par(mfrow=c(1,3))
hist(beta2.samps[,1], main = "beta3 Forest")
hist(beta2.samps[,2], main = "beta3 Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0("alpha-",c("Forest", "Savanna")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+theme_black()+xlab("random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0("beta2-",c("Forest", "Savanna")))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+theme_black()+xlab("Drought slopes")


b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0("beta3-",c("Forest", "Savanna")))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+theme_black()+xlab("DBH random slopes")

library(cowplot)
png(width = 4, height = 6, units = "in", res = 300, "outputs/growth_model/basic_reg_structure_re/param_marginal_distn_by_struct.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots, ncol = 1)
dev.off()


# Compute the posterior mean for the plug-in predictions  

 beta1.mn  <- colMeans(beta1.samps)
 beta2.mn  <- colMeans(beta2.samps)
 sigma.mn <- mean(sigma.samps)
 alpha1.mn <- colMeans(alpha.samps) 


#AVESD1 <- mean(post_sd1)
#COV1   <- mean(Ytest>post_low1 & Ytest<post_high1)

# Plot the Posterior Predictive Density and plug-in
# want to plaot posteror predictive distributions:
 
# can probe either within the JAGS model or in R after the model runs:
 # specify "x probe" values for DBH + DI:
 #xprobe <- matrix(rep(-2.102618, 3.321394))
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  structure= 1:2)
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:





 Xp <- full.probe
 np <- length(Xp$Var1)
 ypred <- list()
 for(j in 1:np){

   # PPD
   #plot(density(Yp.samps[,j]),xlab="Y",main="PPD")

   
   mu <- alpha.samps[,Xp[j,3]] + beta1.samps[,Xp[j,3]]*Xp[j,1] + beta2.samps[,Xp[j,3]]*Xp[j,2]   # use
   #mu <- alpha1.mn+sum(Xp[j,1]*beta1.mn, Xp[j,2]*beta2.mn)
   ypred[[j]]  <- mu #rnorm(20000, mu, sigma.mn)
  
}

ypred.df <- do.call(rbind, ypred)
y.df <- as.data.frame(ypred.df)
Xp$MeanY <- exp(rowMeans(ypred.df)) # get the means of the posterior to plot the overall effects of 
Xp$structure <- ifelse(Xp$structure == 1, "Forest", "Savanna")
Xp$number <- rownames(Xp)

y.df$number <- 1:length(y.df$V1)
y.df <- merge(Xp, y.df, by = "number")


y.df.m <- melt(y.df, id.vars = c("number", "Var1", "Var2", "structure"))


ggplot(y.df.m, aes(Var1, value, col = structure))+geom_boxplot()

#DBH + DI on predicted growth
png("outputs/growth_model/basic_reg_structure_re/predicted_y.png")
#par(mfrow = c(1,2))
plot(density(ypred.df), main = "Ypred, line = Ydata")
abline(v = mean(Y), col = "red")

#plot(density(d13pred.df), main = "d13pred, line = d13data")
#abline(v= mean(d13$Cor.d13C.suess), col = "red")
dev.off()
# Todo: unscale Drought and DBH indices

png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/basic_reg_structure_re/Ypred_by_drought_structure.png")
ggplot(Xp, aes(Var1,MeanY, color = as.factor(structure)))+geom_point()+xlab("Drought Index")+ylab("predicted growth")


dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_structure_re/Ypred_by_DBH_structure.png")
ggplot(Xp, aes(Var2,MeanY,color = as.factor(structure)))+geom_point()+xlab("DBH Index")+ylab("predicted growth")
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_structure_re/Ypred_by_drought_DBH_structure.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~as.factor(structure))
dev.off()


```



model with site or stand structure by ageclass as the factor to take random effects on:
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
population_model_structure_x_cohort_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i]   # use Drought index as a scaled variable 

#r1[i] <- Y[i] - gfunc[i]   

}

#RSS[1] <- sum(r1^2)

# Prediction
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] 
  }

# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)

#r2[s] <- a[j] - mu_beta1
}
#RSS[2] <- sum(r2^2)


# use normal hyperpriors for each hyperparamters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)






}"



# should be the same test and training datasets, but save here anyways
saveRDS(train, "outputs//growth_model/basic_reg_struct_x_cohort_re/train.rds")
saveRDS(test, "outputs//growth_model/basic_reg_struct_x_cohort_re/test.rds")

# generate fake data to predict on:
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  struct.cohort= 1:4)
 Xp <- full.probe
 np <- length(Xp$Var1)


 
 # run the model:
reg.model.by_structure_x_cohort <- jags.model(textConnection(population_model_structure_x_cohort_re), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled, struct.cohort = as.numeric(train$struct.cohort.code), SF = unique(train$struct.cohort.code), np = length(test$DBH.scaled),
   struct.cohort.p = as.numeric(test$struct.cohort.code), DBH.scaled.p = test$DBH.scaled, DI.scaled.p = test$DI.scaled), n.chains = 3, n.adapt = 100)

update(reg.model.by_structure_x_cohort, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(reg.model.by_structure_x_cohort, 
                     variable.names=c("beta1", "beta2","beta3","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3", "Yp"), 
                    n.chains = 3, n.iter=20000, thin = 15)


dic.full <- dic.samples(reg.model.by_structure_x_cohort, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/basic_reg_struct_x_cohort_re_DIC.rds")

# check for convergence (not run, but checked)
#summary(samp.structure.cohort.re)
#plot(samp.structure.cohort.re)

#gelman.diag(samp.structure.cohort.re)
#acfplot(samp.structure.cohort.re)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/basic_reg_struct_x_cohort_re/samps.rds")
  samps <- readRDS("outputs//growth_model/basic_reg_struct_x_cohort_re/samps.rds")
 Yp.samps <- samps[,1:(length(test$RWI))] 
 
 alpha.samps  <- samps[,(length(test$RWI)+ 1):(length(test$RWI)+ 4)]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,(length(test$RWI)+ 5):(length(test$RWI)+ 8)]
 beta3.samps <- samps[,(length(test$RWI)+ 9):(length(test$RWI)+ 12)]
 sigma.samps <- samps[,(length(test$RWI)+ 13)]
 sigma_betas <- samps[,(length(test$RWI)+ 14):(length(test$RWI)+ 16)]

 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps))~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/basic_reg_struct_x_cohort_re/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "basic_reg_struct_x_cohort_re", 
                            model.summary = "beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


# get difference between beta2.samps:
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]
# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/basic_reg_struct_x_cohort_re/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/basic_reg_struct_x_cohort_re/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/basic_reg_struct_x_cohort_re/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0("alpha-",c(unique(train$struct.cohort))))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Drought Index slope")

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))

b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0, 0.15)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/basic_reg_struct_x_cohort_re/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots+ xlim(0, 0.15), b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.6))
dev.off()

# plot slightly differently:
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")

plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))

b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0, 0.15)+theme_black(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/basic_reg_struct_x_cohort_re/param_marginal_distn_bycohort_struct_rb.png")
b2.dots.2
dev.off()

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0("beta3-",c(unique(train$struct.cohort))))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")

library(cowplot)
png(width = 5, height = 6, units = "in", res = 300, "outputs/growth_model/basic_reg_struct_x_cohort_re/param_marginal_distn_bycohort_struct.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots, ncol = 1)
dev.off()


Yp <- data.frame(Yp.samps)
colnames(Yp) <- c(paste0("YP-",c(unique(full.ghcn$struct.cohort))))
Yp$num <- rownames(Yp)
Yp.m <- melt(Yp, id.vars=c("num"))
Yp.m$DBHindex <- Xp$Var2
Yp.m$DIindex <- Xp$Var1
Yp.m$struct.cohort <- Xp$struct.cohort
ggplot(Yp.m, aes(value, color = as.factor(Yp.m$struct.cohort)))+geom_density(alpha = 0.5)+theme_bw()
library(ggridges)

ggplot(Yp.m, aes(x = value, y = as.factor(DIindex))) + 
  geom_density_ridges()

ggplot(full.ghcn, aes(x = log(RWI), y = as.factor(struct.cohort))) + 
  geom_density_ridges()

# Compute the posterior mean for the plug-in predictions  

 beta1.mn  <- colMeans(beta2.samps)
 beta2.mn  <- colMeans(beta3.samps)
 sigma.mn <- mean(sigma.samps)
 alpha1.mn <- colMeans(alpha.samps) 


# Plot the Posterior Predictive Density and plug-in
# want to plaot posteror predictive distributions:
 
# can probe either within the JAGS model or in R after the model runs:
 # specify "x probe" values for DBH + DI:
 #xprobe <- matrix(rep(-2.102618, 3.321394))
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  struct.cohort= 1:4)
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:





 Xp <- full.probe
 np <- length(Xp$Var1)
 ypred <- list()
 ypred.yp <- list()
 diff <- list()
 for(j in 1:np){

   # PPD
   #plot(density(Yp.samps[,j]),xlab="Y",main="PPD")

   
   mu <- alpha1.mn[Xp[j,3]] + beta1.mn[Xp[j,3]]*Xp[j,1] + beta2.mn[Xp[j,3]]*Xp[j,2]   # use
   #mu <- alpha1.mn+sum(Xp[j,1]*beta1.mn, Xp[j,2]*beta2.mn)
   ypred[[j]]  <- rnorm(np, mu, sigma.mn)
  # lines(density(y),col=2)
   #ypred.yp[[j]] <- Yp.samps[,j]
   #diff[[j]] <- ypred[[j]] - Yp.samps[[j]]
   # Truth
   #abline(v=Y[j],col=3,lwd=2)

   #legend("topright",c("PPD","Plug-in","Truth"),col=1:3,lty=1,inset=0.05)
}

ypred.df <- do.call(rbind, ypred)
#diff.df <- do.call(rbind, diff)
#ypred.yp.df <- do.call(rbind, ypred.yp)

Xp$MeanY <- exp(rowMeans(ypred.df))
#Xp$MeanYhat <- exp(rowMeans(ypred.yp.df))# get the means of the posterior to plot the overall effects of 
Xp$struct.cohort <- ifelse(Xp$struct.cohort == 1, "Past-Forest",  
                       ifelse(Xp$struct.cohort == 2, "Modern-Forest",
                               ifelse(Xp$struct.cohort == 3, "Past-Savanna", 
                                       ifelse(Xp$struct.cohort == 4, "Modern-Savanna", NA))))
#DBH + DI on predicted growth

# Todo: unscale Drought and DBH indices

png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_drought_struct_x_cohort.png")
ggplot(Xp, aes(Var1,MeanY, color = as.factor(struct.cohort)))+geom_point()+xlab("Drought Index")+ylab("predicted growth")
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var2,MeanY,color = as.factor(struct.cohort)))+geom_point()+xlab("DBH Index")+ylab("predicted growth")
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_drought_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~as.factor(struct.cohort))
dev.off()


```



model with re effects @ the structure (forest vs. savanna) level and prev years growth (lag -1):
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
population_model_structure_re_lag <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[structure[i]] + beta2[structure[i]]*DI.scaled[i] + beta3[structure[i]]*DBH.scaled[i] +beta4[structure[i]]*log_RWI_1[i]  # use Drought index as a scaled variable 

res[i] <- Y[i] - gfunc[i]   
emp.new[i] ~ dnorm(gfunc[i], sigma)
res.new[i] <- emp.new[i] - gfunc[i]
}



# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
}

# use normal hyperpriors for each hyperparamters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)
mu_beta4 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)

# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


for(i in 1:np){
# process model
Yp[i]   ~ dnorm(gfuncp[i], inv.var) # where Yi is already log transformed

# function g()
gfuncp[i] <- beta1[structure.p[i]] + beta2[structure.p[i]]*DI.scaled.p[i] + beta3[structure.p[i]]*DBH.scaled.p[i] + beta4[structure.p[i]]*log_RWI_1.p[i]  # use Drought index as a scaled variable 

}




}"





# save these for use later:
saveRDS(train, "outputs/growth_model/lag_reg_structure_re/train.rds")
saveRDS(test, "outputs/growth_model/lag_reg_structure_re/test.rds")
train <- readRDS("outputs/growth_model/lag_reg_structure_re/train.rds")
test <- readRDS("outputs/growth_model/lag_reg_structure_re/test.rds")

# run the JAGS model:
lag.model.by_structure <- jags.model(textConnection(population_model_structure_re_lag), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled, structure = as.numeric(train$structure),log_RWI_1 = log(train$RWI_1), SF = unique(train$structure), np=length(test$year), DI.scaled.p = test$DI.scaled, DBH.scaled.p = test$DBH.scaled, structure.p = as.numeric(test$structure), log_RWI_1.p = log(test$RWI_1)), n.chains = 3, n.adapt = 100)

# Burnin for 1000 samples to start, then go higher later
update(lag.model.by_structure, 1000); 

# get samples using coda.samples:
samp.structure.re <- coda.samples(lag.model.by_structure, 
                     variable.names=c("beta1", "beta2","beta3","beta4","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3","sigma_beta4", "Yp"), 
                    n.chains = 3, n.iter=2000, thin = 15)


dic.full <- dic.samples(lag.model.by_structure, n.chains = 3, n.iter=2000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag_reg_structure_re_DIC.rds")

#summary(samp.structure.re)
#plot(samp.structure.re)

#gelman.diag(samp.structure.re)
#acfplot(samp.structure.re)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.re[[1]]
 saveRDS(samps, "outputs/growth_model/lag_reg_structure_re/samps.rds")
 Yp.samps    <- samps[,1:length(test$site)] 
 alpha.samps <- samps[,(length(test$site)+1):(length(test$site)+2)] # one alpha for each of 16 sites
 beta1.samps  <- samps[,(length(test$site)+3):(length(test$site)+4)]
 beta2.samps <- samps[,(length(test$site)+5):(length(test$site)+6)]
beta3.samps <- samps[,(length(test$site)+7):(length(test$site)+8)]
 sigma.samps <- samps[,(length(test$site)+9)]
 sigma_betas <- samps[,(length(test$site)+10):(length(test$site)+11)]
 
 # derived quantities:
 beta1.diffs <- beta1.samps[,1] - beta2.samps[,2]
hist(beta1.diffs)


 
# plot marginal distributions of each parameter:

png("outputs/growth_model/lag_reg_structure_re/marginal_alphas.png")
par(mfrow=c(1,3))
hist(alpha.samps[,1], main = "alpha Forest")
hist(alpha.samps[,2], main = "alpha Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/lag_reg_structure_re/marginal_beta1s.png")
par(mfrow=c(1,3))
hist(beta1.samps[,1], main = "beta2 Forest")
hist(beta1.samps[,2], main = "beta2 Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()


png("outputs/growth_model/lag_reg_structure_re/marginal_beta1_diff.png")

hist(beta1.diffs, main = "Difference between savanna and forest beta1")
abline(v=0,col="red")
dev.off()

png("outputs/growth_model/lag_reg_structure_re/marginal_beta2s.png")
par(mfrow=c(1,3))
hist(beta2.samps[,1], main = "beta3 Forest")
hist(beta2.samps[,2], main = "beta3 Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0("alpha-",c("Forest", "Savanna")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+theme_black()+xlab("random intercepts")


b2 <- data.frame(beta1.samps)
colnames(b2) <- c(paste0("beta2-",c("Forest", "Savanna")))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+theme_black()+xlab("Drought slopes")


b3 <- data.frame(beta2.samps)
colnames(b3) <- c(paste0("beta3-",c("Forest", "Savanna")))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+theme_black()+xlab("DBH random slopes")

b4 <- data.frame(beta3.samps)
colnames(b4) <- c(paste0("beta4-",c("Forest", "Savanna")))
b4$num <- rownames(b4)
b4.m <- melt(b3, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+theme_black()+xlab("prev_growth random slopes")

library(cowplot)
png(width = 4, height = 6, units = "in", res = 300, "outputs/growth_model/lag_reg_structure_re/param_marginal_distn_by_struct.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots, ncol = 1)
dev.off()


# Compute the posterior mean for the plug-in predictions  

 beta1.mn  <- colMeans(beta1.samps)
 beta2.mn  <- colMeans(beta2.samps)
 sigma.mn <- mean(sigma.samps)
 alpha1.mn <- colMeans(alpha.samps) 

 # plot predicted vs. observed & R-sqared:
 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps))~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note better model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag_reg_structure_re/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag_reg_structure_re", 
                            model.summary = "beta1[structure[i]] + beta2[structure[i]]*DI.scaled[i] + beta3[structure[i]]*DBH.scaled[i] +beta4[structure[i]]*log_RWI_1[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)




# Plot the Posterior Predictive Density and plug-in
# want to plaot posteror predictive distributions:
 
# can probe either within the JAGS model or in R after the model runs:
 # specify "x probe" values for DBH + DI:
 #xprobe <- matrix(rep(-2.102618, 3.321394))
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  structure= 1:2)

 Xp <- full.probe
 np <- length(Xp$Var1)
 ypred <- list()
 for(j in 1:np){

  
   mu <- alpha.samps[,Xp[j,3]] + beta1.samps[,Xp[j,3]]*Xp[j,1] + beta2.samps[,Xp[j,3]]*Xp[j,2]   # use
   #mu <- alpha1.mn+sum(Xp[j,1]*beta1.mn, Xp[j,2]*beta2.mn)
   ypred[[j]]  <- mu #rnorm(20000, mu, sigma.mn)
  
}

ypred.df <- do.call(rbind, ypred)
y.df <- as.data.frame(ypred.df)
Xp$MeanY <- exp(rowMeans(ypred.df)) # get the means of the posterior to plot the overall effects of 
Xp$structure <- ifelse(Xp$structure == 1, "Forest", "Savanna")
Xp$number <- rownames(Xp)

y.df$number <- 1:length(y.df$V1)
y.df <- merge(Xp, y.df, by = "number")


y.df.m <- melt(y.df, id.vars = c("number", "Var1", "Var2", "structure"))


ggplot(y.df.m, aes(Var1, value, col = structure))+geom_boxplot()

#DBH + DI on predicted growth
png("outputs/growth_model/lag_reg_structure_re/predicted_y.png")
#par(mfrow = c(1,2))
plot(density(ypred.df), main = "Ypred, line = Ydata")
abline(v = mean(Y), col = "red")

#plot(density(d13pred.df), main = "d13pred, line = d13data")
#abline(v= mean(d13$Cor.d13C.suess), col = "red")
dev.off()
# Todo: unscale Drought and DBH indices

png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/lag_reg_structure_re/Ypred_by_drought_structure.png")
ggplot(Xp, aes(Var1,MeanY, color = as.factor(structure)))+geom_point()+xlab("Drought Index")+ylab("predicted growth")


dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/lag_reg_structure_re/Ypred_by_DBH_structure.png")
ggplot(Xp, aes(Var2,MeanY,color = as.factor(structure)))+geom_point()+xlab("DBH Index")+ylab("predicted growth")
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/lag_reg_structure_re/Ypred_by_drought_DBH_structure.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~as.factor(structure))
dev.off()


```
# check above models


model with stand structure by ageclass random effects and prev years growth (lag -1):
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
population_model_structure_x_cohort_re_lag <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]   # use Drought index as a scaled variable 

#r1[i] <- Y[i] - gfunc[i]   

}

#RSS[1] <- sum(r1^2)

# Prediction
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4[struct.cohort.p[i]]*log_RWI_1.p[i] 
  }

# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
#r2[s] <- a[j] - mu_beta1
}
#RSS[2] <- sum(r2^2)


# use normal hyperpriors for each hyperparamters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)
mu_beta4 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)

# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


}"





saveRDS(train, "outputs/growth_model/lag_reg_struct_x_cohort_re/train.rds")
saveRDS(test, "outputs/growth_model/lag_reg_struct_x_cohort_re/test.rds")
test <- readRDS("outputs/growth_model/lag_reg_struct_x_cohort_re/test.rds")
train <- readRDS("outputs/growth_model/lag_reg_struct_x_cohort_re/train.rds")

lag.model.by_structure_x_cohort <- jags.model(textConnection(population_model_structure_x_cohort_re_lag), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled,log_RWI_1 = log(train$RWI_1), struct.cohort = as.numeric(train$struct.cohort.code), SF = unique(train$struct.cohort.code), np = length(test$DBH.scaled),
   struct.cohort.p = as.numeric(test$struct.cohort.code), DBH.scaled.p = test$DBH.scaled, DI.scaled.p = test$DI.scaled, log_RWI_1.p = log(test$RWI_1)), n.chains = 3, n.adapt = 100)

update(lag.model.by_structure_x_cohort, 1000); # Burnin for 1000 samples to start, then go higher later


lag.samp.structure.cohort.re <- coda.samples(lag.model.by_structure_x_cohort, 
                     variable.names=c("beta1", "beta2","beta3","beta4","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3", "sigma_beta4","Yp"), 
                    n.chains = 3, n.iter=20000, thin = 15)

dic.full <- dic.samples(lag.model.by_structure_x_cohort, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag_reg_struct_x_cohort_re_DIC.rds")

#summary(lag.samp.structure.cohort.re)
#plot(lag.samp.structure.cohort.re)

#gelman.diag(lag.samp.structure.cohort.re)
#acfplot(lag.samp.structure.cohort.re)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- lag.samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/lag_reg_struct_x_cohort_re/samps.rds")
  samps <- readRDS("outputs//growth_model/lag_reg_struct_x_cohort_re/samps.rds")

 Yp.samps <- samps[,1:(length(test$RWI))] 
 alpha.samps  <- samps[,(length(test$RWI)+ 1):(length(test$RWI)+ 4)]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,(length(test$RWI)+ 5):(length(test$RWI)+ 8)]
 beta3.samps <- samps[,(length(test$RWI)+ 9):(length(test$RWI)+ 12)]
 beta4.samps <- samps[,(length(test$RWI)+ 13):(length(test$RWI)+ 16)]
 sigma.samps <- samps[,(length(test$RWI)+ 17)]
 sigma_betas <- samps[,(length(test$RWI)+ 18):(length(test$RWI)+ 21)]

 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps))~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag_reg_struct_x_cohort_re/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag_reg_struct_x_cohort_re", 
                            model.summary = "beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4[struct.cohort.p[i]]*log_RWI_1.p[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "lag_reg_struct_x_cohort_re", 
                           train = "cohort.omit", 
                           DI.scaled = "JJApdsi")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)


# get difference between beta2.samps: (i.e are they different?)
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]
# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/lag_reg_struct_x_cohort_re/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/lag_reg_struct_x_cohort_re/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/lag_reg_struct_x_cohort_re/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0("alpha-",c(unique(train$struct.cohort))))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Drought Index slope")

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))

b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0, 0.15)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag_reg_struct_x_cohort_re/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots+ xlim(0, 0.15), b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.6))
dev.off()

# plot slightly differently:
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")

plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))

b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0, 0.15)+theme_black(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/lag_reg_struct_x_cohort_re/param_marginal_distn_bycohort_struct_rb.png")
b2.dots.2
dev.off()

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0("beta3-",c(unique(train$struct.cohort))))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(paste0("beta4-",c(unique(train$struct.cohort))))
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")

library(cowplot)
png(width = 5, height = 8, units = "in", res = 300, "outputs/growth_model/lag_reg_struct_x_cohort_re/param_marginal_distn_bycohort_struct.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, ncol = 1)
dev.off()

```

model with stand structure by ageclass random effects and prev years growth (lag -1) and includes site level random intercepts, but cohort/structure random slopes:
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
site_model_structure_x_cohort_re_lag <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]   # use Drought index as a scaled variable 

}

#RSS[1] <- sum(r1^2)

# Prediction
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[site.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4[struct.cohort.p[i]]*log_RWI_1.p[i] 
  }

# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){

beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
#r2[s] <- a[j] - mu_beta1
}
#RSS[2] <- sum(r2^2)

for(p in 1:length(plots)){
beta1[p] ~ dnorm(mu_beta1, inv_beta1)
}

# use normal hyperpriors for each hyperparamters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)
mu_beta4 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)

# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


}"





# save these for use later:
saveRDS(train, "outputs/growth_model/lag_site_struct_x_cohort_re/train.rds")
saveRDS(test, "outputs/growth_model/lag_site_struct_x_cohort_re/test.rds")



lag.model.by_structure_x_cohort <- jags.model(textConnection(site_model_structure_x_cohort_re_lag), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled,log_RWI_1 = log(train$RWI_1), struct.cohort = as.numeric(train$struct.cohort.code), SF = unique(ghcn.clean$struct.cohort.code), plots = unique(ghcn.clean$site), site = as.numeric(ghcn.clean$site), np = length(test$DBH.scaled),
   struct.cohort.p = as.numeric(test$struct.cohort.code), DBH.scaled.p = test$DBH.scaled, DI.scaled.p = test$DI.scaled, log_RWI_1.p = log(test$RWI_1), site.p = as.numeric(test$site)), n.chains = 3, n.adapt = 100)

update(lag.model.by_structure_x_cohort, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag.model.by_structure_x_cohort, 
                     variable.names=c("beta1", "beta2","beta3","beta4","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3", "sigma_beta4","Yp"), 
                    n.chains = 3, n.iter=20000, thin = 15)

dic.full <- dic.samples(lag.model.by_structure_x_cohort, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag_site_struct_x_cohort_re_DIC.rds")

#summary(samp.structure.cohort.re)
#plot(samp.structure.cohort.re)

#gelman.diag(samp.structure.cohort.re)
#acfplot(samp.structure.cohort.re)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/lag_site_struct_x_cohort_re/samps.rds")
  samps <- readRDS("outputs//growth_model/lag_site_struct_x_cohort_re/samps.rds")

 Yp.samps <- samps[,1:(length(test$RWI))] 
 alpha.samps  <- samps[,(length(test$RWI)+ 1):(length(test$RWI)+ 16)]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,(length(test$RWI)+ 17):(length(test$RWI)+ 20)]
 beta3.samps <- samps[,(length(test$RWI)+ 21):(length(test$RWI)+ 24)]
 beta4.samps <- samps[,(length(test$RWI)+ 25):(length(test$RWI)+ 28)]
 sigma.samps <- samps[,(length(test$RWI)+ 29)]
 sigma_betas <- samps[,(length(test$RWI)+ 30):(length(test$RWI)+ 33)]

 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps))~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag_site_struct_x_cohort_re/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag_site_struct_x_cohort_re", 
                            model.summary = "beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "lag_site_struct_x_cohort_re", 
                           train = "ghcn.clean", 
                           DI.scaled = "JJApdsi")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)



# get difference between beta2.samps: (i.e are they different?)
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]

# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/lag_site_struct_x_cohort_re/marginal_alphas.png")
par(mfrow=c(5,4))
for(i in 1:length(unique(ghcn.clean$site))){
hist(alpha.samps[,i], main = paste("random intecept", unique(ghcn.clean$site)[i]))

}
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/lag_site_struct_x_cohort_re/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/lag_site_struct_x_cohort_re/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()

png("outputs/growth_model/lag_site_struct_x_cohort_re/marginal_beta3s.png")
par(mfrow=c(3,2))
hist(beta4.samps[,1], main = "beta4 Past-Forest")
hist(beta4.samps[,2], main = "beta4 Modern-Forest")
hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,4], main = "sigma beta3")
dev.off()

# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0("alpha-", unique(ghcn.clean$site)))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Drought Index slope")

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975))+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))

b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0, 0.15)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag_site_struct_x_cohort_re/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots+ xlim(0, 0.15), b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.6))
dev.off()

# plot slightly differently:
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")

plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))

b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0, 0.15)+theme_black(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/lag_site_struct_x_cohort_re/param_marginal_distn_bycohort_struct_rb.png")
b2.dots.2
dev.off()

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0("beta3-",c(unique(train$struct.cohort))))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH effect")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(paste0("beta4-",c(unique(train$struct.cohort))))
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Lag-1 Effect")


png(width = 5, height = 8, units = "in", res = 300, "outputs/growth_model/lag_site_struct_x_cohort_re/param_marginal_distn_bycohort_struct.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, ncol = 1)
dev.off()

```


#model with stand structure by ageclass random effects and prev years growth (lag -1) and (lag - 2):
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
population_model_structure_x_cohort_re_lag2 <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]   # use Drought index as a scaled variable 

#r1[i] <- Y[i] - gfunc[i]   

}

#RSS[1] <- sum(r1^2)

# Prediction
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4[struct.cohort.p[i]]*log_RWI_1.p[i] +beta5[struct.cohort.p[i]]*log_RWI_2.p[i] 
  }

# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
beta5[s] ~ dnorm(mu_beta5, inv_beta5)

}



# use normalpriors for each  beta paramters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)
mu_beta4 ~ dunif(-2, 2)
mu_beta5 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)

# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


}"





# save these for use later:
saveRDS(train, "outputs/growth_model/lag2_reg_struct_x_cohort_re/train.rds")
saveRDS(test, "outputs/growth_model/lag2_reg_struct_x_cohort_re/test.rds")
test <- readRDS( "outputs/growth_model/lag2_reg_struct_x_cohort_re/test.rds")



lag2.model.by_structure_x_cohort <- jags.model(textConnection(population_model_structure_x_cohort_re_lag2), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled,log_RWI_1 = log(train$RWI_1),log_RWI_2 = log(train$RWI_2), struct.cohort = as.numeric(train$struct.cohort.code), SF = unique(train$struct.cohort.code), np = length(test$DBH.scaled),
   struct.cohort.p = as.numeric(test$struct.cohort.code), DBH.scaled.p = test$DBH.scaled, DI.scaled.p = test$DI.scaled, log_RWI_1.p = log(test$RWI_1), log_RWI_2.p = log(test$RWI_2)), n.chains = 3, n.adapt = 100)

update(lag2.model.by_structure_x_cohort, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort, 
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3", "sigma_beta4","sigma_beta5","Yp"), 
                    n.chains = 3, n.iter=20000, thin = 15)



dic.full <- dic.samples(lag2.model.by_structure_x_cohort, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag2_reg_struct_x_cohort_re_DIC.rds")

#summary(samp.structure.cohort.re)
#plot(samp.structure.cohort.re)

#gelman.diag(samp.structure.cohort.re)
#acfplot(samp.structure.cohort.re)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re/samps.rds")
  samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re/samps.rds")

 Yp.samps <- samps[,1:(length(test$RWI))] 
 alpha.samps  <- samps[,(length(test$RWI)+ 1):(length(test$RWI)+ 4)]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,(length(test$RWI)+ 5):(length(test$RWI)+ 8)]
 beta3.samps <- samps[,(length(test$RWI)+ 9):(length(test$RWI)+ 12)]
 beta4.samps <- samps[,(length(test$RWI)+ 13):(length(test$RWI)+ 16)]
 beta5.samps <- samps[,(length(test$RWI)+ 17):(length(test$RWI)+ 20)]
 sigma.samps <- samps[,(length(test$RWI)+ 21)]
 sigma_betas <- samps[,(length(test$RWI)+ 22):(length(test$RWI)+ 26)]

 
 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re", 
                            model.summary = "beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4[struct.cohort.p[i]]*log_RWI_1.p[i] +beta5[struct.cohort.p[i]]*log_RWI_2.p[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re", 
                          train = "cohort.omit", 
                          DI.scaled = "JJApdsi")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)

# get difference between beta2.samps: (i.e are they different?)
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]
# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/lag2_reg_struct_x_cohort_re/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re/marginal_beta3s.png")
par(mfrow=c(3,2))
hist(beta4.samps[,1], main = "beta4 Past-Forest")
hist(beta4.samps[,2], main = "beta4 Modern-Forest")
hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,4], main = "sigma beta4")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re/marginal_beta3s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta5 Past-Forest")
hist(beta5.samps[,2], main = "beta5 Modern-Forest")
hist(beta5.samps[,3],  main = "beta5 Past-Savanna")
hist(beta5.samps[,4],  main = "beta5 Modern-Savanna")
hist(sigma_betas[,5], main = "sigma beta5")
dev.off()

# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0("alpha-",c(unique(train$struct.cohort))))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Drought Index slope")

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))

b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0, 0.15)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots+ xlim(0, 0.15), b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.6))
dev.off()

# plot slightly differently:
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")

plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))

b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0, 0.15)+theme_black(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re/param_marginal_distn_bycohort_struct_rb.png")
b2.dots.2
dev.off()

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0("beta3-",c(unique(train$struct.cohort))))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(paste0("beta4-",c(unique(train$struct.cohort))))
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(paste0("beta5-",c(unique(train$struct.cohort))))
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

library(cowplot)
png(width = 5, height = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re/param_marginal_distn_bycohort_struct.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, b5.mplots,ncol = 1)
dev.off()

```
 
 #model with MAP as drought index stand structure by ageclass random effects and prev years growth (lag -1) and (lag - 2):
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
population_model_structure_x_cohort_re_lag2_temp_MAP <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] # use Drought index as a scaled variable 

#r1[i] <- Y[i] - gfunc[i]   

}

#RSS[1] <- sum(r1^2)

# Prediction from known data
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4[struct.cohort.p[i]]*log_RWI_1.p[i] +beta5[struct.cohort.p[i]]*log_RWI_2.p[i] + beta6[struct.cohort.p[i]]*Temp.scaled.p[i]
  }

# probe for prediction plots:
  for(i in 1:nprobe){
    Yprobe[i]  ~ dnorm(muprobe[i],inv.var)
    muprobe[i] <- beta1[struct.cohort.probe[i]] + beta2[struct.cohort.probe[i]]*DI.scaled.probe[i] + beta3[struct.cohort.probe[i]]*DBH.scaled.probe[i] +beta4[struct.cohort.probe[i]]*log_RWI_1.probe[i] +beta5[struct.cohort.probe[i]]*log_RWI_2.probe[i] + beta6[struct.cohort.probe[i]]*Temp.scaled.probe[i]
  }

# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
beta5[s] ~ dnorm(mu_beta5, inv_beta5)
beta6[s] ~ dnorm(mu_beta5, inv_beta6)
}



# use normalpriors for each  beta paramters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)
mu_beta4 ~ dunif(-2, 2)
mu_beta5 ~ dunif(-2, 2)
mu_beta6 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)
inv_beta6   ~ dgamma(0.01, 0.01)
sigma_beta6 <- 1/sqrt(inv_beta6)

# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


}"





# save these for use later:
saveRDS(train, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/train.rds")
saveRDS(test, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/test.rds")
train <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/train.rds")
test <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/test.rds")



# generate probe dataset:
 DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)
 DBHprobe <- round(seq(range(train$DBH.scaled)[1], range(train$DBH.scaled)[2], by = 0.75), 3)
 Tempprobe <- round(seq(range(train$T.scaled)[1], range(train$T.scaled)[2], by = 0.75), 3)
 RWI1probe <- round(seq(range(log(train$RWI_1))[1], range(log(train$RWI_1))[2], by = 0.5), 3)
 RWI2probe <- round(seq(range(log(train$RWI_2))[1], range(log(train$RWI_2))[2], by = 0.5), 3)
 
 # expand into full probe
probe <- expand.grid(DI.scaled = DIprobe, DBH.scaled = DBHprobe, T.scaled = Tempprobe,
                         RWI_1 = RWI1probe, RWI_2= RWI2probe ,struct.cohort.code= 1:4)



lag2.model.by_structure_x_cohort_t_pr <- jags.model(textConnection(population_model_structure_x_cohort_re_lag2_temp_MAP), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$MAP.scaled, DBH.scaled = train$DBH.scaled,log_RWI_1 = log(train$RWI_1),log_RWI_2 = log(train$RWI_2), Temp.scaled = train$T.scaled, struct.cohort = as.numeric(train$struct.cohort.code), SF = unique(train$struct.cohort.code), np = length(test$DBH.scaled),
   struct.cohort.p = as.numeric(test$struct.cohort.code), DBH.scaled.p = test$DBH.scaled, DI.scaled.p = test$MAP.scaled, log_RWI_1.p = log(test$RWI_1), log_RWI_2.p = log(test$RWI_2), Temp.scaled.p = test$T.scaled, nprobe = length(probe$DBH.scaled),
   struct.cohort.probe = as.numeric(probe$struct.cohort.code), DBH.scaled.probe = probe$DBH.scaled, DI.scaled.probe = probe$DI.scaled, log_RWI_1.probe = probe$RWI_1, log_RWI_2.probe = probe$RWI_2, Temp.scaled.probe = probe$T.scaled), n.chains = 3, n.adapt = 100)

update(lag2.model.by_structure_x_cohort_t_pr, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","beta6","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3", "sigma_beta4","sigma_beta5", "sigma_beta6","Yp", "Yprobe"), 
                    n.chains = 3, n.iter=1000, thin = 15)



dic.full <- dic.samples(lag2.model.by_structure_x_cohort_t_pr, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag2_reg_struct_x_cohort_re_t_pr_DIC.rds")

#summary(samp.structure.cohort.re)
#plot(samp.structure.cohort.re)

#gelman.diag(samp.structure.cohort.re)
#acfplot(samp.structure.cohort.re)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr/samps.rds")
  samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr/samps.rds")
test <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr/test.rds")
train <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr/train.rds")

 Yp.samps <- samps[,1:(length(test$RWI))] 
Yprobe.samps <- samps[,(length(test$RWI)+1):(length(probe$DI.scaled))] 
 alpha.samps  <- samps[,(length(test$RWI)+ (length(probe$DI.scaled))+1):(length(test$RWI)+(length(probe$DI.scaled))+ 4)]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,(length(test$RWI)+ (length(probe$DI.scaled))+5):(length(test$RWI)+ (length(probe$DI.scaled))+8)]
 beta3.samps <- samps[,(length(test$RWI)+ (length(probe$DI.scaled))+9):(length(test$RWI)+ (length(probe$DI.scaled))+12)]
 beta4.samps <- samps[,(length(test$RWI)+ (length(probe$DI.scaled))+13):(length(test$RWI)+(length(probe$DI.scaled))+ 16)]
 beta5.samps <- samps[,(length(test$RWI)+(length(probe$DI.scaled))+ 17):(length(test$RWI)+(length(probe$DI.scaled))+ 20)]
 beta6.samps <- samps[,(length(test$RWI)+(length(probe$DI.scaled))+ 21):(length(test$RWI)+(length(probe$DI.scaled))+ 24)]
 sigma.samps <- samps[,(length(test$RWI)+ (length(probe$DI.scaled))+25)]
 sigma_betas <- samps[,(length(test$RWI)+(length(probe$DI.scaled))+ 26):(length(test$RWI)+(length(probe$DI.scaled))+ 31)]

 
 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note best model fit so far
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr", 
                            model.summary = "beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)

# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_p", 
                           train = "cohort.omit", 
                           DI.scaled = "MAP")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)



# get difference between beta2.samps: (i.e are they different?)
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]
# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/marginal_beta3s.png")
par(mfrow=c(3,2))
hist(beta4.samps[,1], main = "beta4 Past-Forest")
hist(beta4.samps[,2], main = "beta4 Modern-Forest")
hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,4], main = "sigma beta4")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/marginal_beta4s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta5 Past-Forest")
hist(beta5.samps[,2], main = "beta5 Modern-Forest")
hist(beta5.samps[,3],  main = "beta5 Past-Savanna")
hist(beta5.samps[,4],  main = "beta5 Modern-Savanna")
hist(sigma_betas[,5], main = "sigma beta5")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/marginal_beta5s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta4 Past-Forest")
hist(beta5.samps[,2], main = "beta4 Modern-Forest")
hist(beta5.samps[,3],  main = "beta4 Past-Savanna")
hist(beta5.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,6], main = "sigma beta4")
dev.off()

# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0("alpha-",c(unique(train$struct.cohort))))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope")

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0(c(unique(train$struct.cohort))))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH Index slope")


b4 <- data.frame(beta4.samps)
colnames(b4) <- c(paste0(c(unique(train$struct.cohort))))
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-1 Index slope")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(paste0(c(unique(train$struct.cohort))))
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-2 Index slope")

b6 <- data.frame(beta6.samps)
colnames(b6) <- c(paste0(c(unique(train$struct.cohort))))
b6$num <- rownames(b6)
b6.m <- melt(b6, id.vars=c("num"))
b6.mplots <- ggplot(b6.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Summer Temperature slope")

png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/drougt_beta_marginal_distn_bycohort.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots, b5.mplots, b6.mplots)
dev.off()

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))

b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0, 0.15)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots+ xlim(0, 0.15), b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.6))
dev.off()

# plot slightly differently:
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")

plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))

b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0, 0.15)+theme_black(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t/param_marginal_distn_bycohort_struct_rb.png")
b2.dots.2
dev.off()

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0("beta3-",c(unique(train$struct.cohort))))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(paste0("beta4-",c(unique(train$struct.cohort))))
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(paste0("beta5-",c(unique(train$struct.cohort))))
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

library(cowplot)
png(width = 5, height = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/param_marginal_distn_bycohort_struct_1.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, b5.mplots,ncol = 1)
dev.off()

# --------------------make plots of probed predicted growth responses:
# plot probed values of tree growth predictions:
Yprobe <- data.frame(Yprobe.samps)
colnames(Yprobe) <- 1:length(Yprobe)
probe.m <- melt(Yprobe)
probe.m$RWI <- exp(probe.m$value) 
colnames(probe.m) <- c("num", "Ypred", "RWI")

probe$num <- 1:length(probe[,1])
colnames(probe) <- c("Drought", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "num")

# summarize by structure + cohort class only:
# summarize by structure + cohort class only:
probe$num <- as.factor(as.character(probe$num))
full.p <- probe

probtest <- dplyr::inner_join(probe.m, full.p, by=c("num"))

prob <- probtest
# save here:
saveRDS(prob, "outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/full_yprobe_preds.rds")
prob <- readRDS("outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/full_yprobe_preds.rds")


# plot the posteriors:




```
 
 
 
 # FOR All years: multi-level model with MAP as drought index stand structure by ageclass random effects and prev years growth (lag -1) and (lag - 2), and a site level random intercept parameter: 


```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"

population_model_site_int_structure_x_cohort_re_lag2_temp_MAP.f <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] # use Drought index as a scaled variable 
   

}



# Prediction from known data
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[site.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4[struct.cohort.p[i]]*log_RWI_1.p[i] +beta5[struct.cohort.p[i]]*log_RWI_2.p[i] + beta6[struct.cohort.p[i]]*Temp.scaled.p[i]
  }

# probe for prediction plots:
  for(i in 1:nprobe){
    Yprobe[i]  ~ dnorm(muprobe[i],inv.var)
    muprobe[i] <- beta1[site.probe[i]] + beta2[struct.cohort.probe[i]]*DI.scaled.probe[i] + beta3[struct.cohort.probe[i]]*DBH.scaled.probe[i] +beta4[struct.cohort.probe[i]]*log_RWI_1.probe[i] +beta5[struct.cohort.probe[i]]*log_RWI_2.probe[i] + beta6[struct.cohort.probe[i]]*Temp.scaled.probe[i]
  }

# project into the future (assuming no further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut[i]  ~ dnorm(mufut[i],inv.var)
    mufut[i] <- beta1[site.fut[i]] + beta2[struct.cohort.fut[i]]*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]
  }

# project into the future (assuming 35% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.35[i]  ~ dnorm(mufut2[i],inv.var)
    mufut2[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.92)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]
  }



# project into the future (assuming 50% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.50[i]  ~ dnorm(mufut3[i],inv.var)
    mufut3[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.85)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]
  }


# project into the future (assuming 8% further change in drought senseiivty & temperature):
  for(i in 1:nfut){
   Yfut.35.35[i]  ~ dnorm(mufut35[i],inv.var)
    mufut35[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.92)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + (beta6[struct.cohort.fut[i]]*1.08)*Temp.scaled.fut[i]
  }



# project into the future (assuming 7% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.50.50[i]  ~ dnorm(mufut50[i],inv.var)
    mufut50[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.85)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + (beta6[struct.cohort.fut[i]]*1.15)*Temp.scaled.fut[i]
  }

# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){

beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
beta5[s] ~ dnorm(mu_beta5, inv_beta5)
beta6[s] ~ dnorm(mu_beta5, inv_beta6)
}


for(k in 1:Nsites){
beta1[k] ~ dnorm(mu_beta1, inv_beta1)
}


# use normalpriors for each  beta paramters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)
mu_beta4 ~ dunif(-2, 2)
mu_beta5 ~ dunif(-2, 2)
mu_beta6 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)
inv_beta6   ~ dgamma(0.01, 0.01)
sigma_beta6 <- 1/sqrt(inv_beta6)

# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)

}"

# save these for use later:
saveRDS(train.full, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/train.full.rds")
saveRDS(test.full, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/test.full.rds")
train.full <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/train.full.rds")
test.full <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/test.full.rds")
# assign site numbers to each site:
site.num.df <- data.frame(site = as.character(unique(train.full$site)), 
            site.num = 1:length(as.character(unique(train.full$site))))
train.full <- merge(train.full, site.num.df, by = "site" )
test.full <- merge(test.full, site.num.df, by = "site" )


# generate probe dataset:
 DIprobe <- round(seq(range(train.full$MAP.scaled)[1], range(train.full$MAP.scaled)[2], by = 0.75), 3)
 DBHprobe <- round(seq(range(train.full$DBH.scaled)[1], range(train.full$DBH.scaled)[2], by = 0.75), 3)
 Tempprobe <- round(seq(range(train.full$T.scaled)[1], range(train.full$T.scaled)[2], by = 0.75), 3)
 RWI1probe <- round(seq(range(log(train.full$RWI_1))[1], range(log(train.full$RWI_1))[2], by = 0.5), 3)
 RWI2probe <- round(seq(range(log(train.full$RWI_2))[1], range(log(train.full$RWI_2))[2], by = 0.5), 3)
 
 # expand into full probe
probe <- expand.grid(DI.scaled = DIprobe, DBH.scaled = DBHprobe, T.scaled = Tempprobe,
                         RWI_1 = RWI1probe, RWI_2= RWI2probe, struct.cohort.code= 1:4, site.num = unique(train.full$site.num))

sit.cohorts <- unique(train.full[,c("struct.cohort.code", "site.num")])
probe <- merge(probe, sit.cohorts, by = c("struct.cohort.code", "site.num")) # make sure that each site only has savanna or forest in the probe

# make probe smaller to help with saving:
short.probe <- probe[probe$RWI_1 %in% c("-1.466", "0.034", "1.534") & probe$RWI_2 %in% c("-1.397", "0.103", "1.603") & probe$DBH.scaled %in% c("-1.353","0.147","2.397"),]

#short.probe <- probe

# make a probe for future climate projections at our sites!
rcp85 <- rcp85[!rcp85$site %in% c("COR", "GLL4", "HIC", "PLE", "PVC", "STC", "TOW"),]
future.probe_70 <- data.frame(MAP.scaled = rcp85$PR_85_70.scaled, DBH.scaled= -0.413, 
                              T.scaled = rcp85$Tx_70.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103,  struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_70$year <- 2070
future.probe_50 <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site,  model = rcp85$model)
future.probe_50$year <- 2050


# get climate averages from 1950 - present at each site:
train.full$struct.cohort.code2 <- as.numeric(train.full$struct.cohort.code)
train.full.clim.summary <-
  train.full[train.full$ageclass %in% "Modern", ] %>% group_by(site) %>% dplyr::summarise(
    MAP.scaled = mean(MAP.scaled),
    DBH.scaled = -0.413,
    T.scaled = mean(T.scaled),
    RWI_1 = 0.103,
    RWI_2 = 0.103,
    struct.cohort.code = mean(struct.cohort.code2),
    model = "none",
    year = 2000
    )



Average.prob <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_50$year <- 2050


fut <- rbind(future.probe_50, future.probe_70, train.full.clim.summary[,c("MAP.scaled", "DBH.scaled",  "T.scaled", "RWI_1", "RWI_2", "struct.cohort.code", "site","year","model")])


fut <- merge(fut, site.num.df, by = "site")

# look at the effects under two different DBH values
short.fut <- fut
fut.small <- fut
fut.large <- fut
fut.small$DBH.scaled <- -0.413
fut.large$DBH.scaled <- 1.900
long.fut <- rbind(fut.small, fut.large)


# look at the effects under average, below average, and above average different prev year growth values
lfut.low <- long.fut
lfut.avg <- long.fut
lfut.high <- long.fut

lfut.low$RWI_1 <- -1.609
lfut.low$RWI_2 <- -1.47

lfut.high$RWI_1 <- 1.891
lfut.high$RWI_2 <- 2.03

long.fut <- rbind(lfut.high, lfut.avg, lfut.low)

lag2.model.by_structure_x_cohort_t_pr <- jags.model(textConnection(population_model_site_int_structure_x_cohort_re_lag2_temp_MAP.f), 
                    data = list(Y=log(train.full$RWI), n=length(train.full$RWI), DI.scaled = train.full$MAP.scaled, DBH.scaled = train.full$DBH.scaled,log_RWI_1 = log(train.full$RWI_1),log_RWI_2 = log(train.full$RWI_2), Temp.scaled = train.full$T.scaled, struct.cohort = as.numeric(train.full$struct.cohort.code), SF = as.numeric(unique(train.full$struct.cohort.code)), site = train.full$site.num, Nsites = length(unique(train.full$site)),
  
                                struct.cohort.p = as.numeric(test.full$struct.cohort.code), DBH.scaled.p = test.full$DBH.scaled, DI.scaled.p = test.full$MAP.scaled, log_RWI_1.p = log(test.full$RWI_1), log_RWI_2.p = log(test.full$RWI_2), Temp.scaled.p = test.full$T.scaled, site.p = test.full$site.num, np = length(as.numeric(test.full$struct.cohort.code)), 
  
  struct.cohort.probe = as.numeric(short.probe$struct.cohort.code), DBH.scaled.probe = short.probe$DBH.scaled, DI.scaled.probe = short.probe$DI.scaled, log_RWI_1.probe = short.probe$RWI_1, log_RWI_2.probe =short.probe$RWI_2, Temp.scaled.probe = short.probe$T.scaled, site.probe = short.probe$site.num, nprobe = length(as.numeric(short.probe$struct.cohort.code)), 
 
  struct.cohort.fut = as.numeric(long.fut$struct.cohort.code), DBH.scaled.fut = long.fut$DBH.scaled, DI.scaled.fut = long.fut$MAP.scaled, log_RWI_1.fut = long.fut$RWI_1, log_RWI_2.fut =long.fut$RWI_2, Temp.scaled.fut = long.fut$T.scaled, site.fut = long.fut$site.num, nfut = length(as.numeric(long.fut$struct.cohort.code))
 
  
  ),
  n.chains = 3, n.adapt = 100)

update(lag2.model.by_structure_x_cohort_t_pr, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","beta6","sigma", "mu_beta1", "mu_beta2","mu_beta3", "mu_beta4","mu_beta5", "mu_beta6","Yp"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.probe <- coda.samples(lag2.model.by_structure_x_cohort_t_pr,
                     variable.names=c("Yprobe"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut"), 
                    n.chains = 3, n.iter=10000, thin = 15)
Y.fut.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.35"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.50"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.35.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.35.35"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.50.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.50.50"), 
                    n.chains = 3, n.iter=10000,thin = 15)

dic.full <- dic.samples(lag2.model.by_structure_x_cohort_t_pr, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag2_reg_struct_x_cohort_re_t_pr_full_dataset_DIC.rds")

#s

#summary(samp.structure.cohort.re)
#plot(samp.structure.cohort.re)

#gelman.diag(samp.structure.cohort.re, multivariate = FALSE)
#acfplot(samp.structure.cohort.re)

autocorr.plot(samp.structure.cohort.re [[1]][ , 'beta2[1]'], auto.layout = FALSE, lwd = 4, col = "red", lag.max = 100)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/samps.rds")
 

  Yprobe.samps      <- Y.probe[[1]]
 saveRDS(Yprobe.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/Yprobe.samps.rds")
  Y.fut.samps      <- Y.fut[[1]]
 saveRDS(Y.fut.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/Y.fut.samps.rds")
 
  Y.fut.35.samps      <- Y.fut.35[[1]]
 saveRDS(Y.fut.35.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/Y.fut.35.samps.rds")
 
  Y.fut.50.samps      <- Y.fut.50[[1]]
 saveRDS(Y.fut.50.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/Y.fut.50.samps.rds")
 
  Y.fut.35.35.samps      <- Y.fut.35.35[[1]]
 saveRDS(Y.fut.35.35.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/Y.fut.35.35.samps.rds")
 
   Y.fut.50.50.samps      <- Y.fut.50.50[[1]]
 saveRDS(Y.fut.50.50.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/Y.fut.50.50.samps.rds")
 
 
 samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/samps.rds")
 #test.full.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/test.full.rds")
 #train.full.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/train.full.rds")
#Yfut.samps <- samps[, 1:length(fut$RWI_1)]
#samps <- samps[,(length(fut$RWI_1)+1):length(colnames(samps))]
 Yp.samps <- samps[,1:(length(test.full$RWI))] 
 
 alpha.samps  <- samps[,(length(test.full$RWI)+1):(length(test.full$RWI)+ 16)]# one alpha for each of 16 sites
 beta2.samps <- samps[,(length(test.full$RWI)+17):(length(test.full$RWI)+20)]
 beta3.samps <- samps[,(length(test.full$RWI)+21):(length(test.full$RWI)+24)]
 beta4.samps <- samps[,(length(test.full$RWI)+25):(length(test.full$RWI)+ 28)]
 beta5.samps <- samps[,(length(test.full$RWI)+ 29):(length(test.full$RWI)+ 32)]
 beta6.samps <- samps[,(length(test.full$RWI)+ 33):(length(test.full$RWI)+ 36)]
 sigma.samps <- samps[,(length(test.full$RWI)+ 43)]
 sigma_betas <- samps[,(length(test.full$RWI)+ 37):(length(test.full$RWI)+ 42)]

 
 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test.full$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test.full$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)+theme_bw(base_size = 15)

# note best model fit so far
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test.full$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test.full$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_full_dataset", 
                            model.summary = "beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)

# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_full_dataset", 
                           train = "train.full", 
                           DI.scaled = "MAP")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)



# get difference between beta2.samps: (i.e are they different?)
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]




# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/marginal_beta3s.png")
par(mfrow=c(3,2))
hist(beta4.samps[,1], main = "beta4 Past-Forest")
hist(beta4.samps[,2], main = "beta4 Modern-Forest")
hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,4], main = "sigma beta4")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/marginal_beta4s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta5 Past-Forest")
hist(beta5.samps[,2], main = "beta5 Modern-Forest")
hist(beta5.samps[,3],  main = "beta5 Past-Savanna")
hist(beta5.samps[,4],  main = "beta5 Modern-Savanna")
hist(sigma_betas[,5], main = "sigma beta5")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/marginal_beta5s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta4 Past-Forest")
hist(beta5.samps[,2], main = "beta4 Modern-Forest")
hist(beta5.samps[,3],  main = "beta4 Past-Savanna")
hist(beta5.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,6], main = "sigma beta4")
dev.off()

# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- unique(train.full$site)#[order(unique(train.full[,c("site", "site.num")])[,2])])
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <-c(unique(train.full$struct.cohort)[order(unique(train.full[,c("struct.cohort", "struct.cohort.code")])[,2])])
#colnames(b2) <- c(paste0(c(unique(train.full$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope")

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(unique(train.full$struct.cohort)[order(unique(train.full[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH Index slope")


b4 <- data.frame(beta4.samps)
colnames(b4) <- c(unique(train.full$struct.cohort)[order(unique(train.full[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-1 Index slope")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(unique(train.full$struct.cohort)[order(unique(train.full[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-2 Index slope")

b6 <- data.frame(beta6.samps)
colnames(b6) <- c(unique(train.full$struct.cohort)[order(unique(train.full[,c("struct.cohort", "struct.cohort.code")])[,2])])
b6$num <- rownames(b6)
b6.m <- melt(b6, id.vars=c("num"))
b6.mplots <- ggplot(b6.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Summer Temperature slope")

png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/drougt_beta_marginal_distn_bycohort.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots, b5.mplots, b6.mplots)
dev.off()

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

# ------------------------- DOTPLOT MODEL SUMMARIES -----------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:

a1.sum <- a.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
a1.sum$variable <- unique(train.full$site)

df.site.struct <- unique(train.full[,c("site", "structure")])
a1.sum <- merge(a1.sum, df.site.struct, by.x = "variable", by.y = "site")
a1.sum$structure <- factor(a1.sum$structure, levels = c( "Forest", "Savanna"))

b2.sum <- b2.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b3.sum <- b3.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b4.sum <- b4.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.sum <- b5.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b6.sum <- b6.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

# write out all the dotplots
int.dot <- ggplot(data.frame(a1.sum), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Savanna"='sienna4',
"Forest"='forestgreen'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot <- ggplot(data.frame(b2.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot <- ggplot(data.frame(b3.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot <- ggplot(data.frame(b4.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot <- ggplot(data.frame(b5.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot <- ggplot(data.frame(b6.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/full_dot_plot_cohort_struct.png")
plot_grid(int.dot, b2.dot, b6.dot, b3.dot, b4.dot, b5.dot, ncol = 1, align = "v")
dev.off()

# -------------------- DOTPLOTS by modern vs. past only ---------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:
# a does not vary by cohort 
a1.sum.age <- a1.sum

b2.m$cohort <- ifelse(b2.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
b2.sum.age <- b2.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b3.m$cohort <- ifelse(b3.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b3.sum.age <- b3.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b4.m$cohort <- ifelse(b4.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b4.sum.age <- b4.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.m$cohort <- ifelse(b5.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b5.sum.age <- b5.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b6.m$cohort <- ifelse(b6.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b6.sum.age <- b6.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

# write out all the dotplots
int.dot.age <- ggplot(data.frame(a1.sum.age), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot.age <- ggplot(data.frame(b2.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot.age <- ggplot(data.frame(b3.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot.age <- ggplot(data.frame(b4.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot.age <- ggplot(data.frame(b5.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot.age <- ggplot(data.frame(b6.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/full_dot_plot_cohort_only.png")
plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1, align = "v")
dev.off()


png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/full_dot_plot_cohort_only.png")
plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1)
dev.off()


png(height = 12, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/full_dot_plot_cohort_and_cohortXstruct.png")
plot_grid(int.dot.age,int.dot,
         b2.dot.age , b2.dot, 
         b6.dot.age, b6.dot,
         b3.dot.age, b3.dot,
         b4.dot.age,  b4.dot,
         b5.dot.age, b5.dot, ncol = 2, align = "hv", labels = c("a","g",
                                                                "b","h",
                                                                "c","i",
                                                                "d","j",
                                                                "e","k",
                                                                "f","l"), label_x = 0.4)
dev.off()

# ------------------ Do the site level intercepts correlate with site quality -----------
# read in information about site quality:
locs <- read.csv("outputs/priority_sites_locs_with_soil_clim.csv")
locs <- data.frame(locs)
locs$code <- as.character(locs$code)
locs[6:9,]$code <- c( "GLL1", "GLL2", "GLL3", "GLL4")
sites <- c("COR", "HIC", "STC", "GLA", "TOW", "ENG", "UNC", "BON", "MOU", "GLL4", "GLL3", "GLL2", "GLL1", "PVC", "AVO", "PLE", "UNI")

# merge with a1.sum.age
site.summary <- merge(a1.sum.age, locs, by.x = "variable", by.y = "code")

# plot mean + 95% confidence interval vs. MAP
alpha.pr30yr <-ggplot(site.summary, aes(x = pr30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("Total Precip")
# get an idea if there might be relationship
summary(lm(mean.val ~ pr30yr,data = site.summary))

# plot mean + 95% confidence interval vs. Tmean
alpha.tm30yr <- ggplot(site.summary, aes(x = tm30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("Mean Temp")
# get an idea if there might be relationship
summary(lm(mean.val ~ tm30yr,data = site.summary))

# plot mean + 95% confidence interval vs. sand %
alpha.sand <- ggplot(site.summary, aes(x = sand, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("sand")#+stat_smooth(method = "lm")
# get an idea if there might be relationship
summary(lm(mean.val ~ sand,data = site.summary))

# plot mean + 95% confidence interval vs. ksat
alpha.ksat <-ggplot(site.summary, aes(x = ksat, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("ksat")
# get an idea if there might be relationship
summary(lm(mean.val ~ ksat,data = site.summary))

# plot mean + 95% confidence interval vs. awc

alpha.awc <- ggplot(site.summary, aes(x = awc, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("AWC")
# get an idea if there might be relationship
summary(lm(mean.val ~ awc, data = site.summary))

# plot mean + 95% confidence interval vs. n. species 

alpha.nspecies <- ggplot(site.summary, aes(x = nspecies, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept ")+xlab("nspecies")#+stat_smooth(data = site.summary, aes(x = nspecies, y = mean.val), method = "lm")
summary(lm(mean.val ~ nspecies, data = site.summary))


 

alpha.DBH <- ggplot(site.summary, aes(x = DBH, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("Average Site DBH")

summary(lm(mean.val ~ DBH, data = site.summary))


# there seems to be no relationship between alpha and site characteristics
# but plot the relationships out here:
png(height = 8, width = 6, units = "in",res = 200, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/alpha_site_ints_vs_site_quality.png")
plot_grid(alpha.pr30yr, alpha.tm30yr, alpha.awc, alpha.sand, alpha.nspecies, alpha.DBH, ncol = 2, align = "v", labels = "AUTO", label_x = 0.1)
dev.off()

#---------------------- More beta summary plots -----------------------------
png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots, b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.6))
dev.off()

# plot slightly differently:
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")

plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))

b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/param_marginal_distn_bycohort_struct_rb.png")
b2.dots.2
dev.off()

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(unique(train.full$struct.cohort)[order(unique(train.full[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(unique(train.full$struct.cohort)[order(unique(train.full[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(unique(train.full$struct.cohort)[order(unique(train.full[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

library(cowplot)
png(width = 5, height = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/param_marginal_distn_bycohort_struct_1.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, b5.mplots,ncol = 1)
dev.off()

# --------------------make plots of probed predicted growth responses:
# plot probed values of tree growth predictions:
Yprobe.samps <- data.frame(Y.probe[[1]])
colnames(Yprobe.samps) <- 1:length(Yprobe.samps)
probe.m <- melt(Yprobe.samps)
probe.m$RWI <- exp(probe.m$value) 
colnames(probe.m) <- c("num", "Ypred", "RWI")

probe <- short.probe
probe$num <- 1:length(probe[,1])
colnames(probe) <- c("struct.cohort","site","Drought", "DBH","Tmax", "RWI_1","RWI_2", "num")

# summarize by structure + cohort class only:
# summarize by structure + cohort class only:
probe$num <- as.factor(as.character(probe$num))
full.p <- probe

probtest.full <- dplyr::inner_join(probe.m, full.p, by=c("num"))

prob <- probtest.full
# save here:
saveRDS(prob, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/full_yprobe_preds.rds")
prob <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/full_yprobe_preds.rds")




# convert prob$Drought back to MAP:
library(DMwR)
DIprobe <- round(seq(range(train.full$MAP.scaled)[1], range(train.full$MAP.scaled)[2], by = 0.75), 3)



prob$DBH <- as.numeric(round(unscale(vals = prob$DBH, norm.data = DBH.scaled))) 
prob$MAP <- as.numeric(round(unscale(vals = prob$Drought, norm.data = MAP.scaled)))
prob$Tmax <- as.numeric(round(unscale(vals = prob$Tmax, norm.data = T.scaled))) 


prob_10_60cm_avg <- prob %>% dplyr::filter(DBH == 12 | DBH == 36 | DBH == 71 , Tmax == 22 | Tmax == 31, RWI_1 == 0.034, RWI_2 == 0.103 ) 

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train.full$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
 prob_10_60cm_avg <- merge(prob_10_60cm_avg,struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10 <- prob_10_60cm_avg %>% group_by(DBH, Drought, MAP,Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

preds_ci_10_age <- prob_10_60cm_avg %>% group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with LOWER than average tree growth the years before:

prob_10_60cm_low <- prob %>% dplyr::filter(DBH == 12 | DBH == 36 | DBH == 71 , Tmax == 22 | Tmax == 31, RWI_1 == -1.466, RWI_2 == -1.397 ) 

 
 prob_10_60cm_low <- merge(prob_10_60cm_low, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10_low <- prob_10_60cm_low %>% group_by(DBH, Drought,MAP, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))


preds_ci_10_low_age <- prob_10_60cm_low %>% group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with HIGHER than average tree growth the years before:

prob_10_60cm_high <- prob %>% dplyr::filter(DBH == 12 | DBH == 36 | DBH == 71 , Tmax == 22 | Tmax == 31, RWI_1 == 1.534, RWI_2 == 1.603  ) 


 prob_10_60cm_high <- merge(prob_10_60cm_high, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10_high <- prob_10_60cm_high %>% group_by(DBH, Drought,MAP, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

preds_ci_10_high_age <- prob_10_60cm_high %>% group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

#----------- plot drought response by max temperature and Dimaeter + cohort-struct class -----------

Drought.resp.DBH.temp.avgpyr <- ggplot(preds_ci_10, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()



Drought.resp.DBH.temp.lowpyr <- ggplot(preds_ci_10_low, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


Drought.resp.DBH.temp.highpyr <- ggplot(preds_ci_10_high, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


# output the above plots to PNG:
png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/MAP_response_low_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.lowpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/MAP_response_avg_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.avgpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/MAP_response_high_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.highpyr 
dev.off()


#----------- plot drought response by max temperature and Dimaeter + AGECLASS -----------

Drought.resp.DBH.temp.avgpyr.age <- ggplot(preds_ci_10_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()




Drought.resp.DBH.temp.lowpyr.age <- ggplot(preds_ci_10_low_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_10_low_age,aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


Drought.resp.DBH.temp.highpyr.age <- ggplot(preds_ci_10_high_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


# output the above plots to PNG:
png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/MAP_response_low_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.lowpyr.age 
dev.off()

png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/MAP_response_avg_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.avgpyr.age+theme_bw(base_size = 14)
dev.off()

png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/MAP_response_high_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.highpyr.age 
dev.off()





#--------------- plot marginal effects of climate and previous years growth ----------------

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train.full$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

 prob <- left_join(prob, struc.conversion, by  = "struct.cohort")

 # Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, ageclass) %>% summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()


legend <- get_legend(Y_MAP_marg)

png(height = 10, width = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/marginal_post_predictive_effects_ageclass.png")
plts <- plot_grid(Y_MAP_marg+theme(legend.position = "none"), Y_Tmax_marg+theme(legend.position = "none"), Y_DBH_marg+theme(legend.position = "none"), Y_RWI_1_marg+theme(legend.position = "none"), Y_RWI_2_marg+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()

# --------------plot marginal effects for each stand structure and cohort class:
# plot marginal effects of climate and previous years growth 
# Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg_c <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_MAP, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Total Precipitation")


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg_c <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Max. Temperature (DegF)")

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg_c <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Tree DBH (cm)")

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg_c <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-1) year's growth)")

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg_c <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-2) year's growth)")

png(height = 10, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/marginal_post_predictive_effects_ageclassXStruct.png")
legend <- get_legend(Y_MAP_marg_c)
plts <- plot_grid(Y_MAP_marg_c+theme(legend.position = "none"), Y_Tmax_marg_c+theme(legend.position = "none"), Y_DBH_marg_c+theme(legend.position = "none"), Y_RWI_1_marg_c+theme(legend.position = "none"), Y_RWI_2_marg_c+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.45))
dev.off()


# ------------- plot the marginal effects of each model parameter by site: ---------------

preds_ci_mod_past_MAP_site <- prob %>% group_by( MAP, ageclass, site) %>% summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg_site <- ggplot(preds_ci_mod_past_MAP_site, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP_site,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)

# marginal TMAX effect
preds_ci_mod_past_Tmax_site <- prob %>% group_by( Tmax,ageclass, site) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg_site <- ggplot(preds_ci_mod_past_Tmax_site, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax_site, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()+facet_wrap(~site)

# marginal DBH effect
preds_ci_mod_past_DBH_site <- prob %>% group_by( DBH,ageclass, site) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg_site <- ggplot(preds_ci_mod_past_DBH_site, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH_site, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()+facet_wrap(~site)

# marginal lag-1 effect
preds_ci_mod_past_RWI1_site <- prob %>% group_by( RWI_1,ageclass, site) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg_site <- ggplot(preds_ci_mod_past_RWI1_site, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1_site, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)

# marginal lag-2 effect
preds_ci_mod_past_RWI2_site <- prob %>% group_by( RWI_2, ageclass, site) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg_site <- ggplot(preds_ci_mod_past_RWI2_site, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2_site, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)


legend <- get_legend(Y_MAP_marg_site)

png(height = 25, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/marginal_post_predictive_effects_ageclass_by_site.png")
plts <- plot_grid(Y_MAP_marg_site+theme(legend.position = "none"), Y_Tmax_marg_site+theme(legend.position = "none"), Y_DBH_marg_site+theme(legend.position = "none"), Y_RWI_1_marg_site+theme(legend.position = "none"), Y_RWI_2_marg_site+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()



# ----------------------- Plot future predictions ------------------------
fut <- long.fut
# scenario # 1: no change from modern
Yfut.samps <- data.frame(Y.fut[[1]])

colnames(Yfut.samps) <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.samps$num <- 1:length(Yfut.samps[,2])
fut.m <- melt(Yfut.samps)
fut.m$RWI <- exp(fut.m$value)
colnames(fut.m) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "constant"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort","model",  "year", "site.num","site_year", "scenario")

# summarize by structure + cohort class only:

fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))


# scenario # 2: 35% decrease in drought sensitivie from modern
Yfut.35.samps <- data.frame(Y.fut.35[[1]])

colnames(Yfut.35.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.35.samps$num <- 1:length(Yfut.35.samps[,2])
fut.35.m <- melt(Yfut.35.samps)
fut.35.m $RWI <- exp(fut.35.m $value)
colnames(fut.35.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_35"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.35.proj <- dplyr::inner_join(fut.35.m, fut, by=c("site_year"))


# scenario # 3: 50% decrease in drought sensitivie from modern
Yfut.50.samps <- data.frame(Y.fut.50[[1]])

colnames(Yfut.50.samps) <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.50.samps$num <- 1:length(Yfut.50.samps[,2])
fut.50.m <- melt(Yfut.50.samps)
fut.50.m $RWI <- exp(fut.50.m $value)
colnames(fut.50.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_50"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.50.proj <- dplyr::inner_join(fut.50.m, fut, by=c("site_year"))

# scenario # 4: 50% decrease in drought sensitivy from modern & 50% increase in T sensitivity
Yfut.35.35.samps <- data.frame(Y.fut.35.35[[1]])

colnames(Yfut.35.35.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.35.35.samps$num <- 1:length(Yfut.35.35.samps[,2])
fut.35.35.m <- melt(Yfut.35.35.samps)
fut.35.35.m $RWI <- exp(fut.35.35.m $value)
colnames(fut.35.35.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_35.35"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.35.35.proj <- dplyr::inner_join(fut.35.35.m, fut, by=c("site_year"))



# scenario # 5: 50% decrease in drought sensitivy from modern & 50% increase in T sensitivity
Yfut.50.50.samps <- data.frame(Y.fut.50.50[[1]])

colnames(Yfut.50.50.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.50.50.samps$num <- 1:length(Yfut.50.50.samps[,2])
fut.50.50.m <- melt(Yfut.50.50.samps)
fut.50.50.m $RWI <- exp(fut.50.50.m $value)
colnames(fut.50.50.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_50.50"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.50.50.proj <- dplyr::inner_join(fut.50.50.m, fut, by=c("site_year"))


# now join all together :
all.proj <- rbind(fut.proj, fut.35.proj[!fut.35.proj$year == 2000,], fut.50.proj[!fut.50.proj$year == 2000,], fut.35.35.proj[!fut.35.35.proj$year == 2000,], fut.50.50.proj[!fut.50.50.proj$year == 2000,])



# ------------ For 26 cm tree and average prev years growth ----------------------
small.proj <- all.proj[all.proj$DBH == -0.413 & all.proj$RWI_1 == 0.103 & all.proj$RWI_2 == 0.103,]
small.proj$year <- ifelse(small.proj$year == 2050, "2050-2069",
                          ifelse(small.proj$year == 2070, "2070-2099", "2000"))
scenario_names <- c(
                    'constant' = "sensitivity constant",
                    'decrease_35' = "drought (taper 8%)",
                    'decrease_35.35' = "drought & temp. (taper 8%)",
                    'decrease_50.50' = "drought & temp. (no taper 15%)",
                    'decrease_50' = "drought (no taper 15%)"
                    )



# make one big plot for average previous years growth 
by.scenario <- ggplot(small.proj[!small.proj$year == 2000, ], aes(year, RWI, fill = as.character(year)))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000,]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+facet_grid(~ model + scenario)+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c("blue", "red"))+theme(legend.title = element_blank())


png(height = 4, width = 12, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/fut_growth_by_scenarios_26cm_avg_growth.png")
by.scenario+theme(legend.position = "none")
dev.off()


by.period <- ggplot(small.proj[!small.proj$year == 2000 , ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())

png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/fut_growth_by_time_scenarios_26cm_avg_growth.png")
by.period
dev.off()

by.model <- ggplot(small.proj[!small.proj$year == 2000, ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())+facet_grid(rows = vars(scenario), cols = vars(model))



png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/fut_growth_by_model_26cm_avg_growth.png")
by.model
dev.off()

small.proj$model <- factor(small.proj$model, levels = c("INMCM4", "HadGEM-ES2", "MIROC"))
model_names <- c(
                    'INMCM4' = "INMCM4 \n low Tmax - low Precip",
                    'HadGEM-ES2' = "HadGEM-ES2 \n high Tmax - low Precip",
                    'MIROC' = "MIROC \n high Tmax - high Precip"
                    
                    )


model_names <- c("INMCM4 \n low Tmax - low Precip",
                 "HadGEM-ES2 \n high Tmax - low Precip",
                 "MIROC \n high Tmax - high Precip")

by.model.2050 <- ggplot(small.proj[!small.proj$year == 2000 , ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 8%", "taper P & T 8%", "no taper P 15%", "no taper P & T 15%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())+facet_grid(~model)


png(height = 5, width = 9, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/fut_growth_by_model_2050_26cm_avg_growth.png")
by.model.2050
dev.off()

ggplot(small.proj[!small.proj$year == 2000 & !small.proj$year %in% "2070-2099", ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())+facet_grid(rows=vars(model), cols= vars(site))

# ------------ For 26 cm tree and high prev years growth ----------------------
small.high.proj <- all.proj[all.proj$DBH == -0.413 & all.proj$RWI_1 == 1.891 & all.proj$RWI_2 == 2.030,]
small.high.proj$year <- ifelse(small.high.proj$year == 2050, "2050-2069",
                          ifelse(small.high.proj$year == 2070, "2070-2099", "2000"))
scenario_names <- c(
                    'constant' = "sensitivity constant",
                    'decrease_35' = "drought (taper 35%)",
                    'decrease_35.35' = "drought & temp. (taper 35%)",
                    'decrease_50.50' = "drought & temp. (no taper 50%)",
                    'decrease_50' = "drought (no taper 50%)"
                    )



# make one big plot for average previous years growth 
by.scenario.hi <- ggplot(small.high.proj[!small.high.proj$year == 2000, ], aes(year, RWI, fill = as.character(year)))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.high.proj[small.high.proj$year ==2000,]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+facet_wrap(~scenario, nrow = 1, labeller = as_labeller(scenario_names))+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c("blue", "red"))+theme(legend.title = element_blank())


png(height = 4, width = 12, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/fut_growth_by_scenarios_26cm_high_growth.png")
by.scenario.hi+theme(legend.position = "none")
dev.off()


by.period.hi <- ggplot(small.high.proj[!small.high.proj$year == 2000, ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.high.proj[small.high.proj$year ==2000 & small.high.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())

png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/fut_growth_by_time_scenarios_26cm_high_growth.png")
by.period.hi
dev.off()



# left off here:
# ------------ For 26 cm tree and low prev years growth ----------------------
small.low.proj <- all.proj[all.proj$DBH == -0.413 & all.proj$RWI_1 == -1.609 & all.proj$RWI_2 == -1.470,]
small.low.proj$year <- ifelse(small.low.proj$year == 2050, "2050-2069",
                          ifelse(small.low.proj$year == 2070, "2070-2099", "2000"))
scenario_names <- c(
                    'constant' = "sensitivity constant",
                    'decrease_35' = "drought (taper 35%)",
                    'decrease_35.35' = "drought & temp. (taper 35%)",
                    'decrease_50.50' = "drought & temp. (no taper 50%)",
                    'decrease_50' = "drought (no taper 50%)"
                    )



# make one big plot for average previous years growth 
by.scenario.low <- ggplot(small.low.proj[!small.low.proj$year == 2000, ], aes(year, RWI, fill = as.character(year)))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.low.proj[small.low.proj$year ==2000,]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+facet_wrap(~scenario, nrow = 1, labeller = as_labeller(scenario_names))+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c("blue", "red"))+theme(legend.title = element_blank())


png(height = 4, width = 12, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/fut_growth_by_scenarios_26cm_low_growth.png")
by.scenario.low+theme(legend.position = "none")
dev.off()


by.period.low <- ggplot(small.low.proj[!small.low.proj$year == 2000, ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.low.proj[small.low.proj$year ==2000 & small.low.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())

png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/fut_growth_by_time_scenarios_26cm_low_growth.png")
by.period.low
dev.off()










fut.summary <- fut.proj %>% group_by(site_year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

fut.sum<- merge(fut.summary, fut, by = "site_year")

 #ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()
 ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
 ggplot(fut.sum, aes(Tmax, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
  ggplot(fut.sum, aes(site, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =site, ymin = Ci.low, ymax = Ci.high, color = year))+facet_wrap(~year)+ylim(0,5)
 

   ggplot(fut.sum, aes(as.character(year), meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =as.character(year), ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)
   
   
fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.sum$MAP <- as.numeric(round(unscale(vals = fut.sum$MAP, norm.data = MAP.scaled)))
fut.sum$Tmax <- as.numeric(round(unscale(vals = fut.sum$Tmax, norm.data = T.scaled))) 
fut.sum$year <- as.character(fut.sum$year)
 
 site.fut.tmax <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)
 
 
 sit.fut.map <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)+geom_smooth(method = "lm")
 
 ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~year)+ylim(0,3)+geom_smooth(method = "lm")+theme_bw()

  site.fut.tmax2 <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)

  site.fut.map2 <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
  
  
  fut.full <- fut.proj %>% group_by(year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95), MAP = mean(MAP), Tmax = mean(Tmax))+theme_bw()

#fut.full<- merge(fut.full, fut, by = "year")

#fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.full$MAP <- as.numeric(round(unscale(vals = fut.full$MAP, norm.data = MAP.scaled)))
fut.full$Tmax <- as.numeric(round(unscale(vals = fut.full$Tmax, norm.data = T.scaled))) 
fut.full$year <- as.character(fut.full$year)

fut.year<- ggplot(fut.full, aes(year, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =year, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+theme_bw(base_size = 15)+theme(legend.position = "none")

fut.T<- ggplot(fut.full, aes(Tmax, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Max. Temp")+theme_bw(base_size = 15)+theme(legend.position = "none")
 

fut.map<- ggplot(fut.full, aes(MAP, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =MAP, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Precipitation")+theme_bw(base_size = 15)+theme(legend.position = "none")

png(height = 3.5, width = 8, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/future_average_growth.png")
plot_grid(fut.year, fut.T, fut.map, align = "v", nrow = 1)
dev.off()
 

png(height = 5, width = 10, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/future_average_growth_by_site.png")
plot_grid(site.fut.tmax, sit.fut.map, ncol = 2)
dev.off()


# -------- Plot future predictions with further declines in drought sensitivity --------------

Yfut.35.samps <- data.frame(Y.fut.35[[1]])

colnames(Yfut.35.samps) <- paste0(fut$site, "_",fut$year)
Yfut.35.samps$num <- 1:length(Yfut.35.samps$AVO_2015)
fut.m <- melt(Yfut.35.samps)
fut.m$RWI <- exp(fut.m$value)
colnames(fut.m) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year)
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort",  "year", "site.num","site_year")

# summarize by structure + cohort class only:

fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))

fut.summary <- fut.proj %>% group_by(site_year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

fut.sum<- merge(fut.summary, fut, by = "site_year")

 #ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()
 ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
 ggplot(fut.sum, aes(Tmax, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
  ggplot(fut.sum, aes(site, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =site, ymin = Ci.low, ymax = Ci.high, color = year))+facet_wrap(~year)+ylim(0,5)
 

   ggplot(fut.sum, aes(as.character(year), meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =as.character(year), ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)
   
   
fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.sum$MAP <- as.numeric(round(unscale(vals = fut.sum$MAP, norm.data = MAP.scaled)))
fut.sum$Tmax <- as.numeric(round(unscale(vals = fut.sum$Tmax, norm.data = T.scaled))) 
fut.sum$year <- as.character(fut.sum$year)
 
 site.fut.tmax <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)
 
 
 sit.fut.map <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)+geom_smooth(method = "lm")
 
 ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~year)+ylim(0,3)+geom_smooth(method = "lm")+theme_bw()

  site.fut.tmax2 <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)

  site.fut.map2 <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
  
  
  fut.full <- fut.proj %>% group_by(year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95), MAP = mean(MAP), Tmax = mean(Tmax))

#fut.full<- merge(fut.full, fut, by = "year")

#fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.full$MAP <- as.numeric(round(unscale(vals = fut.full$MAP, norm.data = MAP.scaled)))
fut.full$Tmax <- as.numeric(round(unscale(vals = fut.full$Tmax, norm.data = T.scaled))) 
fut.full$year <- as.character(fut.full$year)

fut.year <- ggplot(fut.full, aes(year, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =year, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+theme_bw(base_size = 15)+theme(legend.position = "none")

fut.T<- ggplot(fut.full, aes(Tmax, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Max. Temp")+theme_bw(base_size = 15)+theme(legend.position = "none")
 

fut.map<- ggplot(fut.full, aes(MAP, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =MAP, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Precipitation")+theme_bw(base_size = 15)+theme(legend.position = "none")

png(height = 3.5, width = 8, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/future_average_growth_0.35_decline_drought_sens.png")
plot_grid(fut.year, fut.T, fut.map, align = "v", nrow = 1)
dev.off()
 

png(height = 5, width = 10, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/future_average_growth_by_site.png")
plot_grid(site.fut.tmax, sit.fut.map, ncol = 2)
dev.off()


# -------- Plot future predictions with further declines i.e. 50% in drought sensitivity --------------

Yfut.50.samps <- data.frame(Y.fut.50[[1]])

colnames(Yfut.50.samps) <- paste0(fut$site, "_",fut$year)
Yfut.50.samps$num <- 1:length(Yfut.50.samps$AVO_2015)
fut.m <- melt(Yfut.50.samps)
fut.m$RWI <- exp(fut.m$value)
colnames(fut.m) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year)
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort",  "year", "site.num","site_year")

# summarize by structure + cohort class only:

fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))

fut.summary <- fut.proj %>% group_by(site_year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

fut.sum<- merge(fut.summary, fut, by = "site_year")

 #ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()
 ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
 ggplot(fut.sum, aes(Tmax, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
  ggplot(fut.sum, aes(site, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =site, ymin = Ci.low, ymax = Ci.high, color = year))+facet_wrap(~year)+ylim(0,5)
 

   ggplot(fut.sum, aes(as.character(year), meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =as.character(year), ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)
   
   
fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.sum$MAP <- as.numeric(round(unscale(vals = fut.sum$MAP, norm.data = MAP.scaled)))
fut.sum$Tmax <- as.numeric(round(unscale(vals = fut.sum$Tmax, norm.data = T.scaled))) 
fut.sum$year <- as.character(fut.sum$year)
 
 site.fut.tmax <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)
 
 
 sit.fut.map <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)+geom_smooth(method = "lm")
 
 ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~year)+ylim(0,3)+geom_smooth(method = "lm")+theme_bw()

  site.fut.tmax2 <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)

  site.fut.map2 <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
  
  
  fut.full <- fut.proj %>% group_by(year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95), MAP = mean(MAP), Tmax = mean(Tmax))

#fut.full<- merge(fut.full, fut, by = "year")

#fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.full$MAP <- as.numeric(round(unscale(vals = fut.full$MAP, norm.data = MAP.scaled)))
fut.full$Tmax <- as.numeric(round(unscale(vals = fut.full$Tmax, norm.data = T.scaled))) 
fut.full$year <- as.character(fut.full$year)

fut.year <- ggplot(fut.full, aes(year, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =year, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+theme_bw(base_size = 15)+theme(legend.position = "none")

fut.T <- ggplot(fut.full, aes(Tmax, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Max. Temp")+theme_bw(base_size = 15)+theme(legend.position = "none")
 

fut.map <- ggplot(fut.full, aes(MAP, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =MAP, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Precipitation")+theme_bw(base_size = 15)+theme(legend.position = "none")

png(height = 3.5, width = 8, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/future_average_growth_0.50_decline_drought_sens.png")
plot_grid(fut.year, fut.T, fut.map, align = "v", nrow = 1)
dev.off()
 

png(height = 5, width = 10, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/future_average_growth_by_site_50.png")
plot_grid(site.fut.tmax, sit.fut.map, ncol = 2)
dev.off()



# -------- Plot future predictions with further declines i.e. 50% in drought sensitivity+ 50% increase in t sensitivity --------------

Yfut.50.50.samps <- data.frame(Y.fut.50.50[[1]])

colnames(Yfut.50.50.samps) <- paste0(fut$site, "_",fut$year)
Yfut.50.50.samps$num <- 1:length(Yfut.50.50.samps$AVO_2015)
fut.m <- melt(Yfut.50.50.samps)
fut.m$RWI <- exp(fut.m$value)
colnames(fut.m) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year)
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort",  "year", "site.num","site_year")

# summarize by structure + cohort class only:

fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))

fut.summary <- fut.proj %>% group_by(site_year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

fut.sum<- merge(fut.summary, fut, by = "site_year")

 #ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()
 ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
 ggplot(fut.sum, aes(Tmax, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
  ggplot(fut.sum, aes(site, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =site, ymin = Ci.low, ymax = Ci.high, color = year))+facet_wrap(~year)+ylim(0,5)
 

   ggplot(fut.sum, aes(as.character(year), meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =as.character(year), ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)
   
   
fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.sum$MAP <- as.numeric(round(unscale(vals = fut.sum$MAP, norm.data = MAP.scaled)))
fut.sum$Tmax <- as.numeric(round(unscale(vals = fut.sum$Tmax, norm.data = T.scaled))) 
fut.sum$year <- as.character(fut.sum$year)
 
 site.fut.tmax <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)
 
 
 sit.fut.map <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)+geom_smooth(method = "lm")
 
 ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~year)+ylim(0,3)+geom_smooth(method = "lm")+theme_bw()

  site.fut.tmax2 <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)

  site.fut.map2 <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
  
  
  fut.full <- fut.proj %>% group_by(year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95), MAP = mean(MAP), Tmax = mean(Tmax))

#fut.full<- merge(fut.full, fut, by = "year")

#fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.full$MAP <- as.numeric(round(unscale(vals = fut.full$MAP, norm.data = MAP.scaled)))
fut.full$Tmax <- as.numeric(round(unscale(vals = fut.full$Tmax, norm.data = T.scaled))) 
fut.full$year <- as.character(fut.full$year)

fut.year <- ggplot(fut.full, aes(year, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =year, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+theme_bw(base_size = 15)+theme(legend.position = "none")

fut.T <- ggplot(fut.full, aes(Tmax, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Max. Temp")+theme_bw(base_size = 15)+theme(legend.position = "none")
 

fut.map <- ggplot(fut.full, aes(MAP, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =MAP, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Precipitation")+theme_bw(base_size = 15)+theme(legend.position = "none")

png(height = 3.5, width = 8, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/future_average_growth_0.50_decline_drought_sens50.50.png")
plot_grid(fut.year, fut.T, fut.map, align = "v", nrow = 1)
dev.off()
 

png(height = 5, width = 10, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full/future_average_growth_by_site_50.50.png")
plot_grid(site.fut.tmax, sit.fut.map, ncol = 2)
dev.off()


```
 
 # for all years, but comparing the two paired ageclasses:
 model with MAP as drought index stand structure by ageclass random effects and prev years growth (lag -1) and (lag - 2):
 
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"

population_model_site_int_structure_x_cohort_re_lag2_temp_MAP.f <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] # use Drought index as a scaled variable 
   

}



# Prediction from known data
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[site.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4[struct.cohort.p[i]]*log_RWI_1.p[i] +beta5[struct.cohort.p[i]]*log_RWI_2.p[i] + beta6[struct.cohort.p[i]]*Temp.scaled.p[i]
  }

# probe for prediction plots:
  for(i in 1:nprobe){
    Yprobe[i]  ~ dnorm(muprobe[i],inv.var)
    muprobe[i] <- beta1[site.probe[i]] + beta2[struct.cohort.probe[i]]*DI.scaled.probe[i] + beta3[struct.cohort.probe[i]]*DBH.scaled.probe[i] +beta4[struct.cohort.probe[i]]*log_RWI_1.probe[i] +beta5[struct.cohort.probe[i]]*log_RWI_2.probe[i] + beta6[struct.cohort.probe[i]]*Temp.scaled.probe[i]
  }

# project into the future (assuming no further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut[i]  ~ dnorm(mufut[i],inv.var)
    mufut[i] <- beta1[site.fut[i]] + beta2[struct.cohort.fut[i]]*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]
  }

# project into the future (assuming 35% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.35[i]  ~ dnorm(mufut2[i],inv.var)
    mufut2[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.92)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]
  }



# project into the future (assuming 50% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.50[i]  ~ dnorm(mufut3[i],inv.var)
    mufut3[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.85)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]
  }


# project into the future (assuming 8% further change in drought senseiivty & temperature):
  for(i in 1:nfut){
   Yfut.35.35[i]  ~ dnorm(mufut35[i],inv.var)
    mufut35[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.92)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + (beta6[struct.cohort.fut[i]]*1.08)*Temp.scaled.fut[i]
  }



# project into the future (assuming 7% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.50.50[i]  ~ dnorm(mufut50[i],inv.var)
    mufut50[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.85)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + (beta6[struct.cohort.fut[i]]*1.15)*Temp.scaled.fut[i]
  }

# project into the future (assuming 7% further change in drought senseiivty):
  for(i in 1:ndegree){
   Yfut.degree[i]  ~ dnorm(mufutdegree[i],inv.var)
    mufutdegree[i] <- beta1[site.deg[i]] + (beta2[struct.cohort.deg[i]]*0.85)*DI.scaled.deg[i] + beta3[struct.cohort.deg[i]]*DBH.scaled.deg[i] +beta4[struct.cohort.deg[i]]*log_RWI_1.deg[i] +beta5[struct.cohort.deg[i]]*log_RWI_2.deg[i] + (beta6[struct.cohort.deg[i]]*1.15)*Temp.scaled.deg[i]
  }


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){

beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
beta5[s] ~ dnorm(mu_beta5, inv_beta5)
beta6[s] ~ dnorm(mu_beta5, inv_beta6)
}


for(k in 1:Nsites){
beta1[k] ~ dnorm(mu_beta1, inv_beta1)
}


# use normalpriors for each  beta paramters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)
mu_beta4 ~ dunif(-2, 2)
mu_beta5 ~ dunif(-2, 2)
mu_beta6 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)
inv_beta6   ~ dgamma(0.01, 0.01)
sigma_beta6 <- 1/sqrt(inv_beta6)

# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)

}"

# save these for use later:
saveRDS(train, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/train.rds")
saveRDS(test, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/test.rds")
train <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/train.rds")
test <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/test.rds")
# assign site numbers to each site:
site.num.df <- data.frame(site = as.character(unique(train$site)), 
           site.num = 1:length(as.character(unique(train$site))))
train <- merge(train, site.num.df, by = "site" )
test <- merge(test, site.num.df, by = "site" )


# generate probe dataset:
 DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)
 DBHprobe <- round(seq(range(train$DBH.scaled)[1], range(train$DBH.scaled)[2], by = 0.75), 3)
 Tempprobe <- round(seq(range(train$T.scaled)[1], range(train$T.scaled)[2], by = 0.75), 3)
 RWI1probe <- round(seq(range(log(train$RWI_1))[1], range(log(train$RWI_1))[2], by = 0.5), 3)
 RWI2probe <- round(seq(range(log(train$RWI_2))[1], range(log(train$RWI_2))[2], by = 0.5), 3)
 
 # expand into full probe
probe <- expand.grid(DI.scaled = DIprobe, DBH.scaled = DBHprobe, T.scaled = Tempprobe,
                         RWI_1 = RWI1probe, RWI_2= RWI2probe, struct.cohort.code= 1:4, site.num = unique(train$site.num))
probe$DBH.scaled <- as.character(probe$DBH.scaled)
sit.cohorts <- unique(train[,c("struct.cohort.code", "site.num")])
probe <- merge(probe, sit.cohorts, by = c("struct.cohort.code", "site.num")) # make sure that each site only has savanna or forest in the probe

# make probe smaller to help with saving:
short.probe <- probe[probe$RWI_1 %in% c("-1.466", "0.034", "1.534") & probe$RWI_2 %in% c("-1.466", "0.034", "1.534") & probe$DBH.scaled %in% c("-1.95","0.3","1.8"),]

#short.probe <- probe

# make a probe for future climate projections at our sites!
rcp85 <- rcp85[!rcp85$site %in% c("COR", "GLL4", "HIC", "PLE", "PVC", "STC", "TOW"),]
future.probe_70 <- data.frame(MAP.scaled = rcp85$PR_85_70.scaled, DBH.scaled= -0.413, 
                              T.scaled = rcp85$Tx_70.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103,  struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_70$year <- 2070
future.probe_50 <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site,  model = rcp85$model)
future.probe_50$year <- 2050


# get climate averages from 1950 - present at each site:
train$struct.cohort.code2 <- as.numeric(train$struct.cohort.code)
train.clim.summary <-
  train[train$ageclass %in% "Modern", ] %>% group_by(site) %>% dplyr::summarise(
    MAP.scaled = mean(MAP.scaled),
    DBH.scaled = -0.413,
    T.scaled = mean(T.scaled),
    RWI_1 = 0.103,
    RWI_2 = 0.103,
    struct.cohort.code = mean(struct.cohort.code2),
    model = "none",
    year = 2000
    )



Average.prob <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_50$year <- 2050


fut <- rbind(future.probe_50, future.probe_70, train.clim.summary[,c("MAP.scaled", "DBH.scaled",  "T.scaled", "RWI_1", "RWI_2", "struct.cohort.code", "site","year","model")])


fut <- merge(fut, site.num.df, by = "site")

# look at the effects under two different DBH values
short.fut <- fut
fut.small <- fut
fut.large <- fut
fut.small$DBH.scaled <- -0.413
fut.large$DBH.scaled <- 1.900
long.fut <- rbind(fut.small, fut.large)


# look at the effects under average, below average, and above average different prev year growth values
lfut.low <- long.fut
lfut.avg <- long.fut
lfut.high <- long.fut

lfut.low$RWI_1 <- -1.609
lfut.low$RWI_2 <- -1.47

lfut.high$RWI_1 <- 1.891
lfut.high$RWI_2 <- 2.03


long.fut <- rbind(lfut.high, lfut.avg, lfut.low)

# ------another probe, but super simple-------
# we want to know how much increasing temperature by 1 deg C from the modern cohort at each site will change tree growth:

mod.mean.clim <- test %>% filter(ageclass %in% "Modern" & year > 1950) %>% group_by(site) %>% dplyr::summarize(mod.mean.Tmax = mean(JUNTmax, na.rm = TRUE), one = mean(JUNTmax, na.rm = TRUE) + 1,
          two = mean(JUNTmax, na.rm = TRUE) + 2,
         three = mean(JUNTmax, na.rm = TRUE) + 3,
         four = mean(JUNTmax, na.rm = TRUE) + 4,
         five = mean(JUNTmax, na.rm = TRUE) + 5,
         six = mean(JUNTmax, na.rm = TRUE) + 6,
        seven =  mean(JUNTmax, na.rm = TRUE) + 7,
        eight =  mean(JUNTmax, na.rm = TRUE) + 8, 
        mod.mean.MAP = mean(MAP.prism, na.rm = TRUE), 
        MAPminus100 = mean(MAP.prism, na.rm = TRUE)-100,
        MAPminus50 = mean(MAP.prism, na.rm = TRUE)-50,
        MAPplus50 = mean(MAP.prism, na.rm = TRUE)+50,
        MAPplus100 = mean(MAP.prism, na.rm = TRUE)+100
       )

MAP.scenarios <- mod.mean.clim %>% select(site, mod.mean.MAP:MAPplus100) %>% group_by(site) %>% gather(MAP.Scenario, MAP, mod.mean.MAP:MAPplus100)

temp.scenarios <- mod.mean.clim %>% select(site, mod.mean.Tmax:eight) %>% group_by(site) %>% gather(Temp.Scenario,Tmax, mod.mean.Tmax:eight)

#next merge by site but keep all
all.scen <- merge(MAP.scenarios, temp.scenarios, by = "site", all = TRUE)

# get the scaled values for MAP and TMAX:
all.scen$MAP.scaled <- as.numeric(scale(all.scen$MAP, attr(MAP.scaled, "scaled:center"), attr(MAP.scaled, "scaled:scale")))

all.scen$T.scaled <- as.numeric(scale(all.scen$Tmax, attr(T.scaled, "scaled:center"), attr(T.scaled, "scaled:scale")))

# expand grid to add structure + cohort class - add 1 diameter, add 1 lag, add 2 lag, then add probe to the model....will need to re-run model

extras <- expand.grid(RWI_1 = 0.103, 
                     RWI_2 = 0.103, 
                     site = unique(all.scen$site), 
                     DBH.scaled = 0.1322, # ~ 35 cm tree
                     struct.cohort.code = 1:4)

degree.scenario <- merge(all.scen, extras, by = "site", all = TRUE)
degree.scenario <- merge(degree.scenario, site.num.df, by = "site")

# actually run the model:

lag2.model.by_structure_x_cohort_t_pr <- jags.model(textConnection(population_model_site_int_structure_x_cohort_re_lag2_temp_MAP.f), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$MAP.scaled, DBH.scaled = train$DBH.scaled,log_RWI_1 = log(train$RWI_1),log_RWI_2 = log(train$RWI_2), Temp.scaled = train$T.scaled, struct.cohort = as.numeric(train$struct.cohort.code), SF = as.numeric(unique(train$struct.cohort.code)), site = train$site.num, Nsites = length(unique(train$site)),
  struct.cohort.p = as.numeric(test$struct.cohort.code), DBH.scaled.p = test$DBH.scaled, DI.scaled.p = test$MAP.scaled, log_RWI_1.p = log(test$RWI_1), log_RWI_2.p = log(test$RWI_2), Temp.scaled.p = test$T.scaled, site.p = test$site.num, np = length(as.numeric(test$struct.cohort.code)), 
  
  struct.cohort.probe = as.numeric(short.probe$struct.cohort.code), DBH.scaled.probe = short.probe$DBH.scaled, DI.scaled.probe = short.probe$DI.scaled, log_RWI_1.probe = short.probe$RWI_1, log_RWI_2.probe =short.probe$RWI_2, Temp.scaled.probe = short.probe$T.scaled, site.probe = short.probe$site.num, nprobe = length(as.numeric(short.probe$struct.cohort.code)), 
 
  struct.cohort.fut = as.numeric(long.fut$struct.cohort.code), DBH.scaled.fut = long.fut$DBH.scaled, DI.scaled.fut = long.fut$MAP.scaled, log_RWI_1.fut = long.fut$RWI_1, log_RWI_2.fut =long.fut$RWI_2, Temp.scaled.fut = long.fut$T.scaled, site.fut = long.fut$site.num, nfut = length(as.numeric(long.fut$struct.cohort.code)),
  
   struct.cohort.deg = as.numeric(degree.scenario$struct.cohort.code), DBH.scaled.deg = degree.scenario$DBH.scaled, DI.scaled.deg = degree.scenario$MAP.scaled, log_RWI_1.deg = degree.scenario$RWI_1, log_RWI_2.deg =degree.scenario$RWI_2, Temp.scaled.deg = degree.scenario$T.scaled, site.deg = degree.scenario$site.num, ndegree = length(as.numeric(degree.scenario$struct.cohort.code))
  # 
  
  ),
  n.chains = 3, n.adapt = 100)

update(lag2.model.by_structure_x_cohort_t_pr, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","beta6","sigma", "mu_beta1", "mu_beta2","mu_beta3", "mu_beta4","mu_beta5", "mu_beta6","Yp"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.probe <- coda.samples(lag2.model.by_structure_x_cohort_t_pr,
                     variable.names=c("Yprobe"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.degree <- coda.samples(lag2.model.by_structure_x_cohort_t_pr,
                     variable.names=c("Yfut.degree"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut"), 
                    n.chains = 3, n.iter=10000, thin = 15)
Y.fut.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.35"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.50"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.35.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.35.35"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.50.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.50.50"), 
                    n.chains = 3, n.iter=10000,thin = 15)

dic.full <- dic.samples(lag2.model.by_structure_x_cohort_t_pr, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag2_reg_struct_x_cohort_re_t_pr_full_pair_DIC.rds")



#summary(samp.structure.cohort.re)
#plot(samp.structure.cohort.re)

#gelman.diag(samp.structure.cohort.re, multivariate = FALSE)
#acfplot(samp.structure.cohort.re)

autocorr.plot(samp.structure.cohort.re [[1]][ , 'beta2[1]'], auto.layout = FALSE, lwd = 4, col = "red", lag.max = 100)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/samps.rds")
 samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/samps.rds")
 

  Yprobe.samps      <- Y.probe[[1]]
 saveRDS(Yprobe.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/Yprobe.samps.rds")
 Yprobe.samps <- readRDS( "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/Yprobe.samps.rds")
 
 
 Y.degree.samps      <- Y.degree[[1]]
 saveRDS( Y.degree.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/Y.degree.samps.rds")
  Y.degree.samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/Y.degree.samps.rds")
  Y.degree <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/Y.degree.samps.rds")
  
  Y.fut.samps      <- Y.fut[[1]]
 saveRDS(Y.fut.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/Y.fut.samps.rds")
 Y.fut.samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/Y.fut.samps.rds")
 
  Y.fut.35.samps      <- Y.fut.35[[1]]
 saveRDS(Y.fut.35.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/Y.fut.35.samps.rds")
 
  Y.fut.50.samps      <- Y.fut.50[[1]]
 saveRDS(Y.fut.50.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/Y.fut.50.samps.rds")
 
  Y.fut.35.35.samps      <- Y.fut.35.35[[1]]
 saveRDS(Y.fut.35.35.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/Y.fut.35.35.samps.rds")
 
   Y.fut.50.50.samps      <- Y.fut.50.50[[1]]
 saveRDS(Y.fut.50.50.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/Y.fut.50.50.samps.rds")
 
 
 samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/samps.rds")
 test <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/test.rds")
 train <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/train.rds")
#Yfut.samps <- samps[, 1:length(fut$RWI_1)]
#samps <- samps[,(length(fut$RWI_1)+1):length(colnames(samps))]
 Yp.samps <- samps[,1:(length(test$RWI))] 
 
 alpha.samps  <- samps[,(length(test$RWI)+1):(length(test$RWI)+ 16)]# one alpha for each of 16 sites
 beta2.samps <- samps[,(length(test$RWI)+17):(length(test$RWI)+20)]
 beta3.samps <- samps[,(length(test$RWI)+21):(length(test$RWI)+24)]
 beta4.samps <- samps[,(length(test$RWI)+25):(length(test$RWI)+ 28)]
 beta5.samps <- samps[,(length(test$RWI)+ 29):(length(test$RWI)+ 32)]
 beta6.samps <- samps[,(length(test$RWI)+ 33):(length(test$RWI)+ 36)]
 sigma.samps <- samps[,(length(test$RWI)+ 43)]
 sigma_betas <- samps[,(length(test$RWI)+ 37):(length(test$RWI)+ 42)]

 
 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)+theme_bw(base_size = 15)

# note best model fit so far
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_full_pair", 
                            model.summary = "beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_full_pair", 
                           train = "cohort.omit", 
                           DI.scaled = "JJApdsi")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)


# get difference between beta2.samps: (i.e are they different?)
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]




# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/marginal_beta3s.png")
par(mfrow=c(3,2))
hist(beta4.samps[,1], main = "beta4 Past-Forest")
hist(beta4.samps[,2], main = "beta4 Modern-Forest")
hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,4], main = "sigma beta4")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/marginal_beta4s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta5 Past-Forest")
hist(beta5.samps[,2], main = "beta5 Modern-Forest")
hist(beta5.samps[,3],  main = "beta5 Past-Savanna")
hist(beta5.samps[,4],  main = "beta5 Modern-Savanna")
hist(sigma_betas[,5], main = "sigma beta5")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/marginal_beta5s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta4 Past-Forest")
hist(beta5.samps[,2], main = "beta4 Modern-Forest")
hist(beta5.samps[,3],  main = "beta4 Past-Savanna")
hist(beta5.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,6], main = "sigma beta4")
dev.off()

# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- unique(train$site)#[order(unique(train[,c("site", "site.num")])[,2])])
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <-c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
#colnames(b2) <- c(paste0(c(unique(train$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope")

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH Index slope")


b4 <- data.frame(beta4.samps)
colnames(b4) <- c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-1 Index slope")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-2 Index slope")

b6 <- data.frame(beta6.samps)
colnames(b6) <- c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
b6$num <- rownames(b6)
b6.m <- melt(b6, id.vars=c("num"))
b6.mplots <- ggplot(b6.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Summer Temperature slope")

png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/drougt_beta_marginal_distn_bycohort.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots, b5.mplots, b6.mplots)
dev.off()

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

# ------------------------- DOTPLOT MODEL SUMMARIES -----------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:

a1.sum <- a.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
a1.sum$variable <- unique(train$site)

df.site.struct <- unique(train[,c("site", "structure")])
a1.sum <- merge(a1.sum, df.site.struct, by.x = "variable", by.y = "site")
a1.sum$structure <- factor(a1.sum$structure, levels = c( "Forest", "Savanna"))

b2.sum <- b2.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b3.sum <- b3.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b4.sum <- b4.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.sum <- b5.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b6.sum <- b6.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

# write out all the dotplots
int.dot <- ggplot(data.frame(a1.sum), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Savanna"='sienna4',
"Forest"='forestgreen'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot <- ggplot(data.frame(b2.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot <- ggplot(data.frame(b3.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot <- ggplot(data.frame(b4.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot <- ggplot(data.frame(b5.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot <- ggplot(data.frame(b6.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/full_dot_plot_cohort_struct.png")
plot_grid(int.dot, b2.dot, b6.dot, b3.dot, b4.dot, b5.dot, ncol = 1, align = "v")
dev.off()

# -------------------- DOTPLOTS by modern vs. past only ---------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:
# a does not vary by cohort 
a1.sum.age <- a1.sum

b2.m$cohort <- ifelse(b2.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
b2.sum.age <- b2.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b3.m$cohort <- ifelse(b3.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b3.sum.age <- b3.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b4.m$cohort <- ifelse(b4.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b4.sum.age <- b4.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.m$cohort <- ifelse(b5.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b5.sum.age <- b5.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b6.m$cohort <- ifelse(b6.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b6.sum.age <- b6.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

# write out all the dotplots
int.dot.age <- ggplot(data.frame(a1.sum.age), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot.age <- ggplot(data.frame(b2.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot.age <- ggplot(data.frame(b3.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot.age <- ggplot(data.frame(b4.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot.age <- ggplot(data.frame(b5.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot.age <- ggplot(data.frame(b6.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/full_dot_plot_cohort_only.png")
plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1, align = "v")
dev.off()


png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/full_dot_plot_cohort_only.png")
plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1)
dev.off()


png(height = 12, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/full_dot_plot_cohort_and_cohortXstruct.png")
plot_grid(int.dot.age,int.dot,
         b2.dot.age , b2.dot, 
         b6.dot.age, b6.dot,
         b3.dot.age, b3.dot,
         b4.dot.age,  b4.dot,
         b5.dot.age, b5.dot, ncol = 2, align = "hv", labels = c("a","g",
                                                                "b","h",
                                                                "c","i",
                                                                "d","j",
                                                                "e","k",
                                                                "f","l"), label_x = 0.4)
dev.off()

# ------------------ Do the site level intercepts correlate with site quality -----------
# read in information about site quality:
locs <- read.csv("outputs/priority_sites_locs_with_soil_clim.csv")
locs <- data.frame(locs)
locs$code <- as.character(locs$code)
locs[6:9,]$code <- c( "GLL1", "GLL2", "GLL3", "GLL4")
sites <- c("COR", "HIC", "STC", "GLA", "TOW", "ENG", "UNC", "BON", "MOU", "GLL4", "GLL3", "GLL2", "GLL1", "PVC", "AVO", "PLE", "UNI")

# merge with a1.sum.age
site.summary <- merge(a1.sum.age, locs, by.x = "variable", by.y = "code")

# plot mean + 95% confidence interval vs. MAP
alpha.pr30yr <-ggplot(site.summary, aes(x = pr30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("Total Precip")
# get an idea if there might be relationship
summary(lm(mean.val ~ pr30yr,data = site.summary))

# plot mean + 95% confidence interval vs. Tmean
alpha.tm30yr <- ggplot(site.summary, aes(x = tm30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("Mean Temp")
# get an idea if there might be relationship
summary(lm(mean.val ~ tm30yr,data = site.summary))

# plot mean + 95% confidence interval vs. sand %
alpha.sand <- ggplot(site.summary, aes(x = sand, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("sand")#+stat_smooth(method = "lm")
# get an idea if there might be relationship
summary(lm(mean.val ~ sand,data = site.summary))

# plot mean + 95% confidence interval vs. ksat
alpha.ksat <-ggplot(site.summary, aes(x = ksat, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("ksat")
# get an idea if there might be relationship
summary(lm(mean.val ~ ksat,data = site.summary))

# plot mean + 95% confidence interval vs. awc

alpha.awc <- ggplot(site.summary, aes(x = awc, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("AWC")
# get an idea if there might be relationship
summary(lm(mean.val ~ awc, data = site.summary))

# plot mean + 95% confidence interval vs. n. species 

alpha.nspecies <- ggplot(site.summary, aes(x = nspecies, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept ")+xlab("nspecies")#+stat_smooth(data = site.summary, aes(x = nspecies, y = mean.val), method = "lm")
summary(lm(mean.val ~ nspecies, data = site.summary))


 

alpha.DBH <- ggplot(site.summary, aes(x = DBH, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("Average Site DBH")

summary(lm(mean.val ~ DBH, data = site.summary))


# there seems to be no relationship between alpha and site characteristics
# but plot the relationships out here:
png(height = 8, width = 6, units = "in",res = 200, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/alpha_site_ints_vs_site_quality.png")
plot_grid(alpha.pr30yr, alpha.tm30yr, alpha.awc, alpha.sand, alpha.nspecies, alpha.DBH, ncol = 2, align = "v", labels = "AUTO", label_x = 0.1)
dev.off()

#---------------------- More beta summary plots -----------------------------
png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots, b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.6))
dev.off()

# plot slightly differently:
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")

plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))

b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/param_marginal_distn_bycohort_struct_rb.png")
b2.dots.2
dev.off()

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

library(cowplot)
png(width = 5, height = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/param_marginal_distn_bycohort_struct_1.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, b5.mplots,ncol = 1)
dev.off()

# --------------------make plots of probed predicted growth responses:
# plot probed values of tree growth predictions:
Yprobe.samps <- data.frame(Y.probe[[1]])
colnames(Yprobe.samps) <- 1:length(Yprobe.samps)
probe.m <- melt(Yprobe.samps)
probe.m$RWI <- exp(probe.m$value) 
colnames(probe.m) <- c("num", "Ypred", "RWI")

probe <- short.probe
probe$num <- 1:length(probe[,1])
colnames(probe) <- c("struct.cohort","site","Drought", "DBH","Tmax", "RWI_1","RWI_2", "num")

# summarize by structure + cohort class only:
# summarize by structure + cohort class only:
probe$num <- as.factor(as.character(probe$num))
full.p <- probe

probtest <- dplyr::inner_join(probe.m, full.p, by=c("num"))

prob <- probtest
# save here:
saveRDS(prob, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/full_yprobe_preds.rds")
prob <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/full_yprobe_preds.rds")




# convert prob$Drought back to MAP:
library(DMwR)
DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)



prob$DBH <- as.numeric(round(unscale(vals = as.numeric(prob$DBH), norm.data = DBH.scaled))) 
prob$MAP <- as.numeric(round(unscale(vals = prob$Drought, norm.data = MAP.scaled)))
prob$Tmax <- as.numeric(round(unscale(vals = prob$Tmax, norm.data = T.scaled))) 


prob_10_60cm_avg <- prob %>% dplyr::filter(DBH == 3 | DBH == 38 | DBH == 62 , Tmax == 22 | Tmax == 31, RWI_1 == 0.034, RWI_2 == 0.034 ) 

 struc.conversion <- data.frame(struct.cohort = unique(train$struct.cohort.code2), cohort = c(paste0(c(unique(train$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
 
 prob_10_60cm_avg <- merge(prob_10_60cm_avg, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10 <- prob_10_60cm_avg %>% dplyr::group_by(DBH, Drought, MAP,Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

preds_ci_10_age <- prob_10_60cm_avg %>% dplyr::group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with LOWER than average tree growth the years before:

prob_10_60cm_low <- prob %>% dplyr::filter(DBH == 3 | DBH == 38 | DBH == 62 , Tmax == 22 | Tmax == 31, RWI_1 == -1.466, RWI_2 == -1.466 ) 

 
 prob_10_60cm_low <- merge(prob_10_60cm_low, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10_low <- prob_10_60cm_low %>% dplyr::group_by(DBH, Drought,MAP, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))


preds_ci_10_low_age <- prob_10_60cm_low %>% dplyr::group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with HIGHER than average tree growth the years before:

prob_10_60cm_high <- prob %>% dplyr::filter(DBH == 3 | DBH == 38 | DBH == 62 , Tmax == 22 | Tmax == 31, RWI_1 == 1.534, RWI_2 == 1.534  ) 


 prob_10_60cm_high <- merge(prob_10_60cm_high, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10_high <- prob_10_60cm_high %>% dplyr::group_by(DBH, Drought,MAP, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

preds_ci_10_high_age <- prob_10_60cm_high %>% dplyr::group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

#----------- plot drought response by max temperature and Dimaeter + cohort-struct class -----------

Drought.resp.DBH.temp.avgpyr <- ggplot(preds_ci_10, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()



Drought.resp.DBH.temp.lowpyr <- ggplot(preds_ci_10_low, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


Drought.resp.DBH.temp.highpyr <- ggplot(preds_ci_10_high, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


# output the above plots to PNG:
png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/MAP_response_low_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.lowpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/MAP_response_avg_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.avgpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/MAP_response_high_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.highpyr 
dev.off()


#----------- plot drought response by max temperature and Dimaeter + AGECLASS -----------

Drought.resp.DBH.temp.avgpyr.age <- ggplot(preds_ci_10_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()




Drought.resp.DBH.temp.lowpyr.age <- ggplot(preds_ci_10_low_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_10_low_age,aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


Drought.resp.DBH.temp.highpyr.age <- ggplot(preds_ci_10_high_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


# output the above plots to PNG:
png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/MAP_response_low_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.lowpyr.age 
dev.off()

png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/MAP_response_avg_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.avgpyr.age+theme_bw(base_size = 14)
dev.off()

png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/MAP_response_high_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.highpyr.age 
dev.off()





#--------------- plot marginal effects of climate and previous years growth ----------------

 struc.conversion <- data.frame(struct.cohort = unique(train$struct.cohort.code2), cohort = c(paste0(c(unique(train$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

 prob <- left_join(prob, struc.conversion, by  = "struct.cohort")

 # Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, ageclass) %>% dplyr::summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax,ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH,ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1,ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2,ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()


legend <- get_legend(Y_MAP_marg)

png(height = 10, width = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/marginal_post_predictive_effects_ageclass.png")
plts <- plot_grid(Y_MAP_marg+theme(legend.position = "none"), Y_Tmax_marg+theme(legend.position = "none"), Y_DBH_marg+theme(legend.position = "none"), Y_RWI_1_marg+theme(legend.position = "none"), Y_RWI_2_marg+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()

# --------------plot marginal effects for each stand structure and cohort class:
# plot marginal effects of climate and previous years growth 
# Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg_c <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_MAP, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Total Precipitation")


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg_c <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Max. Temperature (DegF)")

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg_c <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Tree DBH (cm)")

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg_c <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-1) year's growth)")

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg_c <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-2) year's growth)")

png(height = 10, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/marginal_post_predictive_effects_ageclassXStruct.png")
legend <- get_legend(Y_MAP_marg_c)
plts <- plot_grid(Y_MAP_marg_c+theme(legend.position = "none"), Y_Tmax_marg_c+theme(legend.position = "none"), Y_DBH_marg_c+theme(legend.position = "none"), Y_RWI_1_marg_c+theme(legend.position = "none"), Y_RWI_2_marg_c+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.45))
dev.off()


# ------------- plot the marginal effects of each model parameter by site: ---------------

preds_ci_mod_past_MAP_site <- prob %>% group_by( MAP, ageclass, site) %>% dplyr::summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg_site <- ggplot(preds_ci_mod_past_MAP_site, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP_site,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)

# marginal TMAX effect
preds_ci_mod_past_Tmax_site <- prob %>% group_by( Tmax,ageclass, site) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg_site <- ggplot(preds_ci_mod_past_Tmax_site, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax_site, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()+facet_wrap(~site)

# marginal DBH effect
preds_ci_mod_past_DBH_site <- prob %>% group_by( DBH,ageclass, site) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg_site <- ggplot(preds_ci_mod_past_DBH_site, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH_site, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()+facet_wrap(~site)

# marginal lag-1 effect
preds_ci_mod_past_RWI1_site <- prob %>% group_by( RWI_1,ageclass, site) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg_site <- ggplot(preds_ci_mod_past_RWI1_site, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1_site, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)

# marginal lag-2 effect
preds_ci_mod_past_RWI2_site <- prob %>% group_by( RWI_2, ageclass, site) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg_site <- ggplot(preds_ci_mod_past_RWI2_site, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2_site, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)


legend <- get_legend(Y_MAP_marg_site)

png(height = 25, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/marginal_post_predictive_effects_ageclass_by_site.png")
plts <- plot_grid(Y_MAP_marg_site+theme(legend.position = "none"), Y_Tmax_marg_site+theme(legend.position = "none"), Y_DBH_marg_site+theme(legend.position = "none"), Y_RWI_1_marg_site+theme(legend.position = "none"), Y_RWI_2_marg_site+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()



# ----------------------- Plot future predictions ------------------------
fut <- short.fut
# scenario # 1: no change from modern
Yfut.samps <- data.frame(Y.fut[[1]])

colnames(Yfut.samps) <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.samps$num <- 1:length(Yfut.samps[,2])
fut.m <- melt(Yfut.samps)
fut.m$RWI <- exp(fut.m$value)
colnames(fut.m) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "constant"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort","model",  "year", "site.num","site_year", "scenario")

# summarize by structure + cohort class only:

fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))


# calculate the average change in growth relative to modern growth under higher Maximum Temperatures:
fut.proj$DBH_unscale <- as.numeric(round(unscale(vals = as.numeric(fut.proj$DBH), norm.data = DBH.scaled))) 
fut.proj$MAP_unscale <- as.numeric(round(unscale(vals = fut.proj$MAP, norm.data = MAP.scaled)))
fut.proj$Tmax_unscale <- as.numeric(round(unscale(vals = fut.proj$Tmax, norm.data = T.scaled), 1)) 

#-------------------Degree scenarios------------------
# get the Ydegree samples &  calculate % change in growth from the modern average overall:

Y.degree.samps <- data.frame(Y.degree)

colnames(Y.degree.samps) <- paste0(degree.scenario$site, "_",degree.scenario$MAP.Scenario, "_", degree.scenario$Temp.Scenario, "_", degree.scenario$DBH.scaled, "_", degree.scenario$RWI_1, "_", fut$RWI_2)

Y.degree.samps$num <- 1:length(Y.degree.samps[,2])
deg.m <- melt(Y.degree.samps)
deg.m$RWI <- exp(deg.m$value)
colnames(deg.m) <- c("id", "Ypred", "RWI")



degree.scenario$id <- paste0(degree.scenario$site, "_",degree.scenario$MAP.Scenario, "_", degree.scenario$Temp.Scenario, "_", degree.scenario$DBH.scaled, "_", degree.scenario$RWI_1, "_", fut$RWI_2)

pred.degree <- left_join(degree.scenario, deg.m, by = "id")
pred.degree$rownum <- 1:length(pred.degree$site)

# get average growth increase relative to mod.mean:


pct.change.low.ci <- pred.degree %>% select(rownum, site, MAP.Scenario, struct.cohort.code, Temp.Scenario, RWI) %>% group_by(site, MAP.Scenario, struct.cohort.code) %>% select( -Temp.Scenario)

# spread function was adding nas so, create dfs with RWI values:


past.Temp <- pred.degree %>% select(site, MAP.Scenario, struct.cohort.code, RWI, Temp.Scenario) %>% filter(Temp.Scenario %in% "mod.mean.Tmax") %>% rename(zero = RWI) %>% select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code, zero)

one <- pred.degree %>% select(site, MAP.Scenario, struct.cohort.code, RWI, Temp.Scenario) %>% filter(Temp.Scenario %in% "one" ) %>% rename(one = RWI) %>% select( -Temp.Scenario)%>% arrange(site, MAP.Scenario, struct.cohort.code, one)

two <- pred.degree %>%  select(site, MAP.Scenario, struct.cohort.code, RWI, Temp.Scenario) %>%filter(Temp.Scenario %in% "two" ) %>% rename(two = RWI) %>% select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code, two)

three <- pred.degree %>% select(site, MAP.Scenario, struct.cohort.code, RWI, Temp.Scenario) %>% filter(Temp.Scenario %in% "three" ) %>% rename(three = RWI) %>% select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code, three)

four <- pred.degree %>%  select(site, MAP.Scenario, struct.cohort.code, RWI, Temp.Scenario) %>%filter(Temp.Scenario %in% "four" ) %>% rename(four = RWI) %>% select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code, four)

five <-  pred.degree %>% select(site, MAP.Scenario, struct.cohort.code, RWI, Temp.Scenario) %>% filter(Temp.Scenario %in% "five" ) %>% rename(five = RWI) %>% select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code, five)

six <-  pred.degree %>%  select(site, MAP.Scenario, struct.cohort.code, RWI, Temp.Scenario) %>%filter(Temp.Scenario %in% "six" ) %>% rename(six = RWI) %>% select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code, six)

seven <-  pred.degree %>% select(site, MAP.Scenario, struct.cohort.code, RWI, Temp.Scenario) %>% filter(Temp.Scenario %in% "seven" ) %>% rename(seven = RWI) %>% select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code, seven)

eight <-  pred.degree %>% select(site, MAP.Scenario, struct.cohort.code, RWI, Temp.Scenario) %>% filter(Temp.Scenario %in% "eight" ) %>% rename(eight = RWI) %>% select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code, eight)
    

                                                                                                                                                                                                 
newdf <- cbind( past.Temp, one$one, two[,c("two")], three[,c("three")], four[,c("four")], five[, c("five")], six[, c("six")], seven[, c("seven")], eight[, c("eight")])       
colnames(newdf) <- c("site", "MAP.Scenario", "struct.cohort.code", "base", "one", "two", "three", "four", "five", "six", "seven", "eight")




pct.change.temp <- newdf %>% group_by(site, struct.cohort.code, MAP.Scenario)  %>%
  summarise(zero = mean(((base-base)/base)*100, na.rm = TRUE),
            one = mean(((one-base)/base)*100, na.rm = TRUE),
            two = mean(((two-base)/base)*100, na.rm = TRUE),
            three = mean(((three-base)/base)*100, na.rm = TRUE),
            four = mean(((four-base)/base)*100, na.rm = TRUE),
            five = mean(((five-base)/base)*100, na.rm = TRUE),
            six = mean(((six-base)/base)*100, na.rm = TRUE),
            seven = mean(((seven-base)/base)*100, na.rm = TRUE),
            eight = mean(((eight-base)/base)*100, na.rm = TRUE)
            ) %>% 
  gather(key = incT, pct_change, zero:eight)

pct.change.hi.ci <- newdf %>% group_by(site, struct.cohort.code, MAP.Scenario)  %>%
  summarise(zero = quantile(((base-base)/base)*100, 0.975 ,na.rm = TRUE),
            one = quantile(((one-base)/base)*100, 0.975 ,na.rm = TRUE),
            two = quantile(((two-base)/base)*100, 0.975 ,na.rm = TRUE),
            three = quantile(((three-base)/base)*100, 0.975 ,na.rm = TRUE),
            four = quantile(((four-base)/base)*100,0.975 , na.rm = TRUE),
            five = quantile(((five-base)/base)*100,0.975 , na.rm = TRUE),
            six = quantile(((six-base)/base)*100,0.975 , na.rm = TRUE),
            seven = quantile(((seven-base)/base)*100,0.975 , na.rm = TRUE),
            eight = quantile(((eight-base)/base)*100,0.975 , na.rm = TRUE)
            ) %>% 
  gather(key = incT, ci.hi, zero:eight)

pct.change.low.ci <- newdf %>% group_by(site, struct.cohort.code, MAP.Scenario)  %>%
  summarise(zero = quantile(((base-base)/base)*100, 0.025 ,na.rm = TRUE),
            one = quantile(((one-base)/base)*100, 0.025 ,na.rm = TRUE),
            two = quantile(((two-base)/base)*100, 0.025 ,na.rm = TRUE),
            three = quantile(((three-base)/base)*100, 0.025 ,na.rm = TRUE),
            four = quantile(((four-base)/base)*100, 0.025 , na.rm = TRUE),
            five = quantile(((five-base)/base)*100, 0.025 , na.rm = TRUE),
            six = quantile(((six-base)/base)*100, 0.025 , na.rm = TRUE),
            seven = quantile(((seven-base)/base)*100, 0.025 , na.rm = TRUE),
            eight = quantile(((eight-base)/base)*100, 0.025 , na.rm = TRUE)
            ) %>% 
  gather(key = incT, ci.low, zero:eight)

cis <- merge(pct.change.hi.ci, pct.change.low.ci, by = c("site", "incT", "struct.cohort.code", "MAP.Scenario") )
pct.change.temp <- merge(pct.change.temp, cis, by = c("site","incT", "struct.cohort.code", "MAP.Scenario")) 

Tdf <- data.frame(incT = c("zero", "one", "two", "three", "four", "five","six","seven", "eight"), 
           deltaT = 0:8)

pct.change.temp <- merge(pct.change.temp, Tdf, by = "incT")
pct.change.temp$struct.cohort.code <- as.character(pct.change.temp$struct.cohort.code)

ggplot(pct.change.temp[pct.change.temp$MAP.Scenario %in% "MAPplus100",], aes(deltaT, pct_change, color = struct.cohort.code))+geom_point()+geom_line() + geom_ribbon(data = pct.change.temp, aes(x = deltaT, ymin = ci.low, ymax = ci.hi, fill = struct.cohort.code), alpha = 0.25, colour = NA)+facet_wrap(~site)

ggplot(pct.change.temp[pct.change.temp$MAP.Scenario %in% "MAPminus100",], aes(deltaT, pct_change, color = struct.cohort.code))+geom_point()+geom_line() + geom_ribbon(data = pct.change.temp, aes(x = deltaT, ymin = ci.low, ymax = ci.hi, fill = struct.cohort.code), alpha = 0.25, colour = NA)+facet_wrap(~site)


# lets look at the summaries overall:


pct.change.temp <- newdf %>% group_by(MAP.Scenario)  %>%
  summarise(zero = mean(((base-base)/base)*100, na.rm = TRUE),
            one = mean(((one-base)/base)*100, na.rm = TRUE),
            two = mean(((two-base)/base)*100, na.rm = TRUE),
            three = mean(((three-base)/base)*100, na.rm = TRUE),
            four = mean(((four-base)/base)*100, na.rm = TRUE),
            five = mean(((five-base)/base)*100, na.rm = TRUE),
            six = mean(((six-base)/base)*100, na.rm = TRUE),
            seven = mean(((seven-base)/base)*100, na.rm = TRUE),
            eight = mean(((eight-base)/base)*100, na.rm = TRUE)
            ) %>% 
  gather(key = incT, pct_change, zero:eight)

pct.change.hi.ci <- newdf %>% group_by( MAP.Scenario)  %>%
  summarise(zero = quantile(((base-base)/base)*100, 0.9 ,na.rm = TRUE),
            one = quantile(((one-base)/base)*100, 0.9 ,na.rm = TRUE),
            two = quantile(((two-base)/base)*100, 0.9 ,na.rm = TRUE),
            three = quantile(((three-base)/base)*100, 0.9 ,na.rm = TRUE),
            four = quantile(((four-base)/base)*100,0.9 , na.rm = TRUE),
            five = quantile(((five-base)/base)*100,0.9 , na.rm = TRUE),
            six = quantile(((six-base)/base)*100,0.9 , na.rm = TRUE),
            seven = quantile(((seven-base)/base)*100,0.9 , na.rm = TRUE),
            eight = quantile(((eight-base)/base)*100,0.9 , na.rm = TRUE)
            ) %>% 
  gather(key = incT, ci.hi, zero:eight)

pct.change.low.ci <- newdf %>% group_by( MAP.Scenario)  %>%
  summarise(zero = quantile(((base-base)/base)*100, 0.1 ,na.rm = TRUE),
            one = quantile(((one-base)/base)*100, 0.1 ,na.rm = TRUE),
            two = quantile(((two-base)/base)*100, 0.1 ,na.rm = TRUE),
            three = quantile(((three-base)/base)*100, 0.1 ,na.rm = TRUE),
            four = quantile(((four-base)/base)*100, 0.1 , na.rm = TRUE),
            five = quantile(((five-base)/base)*100, 0.1 , na.rm = TRUE),
            six = quantile(((six-base)/base)*100, 0.1 , na.rm = TRUE),
            seven = quantile(((seven-base)/base)*100, 0.1 , na.rm = TRUE),
            eight = quantile(((eight-base)/base)*100, 0.1 , na.rm = TRUE)
            ) %>% 
  gather(key = incT, ci.low, zero:eight)

cis <- merge(pct.change.hi.ci, pct.change.low.ci, by = c("incT", "MAP.Scenario") )
pct.change.temp <- merge(pct.change.temp, cis, by = c("incT", "MAP.Scenario")) 

Tdf <- data.frame(incT = c("zero", "one", "two", "three", "four", "five","six","seven", "eight"), 
           deltaT = 0:8)

pct.change.temp <- merge(pct.change.temp, Tdf, by = "incT")
#pct.change.temp$struct.cohort.code <- as.character(pct.change.temp$struct.cohort.code)

ggplot(pct.change.temp, aes(deltaT, pct_change, color = MAP.Scenario))+geom_point()+geom_line() + geom_ribbon(data = pct.change.temp, aes(x = deltaT, ymin = ci.low, ymax = ci.hi, fill = MAP.Scenario), alpha = 0.25, colour = NA)


newdf.m <- newdf %>% group_by(MAP.Scenario, struct.cohort.code) %>% gather(key = incT, RWI, base:eight) %>% group_by(MAP.Scenario,incT, struct.cohort.code) %>%  summarise(meanRWI = mean(RWI, na.rm=TRUE),
                                                                                                                      ci.low = quantile(RWI, 0.025, na.rm = TRUE), 
                                                                                                                      ci.hi = quantile(RWI, 0.975, na.rm = TRUE))

Tdf <- data.frame(incT = c("zero", "one", "two", "three", "four", "five","six","seven", "eight"), 
           deltaT = 0:8)

newdf.m <- merge(newdf.m, Tdf, by = "incT")

# small, but continous declines:
ggplot()+geom_point(data = newdf.m, aes(deltaT, meanRWI, color = MAP.Scenario))+geom_line(data = newdf.m, aes(deltaT, meanRWI, color = MAP.Scenario)) + geom_ribbon(data = newdf.m, aes(x = deltaT, ymin = ci.low, ymax = ci.hi, fill = MAP.Scenario), alpha = 0.2) + ylim(0, 3) + xlab("Increase in Summer Tmax (deg C)") + ylab("Predicted Growth Increment")

pct.change.temp <- newdf %>% group_by(MAP.Scenario)  %>% 
  summarise(zero =mean ( base, na.rm = TRUE), one = mean(one, na.rm=TRUE), zero.low =quantile ( base,0.025, na.rm = TRUE), one.low = quantile(one, 0.025,na.rm=TRUE), zero.hi =quantile ( base,0.975, na.rm = TRUE), one.hi = mean(one, 0.975,na.rm=TRUE)) %>% group_by(MAP.Scenario) %>%
  summarize (one.pct = mean(((one-zero)/zero)*100,na.rm = TRUE),
             one.low = mean(((one.low-zero.low)/zero.low)*100,na.rm = TRUE),
             one.hi = mean(((one.hi-zero.hi)/zero.hi)*100,na.rm = TRUE))

ggplot(pct.change.temp, aes())




#get the difference in growth:




pct.change.temp <- newdf %>% group_by(MAP.Scenario)  %>%
  summarise(zero = mean(((base-base)), na.rm = TRUE),
            one = mean(((one-base)), na.rm = TRUE),
            two = mean(((two-base)), na.rm = TRUE),
            three = mean(((three-base)), na.rm = TRUE),
            four = mean(((four-base)), na.rm = TRUE),
            five = mean(((five-base)), na.rm = TRUE),
            six = mean(((six-base)), na.rm = TRUE),
            seven = mean(((seven-base)), na.rm = TRUE),
            eight = mean(((eight-base)), na.rm = TRUE)
            ) %>% 
  gather(key = incT, pct_change, zero:eight)

pct.change.hi.ci <- newdf %>% group_by( MAP.Scenario)  %>%
  summarise(zero = quantile(((base-base)), 0.975 ,na.rm = TRUE),
            one = quantile(((one-base)), 0.975 ,na.rm = TRUE),
            two = quantile(((two-base)), 0.975 ,na.rm = TRUE),
            three = quantile(((three-base)), 0.975 ,na.rm = TRUE),
            four = quantile(((four-base)),0.975 , na.rm = TRUE),
            five = quantile(((five-base)),0.975 , na.rm = TRUE),
            six = quantile(((six-base)),0.975 , na.rm = TRUE),
            seven = quantile(((seven-base)),0.975 , na.rm = TRUE),
            eight = quantile(((eight-base)),0.975 , na.rm = TRUE)
            ) %>% 
  gather(key = incT, ci.hi, zero:eight)

pct.change.low.ci <- newdf %>% group_by( MAP.Scenario)  %>%
  summarise(zero = quantile(((base-base)), 0.025 ,na.rm = TRUE),
            one = quantile(((one-base)), 0.025 ,na.rm = TRUE),
            two = quantile(((two-base)), 0.025 ,na.rm = TRUE),
            three = quantile(((three-base)), 0.025 ,na.rm = TRUE),
            four = quantile(((four-base)), 0.025 , na.rm = TRUE),
            five = quantile(((five-base)), 0.025 , na.rm = TRUE),
            six = quantile(((six-base)), 0.025 , na.rm = TRUE),
            seven = quantile(((seven-base)), 0.025 , na.rm = TRUE),
            eight = quantile(((eight-base)), 0.025 , na.rm = TRUE)
            ) %>% 
  gather(key = incT, ci.low, zero:eight)

cis <- merge(pct.change.hi.ci, pct.change.low.ci, by = c("incT", "MAP.Scenario") )
pct.change.temp <- merge(pct.change.temp, cis, by = c("incT", "MAP.Scenario")) 

Tdf <- data.frame(incT = c("zero", "one", "two", "three", "four", "five","six","seven", "eight"), 
           deltaT = 0:8)

pct.change.temp <- merge(pct.change.temp, Tdf, by = "incT")
#pct.change.temp$struct.cohort.code <- as.character(pct.change.temp$struct.cohort.code)

ggplot(pct.change.temp, aes(deltaT, pct_change, color = MAP.Scenario))+geom_point()+geom_line() + geom_ribbon(data = pct.change.temp, aes(x = deltaT, ymin = ci.low, ymax = ci.hi, fill = MAP.Scenario), alpha = 0.25, colour = NA)



#-------------------------Scenario 2--------------------
# scenario # 2: 35% decrease in drought sensitivie from modern
Yfut.35.samps <- data.frame(Y.fut.35[[1]])

colnames(Yfut.35.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.35.samps$num <- 1:length(Yfut.35.samps[,2])
fut.35.m <- melt(Yfut.35.samps)
fut.35.m $RWI <- exp(fut.35.m $value)
colnames(fut.35.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_35"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.35.proj <- dplyr::inner_join(fut.35.m, fut, by=c("site_year"))


# scenario # 3: 50% decrease in drought sensitivie from modern
Yfut.50.samps <- data.frame(Y.fut.50[[1]])

colnames(Yfut.50.samps) <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.50.samps$num <- 1:length(Yfut.50.samps[,2])
fut.50.m <- melt(Yfut.50.samps)
fut.50.m $RWI <- exp(fut.50.m $value)
colnames(fut.50.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_50"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.50.proj <- dplyr::inner_join(fut.50.m, fut, by=c("site_year"))

# scenario # 4: 50% decrease in drought sensitivy from modern & 50% increase in T sensitivity
Yfut.35.35.samps <- data.frame(Y.fut.35.35[[1]])

colnames(Yfut.35.35.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.35.35.samps$num <- 1:length(Yfut.35.35.samps[,2])
fut.35.35.m <- melt(Yfut.35.35.samps)
fut.35.35.m $RWI <- exp(fut.35.35.m $value)
colnames(fut.35.35.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_35.35"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.35.35.proj <- dplyr::inner_join(fut.35.35.m, fut, by=c("site_year"))



# scenario # 5: 50% decrease in drought sensitivy from modern & 50% increase in T sensitivity
Yfut.50.50.samps <- data.frame(Y.fut.50.50[[1]])

colnames(Yfut.50.50.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.50.50.samps$num <- 1:length(Yfut.50.50.samps[,1])
fut.50.50.m <- melt(Yfut.50.50.samps)
fut.50.50.m $RWI <- exp(fut.50.50.m $value)
colnames(fut.50.50.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_50.50"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.50.50.proj <- dplyr::inner_join(fut.50.50.m, fut, by=c("site_year"))


# now join all together :
all.proj <- rbind(fut.proj, fut.35.proj[!fut.35.proj$year == 2000,], fut.50.proj[!fut.50.proj$year == 2000,], fut.35.35.proj[!fut.35.35.proj$year == 2000,], fut.50.50.proj[!fut.50.50.proj$year == 2000,])



# ------------ For 26 cm tree and average prev years growth ----------------------
small.proj <- all.proj[all.proj$DBH == -0.413 & all.proj$RWI_1 == 0.103 & all.proj$RWI_2 == 0.103,]
small.proj$year <- ifelse(small.proj$year == 2050, "2050-2069",
                          ifelse(small.proj$year == 2070, "2070-2099", "2000"))
scenario_names <- c(
                    'constant' = "sensitivity constant",
                    'decrease_35' = "drought (taper 8%)",
                    'decrease_35.35' = "drought & temp. (taper 8%)",
                    'decrease_50.50' = "drought & temp. (no taper 15%)",
                    'decrease_50' = "drought (no taper 15%)"
                    )



# make one big plot for average previous years growth 
by.scenario <- ggplot(small.proj[!small.proj$year == 2000, ], aes(year, RWI, fill = as.character(year)))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000,]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+facet_grid(~ model + scenario)+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c("blue", "red"))+theme(legend.title = element_blank())


png(height = 4, width = 12, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/fut_growth_by_scenarios_26cm_avg_growth.png")
by.scenario+theme(legend.position = "none")
dev.off()


by.period <- ggplot(small.proj[!small.proj$year == 2000 , ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())

png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/fut_growth_by_time_scenarios_26cm_avg_growth.png")
by.period
dev.off()

by.model <- ggplot(small.proj[!small.proj$year == 2000, ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())+facet_grid(rows = vars(scenario), cols = vars(model))



png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/fut_growth_by_model_26cm_avg_growth.png")
by.model
dev.off()

small.proj$model <- factor(small.proj$model, levels = c("INMCM4", "HadGEM-ES2", "MIROC"))
model_names <- c(
                    'INMCM4' = "INMCM4 \n low Tmax - low Precip",
                    'HadGEM-ES2' = "HadGEM-ES2 \n high Tmax - low Precip",
                    'MIROC' = "MIROC \n high Tmax - high Precip"
                    
                    )


model_names <- c("INMCM4 \n low Tmax - low Precip",
                 "HadGEM-ES2 \n high Tmax - low Precip",
                 "MIROC \n high Tmax - high Precip")

by.model.2050 <- ggplot(small.proj[!small.proj$year == 2000 , ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 8%", "taper P & T 8%", "no taper P 15%", "no taper P & T 15%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())+facet_grid(~model)


png(height = 5, width = 9, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/fut_growth_by_model_2050_26cm_avg_growth.png")
by.model.2050
dev.off()

ggplot(small.proj[!small.proj$year == 2000 & !small.proj$year %in% "2070-2099", ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())+facet_grid(rows=vars(model), cols= vars(site))



# this code only works if you ran model with long prob
# # ------------ For 26 cm tree and high prev years growth ----------------------
# small.high.proj <- all.proj[all.proj$DBH == -0.413 & all.proj$RWI_1 == 1.891 & all.proj$RWI_2 == 2.030,]
# small.high.proj$year <- ifelse(small.high.proj$year == 2050, "2050-2069",
#                           ifelse(small.high.proj$year == 2070, "2070-2099", "2000"))
# scenario_names <- c(
#                     'constant' = "sensitivity constant",
#                     'decrease_35' = "drought (taper 35%)",
#                     'decrease_35.35' = "drought & temp. (taper 35%)",
#                     'decrease_50.50' = "drought & temp. (no taper 50%)",
#                     'decrease_50' = "drought (no taper 50%)"
#                     )
# 
# 
# 
# # make one big plot for average previous years growth 
# by.scenario.hi <- ggplot(small.high.proj[!small.high.proj$year == 2000, ], aes(year, RWI, fill = as.character(year)))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.high.proj[small.high.proj$year ==2000,]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+facet_wrap(~scenario, nrow = 1, labeller = as_labeller(scenario_names))+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c("blue", "red"))+theme(legend.title = element_blank())
# 

# png(height = 4, width = 12, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/fut_growth_by_scenarios_26cm_high_growth.png")
# by.scenario.hi+theme(legend.position = "none")
# dev.off()
# 
# 
# by.period.hi <- ggplot(small.high.proj[!small.high.proj$year == 2000, ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.high.proj[small.high.proj$year ==2000 & small.high.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
# ))+theme(legend.title = element_blank())
# 
# png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/fut_growth_by_time_scenarios_26cm_high_growth.png")
# by.period.hi
# dev.off()
# 
# 
# 
# 
# # ------------ For 26 cm tree and low prev years growth ----------------------
# small.low.proj <- all.proj[all.proj$DBH == -0.413 & all.proj$RWI_1 == -1.609 & all.proj$RWI_2 == -1.470,]
# small.low.proj$year <- ifelse(small.low.proj$year == 2050, "2050-2069",
#                           ifelse(small.low.proj$year == 2070, "2070-2099", "2000"))
# scenario_names <- c(
#                     'constant' = "sensitivity constant",
#                     'decrease_35' = "drought (taper 35%)",
#                     'decrease_35.35' = "drought & temp. (taper 35%)",
#                     'decrease_50.50' = "drought & temp. (no taper 50%)",
#                     'decrease_50' = "drought (no taper 50%)"
#                     )
# 
# 
# 
# # make one big plot for average previous years growth 
# by.scenario.low <- ggplot(small.low.proj[!small.low.proj$year == 2000, ], aes(year, RWI, fill = as.character(year)))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.low.proj[small.low.proj$year ==2000,]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+facet_wrap(~scenario, nrow = 1, labeller = as_labeller(scenario_names))+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c("blue", "red"))+theme(legend.title = element_blank())
# 
# 
# png(height = 4, width = 12, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/fut_growth_by_scenarios_26cm_low_growth.png")
# by.scenario.low+theme(legend.position = "none")
# dev.off()
# 
# 
# by.period.low <- ggplot(small.low.proj[!small.low.proj$year == 2000, ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.low.proj[small.low.proj$year ==2000 & small.low.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
# ))+theme(legend.title = element_blank())
# 
# png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/fut_growth_by_time_scenarios_26cm_low_growth.png")
# by.period.low
# dev.off()
# 
# 
# 
# 
# 



# #
# 
# fut.summary <- fut.proj %>% group_by(site_year) %>% dplyr::summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# fut.sum <- merge(fut.summary, fut, by = "site_year")
# 
#  #ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()
#  ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
#  
#  ggplot(fut.sum, aes(Tmax,meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
#  
#   ggplot(fut.sum, aes(site, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =site, ymin = Ci.low, ymax = Ci.high, color = year))+facet_wrap(~year)+ylim(0,5)
#  
# 
#    ggplot(fut.sum, aes(as.character(year), meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =as.character(year), ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)
#    
#    
# fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
# fut.sum$MAP <- as.numeric(round(unscale(vals = fut.sum$MAP, norm.data = MAP.scaled)))
# fut.sum$Tmax <- as.numeric(round(unscale(vals = fut.sum$Tmax, norm.data = T.scaled))) 
# fut.sum$year <- as.character(fut.sum$year)
#  
#  site.fut.tmax <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)
#  
#  
#  sit.fut.map <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)+geom_smooth(method = "lm")
#  
#  ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~year)+ylim(0,3)+geom_smooth(method = "lm")+theme_bw()
# 
#   site.fut.tmax2 <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
# 
#   site.fut.map2 <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
#   
#   
#   fut.full <- fut.proj %>% group_by(year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95), MAP = mean(MAP), Tmax = mean(Tmax))+theme_bw()
# 
# #fut.full<- merge(fut.full, fut, by = "year")
# 
# #fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
# fut.full$MAP <- as.numeric(round(unscale(vals = fut.full$MAP, norm.data = MAP.scaled)))
# fut.full$Tmax <- as.numeric(round(unscale(vals = fut.full$Tmax, norm.data = T.scaled))) 
# fut.full$year <- as.character(fut.full$year)
# 
# fut.year<- ggplot(fut.full, aes(year, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =year, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+theme_bw(base_size = 15)+theme(legend.position = "none")
# 
# fut.T<- ggplot(fut.full, aes(Tmax, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Max. Temp")+theme_bw(base_size = 15)+theme(legend.position = "none")
#  
# 
# fut.map<- ggplot(fut.full, aes(MAP, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =MAP, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Precipitation")+theme_bw(base_size = 15)+theme(legend.position = "none")
# 
# png(height = 3.5, width = 8, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/future_average_growth.png")
# plot_grid(fut.year, fut.T, fut.map, align = "v", nrow = 1)
# dev.off()
#  
# 
# png(height = 5, width = 10, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/future_average_growth_by_site.png")
# plot_grid(site.fut.tmax, sit.fut.map, ncol = 2)
# dev.off()
# 
# 
# # -------- Plot future predictions with further declines in drought sensitivity --------------
# 
# Yfut.35.samps <- data.frame(Y.fut.35[[1]])
# 
# colnames(Yfut.35.samps) <- paste0(fut$site, "_",fut$year)
# Yfut.35.samps$num <- 1:length(Yfut.35.samps$AVO_2015)
# fut.m <- melt(Yfut.35.samps)
# fut.m$RWI <- exp(fut.m$value)
# colnames(fut.m) <- c("site_year", "Ypred", "RWI")
# 
# fut$site_year <- paste0(fut$site, "_",fut$year)
# colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort",  "year", "site.num","site_year")
# 
# # summarize by structure + cohort class only:
# 
# fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))
# 
# fut.summary <- fut.proj %>% group_by(site_year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# fut.sum<- merge(fut.summary, fut, by = "site_year")
# 
#  #ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()
#  ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
#  
#  ggplot(fut.sum, aes(Tmax, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
#  
#   ggplot(fut.sum, aes(site, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =site, ymin = Ci.low, ymax = Ci.high, color = year))+facet_wrap(~year)+ylim(0,5)
#  
# 
#    ggplot(fut.sum, aes(as.character(year), meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =as.character(year), ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)
#    
#    
# fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
# fut.sum$MAP <- as.numeric(round(unscale(vals = fut.sum$MAP, norm.data = MAP.scaled)))
# fut.sum$Tmax <- as.numeric(round(unscale(vals = fut.sum$Tmax, norm.data = T.scaled))) 
# fut.sum$year <- as.character(fut.sum$year)
#  
#  site.fut.tmax <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)
#  
#  
#  sit.fut.map <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)+geom_smooth(method = "lm")
#  
#  ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~year)+ylim(0,3)+geom_smooth(method = "lm")+theme_bw()
# 
#   site.fut.tmax2 <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
# 
#   site.fut.map2 <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
#   
#   
#   fut.full <- fut.proj %>% group_by(year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95), MAP = mean(MAP), Tmax = mean(Tmax))
# 
# #fut.full<- merge(fut.full, fut, by = "year")
# 
# #fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
# fut.full$MAP <- as.numeric(round(unscale(vals = fut.full$MAP, norm.data = MAP.scaled)))
# fut.full$Tmax <- as.numeric(round(unscale(vals = fut.full$Tmax, norm.data = T.scaled))) 
# fut.full$year <- as.character(fut.full$year)
# 
# fut.year <- ggplot(fut.full, aes(year, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =year, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+theme_bw(base_size = 15)+theme(legend.position = "none")
# 
# fut.T<- ggplot(fut.full, aes(Tmax, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Max. Temp")+theme_bw(base_size = 15)+theme(legend.position = "none")
#  
# 
# fut.map<- ggplot(fut.full, aes(MAP, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =MAP, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Precipitation")+theme_bw(base_size = 15)+theme(legend.position = "none")
# 
# png(height = 3.5, width = 8, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/future_average_growth_0.35_decline_drought_sens.png")
# plot_grid(fut.year, fut.T, fut.map, align = "v", nrow = 1)
# dev.off()
#  
# 
# png(height = 5, width = 10, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/future_average_growth_by_site.png")
# plot_grid(site.fut.tmax, sit.fut.map, ncol = 2)
# dev.off()
# 
# 
# # -------- Plot future predictions with further declines i.e. 50% in drought sensitivity --------------
# 
# Yfut.50.samps <- data.frame(Y.fut.50[[1]])
# 
# colnames(Yfut.50.samps) <- paste0(fut$site, "_",fut$year)
# Yfut.50.samps$num <- 1:length(Yfut.50.samps$AVO_2015)
# fut.m <- melt(Yfut.50.samps)
# fut.m$RWI <- exp(fut.m$value)
# colnames(fut.m) <- c("site_year", "Ypred", "RWI")
# 
# fut$site_year <- paste0(fut$site, "_",fut$year)
# colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort",  "year", "site.num","site_year")
# 
# # summarize by structure + cohort class only:
# 
# fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))
# 
# fut.summary <- fut.proj %>% group_by(site_year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# fut.sum<- merge(fut.summary, fut, by = "site_year")
# 
#  #ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()
#  ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
#  
#  ggplot(fut.sum, aes(Tmax, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
#  
#   ggplot(fut.sum, aes(site, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =site, ymin = Ci.low, ymax = Ci.high, color = year))+facet_wrap(~year)+ylim(0,5)
#  
# 
#    ggplot(fut.sum, aes(as.character(year), meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =as.character(year), ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)
#    
#    
# fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
# fut.sum$MAP <- as.numeric(round(unscale(vals = fut.sum$MAP, norm.data = MAP.scaled)))
# fut.sum$Tmax <- as.numeric(round(unscale(vals = fut.sum$Tmax, norm.data = T.scaled))) 
# fut.sum$year <- as.character(fut.sum$year)
#  
#  site.fut.tmax <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)
#  
#  
#  sit.fut.map <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)+geom_smooth(method = "lm")
#  
#  ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~year)+ylim(0,3)+geom_smooth(method = "lm")+theme_bw()
# 
#   site.fut.tmax2 <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
# 
#   site.fut.map2 <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
#   
#   
#   fut.full <- fut.proj %>% group_by(year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95), MAP = mean(MAP), Tmax = mean(Tmax))
# 
# #fut.full<- merge(fut.full, fut, by = "year")
# 
# #fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
# fut.full$MAP <- as.numeric(round(unscale(vals = fut.full$MAP, norm.data = MAP.scaled)))
# fut.full$Tmax <- as.numeric(round(unscale(vals = fut.full$Tmax, norm.data = T.scaled))) 
# fut.full$year <- as.character(fut.full$year)
# 
# fut.year <- ggplot(fut.full, aes(year, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =year, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+theme_bw(base_size = 15)+theme(legend.position = "none")
# 
# fut.T <- ggplot(fut.full, aes(Tmax, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Max. Temp")+theme_bw(base_size = 15)+theme(legend.position = "none")
#  
# 
# fut.map <- ggplot(fut.full, aes(MAP, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =MAP, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Precipitation")+theme_bw(base_size = 15)+theme(legend.position = "none")
# 
# png(height = 3.5, width = 8, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/future_average_growth_0.50_decline_drought_sens.png")
# plot_grid(fut.year, fut.T, fut.map, align = "v", nrow = 1)
# dev.off()
#  
# 
# png(height = 5, width = 10, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/future_average_growth_by_site_50.png")
# plot_grid(site.fut.tmax, sit.fut.map, ncol = 2)
# dev.off()
# 
# 
# 
# # -------- Plot future predictions with further declines i.e. 50% in drought sensitivity+ 50% increase in t sensitivity --------------
# 
# Yfut.50.50.samps <- data.frame(Y.fut.50.50[[1]])
# 
# colnames(Yfut.50.50.samps) <- paste0(fut$site, "_",fut$year)
# Yfut.50.50.samps$num <- 1:length(Yfut.50.50.samps$AVO_2015)
# fut.m <- melt(Yfut.50.50.samps)
# fut.m$RWI <- exp(fut.m$value)
# colnames(fut.m) <- c("site_year", "Ypred", "RWI")
# 
# fut$site_year <- paste0(fut$site, "_",fut$year)
# colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort",  "year", "site.num","site_year")
# 
# # summarize by structure + cohort class only:
# 
# fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))
# 
# fut.summary <- fut.proj %>% group_by(site_year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# fut.sum<- merge(fut.summary, fut, by = "site_year")
# 
#  #ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()
#  ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
#  
#  ggplot(fut.sum, aes(Tmax, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
#  
#   ggplot(fut.sum, aes(site, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =site, ymin = Ci.low, ymax = Ci.high, color = year))+facet_wrap(~year)+ylim(0,5)
#  
# 
#    ggplot(fut.sum, aes(as.character(year), meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =as.character(year), ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)
#    
#    
# fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
# fut.sum$MAP <- as.numeric(round(unscale(vals = fut.sum$MAP, norm.data = MAP.scaled)))
# fut.sum$Tmax <- as.numeric(round(unscale(vals = fut.sum$Tmax, norm.data = T.scaled))) 
# fut.sum$year <- as.character(fut.sum$year)
#  
#  site.fut.tmax <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)
#  
#  
#  sit.fut.map <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)+geom_smooth(method = "lm")
#  
#  ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~year)+ylim(0,3)+geom_smooth(method = "lm")+theme_bw()
# 
#   site.fut.tmax2 <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
# 
#   site.fut.map2 <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
#   
#   
#   fut.full <- fut.proj %>% group_by(year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95), MAP = mean(MAP), Tmax = mean(Tmax))
# 
# #fut.full<- merge(fut.full, fut, by = "year")
# 
# #fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
# fut.full$MAP <- as.numeric(round(unscale(vals = fut.full$MAP, norm.data = MAP.scaled)))
# fut.full$Tmax <- as.numeric(round(unscale(vals = fut.full$Tmax, norm.data = T.scaled))) 
# fut.full$year <- as.character(fut.full$year)
# 
# fut.year <- ggplot(fut.full, aes(year, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =year, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+theme_bw(base_size = 15)+theme(legend.position = "none")
# 
# fut.T <- ggplot(fut.full, aes(Tmax, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Max. Temp")+theme_bw(base_size = 15)+theme(legend.position = "none")
#  
# 
# fut.map <- ggplot(fut.full, aes(MAP, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =MAP, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Precipitation")+theme_bw(base_size = 15)+theme(legend.position = "none")
# 
# png(height = 3.5, width = 8, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/future_average_growth_0.50_decline_drought_sens50.50.png")
# plot_grid(fut.year, fut.T, fut.map, align = "v", nrow = 1)
# dev.off()
#  
# 
# png(height = 5, width = 10, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair/future_average_growth_by_site_50.50.png")
# plot_grid(site.fut.tmax, sit.fut.map, ncol = 2)
# dev.off()

```
 
 
  # for all years, but comparing the two paired ageclasses:
 model with MAP as drought index stand structure by ageclass random effects and prev years growth (lag -1) and (lag - 2) and a parameter for previous climate:
 
```{r}
# this model has a parameter for the past 5 years MAP

population_model_site_int_structure_x_cohort_re_lag2_temp_MAP_MAP_lag.f <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] + beta7[struct.cohort[i]]*MAP.5.scaled[i] # use Drought index as a scaled variable 
   

}



# Prediction from known data
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[site.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4[struct.cohort.p[i]]*log_RWI_1.p[i] +beta5[struct.cohort.p[i]]*log_RWI_2.p[i] + beta6[struct.cohort.p[i]]*Temp.scaled.p[i] + beta7[struct.cohort.p[i]]*MAP.5.scaled.p[i]
  }

# probe for prediction plots:
  for(i in 1:nprobe){
    Yprobe[i]  ~ dnorm(muprobe[i],inv.var)
    muprobe[i] <- beta1[site.probe[i]] + beta2[struct.cohort.probe[i]]*DI.scaled.probe[i] + beta3[struct.cohort.probe[i]]*DBH.scaled.probe[i] +beta4[struct.cohort.probe[i]]*log_RWI_1.probe[i] +beta5[struct.cohort.probe[i]]*log_RWI_2.probe[i] + beta6[struct.cohort.probe[i]]*Temp.scaled.probe[i] + beta7[struct.cohort.probe[i]]*MAP.5.scaled.probe[i]
  }

# project into the future (assuming no further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut[i]  ~ dnorm(mufut[i],inv.var)
    mufut[i] <- beta1[site.fut[i]] + beta2[struct.cohort.fut[i]]*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]+ beta7[struct.cohort.fut[i]]*MAP.5.scaled.fut[i]
  }

# project into the future (assuming 35% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.35[i]  ~ dnorm(mufut2[i],inv.var)
    mufut2[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.92)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]+ beta7[struct.cohort.fut[i]]*MAP.5.scaled.fut[i]
  }



# project into the future (assuming 50% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.50[i]  ~ dnorm(mufut3[i],inv.var)
    mufut3[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.85)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]+ beta7[struct.cohort.fut[i]]*MAP.5.scaled.fut[i]
  }


# project into the future (assuming 8% further change in drought senseiivty & temperature):
  for(i in 1:nfut){
   Yfut.35.35[i]  ~ dnorm(mufut35[i],inv.var)
    mufut35[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.92)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + (beta6[struct.cohort.fut[i]]*1.08)*Temp.scaled.fut[i]+ beta7[struct.cohort.fut[i]]*MAP.5.scaled.fut[i]
  }



# project into the future (assuming 7% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.50.50[i]  ~ dnorm(mufut50[i],inv.var)
    mufut50[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.85)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + (beta6[struct.cohort.fut[i]]*1.15)*Temp.scaled.fut[i]+ beta7[struct.cohort.fut[i]]*MAP.5.scaled.fut[i]
  }

# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){

beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
beta5[s] ~ dnorm(mu_beta5, inv_beta5)
beta6[s] ~ dnorm(mu_beta5, inv_beta6)
beta7[s] ~ dnorm(mu_beta5, inv_beta6)
}


for(k in 1:Nsites){
beta1[k] ~ dnorm(mu_beta1, inv_beta1)
}


# use normalpriors for each  beta paramters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)
mu_beta4 ~ dunif(-2, 2)
mu_beta5 ~ dunif(-2, 2)
mu_beta6 ~ dunif(-2, 2)
mu_beta7 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)
inv_beta6   ~ dgamma(0.01, 0.01)
sigma_beta6 <- 1/sqrt(inv_beta6)
inv_beta7   ~ dgamma(0.01, 0.01)
sigma_beta7 <- 1/sqrt(inv_beta7)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)

}"

# save these for use later:
saveRDS(train, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/train.rds")
saveRDS(test, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/test.rds")
train <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/train.rds")
test <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/test.rds")
# assign site numbers to each site:
site.num.df <- data.frame(site = as.character(unique(train$site)), 
           site.num = 1:length(as.character(unique(train$site))))
train <- merge(train, site.num.df, by = "site" )
test <- merge(test, site.num.df, by = "site" )


# generate probe dataset:
 DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)
 DBHprobe <- round(seq(range(train$DBH.scaled)[1], range(train$DBH.scaled)[2], by = 0.75), 3)
 Tempprobe <- round(seq(range(train$T.scaled)[1], range(train$T.scaled)[2], by = 0.75), 3)
 RWI1probe <- round(seq(range(log(train$RWI_1))[1], range(log(train$RWI_1))[2], by = 0.5), 3)
 RWI2probe <- round(seq(range(log(train$RWI_2))[1], range(log(train$RWI_2))[2], by = 0.5), 3)
 MAP5probe <- round(seq(range(train$MAP.5.scaled)[1], range(train$MAP.5.scaled)[2], by = 0.5), 3)
 
 # expand into full probe
probe <- expand.grid(DI.scaled = DIprobe, DBH.scaled = DBHprobe, T.scaled = Tempprobe,
                         RWI_1 = RWI1probe, RWI_2= RWI2probe, MAP.5.scaled = MAP5probe,struct.cohort.code= 1:4, site.num = unique(train$site.num))
probe$DBH.scaled <- as.character(probe$DBH.scaled)

sit.cohorts <- unique(train[,c("struct.cohort.code", "site.num")])
probe <- merge(probe, sit.cohorts, by = c("struct.cohort.code", "site.num")) # make sure that each site only has savanna or forest in the probe

# make probe smaller to help with saving:
short.probe <- probe[probe$RWI_1 %in% c("-1.466", "0.034", "1.534") & probe$RWI_2 %in% c("-1.466", "0.034", "1.534") & probe$DBH.scaled %in% c("-1.95","0.3","1.8") & probe$MAP.5.scaled %in% c("-2.182","0.318","1.818"),]

#short.probe <- probe

# make a probe for future climate projections at our sites!
rcp85 <- rcp85[!rcp85$site %in% c("COR", "GLL4", "HIC", "PLE", "PVC", "STC", "TOW"),]
future.probe_70 <- data.frame(MAP.scaled = rcp85$PR_85_70.scaled, DBH.scaled= -0.413, 
                              T.scaled = rcp85$Tx_70.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, MAP.5.scaled = 0.318,  struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_70$year <- 2070
future.probe_50 <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, MAP.5.scaled = 0.318,struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site,  model = rcp85$model)
future.probe_50$year <- 2050


# get climate averages from 1950 - present at each site:
train$struct.cohort.code2 <- as.numeric(train$struct.cohort.code)
train.clim.summary <-
  train[train$ageclass %in% "Modern", ] %>% group_by(site) %>% dplyr::summarise(
    MAP.scaled = mean(MAP.scaled),
    DBH.scaled = -0.413,
    T.scaled = mean(T.scaled),
    RWI_1 = 0.103,
    RWI_2 = 0.103,
    MAP.5.scaled = 0.318,
    struct.cohort.code = mean(struct.cohort.code2),
    model = "none",
    year = 2000
    )



Average.prob <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, MAP.5.scaled = 0.318,struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_50$year <- 2050


fut <- rbind(future.probe_50, future.probe_70, train.clim.summary[,c("MAP.scaled", "DBH.scaled",  "T.scaled", "RWI_1", "RWI_2","MAP.5.scaled", "struct.cohort.code", "site","year","model")])


fut <- merge(fut, site.num.df, by = "site")

# look at the effects under two different DBH values
short.fut <- fut
fut.small <- fut
fut.large <- fut
fut.small$DBH.scaled <- -0.413
fut.large$DBH.scaled <- 1.900
long.fut <- rbind(fut.small, fut.large)


# look at the effects under average, below average, and above average different prev year growth values
lfut.low <- long.fut
lfut.avg <- long.fut
lfut.high <- long.fut

lfut.low$RWI_1 <- -1.609
lfut.low$RWI_2 <- -1.47

lfut.high$RWI_1 <- 1.891
lfut.high$RWI_2 <- 2.03

long.fut <- rbind(lfut.high, lfut.avg, lfut.low)

# use jags to specify the model:


lag2.model.by_structure_x_cohort_t_pr <- jags.model(textConnection(population_model_site_int_structure_x_cohort_re_lag2_temp_MAP_MAP_lag.f), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$MAP.scaled, DBH.scaled = train$DBH.scaled,log_RWI_1 = log(train$RWI_1),log_RWI_2 = log(train$RWI_2), Temp.scaled = train$T.scaled, MAP.5.scaled = train$MAP.5.scaled, struct.cohort = as.numeric(train$struct.cohort.code), SF = as.numeric(unique(train$struct.cohort.code)), site = train$site.num, Nsites = length(unique(train$site)),
                                
  struct.cohort.p = as.numeric(test$struct.cohort.code), DBH.scaled.p = test$DBH.scaled, DI.scaled.p = test$MAP.scaled, log_RWI_1.p = log(test$RWI_1), log_RWI_2.p = log(test$RWI_2), Temp.scaled.p = test$T.scaled, MAP.5.scaled.p = test$MAP.5.scaled, site.p = test$site.num, np = length(as.numeric(test$struct.cohort.code)), 
  
  struct.cohort.probe = as.numeric(short.probe$struct.cohort.code), DBH.scaled.probe = short.probe$DBH.scaled, DI.scaled.probe = short.probe$DI.scaled, log_RWI_1.probe = short.probe$RWI_1, log_RWI_2.probe =short.probe$RWI_2, Temp.scaled.probe = short.probe$T.scaled, MAP.5.scaled.probe = short.probe$MAP.5.scaled, site.probe = short.probe$site.num, nprobe = length(as.numeric(short.probe$struct.cohort.code)), 
 
  struct.cohort.fut = as.numeric(long.fut$struct.cohort.code), DBH.scaled.fut = long.fut$DBH.scaled, DI.scaled.fut = long.fut$MAP.scaled, log_RWI_1.fut = long.fut$RWI_1, log_RWI_2.fut =long.fut$RWI_2, Temp.scaled.fut = long.fut$T.scaled, MAP.5.scaled.fut = long.fut$MAP.5.scaled,site.fut = long.fut$site.num, nfut = length(as.numeric(long.fut$struct.cohort.code))
 
  
  ),
  n.chains = 3, n.adapt = 100)

update(lag2.model.by_structure_x_cohort_t_pr, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","beta6","beta7","sigma", "mu_beta1", "mu_beta2","mu_beta3", "mu_beta4","mu_beta5", "mu_beta6","mu_beta7","Yp"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.probe <- coda.samples(lag2.model.by_structure_x_cohort_t_pr,
                     variable.names=c("Yprobe"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut"), 
                    n.chains = 3, n.iter=10000, thin = 15)
Y.fut.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.35"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.50"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.35.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.35.35"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.50.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.50.50"), 
                    n.chains = 3, n.iter=10000,thin = 15)


dic.full <- dic.samples(lag2.model.by_structure_x_cohort_t_pr, n.chains = 3, n.iter=10000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5_DIC.rds")
#summary(samp.structure.cohort.re)
#plot(samp.structure.cohort.re)

#gelman.diag(samp.structure.cohort.re, multivariate = FALSE)
#acfplot(samp.structure.cohort.re)

autocorr.plot(samp.structure.cohort.re [[1]][ , 'beta2[1]'], auto.layout = FALSE, lwd = 4, col = "red", lag.max = 100)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/samps.rds")
 samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/samps.rds")
 

  Yprobe.samps      <- Y.probe[[1]]
 saveRDS(Yprobe.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/Yprobe.samps.rds")
 Yprobe.samps <-  readRDS( "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/Yprobe.samps.rds")
  
 Y.fut.samps      <- Y.fut[[1]]
 saveRDS(Y.fut.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/Y.fut.samps.rds")
 Y.fut.samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/Y.fut.samps.rds")
 
 
  Y.fut.35.samps      <- Y.fut.35[[1]]
 saveRDS(Y.fut.35.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/Y.fut.35.samps.rds")
 
 Y.fut.35.samps <- readRDS( "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/Y.fut.35.samps.rds")
 
  Y.fut.50.samps      <- Y.fut.50[[1]]
 saveRDS(Y.fut.50.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/Y.fut.50.samps.rds")
 Y.fut.50.samps <-  readRDS( "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/Y.fut.50.samps.rds")
 
  Y.fut.35.35.samps      <- Y.fut.35.35[[1]]
 saveRDS(Y.fut.35.35.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/Y.fut.35.35.samps.rds")
 Y.fut.35.35.samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/Y.fut.35.35.samps.rds")
 
   Y.fut.50.50.samps      <- Y.fut.50.50[[1]]
 saveRDS(Y.fut.50.50.samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/Y.fut.50.50.samps.rds")
Y.fut.50.50.samps<- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/Y.fut.50.50.samps.rds")

 
 samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/samps.rds")
 test <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/test.rds")
 train <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/train.rds")
#Yfut.samps <- samps[, 1:length(fut$RWI_1)]
#samps <- samps[,(length(fut$RWI_1)+1):length(colnames(samps))]
 Yp.samps <- samps[,1:(length(test$RWI))] 
 
 alpha.samps  <- samps[,(length(test$RWI)+1):(length(test$RWI)+ 16)]# one alpha for each of 16 sites
 beta2.samps <- samps[,(length(test$RWI)+17):(length(test$RWI)+20)]
 beta3.samps <- samps[,(length(test$RWI)+21):(length(test$RWI)+24)]
 beta4.samps <- samps[,(length(test$RWI)+25):(length(test$RWI)+ 28)]
 beta5.samps <- samps[,(length(test$RWI)+ 29):(length(test$RWI)+ 32)]
 beta6.samps <- samps[,(length(test$RWI)+ 33):(length(test$RWI)+ 36)]
 beta7.samps <- samps[,(length(test$RWI)+ 37):(length(test$RWI)+ 40)]
 sigma.samps <- samps[,(length(test$RWI)+ 48)]
 sigma_betas <- samps[,(length(test$RWI)+ 41):(length(test$RWI)+ 47)]

 
 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)+theme_bw(base_size = 15)

# note best model fit so far
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5", 
                            model.summary = "beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] + beta7[struct.cohort[i]]*MAP.5.scaled[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5", 
                           train = "cohort.omit", 
                           DI.scaled = "MAP")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)




# get difference between beta2.samps: (i.e are they different?)
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]




# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/marginal_beta3s.png")
par(mfrow=c(3,2))
hist(beta4.samps[,1], main = "beta4 Past-Forest")
hist(beta4.samps[,2], main = "beta4 Modern-Forest")
hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,4], main = "sigma beta4")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/marginal_beta4s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta5 Past-Forest")
hist(beta5.samps[,2], main = "beta5 Modern-Forest")
hist(beta5.samps[,3],  main = "beta5 Past-Savanna")
hist(beta5.samps[,4],  main = "beta5 Modern-Savanna")
hist(sigma_betas[,5], main = "sigma beta5")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/marginal_beta5s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta4 Past-Forest")
hist(beta5.samps[,2], main = "beta4 Modern-Forest")
hist(beta5.samps[,3],  main = "beta4 Past-Savanna")
hist(beta5.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,6], main = "sigma beta4")
dev.off()

# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- unique(train$site)#[order(unique(train[,c("site", "site.num")])[,2])])
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <-c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
#colnames(b2) <- c(paste0(c(unique(train$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope")

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH Index slope")


b4 <- data.frame(beta4.samps)
colnames(b4) <- c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-1 Index slope")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-2 Index slope")

b6 <- data.frame(beta6.samps)
colnames(b6) <- c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
b6$num <- rownames(b6)
b6.m <- melt(b6, id.vars=c("num"))
b6.mplots <- ggplot(b6.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Summer Temperature slope")


b7 <- data.frame(beta7.samps)
colnames(b7) <- c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
b7$num <- rownames(b7)
b7.m <- melt(b7, id.vars=c("num"))
b7.mplots <- ggplot(b7.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Past 5 years climate slope")


png(height = 8, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/drougt_beta_marginal_distn_bycohort.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots, b5.mplots, b6.mplots, b7.mplots)
dev.off()

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

# ------------------------- DOTPLOT MODEL SUMMARIES -----------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:

a1.sum <- a.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
a1.sum$variable <- unique(train$site)

df.site.struct <- unique(train[,c("site", "structure")])
a1.sum <- merge(a1.sum, df.site.struct, by.x = "variable", by.y = "site")
a1.sum$structure <- factor(a1.sum$structure, levels = c( "Forest", "Savanna"))

b2.sum <- b2.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b3.sum <- b3.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b4.sum <- b4.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.sum <- b5.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b6.sum <- b6.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b7.sum <- b7.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b7.sum$variable <- factor(b7.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


# write out all the dotplots
int.dot <- ggplot(data.frame(a1.sum), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Savanna"='sienna4',
"Forest"='forestgreen'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot <- ggplot(data.frame(b2.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot <- ggplot(data.frame(b3.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot <- ggplot(data.frame(b4.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot <- ggplot(data.frame(b5.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot <- ggplot(data.frame(b6.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b7.dot <- ggplot(data.frame(b7.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Past 5 years MAP sensitivity (Beta7)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 14, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/full_dot_plot_cohort_struct.png")
plot_grid(int.dot, b2.dot, b6.dot, b3.dot, b4.dot, b5.dot, b7.dot, ncol = 1, align = "v")
dev.off()

# -------------------- DOTPLOTS by modern vs. past only ---------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:
# a varies by stand
a1.sum.age <- a1.sum

b2.m$cohort <- ifelse(b2.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
b2.sum.age <- b2.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))


b3.m$cohort <- ifelse(b3.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b3.sum.age <- b3.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))

b4.m$cohort <- ifelse(b4.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b4.sum.age <- b4.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))


b5.m$cohort <- ifelse(b5.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b5.sum.age <- b5.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))


b6.m$cohort <- ifelse(b6.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b6.sum.age <- b6.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))



b7.m$cohort <- ifelse(b7.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b7.sum.age <- b7.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))

# write out all the dotplots
int.dot.age <- ggplot(data.frame(a1.sum.age), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot.age <- ggplot(data.frame(b2.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot.age <- ggplot(data.frame(b3.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot.age <- ggplot(data.frame(b4.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot.age <- ggplot(data.frame(b5.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot.age <- ggplot(data.frame(b6.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b7.dot.age <- ggplot(data.frame(b7.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Past 5yrs MAP sensitivity (Beta7)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/full_dot_plot_cohort_only.png")
plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, b7.dot.age, ncol = 1, align = "v")
dev.off()




png(height = 14, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/full_dot_plot_cohort_and_cohortXstruct.png")
plot_grid(int.dot.age,int.dot,
         b2.dot.age , b2.dot, 
         b6.dot.age, b6.dot,
         b3.dot.age, b3.dot,
         b4.dot.age,  b4.dot,
         b5.dot.age, b5.dot,
         b7.dot.age, b7.dot, ncol = 2, align = "hv", labels = c("a","g",
                                                                "b","h",
                                                                "c","i",
                                                                "d","j",
                                                                "e","k",
                                                                "f","l"), label_x = 0.4)
dev.off()

# ------------------ Do the site level intercepts correlate with site quality -----------
# read in information about site quality:
locs <- read.csv("outputs/priority_sites_locs_with_soil_clim.csv")
locs <- data.frame(locs)
locs$code <- as.character(locs$code)
locs[6:9,]$code <- c( "GLL1", "GLL2", "GLL3", "GLL4")
sites <- c("COR", "HIC", "STC", "GLA", "TOW", "ENG", "UNC", "BON", "MOU", "GLL4", "GLL3", "GLL2", "GLL1", "PVC", "AVO", "PLE", "UNI")

# merge with a1.sum.age
site.summary <- merge(a1.sum.age, locs, by.x = "variable", by.y = "code")

# plot mean + 95% confidence interval vs. MAP
alpha.pr30yr <-ggplot(site.summary, aes(x = pr30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("Total Precip")
# get an idea if there might be relationship
summary(lm(mean.val ~ pr30yr,data = site.summary))

# plot mean + 95% confidence interval vs. Tmean
alpha.tm30yr <- ggplot(site.summary, aes(x = tm30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("Mean Temp")
# get an idea if there might be relationship
summary(lm(mean.val ~ tm30yr,data = site.summary))

# plot mean + 95% confidence interval vs. sand %
alpha.sand <- ggplot(site.summary, aes(x = sand, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("sand")#+stat_smooth(method = "lm")
# get an idea if there might be relationship
summary(lm(mean.val ~ sand,data = site.summary))

# plot mean + 95% confidence interval vs. ksat
alpha.ksat <-ggplot(site.summary, aes(x = ksat, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("ksat")
# get an idea if there might be relationship
summary(lm(mean.val ~ ksat,data = site.summary))

# plot mean + 95% confidence interval vs. awc

alpha.awc <- ggplot(site.summary, aes(x = awc, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("AWC")
# get an idea if there might be relationship
summary(lm(mean.val ~ awc, data = site.summary))

# plot mean + 95% confidence interval vs. n. species 

alpha.nspecies <- ggplot(site.summary, aes(x = nspecies, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept ")+xlab("nspecies")#+stat_smooth(data = site.summary, aes(x = nspecies, y = mean.val), method = "lm")
summary(lm(mean.val ~ nspecies, data = site.summary))


 

alpha.DBH <- ggplot(site.summary, aes(x = DBH, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("Average Site DBH")

summary(lm(mean.val ~ DBH, data = site.summary))


# there seems to be no relationship between alpha and site characteristics
# but plot the relationships out here:
png(height = 8, width = 6, units = "in",res = 200, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/alpha_site_ints_vs_site_quality.png")
plot_grid(alpha.pr30yr, alpha.tm30yr, alpha.awc, alpha.sand, alpha.nspecies, alpha.DBH, ncol = 2, align = "v", labels = "AUTO", label_x = 0.1)
dev.off()

#---------------------- More beta summary plots -----------------------------
png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots, b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.6))
dev.off()

# plot slightly differently:
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")

plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))

b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/param_marginal_distn_bycohort_struct_rb.png")
b2.dots.2
dev.off()

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(unique(train$struct.cohort)[order(unique(train[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

library(cowplot)
png(width = 5, height = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/param_marginal_distn_bycohort_struct_1.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, b5.mplots,ncol = 1)
dev.off()

# --------------------make plots of probed predicted growth responses:
# plot probed values of tree growth predictions:
Yprobe.samps <- data.frame(Y.probe[[1]])
colnames(Yprobe.samps) <- 1:length(Yprobe.samps)
probe.m <- melt(Yprobe.samps)
probe.m$RWI <- exp(probe.m$value) 
colnames(probe.m) <- c("num", "Ypred", "RWI")

probe <- short.probe
probe$num <- 1:length(probe[,1])
colnames(probe) <- c("struct.cohort","site","Drought", "DBH","Tmax", "RWI_1","RWI_2", "num")

# summarize by structure + cohort class only:
# summarize by structure + cohort class only:
probe$num <- as.factor(as.character(probe$num))
full.p <- probe

probtest <- dplyr::inner_join(probe.m, full.p, by=c("num"))

prob <- probtest
# save here:
saveRDS(prob, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/full_yprobe_preds.rds")
prob <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/full_yprobe_preds.rds")




# convert prob$Drought back to MAP:
library(DMwR)
DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)



prob$DBH <- as.numeric(round(unscale(vals = as.numeric(prob$DBH), norm.data = DBH.scaled))) 
prob$MAP <- as.numeric(round(unscale(vals = prob$Drought, norm.data = MAP.scaled)))
prob$Tmax <- as.numeric(round(unscale(vals = prob$Tmax, norm.data = T.scaled))) 


prob_10_60cm_avg <- prob %>% dplyr::filter(DBH == 3 | DBH == 38 | DBH == 62 , Tmax == 22 | Tmax == 31, RWI_1 == 0.034, RWI_2 == 0.034 ) 

 struc.conversion <- data.frame(struct.cohort = unique(train$struct.cohort.code2), cohort = c(paste0(c(unique(train$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
 
 prob_10_60cm_avg <- merge(prob_10_60cm_avg, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10 <- prob_10_60cm_avg %>% dplyr::group_by(DBH, Drought, MAP,Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

preds_ci_10_age <- prob_10_60cm_avg %>% dplyr::group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with LOWER than average tree growth the years before:

prob_10_60cm_low <- prob %>% dplyr::filter(DBH == 3 | DBH == 38 | DBH == 62 , Tmax == 22 | Tmax == 31, RWI_1 == -1.466, RWI_2 == -1.466 ) 

 
 prob_10_60cm_low <- merge(prob_10_60cm_low, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10_low <- prob_10_60cm_low %>% dplyr::group_by(DBH, Drought,MAP, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))


preds_ci_10_low_age <- prob_10_60cm_low %>% dplyr::group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with HIGHER than average tree growth the years before:

prob_10_60cm_high <- prob %>% dplyr::filter(DBH == 3 | DBH == 38 | DBH == 62 , Tmax == 22 | Tmax == 31, RWI_1 == 1.534, RWI_2 == 1.534  ) 


 prob_10_60cm_high <- merge(prob_10_60cm_high, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10_high <- prob_10_60cm_high %>% dplyr::group_by(DBH, Drought,MAP, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

preds_ci_10_high_age <- prob_10_60cm_high %>% dplyr::group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

#----------- plot drought response by max temperature and Dimaeter + cohort-struct class -----------

Drought.resp.DBH.temp.avgpyr <- ggplot(preds_ci_10, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()



Drought.resp.DBH.temp.lowpyr <- ggplot(preds_ci_10_low, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


Drought.resp.DBH.temp.highpyr <- ggplot(preds_ci_10_high, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


# output the above plots to PNG:
png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/MAP_response_low_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.lowpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/MAP_response_avg_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.avgpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/MAP_response_high_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.highpyr 
dev.off()


#----------- plot drought response by max temperature and Dimaeter + AGECLASS -----------

Drought.resp.DBH.temp.avgpyr.age <- ggplot(preds_ci_10_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()




Drought.resp.DBH.temp.lowpyr.age <- ggplot(preds_ci_10_low_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_10_low_age,aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


Drought.resp.DBH.temp.highpyr.age <- ggplot(preds_ci_10_high_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


# output the above plots to PNG:
png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/MAP_response_low_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.lowpyr.age 
dev.off()

png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/MAP_response_avg_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.avgpyr.age+theme_bw(base_size = 14)
dev.off()

png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/MAP_response_high_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.highpyr.age 
dev.off()





#--------------- plot marginal effects of climate and previous years growth ----------------

 struc.conversion <- data.frame(struct.cohort = unique(train$struct.cohort.code2), cohort = c(paste0(c(unique(train$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

 prob <- left_join(prob, struc.conversion, by  = "struct.cohort")

 # Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, ageclass) %>% dplyr::summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax,ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH,ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1,ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2,ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()


legend <- get_legend(Y_MAP_marg)

png(height = 10, width = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/marginal_post_predictive_effects_ageclass.png")
plts <- plot_grid(Y_MAP_marg+theme(legend.position = "none"), Y_Tmax_marg+theme(legend.position = "none"), Y_DBH_marg+theme(legend.position = "none"), Y_RWI_1_marg+theme(legend.position = "none"), Y_RWI_2_marg+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()

# --------------plot marginal effects for each stand structure and cohort class:
# plot marginal effects of climate and previous years growth 
# Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg_c <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_MAP, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Total Precipitation")


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg_c <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Max. Temperature (DegF)")

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg_c <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Tree DBH (cm)")

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg_c <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-1) year's growth)")

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg_c <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-2) year's growth)")

png(height = 10, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/marginal_post_predictive_effects_ageclassXStruct.png")
legend <- get_legend(Y_MAP_marg_c)
plts <- plot_grid(Y_MAP_marg_c+theme(legend.position = "none"), Y_Tmax_marg_c+theme(legend.position = "none"), Y_DBH_marg_c+theme(legend.position = "none"), Y_RWI_1_marg_c+theme(legend.position = "none"), Y_RWI_2_marg_c+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.45))
dev.off()


# ------------- plot the marginal effects of each model parameter by site: ---------------

preds_ci_mod_past_MAP_site <- prob %>% group_by( MAP, ageclass, site) %>% dplyr::summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg_site <- ggplot(preds_ci_mod_past_MAP_site, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP_site,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)

# marginal TMAX effect
preds_ci_mod_past_Tmax_site <- prob %>% group_by( Tmax,ageclass, site) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg_site <- ggplot(preds_ci_mod_past_Tmax_site, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax_site, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()+facet_wrap(~site)

# marginal DBH effect
preds_ci_mod_past_DBH_site <- prob %>% group_by( DBH,ageclass, site) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg_site <- ggplot(preds_ci_mod_past_DBH_site, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH_site, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()+facet_wrap(~site)

# marginal lag-1 effect
preds_ci_mod_past_RWI1_site <- prob %>% group_by( RWI_1,ageclass, site) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg_site <- ggplot(preds_ci_mod_past_RWI1_site, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1_site, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)

# marginal lag-2 effect
preds_ci_mod_past_RWI2_site <- prob %>% group_by( RWI_2, ageclass, site) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg_site <- ggplot(preds_ci_mod_past_RWI2_site, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2_site, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)


legend <- get_legend(Y_MAP_marg_site)

png(height = 25, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/marginal_post_predictive_effects_ageclass_by_site.png")
plts <- plot_grid(Y_MAP_marg_site+theme(legend.position = "none"), Y_Tmax_marg_site+theme(legend.position = "none"), Y_DBH_marg_site+theme(legend.position = "none"), Y_RWI_1_marg_site+theme(legend.position = "none"), Y_RWI_2_marg_site+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()



# ----------------------- Plot future predictions ------------------------
fut <-short.fut
# scenario # 1: no change from modern
Yfut.samps <- data.frame(Y.fut[[1]])

colnames(Yfut.samps) <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.samps$num <- 1:length(Yfut.samps[,2])
fut.m <- melt(Yfut.samps)
fut.m$RWI <- exp(fut.m$value)
colnames(fut.m) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "constant"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort","model",  "year", "site.num","site_year", "scenario")

# summarize by structure + cohort class only:

fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))


# scenario # 2: 35% decrease in drought sensitivie from modern
Yfut.35.samps <- data.frame(Y.fut.35[[1]])

colnames(Yfut.35.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.35.samps$num <- 1:length(Yfut.35.samps[,2])
fut.35.m <- melt(Yfut.35.samps)
fut.35.m $RWI <- exp(fut.35.m $value)
colnames(fut.35.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_35"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.35.proj <- dplyr::inner_join(fut.35.m, fut, by=c("site_year"))


# scenario # 3: 50% decrease in drought sensitivie from modern
Yfut.50.samps <- data.frame(Y.fut.50[[1]])

colnames(Yfut.50.samps) <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.50.samps$num <- 1:length(Yfut.50.samps[,2])
fut.50.m <- melt(Yfut.50.samps)
fut.50.m $RWI <- exp(fut.50.m $value)
colnames(fut.50.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_50"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.50.proj <- dplyr::inner_join(fut.50.m, fut, by=c("site_year"))

# scenario # 4: 50% decrease in drought sensitivy from modern & 50% increase in T sensitivity
Yfut.35.35.samps <- data.frame(Y.fut.35.35[[1]])

colnames(Yfut.35.35.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.35.35.samps$num <- 1:length(Yfut.35.35.samps[,2])
fut.35.35.m <- melt(Yfut.35.35.samps)
fut.35.35.m $RWI <- exp(fut.35.35.m $value)
colnames(fut.35.35.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_35.35"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.35.35.proj <- dplyr::inner_join(fut.35.35.m, fut, by=c("site_year"))



# scenario # 5: 50% decrease in drought sensitivy from modern & 50% increase in T sensitivity
Yfut.50.50.samps <- data.frame(Y.fut.50.50[[1]])

colnames(Yfut.50.50.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.50.50.samps$num <- 1:length(Yfut.50.50.samps[,1])
fut.50.50.m <- melt(Yfut.50.50.samps)
fut.50.50.m $RWI <- exp(fut.50.50.m $value)
colnames(fut.50.50.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_50.50"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.50.50.proj <- dplyr::inner_join(fut.50.50.m, fut, by=c("site_year"))


# now join all together :
all.proj <- rbind(fut.proj, fut.35.proj[!fut.35.proj$year == 2000,], fut.50.proj[!fut.50.proj$year == 2000,], fut.35.35.proj[!fut.35.35.proj$year == 2000,], fut.50.50.proj[!fut.50.50.proj$year == 2000,])



# ------------ For 26 cm tree and average prev years growth ----------------------
small.proj <- all.proj[all.proj$DBH == -0.413 & all.proj$RWI_1 == 0.103 & all.proj$RWI_2 == 0.103,]
small.proj$year <- ifelse(small.proj$year == 2050, "2050-2069",
                          ifelse(small.proj$year == 2070, "2070-2099", "2000"))
scenario_names <- c(
                    'constant' = "sensitivity constant",
                    'decrease_35' = "drought (taper 8%)",
                    'decrease_35.35' = "drought & temp. (taper 8%)",
                    'decrease_50.50' = "drought & temp. (no taper 15%)",
                    'decrease_50' = "drought (no taper 15%)"
                    )



# make one big plot for average previous years growth 
by.scenario <- ggplot(small.proj[!small.proj$year == 2000, ], aes(year, RWI, fill = as.character(year)))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000,]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+facet_grid(~ model + scenario)+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c("blue", "red"))+theme(legend.title = element_blank())


png(height = 4, width = 12, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/fut_growth_by_scenarios_26cm_avg_growth.png")
by.scenario+theme(legend.position = "none")
dev.off()


by.period <- ggplot(small.proj[!small.proj$year == 2000 , ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())

png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/fut_growth_by_time_scenarios_26cm_avg_growth.png")
by.period
dev.off()

by.model <- ggplot(small.proj[!small.proj$year == 2000, ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())+facet_grid(rows = vars(scenario), cols = vars(model))



png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/fut_growth_by_model_26cm_avg_growth.png")
by.model
dev.off()

small.proj$model <- factor(small.proj$model, levels = c("INMCM4", "HadGEM-ES2", "MIROC"))
model_names <- c(
                    'INMCM4' = "INMCM4 \n low Tmax - low Precip",
                    'HadGEM-ES2' = "HadGEM-ES2 \n high Tmax - low Precip",
                    'MIROC' = "MIROC \n high Tmax - high Precip"
                    
                    )


model_names <- c("INMCM4 \n low Tmax - low Precip",
                 "HadGEM-ES2 \n high Tmax - low Precip",
                 "MIROC \n high Tmax - high Precip")

by.model.2050 <- ggplot(small.proj[!small.proj$year == 2000 , ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 8%", "taper P & T 8%", "no taper P 15%", "no taper P & T 15%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())+facet_grid(~model)


png(height = 5, width = 9, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_full_pair_MAP5/fut_growth_by_model_2050_26cm_avg_growth.png")
by.model.2050
dev.off()

ggplot(small.proj[!small.proj$year == 2000 & !small.proj$year %in% "2070-2099", ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())+facet_grid(rows=vars(model), cols= vars(site))





```
 
  #FOR DRY YEARS ONLY: model with MAP as drought index stand structure by ageclass random effects and prev years growth (lag -1) and (lag - 2):
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"

population_model_structure_x_cohort_re_lag2_temp_MAP.f <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] # use Drought index as a scaled variable 

#r1[i] <- Y[i] - gfunc[i]   

}

#RSS[1] <- sum(r1^2)

# Prediction from known data
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4[struct.cohort.p[i]]*log_RWI_1.p[i] +beta5[struct.cohort.p[i]]*log_RWI_2.p[i] + beta6[struct.cohort.p[i]]*Temp.scaled.p[i]
  }

# probe for prediction plots:
  for(i in 1:nprobe){
    Yprobe[i]  ~ dnorm(muprobe[i],inv.var)
    muprobe[i] <- beta1[struct.cohort.probe[i]] + beta2[struct.cohort.probe[i]]*DI.scaled.probe[i] + beta3[struct.cohort.probe[i]]*DBH.scaled.probe[i] +beta4[struct.cohort.probe[i]]*log_RWI_1.probe[i] +beta5[struct.cohort.probe[i]]*log_RWI_2.probe[i] + beta6[struct.cohort.probe[i]]*Temp.scaled.probe[i]
  }

# project into the future:
  for(i in 1:nfut){
    Yfut[i]  ~ dnorm(mufut[i],inv.var)
    mufut[i] <- beta1[struct.cohort.fut[i]] + beta2[struct.cohort.fut[i]]*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]
  }

# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
beta5[s] ~ dnorm(mu_beta5, inv_beta5)
beta6[s] ~ dnorm(mu_beta5, inv_beta6)
}



# use normalpriors for each  beta paramters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)
mu_beta4 ~ dunif(-2, 2)
mu_beta5 ~ dunif(-2, 2)
mu_beta6 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)
inv_beta6   ~ dgamma(0.01, 0.01)
sigma_beta6 <- 1/sqrt(inv_beta6)

# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


}"

# save these for use later:
saveRDS(train.dry.pair, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/train.rds")
saveRDS(test.dry.pair, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/test.rds")
train.dry.pair <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/train.rds")
test.dry.pair <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/test.rds")



# generate probe dataset:
 DIprobe <- round(seq(range(train.dry$MAP.scaled)[1], range(train.dry$MAP.scaled)[2], by = 0.75), 3)
 DBHprobe <- round(seq(range(train.dry$DBH.scaled)[1], range(train.dry$DBH.scaled)[2], by = 0.75), 3)
 Tempprobe <- round(seq(range(train.dry$T.scaled)[1], range(train.dry$T.scaled)[2], by = 0.75), 3)
 RWI1probe <- round(seq(range(log(train.dry$RWI_1))[1], range(log(train.dry$RWI_1))[2], by = 0.5), 3)
 RWI2probe <- round(seq(range(log(train.dry$RWI_2))[1], range(log(train.dry$RWI_2))[2], by = 0.5), 3)
 
 # expand into full probe
probe <- expand.grid(DI.scaled = DIprobe, DBH.scaled = DBHprobe, T.scaled = Tempprobe,
                         RWI_1 = RWI1probe, RWI_2= RWI2probe, struct.cohort.code= 1:4)

# make a probe for future climate projections at our sites!

future.probe_70 <- data.frame(MAP.scaled = rcp85$PR_85_70.scaled, DBH.scaled= -0.413, 
                              T.scaled = rcp85$Tx_70.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103,  struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site)
future.probe_70$year <- 2070
future.probe_50 <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site)
future.probe_50$year <- 2050

fut <- rbind(future.probe_50, future.probe_70)




lag2.model.by_structure_x_cohort_t_pr <- jags.model(textConnection(population_model_structure_x_cohort_re_lag2_temp_MAP.f), 
                    data = list(Y=log(train.dry.pair$RWI), n=length(train.dry.pair$RWI), DI.scaled = train.dry.pair$DI.scaled, DBH.scaled = train.dry.pair$DBH.scaled,log_RWI_1 = log(train.dry.pair$RWI_1),log_RWI_2 = log(train.dry.pair$RWI_2), Temp.scaled = train.dry.pair$T.scaled, struct.cohort = as.numeric(train.dry.pair$struct.cohort.code), SF = unique(train.dry.pair$struct.cohort.code), np = length(test.dry.pair$DBH.scaled),
   struct.cohort.p = as.numeric(test.dry.pair$struct.cohort.code), DBH.scaled.p = test.dry.pair$DBH.scaled, DI.scaled.p = test.dry.pair$DI.scaled, log_RWI_1.p = log(test.dry.pair$RWI_1), log_RWI_2.p = log(test.dry.pair$RWI_2), Temp.scaled.p = test.dry.pair$T.scaled, nprobe = length(probe$DBH.scaled),
   struct.cohort.probe = as.numeric(probe$struct.cohort.code), DBH.scaled.probe = probe$DBH.scaled, DI.scaled.probe = probe$DI.scaled, log_RWI_1.probe = probe$RWI_1, log_RWI_2.probe = probe$RWI_2, Temp.scaled.probe = probe$T.scaled, 
   
   nfut = length(fut$DBH.scaled),
   struct.cohort.fut = as.numeric(fut$struct.cohort.code), DBH.scaled.fut = fut$DBH.scaled, DI.scaled.fut = fut$MAP.scaled, log_RWI_1.fut = fut$RWI_1, log_RWI_2.fut = fut$RWI_2, Temp.scaled.fut = fut$T.scaled), n.chains = 3, n.adapt = 100)

update(lag2.model.by_structure_x_cohort_t_pr, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","beta6","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3", "sigma_beta4","sigma_beta5", "sigma_beta6","Yp", "Yprobe", "Yfut"), 
                    n.chains = 3, n.iter=5000, thin = 15)


dic.full <- dic.samples(lag2.model.by_structure_x_cohort_t_pr, n.chains = 3, n.iter=10000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_DIC.rds")
#summary(samp.structure.cohort.re)
#plot(samp.structure.cohort.re)

#gelman.diag(samp.structure.cohort.re)
#acfplot(samp.structure.cohort.re)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/samps.rds")
  samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/samps.rds")
test.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/test.rds")
train.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/train.rds")

Yfut.samps <- samps[, 1:length(fut$RWI_1)]
samps <- samps[,(length(fut$RWI_1)+1):length(colnames(samps))]
 Yp.samps <- samps[,1:(length(test.dry.pair$RWI))] 
 Yprobe.samps <- samps[,(length(test.dry.pair$RWI)+1):(length(probe$DI.scaled))] 
 alpha.samps  <- samps[,(length(test.dry.pair$RWI)+ (length(probe$DI.scaled))+1):(length(test.dry.pair$RWI)+(length(probe$DI.scaled))+ 4)]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,(length(test.dry.pair$RWI)+ (length(probe$DI.scaled))+5):(length(test.dry.pair$RWI)+ (length(probe$DI.scaled))+8)]
 beta3.samps <- samps[,(length(test.dry.pair$RWI)+ (length(probe$DI.scaled))+9):(length(test.dry.pair$RWI)+ (length(probe$DI.scaled))+12)]
 beta4.samps <- samps[,(length(test.dry.pair$RWI)+ (length(probe$DI.scaled))+13):(length(test.dry.pair$RWI)+(length(probe$DI.scaled))+ 16)]
 beta5.samps <- samps[,(length(test.dry.pair$RWI)+(length(probe$DI.scaled))+ 17):(length(test.dry.pair$RWI)+(length(probe$DI.scaled))+ 20)]
 beta6.samps <- samps[,(length(test.dry.pair$RWI)+(length(probe$DI.scaled))+ 21):(length(test.dry.pair$RWI)+(length(probe$DI.scaled))+ 24)]
 sigma.samps <- samps[,(length(test.dry.pair$RWI)+ (length(probe$DI.scaled))+25)]
 sigma_betas <- samps[,(length(test.dry.pair$RWI)+(length(probe$DI.scaled))+ 26):(length(test.dry.pair$RWI)+(length(probe$DI.scaled))+ 31)]

 
 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test.dry.pair$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test.dry.pair$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)+theme_bw()

# note best model fit so far
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test.dry.pair$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test.dry.pair$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_dry_yrs", 
                            model.summary = "beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] ",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_dry_yrs", 
                           train = "cohort.omit.dry.yrs", 
                           DI.scaled = "JJApdsi")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)


# get difference between beta2.samps: (i.e are they different?)
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]

# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_beta3s.png")
par(mfrow=c(3,2))
hist(beta4.samps[,1], main = "beta4 Past-Forest")
hist(beta4.samps[,2], main = "beta4 Modern-Forest")
hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,4], main = "sigma beta4")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_beta4s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta5 Past-Forest")
hist(beta5.samps[,2], main = "beta5 Modern-Forest")
hist(beta5.samps[,3],  main = "beta5 Past-Savanna")
hist(beta5.samps[,4],  main = "beta5 Modern-Savanna")
hist(sigma_betas[,5], main = "sigma beta5")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_beta5s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta4 Past-Forest")
hist(beta5.samps[,2], main = "beta4 Modern-Forest")
hist(beta5.samps[,3],  main = "beta4 Past-Savanna")
hist(beta5.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,6], main = "sigma beta4")
dev.off()

# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <-c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
#colnames(b2) <- c(paste0(c(unique(train.dry$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope")

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH Index slope")


b4 <- data.frame(beta4.samps)
colnames(b4) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-1 Index slope")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-2 Index slope")

b6 <- data.frame(beta6.samps)
colnames(b6) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b6$num <- rownames(b6)
b6.m <- melt(b6, id.vars=c("num"))
b6.mplots <- ggplot(b6.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Summer Temperature slope")

png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/drougt_beta_marginal_distn_bycohort.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots, b5.mplots, b6.mplots)
dev.off()

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

# ------------------------- DOTPLOT MODEL SUMMARIES -----------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:

a1.sum <- a.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
a1.sum$variable <- factor(a1.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b2.sum <- b2.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b3.sum <- b3.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b4.sum <- b4.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.sum <- b5.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b6.sum <- b6.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

# write out all the dotplots
int.dot <- ggplot(data.frame(a1.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot <- ggplot(data.frame(b2.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot <- ggplot(data.frame(b3.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot <- ggplot(data.frame(b4.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot <- ggplot(data.frame(b5.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot <- ggplot(data.frame(b6.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/full_dot_plot_cohort_struct.png")
plot_grid(int.dot, b2.dot, b6.dot, b3.dot, b4.dot, b5.dot, ncol = 1)
dev.off()

# -------------------- DOTPLOTS by modern vs. past only ---------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:
a.m$cohort <- ifelse(a.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
a1.sum.age <- a.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#a1.sum.age$variable <- factor(a1.sum.age$coohort, levels = c( "Past", "Modern"))

b2.m$cohort <- ifelse(b2.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
b2.sum.age <- b2.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b3.m$cohort <- ifelse(b3.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b3.sum.age <- b3.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b4.m$cohort <- ifelse(b4.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b4.sum.age <- b4.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.m$cohort <- ifelse(b5.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b5.sum.age <- b5.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b6.m$cohort <- ifelse(b6.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b6.sum.age <- b6.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

# write out all the dotplots
int.dot.age <- ggplot(data.frame(a1.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot.age <- ggplot(data.frame(b2.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot.age <- ggplot(data.frame(b3.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot.age <- ggplot(data.frame(b4.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot.age <- ggplot(data.frame(b5.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot.age <- ggplot(data.frame(b6.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/full_dot_plot_cohort_only.png")
plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1)
dev.off()


png(height = 12, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/full_dot_plot_cohort_only.png")
plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1)
dev.off()


png(height = 12, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/full_dot_plot_cohort_and_cohortXstruct.png")
plot_grid(int.dot.age,int.dot,
         b2.dot.age , b2.dot, 
         b6.dot.age, b6.dot,
         b3.dot.age, b3.dot,
         b4.dot.age,  b4.dot,
         b5.dot.age, b5.dot, ncol = 2, align = "hv", labels = c("a","g",
                                                                "b","h",
                                                                "c","i",
                                                                "d","j",
                                                                "e","k",
                                                                "f","l"), label_x = 0.4)
dev.off()
#---------------------- More beta summary plots -----------------------------
png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots, b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.6))
dev.off()

# plot slightly differently:
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")

plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))

b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/param_marginal_distn_bycohort_struct_rb.png")
b2.dots.2
dev.off()

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

library(cowplot)
png(width = 5, height = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/param_marginal_distn_bycohort_struct_1.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, b5.mplots,ncol = 1)
dev.off()

# --------------------make plots of probed predicted growth responses:
# plot probed values of tree growth predictions:
Yprobe <- data.frame(Yprobe.samps)
colnames(Yprobe) <- 1:length(Yprobe)
probe.m <- melt(Yprobe)
probe.m$RWI <- exp(probe.m$value) 
colnames(probe.m) <- c("num", "Ypred", "RWI")

probe$num <- 1:length(probe[,1])
colnames(probe) <- c("Drought", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "num")

# summarize by structure + cohort class only:
# summarize by structure + cohort class only:
probe$num <- as.factor(as.character(probe$num))
full.p <- probe

probtest.dry <- dplyr::inner_join(probe.m, full.p, by=c("num"))

prob <- probtest.dry
# save here:
saveRDS(prob, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/full_yprobe_preds.rds")
prob <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/full_yprobe_preds.rds")




# convert prob$Drought back to MAP:
library(DMwR)
DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)



prob$DBH <- as.numeric(round(unscale(vals = prob$DBH, norm.data = DBH.scaled))) 
prob$MAP <- as.numeric(round(unscale(vals = prob$Drought, norm.data = MAP.scaled)))
prob$Tmax <- as.numeric(round(unscale(vals = prob$Tmax, norm.data = T.scaled))) 


prob_10_60cm_avg <- prob %>% dplyr::filter(DBH == 3 | DBH == 27 | DBH == 63 , Tmax == 72 | Tmax == 89, RWI_1 == 0.285, RWI_2 == 0.103 ) 

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
 prob_10_60cm_avg <- merge(prob_10_60cm_avg,struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10 <- prob_10_60cm_avg %>% group_by(DBH, Drought, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

preds_ci_10_age <- prob_10_60cm_avg %>% group_by(DBH, Drought, Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with LOWER than average tree growth the years before:

prob_10_60cm_low <- prob %>% dplyr::filter(DBH == 3 | DBH == 27 | DBH == 63 , Tmax == 72 | Tmax == 89, RWI_1 == -1.215, RWI_2 == -1.397  ) 

 
 prob_10_60cm_low <- merge(prob_10_60cm_low, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10_low <- prob_10_60cm_low %>% group_by(DBH, Drought, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))


preds_ci_10_low_age <- prob_10_60cm_low %>% group_by(DBH, Drought, Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with HIGHER than average tree growth the years before:

prob_10_60cm_high <- prob %>% dplyr::filter(DBH == 3 | DBH == 27 | DBH == 63 , Tmax == 72 | Tmax == 89, RWI_1 == 1.785, RWI_2 == 1.603  ) 


 prob_10_60cm_high <- merge(prob_10_60cm_high, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10_high <- prob_10_60cm_high %>% group_by(DBH, Drought, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

preds_ci_10_high_age <- prob_10_60cm_high %>% group_by(DBH, Drought, Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

#----------- plot drought response by max temperature and Dimaeter + cohort-struct class -----------

Drought.resp.DBH.temp.avgpyr <- ggplot(preds_ci_10, aes(Drought, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Precipitation index")+theme_bw()



Drought.resp.DBH.temp.lowpyr <- ggplot(preds_ci_10_low, aes(Drought, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+xlab("Precipitation index")+theme_bw()


Drought.resp.DBH.temp.highpyr <- ggplot(preds_ci_10_high, aes(Drought, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+xlab("Precipitation index")+theme_bw()


# output the above plots to PNG:
png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/MAP_response_low_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.lowpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/MAP_response_avg_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.avgpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/MAP_response_high_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.highpyr 
dev.off()


#----------- plot drought response by max temperature and Dimaeter + AGECLASS -----------

Drought.resp.DBH.temp.avgpyr.age <- ggplot(preds_ci_10_age, aes(Drought, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Precipitation index")+theme_bw()




Drought.resp.DBH.temp.lowpyr.age <- ggplot(preds_ci_10_low_age, aes(Drought, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_10_low_age,aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Precipitation index")+theme_bw()


Drought.resp.DBH.temp.highpyr.age <- ggplot(preds_ci_10_high_age, aes(Drought, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Precipitation index")+theme_bw()


# output the above plots to PNG:
png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/MAP_response_low_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.lowpyr.age 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/MAP_response_avg_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.avgpyr.age+theme_bw(base_size = 14)
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/MAP_response_high_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.highpyr.age 
dev.off()





#--------------- plot marginal effects of climate and previous years growth ----------------

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

 prob <- left_join(prob, struc.conversion, by  = "struct.cohort")

 # Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, ageclass) %>% summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()


legend <- get_legend(Y_MAP_marg)

png(height = 10, width = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_post_predictive_effects_ageclass.png")
plts <- plot_grid(Y_MAP_marg+theme(legend.position = "none"), Y_Tmax_marg+theme(legend.position = "none"), Y_DBH_marg+theme(legend.position = "none"), Y_RWI_1_marg+theme(legend.position = "none"), Y_RWI_2_marg+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()

# --------------plot marginal effects for each stand structure and cohort class:
# plot marginal effects of climate and previous years growth 
# Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg_c <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_MAP, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Total Precipitation")


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg_c <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Max. Temperature (DegF)")

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg_c <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Tree DBH (cm)")

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg_c <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-1) year's growth)")

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg_c <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-2) year's growth)")

png(height = 10, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_post_predictive_effects_ageclassXStruct.png")
legend <- get_legend(Y_MAP_marg_c)
plts <- plot_grid(Y_MAP_marg_c+theme(legend.position = "none"), Y_Tmax_marg_c+theme(legend.position = "none"), Y_DBH_marg_c+theme(legend.position = "none"), Y_RWI_1_marg_c+theme(legend.position = "none"), Y_RWI_2_marg_c+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.45))
dev.off()



# below is some extra code

# -------plot point estimates of growth based on low moisutre under hot and cold conditions by DBH, colored by cohort x stand, and with facets by previous years growth:

prob_lowMAP <- prob %>% dplyr::filter(MAP == 223 , Tmax == 71 | Tmax == 89 , RWI_1 == -1.215 | RWI_1 == 0.285 | RWI_1 == 1.785 , RWI_2 == -1.397 | RWI_2 == 0.103 | RWI_2 == 1.603 ) 

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
prob_lowMAP <- merge(prob_lowMAP,struc.conversion, by  = "struct.cohort")
 
 
prob_lowMAP_ci <- prob_lowMAP %>% group_by(DBH,  Tmax, RWI_1, RWI_2, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

ggplot(prob_lowMAP_ci[prob_lowMAP_ci$Tmax == 89,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)

#ggplot(prob_lowMAP_ci[prob_lowMAP_ci$Tmax == 88,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)

# same but for high MAP
prob_highMAP <- prob %>% dplyr::filter(MAP == 970 , Tmax == 71 | Tmax == 88 , RWI_1 == -1.215 | RWI_1 == 0.285 | RWI_1 == 1.785 , RWI_2 == -1.397 | RWI_2 == 0.103 | RWI_2 == 1.603) 

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
prob_highMAP <- merge(prob_highMAP,struc.conversion, by  = "struct.cohort")
 
 
prob_highMAP_ci <- prob_highMAP %>% group_by(DBH,  Tmax, RWI_1, RWI_2, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

ggplot(prob_highMAP_ci[prob_highMAP_ci$Tmax == 71,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)+theme_bw()

ggplot(prob_highMAP_ci[prob_highMAP_ci$Tmax == 88,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)+theme_bw()





# ----------------------- Plot future predictions ------------------------

Yfut.samps <- data.frame(Yfut.samps)



colnames(Yfut.samps) <- paste0(fut$site, "_",fut$year)
Yfut.samps$num <- 1:length(Yfut.samps$AVO_2015)
fut.m <- melt(Yfut.samps)
fut.m$RWI <- exp(fut.m$value)
colnames(fut.m) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year)
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort",  "year","site.num", "site_year")

# summarize by structure + cohort class only:

fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))

fut.summary <- fut.proj %>% group_by(site_year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

fut.sum<- merge(fut.summary, fut, by = "site_year")

 #ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()
 ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
 ggplot(fut.sum, aes(Tmax, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
  ggplot(fut.sum, aes(site, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =site, ymin = Ci.low, ymax = Ci.high, color = year))+facet_wrap(~year)+ylim(0,5)
 

```
  
  
  
  
  
  
  
  
# FOR DRY YEARS ONLY, but all sites: multi-level model with MAP as drought index stand structure by ageclass random effects and prev years growth (lag -1) and (lag - 2), and a site level random intercept parameter: 

```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"

population_model_site_int_structure_x_cohort_re_lag2_temp_MAP.f <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] # use Drought index as a scaled variable 
   

}



# Prediction from known data
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[site.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4[struct.cohort.p[i]]*log_RWI_1.p[i] +beta5[struct.cohort.p[i]]*log_RWI_2.p[i] + beta6[struct.cohort.p[i]]*Temp.scaled.p[i]
  }

# probe for prediction plots:
  for(i in 1:nprobe){
    Yprobe[i]  ~ dnorm(muprobe[i],inv.var)
    muprobe[i] <- beta1[site.probe[i]] + beta2[struct.cohort.probe[i]]*DI.scaled.probe[i] + beta3[struct.cohort.probe[i]]*DBH.scaled.probe[i] +beta4[struct.cohort.probe[i]]*log_RWI_1.probe[i] +beta5[struct.cohort.probe[i]]*log_RWI_2.probe[i] + beta6[struct.cohort.probe[i]]*Temp.scaled.probe[i]
  }

# project into the future (assuming no further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut[i]  ~ dnorm(mufut[i],inv.var)
    mufut[i] <- beta1[site.fut[i]] + beta2[struct.cohort.fut[i]]*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]
  }

# project into the future (assuming 35% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.35[i]  ~ dnorm(mufut2[i],inv.var)
    mufut2[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.92)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]
  }



# project into the future (assuming 50% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.50[i]  ~ dnorm(mufut3[i],inv.var)
    mufut3[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.85)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]
  }


# project into the future (assuming 8% further change in drought senseiivty & temperature):
  for(i in 1:nfut){
   Yfut.35.35[i]  ~ dnorm(mufut35[i],inv.var)
    mufut35[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.92)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + (beta6[struct.cohort.fut[i]]*1.08)*Temp.scaled.fut[i]
  }



# project into the future (assuming 7% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.50.50[i]  ~ dnorm(mufut50[i],inv.var)
    mufut50[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.85)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + (beta6[struct.cohort.fut[i]]*1.15)*Temp.scaled.fut[i]
  }

# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){

beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
beta5[s] ~ dnorm(mu_beta5, inv_beta5)
beta6[s] ~ dnorm(mu_beta5, inv_beta6)
}


for(k in 1:Nsites){
beta1[k] ~ dnorm(mu_beta1, inv_beta1)
}


# use normalpriors for each  beta paramters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)
mu_beta4 ~ dunif(-2, 2)
mu_beta5 ~ dunif(-2, 2)
mu_beta6 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)
inv_beta6   ~ dgamma(0.01, 0.01)
sigma_beta6 <- 1/sqrt(inv_beta6)

# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)

}"

# save these for use later:


saveRDS(train.dry, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/train.rds")
saveRDS(test.dry, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/test.rds")
train.dry <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/train.rds")
test.dry <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/test.rds")
# assign site numbers to each site:
site.num.df <- data.frame(site = as.character(unique(train.dry$site)), 
           site.num = 1:length(as.character(unique(train.dry$site))))

if(! "site.num" %in% colnames(train.dry)){
train.dry <- merge(train.dry, site.num.df, by = "site" )
test.dry <- merge(test.dry, site.num.df, by = "site" )
}

# generate probe dataset:
 DIprobe <- round(seq(range(train.dry$MAP.scaled)[1], range(train.dry$MAP.scaled)[2], by = 0.75), 3)
 DBHprobe <- round(seq(range(train.dry$DBH.scaled)[1], range(train.dry$DBH.scaled)[2], by = 0.75), 3)
 Tempprobe <- round(seq(range(train.dry$T.scaled)[1], range(train.dry$T.scaled)[2], by = 0.75), 3)
 RWI1probe <- round(seq(range(log(train.dry$RWI_1))[1], range(log(train.dry$RWI_1))[2], by = 0.5), 3)
 RWI2probe <- round(seq(range(log(train.dry$RWI_2))[1], range(log(train.dry$RWI_2))[2], by = 0.5), 3)
 
 # expand into full probe
probe <- expand.grid(DI.scaled = DIprobe, DBH.scaled = DBHprobe, T.scaled = Tempprobe,
                         RWI_1 = RWI1probe, RWI_2= RWI2probe, struct.cohort.code= 1:4, site.num = unique(train.dry$site.num))

sit.cohorts <- unique(train.dry[,c("struct.cohort.code", "site.num")])
probe <- merge(probe, sit.cohorts, by = c("struct.cohort.code", "site.num")) # make sure that each site only has savanna or forest in the probe

# make probe smaller to help with saving:
short.probe <- probe[probe$RWI_1 %in% c("-1.609", "0.391", "1.891") & probe$RWI_2 %in% c("-1.484", "0.016", "2.016") & probe$DBH.scaled %in% c("-0.413", "0.337", "1.087"),]

#short.probe <- probe

# make a probe for future climate projections at our sites!
rcp85 <- rcp85[!rcp85$site %in% c("COR", "GLL4", "HIC", "PLE", "PVC", "STC", "TOW"),]
future.probe_70 <- data.frame(MAP.scaled = rcp85$PR_85_70.scaled, DBH.scaled= -0.413, 
                              T.scaled = rcp85$Tx_70.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103,  struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_70$year <- 2070
future.probe_50 <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site,  model = rcp85$model)
future.probe_50$year <- 2050


# get climate averages from 1950 - present at each site:
train.dry$struct.cohort.code2 <- as.numeric(train.dry$struct.cohort.code)
train.clim.summary <-
  train.dry[train.dry$ageclass %in% "Modern", ] %>% group_by(site) %>% dplyr::summarise(
    MAP.scaled = mean(MAP.scaled),
    DBH.scaled = -0.413,
    T.scaled = mean(T.scaled),
    RWI_1 = 0.103,
    RWI_2 = 0.103,
    struct.cohort.code = mean(struct.cohort.code2),
    model = "none",
    year = 2000
    )



Average.prob <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_50$year <- 2050


fut <- rbind(future.probe_50, future.probe_70, train.clim.summary[,c("MAP.scaled", "DBH.scaled",  "T.scaled", "RWI_1", "RWI_2", "struct.cohort.code", "site","year","model")])


fut <- merge(fut, site.num.df, by = "site")

# look at the effects under two different DBH values
short.fut <- fut
fut.small <- fut
fut.large <- fut
fut.small$DBH.scaled <- -0.413
fut.large$DBH.scaled <- 1.900
long.fut <- rbind(fut.small, fut.large)


# look at the effects under average, below average, and above average different prev year growth values
lfut.low <- long.fut
lfut.avg <- long.fut
lfut.high <- long.fut

lfut.low$RWI_1 <- -1.609
lfut.low$RWI_2 <- -1.47

lfut.high$RWI_1 <- 1.891
lfut.high$RWI_2 <- 2.03

long.fut <- rbind(lfut.high, lfut.avg, lfut.low)

lag2.model.by_structure_x_cohort_t_pr <- jags.model(textConnection(population_model_site_int_structure_x_cohort_re_lag2_temp_MAP.f), 
                    data = list(Y=log(train.dry$RWI), n=length(train.dry$RWI), DI.scaled = train.dry$MAP.scaled, DBH.scaled = train.dry$DBH.scaled,log_RWI_1 = log(train.dry$RWI_1),log_RWI_2 = log(train.dry$RWI_2), Temp.scaled = train.dry$T.scaled, struct.cohort = as.numeric(train.dry$struct.cohort.code), SF = as.numeric(unique(train.dry$struct.cohort.code)), site = train.dry$site.num, Nsites = length(unique(train.dry$site)),
  struct.cohort.p = as.numeric(test.dry$struct.cohort.code), DBH.scaled.p = test.dry$DBH.scaled, DI.scaled.p = test.dry$MAP.scaled, log_RWI_1.p = log(test.dry$RWI_1), log_RWI_2.p = log(test.dry$RWI_2), Temp.scaled.p = test.dry$T.scaled, site.p = test.dry$site.num, np = length(as.numeric(test.dry$struct.cohort.code)), 
  
  struct.cohort.probe = as.numeric(short.probe$struct.cohort.code), DBH.scaled.probe = short.probe$DBH.scaled, DI.scaled.probe = short.probe$DI.scaled, log_RWI_1.probe = short.probe$RWI_1, log_RWI_2.probe =short.probe$RWI_2, Temp.scaled.probe = short.probe$T.scaled, site.probe = short.probe$site.num, nprobe = length(as.numeric(short.probe$struct.cohort.code)), 
 
  struct.cohort.fut = as.numeric(long.fut$struct.cohort.code), DBH.scaled.fut = long.fut$DBH.scaled, DI.scaled.fut = long.fut$MAP.scaled, log_RWI_1.fut = long.fut$RWI_1, log_RWI_2.fut =long.fut$RWI_2, Temp.scaled.fut = long.fut$T.scaled, site.fut = long.fut$site.num, nfut = length(as.numeric(long.fut$struct.cohort.code))
 
  
  ),
  n.chains = 3, n.adapt = 100)

update(lag2.model.by_structure_x_cohort_t_pr, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","beta6","sigma", "mu_beta1", "mu_beta2","mu_beta3", "mu_beta4","mu_beta5", "mu_beta6","Yp"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.probe <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yprobe"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut"), 
                    n.chains = 3, n.iter=10000, thin = 15)
Y.fut.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.35"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.50"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.35.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.35.35"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.50.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("Yfut.50.50"), 
                    n.chains = 3, n.iter=10000,thin = 15)

dic.full <- dic.samples(lag2.model.by_structure_x_cohort_t_pr, n.chains = 3, n.iter=10000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_DIC.rds")

summary(samp.structure.cohort.re)
#plot(samp.structure.cohort.re)

#gelman.diag(samp.structure.cohort.re, multivariate = FALSE)
#acfplot(samp.structure.cohort.re)

autocorr.plot(samp.structure.cohort.re [[1]][ , 'beta2[1]'], auto.layout = FALSE, lwd = 4, col = "red", lag.max = 100)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/samps.rds")
 samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/samps.rds")
 test.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/test.rds")
 train.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/train.rds")
#Yfut.samps <- samps[, 1:length(fut$RWI_1)]
#samps <- samps[,(length(fut$RWI_1)+1):length(colnames(samps))]
 Yp.samps <- samps[,1:(length(test.dry$RWI))] 
 Yprobe.samps <- Y.probe
 alpha.samps  <- samps[,(length(test.dry$RWI)+1):(length(test.dry$RWI)+ 9)]# one alpha for each of 9 sites 
 beta2.samps <- samps[,(length(test.dry$RWI)+10):(length(test.dry$RWI)+13)]
 beta3.samps <- samps[,(length(test.dry$RWI)+14):(length(test.dry$RWI)+17)]
 beta4.samps <- samps[,(length(test.dry$RWI)+18):(length(test.dry$RWI)+ 21)]
 beta5.samps <- samps[,(length(test.dry$RWI)+ 22):(length(test.dry$RWI)+ 25)]
 beta6.samps <- samps[,(length(test.dry$RWI)+ 26):(length(test.dry$RWI)+ 29)]
 sigma.samps <- samps[,(length(test.dry$RWI)+ 36)]
 sigma_betas <- samps[,(length(test.dry$RWI)+ 30):(length(test.dry$RWI)+ 35)]

 
 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test.dry$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test.dry$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)+theme_bw(base_size = 15)

# note best model fit so far
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test.dry$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test.dry$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs", 
                            model.summary = "beta1[site[i]] + beta2[struct.cohort[i]]*MAP.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs", 
                           train = "cohort.omit.dry.years", 
                           DI.scaled = "MAP")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)


# get difference between beta2.samps: (i.e are they different?)
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]




# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/marginal_beta3s.png")
par(mfrow=c(3,2))
hist(beta4.samps[,1], main = "beta4 Past-Forest")
hist(beta4.samps[,2], main = "beta4 Modern-Forest")
hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,4], main = "sigma beta4")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/marginal_beta4s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta5 Past-Forest")
hist(beta5.samps[,2], main = "beta5 Modern-Forest")
hist(beta5.samps[,3],  main = "beta5 Past-Savanna")
hist(beta5.samps[,4],  main = "beta5 Modern-Savanna")
hist(sigma_betas[,5], main = "sigma beta5")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/marginal_beta5s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta4 Past-Forest")
hist(beta5.samps[,2], main = "beta4 Modern-Forest")
hist(beta5.samps[,3],  main = "beta4 Past-Savanna")
hist(beta5.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,6], main = "sigma beta4")
dev.off()

# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- unique(train.dry$site)#[order(unique(train.dry[,c("site", "site.num")])[,2])])
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <-c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
#colnames(b2) <- c(paste0(c(unique(train.dry$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope")

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH Index slope")


b4 <- data.frame(beta4.samps)
colnames(b4) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-1 Index slope")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-2 Index slope")

b6 <- data.frame(beta6.samps)
colnames(b6) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b6$num <- rownames(b6)
b6.m <- melt(b6, id.vars=c("num"))
b6.mplots <- ggplot(b6.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Summer Temperature slope")

png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/drougt_beta_marginal_distn_bycohort.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots, b5.mplots, b6.mplots)
dev.off()

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

# ------------------------- DOTPLOT MODEL SUMMARIES -----------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:

a1.sum <- a.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
a1.sum$variable <- unique(train.dry$site)

df.site.struct <- unique(train.dry[,c("site", "structure")])
a1.sum <- merge(a1.sum, df.site.struct, by.x = "variable", by.y = "site")
a1.sum$structure <- factor(a1.sum$structure, levels = c( "Forest", "Savanna"))

b2.sum <- b2.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975), 
                                                   hdi.low = hdi(value)[1], 
                                                   hdi.high =hdi(value)[2] )
b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b3.sum <- b3.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b4.sum <- b4.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.sum <- b5.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b6.sum <- b6.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

# write out all the dotplots
int.dot <- ggplot(data.frame(a1.sum), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Savanna"='sienna4',
"Forest"='forestgreen'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot <- ggplot(data.frame(b2.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.1, 0.2)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot <- ggplot(data.frame(b3.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot <- ggplot(data.frame(b4.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot <- ggplot(data.frame(b5.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot <- ggplot(data.frame(b6.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/full_dot_plot_cohort_struct.png")
plot_grid(int.dot, b2.dot, b6.dot, b3.dot, b4.dot, b5.dot, ncol = 1, align = "v")
dev.off()

# -------------------- DOTPLOTS by modern vs. past only ---------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:
# a does not vary by cohort 
a1.sum.age <- a1.sum

b2.m$cohort <- ifelse(b2.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
b2.sum.age <- b2.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b3.m$cohort <- ifelse(b3.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b3.sum.age <- b3.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b4.m$cohort <- ifelse(b4.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b4.sum.age <- b4.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.m$cohort <- ifelse(b5.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b5.sum.age <- b5.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b6.m$cohort <- ifelse(b6.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b6.sum.age <- b6.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

# write out all the dotplots
int.dot.age <- ggplot(data.frame(a1.sum.age), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot.age <- ggplot(data.frame(b2.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot.age <- ggplot(data.frame(b3.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot.age <- ggplot(data.frame(b4.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot.age <- ggplot(data.frame(b5.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot.age <- ggplot(data.frame(b6.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/full_dot_plot_cohort_only.png")
plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1, align = "v")
dev.off()


png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/full_dot_plot_cohort_only.png")
plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1)
dev.off()


png(height = 12, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/full_dot_plot_cohort_and_cohortXstruct.png")
plot_grid(int.dot.age,int.dot,
         b2.dot.age , b2.dot, 
         b6.dot.age, b6.dot,
         b3.dot.age, b3.dot,
         b4.dot.age,  b4.dot,
         b5.dot.age, b5.dot, ncol = 2, align = "hv", labels = c("a","g",
                                                                "b","h",
                                                                "c","i",
                                                                "d","j",
                                                                "e","k",
                                                                "f","l"), label_x = 0.4)
dev.off()

# ------------------ Do the site level intercepts correlate with site quality -----------
# read in information about site quality:
locs <- read.csv("outputs/priority_sites_locs_with_soil_clim.csv")
locs <- data.frame(locs)
locs$code <- as.character(locs$code)
locs[6:9,]$code <- c( "GLL1", "GLL2", "GLL3", "GLL4")
sites <- c("COR", "HIC", "STC", "GLA", "TOW", "ENG", "UNC", "BON", "MOU", "GLL4", "GLL3", "GLL2", "GLL1", "PVC", "AVO", "PLE", "UNI")

# merge with a1.sum.age
site.summary <- merge(a1.sum.age, locs, by.x = "variable", by.y = "code")

# plot mean + 95% confidence interval vs. MAP
alpha.pr30yr <-ggplot(site.summary, aes(x = pr30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("Total Precip")
# get an idea if there might be relationship
summary(lm(mean.val ~ pr30yr,data = site.summary))

# plot mean + 95% confidence interval vs. Tmean
alpha.tm30yr <- ggplot(site.summary, aes(x = tm30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("Mean Temp")
# get an idea if there might be relationship
summary(lm(mean.val ~ tm30yr,data = site.summary))

# plot mean + 95% confidence interval vs. sand %
alpha.sand <- ggplot(site.summary, aes(x = sand, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("sand")#+stat_smooth(method = "lm")
# get an idea if there might be relationship
summary(lm(mean.val ~ sand,data = site.summary))

# plot mean + 95% confidence interval vs. ksat
alpha.ksat <-ggplot(site.summary, aes(x = ksat, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("ksat")
# get an idea if there might be relationship
summary(lm(mean.val ~ ksat,data = site.summary))

# plot mean + 95% confidence interval vs. awc

alpha.awc <- ggplot(site.summary, aes(x = awc, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("AWC")
# get an idea if there might be relationship
summary(lm(mean.val ~ awc, data = site.summary))

# plot mean + 95% confidence interval vs. n. species 

alpha.nspecies <- ggplot(site.summary, aes(x = nspecies, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept ")+xlab("nspecies")#+stat_smooth(data = site.summary, aes(x = nspecies, y = mean.val), method = "lm")
summary(lm(mean.val ~ nspecies, data = site.summary))


 

alpha.DBH <- ggplot(site.summary, aes(x = DBH, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept")+xlab("Average Site DBH")

summary(lm(mean.val ~ DBH, data = site.summary))


# there seems to be no relationship between alpha and site characteristics
# but plot the relationships out here:
png(height = 8, width = 6, units = "in",res = 200, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/alpha_site_ints_vs_site_quality.png")
plot_grid(alpha.pr30yr, alpha.tm30yr, alpha.awc, alpha.sand, alpha.nspecies, alpha.DBH, ncol = 2, align = "v", labels = "AUTO", label_x = 0.1)
dev.off()

#---------------------- More beta summary plots -----------------------------
png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots, b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.6))
dev.off()

# plot slightly differently:
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")

plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))

b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/param_marginal_distn_bycohort_struct_rb.png")
b2.dots.2
dev.off()

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

library(cowplot)
png(width = 5, height = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/param_marginal_distn_bycohort_struct_1.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, b5.mplots,ncol = 1)
dev.off()

# --------------------make plots of probed predicted growth responses:
# plot probed values of tree growth predictions:
Yprobe <- data.frame(Yprobe.samps[[1]])
colnames(Yprobe) <- 1:length(Yprobe)
probe.m <- melt(Yprobe)
probe.m$RWI <- exp(probe.m$value) 
colnames(probe.m) <- c("num", "Ypred", "RWI")

probe <- short.probe
probe$num <- 1:length(probe[,1])
colnames(probe) <- c("struct.cohort","site","Drought", "DBH","Tmax", "RWI_1","RWI_2", "num")

# summarize by structure + cohort class only:
# summarize by structure + cohort class only:
probe$num <- as.factor(as.character(probe$num))
full.p <- probe

probtest.dry.pair <- dplyr::inner_join(probe.m, full.p, by=c("num"))

prob <- probtest.dry.pair
# save here:
saveRDS(prob, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/full_yprobe_preds.rds")
prob <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/full_yprobe_preds.rds")




# convert prob$Drought back to MAP:
library(DMwR)
DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)



prob$DBH <- as.numeric(round(unscale(vals = prob$DBH, norm.data = DBH.scaled))) 
prob$MAP <- as.numeric(round(unscale(vals = prob$Drought, norm.data = MAP.scaled)))
prob$Tmax <- as.numeric(round(unscale(vals = prob$Tmax, norm.data = T.scaled))) 


prob_10_60cm_avg <- prob %>% dplyr::filter(DBH == 4 | DBH == 27 | DBH == 63 , Tmax == 71 | Tmax == 88, RWI_1 == 0.391, RWI_2 == 0.03 ) 

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
 prob_10_60cm_avg <- merge(prob_10_60cm_avg,struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10 <- prob_10_60cm_avg %>% group_by(DBH, Drought, MAP,Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

preds_ci_10_age <- prob_10_60cm_avg %>% group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with LOWER than average tree growth the years before:

prob_10_60cm_low <- prob %>% dplyr::filter(DBH == 4 | DBH == 27 | DBH == 63 , Tmax == 71 | Tmax == 88, RWI_1 == -1.609, RWI_2 == -1.47 ) 

 
 prob_10_60cm_low <- merge(prob_10_60cm_low, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10_low <- prob_10_60cm_low %>% group_by(DBH, Drought,MAP, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))


preds_ci_10_low_age <- prob_10_60cm_low %>% group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with HIGHER than average tree growth the years before:

prob_10_60cm_high <- prob %>% dplyr::filter(DBH == 4 | DBH == 27 | DBH == 63 , Tmax == 71 | Tmax == 88, RWI_1 == 1.891, RWI_2 == 2.03  ) 


 prob_10_60cm_high <- merge(prob_10_60cm_high, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10_high <- prob_10_60cm_high %>% group_by(DBH, Drought,MAP, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

preds_ci_10_high_age <- prob_10_60cm_high %>% group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

#----------- plot drought response by max temperature and Dimaeter + cohort-struct class -----------

Drought.resp.DBH.temp.avgpyr <- ggplot(preds_ci_10, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()



Drought.resp.DBH.temp.lowpyr <- ggplot(preds_ci_10_low, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


Drought.resp.DBH.temp.highpyr <- ggplot(preds_ci_10_high, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


# output the above plots to PNG:
png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/MAP_response_low_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.lowpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/MAP_response_avg_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.avgpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/MAP_response_high_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.highpyr 
dev.off()


#----------- plot drought response by max temperature and Dimaeter + AGECLASS -----------

Drought.resp.DBH.temp.avgpyr.age <- ggplot(preds_ci_10_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()




Drought.resp.DBH.temp.lowpyr.age <- ggplot(preds_ci_10_low_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_10_low_age,aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


Drought.resp.DBH.temp.highpyr.age <- ggplot(preds_ci_10_high_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


# output the above plots to PNG:
png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/MAP_response_low_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.lowpyr.age 
dev.off()

png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/MAP_response_avg_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.avgpyr.age+theme_bw(base_size = 14)
dev.off()

png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/MAP_response_high_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.highpyr.age 
dev.off()





#--------------- plot marginal effects of climate and previous years growth ----------------

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

 prob <- left_join(prob, struc.conversion, by  = "struct.cohort")

 # Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, ageclass) %>% summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()


legend <- get_legend(Y_MAP_marg)

png(height = 10, width = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/marginal_post_predictive_effects_ageclass.png")
plts <- plot_grid(Y_MAP_marg+theme(legend.position = "none"), Y_Tmax_marg+theme(legend.position = "none"), Y_DBH_marg+theme(legend.position = "none"), Y_RWI_1_marg+theme(legend.position = "none"), Y_RWI_2_marg+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()

# --------------plot marginal effects for each stand structure and cohort class:
# plot marginal effects of climate and previous years growth 
# Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg_c <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_MAP, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Total Precipitation")


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg_c <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Max. Temperature (DegF)")

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg_c <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Tree DBH (cm)")

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg_c <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-1) year's growth)")

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg_c <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-2) year's growth)")

png(height = 10, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/marginal_post_predictive_effects_ageclassXStruct.png")
legend <- get_legend(Y_MAP_marg_c)
plts <- plot_grid(Y_MAP_marg_c+theme(legend.position = "none"), Y_Tmax_marg_c+theme(legend.position = "none"), Y_DBH_marg_c+theme(legend.position = "none"), Y_RWI_1_marg_c+theme(legend.position = "none"), Y_RWI_2_marg_c+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.45))
dev.off()


# ------------- plot the marginal effects of each model parameter by site: ---------------

preds_ci_mod_past_MAP_site <- prob %>% group_by( MAP, ageclass, site) %>% summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg_site <- ggplot(preds_ci_mod_past_MAP_site, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP_site,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)

# marginal TMAX effect
preds_ci_mod_past_Tmax_site <- prob %>% group_by( Tmax,ageclass, site) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg_site <- ggplot(preds_ci_mod_past_Tmax_site, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax_site, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()+facet_wrap(~site)

# marginal DBH effect
preds_ci_mod_past_DBH_site <- prob %>% group_by( DBH,ageclass, site) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg_site <- ggplot(preds_ci_mod_past_DBH_site, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH_site, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()+facet_wrap(~site)

# marginal lag-1 effect
preds_ci_mod_past_RWI1_site <- prob %>% group_by( RWI_1,ageclass, site) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg_site <- ggplot(preds_ci_mod_past_RWI1_site, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1_site, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)

# marginal lag-2 effect
preds_ci_mod_past_RWI2_site <- prob %>% group_by( RWI_2, ageclass, site) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg_site <- ggplot(preds_ci_mod_past_RWI2_site, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2_site, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)


legend <- get_legend(Y_MAP_marg_site)

png(height = 25, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/marginal_post_predictive_effects_ageclass_by_site.png")
plts <- plot_grid(Y_MAP_marg_site+theme(legend.position = "none"), Y_Tmax_marg_site+theme(legend.position = "none"), Y_DBH_marg_site+theme(legend.position = "none"), Y_RWI_1_marg_site+theme(legend.position = "none"), Y_RWI_2_marg_site+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()


# below is some extra code

# -------plot point estimates of growth based on low moisutre under hot and cold conditions by DBH, colored by cohort x stand, and with facets by previous years growth:

prob_lowMAP <- prob %>% dplyr::filter(MAP == 223 , Tmax == 71 | Tmax == 89 , RWI_1 == -1.215 | RWI_1 == 0.285 | RWI_1 == 1.785 , RWI_2 == -1.397 | RWI_2 == 0.103 | RWI_2 == 1.603 ) 

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
prob_lowMAP <- merge(prob_lowMAP,struc.conversion, by  = "struct.cohort")
 
 
prob_lowMAP_ci <- prob_lowMAP %>% group_by(DBH,  Tmax, RWI_1, RWI_2, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

ggplot(prob_lowMAP_ci[prob_lowMAP_ci$Tmax == 89,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)

#ggplot(prob_lowMAP_ci[prob_lowMAP_ci$Tmax == 88,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)

# same but for high MAP
prob_highMAP <- prob %>% dplyr::filter(MAP == 970 , Tmax == 71 | Tmax == 88 , RWI_1 == -1.215 | RWI_1 == 0.285 | RWI_1 == 1.785 , RWI_2 == -1.397 | RWI_2 == 0.103 | RWI_2 == 1.603) 

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
prob_highMAP <- merge(prob_highMAP,struc.conversion, by  = "struct.cohort")
 
 
prob_highMAP_ci <- prob_highMAP %>% group_by(DBH,  Tmax, RWI_1, RWI_2, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

ggplot(prob_highMAP_ci[prob_highMAP_ci$Tmax == 71,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)+theme_bw()

ggplot(prob_highMAP_ci[prob_highMAP_ci$Tmax == 88,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)+theme_bw()

#ggplot(prob_highMAP_ci[prob_highMAP_ci$RWI_2 == -1.397 & prob_highMAP_ci$RWI_1 == -1.466,], aes(DBH, Tmax,fill = meanY))+geom_tile()+facet_grid(~cohort) 




# ----------------------- Plot future predictions ------------------------
fut <- long.fut
# scenario # 1: no change from modern
Yfut.samps <- data.frame(Y.fut[[1]])

colnames(Yfut.samps) <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.samps$num <- 1:length(Yfut.samps[,2])
fut.m <- melt(Yfut.samps)
fut.m$RWI <- exp(fut.m$value)
colnames(fut.m) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "constant"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort","model",  "year", "site.num","site_year", "scenario")

# summarize by structure + cohort class only:

fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))


# scenario # 2: 35% decrease in drought sensitivie from modern
Yfut.35.samps <- data.frame(Y.fut.35[[1]])

colnames(Yfut.35.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.35.samps$num <- 1:length(Yfut.35.samps[,2])
fut.35.m <- melt(Yfut.35.samps)
fut.35.m $RWI <- exp(fut.35.m $value)
colnames(fut.35.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_35"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.35.proj <- dplyr::inner_join(fut.35.m, fut, by=c("site_year"))


# scenario # 3: 50% decrease in drought sensitivie from modern
Yfut.50.samps <- data.frame(Y.fut.50[[1]])

colnames(Yfut.50.samps) <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.50.samps$num <- 1:length(Yfut.50.samps[,2])
fut.50.m <- melt(Yfut.50.samps)
fut.50.m $RWI <- exp(fut.50.m $value)
colnames(fut.50.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_50"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.50.proj <- dplyr::inner_join(fut.50.m, fut, by=c("site_year"))

# scenario # 4: 50% decrease in drought sensitivy from modern & 50% increase in T sensitivity
Yfut.35.35.samps <- data.frame(Y.fut.35.35[[1]])

colnames(Yfut.35.35.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.35.35.samps$num <- 1:length(Yfut.35.35.samps[,2])
fut.35.35.m <- melt(Yfut.35.35.samps)
fut.35.35.m $RWI <- exp(fut.35.35.m $value)
colnames(fut.35.35.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_35.35"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.35.35.proj <- dplyr::inner_join(fut.35.35.m, fut, by=c("site_year"))



# scenario # 5: 50% decrease in drought sensitivy from modern & 50% increase in T sensitivity
Yfut.50.50.samps <- data.frame(Y.fut.50.50[[1]])

colnames(Yfut.50.50.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.50.50.samps$num <- 1:length(Yfut.50.50.samps[,2])
fut.50.50.m <- melt(Yfut.50.50.samps)
fut.50.50.m $RWI <- exp(fut.50.50.m $value)
colnames(fut.50.50.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_50.50"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.50.50.proj <- dplyr::inner_join(fut.50.50.m, fut, by=c("site_year"))


# now join all together :
all.proj <- rbind(fut.proj, fut.35.proj[!fut.35.proj$year == 2000,], fut.50.proj[!fut.50.proj$year == 2000,], fut.35.35.proj[!fut.35.35.proj$year == 2000,], fut.50.50.proj[!fut.50.50.proj$year == 2000,])



# ------------ For 26 cm tree and average prev years growth ----------------------
small.proj <- all.proj[all.proj$DBH == -0.413 & all.proj$RWI_1 == 0.103 & all.proj$RWI_2 == 0.103,]
small.proj$year <- ifelse(small.proj$year == 2050, "2050-2069",
                          ifelse(small.proj$year == 2070, "2070-2099", "2000"))
scenario_names <- c(
                    'constant' = "sensitivity constant",
                    'decrease_35' = "drought (taper 8%)",
                    'decrease_35.35' = "drought & temp. (taper 8%)",
                    'decrease_50.50' = "drought & temp. (no taper 15%)",
                    'decrease_50' = "drought (no taper 15%)"
                    )



# make one big plot for average previous years growth 
by.scenario <- ggplot(small.proj[!small.proj$year == 2000, ], aes(year, RWI, fill = as.character(year)))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000,]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+facet_grid(~ model + scenario)+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c("blue", "red"))+theme(legend.title = element_blank())


png(height = 4, width = 12, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/fut_growth_by_scenarios_26cm_avg_growth.png")
by.scenario+theme(legend.position = "none")
dev.off()


by.period <- ggplot(small.proj[!small.proj$year == 2000 , ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())

png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/fut_growth_by_time_scenarios_26cm_avg_growth.png")
by.period
dev.off()

by.model <- ggplot(small.proj[!small.proj$year == 2000, ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())+facet_grid(rows = vars(scenario), cols = vars(model))



png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/fut_growth_by_model_26cm_avg_growth.png")
by.model
dev.off()

small.proj$model <- factor(small.proj$model, levels = c("INMCM4", "HadGEM-ES2", "MIROC"))
model_names <- c(
                    'INMCM4' = "INMCM4 \n low Tmax - low Precip",
                    'HadGEM-ES2' = "HadGEM-ES2 \n high Tmax - low Precip",
                    'MIROC' = "MIROC \n high Tmax - high Precip"
                    
                    )


model_names <- c("INMCM4 \n low Tmax - low Precip",
                 "HadGEM-ES2 \n high Tmax - low Precip",
                 "MIROC \n high Tmax - high Precip")

by.model.2050 <- ggplot(small.proj[!small.proj$year == 2000 , ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 8%", "taper P & T 8%", "no taper P 15%", "no taper P & T 15%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())+facet_grid(~model)


png(height = 5, width = 9, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/fut_growth_by_model_2050_26cm_avg_growth.png")
by.model.2050
dev.off()

ggplot(small.proj[!small.proj$year == 2000 & !small.proj$year %in% "2070-2099", ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())+facet_grid(rows=vars(model), cols= vars(site))

# ------------ For 26 cm tree and high prev years growth ----------------------
small.high.proj <- all.proj[all.proj$DBH == -0.413 & all.proj$RWI_1 == 1.891 & all.proj$RWI_2 == 2.030,]
small.high.proj$year <- ifelse(small.high.proj$year == 2050, "2050-2069",
                          ifelse(small.high.proj$year == 2070, "2070-2099", "2000"))
scenario_names <- c(
                    'constant' = "sensitivity constant",
                    'decrease_35' = "drought (taper 35%)",
                    'decrease_35.35' = "drought & temp. (taper 35%)",
                    'decrease_50.50' = "drought & temp. (no taper 50%)",
                    'decrease_50' = "drought (no taper 50%)"
                    )



# make one big plot for average previous years growth 
by.scenario.hi <- ggplot(small.high.proj[!small.high.proj$year == 2000, ], aes(year, RWI, fill = as.character(year)))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.high.proj[small.high.proj$year ==2000,]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+facet_wrap(~scenario, nrow = 1, labeller = as_labeller(scenario_names))+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c("blue", "red"))+theme(legend.title = element_blank())


png(height = 4, width = 12, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/fut_growth_by_scenarios_26cm_high_growth.png")
by.scenario.hi+theme(legend.position = "none")
dev.off()


by.period.hi <- ggplot(small.high.proj[!small.high.proj$year == 2000, ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.high.proj[small.high.proj$year ==2000 & small.high.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())

png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/fut_growth_by_time_scenarios_26cm_high_growth.png")
by.period.hi
dev.off()

# ------------ For 26 cm tree and low prev years growth ----------------------
small.low.proj <- all.proj[all.proj$DBH == -0.413 & all.proj$RWI_1 == -1.609 & all.proj$RWI_2 == -1.470,]
small.low.proj$year <- ifelse(small.low.proj$year == 2050, "2050-2069",
                          ifelse(small.low.proj$year == 2070, "2070-2099", "2000"))
scenario_names <- c(
                    'constant' = "sensitivity constant",
                    'decrease_35' = "drought (taper 35%)",
                    'decrease_35.35' = "drought & temp. (taper 35%)",
                    'decrease_50.50' = "drought & temp. (no taper 50%)",
                    'decrease_50' = "drought (no taper 50%)"
                    )



# make one big plot for average previous years growth 
by.scenario.low <- ggplot(small.low.proj[!small.low.proj$year == 2000, ], aes(year, RWI, fill = as.character(year)))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.low.proj[small.low.proj$year ==2000,]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+facet_wrap(~scenario, nrow = 1, labeller = as_labeller(scenario_names))+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c("blue", "red"))+theme(legend.title = element_blank())


png(height = 4, width = 12, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/fut_growth_by_scenarios_26cm_low_growth.png")
by.scenario.low+theme(legend.position = "none")
dev.off()


by.period.low <- ggplot(small.low.proj[!small.low.proj$year == 2000, ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.low.proj[small.low.proj$year ==2000 & small.low.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())

png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/fut_growth_by_time_scenarios_26cm_low_growth.png")
by.period.low
dev.off()








# extra future figures:


ggplot(all.proj[!all.proj$year == 2000, ], aes(as.factor(year), RWI, fill = as.character(DBH)))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(all.proj[all.proj$year ==2000,]$RWI, na.rm=TRUE))+facet_wrap(~scenario)


medians <- all.proj %>% group_by(year, site, DBH) %>% summarize(med.int = median(RWI))
medians<- medians[medians$year == 2000,]

ggplot(all.proj[!all.proj$year == 2000 & all.proj$DBH ==1.9 , ], aes(as.factor(year), RWI, fill = scenario))+geom_boxplot(position = "dodge2")+geom_hline(aes(yintercept = med.int), data = medians[medians$DBH == 1.9,])+facet_grid(~site)

# make one big plot, but with a line for the modern predictions:




fut.summary <- fut.proj %>% group_by(site_year) %>% dplyr::summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

fut.sum<- merge(fut.summary, fut, by = "site_year")

 #ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()
 ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
 ggplot(fut.sum, aes(Tmax, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
  ggplot(fut.sum, aes(site, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =site, ymin = Ci.low, ymax = Ci.high, color = year))+facet_wrap(~year)+ylim(0,5)
 

   ggplot(fut.sum, aes(as.character(year), meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =as.character(year), ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)
   
   
fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.sum$MAP <- as.numeric(round(unscale(vals = fut.sum$MAP, norm.data = MAP.scaled)))
fut.sum$Tmax <- as.numeric(round(unscale(vals = fut.sum$Tmax, norm.data = T.scaled))) 
fut.sum$year <- as.character(fut.sum$year)
 
 site.fut.tmax <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)
 
 
 sit.fut.map <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)+geom_smooth(method = "lm")
 
 ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~year)+ylim(0,3)+geom_smooth(method = "lm")+theme_bw()

  site.fut.tmax2 <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)

  site.fut.map2 <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
  
  
  fut.full <- fut.proj %>% group_by(year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95), MAP = mean(MAP), Tmax = mean(Tmax))+theme_bw()

#fut.full<- merge(fut.full, fut, by = "year")

#fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.full$MAP <- as.numeric(round(unscale(vals = fut.full$MAP, norm.data = MAP.scaled)))
fut.full$Tmax <- as.numeric(round(unscale(vals = fut.full$Tmax, norm.data = T.scaled))) 
fut.full$year <- as.character(fut.full$year)

fut.year<- ggplot(fut.full, aes(year, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =year, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+theme_bw(base_size = 15)+theme(legend.position = "none")

fut.T<- ggplot(fut.full, aes(Tmax, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Max. Temp")+theme_bw(base_size = 15)+theme(legend.position = "none")
 

fut.map<- ggplot(fut.full, aes(MAP, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =MAP, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Precipitation")+theme_bw(base_size = 15)+theme(legend.position = "none")

png(height = 3.5, width = 8, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/future_average_growth.png")
plot_grid(fut.year, fut.T, fut.map, align = "v", nrow = 1)
dev.off()
 

png(height = 5, width = 10, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/future_average_growth_by_site.png")
plot_grid(site.fut.tmax, sit.fut.map, ncol = 2)
dev.off()


# -------- Plot future predictions with further declines in drought sensitivity --------------

Yfut.35.samps <- data.frame(Y.fut.35[[1]])

colnames(Yfut.35.samps) <- paste0(fut$site, "_",fut$year)
Yfut.35.samps$num <- 1:length(Yfut.35.samps$AVO_2015)
fut.m <- melt(Yfut.35.samps)
fut.m$RWI <- exp(fut.m$value)
colnames(fut.m) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year)
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort",  "year", "site.num","site_year")

# summarize by structure + cohort class only:

fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))

fut.summary <- fut.proj %>% group_by(site_year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

fut.sum<- merge(fut.summary, fut, by = "site_year")

 #ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()
 ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
 ggplot(fut.sum, aes(Tmax, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
  ggplot(fut.sum, aes(site, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =site, ymin = Ci.low, ymax = Ci.high, color = year))+facet_wrap(~year)+ylim(0,5)
 

   ggplot(fut.sum, aes(as.character(year), meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =as.character(year), ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)
   
   
fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.sum$MAP <- as.numeric(round(unscale(vals = fut.sum$MAP, norm.data = MAP.scaled)))
fut.sum$Tmax <- as.numeric(round(unscale(vals = fut.sum$Tmax, norm.data = T.scaled))) 
fut.sum$year <- as.character(fut.sum$year)
 
 site.fut.tmax <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)
 
 
 sit.fut.map <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)+geom_smooth(method = "lm")
 
 ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~year)+ylim(0,3)+geom_smooth(method = "lm")+theme_bw()

  site.fut.tmax2 <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)

  site.fut.map2 <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
  
  
  fut.full <- fut.proj %>% group_by(year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95), MAP = mean(MAP), Tmax = mean(Tmax))

#fut.full<- merge(fut.full, fut, by = "year")

#fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.full$MAP <- as.numeric(round(unscale(vals = fut.full$MAP, norm.data = MAP.scaled)))
fut.full$Tmax <- as.numeric(round(unscale(vals = fut.full$Tmax, norm.data = T.scaled))) 
fut.full$year <- as.character(fut.full$year)

fut.year <- ggplot(fut.full, aes(year, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =year, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+theme_bw(base_size = 15)+theme(legend.position = "none")

fut.T<- ggplot(fut.full, aes(Tmax, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Max. Temp")+theme_bw(base_size = 15)+theme(legend.position = "none")
 

fut.map<- ggplot(fut.full, aes(MAP, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =MAP, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Precipitation")+theme_bw(base_size = 15)+theme(legend.position = "none")

png(height = 3.5, width = 8, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/future_average_growth_0.35_decline_drought_sens.png")
plot_grid(fut.year, fut.T, fut.map, align = "v", nrow = 1)
dev.off()
 

png(height = 5, width = 10, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/future_average_growth_by_site.png")
plot_grid(site.fut.tmax, sit.fut.map, ncol = 2)
dev.off()


# -------- Plot future predictions with further declines i.e. 50% in drought sensitivity --------------

Yfut.50.samps <- data.frame(Y.fut.50[[1]])

colnames(Yfut.50.samps) <- paste0(fut$site, "_",fut$year)
Yfut.50.samps$num <- 1:length(Yfut.50.samps$AVO_2015)
fut.m <- melt(Yfut.50.samps)
fut.m$RWI <- exp(fut.m$value)
colnames(fut.m) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year)
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort",  "year", "site.num","site_year")

# summarize by structure + cohort class only:

fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))

fut.summary <- fut.proj %>% group_by(site_year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

fut.sum<- merge(fut.summary, fut, by = "site_year")

 #ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()
 ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
 ggplot(fut.sum, aes(Tmax, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
  ggplot(fut.sum, aes(site, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =site, ymin = Ci.low, ymax = Ci.high, color = year))+facet_wrap(~year)+ylim(0,5)
 

   ggplot(fut.sum, aes(as.character(year), meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =as.character(year), ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)
   
   
fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.sum$MAP <- as.numeric(round(unscale(vals = fut.sum$MAP, norm.data = MAP.scaled)))
fut.sum$Tmax <- as.numeric(round(unscale(vals = fut.sum$Tmax, norm.data = T.scaled))) 
fut.sum$year <- as.character(fut.sum$year)
 
 site.fut.tmax <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)
 
 
 sit.fut.map <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)+geom_smooth(method = "lm")
 
 ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~year)+ylim(0,3)+geom_smooth(method = "lm")+theme_bw()

  site.fut.tmax2 <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)

  site.fut.map2 <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
  
  
  fut.full <- fut.proj %>% group_by(year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95), MAP = mean(MAP), Tmax = mean(Tmax))

#fut.full<- merge(fut.full, fut, by = "year")

#fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.full$MAP <- as.numeric(round(unscale(vals = fut.full$MAP, norm.data = MAP.scaled)))
fut.full$Tmax <- as.numeric(round(unscale(vals = fut.full$Tmax, norm.data = T.scaled))) 
fut.full$year <- as.character(fut.full$year)

fut.year <- ggplot(fut.full, aes(year, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =year, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+theme_bw(base_size = 15)+theme(legend.position = "none")

fut.T <- ggplot(fut.full, aes(Tmax, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Max. Temp")+theme_bw(base_size = 15)+theme(legend.position = "none")
 

fut.map <- ggplot(fut.full, aes(MAP, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =MAP, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Precipitation")+theme_bw(base_size = 15)+theme(legend.position = "none")

png(height = 3.5, width = 8, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/future_average_growth_0.50_decline_drought_sens.png")
plot_grid(fut.year, fut.T, fut.map, align = "v", nrow = 1)
dev.off()
 

png(height = 5, width = 10, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/future_average_growth_by_site_50.png")
plot_grid(site.fut.tmax, sit.fut.map, ncol = 2)
dev.off()



# -------- Plot future predictions with further declines i.e. 50% in drought sensitivity+ 50% increase in t sensitivity --------------

Yfut.50.50.samps <- data.frame(Y.fut.50.50[[1]])

colnames(Yfut.50.50.samps) <- paste0(fut$site, "_",fut$year)
Yfut.50.50.samps$num <- 1:length(Yfut.50.50.samps$AVO_2015)
fut.m <- melt(Yfut.50.50.samps)
fut.m$RWI <- exp(fut.m$value)
colnames(fut.m) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year)
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort",  "year", "site.num","site_year")

# summarize by structure + cohort class only:

fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))

fut.summary <- fut.proj %>% group_by(site_year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

fut.sum<- merge(fut.summary, fut, by = "site_year")

 #ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()
 ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
 ggplot(fut.sum, aes(Tmax, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
  ggplot(fut.sum, aes(site, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =site, ymin = Ci.low, ymax = Ci.high, color = year))+facet_wrap(~year)+ylim(0,5)
 

   ggplot(fut.sum, aes(as.character(year), meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =as.character(year), ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)
   
   
fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.sum$MAP <- as.numeric(round(unscale(vals = fut.sum$MAP, norm.data = MAP.scaled)))
fut.sum$Tmax <- as.numeric(round(unscale(vals = fut.sum$Tmax, norm.data = T.scaled))) 
fut.sum$year <- as.character(fut.sum$year)
 
 site.fut.tmax <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)
 
 
 sit.fut.map <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~site)+ylim(0,3)+theme_bw(base_size = 10)+geom_smooth(method = "lm")
 
 ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+facet_wrap(~year)+ylim(0,3)+geom_smooth(method = "lm")+theme_bw()

  site.fut.tmax2 <- ggplot(fut.sum, aes(Tmax, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)

  site.fut.map2 <- ggplot(fut.sum, aes(MAP, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =MAP, ymin = Ci.low, ymax = Ci.high, color = year), width = 0.1)+ylim(0,3)+geom_smooth(method = "lm", se = FALSE)+theme_bw(base_size = 12)
  
  
  fut.full <- fut.proj %>% group_by(year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95), MAP = mean(MAP), Tmax = mean(Tmax))

#fut.full<- merge(fut.full, fut, by = "year")

#fut.sum$DBH <- as.numeric(round(unscale(vals =fut.sum$DBH, norm.data = DBH.scaled))) 
fut.full$MAP <- as.numeric(round(unscale(vals = fut.full$MAP, norm.data = MAP.scaled)))
fut.full$Tmax <- as.numeric(round(unscale(vals = fut.full$Tmax, norm.data = T.scaled))) 
fut.full$year <- as.character(fut.full$year)

fut.year <- ggplot(fut.full, aes(year, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =year, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+theme_bw(base_size = 15)+theme(legend.position = "none")

fut.T <- ggplot(fut.full, aes(Tmax, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =Tmax, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Max. Temp")+theme_bw(base_size = 15)+theme(legend.position = "none")
 

fut.map <- ggplot(fut.full, aes(MAP, meanY, color = year))+geom_point(size = 3)+geom_errorbar(data = fut.full, aes(x =MAP, ymin = Ci.low, ymax = Ci.high),color = "grey", width = 0.1)+ylab("Predicted Growth (mm)")+xlab("Precipitation")+theme_bw(base_size = 15)+theme(legend.position = "none")

png(height = 3.5, width = 8, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/future_average_growth_0.50_decline_drought_sens50.50.png")
plot_grid(fut.year, fut.T, fut.map, align = "v", nrow = 1)
dev.off()
 

png(height = 5, width = 10, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs/future_average_growth_by_site_50.50.png")
plot_grid(site.fut.tmax, sit.fut.map, ncol = 2)
dev.off()


```
 
 
 # FOR DRY YEARS ONLY: multi-level model with MAP as drought index, an INTERACTION between MAP and Tmax stand structure by ageclass random effects and prev years growth (lag -1) and (lag - 2), and a site level random intercept parameter: 

```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"

population_model_site_int_structure_x_cohort_re_lag2_temp_MAP_interaction.f <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] + beta7[struct.cohort[i]]*Temp.scaled[i]*DI.scaled[i] # inclued beta 7 as interaction term 
   

}



# Prediction from known data
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[site.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4[struct.cohort.p[i]]*log_RWI_1.p[i] +beta5[struct.cohort.p[i]]*log_RWI_2.p[i] + beta6[struct.cohort.p[i]]*Temp.scaled.p[i]+ beta7[struct.cohort.p[i]]*Temp.scaled.p[i]*DI.scaled.p[i]
  }

# # probe for prediction plots:
#   for(i in 1:nprobe){
#     Yprobe[i]  ~ dnorm(muprobe[i],inv.var)
#     muprobe[i] <- beta1[site.probe[i]] + beta2[struct.cohort.probe[i]]*DI.scaled.probe[i] + beta3[struct.cohort.probe[i]]*DBH.scaled.probe[i] +beta4[struct.cohort.probe[i]]*log_RWI_1.probe[i] + beta5[struct.cohort.probe[i]]*log_RWI_2.probe[i] + beta6[struct.cohort.probe[i]]*Temp.scaled.probe[i] + beta7[struct.cohort.probe[i]]*Temp.scaled.probe[i]*DI.scaled.probe[i]
#   }
# 
# # project into the future (assuming no further change in drought senseiivty):
#   for(i in 1:nfut){
#    Yfut[i]  ~ dnorm(mufut[i],inv.var)
#     mufut[i] <- beta1[site.fut[i]] + beta2[struct.cohort.fut[i]]*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i] + (beta7[struct.cohort.fut[i]])*Temp.scaled.fut[i]*DI.scaled.fut[i]
#   }
# 
# # project into the future (assuming 35% further change in drought senseiivty):
#   for(i in 1:nfut){
#    Yfut.35[i]  ~ dnorm(mufut2[i],inv.var)
#     mufut2[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.92)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]+ (beta7[struct.cohort.fut[i]])*Temp.scaled.fut[i]*DI.scaled.fut[i]
#   }
# 
# 
# 
# # project into the future (assuming 50% further change in drought senseiivty):
#   for(i in 1:nfut){
#    Yfut.50[i]  ~ dnorm(mufut3[i],inv.var)
#     mufut3[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.85)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]+ (beta7[struct.cohort.fut[i]])*Temp.scaled.fut[i]*DI.scaled.fut[i]
#   }
# 
# 
# # project into the future (assuming 8% further change in drought senseiivty & temperature):
#   for(i in 1:nfut){
#    Yfut.35.35[i]  ~ dnorm(mufut35[i],inv.var)
#     mufut35[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.92)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + (beta6[struct.cohort.fut[i]]*1.08)*Temp.scaled.fut[i]+ (beta7[struct.cohort.fut[i]]*0.92)*Temp.scaled.fut[i]*DI.scaled.fut[i]
#   }
# 


# # project into the future (assuming 7% further change in drought senseiivty):
#   for(i in 1:nfut){
#    Yfut.50.50[i]  ~ dnorm(mufut50[i],inv.var)
#     mufut50[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.85)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + (beta6[struct.cohort.fut[i]]*1.15)*Temp.scaled.fut[i]+(beta7[struct.cohort.fut[i]]*0.85)*Temp.scaled.fut[i]*DI.scaled.fut[i]
#   }

# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){

beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
beta5[s] ~ dnorm(mu_beta5, inv_beta5)
beta6[s] ~ dnorm(mu_beta6, inv_beta6)
beta7[s] ~ dnorm(mu_beta7, inv_beta7)
}


for(k in 1:Nsites){
beta1[k] ~ dnorm(mu_beta1, inv_beta1)
}


# use uniform priors for each  Mubeta paramters 
mu_beta1 ~ dunif(-1, 1)
mu_beta2 ~ dunif(-1, 1)
mu_beta3 ~ dunif(-1, 1)
mu_beta4 ~ dunif(-1, 1)
mu_beta5 ~ dunif(-1, 1)
mu_beta6 ~ dunif(-1, 1)
mu_beta7 ~ dunif(-1, 1)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)
inv_beta6   ~ dgamma(0.01, 0.01)
sigma_beta6 <- 1/sqrt(inv_beta6)
inv_beta7   ~ dgamma(0.01, 0.01)
sigma_beta7 <- 1/sqrt(inv_beta7)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)



# calculate differences between parameters:
one.two <- beta2[1] - beta2[2]
two.three<- beta2[2] - beta2[3]
three.four<- beta2[3] - beta2[4]
two.four <- beta2[2] - beta2[4]


}"

# save these for use later:
saveRDS(train.dry.pair, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/train.rds")
saveRDS(test.dry.pair, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/test.rds")
train.dry.pair <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/train.rds")
test.dry.pair <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/test.rds")

full.dry.pair <- dry.yrs.paired  

# assign site numbers to each site:

site.num.df <- data.frame(site = as.character(unique(train.dry.pair$site)), 
           site.num = 1:length(as.character(unique(train.dry.pair$site))))

# if site num is not in the df, add it
if(! "site.num" %in% colnames(train.dry.pair)){
    train.dry.pair <- merge(train.dry.pair, site.num.df, by = "site" )
    test.dry.pair <- merge(test.dry.pair, site.num.df, by = "site" )
    full.dry.pair <- merge(full.dry.pair, site.num.df, by = "site")
}

# generate probe dataset:
 DIprobe <- round(seq(range(train.dry.pair$MAP.scaled)[1], range(train.dry.pair$MAP.scaled)[2], by = 0.75), 3)
 DBHprobe <- round(seq(range(train.dry.pair$DBH.scaled)[1], range(train.dry.pair$DBH.scaled)[2], by = 0.75), 3)
 Tempprobe <- round(seq(range(train.dry.pair$T.scaled)[1], range(train.dry.pair$T.scaled)[2], by = 0.75), 3)
 RWI1probe <- round(seq(range(log(train.dry.pair$RWI_1))[1], range(log(train.dry.pair$RWI_1))[2], by = 0.5), 3)
 RWI2probe <- round(seq(range(log(train.dry.pair$RWI_2))[1], range(log(train.dry.pair$RWI_2))[2], by = 0.5), 3)
 
 # expand into full probe
probe <- expand.grid(DI.scaled = DIprobe, DBH.scaled = DBHprobe, T.scaled = Tempprobe,
                         RWI_1 = RWI1probe, RWI_2= RWI2probe, struct.cohort.code= 1:4, site.num = unique(train.dry.pair$site.num))

sit.cohorts <- unique(train.dry.pair[,c("struct.cohort.code", "site.num")])
probe <- merge(probe, sit.cohorts, by = c("struct.cohort.code", "site.num")) # make sure that each site only has savanna or forest in the probe

# make probe smaller to help with saving:
short.probe <- probe[probe$RWI_1 %in% c("-1.609", "0.391", "1.891") & probe$RWI_2 %in% c("-1.484", "0.016", "1.516") & probe$DBH.scaled %in% c("-0.413", "0.337", "1.837"),]

#short.probe <- probe

# make a probe for future climate projections at our sites!
rcp85 <- rcp85[!rcp85$site %in% c("COR", "GLL4", "HIC", "PLE", "PVC", "STC", "TOW"),]
future.probe_70 <- data.frame(MAP.scaled = rcp85$PR_85_70.scaled, DBH.scaled= -0.413, 
                              T.scaled = rcp85$Tx_70.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103,  struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_70$year <- 2070
future.probe_50 <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site,  model = rcp85$model)
future.probe_50$year <- 2050


# get climate averages from 1950 - present at each site:
train.dry.pair$struct.cohort.code2 <- as.numeric(train.dry.pair$struct.cohort.code)
train.clim.summary <-
  train.dry.pair[train.dry.pair$ageclass %in% "Modern", ] %>% group_by(site) %>% dplyr::summarise(
    MAP.scaled = mean(MAP.scaled),
    DBH.scaled = -0.413,
    T.scaled = mean(T.scaled),
    RWI_1 = 0.103,
    RWI_2 = 0.103,
    struct.cohort.code = mean(struct.cohort.code2),
    model = "none",
    year = 2000
    )



Average.prob <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_50$year <- 2050


fut <- rbind(future.probe_50, future.probe_70, train.clim.summary[,c("MAP.scaled", "DBH.scaled",  "T.scaled", "RWI_1", "RWI_2", "struct.cohort.code", "site","year","model")])


fut <- merge(fut, site.num.df, by = "site")

# look at the effects under two different DBH values
short.fut <- fut
fut.small <- fut
fut.large <- fut
fut.small$DBH.scaled <- -0.413
fut.large$DBH.scaled <- 1.900
long.fut <- rbind(fut.small, fut.large)


# look at the effects under average, below average, and above average different prev year growth values
lfut.low <- long.fut
lfut.avg <- long.fut
lfut.high <- long.fut

lfut.low$RWI_1 <- -1.609
lfut.low$RWI_2 <- -1.47

lfut.high$RWI_1 <- 1.891
lfut.high$RWI_2 <- 2.03

long.fut <- rbind(lfut.high, lfut.avg, lfut.low)

lag2.model.by_structure_x_cohort_t_pr_int <- jags.model(textConnection(population_model_site_int_structure_x_cohort_re_lag2_temp_MAP_interaction.f), 
                    data = list(Y=log(train.dry.pair$RWI), n=length(train.dry.pair$RWI), DI.scaled = train.dry.pair$MAP.scaled, DBH.scaled = train.dry.pair$DBH.scaled,log_RWI_1 = log(train.dry.pair$RWI_1),log_RWI_2 = log(train.dry.pair$RWI_2), Temp.scaled = train.dry.pair$T.scaled, struct.cohort = as.numeric(train.dry.pair$struct.cohort.code), SF = as.numeric(unique(train.dry.pair$struct.cohort.code)), site = train.dry.pair$site.num, Nsites = length(unique(train.dry.pair$site)),
                                
  struct.cohort.p = as.numeric(full.dry.pair$struct.cohort.code), DBH.scaled.p = full.dry.pair$DBH.scaled, DI.scaled.p = full.dry.pair$MAP.scaled, log_RWI_1.p = log(full.dry.pair$RWI_1), log_RWI_2.p = log(full.dry.pair$RWI_2), Temp.scaled.p = full.dry.pair$T.scaled, site.p = full.dry.pair$site.num, np = length(as.numeric(full.dry.pair$struct.cohort.code))
  
  # struct.cohort.probe = as.numeric(short.probe$struct.cohort.code), DBH.scaled.probe = short.probe$DBH.scaled, DI.scaled.probe = short.probe$DI.scaled, log_RWI_1.probe = short.probe$RWI_1, log_RWI_2.probe =short.probe$RWI_2, Temp.scaled.probe = short.probe$T.scaled, site.probe = short.probe$site.num, nprobe = length(as.numeric(short.probe$struct.cohort.code)), 
  # 
  # struct.cohort.fut = as.numeric(long.fut$struct.cohort.code), DBH.scaled.fut = long.fut$DBH.scaled, DI.scaled.fut = long.fut$MAP.scaled, log_RWI_1.fut = long.fut$RWI_1, log_RWI_2.fut =long.fut$RWI_2, Temp.scaled.fut = long.fut$T.scaled, site.fut = long.fut$site.num, nfut = length(as.numeric(long.fut$struct.cohort.code))
 
  
  ),
  n.chains = 3, n.adapt = 100)

update(lag2.model.by_structure_x_cohort_t_pr_int, 10000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","beta6","beta7","sigma", "mu_beta1", "mu_beta2","mu_beta3", "mu_beta4","mu_beta5", "mu_beta6", "mu_beta7"), 
                    n.chains = 3, n.iter=10000, thin = 15)


# beta2.diffs <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
#                      variable.names=c("one.two", "two.three", "three.four", "two.four"), 
#                     n.chains = 3, n.iter=10000, thin = 15)

Yp <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yp"), 
                    n.chains = 3, n.iter=10000, thin = 15)


Y.probe <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yprobe"), 
                    n.chains = 3, n.iter=5000, thin = 15)

Y.fut <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yfut"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yfut.35"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yfut.50"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.35.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yfut.35.35"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.50.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yfut.50.50"), 
                    n.chains = 3, n.iter=10000,thin = 15)


dic.full <- dic.samples(lag2.model.by_structure_x_cohort_t_pr_int, n.chains = 3, n.iter=10000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_DIC.rds")

summary(samp.structure.cohort.re)

traceplot(samp.structure.cohort.re[,"beta2[1]"])

# most just around 1
gelman.diag(samp.structure.cohort.re, multivariate = FALSE)
acfplot(samp.structure.cohort.re)


autocorr.plot(samp.structure.cohort.re [[1]][ , 'beta2[2]'], auto.layout = FALSE, lwd = 4, col = "red", lag.max = 100)

#Extract the samples for each parameter for a basic exploration of effects

 samps   <- samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/samps.rds")
 samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/samps.rds")
 test.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/test.rds")
 train.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/train.rds")
saveRDS(Yp,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/YP.samps.rds")
# Y.probe <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_yprobe_preds.rds")
#Yfut.samps <- samps[, 1:length(fut$RWI_1)]
#samps <- samps[,(length(fut$RWI_1)+1):length(colnames(samps))]
 Yp.samps <- Yp
 Yprobe.samps <- Y.probe
 alpha.samps  <- samps[,1:9]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,10:13]
 beta3.samps <- samps[,14:17]
 beta4.samps <- samps[,18:21]
 beta5.samps <- samps[,22:25]
 beta6.samps <- samps[,26:29]
 beta7.samps <- samps[,30:33]
 mu_beta.samps <- samps[,34:40]
 sigma.samps <- samps[,36]
 sigma_betas <- samps[,30:35]

 
 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps[[1]]) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))

test.dry.pair2 <- test.dry.pair
test.dry.pair2$variable <- unique(Yp.m$variable)

Yp.summary$Observed <- test.dry.pair$RWI



pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test.dry.pair$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)+theme_bw(base_size = 15)

# note best model fit so far
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/pred_vs_obs.png")
p.o.plot
dev.off()

# plot average growth boxplots for modern & past:

Yp.full <- left_join(Yp.m, test.dry.pair2, by = "variable")


# get estimates for predicted growth:
Yp.summary.cohort  <- Yp.full %>% group_by(struct.cohort) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025), 
                                                 Observed = mean(RWI))



ggplot(Yp.summary.cohort, aes(struct.cohort,Predicted, fill = struct.cohort))+geom_bar(stat = "identity")+geom_errorbar(data = Yp.summary.cohort,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.8, size = 0.5, width = 0.2)+ylim(0, 6)+theme_bw()

#ggplot(Yp.summary.cohort, aes(class, Predicted, fill= class))+geom_boxplot()+facet_wrap(~DBHclass)
#ggplot(Yp.summary.cohourt, aes(class, Observed, fill= class))+geom_boxplot()+facet_wrap(~site)

# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test.dry.pair$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test.dry.pair$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter", 
                            model.summary = "beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] + beta7[struct.cohort[i]]*Temp.scaled[i]*DI.scaled[i] ",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter", 
                           train = "cohort.omit.dry.years", 
                           DI.scaled = "MAP")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)



# get difference between beta2.samps: (i.e are they different?)
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]




# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- unique(train.dry.pair$site)#[order(unique(train.dry.pair[,c("site", "site.num")])[,2])])
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <-c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
#colnames(b2) <- c(paste0(c(unique(train.dry.pair$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope")

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH Index slope")


b4 <- data.frame(beta4.samps)
colnames(b4) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-1 Index slope")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-2 Index slope")

b6 <- data.frame(beta6.samps)
colnames(b6) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b6$num <- rownames(b6)
b6.m <- melt(b6, id.vars=c("num"))
b6.mplots <- ggplot(b6.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Summer Temperature slope")

b7 <- data.frame(beta7.samps)
colnames(b7) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b7$num <- rownames(b7)
b7.m <- melt(b7, id.vars=c("num"))
b7.mplots <- ggplot(b7.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precip*Temp slope")



png(height = 10, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/drougt_beta_marginal_distn_bycohort.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots, b5.mplots, b6.mplots, b7.mplots)
dev.off()



# ------------------------- DOTPLOT MODEL SUMMARIES -----------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:

a1.sum <- a.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
a1.sum$variable <- unique(train.dry.pair$site)

df.site.struct <- unique(train.dry.pair[,c("site", "structure")])
a1.sum <- merge(a1.sum, df.site.struct, by.x = "variable", by.y = "site")
a1.sum$structure <- factor(a1.sum$structure, levels = c( "Forest", "Savanna"))

b2.sum <- b2.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b2.sum$variable <- factor(b2.sum$variable, levels = c( "Modern-Forest", "Modern-Savanna", "Past-Forest", "Past-Savanna"))


b3.sum <- b3.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b3.sum$variable <- factor(b3.sum$variable, levels = c( "Modern-Forest", "Modern-Savanna", "Past-Forest", "Past-Savanna"))


b4.sum <- b4.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b4.sum$variable <- factor(b4.sum$variable, levels = c( "Modern-Forest", "Modern-Savanna", "Past-Forest", "Past-Savanna"))

b5.sum <- b5.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b5.sum$variable <- factor(b5.sum$variable, levels = c( "Modern-Forest", "Modern-Savanna", "Past-Forest", "Past-Savanna"))

b6.sum <- b6.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b6.sum$variable <- factor(b6.sum$variable, levels = c( "Modern-Forest", "Modern-Savanna", "Past-Forest", "Past-Savanna"))


b7.sum <- b7.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b7.sum$variable <- factor(b7.sum$variable, levels = c(  "Modern-Forest", "Modern-Savanna", "Past-Forest", "Past-Savanna"))


# write out all the dotplots
int.dot <- ggplot(data.frame(a1.sum), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Savanna"='sienna4',
"Forest"='forestgreen'))+theme_bw()+theme(legend.position = "none", axis.title.y = element_blank(), panel.grid = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.19, 0.71)+ geom_vline(xintercept = 0, linetype = "dashed")

b2.dot <- ggplot(data.frame(b2.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.15, 0.8)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme_bw()+theme(legend.position = "none", axis.title.y = element_blank(), panel.grid = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.19, 0.71)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot <- ggplot(data.frame(b3.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.19, 0.71)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme_bw()+theme(legend.position = "none", axis.title.y = element_blank(), panel.grid = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.19, 0.71)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot <- ggplot(data.frame(b4.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme_bw()+theme(legend.position = "none", axis.title.y = element_blank(), panel.grid = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.19, 0.71)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot <- ggplot(data.frame(b5.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme_bw()+theme(legend.position = "none", axis.title.y= element_blank(), panel.grid = element_blank())+xlab("Estimated lag -2 growth coef. (Beta5)")+xlim(-0.19, 0.71)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot <- ggplot(data.frame(b6.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme_bw()+theme(legend.position = "none", axis.title.y = element_blank(), panel.grid = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.19, 0.71)+ geom_vline(xintercept = 0, linetype = "dashed")

b7.dot <- ggplot(data.frame(b7.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme_bw()+theme(legend.position = "none", axis.title.y = element_blank(), panel.grid = element_blank())+xlab("Estimated Temp*Precip sensitivity (Beta7)")+xlim(-0.19, 0.71)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_dot_plot_cohort_struct.png")
plot_grid(int.dot , b2.dot, b6.dot, b7.dot , b3.dot, b4.dot, b5.dot, ncol = 1, align = "v")
dev.off()


# -------------------- DOTPLOTS by modern vs. past only ---------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:
# a does not vary by cohort 
a1.sum.age <- a1.sum

b2.m$cohort <- ifelse(b2.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
b2.sum.age <- b2.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b3.m$cohort <- ifelse(b3.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b3.sum.age <- b3.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b4.m$cohort <- ifelse(b4.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b4.sum.age <- b4.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.m$cohort <- ifelse(b5.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b5.sum.age <- b5.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b6.m$cohort <- ifelse(b6.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b6.sum.age <- b6.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

# write out all the dotplots
int.dot.age <- ggplot(data.frame(a1.sum.age), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme_bw()+theme(panel.grid = element_blank(),legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.19, 0.71) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot.age <- ggplot(data.frame(b2.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme_bw()+theme(panel.grid = element_blank(),legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.19, 0.71)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot.age <- ggplot(data.frame(b3.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme_bw()+theme(panel.grid = element_blank(),legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.19, 0.71)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot.age <- ggplot(data.frame(b4.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme_bw()+theme(panel.grid = element_blank(),legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot.age <- ggplot(data.frame(b5.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme_bw()+theme(panel.grid = element_blank(),legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.19, 0.71)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot.age <- ggplot(data.frame(b6.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+theme_bw()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(panel.grid = element_blank(), legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.19, 0.71)+ geom_vline(xintercept = 0, linetype = "dashed")

b7.dot.age <- ggplot(data.frame(b6.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1, height = 0))+geom_point()+theme_bw()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(panel.grid = element_blank(), legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Temp*Precip sensitivity (Beta7)")+xlim(-0.19, 0.71)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_dot_plot_cohort_only.png")
plot_grid(int.dot.age, b2.dot.age, b6.dot.age,b7.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1, align = "v")
dev.off()



png(height = 12, width = 8.5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_dot_plot_cohort_and_cohortXstruct.png")
plot_grid(int.dot.age+xlim(-0.18, 0.74),int.dot+xlim(-0.18, 0.74),
         b2.dot.age+xlim(-0.18, 0.74) , b2.dot+xlim(-0.18, 0.74), 
         b6.dot.age+xlim(-0.18, 0.74), b6.dot+xlim(-0.18, 0.74),
         b7.dot.age+xlim(-0.18, 0.74), b7.dot+xlim(-0.18, 0.74),
         b3.dot.age+xlim(-0.18, 0.74), b3.dot+xlim(-0.18, 0.74),
         b4.dot.age+xlim(-0.18, 0.74),  b4.dot+xlim(-0.18, 0.74),
         b5.dot.age+xlim(-0.18, 0.74), b5.dot+xlim(-0.18, 0.74), ncol = 2, align = "hv", labels = c("a","h",
                                                                "b","i",
                                                                "c","j",
                                                                "d","k",
                                                                "e","l",
                                                                "f","m",
                                                                "g", "n"), label_x = 0.28, label_y=0.97)
dev.off()



# ------------------ Do the site level intercepts correlate with site quality -----------
# read in information about site quality:
locs <- read.csv("outputs/priority_sites_locs_with_soil_clim.csv")
locs <- data.frame(locs)
locs$code <- as.character(locs$code)
locs[9:12,]$code <- c( "GLL1", "GLL2", "GLL3", "GLL4")
sites <- c("COR", "HIC", "STC", "GLA", "TOW", "ENG", "UNC", "BON", "MOU", "GLL4", "GLL3", "GLL2", "GLL1", "PVC", "AVO", "PLE", "UNI")

# merge with a1.sum.age
site.summary <- merge(a1.sum.age, locs, by.x = "variable", by.y = "code")

# plot mean + 95% confidence interval vs. MAP
alpha.pr30yr <-ggplot(site.summary, aes(x = pr30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("Total Precip")
# get an idea if there might be relationship
summary(lm(mean.val ~ pr30yr,data = site.summary))

# plot mean + 95% confidence interval vs. Tmean
alpha.tm30yr <-ggplot(site.summary, aes(x = tm30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("Mean Temp")
# get an idea if there might be relationship
summary(lm(mean.val ~ tm30yr,data = site.summary))

# plot mean + 95% confidence interval vs. sand %
alpha.sand <-ggplot(site.summary, aes(x = sand, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("sand")#+stat_smooth(method = "lm")
# get an idea if there might be relationship
summary(lm(mean.val ~ sand,data = site.summary))

# plot mean + 95% confidence interval vs. ksat
alpha.ksat <-ggplot(site.summary, aes(x = ksat, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("ksat")
# get an idea if there might be relationship
summary(lm(mean.val ~ ksat,data = site.summary))

# plot mean + 95% confidence interval vs. awc

alpha.awc <- ggplot(site.summary, aes(x = awc, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("AWC")
# get an idea if there might be relationship
summary(lm(mean.val ~ awc,data = site.summary))

# plot mean + 95% confidence interval vs. n. species 

alpha.nspecies <- ggplot(site.summary, aes(x = nspecies, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("nspecies")#+stat_smooth(data = site.summary, aes(x = nspecies, y = mean.val), method = "lm")

# there seems to be no relationship between alpha and site characteristics
# but plot the relationships out here:
png(height = 10, width = 4, units = "in",res = 200, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/alpha_site_ints_vs_site_quality.png")
plot_grid(alpha.pr30yr, alpha.tm30yr, alpha.awc, alpha.sand, alpha.nspecies, ncol = 1, align = "v")
dev.off()

#---------------------- More beta summary plots -----------------------------

# plot slightly differently:
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")

plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))

# b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_bw(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
# "Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")
# 
# png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_site_rs/param_marginal_distn_bycohort_struct_rb.png")
# b2.dots.2
# dev.off()

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

library(cowplot)
png(width = 5, height = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/param_marginal_distn_bycohort_struct_1.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, b5.mplots,ncol = 1)
dev.off()


# plot effect of temp conditional on MAP (interaction):
## Simulate the range of the moderating variable

T.sim <- seq(min(train.dry.pair$T.scaled), max(train.dry.pair$T.scaled), by = 0.1)

## Calculate conditional effect of X1 across the range of X2
#int.mcmc <- as.mcmc(samp.structure.cohort.re[[1]])
int.mcmc <- as.mcmc(samps)
int.mcmc.mat <- as.matrix(int.mcmc)
int.mcmc.dat <- data.frame(int.mcmc.mat)

int.1 <- matrix(rep(NA, nrow(int.mcmc.dat)*length(T.sim)), nrow = nrow(int.mcmc.dat))
int.2 <- matrix(rep(NA, nrow(int.mcmc.dat)*length(T.sim)), nrow = nrow(int.mcmc.dat))
int.3 <- matrix(rep(NA, nrow(int.mcmc.dat)*length(T.sim)), nrow = nrow(int.mcmc.dat))
int.4 <- matrix(rep(NA, nrow(int.mcmc.dat)*length(T.sim)), nrow = nrow(int.mcmc.dat))

for(i in 1:length(T.sim)){
  int.1[, i] <- int.mcmc.dat$beta2.1. + int.mcmc.dat$beta7.1. * T.sim[i]
  int.2[, i] <- int.mcmc.dat$beta2.2. + int.mcmc.dat$beta7.2. * T.sim[i]
  int.3[, i] <- int.mcmc.dat$beta2.3. + int.mcmc.dat$beta7.3. * T.sim[i]
  int.4[, i] <- int.mcmc.dat$beta2.4. + int.mcmc.dat$beta7.4. * T.sim[i]
}

## Note: the variance now comes from the posterior, not the vcov matrix

bayes.c.eff.mean1 <- apply(int.1, 2, mean)
bayes.c.eff.lower1 <- apply(int.1, 2, function(x) quantile(x, probs = c(0.025)))
bayes.c.eff.upper1 <- apply(int.1, 2, function(x) quantile(x, probs = c(0.975)))

bayes.c.eff.mean2 <- apply(int.2, 2, mean)
bayes.c.eff.lower2 <- apply(int.2, 2, function(x) quantile(x, probs = c(0.025)))
bayes.c.eff.upper2 <- apply(int.2, 2, function(x) quantile(x, probs = c(0.975)))


bayes.c.eff.mean3 <- apply(int.3, 2, mean)
bayes.c.eff.lower3 <- apply(int.3, 2, function(x) quantile(x, probs = c(0.025)))
bayes.c.eff.upper3 <- apply(int.3, 2, function(x) quantile(x, probs = c(0.975)))

bayes.c.eff.mean4 <- apply(int.4, 2, mean)
bayes.c.eff.lower4 <- apply(int.4, 2, function(x) quantile(x, probs = c(0.025)))
bayes.c.eff.upper4 <- apply(int.4, 2, function(x) quantile(x, probs = c(0.975)))

# summarise all the data -> this is ugly but it does the job
library(DMwR)

plot.dat1 <- data.frame(T.sim, Tmax = as.numeric(unscale(vals = T.sim, norm.data = T.scaled)), mean = bayes.c.eff.mean1, Ci.low = bayes.c.eff.lower1, Ci.high = bayes.c.eff.upper1, struct.cohort = 1)

plot.dat2 <- data.frame(T.sim,Tmax = as.numeric(unscale(vals = T.sim, norm.data = T.scaled)), mean = bayes.c.eff.mean2, Ci.low = bayes.c.eff.lower2, Ci.high = bayes.c.eff.upper2,struct.cohort = 2)
plot.dat3<- data.frame(T.sim, Tmax = as.numeric(unscale(vals = T.sim, norm.data = T.scaled)),mean = bayes.c.eff.mean3, Ci.low = bayes.c.eff.lower3, Ci.high = bayes.c.eff.upper3, struct.cohort=3)
plot.dat4 <- data.frame(T.sim, Tmax = as.numeric(unscale(vals = T.sim, norm.data = T.scaled)),mean = bayes.c.eff.mean4, Ci.low = bayes.c.eff.lower4, Ci.high = bayes.c.eff.upper4, struct.cohort = 4) 

plot.dat <- rbind(plot.dat1, plot.dat2, plot.dat3, plot.dat4)
plot.dat$struct.cohort <- as.factor(plot.dat$struct.cohort)

## Foundation for the plot & line for the posterior mean of the Bayesian conditional effect
p <- ggplot(plot.dat, aes(x = Tmax, y = mean, color = struct.cohort)) + geom_line( alpha = 0.8, size = 0.5)+ geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = struct.cohort),  alpha = 0.2)

## Lines for the lower and upper bound of the Bayesian conditional effect
p <- p + geom_line(aes(x = Tmax, y = Ci.low, color = struct.cohort),  alpha = 0.8, size = 0.5) + geom_line(aes(x = Tmax, y = Ci.high, color = struct.cohort),  alpha = 0.8, size = 0.5)

p+ facet_wrap(~struct.cohort)

# 
# plot the conditional effect of Temperature across MAP:
MAP.sim <- seq(min(train.dry.pair$MAP.scaled), max(train.dry.pair$MAP.scaled), by = 0.1)

## Calculate conditional effect of X1 across the range of X2
#int.mcmc <- as.mcmc(samp.structure.cohort.re[[1]])

int.mcmc.mat <- as.matrix(int.mcmc)
int.mcmc.dat <- data.frame(int.mcmc.mat)

int.1 <- matrix(rep(NA, nrow(int.mcmc.dat)*length(MAP.sim)), nrow = nrow(int.mcmc.dat))
int.2 <- matrix(rep(NA, nrow(int.mcmc.dat)*length(MAP.sim)), nrow = nrow(int.mcmc.dat))
int.3 <- matrix(rep(NA, nrow(int.mcmc.dat)*length(MAP.sim)), nrow = nrow(int.mcmc.dat))
int.4 <- matrix(rep(NA, nrow(int.mcmc.dat)*length(MAP.sim)), nrow = nrow(int.mcmc.dat))

# simulate the effect of beta 1 conditional on Tmax
for(i in 1:length(MAP.sim)){
  int.1[, i] <- int.mcmc.dat$beta6.1. + int.mcmc.dat$beta7.1. * MAP.sim[i]
  int.2[, i] <- int.mcmc.dat$beta6.2. + int.mcmc.dat$beta7.2. * MAP.sim[i]
  int.3[, i] <- int.mcmc.dat$beta6.3. + int.mcmc.dat$beta7.3. * MAP.sim[i]
  int.4[, i] <- int.mcmc.dat$beta6.4. + int.mcmc.dat$beta7.4. * MAP.sim[i]

}

## Note: the variance now comes from the posterior, not the vcov matrix

bayes.c.eff.mean1 <- apply(int.1, 2, mean)
bayes.c.eff.lower1 <- apply(int.1, 2, function(x) quantile(x, probs = c(0.025)))
bayes.c.eff.upper1 <- apply(int.1, 2, function(x) quantile(x, probs = c(0.975)))

bayes.c.eff.mean2 <- apply(int.2, 2, mean)
bayes.c.eff.lower2 <- apply(int.2, 2, function(x) quantile(x, probs = c(0.025)))
bayes.c.eff.upper2 <- apply(int.2, 2, function(x) quantile(x, probs = c(0.975)))

bayes.c.eff.mean3 <- apply(int.3, 2, mean)
bayes.c.eff.lower3 <- apply(int.3, 2, function(x) quantile(x, probs = c(0.025)))
bayes.c.eff.upper3 <- apply(int.3, 2, function(x) quantile(x, probs = c(0.975)))

bayes.c.eff.mean4 <- apply(int.4, 2, mean)
bayes.c.eff.lower4 <- apply(int.4, 2, function(x) quantile(x, probs = c(0.025)))
bayes.c.eff.upper4 <- apply(int.4, 2, function(x) quantile(x, probs = c(0.975)))


# summarise all the data -> this is ugly but it does the job
library(DMwR)

plot.dat1 <- data.frame(MAP.sim,MAP = as.numeric(unscale(vals = MAP.sim, norm.data = MAP.scaled)) , mean = bayes.c.eff.mean1, Ci.low = bayes.c.eff.lower1, Ci.high = bayes.c.eff.upper1, cohort = "Past-Forest", structure = "Forest")

plot.dat2 <- data.frame(MAP.sim, MAP = as.numeric(unscale(vals = MAP.sim, norm.data = MAP.scaled)), mean = bayes.c.eff.mean2, Ci.low = bayes.c.eff.lower2, Ci.high = bayes.c.eff.upper2, cohort = "Modern-Forest", structure = "Forest")

plot.dat3 <- data.frame(MAP.sim, MAP = as.numeric(unscale(vals = MAP.sim, norm.data = MAP.scaled)) , mean = bayes.c.eff.mean3, Ci.low = bayes.c.eff.lower3, Ci.high = bayes.c.eff.upper3, cohort = "Past-Savanna", structure = "Savanna")

plot.dat4 <- data.frame(MAP.sim, MAP = as.numeric(unscale(vals = MAP.sim, norm.data = MAP.scaled)), mean = bayes.c.eff.mean4, Ci.low = bayes.c.eff.lower4, Ci.high = bayes.c.eff.upper4, cohort = "Modern-Savanna", structure = "Savanna")


plot.dat.MAP <- rbind(plot.dat1, plot.dat2, plot.dat3, plot.dat4)
plot.dat.MAP$cohort <- as.factor(plot.dat.MAP$cohort)

## Foundation for the plot & line for the posterior mean of the Bayesian conditional effect
MAP.conditional <- ggplot(plot.dat.MAP, aes(x = MAP, y = mean, color = cohort)) + geom_line( alpha = 0.8, size = 0.5)+ geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort),  alpha = 0.2, linetype = "blank") + ylab("Condtional effect of Tmax")+xlab("Precipitation (mm)")+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme_bw(base_size = 18)+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+facet_wrap(~structure, nrow = 2)

MAP.conditional

png(height = 4, width = 6,  units = "in", res = 300,  "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/interaction_plot_Tmax_cond_on_MAP.png")
MAP.conditional
dev.off()



# --------------------make plots of probed predicted growth responses:
# plot probed values of tree growth predictions:
Yprobe <- data.frame(Yprobe.samps[[1]])
colnames(Yprobe) <- 1:length(Yprobe)
probe.m <- melt(Yprobe)
probe.m$RWI <- exp(probe.m$value) 
colnames(probe.m) <- c("num", "Ypred", "RWI")

probe <- short.probe
probe$num <- 1:length(probe[,1])
colnames(probe) <- c("struct.cohort","site","Drought", "DBH","Tmax", "RWI_1","RWI_2", "num")

# summarize by structure + cohort class only:
# summarize by structure + cohort class only:
probe$num <- as.factor(as.character(probe$num))
full.p <- probe

probtest.dry.pair <- dplyr::inner_join(probe.m, full.p, by=c("num"))

prob <- probtest.dry.pair
# save here:
saveRDS(prob, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_yprobe_preds.rds")
prob <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_yprobe_preds.rds")




# convert prob$Drought back to MAP:
library(DMwR)
DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)

prob$DBH <- as.numeric(round(unscale(vals = prob$DBH, norm.data = DBH.scaled))) 
prob$MAP <- as.numeric(round(unscale(vals = prob$Drought, norm.data = MAP.scaled)))
prob$Tmax <- as.numeric(round(unscale(vals = prob$Tmax, norm.data = T.scaled))) 


prob_10_60cm_avg <- prob %>% dplyr::filter(DBH == 27 | DBH == 39 | DBH == 63 ,  RWI_1 == 0.391, RWI_2 == 0.016 ) 

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
 prob_10_60cm_avg <- merge(prob_10_60cm_avg,struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10 <- prob_10_60cm_avg %>% group_by(DBH, Drought, MAP,Tmax, struct.cohort, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

preds_ci_10_age <- prob_10_60cm_avg %>% group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with LOWER than average tree growth the years before:

prob_10_60cm_low <- prob %>% dplyr::filter(DBH == 27 | DBH == 39 | DBH == 63 ,  RWI_1 == -1.609, RWI_2 == -1.484 ) 

 
 prob_10_60cm_low <- merge(prob_10_60cm_low, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10_low <- prob_10_60cm_low %>% group_by(DBH, Drought,MAP, Tmax, struct.cohort, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))


preds_ci_10_low_age <- prob_10_60cm_low %>% group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with HIGHER than average tree growth the years before:

prob_10_60cm_high <- prob %>% dplyr::filter(DBH == 27 | DBH == 39 | DBH == 63 , RWI_1 == 1.891, RWI_2 == 1.516  ) 


 prob_10_60cm_high <- merge(prob_10_60cm_high, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10_high <- prob_10_60cm_high %>% group_by(DBH, Drought,MAP, Tmax, struct.cohort, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

preds_ci_10_high_age <- prob_10_60cm_high %>% group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

#----------- plot drought response by max temperature and Dimaeter + cohort-struct class -----------

Drought.resp.DBH.temp.avgpyr <- ggplot(preds_ci_10, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()



Drought.resp.DBH.temp.lowpyr <- ggplot(preds_ci_10_low, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


Drought.resp.DBH.temp.highpyr <- ggplot(preds_ci_10_high, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


# output the above plots to PNG:
png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_low_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.lowpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_avg_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.avgpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_high_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.highpyr 
dev.off()


#----------- plot drought response by max temperature and Dimaeter + AGECLASS -----------

Drought.resp.DBH.temp.avgpyr.age <- ggplot(preds_ci_10_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()




Drought.resp.DBH.temp.lowpyr.age <- ggplot(preds_ci_10_low_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_10_low_age,aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


Drought.resp.DBH.temp.highpyr.age <- ggplot(preds_ci_10_high_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


# output the above plots to PNG:
png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_low_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.lowpyr.age 
dev.off()

png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_avg_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.avgpyr.age+theme_bw(base_size = 14)
dev.off()

png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_high_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.highpyr.age 
dev.off()





#--------------- plot marginal effects of climate and previous years growth ----------------

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

 prob <- left_join(prob, struc.conversion, by  = "struct.cohort")

 # Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, ageclass) %>% summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()


legend <- get_legend(Y_MAP_marg)

png(height = 10, width = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_post_predictive_effects_ageclass.png")
plts <- plot_grid(Y_MAP_marg+theme(legend.position = "none"), Y_Tmax_marg+theme(legend.position = "none"), Y_DBH_marg+theme(legend.position = "none"), Y_RWI_1_marg+theme(legend.position = "none"), Y_RWI_2_marg+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()

# --------------plot marginal effects for each stand structure and cohort class:
# plot marginal effects of climate and previous years growth 
# Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg_c <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_MAP, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Total Precipitation")


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg_c <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Max. Temperature (DegF)")

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg_c <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Tree DBH (cm)")

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg_c <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-1) year's growth)")

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg_c <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-2) year's growth)")

png(height = 10, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_post_predictive_effects_ageclassXStruct.png")
legend <- get_legend(Y_MAP_marg_c)
plts <- plot_grid(Y_MAP_marg_c+theme(legend.position = "none"), Y_Tmax_marg_c+theme(legend.position = "none"), Y_DBH_marg_c+theme(legend.position = "none"), Y_RWI_1_marg_c+theme(legend.position = "none"), Y_RWI_2_marg_c+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.45))
dev.off()


# ------------- plot the marginal effects of each model parameter by site: ---------------

preds_ci_mod_past_MAP_site <- prob %>% group_by( MAP, ageclass, site) %>% summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg_site <- ggplot(preds_ci_mod_past_MAP_site, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP_site,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)

# marginal TMAX effect
preds_ci_mod_past_Tmax_site <- prob %>% group_by( Tmax,ageclass, site) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg_site <- ggplot(preds_ci_mod_past_Tmax_site, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax_site, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()+facet_wrap(~site)

# marginal DBH effect
preds_ci_mod_past_DBH_site <- prob %>% group_by( DBH,ageclass, site) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg_site <- ggplot(preds_ci_mod_past_DBH_site, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH_site, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()+facet_wrap(~site)

# marginal lag-1 effect
preds_ci_mod_past_RWI1_site <- prob %>% group_by( RWI_1,ageclass, site) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg_site <- ggplot(preds_ci_mod_past_RWI1_site, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1_site, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)

# marginal lag-2 effect
preds_ci_mod_past_RWI2_site <- prob %>% group_by( RWI_2, ageclass, site) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg_site <- ggplot(preds_ci_mod_past_RWI2_site, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2_site, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)


legend <- get_legend(Y_MAP_marg_site)

png(height = 25, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_post_predictive_effects_ageclass_by_site.png")
plts <- plot_grid(Y_MAP_marg_site+theme(legend.position = "none"), Y_Tmax_marg_site+theme(legend.position = "none"), Y_DBH_marg_site+theme(legend.position = "none"), Y_RWI_1_marg_site+theme(legend.position = "none"), Y_RWI_2_marg_site+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()


# below is some extra code



# ----------------------- Plot future predictions ------------------------
fut <- long.fut
# scenario # 1: no change from modern
Yfut.samps <- data.frame(Y.fut[[1]])

colnames(Yfut.samps) <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.samps$num <- 1:length(Yfut.samps[,2])
fut.m <- melt(Yfut.samps)
fut.m$RWI <- exp(fut.m$value)
colnames(fut.m) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "constant"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort","model",  "year", "site.num","site_year", "scenario")

# summarize by structure + cohort class only:

fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))


# scenario # 2: 35% decrease in drought sensitivie from modern
Yfut.35.samps <- data.frame(Y.fut.35[[1]])

colnames(Yfut.35.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.35.samps$num <- 1:length(Yfut.35.samps[,2])
fut.35.m <- melt(Yfut.35.samps)
fut.35.m $RWI <- exp(fut.35.m $value)
colnames(fut.35.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_35"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.35.proj <- dplyr::inner_join(fut.35.m, fut, by=c("site_year"))


# scenario # 3: 50% decrease in drought sensitivie from modern
Yfut.50.samps <- data.frame(Y.fut.50[[1]])

colnames(Yfut.50.samps) <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.50.samps$num <- 1:length(Yfut.50.samps[,2])
fut.50.m <- melt(Yfut.50.samps)
fut.50.m $RWI <- exp(fut.50.m $value)
colnames(fut.50.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_50"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.50.proj <- dplyr::inner_join(fut.50.m, fut, by=c("site_year"))

# scenario # 4: 50% decrease in drought sensitivy from modern & 50% increase in T sensitivity
Yfut.35.35.samps <- data.frame(Y.fut.35.35[[1]])

colnames(Yfut.35.35.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.35.35.samps$num <- 1:length(Yfut.35.35.samps[,2])
fut.35.35.m <- melt(Yfut.35.35.samps)
fut.35.35.m $RWI <- exp(fut.35.35.m $value)
colnames(fut.35.35.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_35.35"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.35.35.proj <- dplyr::inner_join(fut.35.35.m, fut, by=c("site_year"))



# scenario # 5: 50% decrease in drought sensitivy from modern & 50% increase in T sensitivity
Yfut.50.50.samps <- data.frame(Y.fut.50.50[[1]])

colnames(Yfut.50.50.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
Yfut.50.50.samps$num <- 1:length(Yfut.50.50.samps[,2])
fut.50.50.m <- melt(Yfut.50.50.samps)
fut.50.50.m $RWI <- exp(fut.50.50.m $value)
colnames(fut.50.50.m ) <- c("site_year", "Ypred", "RWI")

fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
fut$scenario <- "decrease_50.50"
colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")

fut.50.50.proj <- dplyr::inner_join(fut.50.50.m, fut, by=c("site_year"))


# now join all together :
all.proj <- rbind(fut.proj, fut.35.proj[!fut.35.proj$year == 2000,], fut.50.proj[!fut.50.proj$year == 2000,], fut.35.35.proj[!fut.35.35.proj$year == 2000,], fut.50.50.proj[!fut.50.50.proj$year == 2000,])



# ------------ For 26 cm tree and average prev years growth ----------------------
small.proj <- all.proj[all.proj$DBH == -0.413 & all.proj$RWI_1 == 0.103 & all.proj$RWI_2 == 0.103,]
small.proj$year <- ifelse(small.proj$year == 2050, "2050-2069",
                          ifelse(small.proj$year == 2070, "2070-2099", "2000"))
scenario_names <- c(
                    'constant' = "sensitivity constant",
                    'decrease_35' = "drought (taper 8%)",
                    'decrease_35.35' = "drought & temp. (taper 8%)",
                    'decrease_50.50' = "drought & temp. (no taper 15%)",
                    'decrease_50' = "drought (no taper 15%)"
                    )



# make one big plot for average previous years growth 
by.scenario <- ggplot(small.proj[!small.proj$year == 2000, ], aes(year, RWI, fill = as.character(year)))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000,]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+facet_grid(~ model + scenario)+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c("blue", "red"))+theme(legend.title = element_blank())


png(height = 4, width = 12, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/fut_growth_by_scenarios_26cm_avg_growth.png")
by.scenario+theme(legend.position = "none")
dev.off()


by.period <- ggplot(small.proj[!small.proj$year == 2000 , ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())

png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/fut_growth_by_time_scenarios_26cm_avg_growth.png")
by.period
dev.off()

by.model <- ggplot(small.proj[!small.proj$year == 2000, ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())+facet_grid(rows = vars(scenario), cols = vars(model))



png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/fut_growth_by_model_26cm_avg_growth.png")
by.model
dev.off()

small.proj$model <- factor(small.proj$model, levels = c("INMCM4", "HadGEM-ES2", "MIROC"))
model_names <- c(
                    'INMCM4' = "INMCM4 \n low Tmax - low Precip",
                    'HadGEM-ES2' = "HadGEM-ES2 \n high Tmax - low Precip",
                    'MIROC' = "MIROC \n high Tmax - high Precip"
                    
                    )


model_names <- c("INMCM4 \n low Tmax - low Precip",
                 "HadGEM-ES2 \n high Tmax - low Precip",
                 "MIROC \n high Tmax - high Precip")

by.model.2050 <- ggplot(small.proj[!small.proj$year == 2000 , ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 8%", "taper P & T 8%", "no taper P 15%", "no taper P & T 15%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())+facet_grid(~model)


png(height = 5, width = 9, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/fut_growth_by_model_2050_26cm_avg_growth.png")
by.model.2050
dev.off()

ggplot(small.proj[!small.proj$year == 2000 & !small.proj$year %in% "2070-2099", ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
))+theme(legend.title = element_blank())+facet_grid(rows=vars(model), cols= vars(site))



# ------------------------ Plot posterior response to climate ------------------------------------
# get together a dataframe to probe with:

Tmax.range <- round(seq(range(train.dry.pair$T.scaled)[1], range(train.dry.pair$T.scaled)[2], by = 0.1), 10)

MAP.range <- round(seq(range(train.dry.pair$MAP.scaled)[1], range(train.dry.pair$MAP.scaled)[2], by = 0.1), 10)

prob.vals <- expand.grid(T.scaled = Tmax.range, MAP.scaled = MAP.range, site.num = unique(train.dry.pair$site.num))

prob.vals <- left_join(unique(train.dry.pair[,c("struct.cohort.code", "site", "site.num", "ageclass", "structure")]), prob.vals, by = "site.num")

prob.vals$DBH.scaled <- mean(train.dry.pair$DBH.scaled)
prob.vals$RWI_1 <- log(mean(train.dry.pair$RWI_1))
prob.vals$RWI_2 <- log(mean(train.dry.pair$RWI_2))

# now lets use the betasamps to predict posterior growth for all these conditions:

#int.mcmc <- as.mcmc(samp.structure.cohort.re[[1]])
int.mcmc <- as.mcmc(samps)
int.mcmc.mat <- as.matrix(int.mcmc)
int.mcmc.dat <- data.frame(int.mcmc.mat)

int.1 <- matrix(rep(NA, nrow(int.mcmc.dat)*length(prob.vals$T.scaled)), nrow = nrow(int.mcmc.dat))

# need to clean this up but this is the basic idea:


# simulate the effect of beta 1 conditional on Tmax
for(i in 1:length(prob.vals$T.scaled)){
  # for struct.cohort == 1
  int.1[,i] <- int.mcmc.dat[,paste0("beta1.", prob.vals[i,"site.num"], ".")]+
    int.mcmc.dat[,paste0("beta2.", prob.vals[i,"struct.cohort.code"], ".")]*prob.vals[i,]$MAP.scaled+    
    int.mcmc.dat[,paste0("beta3.", prob.vals[i,"struct.cohort.code"], ".")]*prob.vals[i,"DBH.scaled"] + 
    int.mcmc.dat[,paste0("beta4.", prob.vals[i,"struct.cohort.code"], ".")]*prob.vals[i,"RWI_1"]  + 
    int.mcmc.dat[,paste0("beta5.", prob.vals[i,"struct.cohort.code"], ".")]*prob.vals[i,"RWI_2"] +
    int.mcmc.dat[,paste0("beta6.", prob.vals[i,"struct.cohort.code"], ".")]*prob.vals[i,"T.scaled"] + 
   int.mcmc.dat[,paste0("beta7.", prob.vals[i,"struct.cohort.code"], ".")] * (prob.vals[i,"MAP.scaled"] *prob.vals[i,"T.scaled"])
  
  
}


# columns are the different degree-site scenario combinations
prob.vals$idval <- 1:length(prob.vals$T.scaled)
# rows are the mcmc values
colnames(int.1) <- 1:length(prob.vals$T.scaled)
test.m <- melt(int.1)
colnames(test.m) <- c("MCMC", "idval", "Ypred")
full.pred <- left_join(test.m, prob.vals, by = "idval")
full.pred$RWI <- exp(full.pred$Ypred)
full.pred$Tmax <-  round(DMwR::unscale(full.pred$T.scaled, T.scaled), digits = 3)
full.pred$MAP <-  round(DMwR::unscale(full.pred$MAP.scaled, MAP.scaled), digits = 3)

site.summary <- full.pred %>% group_by(site.num, Tmax, MAP, struct.cohort.code) %>% dplyr::summarise(mean = mean(exp(RWI)), Ci.low = quantile(exp(Ypred), 0.025),  Ci.high = quantile(exp(Ypred), 0.975))

ggplot(site.summary[site.summary$MAP == 499.649,], aes(x = Tmax, y =mean, color = site.num))+geom_bar(stat = "identity", position = "dodge")+facet_wrap(~struct.cohort.code)



ageclass.summary <- full.pred %>% group_by(site, ageclass, Tmax, MAP) %>% dplyr::summarise(mean = mean(RWI), Ci.low = quantile(exp(Ypred), 0.025),  Ci.high = quantile(exp(Ypred), 0.975))


ggplot(ageclass.summary[ageclass.summary$MAP == 259.338,], aes(x = Tmax, y =mean, color = ageclass))+geom_line()+geom_ribbon(data = ageclass.summary[ageclass.summary$MAP == 259.338,], aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+facet_wrap(~site)


ggplot(ageclass.summary[ageclass.summary$MAP == 516.814,], aes(x = Tmax, y =mean, color = ageclass))+geom_line()+geom_ribbon(data = ageclass.summary[ageclass.summary$MAP == 516.814,], aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+facet_wrap(~site)


ggplot(ageclass.summary[ageclass.summary$MAP == 945.942,], aes(x = Tmax, y =mean, color = ageclass))+geom_line()+geom_ribbon(data = ageclass.summary[ageclass.summary$MAP == 945.942,], aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+facet_wrap(~site)


ggplot(ageclass.summary[ageclass.summary$Tmax == 26.799,], aes(x = MAP, y =mean, color = ageclass))+geom_line()+geom_ribbon(data = ageclass.summary[ageclass.summary$Tmax == 26.799,], aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+facet_wrap(~site)


ageclass.only <- full.pred %>% group_by( ageclass, Tmax, MAP) %>% dplyr::summarise(mean = mean(RWI), Ci.low = quantile(exp(Ypred), 0.025),  Ci.high = quantile(exp(Ypred), 0.975))


ggplot(ageclass.only[ageclass.only$MAP == 259.338,], aes(x = Tmax, y =mean, color = ageclass))+geom_line()+geom_ribbon(data = ageclass.only[ageclass.only$MAP == 259.338,], aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)


ggplot(ageclass.only[ageclass.only$MAP == 516.814,], aes(x = Tmax, y =mean, color = ageclass))+geom_line()+geom_ribbon(data = ageclass.only[ageclass.only$MAP == 516.814,], aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)


ggplot(ageclass.only[ageclass.only$MAP == 945.942,], aes(x = Tmax, y =mean, color = ageclass))+geom_line()+geom_ribbon(data = ageclass.only[ageclass.only$MAP == 945.942,], aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)


ggplot(ageclass.only[ageclass.only$Tmax == 26.799,], aes(x = MAP, y =mean, color = ageclass))+geom_line()+geom_ribbon(data = ageclass.only[ageclass.only$Tmax == 26.799,], aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)

# now by ageclass and stand structure:

ageclass.ss.only <- full.pred %>% group_by(structure, ageclass, Tmax, MAP) %>% dplyr::summarise(mean = mean(RWI), Ci.low = quantile(exp(Ypred), 0.025),  Ci.high = quantile(exp(Ypred), 0.975))


ag.ss.pred.200MAP <- ggplot(ageclass.ss.only[ageclass.ss.only$MAP == 259.338,], aes(x = Tmax, y =mean, color = ageclass))+geom_point(size = 0.5)+geom_line()+geom_ribbon(data = ageclass.ss.only[ageclass.ss.only$MAP == 259.338,], aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+facet_wrap(~structure, ncol = 1)+theme_bw()+theme(panel.grid = element_blank())+ylab("Predicted Tree growth (mm)")+xlab(expression("June Mean Maximum Temperature (" * degree * "C)"))+xlim(20,40)+scale_fill_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b")) +scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))


ag.ss.pred.500MAP <- ggplot(ageclass.ss.only[ageclass.ss.only$MAP == 516.814,], aes(x = Tmax, y =mean, color = ageclass))+geom_line()+geom_ribbon(data = ageclass.ss.only[ageclass.ss.only$MAP == 516.814,], aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+facet_wrap(~structure, ncol = 1)+theme_bw()+theme(panel.grid = element_blank())+ylab("Predicted Tree growth (mm)")+xlab(expression("June Mean Maximum Temperature (" * degree * "C)"))+xlim(20,40)+scale_fill_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b")) +scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))


ag.ss.pred.950MAP <- ggplot(ageclass.ss.only[ageclass.ss.only$MAP == 945.942,], aes(x = Tmax, y =mean, color = ageclass))+geom_line()+geom_ribbon(data = ageclass.ss.only[ageclass.ss.only$MAP == 945.942,], aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+facet_wrap(~structure, ncol = 1)+theme_bw()+theme(panel.grid = element_blank())+ylab("Predicted Tree growth (mm)")+xlab(expression("June Mean Maximum Temperature (" * degree * "C)"))+xlim(20,40)+scale_fill_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b")) +scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))


ag.ss.pred.25.TMAX <- ggplot(ageclass.ss.only[ageclass.ss.only$Tmax == 25.383,], aes(x = MAP, y =mean, color = ageclass))+geom_line()+geom_ribbon(data = ageclass.ss.only[ageclass.ss.only$Tmax == 25.383,], aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+facet_wrap(~structure, ncol = 1)+theme_bw()+theme(panel.grid = element_blank())+ylab("Predicted Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+scale_fill_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b")) +scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+facet_wrap(~structure, ncol = 1)

#------------- get pct change for 25.383 TMAX:
full.pred.df <- data.frame(full.pred)
full.pred.df$Tmax <- as.numeric(full.pred.df$Tmax)
full.pred.df$MAP <- as.numeric(full.pred.df$MAP)
Tmax25 <- full.pred.df %>% filter(Tmax == 25.383) %>% select(MCMC, idval, RWI,site, site.num, ageclass, structure, MAP) 

Tmax25.mod.forest <- Tmax25  %>% filter(ageclass %in% "Modern" & structure %in% "Forest") %>%select(MCMC, idval, RWI,site,MAP)
Tmax25.past.forest <- Tmax25  %>% filter(ageclass %in% "Past" & structure %in% "Forest")%>%select(MCMC, idval, RWI,site,MAP)
Tmax25.mod.savanna <- Tmax25  %>% filter(ageclass %in% "Modern" & structure %in% "Savanna")%>%select(MCMC, idval, RWI,site,MAP)
Tmax25.past.savanna <- Tmax25  %>% filter(ageclass %in% "Past" & structure %in% "Savanna")%>%select(MCMC, idval, RWI,site,MAP)

colnames(Tmax25.mod.forest)[3] <- "Modern_Forest"
colnames(Tmax25.past.forest)[3] <- "Past_Forest"
colnames(Tmax25.mod.savanna)[3] <- "Modern_Savanna"
colnames(Tmax25.past.savanna)[3] <- "Past_Savanna"

test.join.forest <- left_join(Tmax25.mod.forest, Tmax25.past.forest, by = c("MCMC", "site", "MAP"))
test.join.forest$growth.change <- test.join.forest$Modern_Forest - test.join.forest$Past_Forest 
test.join.forest$growth.pct.change <- ((test.join.forest$Modern_Forest - test.join.forest$Past_Forest)/ test.join.forest$Past_Forest)*100
test.join.forest$structure <- "Forest"

test.join.savanna <- left_join(Tmax25.mod.savanna, Tmax25.past.savanna, by = c("MCMC", "site", "MAP"))
test.join.savanna$growth.change <- test.join.savanna$Modern_Savanna - test.join.savanna$Past_Savanna 
test.join.savanna$growth.pct.change <- ((test.join.savanna$Modern_Savanna - test.join.savanna$Past_Savanna)/ test.join.savanna$Past_Savanna)*100
test.join.savanna$structure <- "Savanna"

pct.change.tmax25 <- rbind(test.join.forest[,c("site","structure", "MAP", "growth.change", "growth.pct.change")], test.join.savanna[,c("site","structure", "MAP", "growth.change", "growth.pct.change")])

tmax25.change.summary <- pct.change.tmax25 %>% group_by(structure, MAP) %>% dplyr::summarise(mean.change = mean(growth.change),
                                                                    Ci.high.change = quantile(growth.change, 0.975), 
                                                                    Ci.low.change = quantile(growth.change, 0.025), 
                                                                    mean.pct.change = mean(growth.pct.change),
                                                                    Ci.high.pct.change = quantile(growth.pct.change, 0.975), 
                                                                    Ci.low.pct.change = quantile(growth.pct.change, 0.025))



Tmax.summary.pct.change <- ggplot(tmax25.change.summary, aes(x = MAP, y = mean.pct.change, color = structure))+geom_line()+geom_ribbon(data = tmax25.change.summary, aes(x = MAP, ymin = Ci.low.pct.change, ymax = Ci.high.pct.change, fill = structure), alpha = 0.25, colour = NA)+theme_bw()+theme(panel.grid = element_blank())+ylab("% change in growth \n relative to past cohort")+xlab("Total Annual Precipitation (mm)")+geom_hline(yintercept = 0, color = "darkgrey", linetype = "dashed")+scale_color_manual(values = c("Savanna"='#a6611a',"Forest"='#018571'))+scale_fill_manual(values = c("Savanna"='#a6611a',"Forest"='#018571'))


Tmax.summary.total.change <- ggplot(tmax25.change.summary, aes(x = MAP, y = mean.change, color = structure))+geom_line()+geom_ribbon(data = tmax25.change.summary, aes(x = MAP, ymin = Ci.low.change, ymax = Ci.high.change, fill = structure), alpha = 0.25, colour = NA)+theme_bw()+theme(panel.grid = element_blank())+ylab("Average change in growth \n relative to past cohort (mm)")+xlab("Total Annual Precipitation (mm)")+geom_hline(yintercept = 0, color = "darkgrey", linetype = "dashed")+scale_color_manual(values = c("Savanna"='#a6611a',"Forest"='#018571'))+scale_fill_manual(values = c("Savanna"='#a6611a',"Forest"='#018571'))

struct.legend <- get_legend(Tmax.summary.total.change)

png(height = 3, width = 7, units = "in" ,res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/Precipitation_difference_pce_diff_TMAX_25_mean_dbh_growth.png")
plot_grid(Tmax.summary.total.change + theme(legend.position = "none"), Tmax.summary.pct.change+ theme(legend.position = "none"), struct.legend, ncol = 3, rel_widths = c(1,1, 0.3), labels = c("A", "B", ""))
dev.off()



png(height = 4, width = 3, units = "in" ,res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/Precipitation_effect_TMAX_25_mean_dbh_growth.png")
ag.ss.pred.25.TMAX 
dev.off()


# make a plot of modern only responses for high and low precipitaiton only:
modern.hi.low <- ageclass.ss.only %>% filter(MAP == 945.942 & ageclass %in% "Modern" | MAP == 516.814 & ageclass %in% "Modern")
modern.hi.low$MAP_scenario <- ifelse(modern.hi.low$MAP >= 900, "950 mm", "515 mm")

ag.ss.pred.MAP.modonly <- ggplot(modern.hi.low, aes(x = Tmax, y =mean, color = MAP_scenario))+geom_line()+geom_ribbon(data = modern.hi.low, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = MAP_scenario), alpha = 0.25, colour = NA)+facet_wrap(~structure, ncol = 1)+theme_bw()+theme(panel.grid = element_blank())+ylab("Predicted Tree growth (mm)")+xlab(expression("June Mean Maximum Temperature (" * degree * "C)"))+xlim(20,40)+scale_fill_manual(values = c("950 mm"='#008837', '515 mm' = "#7b3294"), name = "Precipitation")+scale_color_manual(values = c("950 mm"='#008837', '515 mm' = "#7b3294"), name = "Precipitation")+theme()


# read in future climate for the region:
June.rcps <- read.csv("outputs/June_summer_cmip5_preds_allyears_2025_2099.csv")
precip.means <- read.csv("outputs/CCESM_rcp8.5_mean_Pr_TMAX_proj_sites.csv")


unique.clim <- unique(train.dry.pair[, c("site", "year", "JUNTmax", "ageclass")])


Jun.rcps.clim.full <- June.rcps[,c("year", "value", "fut.class", "rcp", "site")]

# subset by sites analyzed here:
Jun.rcps.clim <- Jun.rcps.clim.full %>% filter(site %in% unique(unique.clim$site))


unique.clim$fut.class <- ifelse(unique.clim$year <= 1950, "1895-1950", "1950-2015")
unique.clim2 <- unique.clim[,c("year", "JUNTmax", "fut.class", "ageclass", "site")]
colnames(unique.clim2) <- c("year", "value", "fut.class", "rcp",  "site")

clim.full <- rbind(unique.clim2, Jun.rcps.clim)

reclass <- data.frame(class = c(1.5,2.5, 4,4.5,5,5.5, 8,8.5, 9, 9.5), 
           fut.class = c("1895-1950", "1950-2015", "2025-2060","2025-2060","2025-2060","2025-2060",
                         "2060-2099","2060-2099","2060-2099","2060-2099" ),
          rcp = c("Past", "Modern", "rcp2.6", "rcp4.5", "rcp6.0", "rcp8.5", "rcp2.6", "rcp4.5", "rcp6.0", "rcp8.5"))

clim.full2 <- merge( reclass,clim.full, by = c("fut.class", "rcp"))

ggplot(clim.full, aes(x = fut.class, y = value, fill = rcp))+geom_boxplot(width = 0.5, outlier.size = 0.05)+coord_flip()+xlab("Time Period")+ylab(expression("June Mean Maximum Temperature (" * degree * "C)"))


ggplot(clim.full, aes(value, fill = rcp))+geom_histogram()+facet_wrap(~fut.class)

Future.Tmax.summaries <- clim.full %>% group_by(fut.class, rcp) %>% dplyr::summarise(meanTmax = mean(value, na.rm=TRUE),
                                                            sd = sd(value, na.rm=TRUE),
                                                            Tmax.ci.low = quantile(value, 0.025, na.rm=TRUE),
                                                            Tmax.ci.high = quantile(value, 0.975, na.rm=TRUE))

# save summary table to output in the tables script
saveRDS(Future.Tmax.summaries, "/Users/kah/Documents/TreeRings/outputs/data/Tmax_future_climate.rds")

boxplot.tmax <- ggplot(clim.full2, aes(x = class, y = value, fill = rcp, group = class))+geom_boxplot(width = 0.5, outlier.size = 0.05)+coord_flip()+xlab("Time Period")+ylab(expression("June Mean Maximum Temperature (" * degree * "C)"))+ scale_x_continuous(name = "Time Period", breaks = c(1.5, 2.5, 4.5, 8.5 ), minor_breaks = NULL,labels = sort(unique(clim.full2$fut.class)))+theme_bw()+theme(legend.title = element_blank(), panel.grid = element_blank(), axis.title.y  = element_blank()) +scale_fill_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b", "rcp2.6" = "#ffffb2", "rcp4.5" = "#984ea3", "rcp6.0" = "#e0f3f8", "rcp8.5" ="#fc8d59" ))+ylim(20,40)

png(height = 8, width = 4, units = "in", res = 200, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/predicted_treegrowth_Tmax_marginal_fut_climate_boxes.png")
plot_grid(ag.ss.pred.500MAP, ag.ss.pred.950MAP, boxplot.tmax, ncol=1, align = "hv", rel_heights = c(1,1,0.75), labels = "AUTO")
dev.off()



png(height = 6, width = 5, units = "in", res = 200, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/predicted_treegrowth_Tmax_modern_only_marginal_fut_climate_boxes.png")
plot_grid( boxplot.tmax, ag.ss.pred.MAP.modonly,ncol=1, align = "hv", rel_heights = c(1,0.75), labels = "AUTO") 
dev.off()


# ---------make the same plots, but with % change in tree growth given MAP and Tmax:
# Make plots of average percent change in grwoth from regional average growth due to tempearut:
# 1. get range of modern Tmax:
# 2. Find mean growth response for each site at mean Tmax overall 26.34, with all else constant
# 3. generate PP response to range of temperatures 21.94 to 31.94
# 4. Calculate % change between mean growth and 

mod.mean.clim <-
  test.dry.pair %>% filter(ageclass %in% "Modern" & year > 1950) %>%
  #group_by(site) %>%
  dplyr::summarize(
  mod.mean.Tmax = mean(JUNTmax, na.rm = TRUE),
  one = mean(JUNTmax, na.rm = TRUE) + 1,
  two = mean(JUNTmax, na.rm = TRUE) + 2,
  three = mean(JUNTmax, na.rm = TRUE) + 3,
  four = mean(JUNTmax, na.rm = TRUE) + 4,
  five = mean(JUNTmax, na.rm = TRUE) + 5,
  minusone = mean(JUNTmax, na.rm = TRUE) - 1,
  minustwo =  mean(JUNTmax, na.rm = TRUE) - 2,
  minusthree =  mean(JUNTmax, na.rm = TRUE) - 3,
  minusfour = mean(JUNTmax, na.rm = TRUE) - 4,
  minusfive =  mean(JUNTmax, na.rm = TRUE) - 5,
  
  mod.mean.MAP = mean(MAP.prism, na.rm = TRUE),
  MAPminus100 = mean(MAP.prism, na.rm = TRUE) -
  100,
  MAPminus50 = mean(MAP.prism, na.rm = TRUE) -
  50,
  MAPplus50 = mean(MAP.prism, na.rm = TRUE) +
  50,
  
  MAP750 = 750,
  
  MAP515 = 516.814,
  MAP850 = 850,
  MAP950 = 945.942,
  MAPplus100 = mean(MAP.prism, na.rm = TRUE) +
  100
  )
  



# get summaries for MAP and Temperature scenarios & join
MAP.scenarios <- mod.mean.clim %>% dplyr::select(mod.mean.MAP:MAPplus100) %>% gather(MAP.Scenario, MAP, mod.mean.MAP:MAPplus100)

temp.scenarios <- mod.mean.clim %>% dplyr::select( mod.mean.Tmax:minusfive)  %>% gather(Temp.Scenario,Tmax, mod.mean.Tmax:minusfive)
site.scenarios <- expand.grid(Temp.Scenario = temp.scenarios$Temp.Scenario, MAP.Scenario = MAP.scenarios$MAP.Scenario, site = as.character(unique(test.dry.pair$site)))
test.MAP.scenarios <- merge(site.scenarios, MAP.scenarios, by = c("MAP.Scenario"))
all.scen <- merge(test.MAP.scenarios, temp.scenarios, by = "Temp.Scenario", all = TRUE)

# get the scaled values for MAP and TMAX to run through parameters
all.scen$MAP.scaled <- as.numeric(scale(all.scen$MAP, attr(MAP.scaled, "scaled:center"), attr(MAP.scaled, "scaled:scale")))

all.scen$T.scaled <- as.numeric(scale(all.scen$Tmax, attr(T.scaled, "scaled:center"), attr(T.scaled, "scaled:scale")))

# expand grid to add structure + cohort class - add 1 diameter, add 1 lag, add 2 lag, then add probe to the model....will need to re-run model
extras <- expand.grid(RWI_1 = 0.103, 
                      RWI_2 = 0.103, 
                      site = unique(all.scen$site), 
                      DBH.scaled = mean(test.dry.pair$DBH.scaled))

sites.unique <- unique(train.dry.pair[, c("site", "struct.cohort.code", "structure", "ageclass")])
extras <- merge(extras, sites.unique[, c("site", "struct.cohort.code")], by = "site")

degree.scenario <- merge(all.scen, extras, by = "site", all = TRUE)
degree.scenario <- merge(degree.scenario, site.num.df, by = "site")

# -------------use estimates of betas to generate estimates for predicted growth:
meanMAP.sim <- degree.scenario %>% filter( MAP.Scenario == "mod.mean.MAP")
meanMAP.sim <- degree.scenario

int.mcmc <- as.mcmc(samps)
int.mcmc.mat <- as.matrix(int.mcmc)
int.mcmc.dat <- data.frame(int.mcmc.mat)

int.1 <- matrix(rep(NA, nrow(int.mcmc.dat)*length(meanMAP.sim$T.scaled)), nrow = nrow(int.mcmc.dat))

# need to clean this up but this is the basic idea:


# use betas to generate pp given a value for site, structure, dbh, rwi1, rwi2, and varying T and MAP:
for(i in 1:length(meanMAP.sim$T.scaled)){
  # for struct.cohort == 1
  int.1[,i] <- int.mcmc.dat[,paste0("beta1.", meanMAP.sim[i,"site.num"], ".")]+
    int.mcmc.dat[,paste0("beta2.", meanMAP.sim[i,"struct.cohort.code"], ".")]*meanMAP.sim[i,]$MAP.scaled+    
    int.mcmc.dat[,paste0("beta3.", meanMAP.sim[i,"struct.cohort.code"], ".")]*meanMAP.sim[i,"DBH.scaled"] + 
    int.mcmc.dat[,paste0("beta4.", meanMAP.sim[i,"struct.cohort.code"], ".")]*meanMAP.sim[i,"RWI_1"]  + 
    int.mcmc.dat[,paste0("beta5.", meanMAP.sim[i,"struct.cohort.code"], ".")]*meanMAP.sim[i,"RWI_2"] +
    int.mcmc.dat[,paste0("beta6.", meanMAP.sim[i,"struct.cohort.code"], ".")]*meanMAP.sim[i,"T.scaled"] + 
    int.mcmc.dat[,paste0("beta7.", meanMAP.sim[i,"struct.cohort.code"], ".")] * (meanMAP.sim[i,"MAP.scaled"] *meanMAP.sim[i,"T.scaled"])
  
  
}


# columns are the different degree-site scenario combinations
meanMAP.sim$idval <- 1:length(meanMAP.sim$Tmax)
# rows are the mcmc values
colnames(int.1) <- 1:length(meanMAP.sim$Tmax)
test.m <- melt(int.1)
colnames(test.m) <- c("MCMC", "idval", "Ypred")
full.pred <- left_join(test.m, meanMAP.sim, by = "idval")
full.pred$RWI <- exp(full.pred$Ypred)



#  create dfs with RWI values for each map and temp scernario:

past.Temp <- full.pred %>% dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC, RWI, Temp.Scenario, Tmax, MAP) %>%
  filter(Temp.Scenario %in% "mod.mean.Tmax") %>% dplyr::rename(zero = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code, MCMC,zero)

one <- full.pred %>% dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario, Tmax, MAP) %>% filter(Temp.Scenario %in% "one" ) %>% dplyr::rename(one = RWI) %>% dplyr::select( -Temp.Scenario)%>% arrange(site, MAP.Scenario, struct.cohort.code, MCMC,one)

two <- full.pred %>%  dplyr::select(site, MAP.Scenario, struct.cohort.code,MCMC, RWI, Temp.Scenario, Tmax, MAP) %>%filter(Temp.Scenario %in% "two" ) %>% dplyr::rename(two = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code,MCMC, two)

three <- full.pred %>% dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario, Tmax, MAP) %>% filter(Temp.Scenario %in% "three" ) %>% dplyr::rename(three = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code,MCMC, three)

four <- full.pred %>%  dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario, Tmax, MAP) %>%filter(Temp.Scenario %in% "four" ) %>% dplyr::rename(four = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code, MCMC,four)

five <-  full.pred %>% dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario, Tmax, MAP) %>% filter(Temp.Scenario %in% "five" ) %>% dplyr::rename(five = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code,MCMC, five)

minusone <-  full.pred %>%  dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario, Tmax, MAP) %>%filter(Temp.Scenario %in% "minusone" ) %>% dplyr::rename(minusone = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code,MCMC, minusone)

minustwo <- full.pred %>% dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario, Tmax, MAP) %>% filter(Temp.Scenario %in% "minustwo" ) %>% dplyr::rename(minustwo = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code,MCMC, minustwo)

minusthree<-  full.pred %>% dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario, Tmax, MAP) %>% filter(Temp.Scenario %in% "minusthree" ) %>% dplyr::rename(minusthree = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code, MCMC, minusthree)

minusfour <- full.pred %>% dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario, Tmax, MAP) %>% filter(Temp.Scenario %in% "minusfour" ) %>% dplyr::rename(minusfour = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code,MCMC, minusfour)

minusfive <-  full.pred %>% dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario, Tmax, MAP) %>% filter(Temp.Scenario %in% "minusfive" ) %>% dplyr::rename(minusfive = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code, MCMC, minusfive)


newdf <- cbind( past.Temp, one[,c("one")], two[,c("two")], three[,c("three")], four[,c("four")], five[, c("five")], minusone[, c("minusone")], minustwo[, c("minustwo")], minusthree[, c("minusthree")], minusfour[, c("minusfour")], minusfive[, c("minusfive")])       
colnames(newdf) <- c("site", "MAP.Scenario", "struct.cohort.code","MCMC", "base","Tmax", "MAP", "one", "two", "three", "four", "five", "minusone", "minustwo", "minusthree", "minusfour", "minusfive")


# get means and CI for each temperature and MAP scenario:

pct.change.temp <- newdf %>% group_by(site, struct.cohort.code, MAP.Scenario, Tmax, MAP)  %>%
  dplyr::summarise(zero = mean(((base-base)/base)*100, na.rm = TRUE),
                   one = mean(((one-base)/base)*100, na.rm = TRUE),
                   two = mean(((two-base)/base)*100, na.rm = TRUE),
                   three = mean(((three-base)/base)*100, na.rm = TRUE),
                   four = mean(((four-base)/base)*100, na.rm = TRUE),
                   five = mean(((five-base)/base)*100, na.rm = TRUE),
                   minusone = mean(((minusone-base)/base)*100, na.rm = TRUE),
                   minustwo = mean(((minustwo-base)/base)*100, na.rm = TRUE),
                   minusthree = mean(((minusthree-base)/base)*100, na.rm = TRUE),
                   minusfour = mean(((minusfour-base)/base)*100, na.rm = TRUE),
                   minusfive = mean(((minusfive-base)/base)*100, na.rm = TRUE)
  ) %>% 
  gather(key = incT, pct_change, zero:minusfive)


pct.change.hi.ci <- newdf %>% group_by(site, struct.cohort.code, MAP.Scenario, Tmax, MAP)  %>%
  dplyr::summarise(zero = quantile(((base-base)/base)*100, 0.975 ,na.rm = TRUE),
                   one = quantile(((one-base)/base)*100, 0.975 ,na.rm = TRUE),
                   two = quantile(((two-base)/base)*100, 0.975 ,na.rm = TRUE),
                   three = quantile(((three-base)/base)*100, 0.975 ,na.rm = TRUE),
                   four = quantile(((four-base)/base)*100,0.975 , na.rm = TRUE),
                   five = quantile(((five-base)/base)*100,0.975 , na.rm = TRUE),
                   minusone = quantile((( minusone-base)/base)*100,0.975 , na.rm = TRUE),
                   minustwo = quantile((( minustwo-base)/base)*100,0.975 , na.rm = TRUE),
                   minusthree = quantile((( minusthree-base)/base)*100,0.975 , na.rm = TRUE),
                   minusfour = quantile((( minusfour-base)/base)*100,0.975 , na.rm = TRUE),
                   minusfive = quantile((( minusfive-base)/base)*100,0.975 , na.rm = TRUE)
  ) %>% 
  gather(key = incT, ci.hi, zero:minusfive)



pct.change.low.ci <- newdf %>% group_by(site, struct.cohort.code, MAP.Scenario, Tmax, MAP)  %>%
  dplyr::summarise(zero = quantile(((base-base)/base)*100, 0.025 ,na.rm = TRUE),
                   one = quantile(((one-base)/base)*100, 0.025 ,na.rm = TRUE),
                   two = quantile(((two-base)/base)*100, 0.025 ,na.rm = TRUE),
                   three = quantile(((three-base)/base)*100, 0.025 ,na.rm = TRUE),
                   four = quantile(((four-base)/base)*100, 0.025 , na.rm = TRUE),
                   five = quantile(((five-base)/base)*100, 0.025 , na.rm = TRUE),
                   minusone = quantile((( minusone-base)/base)*100,0.025 , na.rm = TRUE),
                   minustwo = quantile((( minustwo-base)/base)*100,0.025 , na.rm = TRUE),
                   minusthree = quantile((( minusthree-base)/base)*100,0.025 , na.rm = TRUE),
                   minusfour = quantile((( minusfour-base)/base)*100,0.025 , na.rm = TRUE),
                   minusfive = quantile((( minusfive-base)/base)*100,0.025 , na.rm = TRUE)
  ) %>% 
  gather(key = incT, ci.low, zero:minusfive)



cis <- merge(pct.change.hi.ci, pct.change.low.ci, by = c("site", "incT", "struct.cohort.code", "MAP.Scenario", "Tmax", "MAP", "MCMC") )
pct.change.temp <- merge(pct.change.temp, cis, by = c("site","incT", "struct.cohort.code", "MAP.Scenario", "Tmax", "MAP", "MCMC")) 

pct.change.temp <- merge(pct.change.temp , sites.unique, by = c("site", "struct.cohort.code"))


Tdf <- data.frame(incT = c("minusfive","minusfour", "minusthree", "minustwo", "minusone","zero", "one", "two", "three", "four", "five"), 
                  deltaT = -5:5)

pct.change.temp <- merge(pct.change.temp, Tdf, by = "incT")
pct.change.temp$struct.cohort.code <- as.character(pct.change.temp$struct.cohort.code)

locs.sites <- locs %>% filter(code %in% unique(pct.change.temp$site)) %>% arrange(pr30yr)
pct.change.temp$site <-factor(pct.change.temp$site, levels = c("BON", "GLL1", "GLL2", "GLL3", "ENG", "AVO", "UNC","MOU", "GLA"))

plus100 <- ggplot(pct.change.temp[pct.change.temp$MAP.Scenario %in% "MAPplus100",], aes(deltaT, pct_change, color = ageclass))+geom_point()+geom_line() + geom_ribbon(data = pct.change.temp[pct.change.temp$MAP.Scenario %in% "MAPplus100",], aes(x = deltaT, ymin = ci.low, ymax = ci.hi, fill = ageclass), alpha = 0.25, colour = NA)+facet_wrap(~site, ncol = 9)+geom_hline(yintercept = 0, linetype = "dashed")+ylab("+100mm ANNUAL PRECIPITATION \n % change in growth")+xlab("increase in Tmax (degC)")



# get regional responses:


pct.change.temp.reg <- newdf %>% group_by(struct.cohort.code, MAP.Scenario, Tmax, MAP)  %>%
  dplyr::summarise(zero = mean(((base-base)/base)*100, na.rm = TRUE),
                   one = mean(((one-base)/base)*100, na.rm = TRUE),
                   two = mean(((two-base)/base)*100, na.rm = TRUE),
                   three = mean(((three-base)/base)*100, na.rm = TRUE),
                   four = mean(((four-base)/base)*100, na.rm = TRUE),
                   five = mean(((five-base)/base)*100, na.rm = TRUE),
                   minusone = mean(((minusone-base)/base)*100, na.rm = TRUE),
                   minustwo = mean(((minustwo-base)/base)*100, na.rm = TRUE),
                   minusthree = mean(((minusthree-base)/base)*100, na.rm = TRUE),
                   minusfour = mean(((minusfour-base)/base)*100, na.rm = TRUE),
                   minusfive = mean(((minusfive-base)/base)*100, na.rm = TRUE)
  ) %>% 
  gather(key = incT, pct_change, zero:minusfive)


pct.change.hi.ci.reg <- newdf %>% group_by( struct.cohort.code, MAP.Scenario, Tmax, MAP)  %>%
  dplyr::summarise(zero = quantile(((base-base)/base)*100, 0.975 ,na.rm = TRUE),
                   one = quantile(((one-base)/base)*100, 0.975 ,na.rm = TRUE),
                   two = quantile(((two-base)/base)*100, 0.975 ,na.rm = TRUE),
                   three = quantile(((three-base)/base)*100, 0.975 ,na.rm = TRUE),
                   four = quantile(((four-base)/base)*100,0.975 , na.rm = TRUE),
                   five = quantile(((five-base)/base)*100,0.975 , na.rm = TRUE),
                   minusone = quantile((( minusone-base)/base)*100,0.975 , na.rm = TRUE),
                   minustwo = quantile((( minustwo-base)/base)*100,0.975 , na.rm = TRUE),
                   minusthree = quantile((( minusthree-base)/base)*100,0.975 , na.rm = TRUE),
                   minusfour = quantile((( minusfour-base)/base)*100,0.975 , na.rm = TRUE),
                   minusfive = quantile((( minusfive-base)/base)*100,0.975 , na.rm = TRUE)
  ) %>% 
  gather(key = incT, ci.hi, zero:minusfive)



pct.change.low.ci.reg <- newdf %>% group_by( struct.cohort.code, MAP.Scenario, Tmax, MAP)  %>%
  dplyr::summarise(zero = quantile(((base-base)/base)*100, 0.025 ,na.rm = TRUE),
                   one = quantile(((one-base)/base)*100, 0.025 ,na.rm = TRUE),
                   two = quantile(((two-base)/base)*100, 0.025 ,na.rm = TRUE),
                   three = quantile(((three-base)/base)*100, 0.025 ,na.rm = TRUE),
                   four = quantile(((four-base)/base)*100, 0.025 , na.rm = TRUE),
                   five = quantile(((five-base)/base)*100, 0.025 , na.rm = TRUE),
                   minusone = quantile((( minusone-base)/base)*100,0.025 , na.rm = TRUE),
                   minustwo = quantile((( minustwo-base)/base)*100,0.025 , na.rm = TRUE),
                   minusthree = quantile((( minusthree-base)/base)*100,0.025 , na.rm = TRUE),
                   minusfour = quantile((( minusfour-base)/base)*100,0.025 , na.rm = TRUE),
                   minusfive = quantile((( minusfive-base)/base)*100,0.025 , na.rm = TRUE)
  ) %>% 
  gather(key = incT, ci.low, zero:minusfive)


cis <- merge(pct.change.hi.ci.reg, pct.change.low.ci.reg, by = c("incT", "struct.cohort.code", "MAP.Scenario", "Tmax", "MAP") )
pct.change.temp.reg <- merge(pct.change.temp.reg, cis, by = c("incT", "struct.cohort.code", "MAP.Scenario", "Tmax", "MAP")) 

pct.change.temp.reg <- merge(pct.change.temp.reg , unique(sites.unique[,c("struct.cohort.code", "structure", "ageclass")]), by = c( "struct.cohort.code"))


Tdf <- data.frame(incT = c("minusfive","minusfour", "minusthree", "minustwo", "minusone","zero", "one", "two", "three", "four", "five"), 
                  deltaT = -5:5)
Tdf$Temperature <- Tdf$deltaT + 26.2

pct.change.temp.reg <- merge(pct.change.temp.reg, Tdf, by = "incT")
pct.change.temp.reg$struct.cohort.code <- as.character(pct.change.temp.reg$struct.cohort.code)


# select only the low and high map values & plot out
pct.change.low.high.MAP <- pct.change.temp.reg %>% filter(ageclass %in% "Modern" & MAP.Scenario %in% c("MAP950", "MAP515")) 

#1b9e77
#d95f02
#7570b3

# plot out pct change in growth estimated:
pct.change.low.high.MAP$Precipitation <- ifelse(pct.change.low.high.MAP$MAP.Scenario %in% "MAP950", "950 mm",
       ifelse(pct.change.low.high.MAP$MAP.Scenario %in% "MAP515","515 mm", "580 mm (current mean)"))

pct.change.plot <- ggplot(pct.change.low.high.MAP, aes(Temperature, pct_change, color = Precipitation, linetype = Precipitation))+geom_line() + geom_ribbon(data = pct.change.low.high.MAP, aes(x = Temperature, ymin = ci.low, ymax = ci.hi, fill = Precipitation), alpha = 0.25, colour = NA)+geom_hline(yintercept = 0, linetype = "dashed", color = "grey")+ylab("% change in growth")+facet_wrap(~structure, ncol = 1)+scale_linetype_manual(values = c("950 mm"= "solid","580 mm (current mean)"="dashed", '515 mm' = "solid"), name = "Precipitation")+scale_color_manual(values = c("950 mm"='#008837', '515 mm' = "#7b3294", "580 mm (current mean)" = "#d95f02"), name = "Precipitation")+scale_fill_manual(values = c("950 mm"='#008837', '515 mm' = "#7b3294", "580 mm (current mean)" = "#d95f02"), name = "Precipitation")+xlab(expression("June Mean Maximum Temperature (" * degree * "C)"))+xlim(20,40)+theme_bw()+theme(panel.grid = element_blank())


pct.change.plot


# put altogether in a single figure

png(height = 8, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/predicted_treegrowth_pct_change_Tmax_modern_only_marginal_fut_climate_boxes.png")
plot_grid( boxplot.tmax, ag.ss.pred.MAP.modonly, pct.change.plot, ncol=1, align = "v", rel_heights = c(0.65,1,1), labels = "AUTO") 
dev.off()

saveRDS(pct.change.low.high.MAP, "/Users/kah/Documents/TreeRings/outputs/data/pct_change_TMAX_precip_scenarios.rds")


# -Get future growth at each site if we change temperature by 1-8 deg C given mean precip, DBH, and RWI---------

mod.mean.clim <- test.dry.pair %>% filter(ageclass %in% "Modern" & year > 1950) %>% group_by(site) %>% dplyr::summarize(mod.mean.Tmax = mean(JUNTmax, na.rm = TRUE), one = mean(JUNTmax, na.rm = TRUE) + 1,
          two = mean(JUNTmax, na.rm = TRUE) + 2,
         three = mean(JUNTmax, na.rm = TRUE) + 3,
         four = mean(JUNTmax, na.rm = TRUE) + 4,
         five = mean(JUNTmax, na.rm = TRUE) + 5,
         six = mean(JUNTmax, na.rm = TRUE) + 6,
        seven =  mean(JUNTmax, na.rm = TRUE) + 7,
        eight =  mean(JUNTmax, na.rm = TRUE) + 8, 
        mod.mean.MAP = mean(MAP.prism, na.rm = TRUE), 
        MAPminus100 = mean(MAP.prism, na.rm = TRUE)-100,
        MAPminus50 = mean(MAP.prism, na.rm = TRUE)-50,
        MAPplus50 = mean(MAP.prism, na.rm = TRUE)+50,
        MAPplus100 = mean(MAP.prism, na.rm = TRUE)+100
       )

MAP.scenarios <- mod.mean.clim %>% dplyr::select(site, mod.mean.MAP:MAPplus100) %>% group_by(site) %>% gather(MAP.Scenario, MAP, mod.mean.MAP:MAPplus100)

temp.scenarios <- mod.mean.clim %>% dplyr::select(site, mod.mean.Tmax:eight) %>% group_by(site) %>% gather(Temp.Scenario,Tmax, mod.mean.Tmax:eight)

#next merge by site but keep all
all.scen <- merge(MAP.scenarios, temp.scenarios, by = "site", all = TRUE)

# get the scaled values for MAP and TMAX:
all.scen$MAP.scaled <- as.numeric(scale(all.scen$MAP, attr(MAP.scaled, "scaled:center"), attr(MAP.scaled, "scaled:scale")))

all.scen$T.scaled <- as.numeric(scale(all.scen$Tmax, attr(T.scaled, "scaled:center"), attr(T.scaled, "scaled:scale")))

# expand grid to add structure + cohort class - add 1 diameter, add 1 lag, add 2 lag, then add probe to the model....will need to re-run model

extras <- expand.grid(RWI_1 = 0.103, 
                     RWI_2 = 0.103, 
                     site = unique(all.scen$site), 
                     DBH.scaled = mean(test.dry.pair$DBH.scaled))

sites.unique <- unique(train.dry.pair[, c("site", "struct.cohort.code", "structure", "ageclass")])
extras <- merge(extras, sites.unique[, c("site", "struct.cohort.code")], by = "site")

degree.scenario <- merge(all.scen, extras, by = "site", all = TRUE)
degree.scenario <- merge(degree.scenario, site.num.df, by = "site")

# use estimates of betas to generate estimates for predicted growth:
meanMAP.sim <- degree.scenario %>% filter( MAP.Scenario == "mod.mean.MAP")
meanMAP.sim <- degree.scenario

int.mcmc <- as.mcmc(samp.structure.cohort.re[[1]])
int.mcmc.mat <- as.matrix(int.mcmc)
int.mcmc.dat <- data.frame(int.mcmc.mat)

int.1 <- matrix(rep(NA, nrow(int.mcmc.dat)*length(meanMAP.sim$T.scaled)), nrow = nrow(int.mcmc.dat))

# need to clean this up but this is the basic idea:


# simulate the effect of beta 1 conditional on Tmax
for(i in 1:length(meanMAP.sim$T.scaled)){
  # for struct.cohort == 1
  int.1[,i] <- int.mcmc.dat[,paste0("beta1.", meanMAP.sim[i,"site.num"], ".")]+
    int.mcmc.dat[,paste0("beta2.", meanMAP.sim[i,"struct.cohort.code"], ".")]*meanMAP.sim[i,]$MAP.scaled+    
    int.mcmc.dat[,paste0("beta3.", meanMAP.sim[i,"struct.cohort.code"], ".")]*meanMAP.sim[i,"DBH.scaled"] + 
    int.mcmc.dat[,paste0("beta4.", meanMAP.sim[i,"struct.cohort.code"], ".")]*meanMAP.sim[i,"RWI_1"]  + 
    int.mcmc.dat[,paste0("beta5.", meanMAP.sim[i,"struct.cohort.code"], ".")]*meanMAP.sim[i,"RWI_2"] +
    int.mcmc.dat[,paste0("beta6.", meanMAP.sim[i,"struct.cohort.code"], ".")]*meanMAP.sim[i,"T.scaled"] + 
   int.mcmc.dat[,paste0("beta7.", meanMAP.sim[i,"struct.cohort.code"], ".")] * (meanMAP.sim[i,"MAP.scaled"] *meanMAP.sim[i,"T.scaled"])
  
  
}


# columns are the different degree-site scenario combinations
meanMAP.sim$idval <- 1:length(meanMAP.sim$Tmax)
# rows are the mcmc values
colnames(int.1) <- 1:length(meanMAP.sim$Tmax)
test.m <- melt(int.1)
colnames(test.m) <- c("MCMC", "idval", "Ypred")
full.pred <- left_join(test.m, meanMAP.sim, by = "idval")
full.pred$RWI <- exp(full.pred$Ypred)

site.summary <- full.pred %>% group_by(site, Temp.Scenario,MAP.Scenario, struct.cohort.code) %>% dplyr::summarise(mean = mean(exp(RWI)), Ci.low = quantile(exp(Ypred), 0.025),  Ci.high = quantile(exp(Ypred), 0.975))

ggplot(site.summary[site.summary$MAP.Scenario %in% "MAPminus100",], aes(x = Temp.Scenario, y =mean, color = site))+geom_bar(stat = "identity", position = "dodge")+facet_wrap(~struct.cohort.code)



# get average growth increase relative to mod.mean:


pct.change.low.ci <- full.pred %>% dplyr::select(idval,MCMC,  site, MAP.Scenario, struct.cohort.code, Temp.Scenario, RWI) %>% group_by(site, MAP.Scenario, struct.cohort.code) %>% dplyr::select( -Temp.Scenario)

# spread function was adding nas so, create dfs with RWI values:

past.Temp <- full.pred %>% dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC, RWI, Temp.Scenario) %>% filter(Temp.Scenario %in% "mod.mean.Tmax") %>% dplyr::rename(zero = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code, MCMC,zero)

one <- full.pred %>% dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario) %>% filter(Temp.Scenario %in% "one" ) %>% dplyr::rename(one = RWI) %>% dplyr::select( -Temp.Scenario)%>% arrange(site, MAP.Scenario, struct.cohort.code, MCMC,one)

two <- full.pred %>%  dplyr::select(site, MAP.Scenario, struct.cohort.code,MCMC, RWI, Temp.Scenario) %>%filter(Temp.Scenario %in% "two" ) %>% dplyr::rename(two = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code,MCMC, two)

three <- full.pred %>% dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario) %>% filter(Temp.Scenario %in% "three" ) %>% dplyr::rename(three = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code,MCMC, three)

four <- full.pred %>%  dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario) %>%filter(Temp.Scenario %in% "four" ) %>% dplyr::rename(four = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code, MCMC,four)

five <-  full.pred %>% dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario) %>% filter(Temp.Scenario %in% "five" ) %>% dplyr::rename(five = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code,MCMC, five)

six <-  full.pred %>%  dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario) %>%filter(Temp.Scenario %in% "six" ) %>% dplyr::rename(six = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code,MCMC, six)

seven <- full.pred %>% dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario) %>% filter(Temp.Scenario %in% "seven" ) %>% dplyr::rename(seven = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code,MCMC, seven)

eight <-  full.pred %>% dplyr::select(site, MAP.Scenario, struct.cohort.code, MCMC,RWI, Temp.Scenario) %>% filter(Temp.Scenario %in% "eight" ) %>% dplyr::rename(eight = RWI) %>% dplyr::select( -Temp.Scenario) %>% arrange(site, MAP.Scenario, struct.cohort.code, MCMC,eight)
    

                                                                                                                                                                                                 
newdf <- cbind( past.Temp, one$one, two[,c("two")], three[,c("three")], four[,c("four")], five[, c("five")], six[, c("six")], seven[, c("seven")], eight[, c("eight")])       
colnames(newdf) <- c("site", "MAP.Scenario", "struct.cohort.code","MCMC", "base", "one", "two", "three", "four", "five", "six", "seven", "eight")




pct.change.temp <- newdf %>% group_by(site, struct.cohort.code, MAP.Scenario)  %>%
  dplyr::summarise(zero = mean(((base-base)/base)*100, na.rm = TRUE),
            one = mean(((one-base)/base)*100, na.rm = TRUE),
            two = mean(((two-base)/base)*100, na.rm = TRUE),
            three = mean(((three-base)/base)*100, na.rm = TRUE),
            four = mean(((four-base)/base)*100, na.rm = TRUE),
            five = mean(((five-base)/base)*100, na.rm = TRUE),
            six = mean(((six-base)/base)*100, na.rm = TRUE),
            seven = mean(((seven-base)/base)*100, na.rm = TRUE),
            eight = mean(((eight-base)/base)*100, na.rm = TRUE)
            ) %>% 
  gather(key = incT, pct_change, zero:eight)


pct.change.temp.all <- newdf %>% group_by(struct.cohort.code, MAP.Scenario)  %>%
  dplyr::summarise(zero = mean(((base-base)/base)*100, na.rm = TRUE),
            one = mean(((one-base)/base)*100, na.rm = TRUE),
            two = mean(((two-base)/base)*100, na.rm = TRUE),
            three = mean(((three-base)/base)*100, na.rm = TRUE),
            four = mean(((four-base)/base)*100, na.rm = TRUE),
            five = mean(((five-base)/base)*100, na.rm = TRUE),
            six = mean(((six-base)/base)*100, na.rm = TRUE),
            seven = mean(((seven-base)/base)*100, na.rm = TRUE),
            eight = mean(((eight-base)/base)*100, na.rm = TRUE)
            ) %>% 
  gather(key = incT, pct_change, zero:eight)


pct.change.hi.ci <- newdf %>% group_by(site, struct.cohort.code, MAP.Scenario)  %>%
  dplyr::summarise(zero = quantile(((base-base)/base)*100, 0.975 ,na.rm = TRUE),
            one = quantile(((one-base)/base)*100, 0.975 ,na.rm = TRUE),
            two = quantile(((two-base)/base)*100, 0.975 ,na.rm = TRUE),
            three = quantile(((three-base)/base)*100, 0.975 ,na.rm = TRUE),
            four = quantile(((four-base)/base)*100,0.975 , na.rm = TRUE),
            five = quantile(((five-base)/base)*100,0.975 , na.rm = TRUE),
            six = quantile(((six-base)/base)*100,0.975 , na.rm = TRUE),
            seven = quantile(((seven-base)/base)*100,0.975 , na.rm = TRUE),
            eight = quantile(((eight-base)/base)*100,0.975 , na.rm = TRUE)
            ) %>% 
  gather(key = incT, ci.hi, zero:eight)



pct.change.low.ci <- newdf %>% group_by(site, struct.cohort.code, MAP.Scenario)  %>%
  dplyr::summarise(zero = quantile(((base-base)/base)*100, 0.025 ,na.rm = TRUE),
            one = quantile(((one-base)/base)*100, 0.025 ,na.rm = TRUE),
            two = quantile(((two-base)/base)*100, 0.025 ,na.rm = TRUE),
            three = quantile(((three-base)/base)*100, 0.025 ,na.rm = TRUE),
            four = quantile(((four-base)/base)*100, 0.025 , na.rm = TRUE),
            five = quantile(((five-base)/base)*100, 0.025 , na.rm = TRUE),
            six = quantile(((six-base)/base)*100, 0.025 , na.rm = TRUE),
            seven = quantile(((seven-base)/base)*100, 0.025 , na.rm = TRUE),
            eight = quantile(((eight-base)/base)*100, 0.025 , na.rm = TRUE)
            ) %>% 
  gather(key = incT, ci.low, zero:eight)



cis <- merge(pct.change.hi.ci, pct.change.low.ci, by = c("site", "incT", "struct.cohort.code", "MAP.Scenario") )
pct.change.temp <- merge(pct.change.temp, cis, by = c("site","incT", "struct.cohort.code", "MAP.Scenario")) 

pct.change.temp <- merge(pct.change.temp , sites.unique, by = c("site", "struct.cohort.code"))


Tdf <- data.frame(incT = c("zero", "one", "two", "three", "four", "five","six","seven", "eight"), 
           deltaT = 0:8)

pct.change.temp <- merge(pct.change.temp, Tdf, by = "incT")
pct.change.temp$struct.cohort.code <- as.character(pct.change.temp$struct.cohort.code)

locs.sites <- locs %>% filter(code %in% unique(pct.change.temp$site)) %>% arrange(pr30yr)
pct.change.temp$site <-factor(pct.change.temp$site, levels = c("BON", "GLL1", "GLL2", "GLL3", "ENG", "AVO", "UNC","MOU", "GLA"))

plus100<- ggplot(pct.change.temp[pct.change.temp$MAP.Scenario %in% "MAPplus100",], aes(deltaT, pct_change, color = ageclass))+geom_point()+geom_line() + geom_ribbon(data = pct.change.temp[pct.change.temp$MAP.Scenario %in% "MAPplus100",], aes(x = deltaT, ymin = ci.low, ymax = ci.hi, fill = ageclass), alpha = 0.25, colour = NA)+facet_wrap(~site, ncol = 9)+geom_hline(yintercept = 0, linetype = "dashed")+ylab("+100mm ANNUAL PRECIPITATION \n % change in growth")+xlab("increase in Tmax (degC)")

minus100 <- ggplot(pct.change.temp[pct.change.temp$MAP.Scenario %in% "MAPminus100",], aes(deltaT, pct_change, color = ageclass))+geom_point()+geom_line() + geom_ribbon(data = pct.change.temp[pct.change.temp$MAP.Scenario %in% "MAPminus100",], aes(x = deltaT, ymin = ci.low, ymax = ci.hi, fill = ageclass), alpha = 0.25, colour = NA)+facet_wrap(~site, ncol = 9)+geom_hline(yintercept = 0, linetype = "dashed")+ylab("-100mm ANNUAL PRECIPITATION \n % change in growth")+xlab("increase in Tmax (degC)")

minus0 <- ggplot(pct.change.temp[pct.change.temp$MAP.Scenario %in% "mod.mean.MAP",], aes(deltaT, pct_change, color = ageclass))+geom_line() + geom_ribbon(data = pct.change.temp[pct.change.temp$MAP.Scenario %in% "mod.mean.MAP",], aes(x = deltaT, ymin = ci.low, ymax = ci.hi, fill = ageclass), alpha = 0.25, colour = NA)+facet_wrap(~site, ncol = 9)+geom_hline(yintercept = 0, linetype = "dashed")+ylab("0mm ANNUAL PRECIPITATION \n % change in growth")+xlab("increase in Tmax (degC)")

png(height = 12, width = 12, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/future_change_ingrowth.png")
plot_grid( plus100, minus0, minus100, nrow = 3, align = "hv", labels = "AUTO")
dev.off()

# get mean differences between time periods:
summary.degrees <- full.pred %>% group_by(site, MCMC, idval,MAP.Scenario, struct.cohort.code) %>% spread(Temp.Scenario, Ypred, drop = TRUE) %>% dplyr::summarise(zero = 0, one.diff = mean(one - mod.mean.Tmax),
                                                                                                                                             two.diff = mean(two- mod.mean.Tmax), 
                                                                                                                                             three.diff = mean(three - mod.mean.Tmax), 
                                                                                                                                             four.diff = mean(four - mod.mean.Tmax),
                                                                                                                                             five.diff = mean(five - mod.mean.Tmax),
                                                                                                                                             six.diff = mean(six -  mod.mean.Tmax), 
                                                                                                                                             seven.diff = mean(seven- mod.mean.Tmax), 
                                                                                                                                             eight.diff = mean(eight - mod.mean.Tmax)
                                                                                                                                             )

```
 
# FOR DRY YEARS ONLY: multi-level model with MAP as drought index, an INTERACTION between MAP and Tmax only by ageclass random effects and prev years growth (lag -1) and (lag - 2), and a site level random intercept parameter: 
 
 
# restart here 
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"

population_model_site_int_structure_x_cohort_re_lag2_temp_MAP_interaction.ageclass <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[site[i]] + beta2[age[i]]*DI.scaled[i] +   beta3[age[i]]*DBH.scaled[i]+beta4[age[i]]*log_RWI_1[i]+beta5[age[i]]*log_RWI_2[i]  + beta6[age[i]]*Temp.scaled[i] + beta7[age[i]]*Temp.scaled[i]*DI.scaled[i] # inclued beta 7 as interaction term 
   

}



# Prediction from known data
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[site.p[i]] + beta2[age.p[i]]*DI.scaled.p[i] + beta3[age.p[i]]*DBH.scaled.p[i] +beta4[age.p[i]]*log_RWI_1.p[i] +beta5[age.p[i]]*log_RWI_2.p[i] + beta6[age.p[i]]*Temp.scaled.p[i]+ beta7[age.p[i]]*Temp.scaled.p[i]*DI.scaled.p[i]
  }

# probe for prediction plots:
  for(i in 1:nprobe){
    Yprobe[i]  ~ dnorm(muprobe[i],inv.var)
    muprobe[i] <- beta1[site.probe[i]] + beta2[age.probe[i]]*DI.scaled.probe[i] + beta3[age.probe[i]]*DBH.scaled.probe[i] +beta4[age.probe[i]]*log_RWI_1.probe[i] + beta5[age.probe[i]]*log_RWI_2.probe[i] + beta6[age.probe[i]]*Temp.scaled.probe[i] + beta7[age.probe[i]]*Temp.scaled.probe[i]*DI.scaled.probe[i]
  }

# project into the future (assuming no further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut[i]  ~ dnorm(mufut[i],inv.var)
    mufut[i] <- beta1[site.fut[i]] + beta2[age.fut[i]]*DI.scaled.fut[i] + beta3[age.fut[i]]*DBH.scaled.fut[i] +beta4[age.fut[i]]*log_RWI_1.fut[i] +beta5[age.fut[i]]*log_RWI_2.fut[i] + beta6[age.fut[i]]*Temp.scaled.fut[i] + (beta7[age.fut[i]])*Temp.scaled.fut[i]*DI.scaled.fut[i]
  }

# project into the future (assuming 35% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.35[i]  ~ dnorm(mufut2[i],inv.var)
    mufut2[i] <- beta1[site.fut[i]] + (beta2[age.fut[i]]*0.92)*DI.scaled.fut[i] + beta3[age.fut[i]]*DBH.scaled.fut[i] +beta4[age.fut[i]]*log_RWI_1.fut[i] +beta5[age.fut[i]]*log_RWI_2.fut[i] + beta6[age.fut[i]]*Temp.scaled.fut[i]+ (beta7[age.fut[i]])*Temp.scaled.fut[i]*DI.scaled.fut[i]
  }



# project into the future (assuming 50% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.50[i]  ~ dnorm(mufut3[i],inv.var)
    mufut3[i] <- beta1[site.fut[i]] + (beta2[age.fut[i]]*0.85)*DI.scaled.fut[i] + beta3[age.fut[i]]*DBH.scaled.fut[i] +beta4[age.fut[i]]*log_RWI_1.fut[i] +beta5[age.fut[i]]*log_RWI_2.fut[i] + beta6[age.fut[i]]*Temp.scaled.fut[i]+ (beta7[age.fut[i]])*Temp.scaled.fut[i]*DI.scaled.fut[i]
  }


# project into the future (assuming 8% further change in drought senseiivty & temperature):
  for(i in 1:nfut){
   Yfut.35.35[i]  ~ dnorm(mufut35[i],inv.var)
    mufut35[i] <- beta1[site.fut[i]] + (beta2[age.fut[i]]*0.92)*DI.scaled.fut[i] + beta3[age.fut[i]]*DBH.scaled.fut[i] +beta4[age.fut[i]]*log_RWI_1.fut[i] +beta5[age.fut[i]]*log_RWI_2.fut[i] + (beta6[age.fut[i]]*1.08)*Temp.scaled.fut[i]+ (beta7[age.fut[i]]*0.92)*Temp.scaled.fut[i]*DI.scaled.fut[i]
  }



# project into the future (assuming 7% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.50.50[i]  ~ dnorm(mufut50[i],inv.var)
    mufut50[i] <- beta1[site.fut[i]] + (beta2[age.fut[i]]*0.85)*DI.scaled.fut[i] + beta3[age.fut[i]]*DBH.scaled.fut[i] +beta4[age.fut[i]]*log_RWI_1.fut[i] +beta5[age.fut[i]]*log_RWI_2.fut[i] + (beta6[age.fut[i]]*1.15)*Temp.scaled.fut[i]+(beta7[age.fut[i]]*0.85)*Temp.scaled.fut[i]*DI.scaled.fut[i]
  }

# Assume normal priors for betas, but generate a beta + alpha for each ageclass

for(s in 1:2){

beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
beta5[s] ~ dnorm(mu_beta5, inv_beta5)
beta6[s] ~ dnorm(mu_beta6, inv_beta6)
beta7[s] ~ dnorm(mu_beta7, inv_beta7)
}


for(k in 1:Nsites){
beta1[k] ~ dnorm(mu_beta1, inv_beta1)
}


# use uniform priors for each  Mubeta paramters 
mu_beta1 ~ dunif(-1, 1)
mu_beta2 ~ dunif(-1, 1)
mu_beta3 ~ dunif(-1, 1)
mu_beta4 ~ dunif(-1, 1)
mu_beta5 ~ dunif(-1, 1)
mu_beta6 ~ dunif(-1, 1)
mu_beta7 ~ dunif(-1, 1)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)
inv_beta6   ~ dgamma(0.01, 0.01)
sigma_beta6 <- 1/sqrt(inv_beta6)
inv_beta7   ~ dgamma(0.01, 0.01)
sigma_beta7 <- 1/sqrt(inv_beta7)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)



# calculate differences between parameters:
# one.two <- beta2[1] - beta2[2]
# two.three<- beta2[2] - beta2[3]
# three.four<- beta2[3] - beta2[4]
# two.four <- beta2[2] - beta2[4]


}"

# save these for use later:
saveRDS(train.dry.pair, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/train.rds")
saveRDS(test.dry.pair, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/test.rds")
train.dry.pair <- readRDS("outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/train.rds")
test.dry.pair <- readRDS("outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/test.rds")
# assign site numbers to each site:

site.num.df <- data.frame(site = as.character(unique(train.dry.pair$site)), 
           site.num = 1:length(as.character(unique(train.dry.pair$site))))

# if site num is not in the df, add it
if(! "site.num" %in% colnames(train.dry.pair)){
    train.dry.pair <- merge(train.dry.pair, site.num.df, by = "site" )
    test.dry.pair <- merge(test.dry.pair, site.num.df, by = "site" )
}

# generate probe dataset:
 DIprobe <- round(seq(range(train.dry.pair$MAP.scaled)[1], range(train.dry.pair$MAP.scaled)[2], by = 0.75), 3)
 DBHprobe <- round(seq(range(train.dry.pair$DBH.scaled)[1], range(train.dry.pair$DBH.scaled)[2], by = 0.75), 3)
 Tempprobe <- round(seq(range(train.dry.pair$T.scaled)[1], range(train.dry.pair$T.scaled)[2], by = 0.75), 3)
 RWI1probe <- round(seq(range(log(train.dry.pair$RWI_1))[1], range(log(train.dry.pair$RWI_1))[2], by = 0.5), 3)
 RWI2probe <- round(seq(range(log(train.dry.pair$RWI_2))[1], range(log(train.dry.pair$RWI_2))[2], by = 0.5), 3)
 
 # expand into full probe
probe <- expand.grid(DI.scaled = DIprobe, DBH.scaled = DBHprobe, T.scaled = Tempprobe,
                         RWI_1 = RWI1probe, RWI_2= RWI2probe, struct.cohort.code= 1:4, age.code = 1:2,site.num = unique(train.dry.pair$site.num))

sit.cohorts <- unique(train.dry.pair[,c("struct.cohort.code", "site.num")])
probe <- merge(probe, sit.cohorts, by = c("struct.cohort.code", "site.num")) # make sure that each site only has savanna or forest in the probe

# make probe smaller to help with saving:
short.probe <- probe[probe$RWI_1 %in% c("-1.609", "0.391", "1.891") & probe$RWI_2 %in% c("-1.196", "0.304", "1.804") & probe$DBH.scaled %in% c("-1.163", "0.337", "1.837"),]

#short.probe <- probe

# make a probe for future climate projections at our sites!
rcp85 <- rcp85[!rcp85$site %in% c("COR", "GLL4", "HIC", "PLE", "PVC", "STC", "TOW"),]
future.probe_70 <- data.frame(MAP.scaled = rcp85$PR_85_70.scaled, DBH.scaled= -0.413, 
                              T.scaled = rcp85$Tx_70.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103,  struct.cohort.code = rcp85$struct.cohort.code,age.code = 1, site = rcp85$site, model = rcp85$model)
future.probe_70$year <- 2070
future.probe_50 <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, age.code = 1, site = rcp85$site,  model = rcp85$model)
future.probe_50$year <- 2050


# get climate averages from 1950 - present at each site:
train.dry.pair$struct.cohort.code2 <- as.numeric(train.dry.pair$struct.cohort.code)
train.clim.summary <-
  train.dry.pair[train.dry.pair$ageclass %in% "Modern", ] %>% group_by(site) %>% dplyr::summarise(
    MAP.scaled = mean(MAP.scaled),
    DBH.scaled = -0.413,
    T.scaled = mean(T.scaled),
    RWI_1 = 0.103,
    RWI_2 = 0.103,
    struct.cohort.code = mean(struct.cohort.code2),
    age.code = 1,
    model = "none",
    year = 2000
    )



Average.prob <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, age.code = 1,site = rcp85$site, model = rcp85$model)
future.probe_50$year <- 2050


fut <- rbind(future.probe_50, future.probe_70, train.clim.summary[,c("MAP.scaled", "DBH.scaled",  "T.scaled", "RWI_1", "RWI_2", "struct.cohort.code", "age.code","site","year","model")])


fut <- merge(fut, site.num.df, by = "site")

# look at the effects under two different DBH values
short.fut <- fut
fut.small <- fut
fut.large <- fut
fut.small$DBH.scaled <- -0.413
fut.large$DBH.scaled <- 1.900
long.fut <- rbind(fut.small, fut.large)


# look at the effects under average, below average, and above average different prev year growth values
lfut.low <- long.fut
lfut.avg <- long.fut
lfut.high <- long.fut

lfut.low$RWI_1 <- -1.609
lfut.low$RWI_2 <- -1.47

lfut.high$RWI_1 <- 1.891
lfut.high$RWI_2 <- 2.03

long.fut <- rbind(lfut.high, lfut.avg, lfut.low)


train.dry.pair$ageclass_code <- ifelse(train.dry.pair$ageclass %in% "Modern", 1, 2)
test.dry.pair$ageclass_code <- ifelse(test.dry.pair$ageclass %in% "Modern", 1, 2)


# create a single dataframe with all the values we care about
colsforYpred <- c("RWI", "MAP.scaled", "DBH.scaled", "RWI_1", "RWI_2", "T.scaled", "ageclass_code", "site.num", "site")

full.dry.pair <- rbind(train.dry.pair[,colsforYpred], test.dry.pair[,colsforYpred])



lag2.model.by_structure_x_cohort_t_pr_int <- jags.model(textConnection(population_model_site_int_structure_x_cohort_re_lag2_temp_MAP_interaction.ageclass), 
                    data = list(Y=log(train.dry.pair$RWI), 
                                n=length(train.dry.pair$RWI), 
                                DI.scaled = train.dry.pair$MAP.scaled, 
                                DBH.scaled = train.dry.pair$DBH.scaled,
                                log_RWI_1 = log(train.dry.pair$RWI_1),
                                log_RWI_2 = log(train.dry.pair$RWI_2), 
                                Temp.scaled = train.dry.pair$T.scaled, 
                                age = as.numeric(train.dry.pair$ageclass_code), 
                                #SF = unique(train.dry.pair$ageclass_code), 
                                site = train.dry.pair$site.num, 
                                Nsites = length(unique(train.dry.pair$site)),
                     
                                
   age.p = as.numeric(full.dry.pair$ageclass_code), 
   DBH.scaled.p = full.dry.pair$DBH.scaled, 
   DI.scaled.p = full.dry.pair$MAP.scaled, 
   log_RWI_1.p = log(full.dry.pair$RWI_1), 
   log_RWI_2.p = log(full.dry.pair$RWI_2), 
   Temp.scaled.p = full.dry.pair$T.scaled, 
   site.p = full.dry.pair$site.num, 
   np = length(full.dry.pair$ageclass_code),

  age.probe = as.numeric(short.probe$age.code), 
  DBH.scaled.probe = short.probe$DBH.scaled, 
  DI.scaled.probe = short.probe$DI.scaled, 
  log_RWI_1.probe = short.probe$RWI_1, 
  log_RWI_2.probe = short.probe$RWI_2, 
  Temp.scaled.probe = short.probe$T.scaled, 
  site.probe = short.probe$site.num, 
  nprobe = length(as.numeric(short.probe$age.code)), 
  # 
  age.fut = as.numeric(long.fut$age.code), 
  DBH.scaled.fut = long.fut$DBH.scaled, 
  DI.scaled.fut = long.fut$MAP.scaled, 
  log_RWI_1.fut = long.fut$RWI_1, 
  log_RWI_2.fut =long.fut$RWI_2, 
  Temp.scaled.fut = long.fut$T.scaled, 
  site.fut = long.fut$site.num, nfut = length(as.numeric(long.fut$age.code))),
   #, 
   n.chains = 3, n.adapt = 100)
  
  


update(lag2.model.by_structure_x_cohort_t_pr_int, 10000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","beta6","beta7","sigma", "mu_beta1", "mu_beta2","mu_beta3", "mu_beta4","mu_beta5", "mu_beta6", "mu_beta7"), 
                    n.chains = 3, n.iter=10000, thin = 15)

# jointly track all variables, including Y
# samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
#                      variable.names=c("beta1", "beta2","beta3","beta4","beta5","beta6","beta7","sigma", "mu_beta1", "mu_beta2","mu_beta3", "mu_beta4","mu_beta5", "mu_beta6", "mu_beta7", "Y"), 
#                     n.chains = 3, n.iter=10000, thin = 15)


#beta2.diffs <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
 #                    variable.names=c("one.two", "two.three", "three.four", "two.four"), 
  #                  n.chains = 3, n.iter=10000, thin = 15)

# note that this is predicting over the full dataset because I used the full dataset in the predicted data
Yp <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yp"), 
                    n.chains = 3, n.iter=10000, thin = 15)
 saveRDS(Yp, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/Ypred_full_dataset.rds")


Y.probe <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yprobe"), 
                    n.chains = 3, n.iter=5000, thin = 15)
saveRDS(Y.probe, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/Y.probe.rds")

Y.fut <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yfut"), 
                    n.chains = 3, n.iter=10000, thin = 15)
saveRDS(Y.fut, "outputs//growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/Y.fut.rds")

Y.fut.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yfut.35"), 
                    n.chains = 3, n.iter=10000, thin = 15)
saveRDS(Y.fut.35, "outputs//growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/Y.fut.35.rds")

Y.fut.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yfut.50"), 
                    n.chains = 3, n.iter=10000, thin = 15)
saveRDS(Y.fut.50, "outputs//growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/Y.fut.50.rds")

Y.fut.35.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yfut.35.35"), 
                    n.chains = 3, n.iter=10000, thin = 15)
saveRDS(Y.fut.35.35, "outputs//growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/Y.fut.35.35.rds")

Y.fut.50.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yfut.50.50"), 
                    n.chains = 3, n.iter=10000,thin = 15)
saveRDS(Y.fut.50.50, "outputs//growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/Y.fuut.50.50.rds")


dic.full <- dic.samples(lag2.model.by_structure_x_cohort_t_pr_int, n.chains = 3, n.iter=10000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter_DIC.rds")

summary(samp.structure.cohort.re)

traceplot(samp.structure.cohort.re[,"beta2[2]"])

# most just around 1
gelman.diag(samp.structure.cohort.re, multivariate = FALSE)
acfplot(samp.structure.cohort.re)


autocorr.plot(samp.structure.cohort.re [[1]][ , 'beta2[2]'], auto.layout = FALSE, lwd = 4, col = "red", lag.max = 100)

#Extract the samples for each parameter for a basic exploration of effects

 samps   <- samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/samps.rds")
 samps <- readRDS("outputs//growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/samps.rds")
 #test.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/test.rds")
 #train.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/train.rds")
#Yfut.samps <- samps[, 1:length(fut$RWI_1)]
#samps <- samps[,(length(fut$RWI_1)+1):length(colnames(samps))]
 Yp.samps <- Yp
 Yprobe.samps <- Y.probe
 alpha.samps  <- samps[,1:9]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,10:11]
 beta3.samps <- samps[,12:13]
 beta4.samps <- samps[,14:15]
 beta5.samps <- samps[,16:17]
 beta6.samps <- samps[,18:19]
 beta7.samps <- samps[,20:21]
 mu_beta.samps <- samps[,22:27]
 sigma.samps <- samps[,36]
 sigma_betas <- samps[,28:34]

 
 
 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps[[1]]) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))

test.dry.pair2 <- test.dry.pair
test.dry.pair2$variable <- unique(Yp.m$variable)

Yp.summary$Observed <- test.dry.pair$RWI



pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test.dry.pair$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)+theme_bw(base_size = 15)

# note best model fit so far
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/pred_vs_obs.png")
p.o.plot
dev.off()

# plot average growth boxplots for modern & past:

Yp.full <- left_join(Yp.m, test.dry.pair2, by = "variable")


# get estimates for predicted growth:
Yp.summary.cohort  <- Yp.full %>% group_by(ageclass) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025), 
                                                 Observed = mean(RWI))



mean.pred.growth <- ggplot(Yp.summary.cohort, aes(ageclass,Predicted, fill = ageclass))+geom_bar(stat = "identity")+geom_errorbar(data = Yp.summary.cohort,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.8, size = 0.5, width = 0.2)+ylim(0, 6) + ylab("Mean predicted tree growth (mm)")+scale_fill_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme_bw(base_size = 16)+theme(panel.grid = element_blank(), axis.title.x = element_blank(), legend.position = "none")

png(height = 4, width = 4.5, units = "in", res = 300, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/predicted_growth_barplot.png")
mean.pred.growth
dev.off()


saveRDS(Yp.full, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/predicted_growth_YP.rds")
# -------make overall summary of the differences in parameters between groups:

beta_diffs <- data.frame(diff_beta2 = (beta2.samps[,1]-beta2.samps[,2]), 
                         diff_beta3 = (beta3.samps[,1]-beta3.samps[,2]) , 
                         diff_beta4 = (beta4.samps[,1]-beta4.samps[,2]), 
                         diff_beta5 = (beta5.samps[,1]-beta5.samps[,2]), 
                         diff_beta6 = (beta6.samps[,1]-beta6.samps[,2]), 
                         diff_beta7 = (beta7.samps[,1]-beta7.samps[,2]))

beta_diffs.pct <- data.frame(diff_beta2 = (beta2.samps[,1]-beta2.samps[,2]), 
                         diff_beta3 = (beta3.samps[,1]-beta3.samps[,2]) , 
                         diff_beta4 = (beta4.samps[,1]-beta4.samps[,2]), 
                         diff_beta5 = (beta5.samps[,1]-beta5.samps[,2]), 
                         diff_beta6 = (beta6.samps[,1]-beta6.samps[,2]), 
                         diff_beta7 = (beta7.samps[,1]-beta7.samps[,2]))


colnames(beta_diffs) <- c("MAP", "DBH", "lag_1", "lag_2", "Tmax","MAPxTmax")

beta_diffsm <- beta_diffs %>% gather(beta, difference) %>% group_by(beta) %>% 
  summarise(mean = mean(difference), 
            hdi.low = hdi(difference)[1],
            hdi.high = hdi(difference)[2]) 


beta.diffs.plot.mod.past <- ggplot(beta_diffsm, aes(beta, mean))+geom_bar(stat = "identity")+geom_errorbar(data = beta_diffsm,aes(ymin=hdi.low, ymax=hdi.high), color = "grey", alpha = 0.8, size = 0.5, width = 0.2)+ylab("Difference in beta parameter (Modern - Past)")+xlab("beta parameters")+theme_bw(base_size = 16)+theme(panel.grid = element_blank())

png(height = 4, width = 4.5, units = "in", res = 300, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/beta_differences_hdi.png")
beta.diffs.plot.mod.past
dev.off()

# save for later plot:
saveRDS(beta_diffsm, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/beta_differences_cohorts.rds")

saveRDS(beta_diffs, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/beta_diffs_cohorts.rds")

# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test.dry.pair$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test.dry.pair$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter", 
                            model.summary = "beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] + beta7[struct.cohort[i]]*Temp.scaled[i]*DI.scaled[i] ",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter", 
                           train = "cohort.omit.dry.years", 
                           DI.scaled = "MAP")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)



# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- unique(train.dry.pair$site)#[order(unique(train.dry.pair[,c("site", "site.num")])[,2])])
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c("Modern" ,"Past")
#colnames(b2) <- c(paste0(c(unique(train.dry.pair$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope")

b3 <- data.frame(beta3.samps)
colnames(b3) <- c("Modern" ,"Past")
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH Index slope")


b4 <- data.frame(beta4.samps)
colnames(b4) <- c("Modern" ,"Past")
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-1 Index slope")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c("Modern" ,"Past")
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-2 Index slope")

b6 <- data.frame(beta6.samps)
colnames(b6) <- c("Modern" ,"Past")
b6$num <- rownames(b6)
b6.m <- melt(b6, id.vars=c("num"))
b6.mplots <- ggplot(b6.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Summer Temperature slope")

b7 <- data.frame(beta7.samps)
colnames(b7) <- c("Modern" ,"Past")
b7$num <- rownames(b7)
b7.m <- melt(b7, id.vars=c("num"))
b7.mplots <- ggplot(b7.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precip*Temp slope")



png(height = 10, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/drougt_beta_marginal_distn_byage.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots, b5.mplots, b6.mplots, b7.mplots)
dev.off()



# -------------------- DOTPLOTS by modern vs. past only ---------------------
# make dotplots for all the factors in the model--
# get summaries by age class from the melted samples:

a1.sum <- a.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975),
                                                   hdi.low = hdi(value)[1], 
                                                   hdi.high = hdi(value)[2])
a1.sum$variable <- unique(train.dry.pair$site)

df.site.struct <- unique(train.dry.pair[,c("site", "structure")])
a1.sum <- merge(a1.sum, df.site.struct, by.x = "variable", by.y = "site")
a1.sum$structure <- factor(a1.sum$structure, levels = c( "Forest", "Savanna"))

b2.sum <- b2.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975),
                                                   hdi.low = hdi(value)[1], 
                                                   hdi.high = hdi(value)[2] )

b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past","Modern"))
colnames(b2.sum) <- c("cohort", "mean.val", "Ci.low", "Ci.high", "hdi.low", "hdi.high")

b3.sum <- b3.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975),
                                                   hdi.low = hdi(value)[1], 
                                                   hdi.high = hdi(value)[2] )
b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past","Modern"))
colnames(b3.sum) <- c("cohort", "mean.val", "Ci.low", "Ci.high", "hdi.low", "hdi.high")

b4.sum <- b4.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975),
                                                   hdi.low = hdi(value)[1], 
                                                   hdi.high = hdi(value)[2] )


b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past","Modern"))
colnames(b4.sum) <- c("cohort", "mean.val", "Ci.low", "Ci.high", "hdi.low", "hdi.high")

b5.sum <- b5.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975),
                                                   hdi.low = hdi(value)[1], 
                                                   hdi.high = hdi(value)[2] )
b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past","Modern"))
colnames(b5.sum) <- c("cohort", "mean.val", "Ci.low", "Ci.high", "hdi.low", "hdi.high")

b6.sum <- b6.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975),
                                                   hdi.low = hdi(value)[1], 
                                                   hdi.high = hdi(value)[2] )
b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past","Modern"))
colnames(b6.sum) <- c("cohort", "mean.val", "Ci.low", "Ci.high", "hdi.low", "hdi.high")


b7.sum <- b7.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975),
                                                   hdi.low = hdi(value)[1], 
                                                   hdi.high = hdi(value)[2] )
b7.sum$variable <- factor(b7.sum$variable, levels = c( "Past","Modern"))
colnames(b7.sum) <- c("cohort", "mean.val", "Ci.low", "Ci.high", "hdi.low", "hdi.high")



# write out all the dotplots with 95% ci
int.dot.age <- ggplot(data.frame(a1.sum), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot.age <- ggplot(data.frame(b2.sum), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot.age <- ggplot(data.frame(b3.sum), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot.age <- ggplot(data.frame(b4.sum), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot.age <- ggplot(data.frame(b5.sum), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -2 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot.age <- ggplot(data.frame(b6.sum), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b7.dot.age <- ggplot(data.frame(b7.sum), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Temp*Precip sensitivity (Beta7)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/full_dot_plot_cohort_only_CI.png")
plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b7.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1, align = "v")
dev.off()


# write out all the dotplots with HDI
int.dot.age.hdi <- ggplot(data.frame(a1.sum), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = hdi.low, xmax = hdi.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot.age.hdi <- ggplot(data.frame(b2.sum), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = hdi.low, xmax = hdi.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot.age.hdi <- ggplot(data.frame(b3.sum), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = hdi.low, xmax = hdi.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot.age.hdi <- ggplot(data.frame(b4.sum), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = hdi.low, xmax = hdi.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot.age.hdi <- ggplot(data.frame(b5.sum), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = hdi.low, xmax = hdi.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -2 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot.age.hdi <- ggplot(data.frame(b6.sum), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = hdi.low, xmax = hdi.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b7.dot.age.hdi <- ggplot(data.frame(b7.sum), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = hdi.low, xmax = hdi.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Temp*Precip sensitivity (Beta7)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")



png(height = 14, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/full_dot_plot_cohort_only_HDI.png")
plot_grid(int.dot.age.hdi, b2.dot.age.hdi, b6.dot.age.hdi, b7.dot.age.hdi, b3.dot.age.hdi, b4.dot.age.hdi, b5.dot.age.hdi, ncol = 1)
dev.off()



# ------------------ Do the site level intercepts correlate with site quality -----------
# read in information about site quality:
locs <- read.csv("outputs/priority_sites_locs_with_soil_clim.csv")
locs <- data.frame(locs)
locs$code <- as.character(locs$code)
locs[9:12,]$code <- c( "GLL1", "GLL2", "GLL3", "GLL4")
sites <- c("COR", "HIC", "STC", "GLA", "TOW", "ENG", "UNC", "BON", "MOU", "GLL4", "GLL3", "GLL2", "GLL1", "PVC", "AVO", "PLE", "UNI")

# merge with a1.sum.age
site.summary <- merge(a1.sum.age, locs, by.x = "variable", by.y = "code")

# plot mean + 95% confidence interval vs. MAP
alpha.pr30yr <-ggplot(site.summary, aes(x = pr30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("Total Precip")
# get an idea if there might be relationship
summary(lm(mean.val ~ pr30yr,data = site.summary))

# plot mean + 95% confidence interval vs. Tmean
alpha.tm30yr <-ggplot(site.summary, aes(x = tm30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("Mean Temp")
# get an idea if there might be relationship
summary(lm(mean.val ~ tm30yr,data = site.summary))

# plot mean + 95% confidence interval vs. sand %
alpha.sand <-ggplot(site.summary, aes(x = sand, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("sand")#+stat_smooth(method = "lm")
# get an idea if there might be relationship
summary(lm(mean.val ~ sand,data = site.summary))

# plot mean + 95% confidence interval vs. ksat
alpha.ksat <-ggplot(site.summary, aes(x = ksat, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept (alpha)")+xlab("ksat")
# get an idea if there might be relationship
summary(lm(mean.val ~ ksat,data = site.summary))

# plot mean + 95% confidence interval vs. awc

alpha.awc <- ggplot(site.summary, aes(x = awc, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+ylab("Estimated Intercept (alpha)")+xlab("AWC")
# get an idea if there might be relationship
summary(lm(mean.val ~ awc,data = site.summary))

# plot mean + 95% confidence interval vs. n. species 

alpha.nspecies <- ggplot(site.summary, aes(x = nspecies, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("nspecies")#+stat_smooth(data = site.summary, aes(x = nspecies, y = mean.val), method = "lm")

# there seems to be a loost relationship between alpha and site soil characteristics, such that sites with lower ksat and higer awc have lower intercepts
# but plot the relationships out here:
png(height = 10, width = 4, units = "in",res = 200, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/alpha_site_ints_vs_site_quality.png")
plot_grid(alpha.pr30yr, alpha.tm30yr, alpha.awc, alpha.sand, alpha.nspecies, ncol = 1, align = "v")
dev.off()

# ---------------------- plot interaaction term --------------------------
# plot the effect of MAP conditional across Tmax

# plot effect of temp conditional on MAP (interaction):
## Simulate the range of the moderating variable

T.sim <- seq(min(train.dry.pair$T.scaled), max(train.dry.pair$T.scaled), by = 0.1)

## Calculate conditional effect of X1 across the range of X2
int.mcmc <- as.mcmc(samp.structure.cohort.re[[1]])
int.mcmc.mat <- as.matrix(int.mcmc)
int.mcmc.dat <- data.frame(int.mcmc.mat)

int.1 <- matrix(rep(NA, nrow(int.mcmc.dat)*length(T.sim)), nrow = nrow(int.mcmc.dat))
int.2 <- matrix(rep(NA, nrow(int.mcmc.dat)*length(T.sim)), nrow = nrow(int.mcmc.dat))

# simulate the effect of beta 1 conditional on Tmax
for(i in 1:length(T.sim)){
  int.1[, i] <- int.mcmc.dat$beta2.1. + int.mcmc.dat$beta7.1. * T.sim[i]
  int.2[, i] <- int.mcmc.dat$beta2.2. + int.mcmc.dat$beta7.2. * T.sim[i]

}

## Note: the variance now comes from the posterior, not the vcov matrix

bayes.c.eff.mean1 <- apply(int.1, 2, mean)
bayes.c.eff.lower1 <- apply(int.1, 2, function(x) quantile(x, probs = c(0.025)))
bayes.c.eff.upper1 <- apply(int.1, 2, function(x) quantile(x, probs = c(0.975)))

bayes.c.eff.mean2 <- apply(int.2, 2, mean)
bayes.c.eff.lower2 <- apply(int.2, 2, function(x) quantile(x, probs = c(0.025)))
bayes.c.eff.upper2 <- apply(int.2, 2, function(x) quantile(x, probs = c(0.975)))


# summarise all the data -> this is ugly but it does the job
library(DMwR)
as.numeric(round(unscale(vals = Tsim, norm.data = T.scaled))) 
plot.dat1 <- data.frame(T.sim,Tmax = as.numeric(unscale(vals = T.sim, norm.data = T.scaled)) , mean = bayes.c.eff.mean1, Ci.low = bayes.c.eff.lower1, Ci.high = bayes.c.eff.upper1, cohort = "Modern")

plot.dat2 <- data.frame(T.sim, Tmax = as.numeric(vals = T.sim, norm.data = T.scaled), mean = bayes.c.eff.mean2, Ci.low = bayes.c.eff.lower2, Ci.high = bayes.c.eff.upper2, cohort = "Past")
#plot.dat3<- data.frame(T.sim, mean = bayes.c.eff.mean3, Ci.low = bayes.c.eff.lower3, Ci.high = bayes.c.eff.upper3, struct.cohort=3)
#plot.dat4 <- data.frame(T.sim, mean = bayes.c.eff.mean4, Ci.low = bayes.c.eff.lower4, Ci.high = bayes.c.eff.upper4, struct.cohort = 4) 

plot.dat <- rbind(plot.dat1, plot.dat2) #, plot.dat3, plot.dat4)
plot.dat$cohort <- as.factor(plot.dat$cohort)

## Foundation for the plot & line for the posterior mean of the Bayesian conditional effect
p <- ggplot(plot.dat, aes(x = Tmax, y = mean, color = cohort)) + geom_line( alpha = 0.8, size = 0.5)+ geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort),  alpha = 0.2, linetype = "blank") +ylab("condtional ffect of MAP")+xlab("Tmax")+ scale_color_manual()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+scale_fill_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))

p


# plot the conditional effect of Temperature across MAP:
MAP.sim <- seq(min(train.dry.pair$MAP.scaled), max(train.dry.pair$MAP.scaled), by = 0.1)

## Calculate conditional effect of X1 across the range of X2
int.mcmc <- as.mcmc(samp.structure.cohort.re[[1]])
int.mcmc.mat <- as.matrix(int.mcmc)
int.mcmc.dat <- data.frame(int.mcmc.mat)

int.1 <- matrix(rep(NA, nrow(int.mcmc.dat)*length(MAP.sim)), nrow = nrow(int.mcmc.dat))
int.2 <- matrix(rep(NA, nrow(int.mcmc.dat)*length(MAP.sim)), nrow = nrow(int.mcmc.dat))

# simulate the effect of beta 1 conditional on Tmax
for(i in 1:length(MAP.sim)){
  int.1[, i] <- int.mcmc.dat$beta6.1. + int.mcmc.dat$beta7.1. * MAP.sim[i]
  int.2[, i] <- int.mcmc.dat$beta6.2. + int.mcmc.dat$beta7.2. * MAP.sim[i]

}

## Note: the variance now comes from the posterior, not the vcov matrix

bayes.c.eff.mean1 <- apply(int.1, 2, mean)
bayes.c.eff.lower1 <- apply(int.1, 2, function(x) quantile(x, probs = c(0.025)))
bayes.c.eff.upper1 <- apply(int.1, 2, function(x) quantile(x, probs = c(0.975)))

bayes.c.eff.mean2 <- apply(int.2, 2, mean)
bayes.c.eff.lower2 <- apply(int.2, 2, function(x) quantile(x, probs = c(0.025)))
bayes.c.eff.upper2 <- apply(int.2, 2, function(x) quantile(x, probs = c(0.975)))


# summarise all the data -> this is ugly but it does the job
library(DMwR)

plot.dat1 <- data.frame(MAP.sim,MAP = as.numeric(unscale(vals = MAP.sim, norm.data = MAP.scaled)) , mean = bayes.c.eff.mean1, Ci.low = bayes.c.eff.lower1, Ci.high = bayes.c.eff.upper1, cohort = "Modern")

plot.dat2 <- data.frame(MAP.sim, MAP = as.numeric(unscale(vals = MAP.sim, norm.data = MAP.scaled)), mean = bayes.c.eff.mean2, Ci.low = bayes.c.eff.lower2, Ci.high = bayes.c.eff.upper2, cohort = "Past")


plot.dat.MAP <- rbind(plot.dat1, plot.dat2) #, plot.dat3, plot.dat4)
plot.dat.MAP$cohort <- as.factor(plot.dat.MAP$cohort)

## Foundation for the plot & line for the posterior mean of the Bayesian conditional effect
MAP.conditional <- ggplot(plot.dat.MAP, aes(x = MAP, y = mean, color = cohort)) + geom_line( alpha = 0.8, size = 0.5)+ geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort),  alpha = 0.2, linetype = "blank") +ylab("Condtional effect of Tmax")+xlab("Precipitation (mm)")+ scale_color_manual()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+scale_fill_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme_bw(base_size = 18)+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

MAP.conditional

png(height = 4, width = 6,  units = "in", res = 300,  "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/interaction_plot_Tmax_cond_on_MAP.png")
MAP.conditional
dev.off()

#-------------- plot responses of modern and past to temperature, precipitation, DBH, Lag_1, Lag_2 conditioned on mean values of all other values: ------------------------------------

# --------------------make plots of probed predicted growth responses:
# plot probed values of tree growth predictions:
Yprobe <- data.frame(Y.probe[[1]])
colnames(Yprobe) <- 1:length(Yprobe)
probe.m <- melt(Yprobe)
probe.m$RWI <- exp(probe.m$value) 
colnames(probe.m) <- c("num", "Ypred", "RWI")

probe <- short.probe
probe$num <- 1:length(probe[,1])
colnames(probe) <- c("struct.cohort","site.num","Drought", "DBH","Tmax", "RWI_1","RWI_2","age.code", "num")

# summarize by structure + cohort class only:
# summarize by structure + cohort class only:
probe$num <- as.factor(as.character(probe$num))
full.p <- probe

probtest.dry.pair <- dplyr::inner_join(probe.m, full.p, by=c("num"))

prob <- probtest.dry.pair
# save here:
saveRDS(prob, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/full_yprobe_preds.rds")
prob <- readRDS("outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/full_yprobe_preds.rds")




# convert prob$Drought back to MAP:
library(DMwR)
DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)



prob$DBH <- as.numeric(round(unscale(vals = prob$DBH, norm.data = DBH.scaled))) 
prob$MAP <- as.numeric(round(unscale(vals = prob$Drought, norm.data = MAP.scaled)))
prob$Tmax <- as.numeric(round(unscale(vals = prob$Tmax, norm.data = T.scaled))) 


prob_10_60cm_avg <- prob %>% dplyr::filter(  RWI_1 == 0.391, RWI_2 == 0.304 ) 

prob_10_60cm_avg$cohort <- ifelse(prob_10_60cm_avg$age.code == 1, "Modern", "Past")

preds_ci_10 <- prob_10_60cm_avg %>% group_by(DBH, Drought, MAP,Tmax,cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                                                                 Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))


# same thing but with LOWER than average tree growth the years before:

prob_10_60cm_low <- prob %>% dplyr::filter( RWI_1 == -1.609, RWI_2 == -1.196 ) 
prob_10_60cm_low$cohort <- ifelse(prob_10_60cm_low$age.code == 1, "Modern", "Past")

preds_ci_10_low_age <- prob_10_60cm_low %>% group_by(DBH, Drought, MAP,Tmax, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with HIGHER than average tree growth the years before:

prob_10_60cm_high <- prob %>% dplyr::filter(RWI_1 == 1.891, RWI_2 == 1.804  ) 
prob_10_60cm_high$cohort <- ifelse(prob_10_60cm_high$age.code == 1, "Modern", "Past")


preds_ci_10_high <- prob_10_60cm_high %>% group_by(DBH, Drought,MAP, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                                                                       Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

preds_ci_10_high_age <- prob_10_60cm_high %>% group_by(DBH, Drought, MAP,Tmax, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                                                              Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

#----------- plot drought response by max temperature and Dimaeter + cohort-struct class -----------

Drought.resp.DBH.temp.avgpyr <- ggplot(preds_ci_10, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()



Drought.resp.DBH.temp.lowpyr <- ggplot(preds_ci_10_low_age, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


Drought.resp.DBH.temp.highpyr <- ggplot(preds_ci_10_high, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()


# output the above plots to PNG:
png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/MAP_response_low_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.lowpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/MAP_response_avg_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.avgpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/MAP_response_high_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.highpyr 
dev.off()


# plot marginal responses of growth to parameters:


#--------------- plot marginal effects of climate and previous years growth ----------------

struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

prob <- left_join(prob, struc.conversion, by  = "struct.cohort")

prob$cohort <- ifelse(prob$age.code == 1, "Modern", "Past")

# Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, cohort) %>% summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = cohort)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax,cohort) %>% summarise(meanY = mean(RWI),
                                                                          Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill =cohort), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (Deg C)")+ylim(0,10)+theme_bw()

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH,cohort) %>% summarise(meanY = mean(RWI),
                                                                        Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1,cohort) %>% summarise(meanY = mean(RWI),
                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2, cohort) %>% summarise(meanY = mean(RWI),
                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()


legend <- get_legend(Y_MAP_marg)

png(height = 10, width = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_cohort_only_re_t_pr_dry_yrs_site_rs_inter/marginal_post_predictive_effects_ageclass.png")
plts <- plot_grid(Y_MAP_marg+theme(legend.position = "none"), Y_Tmax_marg+theme(legend.position = "none"), Y_DBH_marg+theme(legend.position = "none"), Y_RWI_1_marg+theme(legend.position = "none"), Y_RWI_2_marg+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()





# -------------------------- Plot future climate changes ------------------------------



```
 
# run model over full dataset to compare results: multi-level model with MAP as drought index, an INTERACTION between MAP and Tmax stand structure by ageclass random effects and prev years growth (lag -1) and (lag - 2), and a site level random intercept parameter: 

```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"

population_model_site_int_structure_x_cohort_re_lag2_temp_MAP_interaction.f <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] + beta7[struct.cohort[i]]*Temp.scaled[i]*DI.scaled[i] # inclued beta 7 as interaction term 
   

}



# Prediction from known data
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[site.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4[struct.cohort.p[i]]*log_RWI_1.p[i] +beta5[struct.cohort.p[i]]*log_RWI_2.p[i] + beta6[struct.cohort.p[i]]*Temp.scaled.p[i]+ beta7[struct.cohort.p[i]]*Temp.scaled.p[i]*DI.scaled.p[i]
  }

# probe for prediction plots:
  for(i in 1:nprobe){
    Yprobe[i]  ~ dnorm(muprobe[i],inv.var)
    muprobe[i] <- beta1[site.probe[i]] + beta2[struct.cohort.probe[i]]*DI.scaled.probe[i] + beta3[struct.cohort.probe[i]]*DBH.scaled.probe[i] +beta4[struct.cohort.probe[i]]*log_RWI_1.probe[i] + beta5[struct.cohort.probe[i]]*log_RWI_2.probe[i] + beta6[struct.cohort.probe[i]]*Temp.scaled.probe[i] + beta7[struct.cohort.probe[i]]*Temp.scaled.probe[i]*DI.scaled.probe[i]
  }

# project into the future (assuming no further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut[i]  ~ dnorm(mufut[i],inv.var)
    mufut[i] <- beta1[site.fut[i]] + beta2[struct.cohort.fut[i]]*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i] + (beta7[struct.cohort.fut[i]])*Temp.scaled.fut[i]*DI.scaled.fut[i]
  }

# project into the future (assuming 35% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.35[i]  ~ dnorm(mufut2[i],inv.var)
    mufut2[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.92)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]+ (beta7[struct.cohort.fut[i]])*Temp.scaled.fut[i]*DI.scaled.fut[i]
  }



# project into the future (assuming 50% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.50[i]  ~ dnorm(mufut3[i],inv.var)
    mufut3[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.85)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + beta6[struct.cohort.fut[i]]*Temp.scaled.fut[i]+ (beta7[struct.cohort.fut[i]])*Temp.scaled.fut[i]*DI.scaled.fut[i]
  }


# project into the future (assuming 8% further change in drought senseiivty & temperature):
  for(i in 1:nfut){
   Yfut.35.35[i]  ~ dnorm(mufut35[i],inv.var)
    mufut35[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.92)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + (beta6[struct.cohort.fut[i]]*1.08)*Temp.scaled.fut[i]+ (beta7[struct.cohort.fut[i]]*0.92)*Temp.scaled.fut[i]*DI.scaled.fut[i]
  }



# project into the future (assuming 7% further change in drought senseiivty):
  for(i in 1:nfut){
   Yfut.50.50[i]  ~ dnorm(mufut50[i],inv.var)
    mufut50[i] <- beta1[site.fut[i]] + (beta2[struct.cohort.fut[i]]*0.85)*DI.scaled.fut[i] + beta3[struct.cohort.fut[i]]*DBH.scaled.fut[i] +beta4[struct.cohort.fut[i]]*log_RWI_1.fut[i] +beta5[struct.cohort.fut[i]]*log_RWI_2.fut[i] + (beta6[struct.cohort.fut[i]]*1.15)*Temp.scaled.fut[i]+(beta7[struct.cohort.fut[i]]*0.85)*Temp.scaled.fut[i]*DI.scaled.fut[i]
  }

# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){

beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
beta5[s] ~ dnorm(mu_beta5, inv_beta5)
beta6[s] ~ dnorm(mu_beta6, inv_beta6)
beta7[s] ~ dnorm(mu_beta7, inv_beta7)
}


for(k in 1:Nsites){
beta1[k] ~ dnorm(mu_beta1, inv_beta1)
}


# use uniform priors for each  Mubeta paramters 
mu_beta1 ~ dunif(-1, 1)
mu_beta2 ~ dunif(-1, 1)
mu_beta3 ~ dunif(-1, 1)
mu_beta4 ~ dunif(-1, 1)
mu_beta5 ~ dunif(-1, 1)
mu_beta6 ~ dunif(-1, 1)
mu_beta7 ~ dunif(-1, 1)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)
inv_beta6   ~ dgamma(0.01, 0.01)
sigma_beta6 <- 1/sqrt(inv_beta6)
inv_beta7   ~ dgamma(0.01, 0.01)
sigma_beta7 <- 1/sqrt(inv_beta7)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)



# calculate differences between parameters:
one.two <- beta2[1] - beta2[2]
two.three<- beta2[2] - beta2[3]
three.four<- beta2[3] - beta2[4]
two.four <- beta2[2] - beta2[4]


}"

# save these for use later:
saveRDS(train, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_full_dataset/train.rds")
saveRDS(test, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_full_dataset/test.rds")
train <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_full_dataset/train.rds")
test <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_full_dataset/test.rds")
# assign site numbers to each site:

site.num.df <- data.frame(site = as.character(unique(train$site)), 
           site.num = 1:length(as.character(unique(train$site))))

# if site num is not in the df, add it
if(! "site.num" %in% colnames(train)){
    train <- merge(train, site.num.df, by = "site" )
    test <- merge(test, site.num.df, by = "site" )
}

# generate probe dataset:
 DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)
 DBHprobe <- round(seq(range(train$DBH.scaled)[1], range(train$DBH.scaled)[2], by = 0.75), 3)
 Tempprobe <- round(seq(range(train$T.scaled)[1], range(train$T.scaled)[2], by = 0.75), 3)
 RWI1probe <- round(seq(range(log(train$RWI_1))[1], range(log(train$RWI_1))[2], by = 0.5), 3)
 RWI2probe <- round(seq(range(log(train$RWI_2))[1], range(log(train$RWI_2))[2], by = 0.5), 3)
 
 # expand into full probe
probe <- expand.grid(DI.scaled = DIprobe, DBH.scaled = DBHprobe, T.scaled = Tempprobe,
                         RWI_1 = RWI1probe, RWI_2= RWI2probe, struct.cohort.code= 1:4, site.num = unique(train$site.num))

sit.cohorts <- unique(train[,c("struct.cohort.code", "site.num")])
probe <- merge(probe, sit.cohorts, by = c("struct.cohort.code", "site.num")) # make sure that each site only has savanna or forest in the probe

# make probe smaller to help with saving:
short.probe <- probe[probe$RWI_1 %in% c("-1.609", "0.391", "1.891") & probe$RWI_2 %in% c("-1.47", "0.03", "2.03") & probe$DBH.scaled %in% c("-0.376", "0.374", "1.874"),]

#short.probe <- probe

# make a probe for future climate projections at our sites!
rcp85 <- rcp85[!rcp85$site %in% c("COR", "GLL4", "HIC", "PLE", "PVC", "STC", "TOW"),]
future.probe_70 <- data.frame(MAP.scaled = rcp85$PR_85_70.scaled, DBH.scaled= -0.413, 
                              T.scaled = rcp85$Tx_70.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103,  struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_70$year <- 2070
future.probe_50 <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site,  model = rcp85$model)
future.probe_50$year <- 2050


# get climate averages from 1950 - present at each site:
train$struct.cohort.code2 <- as.numeric(train$struct.cohort.code)
train.clim.summary <-
  train[train$ageclass %in% "Modern", ] %>% group_by(site) %>% dplyr::summarise(
    MAP.scaled = mean(MAP.scaled),
    DBH.scaled = -0.413,
    T.scaled = mean(T.scaled),
    RWI_1 = 0.103,
    RWI_2 = 0.103,
    struct.cohort.code = mean(struct.cohort.code2),
    model = "none",
    year = 2000
    )



Average.prob <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_50$year <- 2050


fut <- rbind(future.probe_50, future.probe_70, train.clim.summary[,c("MAP.scaled", "DBH.scaled",  "T.scaled", "RWI_1", "RWI_2", "struct.cohort.code", "site","year","model")])


fut <- merge(fut, site.num.df, by = "site")

# look at the effects under two different DBH values
short.fut <- fut
fut.small <- fut
fut.large <- fut
fut.small$DBH.scaled <- -0.413
fut.large$DBH.scaled <- 1.900
long.fut <- rbind(fut.small, fut.large)


# look at the effects under average, below average, and above average different prev year growth values
lfut.low <- long.fut
lfut.avg <- long.fut
lfut.high <- long.fut

lfut.low$RWI_1 <- -1.609
lfut.low$RWI_2 <- -1.47

lfut.high$RWI_1 <- 1.891
lfut.high$RWI_2 <- 2.03

long.fut <- rbind(lfut.high, lfut.avg, lfut.low)

lag2.model.by_structure_x_cohort_t_pr_int <- jags.model(textConnection(population_model_site_int_structure_x_cohort_re_lag2_temp_MAP_interaction.f), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$MAP.scaled, DBH.scaled = train$DBH.scaled,log_RWI_1 = log(train$RWI_1),log_RWI_2 = log(train$RWI_2), Temp.scaled = train$T.scaled, struct.cohort = as.numeric(train$struct.cohort.code), SF = as.numeric(unique(train$struct.cohort.code)), site = train$site.num, Nsites = length(unique(train$site)),
                                
  struct.cohort.p = as.numeric(test$struct.cohort.code), DBH.scaled.p = test$DBH.scaled, DI.scaled.p = test$MAP.scaled, log_RWI_1.p = log(test$RWI_1), log_RWI_2.p = log(test$RWI_2), Temp.scaled.p = test$T.scaled, site.p = test$site.num, np = length(as.numeric(test$struct.cohort.code)), 
  
  struct.cohort.probe = as.numeric(short.probe$struct.cohort.code), DBH.scaled.probe = short.probe$DBH.scaled, DI.scaled.probe = short.probe$DI.scaled, log_RWI_1.probe = short.probe$RWI_1, log_RWI_2.probe =short.probe$RWI_2, Temp.scaled.probe = short.probe$T.scaled, site.probe = short.probe$site.num, nprobe = length(as.numeric(short.probe$struct.cohort.code)), 
 
  struct.cohort.fut = as.numeric(long.fut$struct.cohort.code), DBH.scaled.fut = long.fut$DBH.scaled, DI.scaled.fut = long.fut$MAP.scaled, log_RWI_1.fut = long.fut$RWI_1, log_RWI_2.fut =long.fut$RWI_2, Temp.scaled.fut = long.fut$T.scaled, site.fut = long.fut$site.num, nfut = length(as.numeric(long.fut$struct.cohort.code))
 
  
  ),
  n.chains = 3, n.adapt = 100)

update(lag2.model.by_structure_x_cohort_t_pr_int, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","beta6","beta7","sigma", "mu_beta1", "mu_beta2","mu_beta3", "mu_beta4","mu_beta5", "mu_beta6", "mu_beta7"), 
                    n.chains = 3, n.iter=10000, thin = 15)


beta2.diffs <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("one.two", "two.three", "three.four", "two.four"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Yp <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yp"), 
                    n.chains = 3, n.iter=10000, thin = 15)


Y.probe <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yprobe"), 
                    n.chains = 3, n.iter=5000, thin = 15)

Y.fut <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yfut"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yfut.35"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yfut.50"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.35.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yfut.35.35"), 
                    n.chains = 3, n.iter=10000, thin = 15)

Y.fut.50.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int, 
                     variable.names=c("Yfut.50.50"), 
                    n.chains = 3, n.iter=10000,thin = 15)


dic.full <- dic.samples(lag2.model.by_structure_x_cohort_t_pr_int, n.chains = 3, n.iter=10000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_full_dataset_DIC.rds")

summary(samp.structure.cohort.re)

traceplot(samp.structure.cohort.re)

# most just around 1
gelman.diag(samp.structure.cohort.re, multivariate = FALSE)
acfplot(samp.structure.cohort.re)


autocorr.plot(samp.structure.cohort.re [[1]][ , 'beta2[2]'], auto.layout = FALSE, lwd = 4, col = "red", lag.max = 100)

#Extract the samples for each parameter for a basic exploration of effects

 samps   <- samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_full_dataset/samps.rds")
 samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_full_dataset/samps.rds")
 #test.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/test.rds")
 #train.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/train.rds")
#Yfut.samps <- samps[, 1:length(fut$RWI_1)]
#samps <- samps[,(length(fut$RWI_1)+1):length(colnames(samps))]
 Yp.samps <- Yp
 Yprobe.samps <- Y.probe
 alpha.samps  <- samps[,1:16]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,17:20]
 beta3.samps <- samps[,21:24]
 beta4.samps <- samps[,25:28]
 beta5.samps <- samps[,29:32]
 beta6.samps <- samps[,33:36]
 beta7.samps <- samps[,37:40]
 #mu_beta.samps <- samps[,34:40]
 #sigma.samps <- samps[,36]
 #sigma_betas <- samps[,30:35]

 
 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps[[1]]) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))

test.dry.pair2 <- test.dry.pair
test.dry.pair2$variable <- unique(Yp.m$variable)

Yp.summary$Observed <- test.dry.pair$RWI



pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test.dry.pair$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)+theme_bw(base_size = 15)

# note best model fit so far
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_full_dataset/pred_vs_obs.png")
p.o.plot
dev.off()

# plot average growth boxplots for modern & past:

Yp.full <- left_join(Yp.m, test.dry.pair2, by = "variable")


# get estimates for predicted growth:
Yp.summary.cohort  <- Yp.full %>% group_by(struct.cohort) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025), 
                                                 Observed = mean(RWI))



ggplot(Yp.summary.cohort, aes(struct.cohort,Predicted, fill = struct.cohort))+geom_bar(stat = "identity")+geom_errorbar(data = Yp.summary.cohort,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.8, size = 0.5, width = 0.2)+ylim(0, 6)

#ggplot(Yp.summary.cohort, aes(class, Predicted, fill= class))+geom_boxplot()+facet_wrap(~DBHclass)
#ggplot(Yp.summary.cohourt, aes(class, Observed, fill= class))+geom_boxplot()+facet_wrap(~site)

# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test.dry.pair$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test.dry.pair$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_full_dataset", 
                            model.summary = "beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] + beta7[struct.cohort[i]]*Temp.scaled[i]*DI.scaled[i] ",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_full_dataset", 
                           train = "cohort.omit", 
                           DI.scaled = "MAP")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)



# get difference between beta2.samps: (i.e are they different?)
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]



# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- unique(train.dry.pair$site)#[order(unique(train.dry.pair[,c("site", "site.num")])[,2])])
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <-c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
#colnames(b2) <- c(paste0(c(unique(train.dry.pair$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope")

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH Index slope")


b4 <- data.frame(beta4.samps)
colnames(b4) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-1 Index slope")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-2 Index slope")

b6 <- data.frame(beta6.samps)
colnames(b6) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b6$num <- rownames(b6)
b6.m <- melt(b6, id.vars=c("num"))
b6.mplots <- ggplot(b6.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Summer Temperature slope")

b7 <- data.frame(beta7.samps)
colnames(b7) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b7$num <- rownames(b7)
b7.m <- melt(b7, id.vars=c("num"))
b7.mplots <- ggplot(b7.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precip*Temp slope")



png(height = 10, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_full_dataset/drougt_beta_marginal_distn_bycohort.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots, b5.mplots, b6.mplots, b7.mplots)
dev.off()

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

# ------------------------- DOTPLOT MODEL SUMMARIES -----------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:

a1.sum <- a.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
a1.sum$variable <- unique(train.dry.pair$site)

df.site.struct <- unique(train.dry.pair[,c("site", "structure")])
a1.sum <- merge(a1.sum, df.site.struct, by.x = "variable", by.y = "site")
a1.sum$structure <- factor(a1.sum$structure, levels = c( "Forest", "Savanna"))

b2.sum <- b2.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b3.sum <- b3.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b4.sum <- b4.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.sum <- b5.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b6.sum <- b6.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b7.sum <- b7.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b7.sum$variable <- factor(b7.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


# write out all the dotplots
int.dot <- ggplot(data.frame(a1.sum), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Savanna"='sienna4',
"Forest"='forestgreen'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot <- ggplot(data.frame(b2.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot <- ggplot(data.frame(b3.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot <- ggplot(data.frame(b4.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot <- ggplot(data.frame(b5.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -2 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot <- ggplot(data.frame(b6.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b7.dot <- ggplot(data.frame(b7.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Temp*Precip sensitivity (Beta7)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_full_dataset/full_dot_plot_cohort_struct.png")
plot_grid(int.dot , b2.dot, b6.dot, b7.dot , b3.dot, b4.dot, b5.dot, ncol = 1, align = "v")
dev.off()

```
 
 
 
 
 
 
# FOR DRY YEARS ONLY: multi-level model with MAP as drought index, an INTERACTION between MAP and Tmax stand structure by ageclass random effects and prev years growth (lag -1) and (lag - 2), and a site level random intercept parameter:
 
 In this version, we sample structural level parameters from a population mean of modern & past

```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"

population_model_site_int_structure_x_cohort_re_lag2_temp_MAP_interaction.heir.s <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[site[i]] + beta2[struct[i]]*DI.scaled[i] +   beta3[struct[i]]*DBH.scaled[i]+beta4[struct[i]]*log_RWI_1[i]+beta5[struct[i]]*log_RWI_2[i]  + beta6[struct[i]]*Temp.scaled[i] #+ beta7[struct[i]]*Temp.scaled[i]*DI.scaled[i] # inclued beta 7 as interaction term


}

#
#


# Assume normal priors for betas, but generate a beta + alpha for each ageclass + cohort

for(struct in 1:uniquestruct){
beta2[struct] ~ dnorm(mu_beta2[cohort[struct]], inv_beta2)
beta3[struct] ~ dnorm(mu_beta3[cohort[struct]], inv_beta3)
beta4[struct] ~ dnorm(mu_beta4[cohort[struct]], inv_beta4)
beta5[struct] ~ dnorm(mu_beta5[cohort[struct]], inv_beta5)
beta6[struct] ~ dnorm(mu_beta6[cohort[struct]], inv_beta6)
#beta7[struct] ~ dnorm(mu_beta7[cohort[struct]], inv_beta7)
}


for(k in 1:Nsites){
beta1[k] ~ dnorm(mu_beta1, inv_beta1)
}

for(s in 1:length(cohort)){

# use uniform priors for each  Mubeta paramters

mu_beta2[s] ~ dnorm(gam_beta2, inv_g_beta2)
mu_beta3[s] ~ dnorm(gam_beta3, inv_g_beta3)
mu_beta4[s] ~ dnorm(gam_beta4, inv_g_beta4)
mu_beta5[s] ~ dnorm(gam_beta5, inv_g_beta5)
mu_beta6[s] ~ dnorm(gam_beta6, inv_g_beta6)
#mu_beta7[s] ~ dnorm(gam_beta7, inv_g_beta7)

}



mu_beta1 ~ dunif(-2,2)

# use uniform priors for each  Mubeta paramters # check this
#gam_beta1 ~ dunif(-1, 1)
gam_beta2 ~ dunif(-1,1)
gam_beta3 ~ dunif(-1,1)
gam_beta4 ~ dunif(-1,1)
gam_beta5 ~ dunif(-1,1)
gam_beta6 ~ dunif(-1,1)
#gam_beta7 ~ dunif(-1,1)

inv_g_beta2   ~ dgamma(0.0001, 0.0001)
inv_g_beta3   ~ dgamma(0.0001, 0.0001)
inv_g_beta4   ~ dgamma(0.0001, 0.0001)
inv_g_beta5   ~ dgamma(0.0001, 0.0001)
inv_g_beta6   ~ dgamma(0.0001, 0.0001)
#inv_g_beta7   ~ dgamma(0.0001, 0.0001)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.1, 0.1)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)
inv_beta6   ~ dgamma(0.01, 0.01)
sigma_beta6 <- 1/sqrt(inv_beta6)
#inv_beta7   ~ dgamma(0.01, 0.01)
#sigma_beta7 <- 1/sqrt(inv_beta7)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.1, 0.1)
sigma     <- 1/sqrt(inv.var)

}"

# # save these for use later:
# saveRDS(train.dry.pair, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/train.rds")
# saveRDS(test.dry.pair, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/test.rds")
# train.dry.pair <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/train.rds")
# test.dry.pair <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/test.rds")
# # assign site numbers to each site:

site.num.df <- data.frame(site = as.character(unique(train$site)),
           site.num = 1:length(as.character(unique(train$site))))

# if site num is not in the df, add it
if(! "site.num" %in% colnames(train)){
    train <- merge(train, site.num.df, by = "site" )
    test.dry.pair <- merge(test.dry.pair, site.num.df, by = "site" )
}

# generate probe dataset:
 DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)
 DBHprobe <- round(seq(range(train$DBH.scaled)[1], range(train$DBH.scaled)[2], by = 0.75), 3)
 Tempprobe <- round(seq(range(train$T.scaled)[1], range(train$T.scaled)[2], by = 0.75), 3)
 RWI1probe <- round(seq(range(log(train$RWI_1))[1], range(log(train$RWI_1))[2], by = 0.5), 3)
 RWI2probe <- round(seq(range(log(train$RWI_2))[1], range(log(train$RWI_2))[2], by = 0.5), 3)

 # expand into full probe
probe <- expand.grid(DI.scaled = DIprobe, DBH.scaled = DBHprobe, T.scaled = Tempprobe,
                         RWI_1 = RWI1probe, RWI_2= RWI2probe, struct.cohort.code= 1:4, site.num = unique(train$site.num))

sit.cohorts <- unique(train[,c("struct.cohort.code", "site.num")])
probe <- merge(probe, sit.cohorts, by = c("struct.cohort.code", "site.num")) # make sure that each site only has savanna or forest in the probe

# make probe smaller to help with saving:
short.probe <- probe[probe$RWI_1 %in% c("-1.609", "0.391", "1.891") & probe$RWI_2 %in% c("-1.47", "0.03", "2.03") & probe$DBH.scaled %in% c("-0.376", "0.374", "1.874"),]

#short.probe <- probe

# make a probe for future climate projections at our sites!
rcp85 <- rcp85[!rcp85$site %in% c("COR", "GLL4", "HIC", "PLE", "PVC", "STC", "TOW"),]
future.probe_70 <- data.frame(MAP.scaled = rcp85$PR_85_70.scaled, DBH.scaled= -0.413,
                              T.scaled = rcp85$Tx_70.scaled,RWI_1 = 0.103,
                               RWI_2 = 0.103,  struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_70$year <- 2070
future.probe_50 <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413,
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103,
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site,  model = rcp85$model)
future.probe_50$year <- 2050


# get climate averages from 1950 - present at each site:
train$struct.cohort.code2 <- as.numeric(train$struct.cohort.code)
train.clim.summary <-
  train[train$ageclass %in% "Modern", ] %>% group_by(site) %>% dplyr::summarise(
    MAP.scaled = mean(MAP.scaled),
    DBH.scaled = -0.413,
    T.scaled = mean(T.scaled),
    RWI_1 = 0.103,
    RWI_2 = 0.103,
    struct.cohort.code = mean(struct.cohort.code2),
    model = "none",
    year = 2000
    )



Average.prob <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413,
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103,
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_50$year <- 2050


fut <- rbind(future.probe_50, future.probe_70, train.clim.summary[,c("MAP.scaled", "DBH.scaled",  "T.scaled", "RWI_1", "RWI_2", "struct.cohort.code", "site","year","model")])


fut <- merge(fut, site.num.df, by = "site")

# look at the effects under two different DBH values
short.fut <- fut
fut.small <- fut
fut.large <- fut
fut.small$DBH.scaled <- -0.413
fut.large$DBH.scaled <- 1.900
long.fut <- rbind(fut.small, fut.large)


# look at the effects under average, below average, and above average different prev year growth values
lfut.low <- long.fut
lfut.avg <- long.fut
lfut.high <- long.fut

lfut.low$RWI_1 <- -1.609
lfut.low$RWI_2 <- -1.47

lfut.high$RWI_1 <- 1.891
lfut.high$RWI_2 <- 2.03

long.fut <- rbind(lfut.high, lfut.avg, lfut.low)


train.pairs <- train[train$site %in% c("AVO", "BON", "ENG", "GLA", "GLL1", "GLL2", "GLL3", "MOU", "UNC"),]
ID.num <- data.frame(ID = unique(train.pairs$ID),
                     ID.num = 1:length(unique(train.pairs$ID)))

if(! "ID.num" %in% colnames(train.pairs)){
  train.pairs <- merge(train.pairs, ID.num, by = "ID")
  test.dry.pair <- merge(test.dry.pair, ID.num, by = "ID")
}



lag2.model.by_structure_x_cohort_t_pr_int <- jags.model(textConnection(population_model_site_int_structure_x_cohort_re_lag2_temp_MAP_interaction.heir.s),
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$MAP.scaled, DBH.scaled = train$DBH.scaled,log_RWI_1 = log(train$RWI_1),log_RWI_2 = log(train$RWI_2), Temp.scaled = train$T.scaled, cohort = as.numeric(train$ageclass), SF = as.numeric(unique(train$age)), site = train$site.num, Nsites = length(unique(train$site)), struct = train$struct.cohort.code2, uniquestruct = length(unique(train$struct.cohort.code2))#,#,

  #  struct.cohort.p = as.numeric(test.dry.pair$struct.cohort.code), DBH.scaled.p = test.dry.pair$DBH.scaled, DI.scaled.p = test.dry.pair$MAP.scaled, log_RWI_1.p = log(test.dry.pair$RWI_1), log_RWI_2.p = log(test.dry.pair$RWI_2), Temp.scaled.p = test.dry.pair$T.scaled, site.p = test.dry.pair$site.num, np = length(as.numeric(test.dry.pair$struct.cohort.code)), indiv.p = train.dry.pair$ID.num
  # #
  # struct.cohort.probe = as.numeric(short.probe$struct.cohort.code), DBH.scaled.probe = short.probe$DBH.scaled, DI.scaled.probe = short.probe$DI.scaled, log_RWI_1.probe = short.probe$RWI_1, log_RWI_2.probe =short.probe$RWI_2, Temp.scaled.probe = short.probe$T.scaled, site.probe = short.probe$site.num, nprobe = length(as.numeric(short.probe$struct.cohort.code)),
  #
  # struct.cohort.fut = as.numeric(long.fut$struct.cohort.code), DBH.scaled.fut = long.fut$DBH.scaled, DI.scaled.fut = long.fut$MAP.scaled, log_RWI_1.fut = long.fut$RWI_1, log_RWI_2.fut =long.fut$RWI_2, Temp.scaled.fut = long.fut$T.scaled, site.fut = long.fut$site.num, nfut = length(as.numeric(long.fut$struct.cohort.code))
  #
  #
  ),
  n.chains = 3, n.adapt = 100)

update(lag2.model.by_structure_x_cohort_t_pr_int, 10000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","beta6","sigma", "mu_beta1", "mu_beta2","mu_beta3", "mu_beta4","mu_beta5", "mu_beta6"),
                    n.chains = 3, n.iter=10000, thin = 15)

# tracplots for precip slopes:
traceplot(samp.structure.cohort.re[,"beta2[1]"])
traceplot(samp.structure.cohort.re[,"beta2[2]"])
traceplot(samp.structure.cohort.re[,"mu_beta2[3]"])
traceplot(samp.structure.cohort.re[,"mu_beta2[4]"])
# gelman.diag(samp.structure.cohort.re)
#
gam_beta_val <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
                     variable.names=c( "gam_beta2","gam_beta3","gam_beta4","gam_beta5","gam_beta6","gam_beta7"),
                    n.chains = 3, n.iter=10000, thin = 15)

#
# Yp <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yp"),
#                     n.chains = 3, n.iter=10000, thin = 15)
#
#
# Y.probe <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yprobe"),
#                     n.chains = 3, n.iter=5000, thin = 15)
#
# Y.fut <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yfut"),
#                     n.chains = 3, n.iter=10000, thin = 15)
#
# Y.fut.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yfut.35"),
#                     n.chains = 3, n.iter=10000, thin = 15)
#
# Y.fut.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yfut.50"),
#                     n.chains = 3, n.iter=10000, thin = 15)
#
# Y.fut.35.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yfut.35.35"),
#                     n.chains = 3, n.iter=10000, thin = 15)
#
# Y.fut.50.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yfut.50.50"),
#                     n.chains = 3, n.iter=10000,thin = 15)
#
#
dic.full <- dic.samples(lag2.model.by_structure_x_cohort_t_pr_int, n.chains = 3, n.iter=10000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_DIC.rds")
#
summary(samp.structure.cohort.re)
#
# traceplot(samp.structure.cohort.re)
#
# # most just around 1
gelman.diag(samp.structure.cohort.re, multivariate = FALSE)
#acfplot(samp.structure.cohort.re)
#
#
#autocorr.plot(samp.structure.cohort.re [[1]][ , 'beta2[1]'], auto.layout = FALSE, lwd = 4, col = "red", lag.max = 100)
#
# #Extract the samples for each parameter for a basic exploration of effects
#
  samps       <- samp.structure.cohort.re[[1]]
#  saveRDS(samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/samps.rds")
#  samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/samps.rds")
#  #test.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/test.rds")
#  #train.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/train.rds")
# #Yfut.samps <- samps[, 1:length(fut$RWI_1)]
# #samps <- samps[,(length(fut$RWI_1)+1):length(colnames(samps))]
#  Yp.samps <- Yp
#  Yprobe.samps <- Y.probe
 alpha.samps  <- samps[,1:9]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,10:(9+ length(unique(train.pairs$ID)))]
 beta3.samps <- samps[,(9+ length(unique(train.pairs$ID))+ 1):(9+ length(unique(train.pairs$ID))*2)]
 beta4.samps <- samps[,(9+ length(unique(train.pairs$ID))*2+ 1):(9+ length(unique(train.pairs$ID))*3)]
 beta5.samps <- samps[,(9+ length(unique(train.pairs$ID))*3+ 1):(9+ length(unique(train.pairs$ID))*4)]
 beta6.samps <- samps[,(9+ length(unique(train.pairs$ID))*4+ 1):(9+ length(unique(train.pairs$ID))*5)]
# beta7.samps <- samps[,(9+ length(unique(train.pairs$ID))*5+ 1):(9+ length(unique(train.pairs$ID))*6)]
 

 start_mu<- (9+ length(unique(train.pairs$ID))*5 + 2)
 
 mu_beta1.samps <- samps[,start_mu]
 # in this model we have a individual tree level estimate for each parameter
 mu_beta2.samps <- samps[, start_mu:( start_mu + 3)]
 mu_beta3.samps <- samps[,(4+ start_mu):(4+ start_mu + 3)]
 mu_beta4.samps <- samps[,(8+ start_mu):(8+ start_mu + 3)]
 mu_beta5.samps <- samps[,(12+ start_mu):(12+ start_mu + 3)]
 mu_beta6.samps <- samps[,(16+ start_mu):(16+ start_mu + 3)]
 mu_beta7.samps <- samps[,(20+ start_mu):(20+ start_mu + 3)]
 #mu_beta7.samps <- samps[,(24+ start_mu):(24+ start_mu + 3)]
 
 sigma.samps <- samps[,36]
 sigma_betas <- samps[,30:35]



# # plot predicted vs observed and assess model fit:
# Yp.samps <- data.frame(Yp.samps[[1]])
# Yp.m <- melt(Yp.samps)
# Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
#                                                   ci.hi = quantile(exp(value),0.975),
#                                                  ci.lo = quantile(exp(value),0.025))
# Yp.summary$Observed <- test.dry.pair$RWI
#
# pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test.dry.pair$RWI))
#
# p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)+theme_bw(base_size = 15)
#
# # note best model fit so far
# png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/pred_vs_obs.png")
# p.o.plot
# dev.off()
#
#
# # calculate MSE & BIAS:
#
# MSE1   <- mean((colMeans(exp(Yp.samps))-test.dry.pair$RWI)^2)
# BIAS1  <- mean(colMeans(exp(Yp.samps))-test.dry.pair$RWI)
#
# # write model summary output to a file!
#
# model.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter",
#                             model.summary = "beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] + beta7[struct.cohort[i]]*Temp.scaled[i]*DI.scaled[i] ",
#            MSE = MSE1,
#            BIAS = BIAS1,
#            Rsq = pred.obs$r.squared)
#
# write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)
#
#
# # summarise the datasource to make model comparisons for best fit models
# data.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter",
#                            train = "cohort.omit.dry.years",
#                            DI.scaled = "MAP")
#
# write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)
#
#
#
# # get difference between beta2.samps: (i.e are they different?)
# oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
# oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
# oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
# twominusthree <- beta2.samps[,2] - beta2.samps[,3]
# twominusfour <- beta2.samps[,2] - beta2.samps[,4]
# threeminusfour <- beta2.samps[,3] - beta2.samps[,4]
#
#
#
# # plot marginal distributions of each parameter:
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_alphas.png")
# par(mfrow=c(3,2))
# hist(alpha.samps[,1], main = "alpha Past-Forest")
# hist(alpha.samps[,2], main = "alpha Modern-Forest")
# hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
# hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
# hist(sigma_betas[,1], main = "sigma alpha")
# dev.off()
#
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_beta1s.png")
# par(mfrow=c(3,2))
# hist(beta2.samps[,1], main = "beta2 Past-Forest")
# hist(beta2.samps[,2], main = "beta2 Modern-Forest")
# hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
# hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
# hist(sigma_betas[,2], main = "sigma beta2")
# dev.off()
#
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_beta2s.png")
# par(mfrow=c(3,2))
# hist(beta3.samps[,1], main = "beta3 Past-Forest")
# hist(beta3.samps[,2], main = "beta3 Modern-Forest")
# hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
# hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
# hist(sigma_betas[,3], main = "sigma beta3")
# dev.off()
#
#
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_beta3s.png")
# par(mfrow=c(3,2))
# hist(beta4.samps[,1], main = "beta4 Past-Forest")
# hist(beta4.samps[,2], main = "beta4 Modern-Forest")
# hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
# hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
# hist(sigma_betas[,4], main = "sigma beta4")
# dev.off()
#
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_beta4s.png")
# par(mfrow=c(3,2))
# hist(beta5.samps[,1], main = "beta5 Past-Forest")
# hist(beta5.samps[,2], main = "beta5 Modern-Forest")
# hist(beta5.samps[,3],  main = "beta5 Past-Savanna")
# hist(beta5.samps[,4],  main = "beta5 Modern-Savanna")
# hist(sigma_betas[,5], main = "sigma beta5")
# dev.off()
#
#
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_beta5s.png")
# par(mfrow=c(3,2))
# hist(beta5.samps[,1], main = "beta4 Past-Forest")
# hist(beta5.samps[,2], main = "beta4 Modern-Forest")
# hist(beta5.samps[,3],  main = "beta4 Past-Savanna")
# hist(beta5.samps[,4],  main = "beta4 Modern-Savanna")
# hist(sigma_betas[,6], main = "sigma beta4")
# dev.off()
#
# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- unique(train.dry.pair$site)#[order(unique(train.dry.pair[,c("site", "site.num")])[,2])])
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(mu_beta2.samps)
colnames(b2) <-c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
#colnames(b2) <- c(paste0(c(unique(train.dry.pair$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope")+xlim(-0.1, 1)

b3 <- data.frame(mu_beta3.samps)
colnames(b3) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH Index slope")


b4 <- data.frame(mu_beta4.samps)
colnames(b4) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-1 Index slope")

b5 <- data.frame(mu_beta5.samps)
colnames(b5) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-2 Index slope")

b6 <- data.frame(mu_beta6.samps)
colnames(b6) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b6$num <- rownames(b6)
b6.m <- melt(b6, id.vars=c("num"))
b6.mplots <- ggplot(b6.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Summer Temperature slope")

b7 <- data.frame(mu_beta7.samps)
colnames(b7) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b7$num <- rownames(b7)
b7.m <- melt(b7, id.vars=c("num"))
b7.mplots <- ggplot(b7.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precip*Temp slope")



# get the mu_beta samples from each individual:

bmu2 <- data.frame(beta2.samps)
#colnames() <-c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
#colnames(b2) <- c(paste0(c(unique(train.dry.pair$struct.cohort))))
bmu2$num <- rownames(bmu2)
bmu2.m <- melt(bmu2, id.vars=c("num"))
bmu2.mplots <- ggplot(bmu2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope by indiv")+theme(legend.position = "none")+xlim(-0.6,0.6)


png(height = 10, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_heir/drougt_beta_marginal_distn_bycohort.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots, b5.mplots, b6.mplots, b7.mplots)
dev.off()

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

# ------------------------- DOTPLOT MODEL SUMMARIES -----------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:

a1.sum <- a.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
a1.sum$variable <- unique(train.dry.pair$site)

df.site.struct <- unique(train.dry.pair[,c("site", "structure")])
a1.sum <- merge(a1.sum, df.site.struct, by.x = "variable", by.y = "site")
a1.sum$structure <- factor(a1.sum$structure, levels = c( "Forest", "Savanna"))

b2.sum <- b2.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b3.sum <- b3.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b4.sum <- b4.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.sum <- b5.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b6.sum <- b6.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b7.sum <- b7.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b7.sum$variable <- factor(b7.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


# write out all the dotplots
int.dot <- ggplot(data.frame(a1.sum), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Savanna"='sienna4',
"Forest"='forestgreen'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot <- ggplot(data.frame(b2.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.3)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot <- ggplot(data.frame(b3.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot <- ggplot(data.frame(b4.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot <- ggplot(data.frame(b5.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot <- ggplot(data.frame(b6.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b7.dot <- ggplot(data.frame(b7.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Temp*Precip sensitivity (Beta7)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_heir/full_dot_plot_cohort_struct.png")
plot_grid(int.dot, b2.dot, b6.dot, b3.dot, b4.dot, b5.dot, ncol = 1, align = "v")
dev.off()


#
# # get individual dot plots for each parameter:
#
bmu2.sum <- bmu2.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.05),
                                                   Ci.high = quantile(value, 0.95))

train.unique <- data.frame(unique(train.pairs[, c("site", "ID", "ageclass", "struct.cohort", "ID.num")]))
train.unique $variable <- paste0("beta2.",train.unique $ID.num, "." )

bmu2.sum2 <- left_join(train.unique , bmu2.sum, by = "variable")


bmu2.sum2 <- bmu2.sum2 %>% arrange(mean.val)
bmu2.sum2$variable <- factor(bmu2.sum2$variable, levels = unique(bmu2.sum2$variable))

ggplot(data.frame(bmu2.sum2), aes(x = mean.val, y = variable, color = ageclass,size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+theme( axis.title.y = element_blank())+geom_vline(xintercept = 0, linetype = "dashed", color = "red")
#
# # -------------------- DOTPLOTS by modern vs. past only ---------------------
# # make dotplots for all the factors in the model--
# # get summaries by struct-cohort class from the melted samples:
# # a does not vary by cohort
# a1.sum.age <- a1.sum
#
# b2.m$cohort <- ifelse(b2.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
# b2.sum.age <- b2.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
#                                                    Ci.low = quantile(value, 0.025),
#                                                    Ci.high = quantile(value, 0.975))
# #b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
#
# b3.m$cohort <- ifelse(b3.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
#
# b3.sum.age <- b3.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
#                                                    Ci.low = quantile(value, 0.025),
#                                                    Ci.high = quantile(value, 0.975))
# #b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
#
# b4.m$cohort <- ifelse(b4.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
#
# b4.sum.age <- b4.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
#                                                    Ci.low = quantile(value, 0.025),
#                                                    Ci.high = quantile(value, 0.975))
# #b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
#
# b5.m$cohort <- ifelse(b5.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
#
# b5.sum.age <- b5.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
#                                                    Ci.low = quantile(value, 0.025),
#                                                    Ci.high = quantile(value, 0.975))
# #b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
# b6.m$cohort <- ifelse(b6.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
#
# b6.sum.age <- b6.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
#                                                    Ci.low = quantile(value, 0.025),
#                                                    Ci.high = quantile(value, 0.975))
# #b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
# b7.m$cohort <- ifelse(b7.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
#
# b7.sum.age <- b7.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
#                                                    Ci.low = quantile(value, 0.025),
#                                                    Ci.high = quantile(value, 0.975))
#
#
# # write out all the dotplots
# int.dot.age <- ggplot(data.frame(a1.sum.age), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")
#
# b2.dot.age <- ggplot(data.frame(b2.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")
#
# b3.dot.age <- ggplot(data.frame(b3.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")
#
# b4.dot.age <- ggplot(data.frame(b4.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")
#
# b5.dot.age <- ggplot(data.frame(b5.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")
#
#
# b6.dot.age <- ggplot(data.frame(b6.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")
#
# b7.dot.age <- ggplot(data.frame(b7.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Temp*Precip sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")
#
#
# png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_dot_plot_cohort_only.png")
# plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b7.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1, align = "v")
# dev.off()
#
#
# png(height = 14, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_dot_plot_cohort_only.png")
# plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b7.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1)
# dev.off()
#
#
# png(height = 14, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_dot_plot_cohort_and_cohortXstruct.png")
# plot_grid(int.dot.age,int.dot,
#          b2.dot.age , b2.dot,
#          b6.dot.age, b6.dot,
#          b7.dot.age, b7.dot,
#          b3.dot.age, b3.dot,
#          b4.dot.age,  b4.dot,
#          b5.dot.age, b5.dot, ncol = 2, align = "hv", labels = c("a","h",
#                                                                 "b","i",
#                                                                 "c","j",
#                                                                 "d","k",
#                                                                 "e","l",
#                                                                 "f","m",
#                                                                 "g","n"), label_x = 0.4)
# dev.off()
#
# # ------------------ Do the site level intercepts correlate with site quality -----------
# # read in information about site quality:
# locs <- read.csv("outputs/priority_sites_locs_with_soil_clim.csv")
# locs <- data.frame(locs)
# locs$code <- as.character(locs$code)
# locs[9:12,]$code <- c( "GLL1", "GLL2", "GLL3", "GLL4")
# sites <- c("COR", "HIC", "STC", "GLA", "TOW", "ENG", "UNC", "BON", "MOU", "GLL4", "GLL3", "GLL2", "GLL1", "PVC", "AVO", "PLE", "UNI")
# 
# # merge with a1.sum.age
# site.summary <- merge(a1.sum.age, locs, by.x = "variable", by.y = "code")
# 
# # plot mean + 95% confidence interval vs. MAP
# alpha.pr30yr <-ggplot(site.summary, aes(x = pr30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("Total Precip")
# # get an idea if there might be relationship
# summary(lm(mean.val ~ pr30yr,data = site.summary))
# 
# # plot mean + 95% confidence interval vs. Tmean
# alpha.tm30yr <-ggplot(site.summary, aes(x = tm30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("Mean Temp")
# # get an idea if there might be relationship
# summary(lm(mean.val ~ tm30yr,data = site.summary))
# 
# # plot mean + 95% confidence interval vs. sand %
# alpha.sand <-ggplot(site.summary, aes(x = sand, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("sand")#+stat_smooth(method = "lm")
# # get an idea if there might be relationship
# summary(lm(mean.val ~ sand,data = site.summary))
# 
# # plot mean + 95% confidence interval vs. ksat
# alpha.ksat <-ggplot(site.summary, aes(x = ksat, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("ksat")
# # get an idea if there might be relationship
# summary(lm(mean.val ~ ksat,data = site.summary))
# 
# # plot mean + 95% confidence interval vs. awc
# 
# alpha.awc <- ggplot(site.summary, aes(x = awc, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("AWC")
# # get an idea if there might be relationship
# summary(lm(mean.val ~ awc,data = site.summary))
# 
# # plot mean + 95% confidence interval vs. n. species 
# 
# alpha.nspecies <- ggplot(site.summary, aes(x = nspecies, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("nspecies")#+stat_smooth(data = site.summary, aes(x = nspecies, y = mean.val), method = "lm")
# 
# # there seems to be no relationship between alpha and site characteristics
# # but plot the relationships out here:
# png(height = 10, width = 4, units = "in",res = 200, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_site_rs/alpha_site_ints_vs_site_quality.png")
# plot_grid(alpha.pr30yr, alpha.tm30yr, alpha.awc, alpha.sand, alpha.nspecies, ncol = 1, align = "v")
# dev.off()
# 
# #---------------------- More beta summary plots -----------------------------
# png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/drougt_beta_marginal_distn_bycohort.png")
# plot_grid(b2.dots, b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.6))
# dev.off()
# 
# # plot slightly differently:
# plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")
# 
# plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
# plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))
# 
# b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
# "Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")
# 
# png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_site_rs/param_marginal_distn_bycohort_struct_rb.png")
# b2.dots.2
# dev.off()
# 
# b3 <- data.frame(beta3.samps)
# colnames(b3) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
# b3$num <- rownames(b3)
# b3.m <- melt(b3, id.vars=c("num"))
# b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")
# 
# b4 <- data.frame(beta4.samps)
# colnames(b4) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
# b4$num <- rownames(b4)
# b4.m <- melt(b4, id.vars=c("num"))
# b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")
# 
# b5 <- data.frame(beta5.samps)
# colnames(b5) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
# b5$num <- rownames(b5)
# b5.m <- melt(b5, id.vars=c("num"))
# b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")
# 
# library(cowplot)
# png(width = 5, height = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/param_marginal_distn_bycohort_struct_1.png")
# plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, b5.mplots,ncol = 1)
# dev.off()
# 
# # --------------------make plots of probed predicted growth responses:
# # plot probed values of tree growth predictions:
# Yprobe <- data.frame(Yprobe.samps[[1]])
# colnames(Yprobe) <- 1:length(Yprobe)
# probe.m <- melt(Yprobe)
# probe.m$RWI <- exp(probe.m$value) 
# colnames(probe.m) <- c("num", "Ypred", "RWI")
# 
# probe <- short.probe
# probe$num <- 1:length(probe[,1])
# colnames(probe) <- c("Drought", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort","site", "num")
# 
# # summarize by structure + cohort class only:
# # summarize by structure + cohort class only:
# probe$num <- as.factor(as.character(probe$num))
# full.p <- probe
# 
# probtest.dry.pair <- dplyr::inner_join(probe.m, full.p, by=c("num"))
# 
# prob <- probtest.dry.pair
# # save here:
# saveRDS(prob, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_yprobe_preds.rds")
# prob <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_yprobe_preds.rds")
# 
# 
# 
# 
# # convert prob$Drought back to MAP:
# library(DMwR)
# DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)
# 
# 
# 
# prob$DBH <- as.numeric(round(unscale(vals = prob$DBH, norm.data = DBH.scaled))) 
# prob$MAP <- as.numeric(round(unscale(vals = prob$Drought, norm.data = MAP.scaled)))
# prob$Tmax <- as.numeric(round(unscale(vals = prob$Tmax, norm.data = T.scaled))) 
# 
# 
# prob_10_60cm_avg <- prob %>% dplyr::filter(DBH == 27 | DBH == 39 | DBH == 63 ,  RWI_1 == 0.391, RWI_2 == 0.03 ) 
# 
#  struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
#  struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
#  prob_10_60cm_avg <- merge(prob_10_60cm_avg,struc.conversion, by  = "struct.cohort")
#  
#  
# preds_ci_10 <- prob_10_60cm_avg %>% group_by(DBH, Drought, MAP,Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# preds_ci_10_age <- prob_10_60cm_avg %>% group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# # same thing but with LOWER than average tree growth the years before:
# 
# prob_10_60cm_low <- prob %>% dplyr::filter(DBH == 27 | DBH == 39 | DBH == 63 ,  RWI_1 == -1.609, RWI_2 == -1.47 ) 
# 
#  
#  prob_10_60cm_low <- merge(prob_10_60cm_low, struc.conversion, by  = "struct.cohort")
#  
#  
# preds_ci_10_low <- prob_10_60cm_low %>% group_by(DBH, Drought,MAP, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# 
# preds_ci_10_low_age <- prob_10_60cm_low %>% group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# # same thing but with HIGHER than average tree growth the years before:
# 
# prob_10_60cm_high <- prob %>% dplyr::filter(DBH == 27 | DBH == 39 | DBH == 63 , RWI_1 == 1.891, RWI_2 == 2.03  ) 
# 
# 
#  prob_10_60cm_high <- merge(prob_10_60cm_high, struc.conversion, by  = "struct.cohort")
#  
#  
# preds_ci_10_high <- prob_10_60cm_high %>% group_by(DBH, Drought,MAP, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# preds_ci_10_high_age <- prob_10_60cm_high %>% group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# #----------- plot drought response by max temperature and Dimaeter + cohort-struct class -----------
# 
# Drought.resp.DBH.temp.avgpyr <- ggplot(preds_ci_10, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()
# 
# 
# 
# Drought.resp.DBH.temp.lowpyr <- ggplot(preds_ci_10_low, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()
# 
# 
# Drought.resp.DBH.temp.highpyr <- ggplot(preds_ci_10_high, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()
# 
# 
# # output the above plots to PNG:
# png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_low_prevyr_high_temp_low_high_DBH.png")
# Drought.resp.DBH.temp.lowpyr 
# dev.off()
# 
# png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_avg_prevyr_high_temp_low_high_DBH.png")
# Drought.resp.DBH.temp.avgpyr 
# dev.off()
# 
# png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_high_prevyr_high_temp_low_high_DBH.png")
# Drought.resp.DBH.temp.highpyr 
# dev.off()
# 
# 
# #----------- plot drought response by max temperature and Dimaeter + AGECLASS -----------
# 
# Drought.resp.DBH.temp.avgpyr.age <- ggplot(preds_ci_10_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()
# 
# 
# 
# 
# Drought.resp.DBH.temp.lowpyr.age <- ggplot(preds_ci_10_low_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_10_low_age,aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()
# 
# 
# Drought.resp.DBH.temp.highpyr.age <- ggplot(preds_ci_10_high_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()
# 
# 
# # output the above plots to PNG:
# png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_low_prevyr_high_temp_low_high_DBH_ageclass.png")
# Drought.resp.DBH.temp.lowpyr.age 
# dev.off()
# 
# png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_avg_prevyr_high_temp_low_high_DBH_ageclass.png")
# Drought.resp.DBH.temp.avgpyr.age+theme_bw(base_size = 14)
# dev.off()
# 
# png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_high_prevyr_high_temp_low_high_DBH_ageclass.png")
# Drought.resp.DBH.temp.highpyr.age 
# dev.off()
# 
# 
# 
# 
# 
# #--------------- plot marginal effects of climate and previous years growth ----------------
# 
#  struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
#  struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
# 
#  prob <- left_join(prob, struc.conversion, by  = "struct.cohort")
# 
#  # Marginal MAP effect:
# preds_ci_mod_past_MAP <- prob %>% group_by( MAP, ageclass) %>% summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_MAP_marg <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
#   geom_ribbon(data = preds_ci_mod_past_MAP,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()
# 
# 
# # marginal TMAX effect
# preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax,ageclass) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_Tmax_marg <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()
# 
# # marginal DBH effect
# preds_ci_mod_past_DBH <- prob %>% group_by( DBH,ageclass) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_DBH_marg <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()
# 
# # marginal lag-1 effect
# preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1,ageclass) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_RWI_1_marg <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()
# 
# # marginal lag-2 effect
# preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2,ageclass) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_RWI_2_marg <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()
# 
# 
# legend <- get_legend(Y_MAP_marg)
# 
# png(height = 10, width = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_post_predictive_effects_ageclass.png")
# plts <- plot_grid(Y_MAP_marg+theme(legend.position = "none"), Y_Tmax_marg+theme(legend.position = "none"), Y_DBH_marg+theme(legend.position = "none"), Y_RWI_1_marg+theme(legend.position = "none"), Y_RWI_2_marg+theme(legend.position = "none"), align = "v", ncol = 1)
# plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
# dev.off()
# 
# # --------------plot marginal effects for each stand structure and cohort class:
# # plot marginal effects of climate and previous years growth 
# # Marginal MAP effect:
# preds_ci_mod_past_MAP <- prob %>% group_by( MAP, cohort) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_MAP_marg_c <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_MAP, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Total Precipitation")
# 
# 
# # marginal TMAX effect
# preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, cohort) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_Tmax_marg_c <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Max. Temperature (DegF)")
# 
# # marginal DBH effect
# preds_ci_mod_past_DBH <- prob %>% group_by( DBH, cohort) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_DBH_marg_c <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Tree DBH (cm)")
# 
# # marginal lag-1 effect
# preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1, cohort) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_RWI_1_marg_c <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-1) year's growth)")
# 
# # marginal lag-2 effect
# preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2, cohort) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_RWI_2_marg_c <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-2) year's growth)")
# 
# png(height = 10, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_site_rs/marginal_post_predictive_effects_ageclassXStruct.png")
# legend <- get_legend(Y_MAP_marg_c)
# plts <- plot_grid(Y_MAP_marg_c+theme(legend.position = "none"), Y_Tmax_marg_c+theme(legend.position = "none"), Y_DBH_marg_c+theme(legend.position = "none"), Y_RWI_1_marg_c+theme(legend.position = "none"), Y_RWI_2_marg_c+theme(legend.position = "none"), align = "v", ncol = 1)
# plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.45))
# dev.off()
# 
# 
# # ------------- plot the marginal effects of each model parameter by site: ---------------
# 
# preds_ci_mod_past_MAP_site <- prob %>% group_by( MAP, ageclass, site) %>% summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_MAP_marg_site <- ggplot(preds_ci_mod_past_MAP_site, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
#   geom_ribbon(data = preds_ci_mod_past_MAP_site,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)
# 
# # marginal TMAX effect
# preds_ci_mod_past_Tmax_site <- prob %>% group_by( Tmax,ageclass, site) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_Tmax_marg_site <- ggplot(preds_ci_mod_past_Tmax_site, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax_site, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()+facet_wrap(~site)
# 
# # marginal DBH effect
# preds_ci_mod_past_DBH_site <- prob %>% group_by( DBH,ageclass, site) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_DBH_marg_site <- ggplot(preds_ci_mod_past_DBH_site, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH_site, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()+facet_wrap(~site)
# 
# # marginal lag-1 effect
# preds_ci_mod_past_RWI1_site <- prob %>% group_by( RWI_1,ageclass, site) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_RWI_1_marg_site <- ggplot(preds_ci_mod_past_RWI1_site, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1_site, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)
# 
# # marginal lag-2 effect
# preds_ci_mod_past_RWI2_site <- prob %>% group_by( RWI_2, ageclass, site) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_RWI_2_marg_site <- ggplot(preds_ci_mod_past_RWI2_site, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2_site, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)
# 
# 
# legend <- get_legend(Y_MAP_marg_site)
# 
# png(height = 25, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_post_predictive_effects_ageclass_by_site.png")
# plts <- plot_grid(Y_MAP_marg_site+theme(legend.position = "none"), Y_Tmax_marg_site+theme(legend.position = "none"), Y_DBH_marg_site+theme(legend.position = "none"), Y_RWI_1_marg_site+theme(legend.position = "none"), Y_RWI_2_marg_site+theme(legend.position = "none"), align = "v", ncol = 1)
# plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
# dev.off()
# 
# 
# # below is some extra code
# 
# 
# 
# # ----------------------- Plot future predictions ------------------------
# fut <- long.fut
# # scenario # 1: no change from modern
# Yfut.samps <- data.frame(Y.fut[[1]])
# 
# colnames(Yfut.samps) <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# Yfut.samps$num <- 1:length(Yfut.samps[,2])
# fut.m <- melt(Yfut.samps)
# fut.m$RWI <- exp(fut.m$value)
# colnames(fut.m) <- c("site_year", "Ypred", "RWI")
# 
# fut$site_year <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# fut$scenario <- "constant"
# colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort","model",  "year", "site.num","site_year", "scenario")
# 
# # summarize by structure + cohort class only:
# 
# fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))
# 
# 
# # scenario # 2: 35% decrease in drought sensitivie from modern
# Yfut.35.samps <- data.frame(Y.fut.35[[1]])
# 
# colnames(Yfut.35.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# Yfut.35.samps$num <- 1:length(Yfut.35.samps[,2])
# fut.35.m <- melt(Yfut.35.samps)
# fut.35.m $RWI <- exp(fut.35.m $value)
# colnames(fut.35.m ) <- c("site_year", "Ypred", "RWI")
# 
# fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# fut$scenario <- "decrease_35"
# colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")
# 
# fut.35.proj <- dplyr::inner_join(fut.35.m, fut, by=c("site_year"))
# 
# 
# # scenario # 3: 50% decrease in drought sensitivie from modern
# Yfut.50.samps <- data.frame(Y.fut.50[[1]])
# 
# colnames(Yfut.50.samps) <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# Yfut.50.samps$num <- 1:length(Yfut.50.samps[,2])
# fut.50.m <- melt(Yfut.50.samps)
# fut.50.m $RWI <- exp(fut.50.m $value)
# colnames(fut.50.m ) <- c("site_year", "Ypred", "RWI")
# 
# fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# fut$scenario <- "decrease_50"
# colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")
# 
# fut.50.proj <- dplyr::inner_join(fut.50.m, fut, by=c("site_year"))
# 
# # scenario # 4: 50% decrease in drought sensitivy from modern & 50% increase in T sensitivity
# Yfut.35.35.samps <- data.frame(Y.fut.35.35[[1]])
# 
# colnames(Yfut.35.35.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# Yfut.35.35.samps$num <- 1:length(Yfut.35.35.samps[,2])
# fut.35.35.m <- melt(Yfut.35.35.samps)
# fut.35.35.m $RWI <- exp(fut.35.35.m $value)
# colnames(fut.35.35.m ) <- c("site_year", "Ypred", "RWI")
# 
# fut$site_year <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# fut$scenario <- "decrease_35.35"
# colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")
# 
# fut.35.35.proj <- dplyr::inner_join(fut.35.35.m, fut, by=c("site_year"))
# 
# 
# 
# # scenario # 5: 50% decrease in drought sensitivy from modern & 50% increase in T sensitivity
# Yfut.50.50.samps <- data.frame(Y.fut.50.50[[1]])
# 
# colnames(Yfut.50.50.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# Yfut.50.50.samps$num <- 1:length(Yfut.50.50.samps[,2])
# fut.50.50.m <- melt(Yfut.50.50.samps)
# fut.50.50.m $RWI <- exp(fut.50.50.m $value)
# colnames(fut.50.50.m ) <- c("site_year", "Ypred", "RWI")
# 
# fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# fut$scenario <- "decrease_50.50"
# colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")
# 
# fut.50.50.proj <- dplyr::inner_join(fut.50.50.m, fut, by=c("site_year"))
# 
# 
# # now join all together :
# all.proj <- rbind(fut.proj, fut.35.proj[!fut.35.proj$year == 2000,], fut.50.proj[!fut.50.proj$year == 2000,], fut.35.35.proj[!fut.35.35.proj$year == 2000,], fut.50.50.proj[!fut.50.50.proj$year == 2000,])
# 
# 
# 
# # ------------ For 26 cm tree and average prev years growth ----------------------
# small.proj <- all.proj[all.proj$DBH == -0.413 & all.proj$RWI_1 == 0.103 & all.proj$RWI_2 == 0.103,]
# small.proj$year <- ifelse(small.proj$year == 2050, "2050-2069",
#                           ifelse(small.proj$year == 2070, "2070-2099", "2000"))
# scenario_names <- c(
#                     'constant' = "sensitivity constant",
#                     'decrease_35' = "drought (taper 8%)",
#                     'decrease_35.35' = "drought & temp. (taper 8%)",
#                     'decrease_50.50' = "drought & temp. (no taper 15%)",
#                     'decrease_50' = "drought (no taper 15%)"
#                     )
# 
# 
# 
# # make one big plot for average previous years growth 
# by.scenario <- ggplot(small.proj[!small.proj$year == 2000, ], aes(year, RWI, fill = as.character(year)))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000,]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+facet_grid(~ model + scenario)+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c("blue", "red"))+theme(legend.title = element_blank())
# 
# 
# png(height = 4, width = 12, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/fut_growth_by_scenarios_26cm_avg_growth.png")
# by.scenario+theme(legend.position = "none")
# dev.off()
# 
# 
# by.period <- ggplot(small.proj[!small.proj$year == 2000 , ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
# ))+theme(legend.title = element_blank())
# 
# png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/fut_growth_by_time_scenarios_26cm_avg_growth.png")
# by.period
# dev.off()
# 
# by.model <- ggplot(small.proj[!small.proj$year == 2000, ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
# ))+theme(legend.title = element_blank())+facet_grid(rows = vars(scenario), cols = vars(model))
# 
# 
# 
# png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/fut_growth_by_model_26cm_avg_growth.png")
# by.model
# dev.off()
# 
# small.proj$model <- factor(small.proj$model, levels = c("INMCM4", "HadGEM-ES2", "MIROC"))
# model_names <- c(
#                     'INMCM4' = "INMCM4 \n low Tmax - low Precip",
#                     'HadGEM-ES2' = "HadGEM-ES2 \n high Tmax - low Precip",
#                     'MIROC' = "MIROC \n high Tmax - high Precip"
#                     
#                     )
# 
# 
# model_names <- c("INMCM4 \n low Tmax - low Precip",
#                  "HadGEM-ES2 \n high Tmax - low Precip",
#                  "MIROC \n high Tmax - high Precip")
# 
# by.model.2050 <- ggplot(small.proj[!small.proj$year == 2000 , ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 8%", "taper P & T 8%", "no taper P 15%", "no taper P & T 15%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
# ))+theme(legend.title = element_blank())+facet_grid(~model)
# 
# 
# png(height = 5, width = 9, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/fut_growth_by_model_2050_26cm_avg_growth.png")
# by.model.2050
# dev.off()
# 
# ggplot(small.proj[!small.proj$year == 2000 & !small.proj$year %in% "2070-2099", ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
# ))+theme(legend.title = element_blank())+facet_grid(rows=vars(model), cols= vars(site))

```

 



 # FOR DRY YEARS ONLY: multi-level model with MAP as drought index, an INTERACTION between MAP and Tmax stand structure by ageclass random effects and prev years growth (lag -1) and (lag - 2), and a site level random intercept parameter:
 
 In this version, we sample individual level parameters from a population mean

```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"

population_model_site_int_structure_x_cohort_re_lag2_temp_MAP_interaction.heir <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[site[i]] + beta2[indiv[i]]*DI.scaled[i] +   beta3[indiv[i]]*DBH.scaled[i]+beta4[indiv[i]]*log_RWI_1[i]+beta5[indiv[i]]*log_RWI_2[i]  + beta6[indiv[i]]*Temp.scaled[i] #+ beta7[indiv[i]]*Temp.scaled[i]*DI.scaled[i] # inclued beta 7 as interaction term


}

#
#


# Assume normal priors for betas, but generate a beta + alpha for each ageclass + cohort

for(indiv in 1:uniqueid){
beta2[indiv] ~ dnorm(mu_beta2[struct.cohort[indiv]], inv_beta2)
beta3[indiv] ~ dnorm(mu_beta3[struct.cohort[indiv]], inv_beta3)
beta4[indiv] ~ dnorm(mu_beta4[struct.cohort[indiv]], inv_beta4)
beta5[indiv] ~ dnorm(mu_beta5[struct.cohort[indiv]], inv_beta5)
beta6[indiv] ~ dnorm(mu_beta6[struct.cohort[indiv]], inv_beta6)
#beta7[indiv] ~ dnorm(mu_beta7[struct.cohort[indiv]], inv_beta7)
}


for(k in 1:Nsites){
beta1[k] ~ dnorm(mu_beta1, inv_beta1)
}
for(s in 1:length(SF)){

# use uniform priors for each  Mubeta paramters

mu_beta2[s] ~ dnorm(gam_beta2, inv_g_beta2)
mu_beta3[s] ~ dnorm(gam_beta3, inv_g_beta3)
mu_beta4[s] ~ dnorm(gam_beta4, inv_g_beta4)
mu_beta5[s] ~ dnorm(gam_beta5, inv_g_beta5)
mu_beta6[s] ~ dnorm(gam_beta6, inv_g_beta6)
#mu_beta7[s] ~ dnorm(gam_beta7, inv_g_beta7)

}



mu_beta1 ~ dunif(-2,2)

# use uniform priors for each  Mubeta paramters # check this
#gam_beta1 ~ dunif(-1, 1)
gam_beta2 ~ dunif(-1,1)
gam_beta3 ~ dunif(-1,1)
gam_beta4 ~ dunif(-1,1)
gam_beta5 ~ dunif(-1,1)
gam_beta6 ~ dunif(-1,1)
#gam_beta7 ~ dunif(-1,1)

inv_g_beta2   ~ dgamma(0.01, 0.01)
inv_g_beta3   ~ dgamma(0.0001, 0.0001)
inv_g_beta4   ~ dgamma(0.0001, 0.0001)
inv_g_beta5   ~ dgamma(0.0001, 0.0001)
inv_g_beta6   ~ dgamma(0.0001, 0.0001)
#inv_g_beta7   ~ dgamma(0.0001, 0.0001)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.1, 0.1)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)
inv_beta6   ~ dgamma(0.01, 0.01)
sigma_beta6 <- 1/sqrt(inv_beta6)
#inv_beta7   ~ dgamma(0.01, 0.01)
#sigma_beta7 <- 1/sqrt(inv_beta7)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.1, 0.1)
sigma     <- 1/sqrt(inv.var)

}"

# # save these for use later:
# saveRDS(train.dry.pair, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/train.rds")
# saveRDS(test.dry.pair, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/test.rds")
# train.dry.pair <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/train.rds")
# test.dry.pair <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/test.rds")
# # assign site numbers to each site:

site.num.df <- data.frame(site = as.character(unique(train$site)),
           site.num = 1:length(as.character(unique(train$site))))

# if site num is not in the df, add it
if(! "site.num" %in% colnames(train)){
    train <- merge(train, site.num.df, by = "site" )
    test.dry.pair <- merge(test.dry.pair, site.num.df, by = "site" )
}

# generate probe dataset:
 DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)
 DBHprobe <- round(seq(range(train$DBH.scaled)[1], range(train$DBH.scaled)[2], by = 0.75), 3)
 Tempprobe <- round(seq(range(train$T.scaled)[1], range(train$T.scaled)[2], by = 0.75), 3)
 RWI1probe <- round(seq(range(log(train$RWI_1))[1], range(log(train$RWI_1))[2], by = 0.5), 3)
 RWI2probe <- round(seq(range(log(train$RWI_2))[1], range(log(train$RWI_2))[2], by = 0.5), 3)

 # expand into full probe
probe <- expand.grid(DI.scaled = DIprobe, DBH.scaled = DBHprobe, T.scaled = Tempprobe,
                         RWI_1 = RWI1probe, RWI_2= RWI2probe, struct.cohort.code= 1:4, site.num = unique(train$site.num))

sit.cohorts <- unique(train[,c("struct.cohort.code", "site.num")])
probe <- merge(probe, sit.cohorts, by = c("struct.cohort.code", "site.num")) # make sure that each site only has savanna or forest in the probe

# make probe smaller to help with saving:
short.probe <- probe[probe$RWI_1 %in% c("-1.609", "0.391", "1.891") & probe$RWI_2 %in% c("-1.47", "0.03", "2.03") & probe$DBH.scaled %in% c("-0.376", "0.374", "1.874"),]

#short.probe <- probe

# make a probe for future climate projections at our sites!
rcp85 <- rcp85[!rcp85$site %in% c("COR", "GLL4", "HIC", "PLE", "PVC", "STC", "TOW"),]
future.probe_70 <- data.frame(MAP.scaled = rcp85$PR_85_70.scaled, DBH.scaled= -0.413,
                              T.scaled = rcp85$Tx_70.scaled,RWI_1 = 0.103,
                               RWI_2 = 0.103,  struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_70$year <- 2070
future.probe_50 <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413,
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103,
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site,  model = rcp85$model)
future.probe_50$year <- 2050


# get climate averages from 1950 - present at each site:
train$struct.cohort.code2 <- as.numeric(train$struct.cohort.code)
train.clim.summary <-
  train[train$ageclass %in% "Modern", ] %>% group_by(site) %>% dplyr::summarise(
    MAP.scaled = mean(MAP.scaled),
    DBH.scaled = -0.413,
    T.scaled = mean(T.scaled),
    RWI_1 = 0.103,
    RWI_2 = 0.103,
    struct.cohort.code = mean(struct.cohort.code2),
    model = "none",
    year = 2000
    )



Average.prob <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413,
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103,
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_50$year <- 2050


fut <- rbind(future.probe_50, future.probe_70, train.clim.summary[,c("MAP.scaled", "DBH.scaled",  "T.scaled", "RWI_1", "RWI_2", "struct.cohort.code", "site","year","model")])


fut <- merge(fut, site.num.df, by = "site")

# look at the effects under two different DBH values
short.fut <- fut
fut.small <- fut
fut.large <- fut
fut.small$DBH.scaled <- -0.413
fut.large$DBH.scaled <- 1.900
long.fut <- rbind(fut.small, fut.large)


# look at the effects under average, below average, and above average different prev year growth values
lfut.low <- long.fut
lfut.avg <- long.fut
lfut.high <- long.fut

lfut.low$RWI_1 <- -1.609
lfut.low$RWI_2 <- -1.47

lfut.high$RWI_1 <- 1.891
lfut.high$RWI_2 <- 2.03

long.fut <- rbind(lfut.high, lfut.avg, lfut.low)


train.pairs <- train[train$site %in% c("AVO", "BON", "ENG", "GLA", "GLL1", "GLL2", "GLL3", "MOU", "UNC"),]
ID.num <- data.frame(ID = unique(train.pairs$ID),
                     ID.num = 1:length(unique(train.pairs$ID)))

if(! "ID.num" %in% colnames(train.pairs)){
  train.pairs <- merge(train.pairs, ID.num, by = "ID")
  test.dry.pair <- merge(test.dry.pair, ID.num, by = "ID")
}



lag2.model.by_structure_x_cohort_t_pr_int <- jags.model(textConnection(population_model_site_int_structure_x_cohort_re_lag2_temp_MAP_interaction.heir),
                    data = list(Y=log(train.pairs$RWI), n=length(train.pairs$RWI), DI.scaled = train.pairs$MAP.scaled2, DBH.scaled = train.pairs$DBH.scaled,log_RWI_1 = log(train.pairs$RWI_1),log_RWI_2 = log(train.pairs$RWI_2), Temp.scaled = train.pairs$T.scaled2, struct.cohort = as.numeric(train.pairs$ageclass), SF = as.numeric(unique(train.pairs$age)), site = train.pairs$site.num, Nsites = length(unique(train.pairs$site)), indiv = train.pairs$ID.num, uniqueid = length(unique(train.pairs$ID.num))#,#,

  #  struct.cohort.p = as.numeric(test.dry.pair$struct.cohort.code), DBH.scaled.p = test.dry.pair$DBH.scaled, DI.scaled.p = test.dry.pair$MAP.scaled, log_RWI_1.p = log(test.dry.pair$RWI_1), log_RWI_2.p = log(test.dry.pair$RWI_2), Temp.scaled.p = test.dry.pair$T.scaled, site.p = test.dry.pair$site.num, np = length(as.numeric(test.dry.pair$struct.cohort.code)), indiv.p = train.pairs.dry.pair$ID.num
  # #
  # struct.cohort.probe = as.numeric(short.probe$struct.cohort.code), DBH.scaled.probe = short.probe$DBH.scaled, DI.scaled.probe = short.probe$DI.scaled, log_RWI_1.probe = short.probe$RWI_1, log_RWI_2.probe =short.probe$RWI_2, Temp.scaled.probe = short.probe$T.scaled, site.probe = short.probe$site.num, nprobe = length(as.numeric(short.probe$struct.cohort.code)),
  #
  # struct.cohort.fut = as.numeric(long.fut$struct.cohort.code), DBH.scaled.fut = long.fut$DBH.scaled, DI.scaled.fut = long.fut$MAP.scaled, log_RWI_1.fut = long.fut$RWI_1, log_RWI_2.fut =long.fut$RWI_2, Temp.scaled.fut = long.fut$T.scaled, site.fut = long.fut$site.num, nfut = length(as.numeric(long.fut$struct.cohort.code))
  #
  #
  ),
  n.chains = 3, n.adapt = 100)

update(lag2.model.by_structure_x_cohort_t_pr_int, 10000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","beta6","sigma", "mu_beta1", "mu_beta2","mu_beta3", "mu_beta4","mu_beta5", "mu_beta6"),
                    n.chains = 3, n.iter=10000, thin = 15)

# tracplots for precip slopes:
traceplot(samp.structure.cohort.re[,"mu_beta2[1]"])
traceplot(samp.structure.cohort.re[,"mu_beta2[2]"])
#traceplot(samp.structure.cohort.re[,"mu_beta2[3]"])
#traceplot(samp.structure.cohort.re[,"mu_beta2[4]"])
# gelman.diag(samp.structure.cohort.re)
#
gam_beta_val <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
                     variable.names=c( "gam_beta2","gam_beta3","gam_beta4","gam_beta5","gam_beta6","gam_beta7"),
                    n.chains = 3, n.iter=10000, thin = 15)

#
# Yp <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yp"),
#                     n.chains = 3, n.iter=10000, thin = 15)
#
#
# Y.probe <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yprobe"),
#                     n.chains = 3, n.iter=5000, thin = 15)
#
# Y.fut <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yfut"),
#                     n.chains = 3, n.iter=10000, thin = 15)
#
# Y.fut.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yfut.35"),
#                     n.chains = 3, n.iter=10000, thin = 15)
#
# Y.fut.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yfut.50"),
#                     n.chains = 3, n.iter=10000, thin = 15)
#
# Y.fut.35.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yfut.35.35"),
#                     n.chains = 3, n.iter=10000, thin = 15)
#
# Y.fut.50.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yfut.50.50"),
#                     n.chains = 3, n.iter=10000,thin = 15)
#
#
dic.full <- dic.samples(lag2.model.by_structure_x_cohort_t_pr_int, n.chains = 3, n.iter=10000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_DIC.rds")
#
summary(samp.structure.cohort.re)
#
# traceplot(samp.structure.cohort.re)
#
# # most just around 1
gelman.diag(samp.structure.cohort.re, multivariate = FALSE)
#acfplot(samp.structure.cohort.re)
#
#
#autocorr.plot(samp.structure.cohort.re [[1]][ , 'beta2[1]'], auto.layout = FALSE, lwd = 4, col = "red", lag.max = 100)
#
# #Extract the samples for each parameter for a basic exploration of effects
#
  samps       <- samp.structure.cohort.re[[1]]
#  saveRDS(samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/samps.rds")
#  samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/samps.rds")
#  #test.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/test.rds")
#  #train.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/train.rds")
# #Yfut.samps <- samps[, 1:length(fut$RWI_1)]
# #samps <- samps[,(length(fut$RWI_1)+1):length(colnames(samps))]
#  Yp.samps <- Yp
#  Yprobe.samps <- Y.probe
 alpha.samps  <- samps[,1:9]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,10:(9+ length(unique(train.pairs$ID)))]
 beta3.samps <- samps[,(9+ length(unique(train.pairs$ID))+ 1):(9+ length(unique(train.pairs$ID))*2)]
 beta4.samps <- samps[,(9+ length(unique(train.pairs$ID))*2+ 1):(9+ length(unique(train.pairs$ID))*3)]
 beta5.samps <- samps[,(9+ length(unique(train.pairs$ID))*3+ 1):(9+ length(unique(train.pairs$ID))*4)]
 beta6.samps <- samps[,(9+ length(unique(train.pairs$ID))*4+ 1):(9+ length(unique(train.pairs$ID))*5)]
# beta7.samps <- samps[,(9+ length(unique(train.pairs$ID))*5+ 1):(9+ length(unique(train.pairs$ID))*6)]
 

 start_mu<- (9+ length(unique(train.pairs$ID))*5 + 2)
 
 mu_beta1.samps <- samps[,start_mu]
 # in this model we have a individual tree level estimate for each parameter
 mu_beta2.samps <- samps[, start_mu:( start_mu + 3)]
 mu_beta3.samps <- samps[,(4+ start_mu):(4+ start_mu + 3)]
 mu_beta4.samps <- samps[,(8+ start_mu):(8+ start_mu + 3)]
 mu_beta5.samps <- samps[,(12+ start_mu):(12+ start_mu + 3)]
 mu_beta6.samps <- samps[,(16+ start_mu):(16+ start_mu + 3)]
 mu_beta7.samps <- samps[,(20+ start_mu):(20+ start_mu + 3)]
 #mu_beta7.samps <- samps[,(24+ start_mu):(24+ start_mu + 3)]
 
 sigma.samps <- samps[,36]
 sigma_betas <- samps[,30:35]



# # plot predicted vs observed and assess model fit:
# Yp.samps <- data.frame(Yp.samps[[1]])
# Yp.m <- melt(Yp.samps)
# Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
#                                                   ci.hi = quantile(exp(value),0.975),
#                                                  ci.lo = quantile(exp(value),0.025))
# Yp.summary$Observed <- test.dry.pair$RWI
#
# pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test.dry.pair$RWI))
#
# p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)+theme_bw(base_size = 15)
#
# # note best model fit so far
# png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/pred_vs_obs.png")
# p.o.plot
# dev.off()
#
#
# # calculate MSE & BIAS:
#
# MSE1   <- mean((colMeans(exp(Yp.samps))-test.dry.pair$RWI)^2)
# BIAS1  <- mean(colMeans(exp(Yp.samps))-test.dry.pair$RWI)
#
# # write model summary output to a file!
#
# model.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter",
#                             model.summary = "beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] + beta7[struct.cohort[i]]*Temp.scaled[i]*DI.scaled[i] ",
#            MSE = MSE1,
#            BIAS = BIAS1,
#            Rsq = pred.obs$r.squared)
#
# write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)
#
#
# # summarise the datasource to make model comparisons for best fit models
# data.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter",
#                            train = "cohort.omit.dry.years",
#                            DI.scaled = "MAP")
#
# write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)
#
#
#
# # get difference between beta2.samps: (i.e are they different?)
# oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
# oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
# oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
# twominusthree <- beta2.samps[,2] - beta2.samps[,3]
# twominusfour <- beta2.samps[,2] - beta2.samps[,4]
# threeminusfour <- beta2.samps[,3] - beta2.samps[,4]
#
#
#
# # plot marginal distributions of each parameter:
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_alphas.png")
# par(mfrow=c(3,2))
# hist(alpha.samps[,1], main = "alpha Past-Forest")
# hist(alpha.samps[,2], main = "alpha Modern-Forest")
# hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
# hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
# hist(sigma_betas[,1], main = "sigma alpha")
# dev.off()
#
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_beta1s.png")
# par(mfrow=c(3,2))
# hist(beta2.samps[,1], main = "beta2 Past-Forest")
# hist(beta2.samps[,2], main = "beta2 Modern-Forest")
# hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
# hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
# hist(sigma_betas[,2], main = "sigma beta2")
# dev.off()
#
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_beta2s.png")
# par(mfrow=c(3,2))
# hist(beta3.samps[,1], main = "beta3 Past-Forest")
# hist(beta3.samps[,2], main = "beta3 Modern-Forest")
# hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
# hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
# hist(sigma_betas[,3], main = "sigma beta3")
# dev.off()
#
#
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_beta3s.png")
# par(mfrow=c(3,2))
# hist(beta4.samps[,1], main = "beta4 Past-Forest")
# hist(beta4.samps[,2], main = "beta4 Modern-Forest")
# hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
# hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
# hist(sigma_betas[,4], main = "sigma beta4")
# dev.off()
#
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_beta4s.png")
# par(mfrow=c(3,2))
# hist(beta5.samps[,1], main = "beta5 Past-Forest")
# hist(beta5.samps[,2], main = "beta5 Modern-Forest")
# hist(beta5.samps[,3],  main = "beta5 Past-Savanna")
# hist(beta5.samps[,4],  main = "beta5 Modern-Savanna")
# hist(sigma_betas[,5], main = "sigma beta5")
# dev.off()
#
#
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_beta5s.png")
# par(mfrow=c(3,2))
# hist(beta5.samps[,1], main = "beta4 Past-Forest")
# hist(beta5.samps[,2], main = "beta4 Modern-Forest")
# hist(beta5.samps[,3],  main = "beta4 Past-Savanna")
# hist(beta5.samps[,4],  main = "beta4 Modern-Savanna")
# hist(sigma_betas[,6], main = "sigma beta4")
# dev.off()
#
# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- unique(train.dry.pair$site)#[order(unique(train.dry.pair[,c("site", "site.num")])[,2])])
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(mu_beta2.samps)
colnames(b2) <-c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
#colnames(b2) <- c(paste0(c(unique(train.dry.pair$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope")+xlim(-0.1, 1)

b3 <- data.frame(mu_beta3.samps)
colnames(b3) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH Index slope")


b4 <- data.frame(mu_beta4.samps)
colnames(b4) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-1 Index slope")

b5 <- data.frame(mu_beta5.samps)
colnames(b5) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-2 Index slope")

b6 <- data.frame(mu_beta6.samps)
colnames(b6) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b6$num <- rownames(b6)
b6.m <- melt(b6, id.vars=c("num"))
b6.mplots <- ggplot(b6.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Summer Temperature slope")

b7 <- data.frame(mu_beta7.samps)
colnames(b7) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b7$num <- rownames(b7)
b7.m <- melt(b7, id.vars=c("num"))
b7.mplots <- ggplot(b7.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precip*Temp slope")



# get the mu_beta samples from each individual:

bmu2 <- data.frame(beta2.samps)
#colnames() <-c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
#colnames(b2) <- c(paste0(c(unique(train.dry.pair$struct.cohort))))
bmu2$num <- rownames(bmu2)
bmu2.m <- melt(bmu2, id.vars=c("num"))
bmu2.mplots <- ggplot(bmu2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope by indiv")+theme(legend.position = "none")+xlim(-0.6,0.6)


png(height = 10, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_heir/drougt_beta_marginal_distn_bycohort.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots, b5.mplots, b6.mplots, b7.mplots)
dev.off()

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

# ------------------------- DOTPLOT MODEL SUMMARIES -----------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:

a1.sum <- a.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
a1.sum$variable <- unique(train.dry.pair$site)

df.site.struct <- unique(train.dry.pair[,c("site", "structure")])
a1.sum <- merge(a1.sum, df.site.struct, by.x = "variable", by.y = "site")
a1.sum$structure <- factor(a1.sum$structure, levels = c( "Forest", "Savanna"))

b2.sum <- b2.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b3.sum <- b3.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b4.sum <- b4.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.sum <- b5.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b6.sum <- b6.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b7.sum <- b7.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b7.sum$variable <- factor(b7.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


# write out all the dotplots
int.dot <- ggplot(data.frame(a1.sum), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Savanna"='sienna4',
"Forest"='forestgreen'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot <- ggplot(data.frame(b2.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.3)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot <- ggplot(data.frame(b3.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot <- ggplot(data.frame(b4.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot <- ggplot(data.frame(b5.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot <- ggplot(data.frame(b6.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b7.dot <- ggplot(data.frame(b7.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Temp*Precip sensitivity (Beta7)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_heir/full_dot_plot_cohort_struct.png")
plot_grid(int.dot, b2.dot, b6.dot, b3.dot, b4.dot, b5.dot, ncol = 1, align = "v")
dev.off()


#
# # get individual dot plots for each parameter:
#
bmu2.sum <- bmu2.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.05),
                                                   Ci.high = quantile(value, 0.95))

train.unique <- data.frame(unique(train.pairs[, c("site", "ID", "ageclass", "struct.cohort", "ID.num")]))
train.unique $variable <- paste0("beta2.",train.unique $ID.num, "." )

bmu2.sum2 <- left_join(train.unique , bmu2.sum, by = "variable")


bmu2.sum2 <- bmu2.sum2 %>% arrange(mean.val)
bmu2.sum2$variable <- factor(bmu2.sum2$variable, levels = unique(bmu2.sum2$variable))

ggplot(data.frame(bmu2.sum2), aes(x = mean.val, y = variable, color = ageclass,size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+theme( axis.title.y = element_blank())+geom_vline(xintercept = 0, linetype = "dashed", color = "red")
#
# # -------------------- DOTPLOTS by modern vs. past only ---------------------
# # make dotplots for all the factors in the model--
# # get summaries by struct-cohort class from the melted samples:
# # a does not vary by cohort
# a1.sum.age <- a1.sum
#
# b2.m$cohort <- ifelse(b2.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
# b2.sum.age <- b2.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
#                                                    Ci.low = quantile(value, 0.025),
#                                                    Ci.high = quantile(value, 0.975))
# #b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
#
# b3.m$cohort <- ifelse(b3.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
#
# b3.sum.age <- b3.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
#                                                    Ci.low = quantile(value, 0.025),
#                                                    Ci.high = quantile(value, 0.975))
# #b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
#
# b4.m$cohort <- ifelse(b4.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
#
# b4.sum.age <- b4.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
#                                                    Ci.low = quantile(value, 0.025),
#                                                    Ci.high = quantile(value, 0.975))
# #b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
#
# b5.m$cohort <- ifelse(b5.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
#
# b5.sum.age <- b5.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
#                                                    Ci.low = quantile(value, 0.025),
#                                                    Ci.high = quantile(value, 0.975))
# #b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
# b6.m$cohort <- ifelse(b6.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
#
# b6.sum.age <- b6.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
#                                                    Ci.low = quantile(value, 0.025),
#                                                    Ci.high = quantile(value, 0.975))
# #b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
# b7.m$cohort <- ifelse(b7.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
#
# b7.sum.age <- b7.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
#                                                    Ci.low = quantile(value, 0.025),
#                                                    Ci.high = quantile(value, 0.975))
#
#
# # write out all the dotplots
# int.dot.age <- ggplot(data.frame(a1.sum.age), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")
#
# b2.dot.age <- ggplot(data.frame(b2.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")
#
# b3.dot.age <- ggplot(data.frame(b3.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")
#
# b4.dot.age <- ggplot(data.frame(b4.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")
#
# b5.dot.age <- ggplot(data.frame(b5.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")
#
#
# b6.dot.age <- ggplot(data.frame(b6.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")
#
# b7.dot.age <- ggplot(data.frame(b7.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Temp*Precip sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")
#
#
# png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_dot_plot_cohort_only.png")
# plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b7.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1, align = "v")
# dev.off()
#
#
# png(height = 14, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_dot_plot_cohort_only.png")
# plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b7.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1)
# dev.off()
#
#
# png(height = 14, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_dot_plot_cohort_and_cohortXstruct.png")
# plot_grid(int.dot.age,int.dot,
#          b2.dot.age , b2.dot,
#          b6.dot.age, b6.dot,
#          b7.dot.age, b7.dot,
#          b3.dot.age, b3.dot,
#          b4.dot.age,  b4.dot,
#          b5.dot.age, b5.dot, ncol = 2, align = "hv", labels = c("a","h",
#                                                                 "b","i",
#                                                                 "c","j",
#                                                                 "d","k",
#                                                                 "e","l",
#                                                                 "f","m",
#                                                                 "g","n"), label_x = 0.4)
# dev.off()
#
# # ------------------ Do the site level intercepts correlate with site quality -----------
# # read in information about site quality:
# locs <- read.csv("outputs/priority_sites_locs_with_soil_clim.csv")
# locs <- data.frame(locs)
# locs$code <- as.character(locs$code)
# locs[9:12,]$code <- c( "GLL1", "GLL2", "GLL3", "GLL4")
# sites <- c("COR", "HIC", "STC", "GLA", "TOW", "ENG", "UNC", "BON", "MOU", "GLL4", "GLL3", "GLL2", "GLL1", "PVC", "AVO", "PLE", "UNI")
# 
# # merge with a1.sum.age
# site.summary <- merge(a1.sum.age, locs, by.x = "variable", by.y = "code")
# 
# # plot mean + 95% confidence interval vs. MAP
# alpha.pr30yr <-ggplot(site.summary, aes(x = pr30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("Total Precip")
# # get an idea if there might be relationship
# summary(lm(mean.val ~ pr30yr,data = site.summary))
# 
# # plot mean + 95% confidence interval vs. Tmean
# alpha.tm30yr <-ggplot(site.summary, aes(x = tm30yr, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("Mean Temp")
# # get an idea if there might be relationship
# summary(lm(mean.val ~ tm30yr,data = site.summary))
# 
# # plot mean + 95% confidence interval vs. sand %
# alpha.sand <-ggplot(site.summary, aes(x = sand, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("sand")#+stat_smooth(method = "lm")
# # get an idea if there might be relationship
# summary(lm(mean.val ~ sand,data = site.summary))
# 
# # plot mean + 95% confidence interval vs. ksat
# alpha.ksat <-ggplot(site.summary, aes(x = ksat, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("ksat")
# # get an idea if there might be relationship
# summary(lm(mean.val ~ ksat,data = site.summary))
# 
# # plot mean + 95% confidence interval vs. awc
# 
# alpha.awc <- ggplot(site.summary, aes(x = awc, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("AWC")
# # get an idea if there might be relationship
# summary(lm(mean.val ~ awc,data = site.summary))
# 
# # plot mean + 95% confidence interval vs. n. species 
# 
# alpha.nspecies <- ggplot(site.summary, aes(x = nspecies, y = mean.val, color = structure, size = 2))+geom_errorbar( aes(ymin = Ci.low, ymax = Ci.high, size = 1,width = 0))+geom_point()+scale_color_manual(values = c("Savanna"='sienna4', 'Forest' = "forestgreen"))+theme(legend.position = "none")+xlab("Estimated Intercept (alpha)")+ylab("nspecies")#+stat_smooth(data = site.summary, aes(x = nspecies, y = mean.val), method = "lm")
# 
# # there seems to be no relationship between alpha and site characteristics
# # but plot the relationships out here:
# png(height = 10, width = 4, units = "in",res = 200, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_site_rs/alpha_site_ints_vs_site_quality.png")
# plot_grid(alpha.pr30yr, alpha.tm30yr, alpha.awc, alpha.sand, alpha.nspecies, ncol = 1, align = "v")
# dev.off()
# 
# #---------------------- More beta summary plots -----------------------------
# png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/drougt_beta_marginal_distn_bycohort.png")
# plot_grid(b2.dots, b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.6))
# dev.off()
# 
# # plot slightly differently:
# plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")
# 
# plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
# plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))
# 
# b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
# "Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")
# 
# png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_site_rs/param_marginal_distn_bycohort_struct_rb.png")
# b2.dots.2
# dev.off()
# 
# b3 <- data.frame(beta3.samps)
# colnames(b3) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
# b3$num <- rownames(b3)
# b3.m <- melt(b3, id.vars=c("num"))
# b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")
# 
# b4 <- data.frame(beta4.samps)
# colnames(b4) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
# b4$num <- rownames(b4)
# b4.m <- melt(b4, id.vars=c("num"))
# b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")
# 
# b5 <- data.frame(beta5.samps)
# colnames(b5) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
# b5$num <- rownames(b5)
# b5.m <- melt(b5, id.vars=c("num"))
# b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")
# 
# library(cowplot)
# png(width = 5, height = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/param_marginal_distn_bycohort_struct_1.png")
# plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, b5.mplots,ncol = 1)
# dev.off()
# 
# # --------------------make plots of probed predicted growth responses:
# # plot probed values of tree growth predictions:
# Yprobe <- data.frame(Yprobe.samps[[1]])
# colnames(Yprobe) <- 1:length(Yprobe)
# probe.m <- melt(Yprobe)
# probe.m$RWI <- exp(probe.m$value) 
# colnames(probe.m) <- c("num", "Ypred", "RWI")
# 
# probe <- short.probe
# probe$num <- 1:length(probe[,1])
# colnames(probe) <- c("Drought", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort","site", "num")
# 
# # summarize by structure + cohort class only:
# # summarize by structure + cohort class only:
# probe$num <- as.factor(as.character(probe$num))
# full.p <- probe
# 
# probtest.dry.pair <- dplyr::inner_join(probe.m, full.p, by=c("num"))
# 
# prob <- probtest.dry.pair
# # save here:
# saveRDS(prob, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_yprobe_preds.rds")
# prob <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/full_yprobe_preds.rds")
# 
# 
# 
# 
# # convert prob$Drought back to MAP:
# library(DMwR)
# DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)
# 
# 
# 
# prob$DBH <- as.numeric(round(unscale(vals = prob$DBH, norm.data = DBH.scaled))) 
# prob$MAP <- as.numeric(round(unscale(vals = prob$Drought, norm.data = MAP.scaled)))
# prob$Tmax <- as.numeric(round(unscale(vals = prob$Tmax, norm.data = T.scaled))) 
# 
# 
# prob_10_60cm_avg <- prob %>% dplyr::filter(DBH == 27 | DBH == 39 | DBH == 63 ,  RWI_1 == 0.391, RWI_2 == 0.03 ) 
# 
#  struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
#  struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
#  prob_10_60cm_avg <- merge(prob_10_60cm_avg,struc.conversion, by  = "struct.cohort")
#  
#  
# preds_ci_10 <- prob_10_60cm_avg %>% group_by(DBH, Drought, MAP,Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# preds_ci_10_age <- prob_10_60cm_avg %>% group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# # same thing but with LOWER than average tree growth the years before:
# 
# prob_10_60cm_low <- prob %>% dplyr::filter(DBH == 27 | DBH == 39 | DBH == 63 ,  RWI_1 == -1.609, RWI_2 == -1.47 ) 
# 
#  
#  prob_10_60cm_low <- merge(prob_10_60cm_low, struc.conversion, by  = "struct.cohort")
#  
#  
# preds_ci_10_low <- prob_10_60cm_low %>% group_by(DBH, Drought,MAP, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# 
# preds_ci_10_low_age <- prob_10_60cm_low %>% group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# # same thing but with HIGHER than average tree growth the years before:
# 
# prob_10_60cm_high <- prob %>% dplyr::filter(DBH == 27 | DBH == 39 | DBH == 63 , RWI_1 == 1.891, RWI_2 == 2.03  ) 
# 
# 
#  prob_10_60cm_high <- merge(prob_10_60cm_high, struc.conversion, by  = "struct.cohort")
#  
#  
# preds_ci_10_high <- prob_10_60cm_high %>% group_by(DBH, Drought,MAP, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# preds_ci_10_high_age <- prob_10_60cm_high %>% group_by(DBH, Drought, MAP,Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# #----------- plot drought response by max temperature and Dimaeter + cohort-struct class -----------
# 
# Drought.resp.DBH.temp.avgpyr <- ggplot(preds_ci_10, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()
# 
# 
# 
# Drought.resp.DBH.temp.lowpyr <- ggplot(preds_ci_10_low, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()
# 
# 
# Drought.resp.DBH.temp.highpyr <- ggplot(preds_ci_10_high, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()
# 
# 
# # output the above plots to PNG:
# png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_low_prevyr_high_temp_low_high_DBH.png")
# Drought.resp.DBH.temp.lowpyr 
# dev.off()
# 
# png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_avg_prevyr_high_temp_low_high_DBH.png")
# Drought.resp.DBH.temp.avgpyr 
# dev.off()
# 
# png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_high_prevyr_high_temp_low_high_DBH.png")
# Drought.resp.DBH.temp.highpyr 
# dev.off()
# 
# 
# #----------- plot drought response by max temperature and Dimaeter + AGECLASS -----------
# 
# Drought.resp.DBH.temp.avgpyr.age <- ggplot(preds_ci_10_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()
# 
# 
# 
# 
# Drought.resp.DBH.temp.lowpyr.age <- ggplot(preds_ci_10_low_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_10_low_age,aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()
# 
# 
# Drought.resp.DBH.temp.highpyr.age <- ggplot(preds_ci_10_high_age, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Total Precipitation (mm)")+theme_bw()
# 
# 
# # output the above plots to PNG:
# png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_low_prevyr_high_temp_low_high_DBH_ageclass.png")
# Drought.resp.DBH.temp.lowpyr.age 
# dev.off()
# 
# png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_avg_prevyr_high_temp_low_high_DBH_ageclass.png")
# Drought.resp.DBH.temp.avgpyr.age+theme_bw(base_size = 14)
# dev.off()
# 
# png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/MAP_response_high_prevyr_high_temp_low_high_DBH_ageclass.png")
# Drought.resp.DBH.temp.highpyr.age 
# dev.off()
# 
# 
# 
# 
# 
# #--------------- plot marginal effects of climate and previous years growth ----------------
# 
#  struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
#  struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
# 
#  prob <- left_join(prob, struc.conversion, by  = "struct.cohort")
# 
#  # Marginal MAP effect:
# preds_ci_mod_past_MAP <- prob %>% group_by( MAP, ageclass) %>% summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_MAP_marg <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
#   geom_ribbon(data = preds_ci_mod_past_MAP,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()
# 
# 
# # marginal TMAX effect
# preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax,ageclass) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_Tmax_marg <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()
# 
# # marginal DBH effect
# preds_ci_mod_past_DBH <- prob %>% group_by( DBH,ageclass) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_DBH_marg <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()
# 
# # marginal lag-1 effect
# preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1,ageclass) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_RWI_1_marg <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()
# 
# # marginal lag-2 effect
# preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2,ageclass) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_RWI_2_marg <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()
# 
# 
# legend <- get_legend(Y_MAP_marg)
# 
# png(height = 10, width = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_post_predictive_effects_ageclass.png")
# plts <- plot_grid(Y_MAP_marg+theme(legend.position = "none"), Y_Tmax_marg+theme(legend.position = "none"), Y_DBH_marg+theme(legend.position = "none"), Y_RWI_1_marg+theme(legend.position = "none"), Y_RWI_2_marg+theme(legend.position = "none"), align = "v", ncol = 1)
# plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
# dev.off()
# 
# # --------------plot marginal effects for each stand structure and cohort class:
# # plot marginal effects of climate and previous years growth 
# # Marginal MAP effect:
# preds_ci_mod_past_MAP <- prob %>% group_by( MAP, cohort) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_MAP_marg_c <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_MAP, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Total Precipitation")
# 
# 
# # marginal TMAX effect
# preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, cohort) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_Tmax_marg_c <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Max. Temperature (DegF)")
# 
# # marginal DBH effect
# preds_ci_mod_past_DBH <- prob %>% group_by( DBH, cohort) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_DBH_marg_c <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Tree DBH (cm)")
# 
# # marginal lag-1 effect
# preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1, cohort) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_RWI_1_marg_c <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-1) year's growth)")
# 
# # marginal lag-2 effect
# preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2, cohort) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_RWI_2_marg_c <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
# "Modern-Savanna"='#dfc27d',
# "Modern-Forest"='#c7eae5',
# "Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-2) year's growth)")
# 
# png(height = 10, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_site_rs/marginal_post_predictive_effects_ageclassXStruct.png")
# legend <- get_legend(Y_MAP_marg_c)
# plts <- plot_grid(Y_MAP_marg_c+theme(legend.position = "none"), Y_Tmax_marg_c+theme(legend.position = "none"), Y_DBH_marg_c+theme(legend.position = "none"), Y_RWI_1_marg_c+theme(legend.position = "none"), Y_RWI_2_marg_c+theme(legend.position = "none"), align = "v", ncol = 1)
# plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.45))
# dev.off()
# 
# 
# # ------------- plot the marginal effects of each model parameter by site: ---------------
# 
# preds_ci_mod_past_MAP_site <- prob %>% group_by( MAP, ageclass, site) %>% summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_MAP_marg_site <- ggplot(preds_ci_mod_past_MAP_site, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
#   geom_ribbon(data = preds_ci_mod_past_MAP_site,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)
# 
# # marginal TMAX effect
# preds_ci_mod_past_Tmax_site <- prob %>% group_by( Tmax,ageclass, site) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_Tmax_marg_site <- ggplot(preds_ci_mod_past_Tmax_site, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax_site, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()+facet_wrap(~site)
# 
# # marginal DBH effect
# preds_ci_mod_past_DBH_site <- prob %>% group_by( DBH,ageclass, site) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_DBH_marg_site <- ggplot(preds_ci_mod_past_DBH_site, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH_site, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()+facet_wrap(~site)
# 
# # marginal lag-1 effect
# preds_ci_mod_past_RWI1_site <- prob %>% group_by( RWI_1,ageclass, site) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_RWI_1_marg_site <- ggplot(preds_ci_mod_past_RWI1_site, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1_site, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)
# 
# # marginal lag-2 effect
# preds_ci_mod_past_RWI2_site <- prob %>% group_by( RWI_2, ageclass, site) %>% summarise(meanY = mean(RWI),
#                                                                             Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
# 
# Y_RWI_2_marg_site <- ggplot(preds_ci_mod_past_RWI2_site, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2_site, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()+facet_wrap(~site)
# 
# 
# legend <- get_legend(Y_MAP_marg_site)
# 
# png(height = 25, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_post_predictive_effects_ageclass_by_site.png")
# plts <- plot_grid(Y_MAP_marg_site+theme(legend.position = "none"), Y_Tmax_marg_site+theme(legend.position = "none"), Y_DBH_marg_site+theme(legend.position = "none"), Y_RWI_1_marg_site+theme(legend.position = "none"), Y_RWI_2_marg_site+theme(legend.position = "none"), align = "v", ncol = 1)
# plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
# dev.off()
# 
# 
# # below is some extra code
# 
# 
# 
# # ----------------------- Plot future predictions ------------------------
# fut <- long.fut
# # scenario # 1: no change from modern
# Yfut.samps <- data.frame(Y.fut[[1]])
# 
# colnames(Yfut.samps) <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# Yfut.samps$num <- 1:length(Yfut.samps[,2])
# fut.m <- melt(Yfut.samps)
# fut.m$RWI <- exp(fut.m$value)
# colnames(fut.m) <- c("site_year", "Ypred", "RWI")
# 
# fut$site_year <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# fut$scenario <- "constant"
# colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort","model",  "year", "site.num","site_year", "scenario")
# 
# # summarize by structure + cohort class only:
# 
# fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))
# 
# 
# # scenario # 2: 35% decrease in drought sensitivie from modern
# Yfut.35.samps <- data.frame(Y.fut.35[[1]])
# 
# colnames(Yfut.35.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# Yfut.35.samps$num <- 1:length(Yfut.35.samps[,2])
# fut.35.m <- melt(Yfut.35.samps)
# fut.35.m $RWI <- exp(fut.35.m $value)
# colnames(fut.35.m ) <- c("site_year", "Ypred", "RWI")
# 
# fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# fut$scenario <- "decrease_35"
# colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")
# 
# fut.35.proj <- dplyr::inner_join(fut.35.m, fut, by=c("site_year"))
# 
# 
# # scenario # 3: 50% decrease in drought sensitivie from modern
# Yfut.50.samps <- data.frame(Y.fut.50[[1]])
# 
# colnames(Yfut.50.samps) <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# Yfut.50.samps$num <- 1:length(Yfut.50.samps[,2])
# fut.50.m <- melt(Yfut.50.samps)
# fut.50.m $RWI <- exp(fut.50.m $value)
# colnames(fut.50.m ) <- c("site_year", "Ypred", "RWI")
# 
# fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# fut$scenario <- "decrease_50"
# colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")
# 
# fut.50.proj <- dplyr::inner_join(fut.50.m, fut, by=c("site_year"))
# 
# # scenario # 4: 50% decrease in drought sensitivy from modern & 50% increase in T sensitivity
# Yfut.35.35.samps <- data.frame(Y.fut.35.35[[1]])
# 
# colnames(Yfut.35.35.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# Yfut.35.35.samps$num <- 1:length(Yfut.35.35.samps[,2])
# fut.35.35.m <- melt(Yfut.35.35.samps)
# fut.35.35.m $RWI <- exp(fut.35.35.m $value)
# colnames(fut.35.35.m ) <- c("site_year", "Ypred", "RWI")
# 
# fut$site_year <- paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# fut$scenario <- "decrease_35.35"
# colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")
# 
# fut.35.35.proj <- dplyr::inner_join(fut.35.35.m, fut, by=c("site_year"))
# 
# 
# 
# # scenario # 5: 50% decrease in drought sensitivy from modern & 50% increase in T sensitivity
# Yfut.50.50.samps <- data.frame(Y.fut.50.50[[1]])
# 
# colnames(Yfut.50.50.samps) <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# Yfut.50.50.samps$num <- 1:length(Yfut.50.50.samps[,2])
# fut.50.50.m <- melt(Yfut.50.50.samps)
# fut.50.50.m $RWI <- exp(fut.50.50.m $value)
# colnames(fut.50.50.m ) <- c("site_year", "Ypred", "RWI")
# 
# fut$site_year <-  paste0(fut$site, "_",fut$year, "_", fut$DBH.scaled, "_", fut$RWI_1, "_", fut$RWI_2, "_", fut$model)
# fut$scenario <- "decrease_50.50"
# colnames(fut) <- c("site","MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "model", "year", "site.num","site_year", "scenario")
# 
# fut.50.50.proj <- dplyr::inner_join(fut.50.50.m, fut, by=c("site_year"))
# 
# 
# # now join all together :
# all.proj <- rbind(fut.proj, fut.35.proj[!fut.35.proj$year == 2000,], fut.50.proj[!fut.50.proj$year == 2000,], fut.35.35.proj[!fut.35.35.proj$year == 2000,], fut.50.50.proj[!fut.50.50.proj$year == 2000,])
# 
# 
# 
# # ------------ For 26 cm tree and average prev years growth ----------------------
# small.proj <- all.proj[all.proj$DBH == -0.413 & all.proj$RWI_1 == 0.103 & all.proj$RWI_2 == 0.103,]
# small.proj$year <- ifelse(small.proj$year == 2050, "2050-2069",
#                           ifelse(small.proj$year == 2070, "2070-2099", "2000"))
# scenario_names <- c(
#                     'constant' = "sensitivity constant",
#                     'decrease_35' = "drought (taper 8%)",
#                     'decrease_35.35' = "drought & temp. (taper 8%)",
#                     'decrease_50.50' = "drought & temp. (no taper 15%)",
#                     'decrease_50' = "drought (no taper 15%)"
#                     )
# 
# 
# 
# # make one big plot for average previous years growth 
# by.scenario <- ggplot(small.proj[!small.proj$year == 2000, ], aes(year, RWI, fill = as.character(year)))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000,]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+facet_grid(~ model + scenario)+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c("blue", "red"))+theme(legend.title = element_blank())
# 
# 
# png(height = 4, width = 12, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/fut_growth_by_scenarios_26cm_avg_growth.png")
# by.scenario+theme(legend.position = "none")
# dev.off()
# 
# 
# by.period <- ggplot(small.proj[!small.proj$year == 2000 , ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
# ))+theme(legend.title = element_blank())
# 
# png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/fut_growth_by_time_scenarios_26cm_avg_growth.png")
# by.period
# dev.off()
# 
# by.model <- ggplot(small.proj[!small.proj$year == 2000, ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
# ))+theme(legend.title = element_blank())+facet_grid(rows = vars(scenario), cols = vars(model))
# 
# 
# 
# png(height = 5, width = 6, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/fut_growth_by_model_26cm_avg_growth.png")
# by.model
# dev.off()
# 
# small.proj$model <- factor(small.proj$model, levels = c("INMCM4", "HadGEM-ES2", "MIROC"))
# model_names <- c(
#                     'INMCM4' = "INMCM4 \n low Tmax - low Precip",
#                     'HadGEM-ES2' = "HadGEM-ES2 \n high Tmax - low Precip",
#                     'MIROC' = "MIROC \n high Tmax - high Precip"
#                     
#                     )
# 
# 
# model_names <- c("INMCM4 \n low Tmax - low Precip",
#                  "HadGEM-ES2 \n high Tmax - low Precip",
#                  "MIROC \n high Tmax - high Precip")
# 
# by.model.2050 <- ggplot(small.proj[!small.proj$year == 2000 , ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 8%", "taper P & T 8%", "no taper P 15%", "no taper P & T 15%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
# ))+theme(legend.title = element_blank())+facet_grid(~model)
# 
# 
# png(height = 5, width = 9, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/fut_growth_by_model_2050_26cm_avg_growth.png")
# by.model.2050
# dev.off()
# 
# ggplot(small.proj[!small.proj$year == 2000 & !small.proj$year %in% "2070-2099", ], aes(year, RWI, fill =factor( scenario, labels = c("constant", "taper P 35%", "taper P & T 35%", "no taper P 50%", "no taper P & T 50%"))))+geom_boxplot(position = "dodge2")+geom_hline(yintercept = mean(small.proj[small.proj$year ==2000 & small.proj$scenario %in% "constant",]$RWI, na.rm=TRUE), color = "black", linetype = "dashed")+ylab("Predicted tree growth (mm)")+xlab("Time period")+scale_fill_manual(values = c('#fee090','#91bfdb','#fc8d59','#4575b4','#d73027'
# ))+theme(legend.title = element_blank())+facet_grid(rows=vars(model), cols= vars(site))

```



```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"

population_model_site_int_structure_x_cohort_re_lag2_temp_MAP_interaction.heir <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[site[i]] + beta2[indiv[i]]*DI.scaled[i] +   beta3[indiv[i]]*DBH.scaled[i]+beta4[indiv[i]]*log_RWI_1[i]+beta5[indiv[i]]*log_RWI_2[i]  + beta6[indiv[i]]*Temp.scaled[i] #+ beta7[indiv[i]]*Temp.scaled[i]*DI.scaled[i] # inclued beta 7 as interaction term


}

#
#


# Assume normal priors for betas, but generate a beta + alpha for each ageclass + cohort

for(indiv in 1:uniqueid){
beta2[indiv] ~ dnorm(mu_beta2[struct.cohort[indiv]], inv_beta2)
beta3[indiv] ~ dnorm(mu_beta3[struct.cohort[indiv]], inv_beta3)
beta4[indiv] ~ dnorm(mu_beta4[struct.cohort[indiv]], inv_beta4)
beta5[indiv] ~ dnorm(mu_beta5[struct.cohort[indiv]], inv_beta5)
beta6[indiv] ~ dnorm(mu_beta6[struct.cohort[indiv]], inv_beta6)
#beta7[indiv] ~ dnorm(mu_beta7[struct.cohort[indiv]], inv_beta7)
}


for(k in 1:Nsites){
beta1[k] ~ dnorm(mu_beta1, inv_beta1)
}
for(s in 1:length(SF)){

# use uniform priors for each  Mubeta paramters

mu_beta2[s] ~ dnorm(gam_beta2, inv_g_beta2)
mu_beta3[s] ~ dnorm(gam_beta3, inv_g_beta3)
mu_beta4[s] ~ dnorm(gam_beta4, inv_g_beta4)
mu_beta5[s] ~ dnorm(gam_beta5, inv_g_beta5)
mu_beta6[s] ~ dnorm(gam_beta6, inv_g_beta6)
#mu_beta7[s] ~ dnorm(gam_beta7, inv_g_beta7)

}



mu_beta1 ~ dunif(-2,2)

# use uniform priors for each  Mubeta paramters # check this
#gam_beta1 ~ dunif(-1, 1)
gam_beta2 ~ dunif(-1,1)
gam_beta3 ~ dunif(-1,1)
gam_beta4 ~ dunif(-1,1)
gam_beta5 ~ dunif(-1,1)
gam_beta6 ~ dunif(-1,1)
#gam_beta7 ~ dunif(-1,1)

inv_g_beta2   ~ dgamma(0.01, 0.01)
inv_g_beta3   ~ dgamma(0.0001, 0.0001)
inv_g_beta4   ~ dgamma(0.0001, 0.0001)
inv_g_beta5   ~ dgamma(0.0001, 0.0001)
inv_g_beta6   ~ dgamma(0.0001, 0.0001)
#inv_g_beta7   ~ dgamma(0.0001, 0.0001)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.1, 0.1)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)
inv_beta6   ~ dgamma(0.01, 0.01)
sigma_beta6 <- 1/sqrt(inv_beta6)
#inv_beta7   ~ dgamma(0.01, 0.01)
#sigma_beta7 <- 1/sqrt(inv_beta7)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.1, 0.1)
sigma     <- 1/sqrt(inv.var)

}"

# # save these for use later:
# saveRDS(train.dry.pair, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/train.rds")
# saveRDS(test.dry.pair, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/test.rds")
# train.dry.pair <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/train.rds")
# test.dry.pair <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/test.rds")
# # assign site numbers to each site:

site.num.df <- data.frame(site = as.character(unique(train$site)),
           site.num = 1:length(as.character(unique(train$site))))

# if site num is not in the df, add it
if(! "site.num" %in% colnames(train)){
    train <- merge(train, site.num.df, by = "site" )
    test.dry.pair <- merge(test.dry.pair, site.num.df, by = "site" )
}

# generate probe dataset:
 DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)
 DBHprobe <- round(seq(range(train$DBH.scaled)[1], range(train$DBH.scaled)[2], by = 0.75), 3)
 Tempprobe <- round(seq(range(train$T.scaled)[1], range(train$T.scaled)[2], by = 0.75), 3)
 RWI1probe <- round(seq(range(log(train$RWI_1))[1], range(log(train$RWI_1))[2], by = 0.5), 3)
 RWI2probe <- round(seq(range(log(train$RWI_2))[1], range(log(train$RWI_2))[2], by = 0.5), 3)

 # expand into full probe
probe <- expand.grid(DI.scaled = DIprobe, DBH.scaled = DBHprobe, T.scaled = Tempprobe,
                         RWI_1 = RWI1probe, RWI_2= RWI2probe, struct.cohort.code= 1:4, site.num = unique(train$site.num))

sit.cohorts <- unique(train[,c("struct.cohort.code", "site.num")])
probe <- merge(probe, sit.cohorts, by = c("struct.cohort.code", "site.num")) # make sure that each site only has savanna or forest in the probe

# make probe smaller to help with saving:
short.probe <- probe[probe$RWI_1 %in% c("-1.609", "0.391", "1.891") & probe$RWI_2 %in% c("-1.47", "0.03", "2.03") & probe$DBH.scaled %in% c("-0.376", "0.374", "1.874"),]

#short.probe <- probe

# make a probe for future climate projections at our sites!
rcp85 <- rcp85[!rcp85$site %in% c("COR", "GLL4", "HIC", "PLE", "PVC", "STC", "TOW"),]
future.probe_70 <- data.frame(MAP.scaled = rcp85$PR_85_70.scaled, DBH.scaled= -0.413,
                              T.scaled = rcp85$Tx_70.scaled,RWI_1 = 0.103,
                               RWI_2 = 0.103,  struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_70$year <- 2070
future.probe_50 <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413,
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103,
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site,  model = rcp85$model)
future.probe_50$year <- 2050


# get climate averages from 1950 - present at each site:
train$struct.cohort.code2 <- as.numeric(train$struct.cohort.code)
train.clim.summary <-
  train[train$ageclass %in% "Modern", ] %>% group_by(site) %>% dplyr::summarise(
    MAP.scaled = mean(MAP.scaled),
    DBH.scaled = -0.413,
    T.scaled = mean(T.scaled),
    RWI_1 = 0.103,
    RWI_2 = 0.103,
    struct.cohort.code = mean(struct.cohort.code2),
    model = "none",
    year = 2000
    )



Average.prob <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413,
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103,
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site, model = rcp85$model)
future.probe_50$year <- 2050


fut <- rbind(future.probe_50, future.probe_70, train.clim.summary[,c("MAP.scaled", "DBH.scaled",  "T.scaled", "RWI_1", "RWI_2", "struct.cohort.code", "site","year","model")])


fut <- merge(fut, site.num.df, by = "site")

# look at the effects under two different DBH values
short.fut <- fut
fut.small <- fut
fut.large <- fut
fut.small$DBH.scaled <- -0.413
fut.large$DBH.scaled <- 1.900
long.fut <- rbind(fut.small, fut.large)


# look at the effects under average, below average, and above average different prev year growth values
lfut.low <- long.fut
lfut.avg <- long.fut
lfut.high <- long.fut

lfut.low$RWI_1 <- -1.609
lfut.low$RWI_2 <- -1.47

lfut.high$RWI_1 <- 1.891
lfut.high$RWI_2 <- 2.03

long.fut <- rbind(lfut.high, lfut.avg, lfut.low)


train.pairs <- train[train$site %in% c("AVO", "BON", "ENG", "GLA", "GLL1", "GLL2", "GLL3", "MOU", "UNC"),]
ID.num <- data.frame(ID = unique(train.pairs$ID),
                     ID.num = 1:length(unique(train.pairs$ID)))

if(! "ID.num" %in% colnames(train.pairs)){
  train.pairs <- merge(train.pairs, ID.num, by = "ID")
  test.dry.pair <- merge(test.dry.pair, ID.num, by = "ID")
}



lag2.model.by_structure_x_cohort_t_pr_int <- jags.model(textConnection(population_model_site_int_structure_x_cohort_re_lag2_temp_MAP_interaction.heir),
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$MAP.scaled, DBH.scaled = train$DBH.scaled,log_RWI_1 = log(train$RWI_1),log_RWI_2 = log(train$RWI_2), Temp.scaled = train$T.scaled, struct.cohort = as.numeric(train$ageclass), SF = as.numeric(unique(train$ageclass)), site = train$site.num, Nsites = length(unique(train$site.num)), indiv = train$site_age.code, uniqueid = length(unique(train$site_age.code))#,#,

  #  struct.cohort.p = as.numeric(test.dry.pair$struct.cohort.code), DBH.scaled.p = test.dry.pair$DBH.scaled, DI.scaled.p = test.dry.pair$MAP.scaled, log_RWI_1.p = log(test.dry.pair$RWI_1), log_RWI_2.p = log(test.dry.pair$RWI_2), Temp.scaled.p = test.dry.pair$T.scaled, site.p = test.dry.pair$site.num, np = length(as.numeric(test.dry.pair$struct.cohort.code)), indiv.p = train.pairs.dry.pair$ID.num
  # #
  # struct.cohort.probe = as.numeric(short.probe$struct.cohort.code), DBH.scaled.probe = short.probe$DBH.scaled, DI.scaled.probe = short.probe$DI.scaled, log_RWI_1.probe = short.probe$RWI_1, log_RWI_2.probe =short.probe$RWI_2, Temp.scaled.probe = short.probe$T.scaled, site.probe = short.probe$site.num, nprobe = length(as.numeric(short.probe$struct.cohort.code)),
  #
  # struct.cohort.fut = as.numeric(long.fut$struct.cohort.code), DBH.scaled.fut = long.fut$DBH.scaled, DI.scaled.fut = long.fut$MAP.scaled, log_RWI_1.fut = long.fut$RWI_1, log_RWI_2.fut =long.fut$RWI_2, Temp.scaled.fut = long.fut$T.scaled, site.fut = long.fut$site.num, nfut = length(as.numeric(long.fut$struct.cohort.code))
  #
  #
  ),
  n.chains = 3, n.adapt = 100)

update(lag2.model.by_structure_x_cohort_t_pr_int, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","beta6","sigma", "mu_beta1", "mu_beta2","mu_beta3", "mu_beta4","mu_beta5", "mu_beta6"),
                    n.chains = 3, n.iter=10000, thin = 15)

# tracplots for precip slopes:
traceplot(samp.structure.cohort.re[,"mu_beta2[1]"])
traceplot(samp.structure.cohort.re[,"mu_beta2[2]"])
#traceplot(samp.structure.cohort.re[,"mu_beta2[3]"])
#traceplot(samp.structure.cohort.re[,"mu_beta2[4]"])
# gelman.diag(samp.structure.cohort.re)
#
gam_beta_val <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
                     variable.names=c( "gam_beta2","gam_beta3","gam_beta4","gam_beta5","gam_beta6","gam_beta7"),
                    n.chains = 3, n.iter=10000, thin = 15)

#
# Yp <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yp"),
#                     n.chains = 3, n.iter=10000, thin = 15)
#
#
# Y.probe <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yprobe"),
#                     n.chains = 3, n.iter=5000, thin = 15)
#
# Y.fut <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yfut"),
#                     n.chains = 3, n.iter=10000, thin = 15)
#
# Y.fut.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yfut.35"),
#                     n.chains = 3, n.iter=10000, thin = 15)
#
# Y.fut.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yfut.50"),
#                     n.chains = 3, n.iter=10000, thin = 15)
#
# Y.fut.35.35 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yfut.35.35"),
#                     n.chains = 3, n.iter=10000, thin = 15)
#
# Y.fut.50.50 <- coda.samples(lag2.model.by_structure_x_cohort_t_pr_int,
#                      variable.names=c("Yfut.50.50"),
#                     n.chains = 3, n.iter=10000,thin = 15)
#
#
dic.full <- dic.samples(lag2.model.by_structure_x_cohort_t_pr_int, n.chains = 3, n.iter=10000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_DIC.rds")
#
summary(samp.structure.cohort.re)
#
# traceplot(samp.structure.cohort.re)
#
# # most just around 1
gelman.diag(samp.structure.cohort.re, multivariate = FALSE)
#acfplot(samp.structure.cohort.re)
#
#
#autocorr.plot(samp.structure.cohort.re [[1]][ , 'beta2[1]'], auto.layout = FALSE, lwd = 4, col = "red", lag.max = 100)
#
# #Extract the samples for each parameter for a basic exploration of effects
#
  samps       <- samp.structure.cohort.re[[1]]
#  saveRDS(samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/samps.rds")
#  samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/samps.rds")
#  #test.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/test.rds")
#  #train.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/train.rds")
# #Yfut.samps <- samps[, 1:length(fut$RWI_1)]
# #samps <- samps[,(length(fut$RWI_1)+1):length(colnames(samps))]
#  Yp.samps <- Yp
#  Yprobe.samps <- Y.probe
 alpha.samps  <- samps[,1:16]# one alpha for each of 9 sites
 beta2.samps <- samps[,17:(16+ length(unique(train$site_age.code)))]
 beta3.samps <- samps[,(16+ length(unique(train$site_age))+ 1):(16+ length(unique(train$site_age))*2)]
 beta4.samps <- samps[,(16+ length(unique(train$site_age))*2+ 1):(16+ length(unique(train$site_age))*3)]
 beta5.samps <- samps[,(16+ length(unique(train$site_age))*3+ 1):(16+ length(unique(train$site_age))*4)]
 beta6.samps <- samps[,(16+ length(unique(train$site_age))*4+ 1):(16+ length(unique(train$site_age))*5)]
# beta7.samps <- samps[,(9+ length(unique(train.pairs$ID))*5+ 1):(9+ length(unique(train.pairs$ID))*6)]
 

 start_mu<- (16+ length(unique(train$site_age))*5 + 2)
 
 mu_beta1.samps <- samps[,start_mu]
 # in this model we have a individual tree level estimate for each parameter
 mu_beta2.samps <- samps[, start_mu:( start_mu + 1)]
 mu_beta3.samps <- samps[,(2+ start_mu):(2+ start_mu + 1)]
 mu_beta4.samps <- samps[,(4+ start_mu):(4+ start_mu + 1)]
 mu_beta5.samps <- samps[,(6+ start_mu):(6+ start_mu + 1)]
 mu_beta6.samps <- samps[,(8+ start_mu):(8+ start_mu + 1)]
 mu_beta7.samps <- samps[,(10+ start_mu):(10+ start_mu + 1)]
 #mu_beta7.samps <- samps[,(24+ start_mu):(24+ start_mu + 3)]
 
 sigma.samps <- samps[,36]
 sigma_betas <- samps[,30:35]



# # plot predicted vs observed and assess model fit:
# Yp.samps <- data.frame(Yp.samps[[1]])
# Yp.m <- melt(Yp.samps)
# Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
#                                                   ci.hi = quantile(exp(value),0.975),
#                                                  ci.lo = quantile(exp(value),0.025))
# Yp.summary$Observed <- test.dry.pair$RWI
#
# pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test.dry.pair$RWI))
#
# p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)+theme_bw(base_size = 15)
#
# # note best model fit so far
# png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/pred_vs_obs.png")
# p.o.plot
# dev.off()
#
#
# # calculate MSE & BIAS:
#
# MSE1   <- mean((colMeans(exp(Yp.samps))-test.dry.pair$RWI)^2)
# BIAS1  <- mean(colMeans(exp(Yp.samps))-test.dry.pair$RWI)
#
# # write model summary output to a file!
#
# model.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter",
#                             model.summary = "beta1[site[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] + beta7[struct.cohort[i]]*Temp.scaled[i]*DI.scaled[i] ",
#            MSE = MSE1,
#            BIAS = BIAS1,
#            Rsq = pred.obs$r.squared)
#
# write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)
#
#
# # summarise the datasource to make model comparisons for best fit models
# data.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter",
#                            train = "cohort.omit.dry.years",
#                            DI.scaled = "MAP")
#
# write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)
#
#
#
# # get difference between beta2.samps: (i.e are they different?)
# oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
# oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
# oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
# twominusthree <- beta2.samps[,2] - beta2.samps[,3]
# twominusfour <- beta2.samps[,2] - beta2.samps[,4]
# threeminusfour <- beta2.samps[,3] - beta2.samps[,4]
#
#
#
# # plot marginal distributions of each parameter:
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_alphas.png")
# par(mfrow=c(3,2))
# hist(alpha.samps[,1], main = "alpha Past-Forest")
# hist(alpha.samps[,2], main = "alpha Modern-Forest")
# hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
# hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
# hist(sigma_betas[,1], main = "sigma alpha")
# dev.off()
#
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_beta1s.png")
# par(mfrow=c(3,2))
# hist(beta2.samps[,1], main = "beta2 Past-Forest")
# hist(beta2.samps[,2], main = "beta2 Modern-Forest")
# hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
# hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
# hist(sigma_betas[,2], main = "sigma beta2")
# dev.off()
#
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_beta2s.png")
# par(mfrow=c(3,2))
# hist(beta3.samps[,1], main = "beta3 Past-Forest")
# hist(beta3.samps[,2], main = "beta3 Modern-Forest")
# hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
# hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
# hist(sigma_betas[,3], main = "sigma beta3")
# dev.off()
#
#
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_beta3s.png")
# par(mfrow=c(3,2))
# hist(beta4.samps[,1], main = "beta4 Past-Forest")
# hist(beta4.samps[,2], main = "beta4 Modern-Forest")
# hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
# hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
# hist(sigma_betas[,4], main = "sigma beta4")
# dev.off()
#
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_beta4s.png")
# par(mfrow=c(3,2))
# hist(beta5.samps[,1], main = "beta5 Past-Forest")
# hist(beta5.samps[,2], main = "beta5 Modern-Forest")
# hist(beta5.samps[,3],  main = "beta5 Past-Savanna")
# hist(beta5.samps[,4],  main = "beta5 Modern-Savanna")
# hist(sigma_betas[,5], main = "sigma beta5")
# dev.off()
#
#
# png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter/marginal_beta5s.png")
# par(mfrow=c(3,2))
# hist(beta5.samps[,1], main = "beta4 Past-Forest")
# hist(beta5.samps[,2], main = "beta4 Modern-Forest")
# hist(beta5.samps[,3],  main = "beta4 Past-Savanna")
# hist(beta5.samps[,4],  main = "beta4 Modern-Savanna")
# hist(sigma_betas[,6], main = "sigma beta4")
# dev.off()
#
# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- unique(train.dry.pair$site)#[order(unique(train.dry.pair[,c("site", "site.num")])[,2])])
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(mu_beta2.samps)
colnames(b2) <-c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
#colnames(b2) <- c(paste0(c(unique(train.dry.pair$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope")+xlim(-0.1, 1)

b3 <- data.frame(mu_beta3.samps)
colnames(b3) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH Index slope")


b4 <- data.frame(mu_beta4.samps)
colnames(b4) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-1 Index slope")

b5 <- data.frame(mu_beta5.samps)
colnames(b5) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-2 Index slope")

b6 <- data.frame(mu_beta6.samps)
colnames(b6) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b6$num <- rownames(b6)
b6.m <- melt(b6, id.vars=c("num"))
b6.mplots <- ggplot(b6.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Summer Temperature slope")

b7 <- data.frame(mu_beta7.samps)
colnames(b7) <- c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
b7$num <- rownames(b7)
b7.m <- melt(b7, id.vars=c("num"))
b7.mplots <- ggplot(b7.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precip*Temp slope")



# get the mu_beta samples from each individual:

bmu2 <- data.frame(beta2.samps)
#colnames() <-c(unique(train.dry.pair$struct.cohort)[order(unique(train.dry.pair[,c("struct.cohort", "struct.cohort.code")])[,2])])
#colnames(b2) <- c(paste0(c(unique(train.dry.pair$struct.cohort))))
bmu2$num <- rownames(bmu2)
bmu2.m <- melt(bmu2, id.vars=c("num"))
bmu2.mplots <- ggplot(bmu2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope by indiv")+theme(legend.position = "none")+xlim(-0.6,0.6)


png(height = 10, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_heir/drougt_beta_marginal_distn_bycohort.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots, b5.mplots, b6.mplots, b7.mplots)
dev.off()

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

# ------------------------- DOTPLOT MODEL SUMMARIES -----------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:

a1.sum <- a.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
a1.sum$variable <- unique(train.dry.pair$site)

df.site.struct <- unique(train.dry.pair[,c("site", "structure")])
a1.sum <- merge(a1.sum, df.site.struct, by.x = "variable", by.y = "site")
a1.sum$structure <- factor(a1.sum$structure, levels = c( "Forest", "Savanna"))

b2.sum <- b2.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b3.sum <- b3.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b4.sum <- b4.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.sum <- b5.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b6.sum <- b6.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b7.sum <- b7.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025),
                                                   Ci.high = quantile(value, 0.975))
b7.sum$variable <- factor(b7.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


# write out all the dotplots
int.dot <- ggplot(data.frame(a1.sum), aes(x = mean.val, y = variable, color = structure, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Savanna"='sienna4',
"Forest"='forestgreen'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot <- ggplot(data.frame(b2.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.3)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot <- ggplot(data.frame(b3.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot <- ggplot(data.frame(b4.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot <- ggplot(data.frame(b5.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot <- ggplot(data.frame(b6.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b7.dot <- ggplot(data.frame(b7.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Temp*Precip sensitivity (Beta7)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs_site_rs_inter_heir/full_dot_plot_cohort_struct.png")
plot_grid(int.dot, b2.dot, b6.dot, b3.dot, b4.dot, b5.dot, ncol = 1, align = "v")
dev.off()


#
# # get individual dot plots for each parameter:
#
bmu2.sum <- bmu2.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.05),
                                                   Ci.high = quantile(value, 0.95))

train.unique <- data.frame(unique(train[, c("site", "ID", "ageclass", "struct.cohort", "site_age.code",  "site_age")]))
train.unique $variable <- paste0("beta2.",train.unique$site_age.code, "." )

bmu2.sum2 <- left_join(train.unique , bmu2.sum, by = "variable")


bmu2.sum2 <- bmu2.sum2 %>% arrange(mean.val)
bmu2.sum2$variable <- factor(bmu2.sum2$variable, levels = unique(bmu2.sum2$variable))

ggplot(data.frame(bmu2.sum2[!bmu2.sum2$site %in% c( "STC", "PVC", "PLE", "HIC", "GLL4", "BON", "COR", "TOW"),]), aes(x = mean.val, y = site_age, color = ageclass,size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+theme( axis.title.y = element_blank())+geom_vline(xintercept = 0, linetype = "dashed", color = "red")

```





 
# FOR DRY YEARS ONLY: multi-level model with MAP as drought index stand structure by ageclass random effects and prev years growth (lag -1) and (lag - 2), and a site level parameter estimation:

# multi-level model where we estimate climate response parameters (given a site), and the effect of sites given their stand structure-cohort class 

```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"

population_model_structure_x_cohort_sites_re_lag2_temp_MAP.f <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i] + beta6[struct.cohort[i]]*Temp.scaled[i] # use Drought index as a scaled variable 

#r1[i] <- Y[i] - gfunc[i]   

}


# Prediction from known data
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1.p[struct.cohort.p[i]] + beta2.p[struct.cohort.p[i]]*DI.scaled.p[i] + beta3.p[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4.p[struct.cohort.p[i]]*log_RWI_1.p[i] +beta5.p[struct.cohort.p[i]]*log_RWI_2.p[i] + beta6.p[struct.cohort.p[i]]*Temp.scaled.p[i]

        for(s in 1:length(SFp)){
        beta1.p[s] ~ dnorm(mu_beta1.p[s], inv_beta1)
        mu_beta1.p[s] <- b1[site.p[s]]
        beta2.p[s] ~ dnorm(mu_beta2.p[s], inv_beta2)
        mu_beta2.p[s] <- b2[site.p[s]] 
        beta3.p[s] ~ dnorm(mu_beta3.p[s], inv_beta3)
        mu_beta3.p[s] <- b3[site.p[s]] 
        beta4.p[s] ~ dnorm(mu_beta4.p[s], inv_beta4)
        mu_beta4.p[s] <- b4[site.p[s]]
        beta5.p[s] ~ dnorm(mu_beta5.p[s], inv_beta5)
        mu_beta5.p[s] <- b5[site.p[s]]
        beta6.p[s] ~ dnorm(mu_beta6.p[s], inv_beta6)
        mu_beta6.p[s] <- b6[site.p[s]]
        }



}

# Assume normal priors for betas, but generate a beta + alpha for each ageclass, by site
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1[s], inv_beta1)
mu_beta1[s] <- b1[site[s]]
beta2[s] ~ dnorm(mu_beta2[s], inv_beta2)
mu_beta2[s] <- b2[site[s]] 
beta3[s] ~ dnorm(mu_beta3[s], inv_beta3)
mu_beta3[s] <- b3[site[s]] 
beta4[s] ~ dnorm(mu_beta4[s], inv_beta4)
mu_beta4[s] <- b4[site[s] ]
beta5[s] ~ dnorm(mu_beta5[s], inv_beta5)
mu_beta5[s] <- b5[site[s]]
beta6[s] ~ dnorm(mu_beta6[s], inv_beta6)
mu_beta6[s] <- b6[site[s]]
}

for(k in 1:Nsites){ # Third level (i.e. priors for second level coefficients)
    b1[k] ~ dnorm(b1.mean, tau.b1)
    b2[k] ~ dnorm(b2.mean, tau.b2)
    b3[k] ~ dnorm(b3.mean, tau.b3)
    b4[k] ~ dnorm(b4.mean, tau.b4)
    b5[k] ~ dnorm(b5.mean, tau.b5)
    b6[k] ~ dnorm(b6.mean, tau.b6)
  }



# use normalpriors for each  beta paramters 

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)
inv_beta6   ~ dgamma(0.01, 0.01)
sigma_beta6 <- 1/sqrt(inv_beta6)

b1.mean ~ dgamma(0.01, 0.01)
sigma.b1 ~ dunif(0,10000)
tau.b1 <- 1/sigma.b1

b2.mean ~ dgamma(0.01, 0.01)
sigma.b2 ~ dunif(0,10000)
tau.b2 <- 1/sigma.b2

b3.mean ~ dgamma(0.01, 0.01)
sigma.b3 ~ dunif(0,10000)
tau.b3 <- 1/sigma.b3

b4.mean ~ dgamma(0.01, 0.01)
sigma.b4 ~ dunif(0,10000)
tau.b4 <- 1/sigma.b4

b5.mean ~ dgamma(0.01, 0.01)
sigma.b5 ~ dunif(0,10000)
tau.b5 <- 1/sigma.b5

b6.mean ~ dgamma(0.01, 0.01)
sigma.b6 ~ dunif(0,10000)
tau.b6 <- 1/sigma.b6

# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


}"

# save these for use later:
saveRDS(train.dry, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/train.rds")
saveRDS(test.dry, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/test.rds")
train.dry <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/train.rds")
test.dry <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/test.rds")



# generate probe dataset:
 DIprobe <- round(seq(range(train.dry$MAP.scaled)[1], range(train.dry$MAP.scaled)[2], by = 0.75), 3)
 DBHprobe <- round(seq(range(train.dry$DBH.scaled)[1], range(train.dry$DBH.scaled)[2], by = 0.75), 3)
 Tempprobe <- round(seq(range(train.dry$T.scaled)[1], range(train.dry$T.scaled)[2], by = 0.75), 3)
 RWI1probe <- round(seq(range(log(train.dry$RWI_1))[1], range(log(train.dry$RWI_1))[2], by = 0.5), 3)
 RWI2probe <- round(seq(range(log(train.dry$RWI_2))[1], range(log(train.dry$RWI_2))[2], by = 0.5), 3)
 
 # expand into full probe
probe <- expand.grid(DI.scaled = DIprobe, DBH.scaled = DBHprobe, T.scaled = Tempprobe,
                         RWI_1 = RWI1probe, RWI_2= RWI2probe, struct.cohort.code= 1:4)

# make a probe for future climate projections at our sites!

future.probe_70 <- data.frame(MAP.scaled = rcp85$PR_85_70.scaled, DBH.scaled= -0.413, 
                              T.scaled = rcp85$Tx_70.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103,  struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site)
future.probe_70$year <- 2070
future.probe_50 <- data.frame(MAP.scaled= rcp85$Pr_85_50.scaled, DBH.scaled = -0.413, 
                               T.scaled  = rcp85$Tx_50.scaled,RWI_1 = 0.103, 
                               RWI_2 = 0.103, struct.cohort.code = rcp85$struct.cohort.code, site = rcp85$site)
future.probe_50$year <- 2050

fut <- rbind(future.probe_50, future.probe_70)




lag2.model.by_structure_x_cohort_t_pr <- jags.model(textConnection(population_model_structure_x_cohort_sites_re_lag2_temp_MAP.f), 
                    data = list(Y=log(train.dry$RWI), n=length(train.dry$RWI), DI.scaled = train.dry$DI.scaled, DBH.scaled = train.dry$DBH.scaled,log_RWI_1 = log(train.dry$RWI_1),log_RWI_2 = log(train.dry$RWI_2), Temp.scaled = train.dry$T.scaled, struct.cohort = as.numeric(train.dry$struct.cohort.code), SF = as.numeric(unique(train.dry$struct.cohort.code)), site = as.numeric(train.dry$site), Nsites = length(unique(train.dry$site)), np = length(test.dry$DBH.scaled),
  struct.cohort.p = as.numeric(test.dry$struct.cohort.code), DBH.scaled.p = test.dry$DBH.scaled, DI.scaled.p = test.dry$DI.scaled, log_RWI_1.p = log(test.dry$RWI_1), log_RWI_2.p = log(test.dry$RWI_2), Temp.scaled.p = test.dry$T.scaled, site.p = as.numeric(test.dry$site), SFp = as.numeric(unique(test.dry$struct.cohort.code))),
  n.chains = 3, n.adapt = 100)

update(lag2.model.by_structure_x_cohort_t_pr, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort_t_pr, 
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","beta6","sigma", "mu_beta1", "mu_beta2","mu_beta3", "mu_beta4","mu_beta5", "mu_beta6","b1", "b2", "b3", "b4", "b5", "b6"), 
                    n.chains = 3, n.iter=10000, thin = 15)

summary(samp.structure.cohort.re)
plot(samp.structure.cohort.re)

gelman.diag(samp.structure.cohort.re, multivariate = FALSE)
acfplot(samp.structure.cohort.re)

autocorr.plot(samp.structure.cohort.re [[1]][ , 'b2[1]'], auto.layout = FALSE, lwd = 4, col = "red", lag.max = 100)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/samps.rds")
  samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/samps.rds")
test.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/test.rds")
train.dry <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/train.rds")
Yfut.samps <- samps[, 1:length(fut$RWI_1)]
samps <- samps[,(length(fut$RWI_1)+1):length(colnames(samps))]
 Yp.samps <- samps[,1:(length(test.dry$RWI))] 
 Yprobe.samps <- samps[,(length(test.dry$RWI)+1):(length(probe$DI.scaled))] 
 alpha.samps  <- samps[,(length(test.dry$RWI)+ (length(probe$DI.scaled))+1):(length(test.dry$RWI)+(length(probe$DI.scaled))+ 4)]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,(length(test.dry$RWI)+ (length(probe$DI.scaled))+5):(length(test.dry$RWI)+ (length(probe$DI.scaled))+8)]
 beta3.samps <- samps[,(length(test.dry$RWI)+ (length(probe$DI.scaled))+9):(length(test.dry$RWI)+ (length(probe$DI.scaled))+12)]
 beta4.samps <- samps[,(length(test.dry$RWI)+ (length(probe$DI.scaled))+13):(length(test.dry$RWI)+(length(probe$DI.scaled))+ 16)]
 beta5.samps <- samps[,(length(test.dry$RWI)+(length(probe$DI.scaled))+ 17):(length(test.dry$RWI)+(length(probe$DI.scaled))+ 20)]
 beta6.samps <- samps[,(length(test.dry$RWI)+(length(probe$DI.scaled))+ 21):(length(test.dry$RWI)+(length(probe$DI.scaled))+ 24)]
 sigma.samps <- samps[,(length(test.dry$RWI)+ (length(probe$DI.scaled))+25)]
 sigma_betas <- samps[,(length(test.dry$RWI)+(length(probe$DI.scaled))+ 26):(length(test.dry$RWI)+(length(probe$DI.scaled))+ 31)]

 
 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test.dry$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test.dry$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)+theme_bw()

# note best model fit so far
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test.dry$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test.dry$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t_pr_dry_yrs", 
                            model.summary = "beta1.p[struct.cohort.p[i]] + beta2.p[struct.cohort.p[i]]*DI.scaled.p[i] + beta3.p[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4.p[struct.cohort.p[i]]*log_RWI_1.p[i] +beta5.p[struct.cohort.p[i]]*log_RWI_2.p[i] + beta6.p[struct.cohort.p[i]]*Temp.scaled.p[i]
 and multilevel by site",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)



# get difference between beta2.samps: (i.e are they different?)
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]

# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_beta3s.png")
par(mfrow=c(3,2))
hist(beta4.samps[,1], main = "beta4 Past-Forest")
hist(beta4.samps[,2], main = "beta4 Modern-Forest")
hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,4], main = "sigma beta4")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_beta4s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta5 Past-Forest")
hist(beta5.samps[,2], main = "beta5 Modern-Forest")
hist(beta5.samps[,3],  main = "beta5 Past-Savanna")
hist(beta5.samps[,4],  main = "beta5 Modern-Savanna")
hist(sigma_betas[,5], main = "sigma beta5")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_beta5s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta4 Past-Forest")
hist(beta5.samps[,2], main = "beta4 Modern-Forest")
hist(beta5.samps[,3],  main = "beta4 Past-Savanna")
hist(beta5.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,6], main = "sigma beta4")
dev.off()

# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <-c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
#colnames(b2) <- c(paste0(c(unique(train.dry$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Precipitation Index slope")

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH Index slope")


b4 <- data.frame(beta4.samps)
colnames(b4) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-1 Index slope")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Log_RWI-2 Index slope")

b6 <- data.frame(beta6.samps)
colnames(b6) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b6$num <- rownames(b6)
b6.m <- melt(b6, id.vars=c("num"))
b6.mplots <- ggplot(b6.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Summer Temperature slope")

png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/drougt_beta_marginal_distn_bycohort.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots, b5.mplots, b6.mplots)
dev.off()

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

# ------------------------- DOTPLOT MODEL SUMMARIES -----------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:

a1.sum <- a.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
a1.sum$variable <- factor(a1.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b2.sum <- b2.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b3.sum <- b3.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))


b4.sum <- b4.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.sum <- b5.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b6.sum <- b6.m %>% group_by(variable) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

# write out all the dotplots
int.dot <- ggplot(data.frame(a1.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot <- ggplot(data.frame(b2.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot <- ggplot(data.frame(b3.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot <- ggplot(data.frame(b4.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot <- ggplot(data.frame(b5.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot <- ggplot(data.frame(b6.sum), aes(x = mean.val, y = variable, color = variable, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/full_dot_plot_cohort_struct.png")
plot_grid(int.dot, b2.dot, b6.dot, b3.dot, b4.dot, b5.dot, ncol = 1)
dev.off()

# -------------------- DOTPLOTS by modern vs. past only ---------------------
# make dotplots for all the factors in the model--
# get summaries by struct-cohort class from the melted samples:
a.m$cohort <- ifelse(a.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
a1.sum.age <- a.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#a1.sum.age$variable <- factor(a1.sum.age$coohort, levels = c( "Past", "Modern"))

b2.m$cohort <- ifelse(b2.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
b2.sum.age <- b2.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b2.sum$variable <- factor(b2.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b3.m$cohort <- ifelse(b3.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b3.sum.age <- b3.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b3.sum$variable <- factor(b3.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b4.m$cohort <- ifelse(b4.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b4.sum.age <- b4.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b4.sum$variable <- factor(b4.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

b5.m$cohort <- ifelse(b5.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b5.sum.age <- b5.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b5.sum$variable <- factor(b5.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b6.m$cohort <- ifelse(b6.m$variable %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

b6.sum.age <- b6.m %>% group_by(cohort) %>% dplyr::summarise(mean.val = mean(value),
                                                   Ci.low = quantile(value, 0.025), 
                                                   Ci.high = quantile(value, 0.975))
#b6.sum$variable <- factor(b6.sum$variable, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

# write out all the dotplots
int.dot.age <- ggplot(data.frame(a1.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Intercept (alpha)")+xlim(-0.3, 0.8) + geom_vline(xintercept = 0, linetype = "dashed")

b2.dot.age <- ggplot(data.frame(b2.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Drought Sensitivity (Beta2)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b3.dot.age <- ggplot(data.frame(b3.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+xlim(-0.1, 0.25)+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated DBH Sensitivity (Beta3)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b4.dot.age <- ggplot(data.frame(b4.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated lag -1 growth coef. (Beta4)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

b5.dot.age <- ggplot(data.frame(b5.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y= element_blank())+xlab("Estimated lag -1 growth coef. (Beta5)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")


b6.dot.age <- ggplot(data.frame(b6.sum.age), aes(x = mean.val, y = cohort, color = cohort, size = 2))+geom_errorbarh( aes(xmin = Ci.low, xmax = Ci.high, size = 1,height = 0))+geom_point()+scale_color_manual(values = c("Past"='#2166ac', 'Modern' = "#b2182b"))+theme(legend.position = "none", axis.title.y = element_blank())+xlab("Estimated Max. Temp. sensitivity (Beta6)")+xlim(-0.3, 0.8)+ geom_vline(xintercept = 0, linetype = "dashed")

png(height = 12, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/full_dot_plot_cohort_only.png")
plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1)
dev.off()


png(height = 12, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/full_dot_plot_cohort_only.png")
plot_grid(int.dot.age, b2.dot.age, b6.dot.age, b3.dot.age, b4.dot.age, b5.dot.age, ncol = 1)
dev.off()


png(height = 12, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/full_dot_plot_cohort_and_cohortXstruct.png")
plot_grid(int.dot.age,int.dot,
         b2.dot.age , b2.dot, 
         b6.dot.age, b6.dot,
         b3.dot.age, b3.dot,
         b4.dot.age,  b4.dot,
         b5.dot.age, b5.dot, ncol = 2, align = "hv", labels = c("a","g",
                                                                "b","h",
                                                                "c","i",
                                                                "d","j",
                                                                "e","k",
                                                                "f","l"), label_x = 0.4)
dev.off()
#---------------------- More beta summary plots -----------------------------
png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots, b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.6))
dev.off()

# plot slightly differently:
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")

plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))

b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(-0.1, 0.25)+theme_black(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/param_marginal_distn_bycohort_struct_rb.png")
b2.dots.2
dev.off()

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(unique(train.dry$struct.cohort)[order(unique(train.dry[,c("struct.cohort", "struct.cohort.code")])[,2])])
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

library(cowplot)
png(width = 5, height = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/param_marginal_distn_bycohort_struct_1.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, b5.mplots,ncol = 1)
dev.off()

# --------------------make plots of probed predicted growth responses:
# plot probed values of tree growth predictions:
Yprobe <- data.frame(Yprobe.samps)
colnames(Yprobe) <- 1:length(Yprobe)
probe.m <- melt(Yprobe)
probe.m$RWI <- exp(probe.m$value) 
colnames(probe.m) <- c("num", "Ypred", "RWI")

probe$num <- 1:length(probe[,1])
colnames(probe) <- c("Drought", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "num")

# summarize by structure + cohort class only:
# summarize by structure + cohort class only:
probe$num <- as.factor(as.character(probe$num))
full.p <- probe

probtest.dry <- dplyr::inner_join(probe.m, full.p, by=c("num"))

prob <- probtest.dry
# save here:
saveRDS(prob, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/full_yprobe_preds.rds")
prob <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/full_yprobe_preds.rds")




# convert prob$Drought back to MAP:
library(DMwR)
DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)



prob$DBH <- as.numeric(round(unscale(vals = prob$DBH, norm.data = DBH.scaled))) 
prob$MAP <- as.numeric(round(unscale(vals = prob$Drought, norm.data = MAP.scaled)))
prob$Tmax <- as.numeric(round(unscale(vals = prob$Tmax, norm.data = T.scaled))) 


prob_10_60cm_avg <- prob %>% dplyr::filter(DBH == 3 | DBH == 27 | DBH == 63 , Tmax == 72 | Tmax == 89, RWI_1 == 0.285, RWI_2 == 0.103 ) 

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
 prob_10_60cm_avg <- merge(prob_10_60cm_avg,struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10 <- prob_10_60cm_avg %>% group_by(DBH, Drought, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

preds_ci_10_age <- prob_10_60cm_avg %>% group_by(DBH, Drought, Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with LOWER than average tree growth the years before:

prob_10_60cm_low <- prob %>% dplyr::filter(DBH == 3 | DBH == 27 | DBH == 63 , Tmax == 72 | Tmax == 89, RWI_1 == -1.215, RWI_2 == -1.397  ) 

 
 prob_10_60cm_low <- merge(prob_10_60cm_low, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10_low <- prob_10_60cm_low %>% group_by(DBH, Drought, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))


preds_ci_10_low_age <- prob_10_60cm_low %>% group_by(DBH, Drought, Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with HIGHER than average tree growth the years before:

prob_10_60cm_high <- prob %>% dplyr::filter(DBH == 3 | DBH == 27 | DBH == 63 , Tmax == 72 | Tmax == 89, RWI_1 == 1.785, RWI_2 == 1.603  ) 


 prob_10_60cm_high <- merge(prob_10_60cm_high, struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10_high <- prob_10_60cm_high %>% group_by(DBH, Drought, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

preds_ci_10_high_age <- prob_10_60cm_high %>% group_by(DBH, Drought, Tmax, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

#----------- plot drought response by max temperature and Dimaeter + cohort-struct class -----------

Drought.resp.DBH.temp.avgpyr <- ggplot(preds_ci_10, aes(Drought, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Tree growth (mm)")+xlab("Precipitation index")+theme_bw()



Drought.resp.DBH.temp.lowpyr <- ggplot(preds_ci_10_low, aes(Drought, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+xlab("Precipitation index")+theme_bw()


Drought.resp.DBH.temp.highpyr <- ggplot(preds_ci_10_high, aes(Drought, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+xlab("Precipitation index")+theme_bw()


# output the above plots to PNG:
png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/MAP_response_low_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.lowpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/MAP_response_avg_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.avgpyr 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/MAP_response_high_prevyr_high_temp_low_high_DBH.png")
Drought.resp.DBH.temp.highpyr 
dev.off()


#----------- plot drought response by max temperature and Dimaeter + AGECLASS -----------

Drought.resp.DBH.temp.avgpyr.age <- ggplot(preds_ci_10_age, aes(Drought, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Precipitation index")+theme_bw(base_size = 12)




Drought.resp.DBH.temp.lowpyr.age <- ggplot(preds_ci_10_low_age, aes(Drought, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_10_low_age,aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Precipitation index")+theme_bw(base_size = 12)


Drought.resp.DBH.temp.highpyr.age<- ggplot(preds_ci_10_high_age, aes(Drought, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax),labeller=label_both)+ylab("Predicted Tree growth (mm)")+xlab("Precipitation index")+theme_bw(base_size = 12)


# output the above plots to PNG:
png(height = 6, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/MAP_response_low_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.lowpyr.age 
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/MAP_response_avg_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.avgpyr.age+theme_bw(base_size = 14)
dev.off()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/MAP_response_high_prevyr_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.highpyr.age 
dev.off()





#--------------- plot marginal effects of climate and previous years growth ----------------

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

 prob <- left_join(prob, struc.conversion, by  = "struct.cohort")

 # Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, ageclass) %>% summarise(meanY = mean(RWI),                                                                           Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Total Annual Precipitation (mm)")+ylim(0, 10)+theme_bw()


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("Max. Temp. (DegF)")+ylim(0,10)+theme_bw()

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)") + xlab("Tree DBH (cm)")+ylim(0,10)+theme_bw()

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-1) Year's growth)")+ylim(0, 10)+theme_bw()

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2,meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Tree growth (mm)")+xlab("log(Previous (-2) Year's growth)")+ylim(0, 10)+theme_bw()


legend <- get_legend(Y_MAP_marg)

png(height = 10, width = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_post_predictive_effects_ageclass.png")
plts <- plot_grid(Y_MAP_marg+theme(legend.position = "none"), Y_Tmax_marg+theme(legend.position = "none"), Y_DBH_marg+theme(legend.position = "none"), Y_RWI_1_marg+theme(legend.position = "none"), Y_RWI_2_marg+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()

# --------------plot marginal effects for each stand structure and cohort class:
# plot marginal effects of climate and previous years growth 
# Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg_c <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_MAP, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Total Precipitation")


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg_c <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Max. Temperature (DegF)")

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg_c <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("Tree DBH (cm)")

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg_c <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI1, aes(x = RWI_1, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-1) year's growth)")

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg_c <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_RWI2, aes(x = RWI_2, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("Tree growth")+ylim(0, 10)+xlab("log(Prev (-2) year's growth)")

png(height = 10, width = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr_dry_yrs/marginal_post_predictive_effects_ageclassXStruct.png")
legend <- get_legend(Y_MAP_marg_c)
plts <- plot_grid(Y_MAP_marg_c+theme(legend.position = "none"), Y_Tmax_marg_c+theme(legend.position = "none"), Y_DBH_marg_c+theme(legend.position = "none"), Y_RWI_1_marg_c+theme(legend.position = "none"), Y_RWI_2_marg_c+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.45))
dev.off()



# below is some extra code

# -------plot point estimates of growth based on low moisutre under hot and cold conditions by DBH, colored by cohort x stand, and with facets by previous years growth:

prob_lowMAP <- prob %>% dplyr::filter(MAP == 223 , Tmax == 71 | Tmax == 89 , RWI_1 == -1.215 | RWI_1 == 0.285 | RWI_1 == 1.785 , RWI_2 == -1.397 | RWI_2 == 0.103 | RWI_2 == 1.603 ) 

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
prob_lowMAP <- merge(prob_lowMAP,struc.conversion, by  = "struct.cohort")
 
 
prob_lowMAP_ci <- prob_lowMAP %>% group_by(DBH,  Tmax, RWI_1, RWI_2, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

ggplot(prob_lowMAP_ci[prob_lowMAP_ci$Tmax == 89,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)

#ggplot(prob_lowMAP_ci[prob_lowMAP_ci$Tmax == 88,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)

# same but for high MAP
prob_highMAP <- prob %>% dplyr::filter(MAP == 970 , Tmax == 71 | Tmax == 88 , RWI_1 == -1.215 | RWI_1 == 0.285 | RWI_1 == 1.785 , RWI_2 == -1.397 | RWI_2 == 0.103 | RWI_2 == 1.603) 

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
prob_highMAP <- merge(prob_highMAP,struc.conversion, by  = "struct.cohort")
 
 
prob_highMAP_ci <- prob_highMAP %>% group_by(DBH,  Tmax, RWI_1, RWI_2, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

ggplot(prob_highMAP_ci[prob_highMAP_ci$Tmax == 71,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)+theme_bw()

ggplot(prob_highMAP_ci[prob_highMAP_ci$Tmax == 88,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)+theme_bw()

#ggplot(prob_highMAP_ci[prob_highMAP_ci$RWI_2 == -1.397 & prob_highMAP_ci$RWI_1 == -1.466,], aes(DBH, Tmax,fill = meanY))+geom_tile()+facet_grid(~cohort) 




# ----------------------- Plot future predictions ------------------------

Yfut.samps <- data.frame(Yfut.samps)



colnames(Yfut.samps) <- paste0(fut$site, "_",fut$year)
Yfut.samps$num <- 1:length(Yfut.samps$AVO_2015)
fut.m <- melt(Yfut.samps)
fut.m$RWI <- exp(fut.m$value)
colnames(fut.m) <- c("site_year", "Ypred", "RWI")

fut$site_year <- paste0(fut$site, "_",fut$year)
colnames(fut) <- c("MAP", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "site", "year", "site_year")

# summarize by structure + cohort class only:

fut.proj <- dplyr::inner_join(fut.m, fut, by=c("site_year"))

fut.summary <- fut.proj %>% group_by(site_year) %>% summarise(meanY = mean(RWI), Ci.low =quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

fut.sum<- merge(fut.summary, fut, by = "site_year")

 #ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()
 ggplot(fut.sum, aes(MAP, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
 ggplot(fut.sum, aes(Tmax, meanY, color = struct.cohort))+geom_point()+geom_errorbar(data = fut.sum, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, color = struct.cohort), alpha = 0.25, colour = NA)+facet_wrap(~year)
 
  ggplot(fut.sum, aes(site, meanY, fill = year))+geom_point(position = "dodge2")+geom_errorbar(data = fut.sum, aes(x =site, ymin = Ci.low, ymax = Ci.high, color = year))+facet_wrap(~year)+ylim(0,5)
 

```
 
#model with temperature, precipitation, stand structure by ageclass random effects and prev years growth (lag -1) and (lag - 2):
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
population_model_structure_x_cohort_re_lag2_temp <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] # use Drought index as a scaled variable 

#r1[i] <- Y[i] - gfunc[i]   

}

#RSS[1] <- sum(r1^2)

# Prediction from known data
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4[struct.cohort.p[i]]*log_RWI_1.p[i] +beta5[struct.cohort.p[i]]*log_RWI_2.p[i] + beta6[struct.cohort.p[i]]*Temp.scaled.p[i]
  }

# probe for prediction plots:
  for(i in 1:nprobe){
    Yprobe[i]  ~ dnorm(muprobe[i],inv.var)
    muprobe[i] <- beta1[struct.cohort.probe[i]] + beta2[struct.cohort.probe[i]]*DI.scaled.probe[i] + beta3[struct.cohort.probe[i]]*DBH.scaled.probe[i] +beta4[struct.cohort.probe[i]]*log_RWI_1.probe[i] +beta5[struct.cohort.probe[i]]*log_RWI_2.probe[i] + beta6[struct.cohort.probe[i]]*Temp.scaled.probe[i]
  }

# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
beta5[s] ~ dnorm(mu_beta5, inv_beta5)
beta6[s] ~ dnorm(mu_beta5, inv_beta6)
}



# use normalpriors for each  beta paramters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)
mu_beta4 ~ dunif(-2, 2)
mu_beta5 ~ dunif(-2, 2)
mu_beta6 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)
inv_beta6   ~ dgamma(0.01, 0.01)
sigma_beta6 <- 1/sqrt(inv_beta6)

# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


}"





# save these for use later:
saveRDS(train, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t/train.rds")
saveRDS(test, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t/test.rds")
train <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t/train.rds")
test <- readRDS("outputs/growth_model/lag2_reg_struct_x_cohort_re_t/test.rds")
# generate probe dataset:
 DIprobe <- seq(range(train$DI.scaled)[1], range(train$DI.scaled)[2], by = 0.75)
 DBHprobe <- seq(range(train$DBH.scaled)[1], range(train$DBH.scaled)[2], by = 0.75)
 Tempprobe <- seq(range(train$T.scaled)[1], range(train$T.scaled)[2], by = 0.75)
 RWI1probe <- seq(range(log(train$RWI_1))[1], range(log(train$RWI_1))[2], by = 0.5)
 RWI2probe <- seq(range(log(train$RWI_2))[1], range(log(train$RWI_2))[2], by = 0.5)
 
 # expand into full probe
probe <- expand.grid(DI.scaled = DIprobe, DBH.scaled = DBHprobe, T.scaled = Tempprobe,
                         RWI_1 = RWI1probe, RWI_2= RWI2probe ,struct.cohort.code= 1:4)



lag2.model.by_structure_x_cohort <- jags.model(textConnection(population_model_structure_x_cohort_re_lag2_temp), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled,log_RWI_1 = log(train$RWI_1),log_RWI_2 = log(train$RWI_2), Temp.scaled = train$T.scaled, struct.cohort = as.numeric(train$struct.cohort.code), SF = unique(train$struct.cohort.code), np = length(test$DBH.scaled),
   struct.cohort.p = as.numeric(test$struct.cohort.code), DBH.scaled.p = test$DBH.scaled, DI.scaled.p = test$DI.scaled, log_RWI_1.p = log(test$RWI_1), log_RWI_2.p = log(test$RWI_2), Temp.scaled.p = test$T.scaled, nprobe = length(probe$DBH.scaled),
   struct.cohort.probe = as.numeric(probe$struct.cohort.code), DBH.scaled.probe = probe$DBH.scaled, DI.scaled.probe = probe$DI.scaled, log_RWI_1.probe = probe$RWI_1, log_RWI_2.probe = probe$RWI_2, Temp.scaled.probe = probe$T.scaled), n.chains = 3, n.adapt = 100)

update(lag2.model.by_structure_x_cohort, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort, 
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","beta6","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3", "sigma_beta4","sigma_beta5", "sigma_beta6","Yp", "Yprobe"), 
                    n.chains = 3, n.iter=2000, thin = 15)


dic.full <- dic.samples(lag2.model.by_structure_x_cohort, n.chains = 3, n.iter=2000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/lag2_reg_struct_x_cohort_re_t_DIC.rds")
#summary(samp.structure.cohort.re)
#plot(samp.structure.cohort.re)

#gelman.diag(samp.structure.cohort.re)
#acfplot(samp.structure.cohort.re)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/lag2_reg_struct_x_cohort_re_t/samps.rds")
  samps <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t/samps.rds")
test <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t/test.rds")
train <- readRDS("outputs//growth_model/lag2_reg_struct_x_cohort_re_t/train.rds")

 Yp.samps <- samps[,1:(length(test$RWI))] 
 Yprobe.samps <- samps[,(length(test$RWI)+1):(length(probe$DI.scaled))] 
 alpha.samps  <- samps[,(length(test$RWI)+ (length(probe$DI.scaled))+1):(length(test$RWI)+(length(probe$DI.scaled))+ 4)]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,(length(test$RWI)+ (length(probe$DI.scaled))+5):(length(test$RWI)+ (length(probe$DI.scaled))+8)]
 beta3.samps <- samps[,(length(test$RWI)+ (length(probe$DI.scaled))+9):(length(test$RWI)+ (length(probe$DI.scaled))+12)]
 beta4.samps <- samps[,(length(test$RWI)+ (length(probe$DI.scaled))+13):(length(test$RWI)+(length(probe$DI.scaled))+ 16)]
 beta5.samps <- samps[,(length(test$RWI)+(length(probe$DI.scaled))+ 17):(length(test$RWI)+(length(probe$DI.scaled))+ 20)]
 beta6.samps <- samps[,(length(test$RWI)+(length(probe$DI.scaled))+ 21):(length(test$RWI)+(length(probe$DI.scaled))+ 24)]
 sigma.samps <- samps[,(length(test$RWI)+ (length(probe$DI.scaled))+25)]
 sigma_betas <- samps[,(length(test$RWI)+(length(probe$DI.scaled))+ 26):(length(test$RWI)+(length(probe$DI.scaled))+ 31)]

 
 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps)) ~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note best model fit so far
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t", 
                            
                      model.summary = "beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +   beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]  + beta6[struct.cohort[i]]*Temp.scaled[i] # use Drought index as a scaled variable 
",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)



# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "lag2_reg_struct_x_cohort_re_t", 
                           train = "cohort.omit", 
                           DI.scaled = "JJApdsi")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)



# get difference between beta2.samps: (i.e are they different?)
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]
# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t/marginal_beta3s.png")
par(mfrow=c(3,2))
hist(beta4.samps[,1], main = "beta4 Past-Forest")
hist(beta4.samps[,2], main = "beta4 Modern-Forest")
hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,4], main = "sigma beta4")
dev.off()

png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t/marginal_beta4s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta5 Past-Forest")
hist(beta5.samps[,2], main = "beta5 Modern-Forest")
hist(beta5.samps[,3],  main = "beta5 Past-Savanna")
hist(beta5.samps[,4],  main = "beta5 Modern-Savanna")
hist(sigma_betas[,5], main = "sigma beta5")
dev.off()


png("outputs/growth_model/lag2_reg_struct_x_cohort_re_t/marginal_beta5s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta4 Past-Forest")
hist(beta5.samps[,2], main = "beta4 Modern-Forest")
hist(beta5.samps[,3],  main = "beta4 Past-Savanna")
hist(beta5.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,6], main = "sigma beta4")
dev.off()

# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0("alpha-",c(unique(train$struct.cohort))))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Drought Index slope")

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))

b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0, 0.15)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_reg_struct_x_cohort_re_t/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots+ xlim(0, 0.15), b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.6))
dev.off()

# plot slightly differently:
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")

plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))

b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0, 0.15)+theme_black(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t/param_marginal_distn_bycohort_struct_rb.png")
b2.dots.2
dev.off()

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0("beta3-",c(unique(train$struct.cohort))))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(paste0("beta4-",c(unique(train$struct.cohort))))
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(paste0("beta5-",c(unique(train$struct.cohort))))
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

library(cowplot)
png(width = 5, height = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t/param_marginal_distn_bycohort_struct.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, b5.mplots,ncol = 1)
dev.off()

# --------------------make plots of probed predicted growth responses:
# plot probed values of tree growth predictions:
Yprobe <- data.frame(Yprobe.samps)
colnames(Yprobe) <- 1:length(Yprobe)
probe.m <- melt(Yprobe)
probe.m$RWI <- exp(probe.m$value) 
colnames(probe.m) <- c("num", "Ypred", "RWI")

probe$num <- 1:length(probe[,1])
colnames(probe) <- c("Drought", "DBH","Tmax", "RWI_1","RWI_2","struct.cohort", "num")

# summarize by structure + cohort class only:
full.p <- probe
full.p$num <- as.factor(as.character(full.p$num))
prob <- dplyr::inner_join(probe.m, full.p, by=c("num"))


preds_ci <- prob %>% group_by(num, DBH,Drought,Tmax, RWI_1,RWI_2,struct.cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

ggplot(preds_ci, aes(Drought, meanY, color = as.factor(struct.cohort)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()+facet_wrap(~as.factor(DBH))



ggplot(prob, aes(x = Ypred, y = as.factor(Drought))) + 
  geom_density_ridges()+facet_grid(~ DBH)+coord_flip()

# summarize by ageclass only:
prob$ageclass <- ifelse(prob$struct.cohort %in% c("1", "3"),"Past","Modern")
dbh.df <- data.frame(DBH = unique(prob$DBH)[order(unique(prob$DBH))], DBH.class = c("10cm", "20cm", "30cm", "40cm", "50cm", "60cm","70cm", "80cm"))


prob <- merge(dbh.df, prob, by = "DBH")

preds_ci_mod_past <- prob %>% group_by( DBH.class,Drought,Tmax,RWI_1,RWI_2, ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

preds_ci_mod_past$DBH.class <- factor(preds_ci_mod_past$DBH.class, levels = c("10cm", "20cm", "30cm", "40cm", "50cm", "60cm", "70cm"))
preds_ci_mod_past$PDSI <- unscale(preds_ci_mod_past$Drought, norm.data = DI.scaled)

preds.gg <- ggplot(preds_ci_mod_past, aes(PDSI, meanY, color = as.factor(ageclass)))+
  geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = as.factor(ageclass)), alpha = 0.1, linetype = "dashed")+scale_color_manual (values = c("Modern" = "red", "Past" = "blue"))+stat_smooth()+facet_wrap(~DBH.class)+theme(legend.title = element_blank())+ylab("Predicted Ring Width")
 


png(height = 8, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t/predicted_growth_mod_past_CI.png")
preds.gg
dev.off()


preds_ci_mod_past$ageclass <- factor(preds_ci_mod_past$ageclass, levels = c("Past", "Modern"))
gg.tile.past.mod <- ggplot(preds_ci_mod_past, aes(PDSI, DBH.class, fill = meanY))+geom_raster()+facet_wrap(~ageclass, ncol = 1)+scale_fill_distiller(palette = "BrBG", direction = 1, name = "Tree \nGrowth")+ylab("Tree diameter")+xlab("Palmer Drought Severity Index")+theme_bw(base_size = 12)


png(height = 4, width = 3, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t/predicted_growth_mod_past_tile.png")
gg.tile.past.mod
dev.off()

preds_ci <- prob %>% group_by( DBH, Tmax, Drought, RWI_1, RWI_2, struct.cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

ggplot(preds_ci, aes(Drought, meanY, color = as.factor(struct.cohort)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()+facet_wrap(~as.factor(DBH))



# plot response to sp01-drought for small and large DBH trees in savanna + forest for modern + past
# with sp06 = very droughty, an average prev years growth:
# convert prob$Drought back to MAP:
library(DMwR)
DIprobe <- round(seq(range(train$MAP.scaled)[1], range(train$MAP.scaled)[2], by = 0.75), 3)



prob$DBH <- as.numeric(round(unscale(vals = prob$DBH, norm.data = DBH.scaled))) 
prob$MAP <- as.numeric(round(unscale(vals = prob$Drought, norm.data = MAP.scaled)))
prob$Tmax <- as.numeric(round(unscale(vals = prob$Tmax, norm.data = T.scaled))) 
#prob$DBH <- round(unscale(vals = prob$DBH, norm.data = DBH.scaled)) 
#get labels for structure and cohort


prob_10_60cm_avg <- prob %>% dplyr::filter(DBH == 9 | DBH == 33 | DBH == 69 , Tmax == 68 | Tmax == 88, RWI_1 == 0.034, RWI_2 == 0.103 ) 

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
 prob_10_60cm_avg <- merge(prob_10_60cm_avg,struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10 <- prob_10_60cm_avg %>% group_by(DBH, Drought, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

# same thing but with lower than average tree growth the years before:

prob_10_60cm_low <- prob %>% dplyr::filter(DBH == 9 | DBH == 33 | DBH == 69 , Tmax == 68 | Tmax == 88, RWI_1 == -1.466, RWI_2 == -1.397 ) 

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
 prob_10_60cm_low <- merge(prob_10_60cm_low,struc.conversion, by  = "struct.cohort")
 
 
preds_ci_10_low <- prob_10_60cm_low %>% group_by(DBH, Drought, Tmax, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))


#----------- plot drought response by max temperature and Dimaeter

ggplot(preds_ci_10, aes(Drought, meanY, color = cohort))+geom_point()+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax))

ggplot(preds_ci_10, aes(Drought, meanY, color = as.factor(DBH)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()+facet_grid(vars(cohort) , vars(Tmax))

# same plots but with lower than average tree growth the years before:
ggplot(preds_ci_10_low, aes(Drought, meanY, color = cohort))+geom_point()+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax))

ggplot(preds_ci_10_low, aes(Drought, meanY, color = as.factor(DBH)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()+facet_grid(vars(cohort) , vars(Tmax))


ggplot(preds_ci_10_low, aes(Drought, DBH, fill = meanY))+geom_tile()+facet_grid(vars(cohort) , vars(Tmax))

# -------plot point estimates of growth based on low moisutre under hot and cold conditions by DBH, colored by cohort x stand, and with facets by previous years growth:

prob_lowMAP <- prob %>% dplyr::filter(MAP == 225 , Tmax == 68 | Tmax == 88 , RWI_1 == -1.466 | RWI_1 == 0.034 | RWI_1 == 1.534 , RWI_2 == -1.397 | RWI_2 == 0.103 | RWI_2 == 1.603 ) 

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
prob_lowMAP <- merge(prob_lowMAP,struc.conversion, by  = "struct.cohort")
 
 
prob_lowMAP_ci <- prob_lowMAP %>% group_by(DBH,  Tmax, RWI_1, RWI_2, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

ggplot(prob_lowMAP_ci[prob_lowMAP_ci$Tmax == 68,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)

ggplot(prob_lowMAP_ci[prob_lowMAP_ci$Tmax == 88,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)

# same but for high MAP
prob_highMAP <- prob %>% dplyr::filter(MAP == 1094 , Tmax == 68 | Tmax == 88 , RWI_1 == -1.466 | RWI_1 == 0.034 | RWI_1 == 1.534 , RWI_2 == -1.397 | RWI_2 == 0.103 | RWI_2 == 1.603 ) 

 struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
prob_highMAP <- merge(prob_highMAP,struc.conversion, by  = "struct.cohort")
 
 
prob_highMAP_ci <- prob_highMAP %>% group_by(DBH,  Tmax, RWI_1, RWI_2, struct.cohort, cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

ggplot(prob_highMAP_ci[prob_highMAP_ci$Tmax == 68,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)+theme_bw()

ggplot(prob_highMAP_ci[prob_highMAP_ci$Tmax == 88,], aes(DBH, meanY, color = cohort))+geom_point()+facet_grid(vars(RWI_1), vars(RWI_2)) + ylim(0,6)+theme_bw()

#ggplot(prob_highMAP_ci[prob_highMAP_ci$RWI_2 == -1.397 & prob_highMAP_ci$RWI_1 == -1.466,], aes(DBH, Tmax,fill = meanY))+geom_tile()+facet_grid(~cohort) 


#------- get sensitivity to temperature by dbh, site, etc.
preds_ci <- prob %>% group_by(num, DBH,Drought,Tmax, RWI_1,RWI_2,struct.cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

ggplot(preds_ci, aes(Drought, meanY, color = as.factor(struct.cohort)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()+facet_wrap(~as.factor(DBH))



ggplot(prob, aes(x = Ypred, y = as.factor(Drought))) + 
  geom_density_ridges()+facet_grid(~ DBH)+coord_flip()

# summarize by ageclass only:
prob$ageclass <- ifelse(prob$struct.cohort %in% c("1", "3"),"Past","Modern")
dbh.df <- data.frame(DBH = unique(prob$DBH)[order(unique(prob$DBH))], DBH.class = c(">5cm", "10cm", "20cm", "30cm", "45cm", "60cm","70cm", "80cm"))


prob <- merge(dbh.df, prob, by = "DBH")

preds_ci_mod_past <- prob %>% group_by( DBH.class,DBH,Drought,Tmax,RWI_1,RWI_2, ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

preds_ci_mod_past$DBH.class <- factor(preds_ci_mod_past$DBH.class, levels = c(">5cm", "20cm", "30cm", "45cm", "60cm", "70cm", "80cm"))


preds.gg <- ggplot(preds_ci_mod_past[preds_ci_mod_past$Tmax == 68 & preds_ci_mod_past$RWI_1 == -1.966  & preds_ci_mod_past$RWI_2 == -1.897,], aes(Drought, meanY, color = as.factor(ageclass)))+geom_line()+
  geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = as.factor(ageclass)), alpha = 0.1, linetype = "dashed")+scale_color_manual (values = c("Modern" = "red", "Past" = "blue"))+facet_wrap(~DBH.class)+theme(legend.title = element_blank())+ylab("Predicted Ring Width")
 

ggplot(preds_ci_mod_past[preds_ci_mod_past$Tmax == 88 & preds_ci_mod_past$RWI_1 == -1.966  & preds_ci_mod_past$RWI_2 == -1.897,], aes(Drought, meanY, color = as.factor(ageclass)))+geom_line()+
  geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = as.factor(ageclass)), alpha = 0.1, linetype = "dashed")+scale_color_manual (values = c("Modern" = "red", "Past" = "blue"))+facet_wrap(~DBH.class)+theme(legend.title = element_blank())+ylab("Predicted Ring Width")
 

ggplot(preds_ci_mod_past[preds_ci_mod_past$Tmax == 68 & preds_ci_mod_past$RWI_1 == 0.034  & preds_ci_mod_past$RWI_2 == 0.103,], aes(Drought, meanY, color = as.factor(ageclass)))+geom_line()+
  geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = as.factor(ageclass)), alpha = 0.1, linetype = "dashed")+scale_color_manual (values = c("Modern" = "red", "Past" = "blue"))+facet_wrap(~DBH.class)+theme(legend.title = element_blank())+ylab("Predicted Ring Width")
 

ggplot(preds_ci_mod_past[preds_ci_mod_past$Tmax == 88 & preds_ci_mod_past$RWI_1 == 0.034  & preds_ci_mod_past$RWI_2 == 0.103,], aes(Drought, meanY, color = as.factor(ageclass)))+geom_line()+
  geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = as.factor(ageclass)), alpha = 0.1, linetype = "dashed")+scale_color_manual (values = c("Modern" = "red", "Past" = "blue"))+facet_wrap(~DBH.class)+theme(legend.title = element_blank())+ylab("Predicted Ring Width")
 

ggplot(preds_ci_mod_past[preds_ci_mod_past$Tmax == 68 & preds_ci_mod_past$RWI_1 == 1.534  & preds_ci_mod_past$RWI_2 == 1.603,], aes(Drought, meanY, color = as.factor(ageclass)))+geom_line()+
  geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = as.factor(ageclass)), alpha = 0.1, linetype = "dashed")+scale_color_manual (values = c("Modern" = "red", "Past" = "blue"))+facet_wrap(~DBH.class)+theme(legend.title = element_blank())+ylab("Predicted Ring Width")
 

ggplot(preds_ci_mod_past[preds_ci_mod_past$Tmax == 88 & preds_ci_mod_past$RWI_1 == 1.534  & preds_ci_mod_past$RWI_2 == 1.603,], aes(Drought, meanY, color = as.factor(ageclass)))+geom_line()+
  geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = as.factor(ageclass)), alpha = 0.1, linetype = "dashed")+scale_color_manual (values = c("Modern" = "red", "Past" = "blue"))+facet_wrap(~DBH.class)+theme(legend.title = element_blank())+ylab("Predicted Ring Width")
 

# plot marginal effects of climate and previous years growth 
# Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg<- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = ageclass))+geom_smooth(data = preds_ci_mod_past_MAP,aes(x = MAP, y = meanY))+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Mean Predicted Tree growth")+ylim(0.5, 2.5)


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg<- ggplot(preds_ci_mod_past_Tmax, aes(Tmax,meanY, color = ageclass))+geom_smooth(data = preds_ci_mod_past_Tmax,aes(x = Tmax, y = meanY))+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Mean Predicted Tree growth")+ylim(0.5,2.5)

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg <- ggplot(preds_ci_mod_past_DBH, aes(DBH,meanY, color = ageclass))+geom_smooth(data = preds_ci_mod_past_DBH,aes(x = DBH, y = meanY))+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Mean Predicted Tree growth")+ylim(0.5,2.5)

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1,meanY, color = ageclass))+geom_smooth(data = preds_ci_mod_past_RWI1,aes(x = RWI_1, y = meanY))+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Mean Predicted Tree growth")+xlab("Previous (-1) Year's growth")+ylim(0, 4)

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2,ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg<- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2,meanY, color = ageclass))+geom_smooth(aes(x = RWI_2, y = meanY))+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("Mean Predicted Tree growth")+ylim(0, 4)+xlab("-2 Year's growth")



png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/marginal_post_predictive_effects_ageclass.png")
plot_grid(Y_MAP_marg, Y_Tmax_marg, Y_DBH_marg,Y_RWI_1_marg, Y_RWI_2_marg, align = "v", nrow = 3)
dev.off()

# --------------plot marginal effects for each stand structure and cohort class:
struc.conversion <- data.frame(struct.cohort = 1:4, cohort = c(paste0(c(unique(train$struct.cohort)))))
prob <- merge(prob, struc.conversion, by  = "struct.cohort")
 
# plot marginal effects of climate and previous years growth 
# Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP,cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_MAP_marg_c <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = cohort))+geom_smooth(data = preds_ci_mod_past_MAP,aes(x = MAP, y = meanY))+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) + ylab("Mean Predicted Tree growth")+ylim(0.5, 2.5)


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_Tmax_marg_c <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax,meanY, color = cohort))+geom_smooth(data = preds_ci_mod_past_Tmax,aes(x = Tmax, y = meanY))+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) + ylab("Mean Predicted Tree growth")+ylim(0.5,2.5)

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_DBH_marg_c <- ggplot(preds_ci_mod_past_DBH, aes(DBH,meanY, color = cohort))+geom_smooth(data = preds_ci_mod_past_DBH,aes(x = DBH, y = meanY))+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))  + ylab("Mean Predicted Tree growth")+ylim(0.5,2.5)

# marginal lag-1 effect
preds_ci_mod_past_RWI1 <- prob %>% group_by( RWI_1, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_1_marg_c <- ggplot(preds_ci_mod_past_RWI1, aes(RWI_1,meanY, color = cohort))+geom_smooth(data = preds_ci_mod_past_RWI1,aes(x = RWI_1, y = meanY))+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))  + ylab("Mean Predicted Tree growth")+xlab("Previous (-1) Year's growth")+ylim(0, 4)

# marginal lag-2 effect
preds_ci_mod_past_RWI2 <- prob %>% group_by( RWI_2, cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))

Y_RWI_2_marg_c <- ggplot(preds_ci_mod_past_RWI2, aes(RWI_2,meanY, color = cohort))+geom_smooth(aes(x = RWI_2, y = meanY))+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) + ylab("Mean Predicted Tree growth")+ylim(0, 4)+xlab("-2 Year's growth")



png(height = 10, width = 10, units = "in", res = 300, "outputs/growth_model/lag2_reg_struct_x_cohort_re_t_pr/marginal_post_predictive_effects_ageclass_cohort.png")
plot_grid(Y_MAP_marg_c, Y_Tmax_marg_c, Y_DBH_marg_c,Y_RWI_1_marg_c, Y_RWI_2_marg_c, align = "v", nrow = 3)
dev.off()




```

#model with stand structure by ageclass random effects and prev years growth (lag -1) and (lag - 2), but not log transformed:
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
model_structure_x_cohort_re_lag2 <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i]+beta4[struct.cohort[i]]*log_RWI_1[i]+beta5[struct.cohort[i]]*log_RWI_2[i]   # use Drought index as a scaled variable 

#r1[i] <- Y[i] - gfunc[i]   

}

#RSS[1] <- sum(r1^2)

# Prediction
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] +beta4[struct.cohort.p[i]]*log_RWI_1.p[i] +beta5[struct.cohort.p[i]]*log_RWI_2.p[i] 
  }

# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
beta5[s] ~ dnorm(mu_beta5, inv_beta5)

}



# use normalpriors for each  beta paramters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)
mu_beta4 ~ dunif(-2, 2)
mu_beta5 ~ dunif(-2, 2)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)

# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


}"





# save these for use later:
saveRDS(train, "outputs/growth_model/lag2_untrans_reg_struct_x_cohort_re/train.rds")
saveRDS(test, "outputs/growth_model/lag2_untrans_reg_struct_x_cohort_re/test.rds")



lag2.model.by_structure_x_cohort <- jags.model(textConnection(model_structure_x_cohort_re_lag2), 
                    data = list(Y=train$RWI, n=length(train$RWI), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled,log_RWI_1 = log(train$RWI_1),log_RWI_2 = train$RWI_2, struct.cohort = as.numeric(train$struct.cohort.code), SF = unique(train$struct.cohort.code), np = length(test$DBH.scaled),
   struct.cohort.p = as.numeric(test$struct.cohort.code), DBH.scaled.p = test$DBH.scaled, DI.scaled.p = test$DI.scaled, log_RWI_1.p = test$RWI_1, log_RWI_2.p = test$RWI_2), n.chains = 3, n.adapt = 100)

update(lag2.model.by_structure_x_cohort, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.cohort.re <- coda.samples(lag2.model.by_structure_x_cohort, 
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3", "sigma_beta4","sigma_beta5","Yp"), 
                    n.chains = 3, n.iter=20000, thin = 15)

#summary(samp.structure.cohort.re)
#plot(samp.structure.cohort.re)

#gelman.diag(samp.structure.cohort.re)
#acfplot(samp.structure.cohort.re)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.cohort.re[[1]]
 saveRDS(samps, "outputs//growth_model/lag2_untrans_reg_struct_x_cohort_re/samps.rds")
  samps <- readRDS("outputs//growth_model/lag2_untrans_reg_struct_x_cohort_re/samps.rds")

 Yp.samps <- samps[,1:(length(test$RWI))] 
 alpha.samps  <- samps[,(length(test$RWI)+ 1):(length(test$RWI)+ 4)]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,(length(test$RWI)+ 5):(length(test$RWI)+ 8)]
 beta3.samps <- samps[,(length(test$RWI)+ 9):(length(test$RWI)+ 12)]
 beta4.samps <- samps[,(length(test$RWI)+ 13):(length(test$RWI)+ 16)]
 beta5.samps <- samps[,(length(test$RWI)+ 17):(length(test$RWI)+ 20)]
 sigma.samps <- samps[,(length(test$RWI)+ 21)]
 sigma_betas <- samps[,(length(test$RWI)+ 22):(length(test$RWI)+ 26)]

 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(value),
                                                  ci.hi = quantile(value,0.975),
                                                 ci.lo = quantile(value,0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(Yp.samps)~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/lag2_untrans_reg_struct_x_cohort_re/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(Yp.samps)-test$RWI)^2)
BIAS1  <- mean(colMeans(Yp.samps)-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "lag2_untrans_reg_struct_x_cohort_re", 
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)



# get difference between beta2.samps: (i.e are they different?)
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]
# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/llag2_untrans_reg_struct_x_cohort_re/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/lag2_untrans_reg_struct_x_cohort_re/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/lag2_untrans_reg_struct_x_cohort_re/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


png("outputs/growth_model/lag2_untrans_reg_struct_x_cohort_re/marginal_beta3s.png")
par(mfrow=c(3,2))
hist(beta4.samps[,1], main = "beta4 Past-Forest")
hist(beta4.samps[,2], main = "beta4 Modern-Forest")
hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
hist(sigma_betas[,4], main = "sigma beta4")
dev.off()

png("outputs/growth_model/lag2_untrans_reg_struct_x_cohort_re/marginal_beta3s.png")
par(mfrow=c(3,2))
hist(beta5.samps[,1], main = "beta5 Past-Forest")
hist(beta5.samps[,2], main = "beta5 Modern-Forest")
hist(beta5.samps[,3],  main = "beta5 Past-Savanna")
hist(beta5.samps[,4],  main = "beta5 Modern-Savanna")
hist(sigma_betas[,5], main = "sigma beta5")
dev.off()

# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0("alpha-",c(unique(train$struct.cohort))))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Drought Index slope")

b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))

b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c( "Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0, 0.15)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

png(height = 6, width = 12, units = "in", res = 300,"outputs/growth_model/lag2_untrans_reg_struct_x_cohort_re/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots+ xlim(0, 0.15), b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.6))
dev.off()

# plot slightly differently:
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Modern-Forest"), "Forest", "Savanna")

plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels= c("Past", "Modern"))

b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0, 0.15)+theme_black(base_size = 18)+facet_wrap(~forestclass)+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("Estimated Drought Sensitivity")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/lag2_untrans_reg_struct_x_cohort_re/param_marginal_distn_bycohort_struct_rb.png")
b2.dots.2
dev.off()

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0("beta3-",c(unique(train$struct.cohort))))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(paste0("beta4-",c(unique(train$struct.cohort))))
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(paste0("beta5-",c(unique(train$struct.cohort))))
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("lag - 1 effect")

library(cowplot)
png(width = 5, height = 10, units = "in", res = 300, "outputs/growth_model/lag2_untrans_reg_struct_x_cohort_re/param_marginal_distn_bycohort_struct.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, b5.mplots,ncol = 1)
dev.off()

```

# model for cohort effects and site level effects, heirarchically:
```{r}

cohort_model_site_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[cohort[i]] + beta2[cohort[i]]*DI.scaled[i] + beta3[cohort[i]]*DBH.scaled[i] + beta4[cohort[i]]*log_RWI_1[i]  # use Drought index as a scaled variable 
}



# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(S)){
beta1[s] ~ dnorm(mu_beta1[plot[s]], inv_beta1)
beta2[s] ~ dnorm(mu_beta2[plot[s]], inv_beta2)
beta3[s] ~ dnorm(mu_beta3[plot[s]], inv_beta3)
beta4[s] ~ dnorm(mu_beta4[plot[s]], inv_beta4)



}


for(j in 1:length(ind)){
# use normal hyperpriors for each hyperparamters 
mu_beta1[j] ~ dnorm(0, 0.5)
mu_beta2[j] ~ dnorm(0, 0.5)
mu_beta3[j] ~ dnorm(0, 0.5)
mu_beta4[j] ~ dnorm(0, 0.5)
}

inv_beta1   ~ dgamma(0.001, 0.001)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.001, 0.001)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.001, 0.001)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.001, 0.001)
sigma_beta4 <- 1/sqrt(inv_beta4)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.0001, 0.0001)
sigma     <- 1/sqrt(inv.var)


for(i in 1:np){
# process model
Yp[i]   ~ dnorm(gfuncp[i], inv.var) # where Yi is already log transformed

# function g()
gfuncp[i] <- beta1[cohort.p[i]] + beta2[cohort.p[i]]*DI.scaled.p[i] + beta3[cohort.p[i]]*DBH.scaled.p[i] + beta4[cohort.p[i]]*log_RWI_1.p[i]  # use Drought index as a scaled variable 
}

}"






cohort.model.re_lag <- jags.model(textConnection(cohort_model_site_re), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled, log_RWI_1 = log(train$RWI_1), cohort = as.numeric(train$ageclass), S = unique(train$ageclass),
                    plot = as.numeric(train$site), ind = unique(train$site), np = length(test$DBH.scaled), DI.scaled.p = test$DI.scaled, DBH.scaled.p = test$DBH.scaled, log_RWI_1.p = log(test$RWI_1),cohort.p = as.numeric(test$ageclass), SP = unique(test$ageclass),
                    plot.p = as.numeric(test$site), ind.p = unique(test$site)), n.chains = 3, n.adapt = 100)

update(cohort.model.re_lag, 2000); # Burnin for 1000 samples to start, then go higher later

samp <- coda.samples(cohort.model.re_lag, 
                     variable.names=c("beta1", "beta2","beta3","beta4","sigma", "sigma_beta1", "sigma_beta2", "sigma_beta3","sigma_beta4", "mu_beta1", "mu_beta2", "mu_beta3","mu_beta3", "Yp"), 
                    n.chains = 3, n.iter=20000, thin = 10)


dic.full <- dic.samples(cohort.model.re_lag, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/basic_reg_cohort_site_re_with_lag_DIC.rds")

#summary(samp)
#traceplot(samp)
#gelman.diag(samp)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp[[1]]
 saveRDS(samps, "outputs/growth_model/basic_reg_cohort_site_re/samps.rds")
samps <-  readRDS("outputs/growth_model/basic_reg_cohort_site_re/samps.rds")
 Yp.samps    <- samps[,1:length(test$RWI)] 
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 alpha.samps  <- samps[,((length(test$RWI)+1)):((length(test$RWI)+2))]
 beta2.samps <- samps[,((length(test$RWI)+3)):((length(test$RWI)+4))]
 beta3.samps <- samps[,((length(test$RWI)+5)):((length(test$RWI)+6))]
  beta4.samps <- samps[,((length(test$RWI)+7)):((length(test$RWI)+8))]
 mu_beta1.samps <- samps[,((length(test$RWI)+9)):((length(test$RWI)+24))]
 mu_beta2.samps <- samps[,((length(test$RWI)+25)):((length(test$RWI)+40))]
 mu_beta3.samps <- samps[,((length(test$RWI)+41)):((length(test$RWI)+56))]
 sigma.samps <- samps[,((length(test$RWI)+57))]
 sigma_betas <- samps[,((length(test$RWI)+58)):((length(test$RWI)+61))]

 
 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps))~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/basic_reg_cohort_site_re/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "basic_reg_cohort_site_re_with_lag", 
                            model.summary = "gfunc[i] <- beta1[cohort[i]] + beta2[cohort[i]]*DI.scaled[i] + beta3[cohort[i]]*DBH.scaled[i] + beta4[cohort[i]]*log_RWI_1[i]" ,
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "basic_reg_cohort_site_re_with_lag", 
                           train = "cohort.omit", 
                           DI.scaled = "JJApdsi")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)


 
png("outputs/growth_model/basic_reg_cohort_site_re/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past")
hist(alpha.samps[,2], main = "alpha Modern")
#hist(alpha.samps[,3],  main = "alpha Past-Forest")
#hist(alpha.samps[,4],  main = "alpha Modern-Forest")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/basic_reg_cohort_site_re/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Savanna")
hist(beta2.samps[,2], main = "beta2 Modern-Savanna")
#hist(beta2.samps[,3],  main = "beta2 Past-Forest")
#hist(beta2.samps[,4],  main = "beta2 Modern-Forest")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()





png("outputs/growth_model/basic_reg_cohort_site_re/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Savanna")
hist(beta3.samps[,2], main = "beta3 Modern-Savanna")
#hist(beta3.samps[,3],  main = "beta3 Past-Forest")
#hist(beta3.samps[,4],  main = "beta3 Modern-Forest")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


png(height = 10, width = 10, units = "in", res = 300,"outputs/growth_model/basic_reg_cohort_site_re/marginal_mu_beta2s.png")
par(mfrow=c(4,4))
for(i in 1:length(colnames(mu_beta3.samps))){
  hist(mu_beta2.samps[,i], main = paste(colnames(mu_beta2.samps)[i]))
}
dev.off()


png(height = 10, width = 10, units = "in", res = 300,"outputs/growth_model/basic_reg_cohort_site_re/marginal_mu_beta3s.png")
par(mfrow=c(4,4))
for(i in 1:length(colnames(mu_beta3.samps))){
  hist(mu_beta3.samps[,i], main = paste(colnames(mu_beta3.samps)[i]))
}
dev.off()

png(height = 10, width = 10, units = "in", res = 300,"outputs/growth_model/basic_reg_cohort_site_re/marginal_mu_beta1s.png")
par(mfrow=c(4,4))
for(i in 1:length(colnames(mu_beta1.samps))){
  hist(mu_beta1.samps[,i], main = paste(colnames(mu_beta1.samps)[i]))
}
dev.off()

# plot predicted vs. observed:
png("outputs/growth_model/basic_reg_cohort_site_re/pred_vs_obs.png")
plot(colMeans(exp(Yp.samps)), test$RWI) 
abline(a = 0, b = 1, col = "red")
dev.off()



# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0( c("Modern", "Past")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bw = 0.005)+theme_bw()+xlab("Random intercepts")+theme_black()

a.mean <- apply(as.matrix(a[,1:2]), 2, mean)
a.lower <- apply(as.matrix(a[,1:2]), 2, function(x) quantile(x, probs = c(0.025)))
a.upper <- apply(as.matrix(a[,1:2]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat <- data.frame(a.mean, a.lower, a.upper)
plot.dat$class <- row.names(plot.dat)

a.dots <- ggplot(plot.dat, aes(x = a.mean,y = class, color = class))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 1,height = 0)+geom_point()+xlim(-0.1, 0.05)+theme_black()+coord_flip()+theme(legend.position = "none")+xlab("Estimated Intercept")

plot_grid(a.dots, alpha.mplots+coord_flip()+ xlim(-0.1, 0.05)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()))



b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c("Modern", "Past")))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bw = 0.005)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black()

b2.mean <- apply(as.matrix(b2[,1:2]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:2]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:2]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 1,height = 0)+geom_point()+xlim(0, 0.15)+theme_black()+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

png("outputs/growth_model/basic_reg_cohort_site_re/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots, b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()))
dev.off()



b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0("beta3-",c("Modern", "Past")))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")+theme_black()

library(cowplot)
png(width = 5, height = 6, units = "in", res = 300, "outputs/growth_model/basic_reg_cohort_site_re/param_marginal_distn_bycohort.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots, ncol = 1)
dev.off()

# Compute the posterior mean for the plug-in predictions  

 beta1.mn  <- colMeans(beta1.samps)
 beta2.mn  <- colMeans(beta2.samps)
 beta3.mn  <- colMeans(beta3.samps)
 sigma.mn <- mean(sigma.samps)
 alpha1.mn <- colMeans(alpha.samps) 
 #mu_beta1.samps <- colMeans(mu_beta1.samps) 
 #mu_beta2.samps <- colMeans(mu_beta2.samps) 
 #mu_beta3.samps <- colMeans(mu_beta3.samps) 


# get posterior predictions:
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  cohort= 1:2, site = as.numeric(unique(full.ghcn$site)))
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:



 Xp <- full.probe
 np <- length(Xp$Var1)
 ypred <- list()
 
 
 for(j in 1:np){

   # PPD
   #plot(density(Yp.samps[,j]),xlab="Y",main="PPD")

        
        alpha1.mn <- rnorm(1000, mu_beta1.samps[Xp[j,4]], mean(sigma_betas[,1]) ) # check the sigma betas
        beta2.mn <- rnorm(1000, mu_beta2.samps[Xp[j,4]], mean(sigma_betas[,2]) ) # check the sigma betas
        beta3.mn <- rnorm(1000, mu_beta3.samps[Xp[j,3]], mean(sigma_betas[,3]) ) # check the sigma betas
       
   mu <- alpha1.mn + beta2.mn*Xp[j,1] + beta2.mn*Xp[j,2]   # use
   
   #mu <- alpha1.mn+sum(Xp[j,1]*beta1.mn, Xp[j,2]*beta2.mn)
   
   ypred[[j]]  <- mu
  # lines(density(y),col=2)
   
   #abline(v=Y[j],col=3,lwd=2)

   #legend("topright",c("PPD","Plug-in","Truth"),col=1:3,lty=1,inset=0.05)
}

ypred.df <- do.call(rbind, ypred)


Xp$MeanY <- exp(rowMeans(ypred.df))

Xp$cohort <- ifelse(Xp$cohort == 2, "Past",  
                       ifelse(Xp$cohort == 1, "Modern",NA))
#DBH + DI on predicted growth

# Todo: unscale Drought and DBH indices

png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/basic_reg_cohort_site_re/Ypred_by_drought_struct_x_cohort.png")
ggplot(Xp, aes(Var1, MeanY, color = as.factor(site), shape = as.factor(cohort)))+geom_point()+xlab("Drought Index")+ylab("predicted growth")
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_cohort_site_re/Ypred_by_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var2,MeanY,color = as.factor(cohort)))+geom_point()+xlab("DBH Index")+ylab("predicted growth")
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_cohort_site_re/Ypred_by_drought_DBH_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~ as.factor(cohort))
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_cohort_site_re/Ypred_by_drought_DBH_site.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~ as.factor(site))
dev.off()


png(height = 10, width = 10, units = "in", res = 200,"outputs/growth_model/basic_reg_cohort_site_re/Ypred_by_drought_DBH_site_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~ as.factor(site) + as.factor(cohort))
dev.off()

```

# this is the same as above, but we include both cohort and structure as RE
```{r}

site_model_structure_x_cohort_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i]   # use Drought index as a scaled variable 


}

# Prediction of test data
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] 
  }

# Prediction of probe data for plotting:
  for(i in 1:nprobe){
    Yprobe[i]  ~ dnorm(muprobe[i],inv.var)
    muprobe[i] <- beta1[struct.cohort.probe[i]] + beta2[struct.cohort.probe[i]]*DI.scaled.probe[i] + beta3[struct.cohort.probe[i]]*DBH.scaled.probe[i] 
  }


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(S)){
beta1[s] ~ dnorm(mu_beta1[plot[s]], inv_beta1)
beta2[s] ~ dnorm(mu_beta2[plot[s]], inv_beta2)
beta3[s] ~ dnorm(mu_beta3[plot[s]], inv_beta3)
}


for(j in 1:length(ind)){
# use normal hyperpriors for each hyperparamters 
mu_beta1[j] ~ dnorm(0, 0.5)
mu_beta2[j] ~ dnorm(0, 0.5)
mu_beta3[j] ~ dnorm(0, 0.5)

}

inv_beta1   ~ dgamma(0.001, 0.001)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.001, 0.001)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.001, 0.001)
sigma_beta3 <- 1/sqrt(inv_beta3)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.0001, 0.0001)
sigma     <- 1/sqrt(inv.var)





}"





# save these for use later:
saveRDS(train, "outputs/growth_model/site_reg_structure_cohort_re/train.rds")
saveRDS(test, "outputs/growth_model/site_reg_structure_cohort_re/test.rds")

# generate fake data to predict on:
# we want to plot growth relationship to PDSI for Mod/Past in Sav/Forest in small and large DBH:
library(DMwR)

unscale(vals = 2.9355, norm.data = DBH.scaled) # 80 cm
unscale(vals = 2.305, norm.data = DBH.scaled) # 70 cm
unscale(vals = 1.6745, norm.data = DBH.scaled) # 60 cm
unscale(vals = 1.0441, norm.data = DBH.scaled) # 50 cm
unscale(vals = 0.414, norm.data = DBH.scaled) # 40 cm
unscale(vals = -0.217, norm.data = DBH.scaled) # 30 cm
unscale(vals = -0.8469, norm.data = DBH.scaled) # 20 cm
unscale(vals = -1.4775, norm.data = DBH.scaled) # 10 cm


 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 DI.p <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBH.p <- c(2.9355,2.305,1.0441,0.414, -0.217, -0.8469, -1.4775 )# for 40 cm, 30 cm, 20cm, and 10 cm trees respectivly
 full.p <- expand.grid(DI.p, DBH.p,  struct.cohort= 1:4)
 
 

 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  struct.cohort= 1:4)
 
 Xp <- full.probe
 np <- length(Xp$Var1)


reg.model.site_structure_x_cohort <- jags.model(textConnection(site_model_structure_x_cohort_re ), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled, struct.cohort = as.numeric(train$struct.cohort.code), S = unique(train$struct.cohort.code), plot = as.numeric(train$site), ind = unique(train$site),np = length(test$DBH.scaled),
   struct.cohort.p = as.numeric(test$struct.cohort.code), DBH.scaled.p = test$DBH.scaled, DI.scaled.p = test$DI.scaled, 
   nprobe = length(full.p$Var1),
   struct.cohort.probe = as.numeric(full.p$struct.cohort), DBH.scaled.probe = full.p$Var2, DI.scaled.probe = full.p$Var1
   ), n.chains = 3, n.adapt = 100)

update(reg.model.site_structure_x_cohort, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.site.cohort.re <- coda.samples(reg.model.site_structure_x_cohort, 
                     variable.names=c("beta1", "beta2","beta3","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3", "Yp", "Yprobe"), 
                    n.chains = 3, n.iter=20000, thin = 15)


dic.full <- dic.samples(reg.model.site_structure_x_cohort, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/site_reg_structure_cohort_re_DIC.rds")

#summary(samp.structure.site.cohort.re)
#plot(samp.structure.site.cohort.re)

#gelman.diag(samp.structure.site.cohort.re)
#acfplot(samp.structure.site.cohort.re)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.site.cohort.re[[1]]
 saveRDS(samps, "outputs/growth_model/site_reg_structure_cohort_re/samps.rds")
 test  <- readRDS(test, "outputs/growth_model/site_reg_structure_cohort_re/test.rds")
 
 Yp.samps <- samps[,1:length(test$RWI)] 
 Yprobe.samps <-samps [,(length(test$RWI)+ 1):(length(test$RWI)+ length(full.p$Var1))]
 alpha.samps  <- samps[,(length(test$RWI)+length(full.p$Var1)+1):(length(test$RWI)+length(full.p$Var1)+4)]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,(length(test$RWI)+length(full.p$Var1)+5):(length(test$RWI)+length(full.p$Var1)+8)]
 beta3.samps <- samps[,(length(test$RWI)+length(full.p$Var1)+9):(length(test$RWI)+length(full.p$Var1)+12)]
 sigma.samps <- samps[,(length(test$RWI)+length(full.p$Var1)+13)]
 sigma_betas <- samps[,(length(test$RWI)+length(full.p$Var1)+14):(length(test$RWI)+length(full.p$Var1)+16)]

 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps))~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "site_reg_structure_cohort_re",
                            model.summary = "gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i]   # use Drought index as a scaled variable ",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)

# get difference between beta2.samps:
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]
# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/site_reg_structure_cohort_re/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/site_reg_structure_cohort_re/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/site_reg_structure_cohort_re/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <-ggplot(a.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), bandwidth = 0.005, alpha = 0.5)+theme_black()+ylab("frequency")+xlab(" random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), bandwidth = 0.005, alpha = 0.5)+theme_black()+ylab("frequency")+xlab("Drought random slopes")

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), bandwidth = 0.005, alpha = 0.5)+theme_black()+ylab("frequency")+xlab("DBH random slopes")


library(cowplot)
png(width = 5, height = 6, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re/param_marginal_distn_bycohort_struct.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots, ncol = 1)
dev.off()


# plot probed values of tree growth predictions:
Yprobe <- data.frame(Yprobe.samps)
colnames(Yprobe) <- 1:length(Yprobe)
probe.m <- melt(Yprobe)
probe.m$RWI <- exp(probe.m$value) 
colnames(probe.m) <- c("num", "Ypred", "RWI")

full.p$num <- 1:length(full.p[,1])
colnames(full.p) <- c("Drought", "DBH", "struct.cohort", "num")

# summarize by structure + cohort class only:
prob <- merge(probe.m, full.p, by = "num")
preds_ci <- prob %>% group_by(num, DBH,Drought, struct.cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

ggplot(preds_ci, aes(Drought, meanY, color = as.factor(struct.cohort)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()+facet_wrap(~as.factor(DBH))

ggplot(prob, aes(x = Ypred, y = as.factor(Drought))) + 
  geom_density_ridges()+facet_grid(~ DBH)+coord_flip()

# summarize by ageclass only:
prob$ageclass <- ifelse(prob$struct.cohort %in% c("1", "3"),"Past","Modern")
dbh.df <- data.frame(DBH = unique(prob$DBH)[order(unique(prob$DBH))], DBH.class = c("10cm", "20cm", "30cm", "40cm", "50cm", "60cm","70cm"))


prob <- merge(dbh.df, prob, by = "DBH")

preds_ci_mod_past <- prob %>% group_by( DBH.class,Drought, ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

preds_ci_mod_past$DBH.class <- factor(preds_ci_mod_past$DBH.class, levels = c("10cm", "20cm", "30cm", "40cm", "50cm", "60cm", "70cm"))
preds_ci_mod_past$PDSI <- unscale(preds_ci_mod_past$Drought, norm.data = DI.scaled)

preds.gg <- ggplot(preds_ci_mod_past, aes(PDSI, meanY, color = as.factor(ageclass)))+
  geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = as.factor(ageclass)), alpha = 0.1, linetype = "dashed")+scale_color_manual (values = c("Modern" = "red", "Past" = "blue"))+stat_smooth()+facet_wrap(~DBH.class)+theme(legend.title = element_blank())+ylab("Predicted Ring Width")
 


png(height = 8, width = 8, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re/predicted_growth_mod_past_CI.png")
preds.gg
dev.off()


preds_ci_mod_past$ageclass <- factor(preds_ci_mod_past$ageclass, levels = c("Past", "Modern"))
gg.tile.past.mod <- ggplot(preds_ci_mod_past, aes(PDSI, DBH.class, fill = meanY))+geom_raster()+facet_wrap(~ageclass, ncol = 1)+scale_fill_distiller(palette = "BrBG", direction = 1, name = "Tree \nGrowth")+ylab("Tree diameter")+xlab("Palmer Drought Severity Index")+theme_bw(base_size = 12)


png(height = 4, width = 3, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re/predicted_growth_mod_past_tile.png")
gg.tile.past.mod
dev.off()


# do the same thing, but just for age structure:
preds_ci_age_struct <- prob %>% group_by(Drought, struct.cohort, DBH.class) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

preds_ci_age_struct$PDSI <- unscale(preds_ci_age_struct$Drought, norm.data = DI.scaled)

ggplot(preds_ci_age_struct, aes(PDSI, meanY, color = as.factor(struct.cohort)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()

# rename cohort structure numbers to text
cohort.df <- data.frame(cohorts = unique(full.ghcn$struct.cohort)[order(unique(full.ghcn$struct.cohort.code))],
           struct.cohort = 1:4)

preds_ci_age_struct <- merge(cohort.df, preds_ci_age_struct, by = "struct.cohort")
preds_ci_age_struct$cohorts <- factor(preds_ci_age_struct$cohorts, levels =c("Past-Forest", 
                                                                             "Past-Savanna", 
                                                                             "Modern-Forest", 
                                                                             "Modern-Savanna") )

#create tile plots of growth responses over time:
gg.tile.past.mod.cohort <- ggplot(preds_ci_age_struct, aes(PDSI, DBH.class, fill = meanY))+geom_raster()+facet_wrap(~cohorts, ncol = 2)+scale_fill_distiller(palette = "BrBG", direction = 1, name = "Tree \nGrowth")+ylab("Tree diameter")+xlab("Palmer Drought Severity Index")+theme_bw(base_size = 12)

png(height = 4, width = 6, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re/predicted_growth_mod_past_forest_sav_tile.png")
gg.tile.past.mod.cohort
dev.off()



# or we can do the comparisons by hand:
Yp <- data.frame(Yp.samps)
colnames(Yp) <- c(paste0("YP-",test$site))
Yp$num <- rownames(Yp)
Yp.m <- melt(Yp, id.vars=c("num"))


ggplot(Yp.m, aes(value, color = as.factor(Yp.m$variable)))+geom_density(alpha = 0.5)+theme_bw()

library(ggridges)

ggplot(Yp.m, aes(x = value, y = as.factor(DI.index))) + 
  geom_density_ridges()

ggplot(full.ghcn, aes(x = log(RWI), y = as.factor(struct.cohort))) + 
  geom_density_ridges()

# Compute the posterior mean for the plug-in predictions  

 beta1.mn  <- colMeans(beta2.samps)
 beta2.mn  <- colMeans(beta3.samps)
 sigma.mn <- mean(sigma.samps)
 alpha1.mn <- colMeans(alpha.samps) 


# Plot the Posterior Predictive Density and plug-in
# want to plaot posteror predictive distributions:
 
# can probe either within the JAGS model or in R after the model runs:
 # specify "x probe" values for DBH + DI:
 #xprobe <- matrix(rep(-2.102618, 3.321394))
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  struct.cohort= 1:4)
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:





 Xp <- full.probe
 np <- length(Xp$Var1)
 ypred <- list()
 ypred.yp <- list()
 diff <- list()
 for(j in 1:np){

   # PPD
   #plot(density(Yp.samps[,j]),xlab="Y",main="PPD")

   
   mu <- alpha1.mn[Xp[j,3]] + beta1.mn[Xp[j,3]]*Xp[j,1] + beta2.mn[Xp[j,3]]*Xp[j,2]   # use
   #mu <- alpha1.mn+sum(Xp[j,1]*beta1.mn, Xp[j,2]*beta2.mn)
   ypred[[j]]  <- rnorm(np, mu, sigma.mn)
  # lines(density(y),col=2)
   #ypred.yp[[j]] <- Yp.samps[,j]
   #diff[[j]] <- ypred[[j]] - Yp.samps[[j]]
   # Truth
   #abline(v=Y[j],col=3,lwd=2)

   #legend("topright",c("PPD","Plug-in","Truth"),col=1:3,lty=1,inset=0.05)
}

ypred.df <- do.call(rbind, ypred)
#diff.df <- do.call(rbind, diff)
#ypred.yp.df <- do.call(rbind, ypred.yp)

Xp$MeanY <- exp(rowMeans(ypred.df))
#Xp$MeanYhat <- exp(rowMeans(ypred.yp.df))# get the means of the posterior to plot the overall effects of 
Xp$struct.cohort <- ifelse(Xp$struct.cohort == 1, "Past-Forest",  
                       ifelse(Xp$struct.cohort == 2, "Modern-Forest",
                               ifelse(Xp$struct.cohort == 3, "Past-Savanna", 
                                       ifelse(Xp$struct.cohort == 4, "Modern-Savanna", NA))))
#DBH + DI on predicted growth

# Todo: unscale Drought and DBH indices

png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/site_reg_structure_cohort_re/Ypred_by_drought_struct_x_cohort.png")
ggplot(Xp, aes(Var1,MeanY, color = as.factor(struct.cohort)))+xlab("Drought Index")+geom_point()+ylab("predicted growth")+stat_smooth()
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/site_reg_structure_cohort_re/Ypred_by_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var2,MeanY,color = as.factor(struct.cohort)))+geom_point()+xlab("DBH Index")+ylab("predicted growth")+stat_smooth()
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/site_reg_structure_cohort_re/Ypred_by_drought_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~as.factor(struct.cohort))
dev.off()

```




# this is the same as above, but we include both cohort and structure as RE, but no random intercept for structure/cohort:
```{r}

site_model_structure_x_cohort_re_slopes <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1 + beta2[struct.cohort[i]]*DI.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i]   # use Drought index as a scaled variable 


}

# Prediction
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1 + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] 
  }

# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(S)){
#beta1[s] ~ dnorm(mu_beta1[plot[s]], inv_beta1)
beta2[s] ~ dnorm(mu_beta2[plot[s]], inv_beta2)
beta3[s] ~ dnorm(mu_beta3[plot[s]], inv_beta3)
}


for(j in 1:length(ind)){
# use normal hyperpriors for each hyperparamters 
#mu_beta1[j] ~ dnorm(0, 0.5)
mu_beta2[j] ~ dnorm(0, 0.5)
mu_beta3[j] ~ dnorm(0, 0.5)

}

beta1 ~ dnorm(0, inv_beta1)
inv_beta1   ~ dgamma(0.001, 0.001)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.001, 0.001)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.001, 0.001)
sigma_beta3 <- 1/sqrt(inv_beta3)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.0001, 0.0001)
sigma     <- 1/sqrt(inv.var)





}"





reg.model.site_structure_x_cohort_slopes <- jags.model(textConnection(site_model_structure_x_cohort_re_slopes ), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled, struct.cohort = as.numeric(train$struct.cohort.code), S = unique(train$struct.cohort.code), plot = as.numeric(train$site), ind = unique(train$site),np = length(test$DBH.scaled),
   struct.cohort.p = as.numeric(test$struct.cohort.code), DBH.scaled.p = test$DBH.scaled, DI.scaled.p = test$DI.scaled), n.chains = 3, n.adapt = 100)

update(reg.model.site_structure_x_cohort_slopes, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.site.cohort.re.slopes <- coda.samples(reg.model.site_structure_x_cohort_slopes, 
                     variable.names=c("beta1", "beta2","beta3","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3", "Yp"), 
                    n.chains = 3, n.iter=20000, thin = 15)

#summary(samp.structure.site.cohort.re.slopes)
#plot(samp.structure.site.cohort.re.slopes)

#gelman.diag(samp.structure.site.cohort.re.slopes)
#acfplot(samp.structure.site.cohort.re.slopes)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.site.cohort.re.slopes[[1]]
 saveRDS(samps, "outputs/growth_model/site_reg_structure_cohort_re.slopes/samps.rds")
 #Yp.samps    <- samps[,1] 
 Yp.samps <- samps[,1:length(test$RWI)] 
 alpha.samps  <- samps[,(length(test$RWI)+1)]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,(length(test$RWI)+2):(length(test$RWI)+6)]
 beta3.samps <- samps[,(length(test$RWI)+7):(length(test$RWI)+10)]
 sigma.samps <- samps[,(length(test$RWI)+11)]
 sigma_betas <- samps[,(length(test$RWI)+12):(length(test$RWI)+13)]

 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps))~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re.slopes/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "site_reg_structure_cohort_re.slopes", 
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)

# get difference between beta2.samps:
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]
# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/site_reg_structure_cohort_re.slopes/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/site_reg_structure_cohort_re.slopes/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/site_reg_structure_cohort_re.slopes/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <-ggplot(a.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), bandwidth = 0.005, alpha = 0.5)+theme_black()+ylab("frequency")+xlab(" random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.003)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black()+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))

b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)

b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0, 0.15)+theme_black()+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

png("outputs/growth_model/site_reg_structure_cohort_re.slopes/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots, b2.mplots+coord_flip()+ xlim(0, 0.15)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()))
dev.off()


b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), bandwidth = 0.005, alpha = 0.5)+theme_black()+ylab("frequency")+xlab("DBH random slopes")

 ggplot(b3.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), bandwidth = 0.005, alpha = 0.5)+theme_black()+ylab("frequency")+xlab("DBH random slopes")

b3.boxplots <- ggplot(b3.m, aes(y = value, fill = variable))+geom_boxplot(alpha = 0.5)+theme_bw()+xlab("DBH slope")+theme_black()

library(cowplot)
png(width = 5, height = 6, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re.slopes/param_marginal_distn_bycohort_struct.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots, ncol = 1)
dev.off()


Yp <- data.frame(Yp.samps)
colnames(Yp) <- c(paste0("YP-",test$site))
Yp$num <- rownames(Yp)
Yp.m <- melt(Yp, id.vars=c("num"))
#Yp.m$DBHindex <- Xp$Var2
#Yp.m$DIindex <- Xp$Var1
#Yp.m$struct.cohort <- Xp$struct.cohort

ggplot(Yp.m, aes(value, color = as.factor(Yp.m$variable)))+geom_density(alpha = 0.5)+theme_bw()

library(ggridges)

ggplot(Yp.m, aes(x = value, y = as.factor(DIindex))) + 
  geom_density_ridges()

ggplot(full.ghcn, aes(x = log(RWI), y = as.factor(struct.cohort))) + 
  geom_density_ridges()

# Compute the posterior mean for the plug-in predictions  

 beta1.mn  <- colMeans(beta2.samps)
 beta2.mn  <- colMeans(beta3.samps)
 sigma.mn <- mean(sigma.samps)
 alpha1.mn <- colMeans(alpha.samps) 


# Plot the Posterior Predictive Density and plug-in
# want to plaot posteror predictive distributions:
 
# can probe either within the JAGS model or in R after the model runs:
 # specify "x probe" values for DBH + DI:
 #xprobe <- matrix(rep(-2.102618, 3.321394))
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  struct.cohort= 1:4)
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:





 Xp <- full.probe
 np <- length(Xp$Var1)
 ypred <- list()
 ypred.yp <- list()
 diff <- list()
 for(j in 1:np){

   # PPD
   #plot(density(Yp.samps[,j]),xlab="Y",main="PPD")

   
   mu <- alpha1.mn[Xp[j,3]] + beta1.mn[Xp[j,3]]*Xp[j,1] + beta2.mn[Xp[j,3]]*Xp[j,2]   # use
   #mu <- alpha1.mn+sum(Xp[j,1]*beta1.mn, Xp[j,2]*beta2.mn)
   ypred[[j]]  <- rnorm(np, mu, sigma.mn)
  # lines(density(y),col=2)
   #ypred.yp[[j]] <- Yp.samps[,j]
   #diff[[j]] <- ypred[[j]] - Yp.samps[[j]]
   # Truth
   #abline(v=Y[j],col=3,lwd=2)

   #legend("topright",c("PPD","Plug-in","Truth"),col=1:3,lty=1,inset=0.05)
}

ypred.df <- do.call(rbind, ypred)
#diff.df <- do.call(rbind, diff)
#ypred.yp.df <- do.call(rbind, ypred.yp)

Xp$MeanY <- exp(rowMeans(ypred.df))
#Xp$MeanYhat <- exp(rowMeans(ypred.yp.df))# get the means of the posterior to plot the overall effects of 
Xp$struct.cohort <- ifelse(Xp$struct.cohort == 1, "Past-Forest",  
                       ifelse(Xp$struct.cohort == 2, "Modern-Forest",
                               ifelse(Xp$struct.cohort == 3, "Past-Savanna", 
                                       ifelse(Xp$struct.cohort == 4, "Modern-Savanna", NA))))
#DBH + DI on predicted growth

# Todo: unscale Drought and DBH indices

png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/site_reg_structure_cohort_re/Ypred_by_drought_struct_x_cohort.png")
ggplot(Xp, aes(Var1,MeanY, color = as.factor(struct.cohort)))+xlab("Drought Index")+geom_point()+ylab("predicted growth")+stat_smooth()
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/site_reg_structure_cohort_re/Ypred_by_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var2,MeanY,color = as.factor(struct.cohort)))+geom_point()+xlab("DBH Index")+ylab("predicted growth")+stat_smooth()
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/site_reg_structure_cohort_re/Ypred_by_drought_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~as.factor(struct.cohort))
dev.off()


```

Model with cohort RE and SPEI-6 month July lags
```{r}

site_model_structure_x_cohort_re_SP6_06 <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i]+ beta4[struct.cohort[i]]*log_RWI_1[i]   # use Drought index as a scaled variable 


}

# Prediction of test data
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] + beta4[struct.cohort.p[i]]*log_RWI_1.p[i]
  }

# Prediction of probe data for plotting:
  for(i in 1:nprobe){
    Yprobe[i]  ~ dnorm(muprobe[i], inv.var)
    muprobe[i] <- beta1[struct.cohort.probe[i]] + beta2[struct.cohort.probe[i]]*DI.scaled.probe[i] + beta3[struct.cohort.probe[i]]*DBH.scaled.probe[i] + beta4[struct.cohort.probe[i]]*log_RWI_1.probe[i]
  }


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(S)){
beta1[s] ~ dnorm(mu_beta1[plot[s]], inv_beta1)
beta2[s] ~ dnorm(mu_beta2[plot[s]], inv_beta2)
beta3[s] ~ dnorm(mu_beta3[plot[s]], inv_beta3)
beta4[s] ~ dnorm(mu_beta4[plot[s]], inv_beta4)
}


for(j in 1:length(ind)){
# use normal hyperpriors for each hyperparamters 
mu_beta1[j] ~ dnorm(0, 0.5)
mu_beta2[j] ~ dnorm(0, 0.5)
mu_beta3[j] ~ dnorm(0, 0.5)
mu_beta4[j] ~ dnorm(0, 0.5)
}

inv_beta1   ~ dgamma(0.001, 0.001)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.001, 0.001)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.001, 0.001)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.001, 0.001)
sigma_beta4 <- 1/sqrt(inv_beta4)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.0001, 0.0001)
sigma     <- 1/sqrt(inv.var)


}"





# save these for use later:
saveRDS(train, "outputs/growth_model/site_reg_structure_cohort_re_sp6/train.rds")
saveRDS(test, "outputs/growth_model/site_reg_structure_cohort_re_sp6/test.rds")

# generate fake data to predict on:
# we want to plot growth relationship to PDSI for Mod/Past in Sav/Forest in small and large DBH:
library(DMwR)

unscale(vals = 2.9355, norm.data = DBH.scaled) # 80 cm
unscale(vals = 2.305, norm.data = DBH.scaled) # 70 cm
unscale(vals = 1.6745, norm.data = DBH.scaled) # 60 cm
unscale(vals = 1.0441, norm.data = DBH.scaled) # 50 cm
unscale(vals = 0.414, norm.data = DBH.scaled) # 40 cm
unscale(vals = -0.217, norm.data = DBH.scaled) # 30 cm
unscale(vals = -0.8469, norm.data = DBH.scaled) # 20 cm
unscale(vals = -1.4775, norm.data = DBH.scaled) # 10 cm


 SPprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 DI.p <- seq(range(full.ghcn$SP06_6)[1], range(full.ghcn$SP06_6)[2], by = 0.5)
 DBH.p <- c(2.9355, 2.305,1.0441,0.414, -0.217, -0.8469, -1.4775 )# for 40 cm, 30 cm, 20cm, and 10 
  log_RWI_1.probe <- seq(range(log(test$RWI_1))[1], range(log(test$RWI_1))[2], by = 0.25)
#cm trees respectivly
 full.probe <- expand.grid(DI.probe = DI.p, DBH.probe = DBH.p,  log_RWI_1.probe = log_RWI_1.probe,struct.cohort= 1:4)
 
 

 # something like:
#full.probe <- expand.grid( DI.p, DBH.p, log_RWI_1.probe,  struct.cohort= 1:4 )
 
 Xp <- full.probe
 np <- length(Xp$Var1)


reg.model.site_structure_x_cohort_sp6 <- jags.model(textConnection(site_model_structure_x_cohort_re_SP6_06 ), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$SP06_6, DBH.scaled = train$DBH.scaled, log_RWI_1 = log(train$RWI_1), struct.cohort = as.numeric(train$struct.cohort.code), S = unique(train$struct.cohort.code), plot = as.numeric(train$site), ind = unique(train$site),np = length(test$DBH.scaled),
   struct.cohort.p = as.numeric(test$struct.cohort.code), DBH.scaled.p = test$DBH.scaled, DI.scaled.p = test$SP06_6, log_RWI_1.p = log(test$RWI_1),
   nprobe = length(full.probe$DI.probe),
   struct.cohort.probe = as.numeric(full.probe$struct.cohort), DBH.scaled.probe = full.probe$DBH.probe, DI.scaled.probe = full.probe$DI.probe, log_RWI_1.probe = full.probe$log_RWI_1.probe
   ), n.chains = 3, n.adapt = 100)

update(reg.model.site_structure_x_cohort_sp6, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.site.cohort.re.sp6 <- coda.samples(reg.model.site_structure_x_cohort_sp6, 
                     variable.names=c("beta1", "beta2","beta3","beta4","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3","sigma_beta4", "Yp", "Yprobe"), 
                    n.chains = 3, n.iter=20000, thin = 15)


dic.full <- dic.samples(reg.model.site_structure_x_cohort_sp6, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/site_reg_structure_cohort_re_sp6_DIC.rds")

#summary(samp.structure.site.cohort.re.sp6)
#plot(samp.structure.site.cohort.re.sp6)

#gelman.diag(samp.structure.site.cohort.re.sp6)
#acfplot(samp.structure.site.cohort.re.sp6)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.site.cohort.re.sp6[[1]]
 saveRDS(samps, "outputs/growth_model/site_reg_structure_cohort_re_sp6/samps.rds")
 test  <- readRDS(test, "outputs/growth_model/site_reg_structure_cohort_re_sp6/test.rds")
 
 Yp.samps <- samps[,1:length(test$RWI)] 
 Yprobe.samps <-samps [,(length(test$RWI)+ 1):(length(test$RWI)+ length(full.probe$DI.probe))]
 alpha.samps  <- samps[,(length(test$RWI)+length(full.probe$DI.probe)+1):(length(test$RWI)+length(full.probe$DI.probe)+4)]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,(length(test$RWI)+length(full.probe$DI.probe)+5):(length(test$RWI)+length(full.probe$DI.probe)+8)]
 beta3.samps <- samps[,(length(test$RWI)+length(full.probe$DI.probe)+9):(length(test$RWI)+length(full.probe$DI.probe)+12)]
  beta4.samps <- samps[,(length(test$RWI)+length(full.probe$DI.probe)+13):(length(test$RWI)+length(full.probe$DI.probe)+16)]
 sigma.samps <- samps[,(length(test$RWI)+length(full.probe$DI.probe)+17)]
 sigma_betas <- samps[,(length(test$RWI)+length(full.probe$DI.probe)+18):(length(test$RWI)+length(full.probe$DI.probe)+21)]

 

# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps))~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re_sp6/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "site_reg_structure_cohort_re_sp6", 
                            model.structure = "gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*SP6_06.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i]+ beta4[struct.cohort[i]]*log_RWI_1[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "site_reg_structure_cohort_re_sp6", 
                           train = "cohort.omit", 
                           DI.scaled = "SP06-6")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)




# get difference between beta2.samps:
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]
# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/site_reg_structure_cohort_re_sp6/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/site_reg_structure_cohort_re_sp6/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/site_reg_structure_cohort_re_sp6/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <-ggplot(a.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), bandwidth = 0.005, alpha = 0.5)+theme_black()+ylab("frequency")+xlab(" random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), bandwidth = 0.05, alpha = 0.5)+theme_black()+ylab("frequency")+xlab("Drought random slopes")

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), bandwidth = 0.05, alpha = 0.5)+theme_black()+ylab("frequency")+xlab("DBH random slopes")


library(cowplot)
png(width = 5, height = 6, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re_sp6/param_marginal_distn_bycohort_struct.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots, ncol = 1)
dev.off()


# plot probed values of tree growth predictions:
Yprobe <- data.frame(Yprobe.samps)
colnames(Yprobe) <- 1:length(Yprobe)
probe.m <- melt(Yprobe)
probe.m$RWI <- exp(probe.m$value) 
colnames(probe.m) <- c("num", "Ypred", "RWI")

full.p$num <- 1:length(full.p[,1])
colnames(full.p) <- c("Drought", "DBH", "struct.cohort", "num")

# summarize by structure + cohort class only:
prob <- merge(probe.m, full.p, by = "num")
preds_ci <- prob %>% group_by(num, DBH,Drought, struct.cohort) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

ggplot(preds_ci, aes(Drought, meanY, color = as.factor(struct.cohort)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()+facet_wrap(~as.factor(DBH))

ggplot(prob, aes(x = Ypred, y = as.factor(Drought))) + 
  geom_density_ridges()+facet_grid(~ DBH)+coord_flip()

# summarize by ageclass only:
prob$ageclass <- ifelse(prob$struct.cohort %in% c("1", "3"),"Past","Modern")
dbh.df <- data.frame(DBH = unique(prob$DBH)[order(unique(prob$DBH))], DBH.class = c("10cm", "20cm", "30cm", "40cm", "50cm", "60cm","70cm"))


prob <- merge(dbh.df, prob, by = "DBH")

preds_ci_mod_past <- prob %>% group_by( DBH.class,Drought, ageclass) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

preds_ci_mod_past$DBH.class <- factor(preds_ci_mod_past$DBH.class, levels = c("10cm", "20cm", "30cm", "40cm", "50cm", "60cm", "70cm"))
preds_ci_mod_past$PDSI <- unscale(preds_ci_mod_past$Drought, norm.data = DI.scaled)

preds.gg <- ggplot(preds_ci_mod_past, aes(Drought, meanY, color = as.factor(ageclass)))+
  geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = as.factor(ageclass)), alpha = 0.1, linetype = "dashed")+scale_color_manual (values = c("Modern" = "red", "Past" = "blue"))+stat_smooth()+facet_wrap(~DBH.class)+theme(legend.title = element_blank())+ylab("Predicted Ring Width")
 


png(height = 8, width = 8, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re_sp6/predicted_growth_mod_past_CI.png")
preds.gg
dev.off()


preds_ci_mod_past$ageclass <- factor(preds_ci_mod_past$ageclass, levels = c("Past", "Modern"))
gg.tile.past.mod <- ggplot(preds_ci_mod_past, aes(Drought, DBH.class, fill = meanY))+geom_raster()+facet_wrap(~ageclass, ncol = 1)+scale_fill_distiller(palette = "BrBG", direction = 1, name = "Tree \nGrowth")+ylab("Tree diameter")+xlab("SPEI - 6 month")+theme_bw(base_size = 12)


png(height = 4, width = 3, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re_sp6/predicted_growth_mod_past_tile.png")
gg.tile.past.mod
dev.off()


# do the same thing, but just for age structure:
preds_ci_age_struct <- prob %>% group_by(Drought, struct.cohort, DBH.class) %>% summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

#preds_ci_age_struct$PDSI <- unscale(preds_ci_age_struct$Drought, norm.data = DI.scaled)

ggplot(preds_ci_age_struct, aes(Drought, meanY, color = as.factor(struct.cohort)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()

# rename cohort structure numbers to text
cohort.df <- data.frame(cohorts = unique(full.ghcn$struct.cohort)[order(unique(full.ghcn$struct.cohort.code))],
           struct.cohort = 1:4)

preds_ci_age_struct <- merge(cohort.df, preds_ci_age_struct, by = "struct.cohort")
preds_ci_age_struct$cohorts <- factor(preds_ci_age_struct$cohorts, levels =c("Past-Forest", 
                                                                             "Past-Savanna", 
                                                                             "Modern-Forest", 
                                                                             "Modern-Savanna") )

#create tile plots of growth responses over time:
gg.tile.past.mod.cohort <- ggplot(preds_ci_age_struct, aes(Drought, DBH.class, fill = meanY))+geom_raster()+facet_wrap(~cohorts, ncol = 2)+scale_fill_distiller(palette = "BrBG", direction = 1, name = "Tree \nGrowth")+ylab("Tree diameter")+xlab("Palmer Drought Severity Index")+theme_bw(base_size = 12)

png(height = 4, width = 6, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re_sp6/predicted_growth_mod_past_forest_sav_tile.png")
gg.tile.past.mod.cohort
dev.off()



# or we can do the comparisons by hand:
Yp <- data.frame(Yp.samps)
colnames(Yp) <- c(paste0("YP-",test$site))
Yp$num <- rownames(Yp)
Yp.m <- melt(Yp, id.vars=c("num"))


ggplot(Yp.m, aes(value, color = as.factor(Yp.m$variable)))+geom_density(alpha = 0.5)+theme_bw()

library(ggridges)

ggplot(Yp.m, aes(x = value, y = as.factor(DI.index))) + 
  geom_density_ridges()

ggplot(full.ghcn, aes(x = log(RWI), y = as.factor(struct.cohort))) + 
  geom_density_ridges()

# Compute the posterior mean for the plug-in predictions  

 beta1.mn  <- colMeans(beta2.samps)
 beta2.mn  <- colMeans(beta3.samps)
 sigma.mn <- mean(sigma.samps)
 alpha1.mn <- colMeans(alpha.samps) 


# Plot the Posterior Predictive Density and plug-in
# want to plaot posteror predictive distributions:
 
# can probe either within the JAGS model or in R after the model runs:
 # specify "x probe" values for DBH + DI:
 #xprobe <- matrix(rep(-2.102618, 3.321394))
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  struct.cohort= 1:4)
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:





 Xp <- full.probe
 np <- length(Xp$Var1)
 ypred <- list()
 ypred.yp <- list()
 diff <- list()
 for(j in 1:np){

   # PPD
   #plot(density(Yp.samps[,j]),xlab="Y",main="PPD")

   
   mu <- alpha1.mn[Xp[j,3]] + beta1.mn[Xp[j,3]]*Xp[j,1] + beta2.mn[Xp[j,3]]*Xp[j,2]   # use
   #mu <- alpha1.mn+sum(Xp[j,1]*beta1.mn, Xp[j,2]*beta2.mn)
   ypred[[j]]  <- rnorm(np, mu, sigma.mn)
  # lines(density(y),col=2)
   #ypred.yp[[j]] <- Yp.samps[,j]
   #diff[[j]] <- ypred[[j]] - Yp.samps[[j]]
   # Truth
   #abline(v=Y[j],col=3,lwd=2)

   #legend("topright",c("PPD","Plug-in","Truth"),col=1:3,lty=1,inset=0.05)
}

ypred.df <- do.call(rbind, ypred)
#diff.df <- do.call(rbind, diff)
#ypred.yp.df <- do.call(rbind, ypred.yp)

Xp$MeanY <- exp(rowMeans(ypred.df))
#Xp$MeanYhat <- exp(rowMeans(ypred.yp.df))# get the means of the posterior to plot the overall effects of 
Xp$struct.cohort <- ifelse(Xp$struct.cohort == 1, "Past-Forest",  
                       ifelse(Xp$struct.cohort == 2, "Modern-Forest",
                               ifelse(Xp$struct.cohort == 3, "Past-Savanna", 
                                       ifelse(Xp$struct.cohort == 4, "Modern-Savanna", NA))))
#DBH + DI on predicted growth

# Todo: unscale Drought and DBH indices

png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/site_reg_structure_cohort_re_sp6/Ypred_by_drought_struct_x_cohort.png")
ggplot(Xp, aes(Var1,MeanY, color = as.factor(struct.cohort)))+xlab("Drought Index")+geom_point()+ylab("predicted growth")+stat_smooth()
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/site_reg_structure_cohort_re_sp6/Ypred_by_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var2,MeanY,color = as.factor(struct.cohort)))+geom_point()+xlab("DBH Index")+ylab("predicted growth")+stat_smooth()
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/site_reg_structure_cohort_re_sp6/Ypred_by_drought_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~as.factor(struct.cohort))
dev.off()

```


Model with cohort RE, SPEI-1 month July and SPEI-6 month July lags
```{r}

site_model_structure_x_cohort_re_SP6_01_06 <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +  beta3[struct.cohort[i]]*DI.scaled2[i] + beta4[struct.cohort[i]]*DBH.scaled[i] +beta5[struct.cohort[i]]*log_RWI_1[i]  # use Drought index as a scaled variable 


}

# Prediction of test data
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DI.scaled2.p[i] + beta4[struct.cohort.p[i]]*DBH.scaled.p[i]+ beta5[struct.cohort.p[i]]*log_RWI_1.p[i]
  }

# Prediction of probe data for plotting:
  for(i in 1:nprobe){
    Yprobe[i]  ~ dnorm(muprobe[i],inv.var)
    muprobe[i] <- beta1[struct.cohort.probe[i]] + beta2[struct.cohort.probe[i]]*DI.scaled.probe[i] +
 beta3[struct.cohort.probe[i]]*DI.scaled2.probe[i]+beta4[struct.cohort.probe[i]]*DBH.scaled.probe[i]+beta5[struct.cohort.probe[i]]*log_RWI_1.probe[i] 
  }


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(S)){
beta1[s] ~ dnorm(mu_beta1[plot[s]], inv_beta1)
beta2[s] ~ dnorm(mu_beta2[plot[s]], inv_beta2)
beta3[s] ~ dnorm(mu_beta3[plot[s]], inv_beta3)
beta4[s] ~ dnorm(mu_beta4[plot[s]], inv_beta4)
beta5[s] ~ dnorm(mu_beta5[plot[s]], inv_beta5)
}



for(j in 1:length(ind)){
# use normal hyperpriors for each hyperparamters 
mu_beta1[j] ~ dnorm(0, 0.5)
mu_beta2[j] ~ dnorm(0, 0.5)
mu_beta3[j] ~ dnorm(0, 0.5)
mu_beta4[j] ~ dnorm(0, 0.5)
mu_beta5[j] ~ dnorm(0, 0.5)
}

inv_beta1   ~ dgamma(0.001, 0.001)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.001, 0.001)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.001, 0.001)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.001, 0.001)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.001, 0.001)
sigma_beta5 <- 1/sqrt(inv_beta5)

# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.0001, 0.0001)
sigma     <- 1/sqrt(inv.var)





}"




#save train and testing for later:
saveRDS(train, "outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/train.rds")
saveRDS(test, "outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/test.rds")

# generate fake data to predict on:
# we want to plot growth relationship to PDSI for Mod/Past in Sav/Forest in small and large DBH:
library(DMwR)

unscale(vals = 2.9355, norm.data = DBH.scaled) # 80 cm
unscale(vals = 2.305, norm.data = DBH.scaled) # 70 cm
unscale(vals = 1.6745, norm.data = DBH.scaled) # 60 cm
unscale(vals = 1.0441, norm.data = DBH.scaled) # 50 cm
unscale(vals = 0.414, norm.data = DBH.scaled) # 40 cm
unscale(vals = -0.217, norm.data = DBH.scaled) # 30 cm
unscale(vals = -0.8469, norm.data = DBH.scaled) # 20 cm
unscale(vals = -1.4775, norm.data = DBH.scaled) # 10 cm

unscale(vals = -5, norm.data = DI.scaled) # 10 cm


 SPprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 DI.p2 <- round(seq(range(full.ghcn$SP06_6)[1], range(full.ghcn$SP06_6)[2], by = 0.5),3)
 DI.p <- round(seq(range(full.ghcn$SP01_6)[1], range(full.ghcn$SP01_6)[2], by = 0.5),3)
 DBH.p <- c(2.9355, 2.305,1.0441,0.414, -0.217, -0.8469, -1.4775 )# for 40 cm, 30 cm, 20cm, and 10 cm trees respectivly
 log_RWI_1.p <-  round(seq(range(log(train$RWI_1))[1], range(log(train$RWI_1))[2], by = 0.25), 3)
 full.p <- expand.grid(DI.p,DI.p2, DBH.p, log_RWI1.probe = log_RWI_1.p, struct.cohort= 1:4)
 
 



reg.model.site_structure_x_cohort_sp1_sp6 <- jags.model(textConnection(site_model_structure_x_cohort_re_SP6_01_06 ), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$SP01_6, DI.scaled2 = train$SP06_6, DBH.scaled = train$DBH.scaled, struct.cohort = as.numeric(train$struct.cohort.code), log_RWI_1 = log(train$RWI_1), S = unique(train$struct.cohort.code), plot = as.numeric(train$site), ind = unique(train$site),np = length(test$DBH.scaled),
   struct.cohort.p = as.numeric(test$struct.cohort.code), DBH.scaled.p = test$DBH.scaled, DI.scaled.p = test$SP01_6, DI.scaled2.p = test$SP06_6, log_RWI_1.p = log(test$RWI_1),
   nprobe = length(full.p$Var1),
   struct.cohort.probe = as.numeric(full.p$struct.cohort), DBH.scaled.probe = full.p$Var3, DI.scaled.probe = full.p$Var1, DI.scaled2.probe = full.p$Var2,  log_RWI_1.probe = full.p$log_RWI1.probe), n.chains = 3, n.adapt = 100)

update(reg.model.site_structure_x_cohort_sp1_sp6, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.site.cohort.re.sp6.sp1 <- coda.samples(reg.model.site_structure_x_cohort_sp1_sp6, 
                     variable.names=c("beta1", "beta2","beta3","beta4","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3", "Yp", "Yprobe"), 
                    n.chains = 3, n.iter=20000, thin = 15)

dic.full <- dic.samples(reg.model.site_structure_x_cohort_sp1_sp6, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/site_reg_structure_cohort_re_sp1_sp6_DIC.rds")



#summary(samp.structure.site.cohort.re.sp6)
#plot(samp.structure.site.cohort.re.sp6)

#gelman.diag(samp.structure.site.cohort.re.sp6)
#acfplot(samp.structure.site.cohort.re.sp6)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.site.cohort.re.sp6.sp1 [[1]]
 saveRDS(samps, "outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/samps.rds")
 samps <- readRDS( "outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/samps.rds")
 test  <- readRDS("outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/test.rds")
 
 Yp.samps <- samps[,1:length(test$RWI)] 
 Yprobe.samps <-samps [,(length(test$RWI)+ 1):(length(test$RWI)+ length(full.p$Var1))]
 alpha.samps  <- samps[,(length(test$RWI)+length(full.p$Var1)+1):(length(test$RWI)+length(full.p$Var1)+4)]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,(length(test$RWI)+length(full.p$Var1)+5):(length(test$RWI)+length(full.p$Var1)+8)]
 beta3.samps <- samps[,(length(test$RWI)+length(full.p$Var1)+9):(length(test$RWI)+length(full.p$Var1)+12)]
 beta4.samps <- samps[,(length(test$RWI)+length(full.p$Var1)+13):(length(test$RWI)+length(full.p$Var1)+16)]
 beta5.samps <- samps[,(length(test$RWI)+length(full.p$Var1)+17):(length(test$RWI)+length(full.p$Var1)+20)]
 sigma.samps <- samps[,(length(test$RWI)+length(full.p$Var1)+21)]
 sigma_betas <- samps[,(length(test$RWI)+length(full.p$Var1)+22):(length(test$RWI)+length(full.p$Var1)+26)]

 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps))~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "site_reg_structure_cohort_re_sp1_sp6", 
                            model.summary = "gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*SP01.scaled[i] +  beta3[struct.cohort[i]]*SP06_scaled2[i] + beta4[struct.cohort[i]]*DBH.scaled[i] +beta5[struct.cohort[i]]*log_RWI_1[i]"   , 
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)

# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "site_reg_structure_cohort_re_sp1_sp6", 
                           train = "cohort.omit", 
                           DI.scaled = "SP_06-6 & SP01-06")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)




# get difference between beta2.samps:
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]
# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()

png("outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta4.samps[,1], main = "beta4 Past-Forest")
hist(beta4.samps[,2], main = "beta4 Modern-Forest")
hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
#hist(sigma_betas[,3], main = "sigma beta3")
dev.off()

library(ggridges)
# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
a$num <- as.numeric(rownames(a))
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <-ggplot(a.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), bandwidth = 0.005, alpha = 0.5)+theme_black()+ylab("frequency")+xlab(" random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
b2$num <- as.numeric(rownames(b2))
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95),  alpha = 0.5)+theme_black()+ylab("frequency")+xlab("SP01-1 random slopes")

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
b3$num <- as.numeric(rownames(b3))
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), alpha = 0.5)+theme_black()+ylab("frequency")+xlab("SP06-6 random slopes")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
b4$num <- as.numeric(rownames(b4))
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), alpha = 0.5)+theme_black()+ylab("frequency")+xlab("DBH random slopes")

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
b5$num <- as.numeric(rownames(b5))
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), alpha = 0.5)+theme_black()+ylab("frequency")+xlab("Lag-1 random slopes")

library(cowplot)
png(width = 5, height = 8, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/param_marginal_distn_bycohort_struct.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots, b5.mplots,ncol = 1)
dev.off()


# plot probed values of tree growth predictions:
Yprobe <- data.frame(Yprobe.samps)
colnames(Yprobe) <- 1:length(Yprobe)
probe.m <- melt(Yprobe)
probe.m$RWI <- exp(probe.m$value) 
colnames(probe.m) <- c("num", "Ypred", "RWI")

full.p$num <- 1:length(full.p[,1])
colnames(full.p) <- c("SP01","SP06", "DBH","Log_lag_RWI_1", "struct.cohort", "num")

# summarize by structure + cohort class only:
full.p$num <- as.factor(as.character(full.p$num))
probtest <- dplyr::inner_join(probe.m, full.p, by=c("num"))

prob <- probtest

preds_ci <- prob %>% group_by(num, DBH,SP01, SP06,Log_lag_RWI_1, struct.cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

ggplot(preds_ci, aes(SP01, meanY, color = as.factor(struct.cohort)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()+facet_wrap(~as.factor(DBH))

ggplot(prob, aes(x = Ypred, y = as.factor(SP01))) + 
  geom_density_ridges()+facet_grid(~ DBH)+coord_flip()

ggplot(prob, aes(x = Ypred, y = as.factor(SP06))) + 
  geom_density_ridges()+facet_grid(~ DBH)+coord_flip()

saveRDS(prob, "outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/full_yprobe_preds.rds")
prob <- readRDS("outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/full_yprobe_preds.rds")

# plot response to sp01-drought for small and large DBH trees in savanna + forest for modern + past
# with sp06 = very droughty, an average prev years growth:

prob_10_60cm_avg <- prob %>% filter(DBH == -0.8469 | DBH ==  2.3050, Log_lag_RWI_1 == 0.284, SP06 == -3.09 | SP06 == -1.09 | SP06 == 2.91 ) 

preds_ci_10 <- prob_10_60cm_avg %>% group_by(DBH, SP01,SP06, struct.cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.05), Ci.high = quantile(RWI, 0.95))
#prob_40cm_avg <- filter(prob, DBH == -0.8469 | DBH == -0.8469, SP06 == 0.41, Log_lag_RWI_1 == 0.03388714)

ggplot(preds_ci_10, aes(SP01, meanY, color = as.factor(struct.cohort)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()+facet_grid(~DBH + SP06)

ggplot(preds_ci_10, aes(SP01, meanY, color = as.factor(DBH)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()+facet_grid(~struct.cohort+SP06)


# same plots 
prob_10_60cm_avg <- dplyr::filter(prob, DBH == -0.8469) 

preds_ci_10 <- prob_10_60cm_avg %>% group_by( SP01, struct.cohort) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))
#prob_40cm_avg <- filter(prob, DBH == -0.8469 | DBH == -0.8469, SP06 == 0.41, Log_lag_RWI_1 == 0.03388714)


ggplot(preds_ci_10, aes(SP01, meanY, color = as.factor(struct.cohort)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()





# -----------------------------summarize by ageclass only:---------------------------------
prob$ageclass <- ifelse(prob$struct.cohort %in% c("1", "3"),"Past","Modern")
dbh.df <- data.frame(DBH = unique(prob$DBH)[order(unique(prob$DBH))], DBH.class = c("10cm", "20cm", "30cm", "40cm", "50cm", "60cm","70cm"))


prob <- merge(dbh.df, prob, by = "DBH")

preds_ci_mod_past <- prob %>% group_by( DBH.class,SP01,SP06, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

preds_ci_mod_past$DBH.class <- factor(preds_ci_mod_past$DBH.class, levels = c("10cm", "20cm", "30cm", "40cm", "50cm", "60cm", "70cm"))
preds_ci_mod_past$SP06.class <- factor(preds_ci_mod_past$SP06, levels = c("-3.09", "-2.59", "-2.09", "-1.59", "-1.09", "-0.59", "-0.09",  "0.41",  "0.91",  "1.41",  "1.91",  "2.41",  "2.91"))

#preds_ci_mod_past$PDSI <- unscale(preds_ci_mod_past$SP01, norm.data = SP1.scaled)

preds.gg1 <- ggplot(preds_ci_mod_past, aes(SP01, meanY, color = as.factor(ageclass)))+
  geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = as.factor(ageclass)), alpha = 0.1, linetype = "dashed")+scale_color_manual (values = c("Modern" = "red", "Past" = "blue"))+stat_smooth()+facet_grid(rows = vars(SP06.class), cols = vars(DBH.class))+theme(legend.title = element_blank())+ylab("Predicted Ring Width")
 

preds.gg <- ggplot(preds_ci_mod_past, aes(SP06, meanY, color = as.factor(ageclass)))+
  geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = as.factor(ageclass)), alpha = 0.1, linetype = "dashed")+scale_color_manual (values = c("Modern" = "red", "Past" = "blue"))+stat_smooth()+facet_grid(rows = vars(SP01), cols = vars(DBH.class))+theme(legend.title = element_blank())+ylab("Predicted Ring Width")
 

png(height = 10, width = 10, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/predicted_growth_mod_past_SP01_CI.png")
preds.gg
dev.off()


preds_ci_mod_past$ageclass <- factor(preds_ci_mod_past$ageclass, levels = c("Past", "Modern"))
gg.tile.past.mod2 <- ggplot(preds_ci_mod_past, aes(SP06, DBH.class, fill = meanY))+geom_raster()+facet_wrap(~ageclass, ncol = 1)+scale_fill_distiller(palette = "BrBG", direction = 1, name = "Tree \nGrowth")+ylab("Tree diameter")+xlab("SPEI - 6 month")+theme_bw(base_size = 12)

gg.tile.past.mod2 <- ggplot(preds_ci_mod_past, aes(SP06, DBH.class, fill = meanY))+geom_raster()+facet_grid(rows = vars(SP01),cols = vars(ageclass))+scale_fill_distiller(palette = "BrBG", direction = 1, name = "Tree \nGrowth")+ylab("Tree diameter")+xlab("SPEI - 6 month")+theme_bw(base_size = 12)


png(height = 4, width = 3, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/predicted_growth_mod_past_tile.png")
gg.tile.past.mod
dev.off()


# do the same thing, but just for age structure:
preds_ci_age_struct <- prob %>% group_by(SP01,SP06, struct.cohort, DBH.class) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

#preds_ci_age_struct$PDSI <- unscale(preds_ci_age_struct$Drought, norm.data = DI.scaled)

ggplot(preds_ci_age_struct, aes(SP01, meanY, color = as.factor(struct.cohort)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()+facet_wrap(~SP06)

# rename cohort structure numbers to text
cohort.df <- data.frame(cohorts = unique(full.ghcn$struct.cohort)[order(unique(full.ghcn$struct.cohort.code))],
           struct.cohort = 1:4)

preds_ci_age_struct <- merge(cohort.df, preds_ci_age_struct, by = "struct.cohort")
preds_ci_age_struct$cohorts <- factor(preds_ci_age_struct$cohorts, levels =c("Past-Forest", 
                                                                             "Past-Savanna", 
                                                                             "Modern-Forest", 
                                                                             "Modern-Savanna") )

#create tile plots of growth responses over time:
gg.tile.past.mod.cohort <- ggplot(preds_ci_age_struct, aes(SP06, DBH.class, fill = meanY))+geom_raster()+facet_wrap(~cohorts, ncol = 2)+scale_fill_distiller(palette = "BrBG", direction = 1, name = "Tree \nGrowth")+ylab("Tree diameter")+xlab("SP06")+theme_bw(base_size = 12)

gg.tile.past.mod.cohort <- ggplot(preds_ci_age_struct, aes(SP01, DBH.class, fill = meanY))+geom_raster()+facet_grid(cols = vars(cohorts), rows = vars(SP06))+scale_fill_distiller(palette = "BrBG", direction = 1, name = "Tree \nGrowth")+ylab("Tree diameter")+xlab("SP01")+theme_bw(base_size = 12)

png(height = 8, width = 10, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/predicted_growth_mod_past_forest_sav_tile_sp6.png")
gg.tile.past.mod.cohort
dev.off()

```

Model with cohort RE, SPEI-6 month july, june, aug droughts and June, july aug temperature + previous year RWI:
```{r}

site_model_structure_x_cohort_re_SP6_06_prevRWI <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] +  beta3[struct.cohort[i]]*DI.scaled2[i] + beta4[struct.cohort[i]]*DBH.scaled[i]+ beta5[struct.cohort[i]]*log_RWI_1[i]   # use Drought index as a scaled variable 


}

# Prediction of test data
  for(i in 1:np){
    Yp[i]  ~ dnorm(mup[i],inv.var)
    mup[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DI.scaled2.p[i] + beta4[struct.cohort.p[i]]*DBH.scaled.p[i]+ beta5[struct.cohort.p[i]]*log_RWI_1.p[i]
  }

# Prediction of probe data for plotting:
  for(i in 1:nprobe){
    Yprobe[i]  ~ dnorm(muprobe[i],inv.var)
    muprobe[i] <- beta1[struct.cohort.probe[i]] + beta2[struct.cohort.probe[i]]*DI.scaled.probe[i] +
 beta3[struct.cohort.probe[i]]*DI.scaled2.probe[i]+beta4[struct.cohort.probe[i]]*DBH.scaled.probe[i]+beta5[struct.cohort.probe[i]]*log_RWI_1.probe[i] 
  }


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(S)){
beta1[s] ~ dnorm(mu_beta1[plot[s]], inv_beta1)
beta2[s] ~ dnorm(mu_beta2[plot[s]], inv_beta2)
beta3[s] ~ dnorm(mu_beta3[plot[s]], inv_beta3)
beta4[s] ~ dnorm(mu_beta4[plot[s]], inv_beta4)
beta5[s] ~ dnorm(mu_beta5[plot[s]], inv_beta5)
}


for(j in 1:length(ind)){
# use normal hyperpriors for each hyperparamters 
mu_beta1[j] ~ dnorm(0, 0.5)
mu_beta2[j] ~ dnorm(0, 0.5)
mu_beta3[j] ~ dnorm(0, 0.5)
mu_beta4[j] ~ dnorm(0, 0.5)
mu_beta5[j] ~ dnorm(0, 0.5)
}

inv_beta1   ~ dgamma(0.001, 0.001)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.001, 0.001)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.001, 0.001)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.001, 0.001)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.001, 0.001)
sigma_beta5 <- 1/sqrt(inv_beta5)

# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.0001, 0.0001)
sigma     <- 1/sqrt(inv.var)


}"





# save these for use later:
saveRDS(train, "outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/train.rds")
saveRDS(test, "outputs/growth_model/site_reg_structure_cohort_re_sp1_sp6/test.rds")

# generate fake data to predict on:
# we want to plot growth relationship to PDSI for Mod/Past in Sav/Forest in small and large DBH:
library(DMwR)

unscale(vals = 2.9355, norm.data = DBH.scaled) # 80 cm
unscale(vals = 2.305, norm.data = DBH.scaled) # 70 cm
unscale(vals = 1.6745, norm.data = DBH.scaled) # 60 cm
unscale(vals = 1.0441, norm.data = DBH.scaled) # 50 cm
unscale(vals = 0.414, norm.data = DBH.scaled) # 40 cm
unscale(vals = -0.217, norm.data = DBH.scaled) # 30 cm
unscale(vals = -0.8469, norm.data = DBH.scaled) # 20 cm
unscale(vals = -1.4775, norm.data = DBH.scaled) # 10 cm


 SPprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 DI.p2 <- seq(range(full.ghcn$SP06_6)[1], range(full.ghcn$SP06_6)[2], by = 0.5)
 DI.p <- seq(range(full.ghcn$SP01_6)[1], range(full.ghcn$SP01_6)[2], by = 0.5)
 DBH.p <- c(2.9355, 2.305,1.0441,0.414, -0.217, -0.8469, -1.4775 )# for 40 cm, 30 cm, 20cm, and 10 cm trees respectivly
 log_RWI_1.p <-  seq(range(log(train$RWI_1))[1], range(log(train$RWI_1))[2], by = 0.25)
 full.p <- expand.grid(DI.p,DI.p2, DBH.p, log_RWI1.probe = log_RWI_1.p, struct.cohort= 1:4)
 
 



reg.model.site_structure_x_cohort_sp1_sp6 <- jags.model(textConnection(site_model_structure_x_cohort_re_SP6_06_prevRWI ), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), DI.scaled = train$SP01_6, DI.scaled2 = train$SP06_6, DBH.scaled = train$DBH.scaled, log_RWI_1 = log(train$RWI_1), struct.cohort = as.numeric(train$struct.cohort.code), S = unique(train$struct.cohort.code), plot = as.numeric(train$site), ind = unique(train$site),np = length(test$DBH.scaled),
   struct.cohort.p = as.numeric(test$struct.cohort.code), log_RWI_1.p = log(test$RWI_1),DBH.scaled.p = test$DBH.scaled, DI.scaled.p = test$SP01_6, DI.scaled2.p = test$SP06_6,
   nprobe = length(full.p$Var1),
   struct.cohort.probe = as.numeric(full.p$struct.cohort), DBH.scaled.probe = full.p$Var3, DI.scaled.probe = full.p$Var1, DI.scaled2.probe = full.p$Var2, log_RWI_1.probe = full.p$log_RWI1.probe
   ), n.chains = 3, n.adapt = 100)

update(reg.model.site_structure_x_cohort_sp1_sp6, 1000); # Burnin for 1000 samples to start, then go higher later


samp.structure.site.cohort.re.sp6.sp1 <- coda.samples(reg.model.site_structure_x_cohort_sp1_sp6, 
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","sigma", "sigma_beta1", "sigma_beta2","sigma_beta3","sigma_beta4", "sigma_beta5","Yp", "Yprobe"), 
                    n.chains = 3, n.iter=20000, thin = 15)

#summary(samp.structure.site.cohort.re.sp6)
#plot(samp.structure.site.cohort.re.sp6)

#gelman.diag(samp.structure.site.cohort.re.sp6)
#acfplot(samp.structure.site.cohort.re.sp6)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp.structure.site.cohort.re.sp6.sp1 [[1]]
 saveRDS(samps, "outputs/growth_model/site_reg_structure_cohort_re_sp06_sp01_lag/samps.rds")
samps  <- readRDS("outputs/growth_model/site_reg_structure_cohort_re_sp06_sp01_lag/sampsrds")
 
 Yp.samps <- samps[,1:length(test$RWI)] 
 Yprobe.samps <-samps [,(length(test$RWI)+ 1):(length(test$RWI)+ length(full.p$Var1))]
 alpha.samps  <- samps[,(length(test$RWI)+length(full.p$Var1)+1):(length(test$RWI)+length(full.p$Var1)+4)]# one alpha for each of 4 cohort-strcuture groups
 beta2.samps <- samps[,(length(test$RWI)+length(full.p$Var1)+5):(length(test$RWI)+length(full.p$Var1)+8)]
 beta3.samps <- samps[,(length(test$RWI)+length(full.p$Var1)+9):(length(test$RWI)+length(full.p$Var1)+12)]
 beta4.samps <- samps[,(length(test$RWI)+length(full.p$Var1)+13):(length(test$RWI)+length(full.p$Var1)+16)]
  beta4.samps <- samps[,(length(test$RWI)+length(full.p$Var1)+17):(length(test$RWI)+length(full.p$Var1)+20)]
 sigma.samps <- samps[,(length(test$RWI)+length(full.p$Var1)+21)]
 sigma_betas <- samps[,(length(test$RWI)+length(full.p$Var1)+22):(length(test$RWI)+length(full.p$Var1)+26)]

 
# plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps))~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re_sp06_sp01_lag/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "site_reg_structure_cohort_re_sp06_sp01_lag", 
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


# get difference between beta2.samps:
oneminustwo <- beta2.samps[,1] - beta2.samps[,2]
oneminusthree <- beta2.samps[,1] - beta2.samps[,3]
oneminusfour <- beta2.samps[,1] - beta2.samps[,4]
twominusthree <- beta2.samps[,2] - beta2.samps[,3]
twominusfour <- beta2.samps[,2] - beta2.samps[,4]
threeminusfour <- beta2.samps[,3] - beta2.samps[,4]
# calculate MSPE
# get posterior predictive density

# plot marginal distributions of each parameter:
png("outputs/growth_model/site_reg_structure_cohort_re_sp06_sp01_lag/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Forest")
hist(alpha.samps[,2], main = "alpha Modern-Forest")
hist(alpha.samps[,3],  main = "alpha Past-Savanna ")
hist(alpha.samps[,4],  main = "alpha Modern-Savanna")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/site_reg_structure_cohort_re_sp06_sp01_lag/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Forest")
hist(beta2.samps[,2], main = "beta2 Modern-Forest")
hist(beta2.samps[,3],  main = "beta2 Past-Savanna")
hist(beta2.samps[,4],  main = "beta2 Modern-Savanna")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/site_reg_structure_cohort_re_sp06_sp01_lag/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Forest")
hist(beta3.samps[,2], main = "beta3 Modern-Forest")
hist(beta3.samps[,3],  main = "beta3 Past-Savanna")
hist(beta3.samps[,4],  main = "beta3 Modern-Savanna")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()

png("outputs/growth_model/site_reg_structure_cohort_re_sp06_sp01_lag/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta4.samps[,1], main = "beta4 Past-Forest")
hist(beta4.samps[,2], main = "beta4 Modern-Forest")
hist(beta4.samps[,3],  main = "beta4 Past-Savanna")
hist(beta4.samps[,4],  main = "beta4 Modern-Savanna")
#hist(sigma_betas[,3], main = "sigma beta3")
dev.off()

library(ggridges)
# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
a$num <- as.numeric(rownames(a))
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <-ggplot(a.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), bandwidth = 0.005, alpha = 0.5)+theme_black()+ylab("frequency")+xlab(" random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
b2$num <- as.numeric(rownames(b2))
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95),  alpha = 0.5)+theme_black()+ylab("frequency")+xlab("SP01-1 random slopes")

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
b3$num <- as.numeric(rownames(b3))
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), alpha = 0.5)+theme_black()+ylab("frequency")+xlab("SP06-6 random slopes")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))
b4$num <- as.numeric(rownames(b4))
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value,1, fill = variable))+stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.05, 0.95), alpha = 0.5)+theme_black()+ylab("frequency")+xlab("DBH random slopes")


library(cowplot)
png(width = 5, height = 8, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re_sp06_sp01_lag/param_marginal_distn_bycohort_struct.png")
cowplot::plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots,ncol = 1)
dev.off()


# plot probed values of tree growth predictions:
Yprobe <- data.frame(Yprobe.samps)
colnames(Yprobe) <- 1:length(Yprobe)
probe.m <- melt(Yprobe)
probe.m$RWI <- exp(probe.m$value) 
colnames(probe.m) <- c("num", "Ypred", "RWI")

full.p$num <- 1:length(full.p[,1])
colnames(full.p) <- c("SP01","SP06", "DBH","log_RWI.probe", "struct.cohort", "num")

# summarize by structure + cohort class only:
prob <- merge(probe.m, full.p, by = "num")
preds_ci <- prob %>% group_by(num, DBH,SP01, SP06, struct.cohort) %>% dplyr::summarise(meanY = mean(exp(RWI)),
                                                                            Ci.low = quantile(exp(RWI), 0.025), Ci.high = quantile(RWI, 0.975))

ggplot(preds_ci, aes(SP01, meanY, color = as.factor(struct.cohort)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()+facet_wrap(~as.factor(DBH))

ggplot(prob, aes(x = Ypred, y = as.factor(SP01))) + 
  geom_density_ridges()+facet_grid(~ DBH)+coord_flip()

ggplot(prob, aes(x = Ypred, y = as.factor(SP06))) + 
  geom_density_ridges()+facet_grid(~ DBH)+coord_flip()

# summarize by ageclass only:
prob$ageclass <- ifelse(prob$struct.cohort %in% c("1", "3"),"Past","Modern")
dbh.df <- data.frame(DBH = unique(prob$DBH)[order(unique(prob$DBH))], DBH.class = c("10cm", "20cm", "30cm", "40cm", "50cm", "60cm","70cm"))


prob <- merge(dbh.df, prob, by = "DBH")

preds_ci_mod_past <- prob %>% group_by( DBH.class,SP01,SP06, ageclass) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

preds_ci_mod_past$DBH.class <- factor(preds_ci_mod_past$DBH.class, levels = c("10cm", "20cm", "30cm", "40cm", "50cm", "60cm", "70cm"))
preds_ci_mod_past$SP06.class <- factor(preds_ci_mod_past$SP06, levels = c("-3.09", "-2.59", "-2.09", "-1.59", "-1.09", "-0.59", "-0.09",  "0.41",  "0.91",  "1.41",  "1.91",  "2.41",  "2.91"))

#preds_ci_mod_past$PDSI <- unscale(preds_ci_mod_past$SP01, norm.data = SP1.scaled)

preds.gg1 <- ggplot(preds_ci_mod_past, aes(SP01, meanY, color = as.factor(ageclass)))+
  geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = as.factor(ageclass)), alpha = 0.1, linetype = "dashed")+scale_color_manual (values = c("Modern" = "red", "Past" = "blue"))+stat_smooth()+facet_grid(rows = vars(SP06.class), cols = vars(DBH.class))+theme(legend.title = element_blank())+ylab("Predicted Ring Width")
 

preds.gg <- ggplot(preds_ci_mod_past, aes(SP06, meanY, color = as.factor(ageclass)))+
  geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = as.factor(ageclass)), alpha = 0.1, linetype = "dashed")+scale_color_manual (values = c("Modern" = "red", "Past" = "blue"))+stat_smooth()+facet_grid(rows = vars(SP01), cols = vars(DBH.class))+theme(legend.title = element_blank())+ylab("Predicted Ring Width")
 

png(height = 10, width = 10, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re_sp06_sp01_lag/predicted_growth_mod_past_SP01_CI.png")
preds.gg
dev.off()


preds_ci_mod_past$ageclass <- factor(preds_ci_mod_past$ageclass, levels = c("Past", "Modern"))
gg.tile.past.mod2 <- ggplot(preds_ci_mod_past, aes(SP06, DBH.class, fill = meanY))+geom_raster()+facet_wrap(~ageclass, ncol = 1)+scale_fill_distiller(palette = "BrBG", direction = 1, name = "Tree \nGrowth")+ylab("Tree diameter")+xlab("SPEI - 6 month")+theme_bw(base_size = 12)

gg.tile.past.mod2 <- ggplot(preds_ci_mod_past, aes(SP06, DBH.class, fill = meanY))+geom_raster()+facet_grid(rows = vars(SP01),cols = vars(ageclass))+scale_fill_distiller(palette = "BrBG", direction = 1, name = "Tree \nGrowth")+ylab("Tree diameter")+xlab("SPEI - 6 month")+theme_bw(base_size = 12)


png(height = 4, width = 3, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re_sp06_sp01_lag/predicted_growth_mod_past_tile.png")
gg.tile.past.mod
dev.off()


# do the same thing, but just for age structure:
preds_ci_age_struct <- prob %>% group_by(SP01,SP06, struct.cohort, DBH.class) %>% dplyr::summarise(meanY = mean(RWI),
                                                                            Ci.low = quantile(RWI, 0.025), Ci.high = quantile(RWI, 0.975))

#preds_ci_age_struct$PDSI <- unscale(preds_ci_age_struct$Drought, norm.data = DI.scaled)

ggplot(preds_ci_age_struct, aes(SP01, meanY, color = as.factor(struct.cohort)))+geom_point()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high), alpha = 0.1, fill = "grey60", linetype = "dashed")+stat_smooth()+facet_wrap(~SP06)

# rename cohort structure numbers to text
cohort.df <- data.frame(cohorts = unique(full.ghcn$struct.cohort)[order(unique(full.ghcn$struct.cohort.code))],
           struct.cohort = 1:4)

preds_ci_age_struct <- merge(cohort.df, preds_ci_age_struct, by = "struct.cohort")
preds_ci_age_struct$cohorts <- factor(preds_ci_age_struct$cohorts, levels =c("Past-Forest", 
                                                                             "Past-Savanna", 
                                                                             "Modern-Forest", 
                                                                             "Modern-Savanna") )

#create tile plots of growth responses over time:
gg.tile.past.mod.cohort <- ggplot(preds_ci_age_struct, aes(SP06, DBH.class, fill = meanY))+geom_raster()+facet_wrap(~cohorts, ncol = 2)+scale_fill_distiller(palette = "BrBG", direction = 1, name = "Tree \nGrowth")+ylab("Tree diameter")+xlab("SP06")+theme_bw(base_size = 12)

gg.tile.past.mod.cohort <- ggplot(preds_ci_age_struct, aes(SP01, DBH.class, fill = meanY))+geom_raster()+facet_grid(cols = vars(cohorts), rows = vars(SP06))+scale_fill_distiller(palette = "BrBG", direction = 1, name = "Tree \nGrowth")+ylab("Tree diameter")+xlab("SP01")+theme_bw(base_size = 12)

png(height = 8, width = 10, units = "in", res = 300, "outputs/growth_model/site_reg_structure_cohort_re_sp06_sp01_lag/predicted_growth_mod_past_forest_sav_tile_sp6.png")
gg.tile.past.mod.cohort
dev.off()

```

# model for cohort effects with summer VPD instead of PDSI
```{r}

cohort_model_site_VPD_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[cohort[i]] + beta2[cohort[i]]*VPD.scaled[i] + beta3[cohort[i]]*DBH.scaled[i]+ beta4[cohort[i]]*log_RWI_1[i]  # use Drought index as a scaled variable 
}



# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(S)){
beta1[s] ~ dnorm(mu_beta1[plot[s]], inv_beta1)
beta2[s] ~ dnorm(mu_beta2[plot[s]], inv_beta2)
beta3[s] ~ dnorm(mu_beta3[plot[s]], inv_beta3)
beta4[s] ~ dnorm(mu_beta4[plot[s]], inv_beta4)
}


for(j in 1:length(ind)){
# use normal hyperpriors for each hyperparamters 
mu_beta1[j] ~ dnorm(0, 0.5)
mu_beta2[j] ~ dnorm(0, 0.5)
mu_beta3[j] ~ dnorm(0, 0.5)
mu_beta4[j] ~ dnorm(0, 0.5)
}

inv_beta1   ~ dgamma(0.001, 0.001)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.001, 0.001)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.001, 0.001)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.001, 0.001)
sigma_beta4 <- 1/sqrt(inv_beta4)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.0001, 0.0001)
sigma     <- 1/sqrt(inv.var)


for(i in 1:np){
# process model
Yp[i]   ~ dnorm(gfuncp[i], inv.var) # where Yi is already log transformed

# function g()
gfuncp[i] <- beta1[cohort.p[i]] + beta2[cohort.p[i]]*VPD.scaled.p[i] + beta3[cohort.p[i]]*DBH.scaled.p[i] + beta4[cohort.p[i]]*log_RWI_1.p[i]  # use Drought index as a scaled variable 
}

}"

cohort.model.VPD.re <- jags.model(textConnection(cohort_model_site_VPD_re ), 
                    data = list(Y=log(train$RWI), n=length(train$RWI), VPD.scaled = train$jja.VPDmax.scaled, DBH.scaled = train$DBH.scaled, log_RWI_1 = log(train$RWI_1), cohort = as.numeric(train$ageclass), S = unique(train$ageclass),
                    plot = as.numeric(train$site), ind = unique(train$site), np = length(test$DBH.scaled),  VPD.scaled.p = test$jja.VPDmax.scaled, DBH.scaled.p = test$DBH.scaled, log_RWI_1.p = log(test$RWI_1), cohort.p = as.numeric(test$ageclass), SP = unique(test$ageclass),
                    plot.p = as.numeric(test$site), ind.p = unique(test$site)), n.chains = 3, n.adapt = 100)

update(cohort.model.VPD.re , 2000); # Burnin for 1000 samples to start, then go higher later

samp <- coda.samples(cohort.model.VPD.re , 
                     variable.names=c("beta1", "beta2","beta3","beta4","sigma", "sigma_beta1", "sigma_beta2", "sigma_beta3","sigma_beta4", "mu_beta1", "mu_beta2", "mu_beta3", "mu_beta4","Yp"), 
                    n.chains = 3, n.iter=2000, thin = 10)

summary(samp)
#traceplot(samp)
#gelman.diag(samp)


dic.full <- dic.samples(cohort.model.VPD.re, n.chains = 3, n.iter=20000,thin = 15)
saveRDS(dic.full, "outputs/growth_model/model_summary/basic_reg_cohort_site_VPD_re_DIC.rds")

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp[[1]]
 saveRDS(samps, "outputs/growth_model/basic_reg_cohort_site_VPD_re/samps.rds")
 Yp.samps    <- samps[,1:length(test$RWI)] 
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 alpha.samps  <- samps[,(length(test$RWI)+1):(length(test$RWI)+2)]
 beta2.samps <- samps[,(length(test$RWI)+3):(length(test$RWI)+4)]
 beta3.samps <- samps[,(length(test$RWI)+5):(length(test$RWI)+6)]
 beta4.samps <- samps[,(length(test$RWI)+7):(length(test$RWI)+8)]
 mu_beta1.samps <- samps[,(length(test$RWI)+9):(length(test$RWI)+10)]
 mu_beta2.samps <- samps[,(length(test$RWI)+11):(length(test$RWI)+12)]
 mu_beta3.samps <- samps[,(length(test$RWI)+13):(length(test$RWI)+14)]
 mu_beta4.samps <- samps[,(length(test$RWI)+15):(length(test$RWI)+16)]
 sigma.samps <- samps[,(length(test$RWI)+17)]
 sigma_betas <- samps[,(length(test$RWI)+18):(length(test$RWI)+21)]

 
 
 # plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(Yp.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(exp(value)),
                                                  ci.hi = quantile(exp(value),0.975),
                                                 ci.lo = quantile(exp(value),0.025))
Yp.summary$Observed <- test$RWI

pred.obs <- summary(lm(colMeans(exp(Yp.samps))~ test$RWI))

p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+ylim(0, 8)+xlim(0,8)+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note poor model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/basic_reg_cohort_site_VPD_re/pred_vs_obs.png")
p.o.plot
dev.off()


# calculate MSE & BIAS:

MSE1   <- mean((colMeans(exp(Yp.samps))-test$RWI)^2)
BIAS1  <- mean(colMeans(exp(Yp.samps))-test$RWI)

# write model summary output to a file!

model.summary <- data.frame(model = "basic_reg_cohort_site_VPD_re", 
          model.structure = "beta1[cohort[i]] + beta2[cohort[i]]*VPD.scaled[i] + beta3[cohort[i]]*DBH.scaled[i]+ beta4[cohort[i]]*log_RWI_1[i]",
           MSE = MSE1, 
           BIAS = BIAS1, 
           Rsq = pred.obs$r.squared)

write.csv(model.summary, paste0("outputs/growth_model/model_summary/", model.summary$model, "_summary.csv"), row.names = FALSE)


# summarise the datasource to make model comparisons for best fit models
data.summary <- data.frame(model = "basic_reg_cohort_site_VPD_re", 
                           train = "cohort.omit", 
                           DI.scaled = "JJAVPDmax")

write.csv(data.summary, paste0("outputs/growth_model/data_summary/", data.summary$model, "_data.csv"), row.names = FALSE)



 
png("outputs/growth_model/basic_reg_cohort_site_VPD_re/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past")
hist(alpha.samps[,2], main = "alpha Modern")
#hist(alpha.samps[,3],  main = "alpha Past-Forest")
#hist(alpha.samps[,4],  main = "alpha Modern-Forest")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/basic_reg_cohort_site_VPD_re/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Savanna")
hist(beta2.samps[,2], main = "beta2 Modern-Savanna")
#hist(beta2.samps[,3],  main = "beta2 Past-Forest")
#hist(beta2.samps[,4],  main = "beta2 Modern-Forest")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()





png("outputs/growth_model/basic_reg_cohort_site_VPD_re/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Savanna")
hist(beta3.samps[,2], main = "beta3 Modern-Savanna")
#hist(beta3.samps[,3],  main = "beta3 Past-Forest")
#hist(beta3.samps[,4],  main = "beta3 Modern-Forest")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


png(height = 10, width = 10, units = "in", res = 300,"outputs/growth_model/basic_reg_cohort_site_VPD_re/marginal_mu_beta2s.png")
par(mfrow=c(4,4))
for(i in 1:length(colnames(mu_beta3.samps))){
  hist(mu_beta2.samps[,i], main = paste(colnames(mu_beta2.samps)[i]))
}
dev.off()


png(height = 10, width = 10, units = "in", res = 300,"outputs/growth_model/basic_reg_cohort_site_VPD_re/marginal_mu_beta3s.png")
par(mfrow=c(4,4))
for(i in 1:length(colnames(mu_beta3.samps))){
  hist(mu_beta3.samps[,i], main = paste(colnames(mu_beta3.samps)[i]))
}
dev.off()

png(height = 10, width = 10, units = "in", res = 300,"outputs/growth_model/basic_reg_cohort_site_VPD_re/marginal_mu_beta1s.png")
par(mfrow=c(4,4))
for(i in 1:length(colnames(mu_beta1.samps))){
  hist(mu_beta1.samps[,i], main = paste(colnames(mu_beta1.samps)[i]))
}
dev.off()

# plot predicted vs. observed:
png("outputs/growth_model/basic_reg_cohort_site_VPD_re/pred_vs_obs.png")
plot(colMeans(exp(Yp.samps)), test$RWI) 
abline(a = 0, b = 1, col = "red")
dev.off()



# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0("alpha-", c("Modern", "Past")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Random intercepts")+theme_black()


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0("beta2-",c("Modern", "Past")))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("VPD Index slope")+theme_black()


b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0("beta3-",c("Modern", "Past")))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("DBH slope")+theme_black()

library(cowplot)
png(width = 5, height = 6, units = "in", res = 300, "outputs/growth_model/basic_reg_cohort_site_VPD_re/param_marginal_distn_bycohort.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots, ncol = 1)
dev.off()

# Compute the posterior mean for the plug-in predictions  

 beta1.mn  <- colMeans(alpha.samps)
 beta2.mn  <- colMeans(beta2.samps)
 beta3.mn  <- colMeans(beta3.samps)
 sigma.mn <- mean(sigma.samps)
 alpha1.mn <- colMeans(alpha.samps) 
 #mu_beta1.samps <- colMeans(mu_beta1.samps) 
 #mu_beta2.samps <- colMeans(mu_beta2.samps) 
 #mu_beta3.samps <- colMeans(mu_beta3.samps) 


# get posterior predictions:
 DIprobe <- seq(range(full.ghcn$jja.VPDmax.scaled)[1], range(full.ghcn$jja.VPDmax.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  cohort= 1:2, site = as.numeric(unique(full.ghcn$site)))
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:



 Xp <- full.probe
 np <- length(Xp$Var1)
 ypred <- list()
 
 
 for(j in 1:np){

   # PPD
   #plot(density(Yp.samps[,j]),xlab="Y",main="PPD")

        
        alpha1.mn <- rnorm(1000, mu_beta1.samps[Xp[j,4]], mean(sigma_betas[,1]) ) # check the sigma betas
        beta2.mn <- rnorm(1000, mu_beta2.samps[Xp[j,4]], mean(sigma_betas[,2]) ) # check the sigma betas
        beta3.mn <- rnorm(1000, mu_beta3.samps[Xp[j,3]], mean(sigma_betas[,3]) ) # check the sigma betas
       
   mu <- alpha1.mn + beta2.mn*Xp[j,1] + beta2.mn*Xp[j,2]   # use
   
   #mu <- alpha1.mn+sum(Xp[j,1]*beta1.mn, Xp[j,2]*beta2.mn)
   
   ypred[[j]]  <- mu
  # lines(density(y),col=2)
   
   #abline(v=Y[j],col=3,lwd=2)

   #legend("topright",c("PPD","Plug-in","Truth"),col=1:3,lty=1,inset=0.05)
}

ypred.df <- do.call(rbind, ypred)


Xp$MeanY <- rowMeans(exp(ypred.df))

Xp$cohort <- ifelse(Xp$cohort == 2, "Past",  
                       ifelse(Xp$cohort == 1, "Modern",NA))
#DBH + DI on predicted growth

# Todo: unscale Drought and DBH indices

png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/basic_reg_cohort_site_VPD_re/Ypred_by_VPD_struct_x_cohort.png")
ggplot(Xp, aes(Var1, MeanY, color = as.factor(site), shape = as.factor(cohort)))+geom_point()+xlab("VPD Index")+ylab("predicted growth")
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_cohort_site_VPD_re/Ypred_by_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var2,MeanY,color = as.factor(cohort)))+geom_point()+xlab("DBH Index")+ylab("predicted growth")
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_cohort_site_VPD_re/Ypred_by_VPD_DBH_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~ as.factor(cohort))
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_cohort_site_VPD_re/Ypred_by_VPD_DBH_site.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~ as.factor(site))
dev.off()


png(height = 10, width = 10, units = "in", res = 200,"outputs/growth_model/basic_reg_cohort_site_re/Ypred_by_drought_DBH_site_cohort.png")
ggplot(Xp[!Xp$site %in% "10",], aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~ as.factor(site) + as.factor(cohort))
dev.off()

```

# cohort model for only comparable drought years:
# model for cohort effects and site level effects, heirarchically:
```{r}
cohort_model_dry_site_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1[cohort[i]] + beta2[cohort[i]]*DI.scaled[i] + beta3[cohort[i]]*DBH.scaled[i]   # use Drought index as a scaled variable 
}



# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(S)){
beta1[s] ~ dnorm(mu_beta1[plot[s]], inv_beta1)
beta2[s] ~ dnorm(mu_beta2[plot[s]], inv_beta2)
beta3[s] ~ dnorm(mu_beta3[plot[s]], inv_beta3)
}


for(j in 1:length(ind)){
# use normal hyperpriors for each hyperparamters 
mu_beta1[j] ~ dnorm(0, 0.5)
mu_beta2[j] ~ dnorm(0, 0.5)
mu_beta3[j] ~ dnorm(0, 0.5)

}

inv_beta1   ~ dgamma(0.001, 0.001)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.001, 0.001)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.001, 0.001)
sigma_beta3 <- 1/sqrt(inv_beta3)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.0001, 0.0001)
sigma     <- 1/sqrt(inv.var)

# predictions for the model:
for(i in 1:np){
# process model
Yp[i]   ~ dnorm(gfuncp[i], inv.var) # where Yi is already log transformed

# function g()
gfuncp[i] <- beta1[cohort.p[i]] + beta2[cohort.p[i]]*DI.scaled.p[i] + beta3[cohort.p[i]]*DBH.scaled.p[i]   # use Drought index as a scaled variable 
}


}"



# save training and testing for later:
saveRDS(train, "outputs/growth_model/basic_reg_dry_cohort_site_re/train.rds")
saveRDS(test, "outputs/growth_model/basic_reg_dry_cohort_site_re/test.rds")

cohort.model.dry.re <- jags.model(textConnection(cohort_model_dry_site_re), 
                    data = list(Y=log(dry.yrs$RWI), n=length(dry.yrs$RWI), DI.scaled = dry.yrs$DI.scaled, DBH.scaled = dry.yrs$DBH.scaled, cohort = as.numeric(dry.yrs$ageclass), S = unique(dry.yrs$ageclass),
                    plot = as.numeric(dry.yrs$site), ind = unique(dry.yrs$site),  np=length(test$RWI), DI.scaled.p = test$DI.scaled, DBH.scaled.p = test$DBH.scaled, cohort.p = as.numeric(test$ageclass), SP = unique(test$ageclass),
                    plot.p = as.numeric(test$site), ind.p = unique(test$site)), n.chains = 3, n.adapt = 100)

update(cohort.model.dry.re, 2000); # Burnin for 1000 samples to start, then go higher later

samp <- coda.samples(cohort.model.dry.re, 
                     variable.names=c("beta1", "beta2","beta3","sigma", "sigma_beta1", "sigma_beta2", "sigma_beta3", "mu_beta1", "mu_beta2", "mu_beta3","Yp"), 
                    n.chains = 3, n.iter=10000, thin = 10)

summary(samp)
traceplot(samp)
gelman.diag(samp)



#Extract the samples for each parameter for a basic exploration of effects

 samps       <- samp[[1]]
 
 saveRDS(samps, "outputs/growth_model/basic_reg_dry_cohort_site_re/samps_full.rds")
 samps <-  readRDS( "outputs/growth_model/basic_reg_dry_cohort_site_re/samps_full.rds")
 Yp.samps    <- samps[,1:length(test$RWI)] 
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 alpha.samps  <- samps[,(length(test$RWI)+1):(length(test$RWI)+2)]
 beta2.samps <- samps[,(length(test$RWI)+3):(length(test$RWI)+4)]
 beta3.samps <- samps[,(length(test$RWI)+5):(length(test$RWI)+6)]
 mu_beta1.samps <- samps[,(length(test$RWI)+7):(length(test$RWI)+20)]
 mu_beta2.samps <- samps[,(length(test$RWI)+21):(length(test$RWI)+34)]
 mu_beta3.samps <- samps[,(length(test$RWI)+35):(length(test$RWI)+48)]
 sigma.samps <- samps[,(length(test$RWI)+49)]
 sigma_betas <- samps[,(length(test$RWI)+50):(length(test$RWI)+52)]

 
png("outputs/growth_model/basic_reg_dry_cohort_site_re/pred_vs_obs.png")
plot(colMeans(exp(Yp.samps)), test$RWI) 
abline(a = 0, b = 1, col = "red")
dev.off()

residual <- colMeans(exp(Yp.samps)) - test$RWI

hist(residual)


png("outputs/growth_model/basic_reg_dry_cohort_site_re/marginal_alphas.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past")
hist(alpha.samps[,2], main = "alpha Modern")
#hist(alpha.samps[,3],  main = "alpha Past-Forest")
#hist(alpha.samps[,4],  main = "alpha Modern-Forest")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/basic_reg_dry_cohort_site_re/marginal_beta1s.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Savanna")
hist(beta2.samps[,2], main = "beta2 Modern-Savanna")
#hist(beta2.samps[,3],  main = "beta2 Past-Forest")
#hist(beta2.samps[,4],  main = "beta2 Modern-Forest")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()





png("outputs/growth_model/basic_reg_dry_cohort_site_re/marginal_beta2s.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Savanna")
hist(beta3.samps[,2], main = "beta3 Modern-Savanna")
#hist(beta3.samps[,3],  main = "beta3 Past-Forest")
#hist(beta3.samps[,4],  main = "beta3 Modern-Forest")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


png(height = 10, width = 10, units = "in", res = 300,"outputs/growth_model/basic_reg_dry_cohort_site_re/marginal_mu_beta2s.png")
par(mfrow=c(4,4))
for(i in 1:length(colnames(mu_beta2.samps))){
  hist(mu_beta2.samps[,i], main = paste(colnames(mu_beta2.samps)[i]))
}
dev.off()


png(height = 10, width = 10, units = "in", res = 300,"outputs/growth_model/basic_reg_dry_cohort_site_re/marginal_mu_beta3s.png")
par(mfrow=c(4,4))
for(i in 1:length(colnames(mu_beta3.samps))){
  hist(mu_beta3.samps[,i], main = paste(colnames(mu_beta3.samps)[i]))
}
dev.off()

png(height = 10, width = 10, units = "in", res = 300,"outputs/growth_model/basic_reg_dry_cohort_site_re/marginal_mu_beta1s.png")
par(mfrow=c(4,4))
for(i in 1:length(colnames(mu_beta1.samps))){
  hist(mu_beta1.samps[,i], main = paste(colnames(mu_beta1.samps)[i]))
}
dev.off()


# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0("alpha-", c("Modern", "Past")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_black()+xlab("Random intercepts")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c("Modern", "Past")))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <-ggplot(b2.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.0075)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 18)+scale_fill_manual(values = c("Past"='#d73027',
"Modern"='#4575b4'))

b2.mean <- apply(as.matrix(b2[,1:2]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:2]), 2, function(x) quantile(x, probs = c(0.05)))
b2.upper <- apply(as.matrix(b2[,1:2]), 2, function(x) quantile(x, probs = c(0.95)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)
plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c("Past", "Modern"))
b2.dots <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+xlim(0 , 0.25)+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='#d73027',
"Modern"='#4575b4'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Drought Sensitivity")

png(height = 5, width = 8, units = "in", res = 300, "outputs/growth_model/basic_reg_dry_cohort_site_re/drougt_beta_marginal_distn_bycohort.png")
plot_grid(b2.dots+xlim(0.05 , 0.3), b2.mplots+coord_flip()+xlim(0.05 , 0.3)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()))
dev.off()

# difference between betas:
beta2.diff <- beta2.samps[,1] - beta2.samps[,2]

b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0("beta3-",c("Modern", "Past")))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_black()+xlab("DBH slope")



library(cowplot)
png(width = 5, height = 10, units = "in", res = 300, "outputs/growth_model/basic_reg_dry_cohort_site_re/param_marginal_distn_bycohort.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots, ncol = 1)
dev.off()

# Compute the posterior mean for the plug-in predictions  

 beta1.mn  <- colMeans(beta1.samps)
 beta2.mn  <- colMeans(beta2.samps)
 beta3.mn  <- colMeans(beta3.samps)
 sigma.mn <- mean(sigma.samps)
 alpha1.mn <- colMeans(alpha.samps) 
 #mu_beta1.samps <- colMeans(mu_beta1.samps) 
 #mu_beta2.samps <- colMeans(mu_beta2.samps) 
 #mu_beta3.samps <- colMeans(mu_beta3.samps) 


# get posterior predictions:
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  cohort= 1:2, site = as.numeric(unique(full.ghcn$site)))
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:



 Xp <- full.probe
 np <- length(Xp$Var1)
 ypred <- list()
 
 
 for(j in 1:np){

   # PPD
   #plot(density(Yp.samps[,j]),xlab="Y",main="PPD")

        
        alpha1.mn <- rnorm(1000, mu_beta1.samps[Xp[j,4]], mean(sigma_betas[,1]) ) # check the sigma betas
        beta2.mn <- rnorm(1000, mu_beta2.samps[Xp[j,4]], mean(sigma_betas[,2]) ) # check the sigma betas
        beta3.mn <- rnorm(1000, mu_beta3.samps[Xp[j,3]], mean(sigma_betas[,3]) ) # check the sigma betas
       
   mu <- alpha1.mn + beta2.mn*Xp[j,1] + beta2.mn*Xp[j,2]   # use
   
   #mu <- alpha1.mn+sum(Xp[j,1]*beta1.mn, Xp[j,2]*beta2.mn)
   
   ypred[[j]]  <- mu
  # lines(density(y),col=2)
   
   #abline(v=Y[j],col=3,lwd=2)

   #legend("topright",c("PPD","Plug-in","Truth"),col=1:3,lty=1,inset=0.05)
}

ypred.df <- do.call(rbind, ypred)


Xp$MeanY <- exp(rowMeans(ypred.df))

Xp$cohort <- ifelse(Xp$cohort == 2, "Past",  
                       ifelse(Xp$cohort == 1, "Modern",NA))
#DBH + DI on predicted growth

# Todo: unscale Drought and DBH indices

png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/basic_reg_cohort_site_re/Ypred_by_drought_struct_x_cohort.png")
ggplot(Xp, aes(Var1, MeanY, color = as.factor(site), shape = as.factor(cohort)))+geom_point()+xlab("Drought Index")+ylab("predicted growth")
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_cohort_site_re/Ypred_by_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var2,MeanY,color = as.factor(cohort)))+geom_point()+xlab("DBH Index")+ylab("predicted growth")
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_cohort_site_re/Ypred_by_drought_DBH_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~ as.factor(cohort))
dev.off()

png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_cohort_site_re/Ypred_by_drought_DBH_site.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~ as.factor(site))
dev.off()


png(height = 10, width = 10, units = "in", res = 200,"outputs/growth_model/basic_reg_cohort_site_re/Ypred_by_drought_DBH_site_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~ as.factor(site) + as.factor(cohort))
dev.off()

```







# >>>>>>>>>>>>>>>>>>>>>> Stable isotope results <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

# intercept only model (mean for d13C):
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
d13C_intercept_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model for iWUE:
d13[i]   ~ dnorm(d13func[i], inv.var) # where Yi is already log transformed

# function g()
d13func[i] <- beta1[struct.cohort[i]]

}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
}



# use normal hyperpriors for each hyperparamters 

mu_beta1 ~ dnorm(0, 0.1)


inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)



# Non-informative Prior for the inverse population variances

inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


# Predict test data:
for(i in 1:np){
# process model for 13:
d13.p[i]   ~ dnorm(d13func.p[i], inv.var) # where Yi is already log transformed

# function g()
d13func.p[i] <- beta1[struct.cohort.p[i]]

}


}"

test.iso <- test.iso[!is.na(test.iso$Cor.d13C.suess),]
train.iso <- train.iso[!is.na(train.iso$Cor.d13C.suess),]

d13_mean <- jags.model(textConnection(d13C_intercept_re), 
                    data = list(d13 = train.iso[!train.iso$site %in% "BON",]$Cor.d13C.suess, n=length(train.iso[!train.iso$site %in% "BON",]$iWUE), struct.cohort = as.numeric(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), SF = unique(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), struct.cohort.p =as.numeric(test.iso[!test.iso$site %in% "BON",]$struct.cohort.code), np = length(as.numeric(test.iso[!test.iso$site %in% "BON",]$struct.cohort.code)) ), n.chains = 3, n.adapt = 100)

update(d13_mean, 1000); # Burnin for 1000 samples to start, then go higher later


d13.mean.re <- coda.samples(d13_mean, 
                     variable.names=c("beta1", "mu_beta1", "d13.p"), 
                    n.chains = 3, n.iter = 20000, thin = 15)

#summary(d13.mean.re )
#plot(d13.mean.re )

#gelman.diag(d13.mean.re  )
#acfplot(d13.mean.re )

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- d13.mean.re [[1]]
 saveRDS(samps, "outputs/growth_model/d13C_intercept_mode/samps.d13_noBON.rds")
 saveRDS(samps, "outputs/growth_model/d13C_intercept_mode/train_iso_noBON.rds")
saveRDS(samps, "outputs/growth_model/d13C_intercept_mode/test_iso_noBON.rds")
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 #d13pred <- samps
 alpha.samps  <- samps[,1:4]
 d13p.samps  <- samps[,5:(4+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]


 #------------------ plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(d13p.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(value),
                                                  ci.hi = quantile(value,0.975),
                                                 ci.lo = quantile(value,0.025))
Yp.summary$Observed <- test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess

pred.obs <- summary(lm(colMeans(Yp.samps)~ test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))

# this does a poor job representing d13 values by itself, but explains som of the variation
p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note better model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/d13C_intercept_mode/pred_vs_obs.png")
p.o.plot
dev.off()
 

png("outputs/growth_model/d13C_intercept_mode/marginal_alphas_v3_iWUE.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Savanna")
hist(alpha.samps[,2], main = "alpha Modern-Savanna")
hist(alpha.samps[,3],  main = "alpha Past-Forest")
hist(alpha.samps[,4],  main = "alpha Modern-Forest")

dev.off()


# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c(unique(train.iso$struct.cohort)[order(unique(train.iso$struct.cohort.code))])))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("d13C")


ggplot(a.m, aes(variable, value, fill = variable))+geom_boxplot(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("d13C")

a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c(unique(full.iso$struct.cohort)[order(unique(full.iso$struct.cohort.code))])))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
a.mplots <-ggplot(a.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.5)+theme_bw()+xlab("Estimated mean D13C")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))

a.mean <- apply(as.matrix(a[,1:4]), 2, mean)
a.lower <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
a.upper <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.a <- data.frame(a.mean, a.lower, a.upper)
plot.dat.a$class <- row.names(plot.dat.a)
plot.dat.a$class <- factor(plot.dat.a$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

a.dots <- ggplot(plot.dat.a, aes(x = a.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 2,height = 0)+geom_point()+xlim(-26, -22)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated Mean d13C")

png(height = 5, width = 12, units = "in",res = 300,"outputs/growth_model/d13C_intercept_mode/d13C_alpha_marginal_distn_bycohort.png")
plot_grid(a.dots, a.mplots+coord_flip()+ xlim(-26, -22)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.75))
dev.off()

library(cowplot)
png(width = 7, height = 3, units = "in", res = 300, "outputs/growth_model/d13C_intercept_mode/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes.png")
plot_grid(alpha.mplots, ncol = 1)
dev.off()




plot.dat.a$ageclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.a$ageclass <- factor(plot.dat.a$ageclass, levels = c("Past", "Modern"))

plot.dat.a$forestclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")

a.dots.2 <- ggplot(plot.dat.a, aes(x = a.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 2,height = 0)+geom_point()+xlim(-26, -22)+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.text.x = element_blank())+xlab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)")))+facet_wrap(~forestclass)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13C_intercept_mode/param_marginal_distn_bycohort_struct_v3_d13_random_slopes.png")
a.dots.2
dev.off()


png(width = 7, height = 3, units = "in", res = 300, "outputs/growth_model/d13C_intercept_mode/param_marginal_distn_bycohort_struct_v3_d13_random_slopes_bw.png")
plot_grid(a.dots.2 + theme_bw(base_size = 14)+theme(legend.position = "none"), ncol = 1)
dev.off()

```

# intercept and VPDmax model for d13C:

```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
d13_VPD_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model for iWUE:
d13[i]   ~ dnorm(d13func[i], inv.var) # where Yi is already log transformed

# function g()
d13func[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*VPD_scaled[i]

}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
}



# use normal hyperpriors for each hyperparamters 

mu_beta1 ~ dnorm(0, 0.1)
mu_beta2 ~ dnorm(0, 0.1)


inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)

inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)



# Non-informative Prior for the inverse population variances

inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


# Predict test data
for(i in 1:np){
# process model for iWUE:
d13.p[i]   ~ dnorm(d13func.p[i], inv.var) # where Yi is already log transformed

# function g()
d13func.p[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*VPD_scaled.p[i]

}


}"



d13_vpd <- jags.model(textConnection(d13_VPD_re), 
                    data = list(d13 = train.iso[!train.iso$site %in% "BON",]$Cor.d13C.suess, n=length(train.iso[!train.iso$site %in% "BON",]$iWUE), struct.cohort = as.numeric(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), SF = unique(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), VPD_scaled = train.iso[!train.iso$site %in% "BON",]$jja.VPDmax.scaled, np = length(test.iso[!test.iso$site %in% "BON",]$site), struct.cohort.p = as.numeric(test.iso[!test.iso$site %in% "BON",]$struct.cohort.code), VPD_scaled.p = test.iso[!test.iso$site %in% "BON",]$jja.VPDmax.scaled), n.chains = 3, n.adapt = 100)

update(d13_vpd, 1000); # Burnin for 1000 samples to start, then go higher later


d13.mean.re <- coda.samples(d13_vpd, 
                     variable.names=c("beta1", "beta2","mu_beta1","mu_beta2", "d13.p"), 
                    n.chains = 3, n.iter = 20000, thin = 15)

summary(d13.mean.re )
plot(d13.mean.re )

gelman.diag(d13.mean.re )
acfplot(d13.mean.re )

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- d13.mean.re [[1]]
 saveRDS(samps, "outputs/growth_model/d13_VPD/samps.d13_nobon.rds")
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 #d13pred <- samps
 alpha.samps  <- samps[,1:4]
 beta.samps  <- samps[,5:8]
d13.samps  <- samps[,9:(8+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]
 #d13p.samps  <- samps[,5:(4+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]


 #------------------ plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(d13.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(value),
                                                  ci.hi = quantile(value,0.975),
                                                 ci.lo = quantile(value,0.025))
Yp.summary$Observed <- test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess

pred.obs <- summary(lm(colMeans(Yp.samps)~ test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))

# this does a poor job representing d13 values by itself, but explains som of the variation
p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=-22, y=-26)

# note better model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/d13_VPD/pred_vs_obs.png")
p.o.plot
dev.off()

# ----------------- Plot intercepts/params ---------------------

png("outputs/growth_model/d13_VPD/marginal_alphas_v3_d13.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Savanna")
hist(alpha.samps[,2], main = "alpha Modern-Savanna")
hist(alpha.samps[,3],  main = "alpha Past-Forest")
hist(alpha.samps[,4],  main = "alpha Modern-Forest")

dev.off()


png("outputs/growth_model/d13_VPD/marginal_alphas_v3_d13.png")
par(mfrow=c(3,2))
hist(beta.samps[,1], main = "alpha Past-Savanna")
hist(beta.samps[,2], main = "alpha Modern-Savanna")
hist(beta.samps[,3],  main = "alpha Past-Forest")
hist(beta.samps[,4],  main = "alpha Modern-Forest")

dev.off()

# -----------plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c("Past-Forest", "Modern-Forest", "Past-Savanna", "Modern-Savanna")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("iWUE")


ggplot(a.m, aes(variable, value, fill = variable))+geom_boxplot(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("iWUE")

a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
a.mplots <-ggplot(a.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.5)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',

"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


# for VPD:
b <- data.frame(beta.samps)
colnames(b) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

b$num <- rownames(b)
b.m <- melt(b, id.vars=c("num"))
b.mplots <-ggplot(b.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated VPDmax Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))



# calculate dot plots
a.mean <- apply(as.matrix(a[,1:4]), 2, mean)
a.lower <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
a.upper <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.a <- data.frame(a.mean, a.lower, a.upper)
plot.dat.a$class <- row.names(plot.dat.a)
plot.dat.a$class <- factor(plot.dat.a$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.a$ageclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.a$ageclass <- factor(plot.dat.a$ageclass, levels = c("Past", "Modern"))
plot.dat.a$forestclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


a.dots.2 <- ggplot(plot.dat.a, aes(x = a.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+xlim(-25.5, -22)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+facet_wrap(~forestclass)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_VPD/param_marginal_distn_bycohort_struct_v3_d13_random_slopes.png")
a.dots.2
dev.off()


b.mean <- apply(as.matrix(b[,1:4]), 2, mean)
b.lower <- apply(as.matrix(b[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b.upper <- apply(as.matrix(b[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b <- data.frame(b.mean, b.lower, b.upper)
plot.dat.b$class <- row.names(plot.dat.b)
plot.dat.b$class <- factor(plot.dat.b$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.b$ageclass <- ifelse(plot.dat.b$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.b$ageclass <- factor(plot.dat.b$ageclass, levels = c("Past", "Modern"))
plot.dat.b$forestclass <- ifelse(plot.dat.b$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


b.dots.2 <- ggplot(plot.dat.b, aes(x = b.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b.lower, xmax = b.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+facet_wrap(~forestclass)+xlim(-0.25, 1)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_VPD/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_VPD_impact.png")
b.dots.2
dev.off()

```

# intercept VPDmax and DBH  model for d13C:

```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
d13_VPD_DBH_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model for iWUE:
d13[i]   ~ dnorm(d13func[i], inv.var) # where Yi is already log transformed

# function g()
d13func[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*VPD_scaled[i] + beta3[struct.cohort[i]]*DBH_scaled[i]

}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
}



# use normal hyperpriors for each hyperparamters 

mu_beta1 ~ dnorm(0, 0.1)
mu_beta2 ~ dnorm(0, 0.1)
mu_beta3 ~ dnorm(0, 0.1)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)

inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)

inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)



# Non-informative Prior for the inverse population variances

inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


# Predict test data
for(i in 1:np){
# process model for iWUE:
d13.p[i]   ~ dnorm(d13func.p[i], inv.var) # where Yi is already log transformed

# function g()
d13func.p[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*VPD_scaled.p[i]+ beta3[struct.cohort.p[i]]*DBH_scaled.p[i]

}


}"



d13_vpd_dbh <- jags.model(textConnection(d13_VPD_DBH_re), 
                    data = list(d13 = train.iso[!train.iso$site %in% "BON",]$Cor.d13C.suess, n=length(train.iso[!train.iso$site %in% "BON",]$iWUE), struct.cohort = as.numeric(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), SF = unique(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), VPD_scaled = train.iso[!train.iso$site %in% "BON",]$jja.VPDmax.scaled, DBH_scaled = train.iso[!train.iso$site %in% "BON",]$DBH.scaled, np = length(test.iso[!test.iso$site %in% "BON",]$site), struct.cohort.p = as.numeric(test.iso[!test.iso$site %in% "BON",]$struct.cohort.code), VPD_scaled.p = test.iso[!test.iso$site %in% "BON",]$jja.VPDmax.scaled, DBH_scaled.p = test.iso[!test.iso$site %in% "BON",]$DBH.scaled), n.chains = 3, n.adapt = 100)

update(d13_vpd_dbh, 1000); # Burnin for 1000 samples to start, then go higher later


d13.mean.re <- coda.samples(d13_vpd_dbh, 
                     variable.names=c("beta1", "beta2","beta3","mu_beta1","mu_beta2","mu_beta3", "d13.p"), 
                    n.chains = 3, n.iter = 20000, thin = 15)

summary(d13.mean.re )
plot(d13.mean.re )

gelman.diag(d13.mean.re )
acfplot(d13.mean.re )

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- d13.mean.re [[1]]
 saveRDS(samps, "outputs/growth_model/d13_VPD_DBH/samps.d13_nobon.rds")
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 #d13pred <- samps
 alpha.samps  <- samps[,1:4]
 beta.samps  <- samps[,5:8]
 beta2.samps  <- samps[,9:12]
d13.samps  <- samps[,13:(12+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]
 #d13p.samps  <- samps[,5:(4+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]


 #------------------ plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(d13.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(value),
                                                  ci.hi = quantile(value,0.975),
                                                 ci.lo = quantile(value,0.025))
Yp.summary$Observed <- test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess

pred.obs <- summary(lm(colMeans(Yp.samps)~ test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))

# this does a poor job representing d13 values by itself, but explains som of the variation
p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=-22, y=-26)

# note fairly poor model fit
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/d13_VPD_DBH/pred_vs_obs.png")
p.o.plot
dev.off()

# ----------------- Plot intercepts/params ---------------------

png("outputs/growth_model/d13_VPD_DBH/marginal_alphas_v3_d13.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Savanna")
hist(alpha.samps[,2], main = "alpha Modern-Savanna")
hist(alpha.samps[,3],  main = "alpha Past-Forest")
hist(alpha.samps[,4],  main = "alpha Modern-Forest")

dev.off()


png("outputs/growth_model/d13_VPD/marginal_alphas_v3_d13.png")
par(mfrow=c(3,2))
hist(beta.samps[,1], main = "alpha Past-Savanna")
hist(beta.samps[,2], main = "alpha Modern-Savanna")
hist(beta.samps[,3],  main = "alpha Past-Forest")
hist(beta.samps[,4],  main = "alpha Modern-Forest")

dev.off()

# -----------plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c("Past-Forest", "Modern-Forest", "Past-Savanna", "Modern-Savanna")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("iWUE")


ggplot(a.m, aes(variable, value, fill = variable))+geom_boxplot(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("iWUE")

a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
a.mplots <-ggplot(a.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.5)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',

"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


# for VPD:
b <- data.frame(beta.samps)
colnames(b) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

b$num <- rownames(b)
b.m <- melt(b, id.vars=c("num"))
b.mplots <-ggplot(b.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated VPDmax Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))


# for DBH:
b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <-ggplot(b2.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated DBH Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))


# calculate dot plots
a.mean <- apply(as.matrix(a[,1:4]), 2, mean)
a.lower <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
a.upper <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.a <- data.frame(a.mean, a.lower, a.upper)
plot.dat.a$class <- row.names(plot.dat.a)
plot.dat.a$class <- factor(plot.dat.a$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.a$ageclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.a$ageclass <- factor(plot.dat.a$ageclass, levels = c("Past", "Modern"))
plot.dat.a$forestclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


a.dots.2 <- ggplot(plot.dat.a, aes(x = a.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+xlim(-25.5, -22)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+facet_wrap(~forestclass)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_VPD/param_marginal_distn_bycohort_struct_v3_d13_random_slopes.png")
a.dots.2
dev.off()

# dot plot for VPD
b.mean <- apply(as.matrix(b[,1:4]), 2, mean)
b.lower <- apply(as.matrix(b[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b.upper <- apply(as.matrix(b[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b <- data.frame(b.mean, b.lower, b.upper)
plot.dat.b$class <- row.names(plot.dat.b)
plot.dat.b$class <- factor(plot.dat.b$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.b$ageclass <- ifelse(plot.dat.b$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.b$ageclass <- factor(plot.dat.b$ageclass, levels = c("Past", "Modern"))
plot.dat.b$forestclass <- ifelse(plot.dat.b$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


b.dots.2 <- ggplot(plot.dat.b, aes(x = b.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b.lower, xmax = b.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+facet_wrap(~forestclass)+xlim(-0.25, 1)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_VPD/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_VPD_impact.png")
b.dots.2
dev.off()

# dot plot for DBH
b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)
plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels = c("Past", "Modern"))
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+facet_wrap(~forestclass)+xlim(-0.7, 1)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_VPD/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_DBH_impact.png")
b.dots.2
dev.off()

```

# intercept total precip and VPDmax  model for d13C:
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
d13_MAP_tmax_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model for iWUE:
d13[i]   ~ dnorm(d13func[i], inv.var) # where Yi is already log transformed

# function g()
d13func[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*MAP_scaled[i] + beta3[struct.cohort[i]]*TMAX_scaled[i]

}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
}



# use normal hyperpriors for each hyperparamters 

mu_beta1 ~ dnorm(0, 0.1)
mu_beta2 ~ dnorm(0, 0.1)
mu_beta3 ~ dnorm(0, 0.1)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)

inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)

inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)



# Non-informative Prior for the inverse population variances

inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


# Predict test data
for(i in 1:np){
# process model for iWUE:
d13.p[i]   ~ dnorm(d13func.p[i], inv.var) # where Yi is already log transformed

# function g()
d13func.p[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*MAP_scaled.p[i]+ beta3[struct.cohort.p[i]]*TMAX_scaled.p[i]

}


}"



d13_map_tmax <- jags.model(textConnection(d13_MAP_tmax_re), 
                    data = list(d13 = train.iso[!train.iso$site %in% "BON",]$Cor.d13C.suess, n=length(train.iso[!train.iso$site %in% "BON",]$iWUE), struct.cohort = as.numeric(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), SF = unique(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), MAP_scaled = train.iso[!train.iso$site %in% "BON",]$MAP.scaled, TMAX_scaled = train.iso[!train.iso$site %in% "BON",]$T.scaled, np = length(test.iso[!test.iso$site %in% "BON",]$site), struct.cohort.p = as.numeric(test.iso[!test.iso$site %in% "BON",]$struct.cohort.code), MAP_scaled.p = test.iso[!test.iso$site %in% "BON",]$MAP.scaled, TMAX_scaled.p = test.iso[!test.iso$site %in% "BON",]$T.scaled), n.chains = 3, n.adapt = 100)

update(d13_map_tmax, 1000); # Burnin for 1000 samples to start, then go higher later


d13_map_tmax.re <- coda.samples(d13_map_tmax, 
                     variable.names=c("beta1", "beta2","beta3","mu_beta1","mu_beta2","mu_beta3", "d13.p"), 
                    n.chains = 3, n.iter = 20000, thin = 15)

summary(d13_map_tmax.re )
plot(d13_map_tmax.re )

gelman.diag(d13_map_tmax.re )
acfplot(d13_map_tmax.re )

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- d13_map_tmax.re [[1]]
 saveRDS(samps, "outputs/growth_model/d13_MAP_TMAX/samps.d13_nobon.rds")
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 #d13pred <- samps
 alpha.samps  <- samps[,1:4]
 beta.samps  <- samps[,5:8]
 beta2.samps  <- samps[,9:12]
 d13.samps  <- samps[,13:(12+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]
 #d13p.samps  <- samps[,5:(4+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]


 #------------------ plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(d13.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(value),
                                                  ci.hi = quantile(value,0.975),
                                                 ci.lo = quantile(value,0.025))
Yp.summary$Observed <- test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess

pred.obs <- summary(lm(colMeans(Yp.samps)~ test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))

# this does a poor job representing d13 values by itself, but explains som of the variation
p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=-22, y=-26)

# note fairly poor model fit
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX/pred_vs_obs.png")
p.o.plot
dev.off()

# ----------------- Plot intercepts/params ---------------------

png("outputs/growth_model/d13_MAP_TMAX/marginal_alphas_v3_d13.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Savanna")
hist(alpha.samps[,2], main = "alpha Modern-Savanna")
hist(alpha.samps[,3],  main = "alpha Past-Forest")
hist(alpha.samps[,4],  main = "alpha Modern-Forest")

dev.off()


png("outputs/growth_model/d13_MAP_TMAX/marginal_alphas_v3_d13.png")
par(mfrow=c(3,2))
hist(beta.samps[,1], main = "alpha Past-Savanna")
hist(beta.samps[,2], main = "alpha Modern-Savanna")
hist(beta.samps[,3],  main = "alpha Past-Forest")
hist(beta.samps[,4],  main = "alpha Modern-Forest")

dev.off()

# -----------plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c("Past-Forest", "Modern-Forest", "Past-Savanna", "Modern-Savanna")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("iWUE")


ggplot(a.m, aes(variable, value, fill = variable))+geom_boxplot(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("iWUE")

a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
a.mplots <-ggplot(a.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.5)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',

"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


# for MAP:
b <- data.frame(beta.samps)
colnames(b) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

b$num <- rownames(b)
b.m <- melt(b, id.vars=c("num"))
b.mplots <-ggplot(b.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated Precip Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))


# for DBH:
b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <-ggplot(b2.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated Tmax Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))


# calculate dot plots
a.mean <- apply(as.matrix(a[,1:4]), 2, mean)
a.lower <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
a.upper <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.a <- data.frame(a.mean, a.lower, a.upper)
plot.dat.a$class <- row.names(plot.dat.a)
plot.dat.a$class <- factor(plot.dat.a$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.a$ageclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.a$ageclass <- factor(plot.dat.a$ageclass, levels = c("Past", "Modern"))
plot.dat.a$forestclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


a.dots.2 <- ggplot(plot.dat.a, aes(x = a.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+xlim(-25.5, -22)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+facet_wrap(~forestclass)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX/param_marginal_distn_bycohort_struct_v3_d13_random_slopes.png")
a.dots.2
dev.off()

# dot plot for MAP
b.mean <- apply(as.matrix(b[,1:4]), 2, mean)
b.lower <- apply(as.matrix(b[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b.upper <- apply(as.matrix(b[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b <- data.frame(b.mean, b.lower, b.upper)
plot.dat.b$class <- row.names(plot.dat.b)
plot.dat.b$class <- factor(plot.dat.b$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.b$ageclass <- ifelse(plot.dat.b$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.b$ageclass <- factor(plot.dat.b$ageclass, levels = c("Past", "Modern"))
plot.dat.b$forestclass <- ifelse(plot.dat.b$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


b.dots.2 <- ggplot(plot.dat.b, aes(x = b.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b.lower, xmax = b.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+facet_wrap(~forestclass)+xlim(-0.25, 1)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_Precip_impact.png")
b.dots.2
dev.off()

# dot plot for DBH
b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)
plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels = c("Past", "Modern"))
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+facet_wrap(~forestclass)+xlim(-0.7, 1)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_TMAX_impact.png")
b2.dots.2
dev.off()

```


# intercept total precip and VPDmax, DBH  model for d13C:
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
d13_MAP_tmax_dbh_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model for iWUE:
d13[i]   ~ dnorm(d13func[i], inv.var) # where Yi is already log transformed

# function g()
d13func[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*MAP_scaled[i] + beta3[struct.cohort[i]]*TMAX_scaled[i] + beta4[struct.cohort[i]]*DBH_scaled[i]

}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
}



# use normal hyperpriors for each hyperparamters 

mu_beta1 ~ dnorm(0, 0.1)
mu_beta2 ~ dnorm(0, 0.1)
mu_beta3 ~ dnorm(0, 0.1)
mu_beta4 ~ dnorm(0, 0.1)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)

inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)

inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)

inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)

# Non-informative Prior for the inverse population variances

inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


# Predict test data
for(i in 1:np){
# process model for iWUE:
d13.p[i]   ~ dnorm(d13func.p[i], inv.var) # where Yi is already log transformed

# function g()
d13func.p[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*MAP_scaled.p[i]+ beta3[struct.cohort.p[i]]*TMAX_scaled.p[i]+ beta4[struct.cohort.p[i]]*DBH_scaled.p[i]

}


# Probe values
for(i in 1:nprobe){
# process model for iWUE:
d13.probe[i]   ~ dnorm(d13func.probe[i], inv.var) # where Yi is already log transformed

# function g()
d13func.probe[i] <- beta1[struct.cohort.probe[i]] + beta2[struct.cohort.probe[i]]*MAP_scaled.probe[i]+ beta3[struct.cohort.probe[i]]*TMAX_scaled.probe[i]+ beta4[struct.cohort.probe[i]]*DBH_scaled.probe[i]

}

}"


# create probe to generate posterior predictions:
MAP.probe <- seq(range(full.iso$MAP.scaled)[1], range(full.iso$MAP.scaled)[2], by = 1)
T.probe <- seq(range(full.iso$T.scaled)[1], range(full.iso$T.scaled)[2], by = 1)
DBH.probe <- seq(range(full.iso$DBH.scaled)[1], range(full.iso$T.scaled)[2], by = 1)

d13probe <- expand.grid(MAP.probe = MAP.probe, T.probe = T.probe, DBH.probe = DBH.probe, struct.cohort.probe = 1:4)

d13_map_tmax <- jags.model(textConnection(d13_MAP_tmax_dbh_re), 
                    data = list(d13 = train.iso[!train.iso$site %in% "BON",]$Cor.d13C.suess, n=length(train.iso[!train.iso$site %in% "BON",]$iWUE), struct.cohort = as.numeric(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), SF = unique(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), MAP_scaled = train.iso[!train.iso$site %in% "BON",]$MAP.scaled, TMAX_scaled = train.iso[!train.iso$site %in% "BON",]$T.scaled, DBH_scaled = train.iso[!train.iso$site %in% "BON",]$DBH.scaled, np = length(test.iso[!test.iso$site %in% "BON",]$site), struct.cohort.p = as.numeric(test.iso[!test.iso$site %in% "BON",]$struct.cohort.code), MAP_scaled.p = test.iso[!test.iso$site %in% "BON",]$MAP.scaled, TMAX_scaled.p = test.iso[!test.iso$site %in% "BON",]$T.scaled, DBH_scaled.p = test.iso[!test.iso$site %in% "BON",]$DBH.scaled, 
                                nprobe = length(d13probe$MAP.probe),
                                MAP_scaled.probe = d13probe$MAP.probe,
                                TMAX_scaled.probe = d13probe$T.probe, 
                                DBH_scaled.probe = d13probe$DBH.probe,
                                struct.cohort.probe = d13probe$struct.cohort.probe), n.chains = 3, n.adapt = 100)

update(d13_map_tmax, 1000); # Burnin for 1000 samples to start, then go higher later


d13_map_tmax.re <- coda.samples(d13_map_tmax, 
                     variable.names=c("beta1", "beta2","beta3","beta4","mu_beta1","mu_beta2","mu_beta3","mu_beta4", "d13.p", "d13.probe"), 
                    n.chains = 3, n.iter = 20000, thin = 15)

summary( d13_map_tmax.re )
#plot(d13_map_tmax.re )

gelman.diag(d13_map_tmax.re )
#acfplot(d13_map_tmax.re )

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- d13_map_tmax.re [[1]]
 saveRDS(samps, "outputs/growth_model/d13_MAP_TMAX_dbh/samps.d13_nobon.rds")
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 #d13pred <- samps
 alpha.samps  <- samps[,1:4]
 beta.samps  <- samps[,5:8]
 beta2.samps  <- samps[,9:12]
 beta3.samps  <- samps[,13:16]
 d13.samps  <- samps[,17:(16+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]
 d13p.samps  <- samps[,(17+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess)):(16+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess)+length(d13probe$MAP.probe))]
 #d13p.samps  <- samps[,5:(4+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]


 #------------------ plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(d13.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(value),
                                                  ci.hi = quantile(value,0.975),
                                                 ci.lo = quantile(value,0.025))
Yp.summary$Observed <- test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess

pred.obs <- summary(lm(colMeans(Yp.samps)~ test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))

# this does a poor job representing d13 values by itself, but explains som of the variation
p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=-22, y=-26)

# note fairly poor model fit
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/pred_vs_obs.png")
p.o.plot
dev.off()

# ----------------- Plot intercepts/params ---------------------

png("outputs/growth_model/d13_MAP_TMAX_dbh/marginal_alphas_v3_d13.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Savanna")
hist(alpha.samps[,2], main = "alpha Modern-Savanna")
hist(alpha.samps[,3],  main = "alpha Past-Forest")
hist(alpha.samps[,4],  main = "alpha Modern-Forest")

dev.off()


png("outputs/growth_model/d13_MAP_TMAX_dbh/marginal_alphas_v3_d13.png")
par(mfrow=c(3,2))
hist(beta.samps[,1], main = "alpha Past-Savanna")
hist(beta.samps[,2], main = "alpha Modern-Savanna")
hist(beta.samps[,3],  main = "alpha Past-Forest")
hist(beta.samps[,4],  main = "alpha Modern-Forest")

dev.off()

# -----------plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c("Past-Forest", "Modern-Forest", "Past-Savanna", "Modern-Savanna")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+ylab("frequency")+xlab("d13C")


ggplot(a.m, aes(variable, value, fill = variable))+geom_boxplot(alpha = 0.5)+theme_bw()+ylab("frequency")+xlab("d13C")

a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
a.mplots <-ggplot(a.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.5)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_bw(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',

"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


# for MAP:
b <- data.frame(beta.samps)
colnames(b) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

b$num <- rownames(b)
b.m <- melt(b, id.vars=c("num"))
b.mplots <-ggplot(b.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated Precip Sensitivity")+theme_bw(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))


# for Tmax:
b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <-ggplot(b2.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated Tmax Sensitivity")+theme_bw(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))

# for DBH:
b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <-ggplot(b3.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated Tmax Sensitivity")+theme_bw(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))

# calculate dot plots
a.mean <- apply(as.matrix(a[,1:4]), 2, mean)
a.lower <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
a.upper <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.a <- data.frame(a.mean, a.lower, a.upper)
plot.dat.a$class <- row.names(plot.dat.a)
plot.dat.a$class <- factor(plot.dat.a$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.a$ageclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.a$ageclass <- factor(plot.dat.a$ageclass, levels = c("Past", "Modern"))
plot.dat.a$forestclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


a.dots.2 <- ggplot(plot.dat.a, aes(x = a.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 2,height = 0)+geom_point()+theme_bw(base_size = 18)+xlim(-25.5, -22)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+facet_wrap(~forestclass)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX/param_marginal_distn_bycohort_struct_v3_d13_random_slopes.png")
a.dots.2
dev.off()

# dot plot for MAP
b.mean <- apply(as.matrix(b[,1:4]), 2, mean)
b.lower <- apply(as.matrix(b[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b.upper <- apply(as.matrix(b[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b <- data.frame(b.mean, b.lower, b.upper)
plot.dat.b$class <- row.names(plot.dat.b)
plot.dat.b$class <- factor(plot.dat.b$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.b$ageclass <- ifelse(plot.dat.b$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.b$ageclass <- factor(plot.dat.b$ageclass, levels = c("Past", "Modern"))
plot.dat.b$forestclass <- ifelse(plot.dat.b$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


b.dots.2 <- ggplot(plot.dat.b, aes(x = b.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b.lower, xmax = b.upper, size = 2,height = 0)+geom_point()+theme_bw(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+facet_wrap(~forestclass)+xlim(-1, 0.25)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_Precip_impact.png")
b.dots.2
dev.off()

# dot plot for Tmax
b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)
plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels = c("Past", "Modern"))
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+theme_bw(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+facet_wrap(~forestclass)+xlim(-0.7, 1)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_TMAX_impact.png")
b2.dots.2
dev.off()




# dot plot for DBH
b3.mean <- apply(as.matrix(b3[,1:4]), 2, mean)
b3.lower <- apply(as.matrix(b3[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b3.upper <- apply(as.matrix(b3[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b3 <- data.frame(b3.mean, b3.lower, b3.upper)
plot.dat.b3$class <- row.names(plot.dat.b3)
plot.dat.b3$class <- factor(plot.dat.b3$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))



plot.dat.b3$ageclass <- ifelse(plot.dat.b3$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.b3$ageclass <- factor(plot.dat.b3$ageclass, levels = c("Past", "Modern"))
plot.dat.b3$forestclass <- ifelse(plot.dat.b3$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


b3.dots.2 <- ggplot(plot.dat.b3, aes(x = b3.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b3.lower, xmax = b3.upper, size = 2,height = 0)+geom_point()+theme_bw(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+facet_wrap(~forestclass)+xlim(-0.7, 1)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_DBH_impact.png")
b3.dots.2
dev.off()




# ---------- make marginal plots of probed data -------------
# plot probed values of tree growth predictions:
Yprobe <- data.frame(d13p.samps)
colnames(Yprobe) <- 1:length(Yprobe)
probe.m <- melt(Yprobe)
 
colnames(probe.m) <- c("num", "d13pred")

d13probe$num <- 1:length(d13probe[,1])
#colnames(full.p) <- c("MA","SP06", "DBH","Log_lag_RWI_1", "struct.cohort", "num")

# summarize by structure + cohort class only:
d13probe$num <- as.factor(as.character(d13probe$num))
probtest <- dplyr::inner_join(probe.m, d13probe, by=c("num"))

prob <- probtest


struc.conversion <- unique(train.iso[, c("struct.cohort", "struct.cohort.code", "ageclass")])
 #struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
struc.conversion$struct.cohort.probe <- as.integer(struc.conversion$struct.cohort.code)
 prob <- left_join(prob, struc.conversion, by  = "struct.cohort.probe")

 preds_ci <- prob %>% group_by( MAP.probe, T.probe, DBH.probe,  struct.cohort.probe) %>% dplyr::summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.025), Ci.high = quantile(d13pred, 0.975))


 # convert to unscaled data:
 prob$MAP <- round(unscale(prob$MAP.probe, MAP.scaled))
 prob$Tmax <- round(unscale(prob$T.probe, T.scaled))
 prob$DBH <- round(unscale(prob$DBH.probe, DBH.scaled))

 #--------------- plot marginal effects of climate and DBH on d13 ----------------

 

 
 # Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, ageclass) %>% summarise(meanY = mean(d13pred),                                                                           Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_MAP_marg <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)"))) +xlab("Total Annual Precipitation (mm)")+theme_bw()


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, ageclass) %>% summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_Tmax_marg <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)"))) +xlab("Max. Temp. (DegC)")+theme_bw()

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH,ageclass) %>% summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_DBH_marg <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)"))) + xlab("Tree DBH (cm)")+theme_bw()


png(height = 7, width = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/marginal_post_predictive_effects_ageclass.png")
legend <- get_legend(Y_MAP_marg)
plts <- plot_grid(Y_MAP_marg+theme(legend.position = "none"), Y_Tmax_marg+theme(legend.position = "none"), Y_DBH_marg+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()


# --------------plot marginal effects for each stand structure and cohort class:
# plot marginal effects of climate and previous years growth 
# Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, struct.cohort) %>% summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_MAP_marg_c <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = struct.cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_MAP, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = struct.cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)")))+xlab("Total Precipitation")


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, struct.cohort) %>% summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_Tmax_marg_c <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax,meanY, color = struct.cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = struct.cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)"))) +xlab("Max. Temperature (DegF)")

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH, struct.cohort) %>% summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_DBH_marg_c <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = struct.cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = struct.cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+  ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)")))+xlab("Tree DBH (cm)")

png(height = 7, width = 5, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/marginal_post_predictive_effects_ageclassXStruct.png")
legend <- get_legend(Y_MAP_marg_c)
plts <- plot_grid(Y_MAP_marg_c+theme(legend.position = "none"), Y_Tmax_marg_c+theme(legend.position = "none"), Y_DBH_marg_c+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.45))
dev.off()



#------------ plot d13 responses to cliamte conditional on DBH and other climate:
preds_ci_all <- prob %>% group_by(DBH, MAP, Tmax, struct.cohort.probe, cohort) %>% dplyr::summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

preds_ci_all_age <- prob %>% group_by(DBH, MAP, Tmax, ageclass) %>% dplyr::summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))



# --------filter select some DBH values and low and high temps by cohort and stucture class ----


prob_select <- preds_ci_all %>% dplyr::filter(DBH == 16 | DBH == 48 | DBH == 79 , Tmax == 72 | Tmax == 90  ) 


prob_select$DBH<- as.numeric(prob_select$DBH)
prob_select$Tmax<- as.numeric(prob_select$Tmax)


Drought.resp.DBH.temp.cohort <- ggplot(prob_select, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller = label_both)+ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)")))+xlab("Precipitation index")+theme_bw()


# output the above plots to PNG:
png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/MAP_response_high_temp_low_high_DBH_cohortXstruct.png")
Drought.resp.DBH.temp.cohort 
dev.off()

# --------filter select some DBH values and low and high temps by cohort/age class ----

prob_select <- preds_ci_all_age %>% dplyr::filter(DBH == 16 | DBH == 48 | DBH == 79 , Tmax == 72 | Tmax == 90  ) 


prob_select$DBH<- as.numeric(prob_select$DBH)
prob_select$Tmax<- as.numeric(prob_select$Tmax)


Drought.resp.DBH.temp.age <- ggplot(prob_select, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+scale_fill_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax), labeller=label_both)+ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)")))+xlab("Precipitation index")+theme_bw()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/MAP_response_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.age
dev.off()
```

# by ageclass not structure and cohort:
# intercept total precip and VPDmax, DBH  model for d13C:
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
d13_MAP_tmax_dbh_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model for iWUE:
d13[i]   ~ dnorm(d13func[i], inv.var) # where Yi is already log transformed

# function g()
d13func[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*MAP_scaled[i] + beta3[struct.cohort[i]]*TMAX_scaled[i] + beta4[struct.cohort[i]]*DBH_scaled[i]

}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
}



# use normal hyperpriors for each hyperparamters 

mu_beta1 ~ dnorm(0, 0.1)
mu_beta2 ~ dnorm(0, 0.1)
mu_beta3 ~ dnorm(0, 0.1)
mu_beta4 ~ dnorm(0, 0.1)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)

inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)

inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)

inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)

# Non-informative Prior for the inverse population variances

inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


# Predict test data
for(i in 1:np){
# process model for iWUE:
d13.p[i]   ~ dnorm(d13func.p[i], inv.var) # where Yi is already log transformed

# function g()
d13func.p[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*MAP_scaled.p[i]+ beta3[struct.cohort.p[i]]*TMAX_scaled.p[i]+ beta4[struct.cohort.p[i]]*DBH_scaled.p[i]

}


# Probe values
for(i in 1:nprobe){
# process model for iWUE:
d13.probe[i]   ~ dnorm(d13func.probe[i], inv.var) # where Yi is already log transformed

# function g()
d13func.probe[i] <- beta1[struct.cohort.probe[i]] + beta2[struct.cohort.probe[i]]*MAP_scaled.probe[i]+ beta3[struct.cohort.probe[i]]*TMAX_scaled.probe[i]+ beta4[struct.cohort.probe[i]]*DBH_scaled.probe[i]

}

}"


# create probe to generate posterior predictions:
MAP.probe <- seq(range(full.iso$MAP.scaled)[1], range(full.iso$MAP.scaled)[2], by = 1)
T.probe <- seq(range(full.iso$T.scaled)[1], range(full.iso$T.scaled)[2], by = 1)
DBH.probe <- seq(range(full.iso$DBH.scaled)[1], range(full.iso$T.scaled)[2], by = 1)

d13probe <- expand.grid(MAP.probe = MAP.probe, T.probe = T.probe, DBH.probe = DBH.probe, struct.cohort.probe = 1:2)
train.iso$age.code <- ifelse(train.iso$ageclass %in% "Past", 1, 2)
test.iso$age.code <- ifelse(test.iso$ageclass %in% "Past", 1, 2)


d13_map_tmax <- jags.model(textConnection(d13_MAP_tmax_dbh_re), 
                    data = list(d13 = train.iso[!train.iso$site %in% "BON",]$Cor.d13C.suess, n=length(train.iso[!train.iso$site %in% "BON",]$iWUE), struct.cohort = as.numeric(train.iso[!train.iso$site %in% "BON",]$age.code), SF = unique(train.iso[!train.iso$site %in% "BON",]$age.code), MAP_scaled = train.iso[!train.iso$site %in% "BON",]$MAP.scaled, TMAX_scaled = train.iso[!train.iso$site %in% "BON",]$T.scaled, DBH_scaled = train.iso[!train.iso$site %in% "BON",]$DBH.scaled, np = length(test.iso[!test.iso$site %in% "BON",]$site), struct.cohort.p = as.numeric(test.iso[!test.iso$site %in% "BON",]$age.code), MAP_scaled.p = test.iso[!test.iso$site %in% "BON",]$MAP.scaled, TMAX_scaled.p = test.iso[!test.iso$site %in% "BON",]$T.scaled, DBH_scaled.p = test.iso[!test.iso$site %in% "BON",]$DBH.scaled, 
                                nprobe = length(d13probe$MAP.probe),
                                MAP_scaled.probe = d13probe$MAP.probe,
                                TMAX_scaled.probe = d13probe$T.probe, 
                                DBH_scaled.probe = d13probe$DBH.probe,
                                struct.cohort.probe = d13probe$struct.cohort.probe), n.chains = 3, n.adapt = 100)

update(d13_map_tmax, 1000); # Burnin for 1000 samples to start, then go higher later


d13_map_tmax.re <- coda.samples(d13_map_tmax, 
                     variable.names=c("beta1", "beta2","beta3","beta4","mu_beta1","mu_beta2","mu_beta3","mu_beta4", "d13.p", "d13.probe"), 
                    n.chains = 3, n.iter = 20000, thin = 15)

#summary( d13_map_tmax.re )
#plot(d13_map_tmax.re )

#gelman.diag(d13_map_tmax.re )
#acfplot(d13_map_tmax.re )

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- d13_map_tmax.re [[1]]
 saveRDS(samps, "outputs/growth_model/d13_MAP_TMAX_dbh/samps.d13_nobon_age.rds")
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 #d13pred <- samps
 alpha.samps  <- samps[,1:2]
 beta.samps  <- samps[,3:4]
 beta2.samps  <- samps[,5:6]
 beta3.samps  <- samps[,7:8]
 d13.samps  <- samps[,9:(8+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]
 d13p.samps  <- samps[,(9+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess)):(8+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess)+length(d13probe$MAP.probe))]
 #d13p.samps  <- samps[,5:(4+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]


 #------------------ plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(d13.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(value),
                                                  ci.hi = quantile(value,0.975),
                                                 ci.lo = quantile(value,0.025))
Yp.summary$Observed <- test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess

pred.obs <- summary(lm(Yp.summary$Predicted~ Yp.summary$Observed))

# this does a poor job representing d13 values by itself, but explains som of the variation
p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=-22, y=-26)

# note fairly poor model fit
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/pred_vs_obs_cohort.png")
p.o.plot
dev.off()

# ----------------- Plot intercepts/params ---------------------



# -----------plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c("Modern", "Past")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+ylab("frequency")+xlab("d13C")


ggplot(a.m, aes(variable, value, fill = variable))+geom_boxplot(alpha = 0.5)+theme_bw()+ylab("frequency")+xlab("d13C")

a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c("Modern", "Past")))




# for MAP:
b <- data.frame(beta.samps)
colnames(b) <- c(paste0(c("Modern", "Past")))

b$num <- rownames(b)
b.m <- melt(b, id.vars=c("num"))
b.mplots <-ggplot(b.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated Precip Sensitivity")+theme_bw(base_size = 16)+scale_fill_manual(values = c("Past"='blue',"Modern"='red'))


# for Tmax:
b2 <- data.frame(beta2.samps)
colnames(b2) <-c(paste0(c("Modern", "Past")))

b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <-ggplot(b2.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated Tmax Sensitivity")+theme_bw(base_size = 16)

# for DBH:
b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0(c("Modern", "Past")))

b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <-ggplot(b3.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated DBH Sensitivity")+theme_bw(base_size = 16)+scale_fill_manual(values = c("Past"='blue',"Modern"='red'))

# calculate dot plots
a.mean <- apply(as.matrix(a[,1:2]), 2, mean)
a.lower <- apply(as.matrix(a[,1:2]), 2, function(x) quantile(x, probs = c(0.025)))
a.upper <- apply(as.matrix(a[,1:2]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.a <- data.frame(a.mean, a.lower, a.upper)
plot.dat.a$class <- row.names(plot.dat.a)
plot.dat.a$class <- factor(plot.dat.a$class, levels = c(paste0(c("Modern", "Past"))))


a.dots.2 <- ggplot(plot.dat.a, aes(x = a.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 2,height = 0)+geom_point()+theme_bw(base_size = 18)+xlim(-25.5, -22)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank(), panel.grid = element_blank())+ xlab(expression(paste("Baseline " ,delta^{13}, "C (\u2030)")))

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX/param_marginal_distn_bycohort_struct_v3_d13_random_slopes_cohort.png")
a.dots.2
dev.off()

# dot plot for MAP
b.mean <- apply(as.matrix(b[,1:2]), 2, mean)
b.lower <- apply(as.matrix(b[,1:2]), 2, function(x) quantile(x, probs = c(0.025)))
b.upper <- apply(as.matrix(b[,1:2]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b <- data.frame(b.mean, b.lower, b.upper)
plot.dat.b$class <- row.names(plot.dat.b)
plot.dat.b$class <- factor(plot.dat.b$class, levels = c(paste0(c("Past", "Modern"))))




b.dots.2 <- ggplot(plot.dat.b, aes(x = b.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b.lower, xmax = b.upper, size = 2,height = 0)+geom_point()+theme_bw(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank(), panel.grid = element_blank())+ xlab(expression(paste("Precip effect on " ,delta^{13}, "C (\u2030)")))+xlim(-1, 0.25)+geom_vline(xintercept = 0, linetype = "dashed")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_Precip_impact.png")
b.dots.2
dev.off()




# dot plot for Tmax
b2.mean <- apply(as.matrix(b2[,1:2]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:2]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:2]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)
plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c("Past",  "Modern"))




b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+theme_bw(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank(), panel.grid = element_blank())+xlab("d13C")+xlim(-0.7, 1)+ xlab(expression(paste("Tmax effect on " ,delta^{13}, "C (\u2030)")))+geom_vline(xintercept = 0, linetype = "dashed")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/param_marginal_distn_bycohort_v3_iwue_random_slopes_TMAX_impact.png")
b2.dots.2
dev.off()



# dot plot for DBH
b3.mean <- apply(as.matrix(b3[,1:2]), 2, mean)
b3.lower <- apply(as.matrix(b3[,1:2]), 2, function(x) quantile(x, probs = c(0.025)))
b3.upper <- apply(as.matrix(b3[,1:2]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b3 <- data.frame(b3.mean, b3.lower, b3.upper)
plot.dat.b3$class <- row.names(plot.dat.b3)
plot.dat.b3$class <- factor(plot.dat.b3$class, levels = c("Past",  "Modern"))



b3.dots.2 <- ggplot(plot.dat.b3, aes(x = b3.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b3.lower, xmax = b3.upper, size = 2,height = 0)+geom_point()+theme_bw(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank(), panel.grid = element_blank())+xlim(-0.7, 1)+ xlab(expression(paste("DBH effect on " ,delta^{13}, "C (\u2030)")))+geom_vline(xintercept = 0, linetype = "dashed")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_DBH_impact.png")
b3.dots.2
dev.off()

png(width = 4, height = 14, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/param_marginal_distn_bycohort_d13_all_dotplots.png")
plot_grid(a.dots.2,b.dots.2,b2.dots.2, b3.dots.2, ncol = 1,align = "hv", labels = "AUTO")
dev.off()

# ---------- make marginal plots of probed data -------------
# plot probed values of tree growth predictions:
Yprobe <- data.frame(d13p.samps)
colnames(Yprobe) <- 1:length(Yprobe)
probe.m <- melt(Yprobe)
 
colnames(probe.m) <- c("num", "d13pred")

d13probe$num <- 1:length(d13probe[,1])
#colnames(full.p) <- c("MA","SP06", "DBH","Log_lag_RWI_1", "struct.cohort", "num")

# summarize by structure + cohort class only:
d13probe$num <- as.factor(as.character(d13probe$num))
probtest <- dplyr::inner_join(probe.m, d13probe, by=c("num"))

prob <- probtest


struc.conversion <- unique(train.iso[, c("struct.cohort", "struct.cohort.code", "ageclass")])
 #struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")
struc.conversion$struct.cohort.probe <- as.integer(struc.conversion$struct.cohort.code)
 prob <- left_join(prob, struc.conversion, by  = "struct.cohort.probe")

 preds_ci <- prob %>% group_by( MAP.probe, T.probe, DBH.probe,  struct.cohort.probe) %>% dplyr::summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.025), Ci.high = quantile(d13pred, 0.975))


 # convert to unscaled data:
 prob$MAP <- round(unscale(prob$MAP.probe, MAP.scaled))
 prob$Tmax <- round(unscale(prob$T.probe, T.scaled))
 prob$DBH <- round(unscale(prob$DBH.probe, DBH.scaled))

 #--------------- plot marginal effects of climate and DBH on d13 ----------------

 

 
 # Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, ageclass) %>% summarise(meanY = mean(d13pred),                                                                           Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_MAP_marg <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)"))) +xlab("Total Annual Precipitation (mm)")+theme_bw()


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, ageclass) %>% summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_Tmax_marg <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)"))) +xlab("Max. Temp. (DegC)")+theme_bw()

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH,ageclass) %>% summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_DBH_marg <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)"))) + xlab("Tree DBH (cm)")+theme_bw()


png(height = 7, width = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/marginal_post_predictive_effects_ageclass.png")
legend <- get_legend(Y_MAP_marg)
plts <- plot_grid(Y_MAP_marg+theme(legend.position = "none"), Y_Tmax_marg+theme(legend.position = "none"), Y_DBH_marg+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()


# --------------plot marginal effects for each stand structure and cohort class:
# plot marginal effects of climate and previous years growth 
# Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, struct.cohort) %>% summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_MAP_marg_c <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = struct.cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_MAP, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = struct.cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)")))+xlab("Total Precipitation")


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, struct.cohort) %>% summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_Tmax_marg_c <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax,meanY, color = struct.cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = struct.cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)"))) +xlab("Max. Temperature (DegF)")

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH, struct.cohort) %>% summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_DBH_marg_c <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = struct.cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = struct.cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+  ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)")))+xlab("Tree DBH (cm)")

png(height = 7, width = 5, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/marginal_post_predictive_effects_ageclassXStruct.png")
legend <- get_legend(Y_MAP_marg_c)
plts <- plot_grid(Y_MAP_marg_c+theme(legend.position = "none"), Y_Tmax_marg_c+theme(legend.position = "none"), Y_DBH_marg_c+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.45))
dev.off()



#------------ plot d13 responses to cliamte conditional on DBH and other climate:
preds_ci_all <- prob %>% group_by(DBH, MAP, Tmax, struct.cohort.probe, cohort) %>% dplyr::summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

preds_ci_all_age <- prob %>% group_by(DBH, MAP, Tmax, ageclass) %>% dplyr::summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))



# --------filter select some DBH values and low and high temps by cohort and stucture class ----


prob_select <- preds_ci_all %>% dplyr::filter(DBH == 16 | DBH == 48 | DBH == 79 , Tmax == 72 | Tmax == 90  ) 


prob_select$DBH<- as.numeric(prob_select$DBH)
prob_select$Tmax<- as.numeric(prob_select$Tmax)


Drought.resp.DBH.temp.cohort <- ggplot(prob_select, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller = label_both)+ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)")))+xlab("Precipitation index")+theme_bw()


# output the above plots to PNG:
png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/MAP_response_high_temp_low_high_DBH_cohortXstruct.png")
Drought.resp.DBH.temp.cohort 
dev.off()

# --------filter select some DBH values and low and high temps by cohort/age class ----

prob_select <- preds_ci_all_age %>% dplyr::filter(DBH == 16 | DBH == 48 | DBH == 79 , Tmax == 72 | Tmax == 90  ) 


prob_select$DBH<- as.numeric(prob_select$DBH)
prob_select$Tmax<- as.numeric(prob_select$Tmax)


Drought.resp.DBH.temp.age <- ggplot(prob_select, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+scale_fill_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax), labeller=label_both)+ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)")))+xlab("Precipitation index")+theme_bw()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh/MAP_response_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.age
dev.off()
```


# now add an interaction effect to this model:
# intercept total precip and VPDmax, DBH  model for d13C:
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
d13_MAP_TMAX_dbh_inter_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model for iWUE:
d13[i]   ~ dnorm(d13func[i], inv.var) # where Yi is already log transformed

# function g()
d13func[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*MAP_scaled[i] + beta3[struct.cohort[i]]*TMAX_scaled[i] + beta4[struct.cohort[i]]*DBH_scaled[i] + beta5[struct.cohort[i]]*(TMAX_scaled[i]*MAP_scaled[i])

}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
beta5[s] ~ dnorm(mu_beta5, inv_beta5)
}



# use normal hyperpriors for each hyperparamters 

mu_beta1 ~ dnorm(0, 0.1)
mu_beta2 ~ dnorm(0, 0.1)
mu_beta3 ~ dnorm(0, 0.1)
mu_beta4 ~ dnorm(0, 0.1)
mu_beta5 ~ dnorm(0, 0.1)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)

inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)

inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)

inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)

inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)

# Non-informative Prior for the inverse population variances

inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


# Predict test data
for(i in 1:np){
# process model for iWUE:
d13.p[i]   ~ dnorm(d13func.p[i], inv.var) # where Yi is already log transformed

# function g()
d13func.p[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*MAP_scaled.p[i]+ beta3[struct.cohort.p[i]]*TMAX_scaled.p[i]+ beta4[struct.cohort.p[i]]*DBH_scaled.p[i]+beta5[struct.cohort.p[i]]*(TMAX_scaled.p[i]*MAP_scaled.p[i])

}


# Probe values
for(i in 1:nprobe){
# process model for iWUE:
d13.probe[i]   ~ dnorm(d13func.probe[i], inv.var) # where Yi is already log transformed

# function g()
d13func.probe[i] <- beta1[struct.cohort.probe[i]] + beta2[struct.cohort.probe[i]]*MAP_scaled.probe[i]+ beta3[struct.cohort.probe[i]]*TMAX_scaled.probe[i]+ beta4[struct.cohort.probe[i]]*DBH_scaled.probe[i]+beta5[struct.cohort.probe[i]]*(TMAX_scaled.probe[i]*MAP_scaled.probe[i])

}

}"


# create probe to generate posterior predictions:
MAP.probe <- seq(range(full.iso$MAP.scaled)[1], range(full.iso$MAP.scaled)[2], by = 1)
T.probe <- seq(range(full.iso$T.scaled)[1], range(full.iso$T.scaled)[2], by = 1)
DBH.probe <- seq(range(full.iso$DBH.scaled)[1], range(full.iso$T.scaled)[2], by = 1)

d13probe <- expand.grid(MAP.probe = MAP.probe, T.probe = T.probe, DBH.probe = DBH.probe, struct.cohort.probe = 1:4)

d13_map_tmax <- jags.model(textConnection(d13_MAP_TMAX_dbh_inter_re), 
                    data = list(d13 = train.iso[!train.iso$site %in% "BON",]$Cor.d13C.suess, n=length(train.iso[!train.iso$site %in% "BON",]$iWUE), struct.cohort = as.numeric(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), SF = unique(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), MAP_scaled = train.iso[!train.iso$site %in% "BON",]$MAP.scaled, TMAX_scaled = train.iso[!train.iso$site %in% "BON",]$T.scaled, DBH_scaled = train.iso[!train.iso$site %in% "BON",]$DBH.scaled, np = length(test.iso[!test.iso$site %in% "BON",]$site), struct.cohort.p = as.numeric(test.iso[!test.iso$site %in% "BON",]$struct.cohort.code), MAP_scaled.p = test.iso[!test.iso$site %in% "BON",]$MAP.scaled, TMAX_scaled.p = test.iso[!test.iso$site %in% "BON",]$T.scaled, DBH_scaled.p = test.iso[!test.iso$site %in% "BON",]$DBH.scaled, 
                                nprobe = length(d13probe$MAP.probe),
                                MAP_scaled.probe = d13probe$MAP.probe,
                                TMAX_scaled.probe = d13probe$T.probe, 
                                DBH_scaled.probe = d13probe$DBH.probe,
                                struct.cohort.probe = d13probe$struct.cohort.probe), n.chains = 3, n.adapt = 100)

update(d13_map_tmax, 1000); # Burnin for 1000 samples to start, then go higher later


d13_map_tmax.re <- coda.samples(d13_map_tmax, 
                     variable.names=c("beta1", "beta2","beta3","beta4","beta5","mu_beta1","mu_beta2","mu_beta3","mu_beta4","mu_beta5", "d13.p", "d13.probe"), 
                    n.chains = 3, n.iter = 20000, thin = 15)

summary( d13_map_tmax.re )
plot(d13_map_tmax.re )

gelman.diag(d13_map_tmax.re )
#acfplot(d13_map_tmax.re )

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- d13_map_tmax.re [[1]]
 saveRDS(samps, "outputs/growth_model/d13_MAP_TMAX_dbh_inter/samps.d13_nobon.rds")
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 #d13pred <- samps
 alpha.samps  <- samps[,1:4]
 beta.samps  <- samps[,5:8]
 beta2.samps  <- samps[,9:12]
 beta3.samps  <- samps[,13:16]
 beta4.samps <- samps[,17:20]
 d13.samps  <- samps[,21:(20+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]
 d13p.samps  <- samps[,(21+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess)):(20+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess)+length(d13probe$MAP.probe))]
 #d13p.samps  <- samps[,5:(4+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]


 #------------------ plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(d13.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(value),
                                                  ci.hi = quantile(value,0.975),
                                                 ci.lo = quantile(value,0.025))
Yp.summary$Observed <- test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess

pred.obs <- summary(lm(colMeans(Yp.samps)~ test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))

# this does a poor job representing d13 values by itself, but explains som of the variation
p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=-22, y=-26)

# note fairly poor model fit
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh_inter/pred_vs_obs.png")
p.o.plot
dev.off()

# ----------------- Plot intercepts/params ---------------------

png("outputs/growth_model/d13_MAP_TMAX_dbh_inter/marginal_alphas_v3_d13.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Savanna")
hist(alpha.samps[,2], main = "alpha Modern-Savanna")
hist(alpha.samps[,3],  main = "alpha Past-Forest")
hist(alpha.samps[,4],  main = "alpha Modern-Forest")

dev.off()


png("outputs/growth_model/d13_MAP_TMAX_dbh_inter/marginal_alphas_v3_d13.png")
par(mfrow=c(3,2))
hist(beta.samps[,1], main = "alpha Past-Savanna")
hist(beta.samps[,2], main = "alpha Modern-Savanna")
hist(beta.samps[,3],  main = "alpha Past-Forest")
hist(beta.samps[,4],  main = "alpha Modern-Forest")

dev.off()

# -----------plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c("Past-Forest", "Modern-Forest", "Past-Savanna", "Modern-Savanna")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("iWUE")


ggplot(a.m, aes(variable, value, fill = variable))+geom_boxplot(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("iWUE")

a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
a.mplots <-ggplot(a.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.5)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',

"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


# for MAP:
b <- data.frame(beta.samps)
colnames(b) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

b$num <- rownames(b)
b.m <- melt(b, id.vars=c("num"))
b.mplots <-ggplot(b.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated Precip Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))


# for Tmax:
b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <-ggplot(b2.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated Tmax Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))

# for DBH:
b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <-ggplot(b3.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated Tmax Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))

# calculate dot plots
a.mean <- apply(as.matrix(a[,1:4]), 2, mean)
a.lower <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
a.upper <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.a <- data.frame(a.mean, a.lower, a.upper)
plot.dat.a$class <- row.names(plot.dat.a)
plot.dat.a$class <- factor(plot.dat.a$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.a$ageclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.a$ageclass <- factor(plot.dat.a$ageclass, levels = c("Past", "Modern"))
plot.dat.a$forestclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


a.dots.2 <- ggplot(plot.dat.a, aes(x = a.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+xlim(-25.5, -22)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+facet_wrap(~forestclass)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX/param_marginal_distn_bycohort_struct_v3_d13_random_slopes.png")
a.dots.2
dev.off()

# dot plot for MAP
b.mean <- apply(as.matrix(b[,1:4]), 2, mean)
b.lower <- apply(as.matrix(b[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b.upper <- apply(as.matrix(b[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b <- data.frame(b.mean, b.lower, b.upper)
plot.dat.b$class <- row.names(plot.dat.b)
plot.dat.b$class <- factor(plot.dat.b$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.b$ageclass <- ifelse(plot.dat.b$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.b$ageclass <- factor(plot.dat.b$ageclass, levels = c("Past", "Modern"))
plot.dat.b$forestclass <- ifelse(plot.dat.b$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


b.dots.2 <- ggplot(plot.dat.b, aes(x = b.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b.lower, xmax = b.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+facet_wrap(~forestclass)+xlim(-0.25, 1)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh_inter/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_Precip_impact.png")
b.dots.2
dev.off()

# dot plot for Tmax
b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)
plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels = c("Past", "Modern"))
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+facet_wrap(~forestclass)+xlim(-0.7, 1)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh_inter/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_TMAX_impact.png")
b2.dots.2
dev.off()




# dot plot for DBH
b3.mean <- apply(as.matrix(b3[,1:2]), 2, mean)
b3.lower <- apply(as.matrix(b3[,1:2]), 2, function(x) quantile(x, probs = c(0.025)))
b3.upper <- apply(as.matrix(b3[,1:2]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b3 <- data.frame(b3.mean, b3.lower, b3.upper)
plot.dat.b3$class <- row.names(plot.dat.b3)
plot.dat.b3$class <- factor(plot.dat.b3$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))



plot.dat.b3$ageclass <- ifelse(plot.dat.b3$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.b3$ageclass <- factor(plot.dat.b3$ageclass, levels = c("Past", "Modern"))
plot.dat.b3$forestclass <- ifelse(plot.dat.b3$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


b3.dots.2 <- ggplot(plot.dat.b3, aes(x = b3.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b3.lower, xmax = b3.upper, size = 2,height = 0)+geom_point()+theme_bw(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("d13C")+xlim(-0.7, 1)+ ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)")))

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh_inter/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_DBH_impact.png")
b3.dots.2
dev.off()




# ---------- make marginal plots of probed data -------------
# plot probed values of tree growth predictions:
Yprobe <- data.frame(d13p.samps)
colnames(Yprobe) <- 1:length(Yprobe)
probe.m <- melt(Yprobe)
 
colnames(probe.m) <- c("num", "d13pred")

d13probe$num <- 1:length(d13probe[,1])
#colnames(full.p) <- c("MA","SP06", "DBH","Log_lag_RWI_1", "struct.cohort", "num")

# summarize by structure + cohort class only:
d13probe$num <- as.factor(as.character(d13probe$num))
probtest <- dplyr::inner_join(probe.m, d13probe, by=c("num"))

prob <- probtest


struc.conversion <- data.frame(struct.cohort.probe = 1:4, cohort = c(paste0(c(unique(train.iso$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

 prob <- left_join(prob, struc.conversion, by  = "struct.cohort.probe")

 preds_ci <- prob %>% group_by( MAP.probe, T.probe, DBH.probe,  struct.cohort.probe) %>% dplyr::summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.025), Ci.high = quantile(d13pred, 0.975))


 # convert to unscaled data:
 prob$MAP <- round(unscale(prob$MAP.probe, MAP.scaled))
 prob$Tmax <- round(unscale(prob$T.probe, T.scaled))
 prob$DBH <- round(unscale(prob$DBH.probe, DBH.scaled))

 #--------------- plot marginal effects of climate and DBH on d13 ----------------

 

 
 # Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, ageclass) %>% summarise(meanY = mean(d13pred),                                                                           Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_MAP_marg <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)"))) +xlab("Total Annual Precipitation (mm)")+theme_bw()


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax,ageclass) %>% summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_Tmax_marg <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)"))) +xlab("Max. Temp. (DegC)")+theme_bw()

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH,ageclass) %>% summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_DBH_marg <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)"))) + xlab("Tree DBH (cm)")+theme_bw()


png(height = 7, width = 4, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh_inter/marginal_post_predictive_effects_ageclass.png")
legend <- get_legend(Y_MAP_marg)
plts <- plot_grid(Y_MAP_marg+theme(legend.position = "none"), Y_Tmax_marg+theme(legend.position = "none"), Y_DBH_marg+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()


# --------------plot marginal effects for each stand structure and cohort class:
# plot marginal effects of climate and previous years growth 
# Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, cohort) %>% summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_MAP_marg_c <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_MAP, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)")))+xlab("Total Precipitation")


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, cohort) %>% summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_Tmax_marg_c <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)"))) +xlab("Max. Temperature (DegF)")

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH, cohort) %>% summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

Y_DBH_marg_c <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+  ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)")))+xlab("Tree DBH (cm)")

png(height = 7, width = 5, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh_inter/marginal_post_predictive_effects_ageclassXStruct.png")
legend <- get_legend(Y_MAP_marg_c)
plts <- plot_grid(Y_MAP_marg_c+theme(legend.position = "none"), Y_Tmax_marg_c+theme(legend.position = "none"), Y_DBH_marg_c+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.45))
dev.off()



#------------ plot d13 responses to cliamte conditional on DBH and other climate:
preds_ci_all <- prob %>% group_by(DBH, MAP, Tmax, struct.cohort.probe, cohort) %>% dplyr::summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))

preds_ci_all_age <- prob %>% group_by(DBH, MAP, Tmax, ageclass) %>% dplyr::summarise(meanY = mean(d13pred),
                                                                            Ci.low = quantile(d13pred, 0.05), Ci.high = quantile(d13pred, 0.95))



# --------filter select some DBH values and low and high temps by cohort and stucture class ----


prob_select <- preds_ci_all %>% dplyr::filter(DBH == 16 | DBH == 48 | DBH == 79 , Tmax == 72 | Tmax == 90  ) 


prob_select$DBH<- as.numeric(prob_select$DBH)
prob_select$Tmax<- as.numeric(prob_select$Tmax)


Drought.resp.DBH.temp.cohort <- ggplot(prob_select, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller = label_both)+ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)")))+xlab("Precipitation index")+theme_bw()


# output the above plots to PNG:
png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh_inter/MAP_response_high_temp_low_high_DBH_cohortXstruct.png")
Drought.resp.DBH.temp.cohort 
dev.off()

# --------filter select some DBH values and low and high temps by cohort/age class ----

prob_select <- preds_ci_all_age %>% dplyr::filter(DBH == 16 | DBH == 48 | DBH == 79 , Tmax == 72 | Tmax == 90  ) 


prob_select$DBH<- as.numeric(prob_select$DBH)
prob_select$Tmax<- as.numeric(prob_select$Tmax)


Drought.resp.DBH.temp.age <- ggplot(prob_select, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+scale_fill_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax), labeller=label_both)+ylab(expression(paste("Estimated " ,delta^{13}, "C (\u2030)")))+xlab("Precipitation index")+theme_bw()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/d13_MAP_TMAX_dbh_inter/MAP_response_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.age
dev.off()
```


# intercept only model (mean for iWUE):

```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
iWUE_intercept_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model for iWUE:
iWUE[i]   ~ dnorm(iwuefunc[i], inv.var) # where Yi is already log transformed

# function g()
iwuefunc[i] <- beta1[struct.cohort[i]]

}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
}



# use normal hyperpriors for each hyperparamters 

mu_beta1 ~ dnorm(0, 0.1)


inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)



# Non-informative Prior for the inverse population variances

inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


# Predict test data
for(i in 1:np){
# process model for iWUE:
iWUE.p[i]   ~ dnorm(iwuefunc.p[i], inv.var) # where Yi is already log transformed

# function g()
iwuefunc.p[i] <- beta1[struct.cohort.p[i]]

}


}"



iwue_mean <- jags.model(textConnection(iWUE_intercept_re), 
                    data = list(iWUE = train.iso[!train.iso$site %in% "BON",]$iWUE, n=length(train.iso[!train.iso$site %in% "BON",]$iWUE), struct.cohort = as.numeric(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), SF = unique(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), np = length(test.iso[!test.iso$site %in% "BON",]$site), struct.cohort.p = as.numeric(test.iso[!test.iso$site %in% "BON",]$struct.cohort.code)), n.chains = 3, n.adapt = 100)

update(iwue_mean, 1000); # Burnin for 1000 samples to start, then go higher later


iwue.mean.re <- coda.samples(iwue_mean, 
                     variable.names=c("beta1", "mu_beta1", "iWUE.p"), 
                    n.chains = 3, n.iter = 20000, thin = 15)

summary(iwue.mean.re )
plot(iwue.mean.re )

gelman.diag(iwue.mean.re )
acfplot(iwue.mean.re )

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- iwue.mean.re [[1]]
 saveRDS(samps, "outputs/growth_model/iWUE_intercept_mod/samps.d13_nobon.rds")
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 #d13pred <- samps
 alpha.samps  <- samps[,1:4]
alpha.samps  <- samps[,1:4]
iWUE.samps  <- samps[,5:(4+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]
 #d13p.samps  <- samps[,5:(4+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]


 #------------------ plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(iWUE.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(value),
                                                  ci.hi = quantile(value,0.975),
                                                 ci.lo = quantile(value,0.025))
Yp.summary$Observed <- test.iso[!test.iso$site %in% "BON",]$iWUE

pred.obs <- summary(lm(colMeans(Yp.samps)~ test.iso[!test.iso$site %in% "BON",]$iWUE))

# this does a poor job representing d13 values by itself, but explains som of the variation
p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note better model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/iWUE_intercept_mod/pred_vs_obs.png")
p.o.plot
dev.off()

# ----------------- Plot intercepts/params ---------------------

png("outputs/growth_model/iWUE_intercept_mod/marginal_alphas_v3_iWUE.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Savanna")
hist(alpha.samps[,2], main = "alpha Modern-Savanna")
hist(alpha.samps[,3],  main = "alpha Past-Forest")
hist(alpha.samps[,4],  main = "alpha Modern-Forest")

dev.off()


# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c("Past-Forest", "Modern-Forest", "Past-Savanna", "Modern-Savanna")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("iWUE")


ggplot(a.m, aes(variable, value, fill = variable))+geom_boxplot(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("iWUE")

a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c(unique(full.iso$struct.cohort)[order(unique(full.iso$struct.cohort.code))])))

a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
a.mplots <-ggplot(a.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.5)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))

a.mean <- apply(as.matrix(a[,1:4]), 2, mean)
a.lower <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
a.upper <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.a <- data.frame(a.mean, a.lower, a.upper)
plot.dat.a$class <- row.names(plot.dat.a)
plot.dat.a$class <- factor(plot.dat.a$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))

a.dots <- ggplot(plot.dat.a, aes(x = a.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 2,height = 0)+geom_point()+xlim(100, 160)+theme_black(base_size = 16)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+coord_flip()+theme(legend.position = "none")+xlab("Estimated iWUE")

png(height = 5, width = 12, units = "in",res = 300,"outputs/growth_model/iWUE_intercept_mod/iwue_alpha_marginal_distn_bycohort.png")
plot_grid(a.dots, a.mplots+coord_flip()+ xlim(100, 160)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()), rel_widths = c(1,0.75))
dev.off()

library(cowplot)
png(width = 7, height = 3, units = "in", res = 300, "outputs/growth_model/iWUE_intercept_mod/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes.png")
plot_grid(alpha.mplots, ncol = 1)
dev.off()


plot.dat.a$ageclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.a$ageclass <- factor(plot.dat.a$ageclass, levels = c("Past", "Modern"))
plot.dat.a$forestclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


a.dots.2 <- ggplot(plot.dat.a, aes(x = a.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 2,height = 0)+geom_point()+xlim(100, 160)+theme_bw()+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("iWUE")+facet_wrap(~forestclass)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/iWUE_intercept_mod/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes.png")
a.dots.2
dev.off()


```



# intercept and VPDmax models for mean iWUE:

```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
iWUE_VPD_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model for iWUE:
iWUE[i]   ~ dnorm(iwuefunc[i], inv.var) # where Yi is already log transformed

# function g()
iwuefunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*VPD_scaled[i]

}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
}



# use normal hyperpriors for each hyperparamters 

mu_beta1 ~ dnorm(0, 0.1)
mu_beta2 ~ dnorm(0, 0.1)


inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)

inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)



# Non-informative Prior for the inverse population variances

inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


# Predict test data
for(i in 1:np){
# process model for iWUE:
iWUE.p[i]   ~ dnorm(iwuefunc.p[i], inv.var) # where Yi is already log transformed

# function g()
iwuefunc.p[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*VPD_scaled.p[i]

}


}"



iwue_vpd <- jags.model(textConnection(iWUE_VPD_re), 
                    data = list(iWUE = train.iso[!train.iso$site %in% "BON",]$iWUE, n=length(train.iso[!train.iso$site %in% "BON",]$iWUE), struct.cohort = as.numeric(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), SF = unique(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), VPD_scaled = train.iso[!train.iso$site %in% "BON",]$jja.VPDmax.scaled, np = length(test.iso[!test.iso$site %in% "BON",]$site), struct.cohort.p = as.numeric(test.iso[!test.iso$site %in% "BON",]$struct.cohort.code), VPD_scaled.p = test.iso[!test.iso$site %in% "BON",]$jja.VPDmax.scaled), n.chains = 3, n.adapt = 100)

update(iwue_vpd, 1000); # Burnin for 1000 samples to start, then go higher later


iwue.mean.re <- coda.samples(iwue_vpd, 
                     variable.names=c("beta1", "beta2","mu_beta1","mu_beta2", "iWUE.p"), 
                    n.chains = 3, n.iter = 20000, thin = 15)

summary(iwue.mean.re )
plot(iwue.mean.re )

gelman.diag(iwue.mean.re )
acfplot(iwue.mean.re )

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- iwue.mean.re [[1]]
 saveRDS(samps, "outputs/growth_model/iWUE_VPD/samps.d13_nobon.rds")
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 #d13pred <- samps
 alpha.samps  <- samps[,1:4]
 beta.samps  <- samps[,5:8]
 iWUE.samps  <- samps[,9:(8+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]
 #d13p.samps  <- samps[,5:(4+length(test.iso[!test.iso$site %in% "BON",]$Cor.d13C.suess))]


 #------------------ plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(iWUE.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(value),
                                                  ci.hi = quantile(value,0.975),
                                                 ci.lo = quantile(value,0.025))
Yp.summary$Observed <- test.iso[!test.iso$site %in% "BON",]$iWUE

pred.obs <- summary(lm(colMeans(Yp.samps)~ test.iso[!test.iso$site %in% "BON",]$iWUE))

# this does a poor job representing d13 values by itself, but explains som of the variation
p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=1, y=7)

# note better model fit!
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/iWUE_VPD/pred_vs_obs.png")
p.o.plot
dev.off()

# ----------------- Plot intercepts/params ---------------------

png("outputs/growth_model/iWUE_VPD/marginal_alphas_v3_iWUE.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Savanna")
hist(alpha.samps[,2], main = "alpha Modern-Savanna")
hist(alpha.samps[,3],  main = "alpha Past-Forest")
hist(alpha.samps[,4],  main = "alpha Modern-Forest")

dev.off()


png("outputs/growth_model/iWUE_VPD/marginal_alphas_v3_iWUE.png")
par(mfrow=c(3,2))
hist(beta.samps[,1], main = "alpha Past-Savanna")
hist(alpha.samps[,2], main = "alpha Modern-Savanna")
hist(alpha.samps[,3],  main = "alpha Past-Forest")
hist(alpha.samps[,4],  main = "alpha Modern-Forest")

dev.off()
# -----------plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c("Past-Forest", "Modern-Forest", "Past-Savanna", "Modern-Savanna")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("iWUE")


ggplot(a.m, aes(variable, value, fill = variable))+geom_boxplot(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("iWUE")

a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
a.mplots <-ggplot(a.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.5)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',

"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


# for VPD:
b <- data.frame(beta.samps)
colnames(b) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

b$num <- rownames(b)
b.m <- melt(b, id.vars=c("num"))
b.mplots <-ggplot(b.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated VPDmax Sensitivity")+theme_black(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))



# calculate dot plots
a.mean <- apply(as.matrix(a[,1:4]), 2, mean)
a.lower <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
a.upper <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.a <- data.frame(a.mean, a.lower, a.upper)
plot.dat.a$class <- row.names(plot.dat.a)
plot.dat.a$class <- factor(plot.dat.a$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.a$ageclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.a$ageclass <- factor(plot.dat.a$ageclass, levels = c("Past", "Modern"))
plot.dat.a$forestclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


a.dots.2 <- ggplot(plot.dat.a, aes(x = a.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 2,height = 0)+geom_point()+xlim(100, 160)+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='blue',
"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("iWUE")+facet_wrap(~forestclass)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/iWUE_intercept_mod/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes.png")
a.dots.2
dev.off()


b.mean <- apply(as.matrix(b[,1:4]), 2, mean)
b.lower <- apply(as.matrix(b[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b.upper <- apply(as.matrix(b[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b <- data.frame(b.mean, b.lower, b.upper)
plot.dat.b$class <- row.names(plot.dat.b)
plot.dat.b$class <- factor(plot.dat.b$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.b$ageclass <- ifelse(plot.dat.b$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.b$ageclass <- factor(plot.dat.b$ageclass, levels = c("Past", "Modern"))
plot.dat.b$forestclass <- ifelse(plot.dat.b$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


b.dots.2 <- ggplot(plot.dat.b, aes(x = b.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b.lower, xmax = b.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("iWUE")+facet_wrap(~forestclass)+xlim(-7.1, 1.4)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/iWUE_intercept_mod/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_VPD_impact.png")
b.dots.2
dev.off()

```




# MAP, TMAX, and dbh model for iWUE:
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
iWUE_MAP_tmax_dbh_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model for iWUE:
iWUE[i]   ~ dnorm(iWUEfunc[i], inv.var) # where Yi is already log transformed

# function g()
iWUEfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*MAP_scaled[i] + beta3[struct.cohort[i]]*TMAX_scaled[i] + beta4[struct.cohort[i]]*DBH_scaled[i]

}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
}



# use normal hyperpriors for each hyperparamters 

mu_beta1 ~ dnorm(0, 0.1)
mu_beta2 ~ dnorm(0, 0.1)
mu_beta3 ~ dnorm(0, 0.1)
mu_beta4 ~ dnorm(0, 0.1)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)

inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)

inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)

inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)

# Non-informative Prior for the inverse population variances

inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


# Predict test data
for(i in 1:np){
# process model for iWUE:
iWUE.p[i]   ~ dnorm(iWUEfunc.p[i], inv.var) # where Yi is already log transformed

# function g()
iWUEfunc.p[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*MAP_scaled.p[i]+ beta3[struct.cohort.p[i]]*TMAX_scaled.p[i]+ beta4[struct.cohort.p[i]]*DBH_scaled.p[i]

}


# Probe values
for(i in 1:nprobe){
# process model for iWUE:
iWUE.probe[i]   ~ dnorm(iWUEfunc.probe[i], inv.var) # where Yi is already log transformed

# function g()
iWUEfunc.probe[i] <- beta1[struct.cohort.probe[i]] + beta2[struct.cohort.probe[i]]*MAP_scaled.probe[i]+ beta3[struct.cohort.probe[i]]*TMAX_scaled.probe[i]+ beta4[struct.cohort.probe[i]]*DBH_scaled.probe[i]

}

}"


# create probe to generate posterior predictions:
MAP.probe <- seq(range(full.iso$MAP.scaled)[1], range(full.iso$MAP.scaled)[2], by = 1)
T.probe <- seq(range(full.iso$T.scaled)[1], range(full.iso$T.scaled)[2], by = 1)
DBH.probe <- seq(range(full.iso$DBH.scaled)[1], range(full.iso$T.scaled)[2], by = 1)

iWUEprobe <- expand.grid(MAP.probe = MAP.probe, T.probe = T.probe, DBH.probe = DBH.probe, struct.cohort.probe = 1:4)

iWUE_map_tmax <- jags.model(textConnection(iWUE_MAP_tmax_dbh_re), 
                    data = list(iWUE = train.iso[!train.iso$site %in% "BON",]$iWUE, n=length(train.iso[!train.iso$site %in% "BON",]$iWUE), struct.cohort = as.numeric(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), SF = unique(train.iso[!train.iso$site %in% "BON",]$struct.cohort.code), MAP_scaled = train.iso[!train.iso$site %in% "BON",]$MAP.scaled, TMAX_scaled = train.iso[!train.iso$site %in% "BON",]$T.scaled, DBH_scaled = train.iso[!train.iso$site %in% "BON",]$DBH.scaled, np = length(test.iso[!test.iso$site %in% "BON",]$site), struct.cohort.p = as.numeric(test.iso[!test.iso$site %in% "BON",]$struct.cohort.code), MAP_scaled.p = test.iso[!test.iso$site %in% "BON",]$MAP.scaled, TMAX_scaled.p = test.iso[!test.iso$site %in% "BON",]$T.scaled, DBH_scaled.p = test.iso[!test.iso$site %in% "BON",]$DBH.scaled, 
                                nprobe = length(iWUEprobe$MAP.probe),
                                MAP_scaled.probe = iWUEprobe$MAP.probe,
                                TMAX_scaled.probe = iWUEprobe$T.probe, 
                                DBH_scaled.probe = iWUEprobe$DBH.probe,
                                struct.cohort.probe = iWUEprobe$struct.cohort.probe), n.chains = 3, n.adapt = 100)

update(iWUE_map_tmax, 1000); # Burnin for 1000 samples to start, then go higher later


iWUE_map_tmax.re <- coda.samples(iWUE_map_tmax, 
                     variable.names=c("beta1", "beta2","beta3","beta4","mu_beta1","mu_beta2","mu_beta3","mu_beta4", "iWUE.p", "iWUE.probe"), 
                    n.chains = 3, n.iter = 20000, thin = 15)

#summary( iWUE_map_tmax.re )
#plot(iWUE.meaniWUE_map_tmax.re )

#gelman.diag(iWUE_map_tmax.re )
#acfplot(iWUE_map_tmax.re )

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- iWUE_map_tmax.re [[1]]
 saveRDS(samps, "outputs/growth_model/iWUE_MAP_TMAX_dbh/samps.iWUE_nobon.rds")
 saveRDS(train.iso, "outputs/growth_model/iWUE_MAP_TMAX_dbh/train.iso.rds")
  saveRDS(test.iso, "outputs/growth_model/iWUE_MAP_TMAX_dbh/test.iso.rds")
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 #iWUEpred <- samps
 alpha.samps  <- samps[,1:4]
 beta.samps  <- samps[,5:8]
 beta2.samps  <- samps[,9:12]
 beta3.samps  <- samps[,13:16]
 
 # save all paramter estimates:
 
 params <- samps[,1:16]
  saveRDS(params, "outputs/growth_model/iWUE_MAP_TMAX_dbh/params.rds")
 iWUE.samps  <- samps[,17:(16+length(test.iso[!test.iso$site %in% "BON",]$iWUE))]
 iWUEp.samps  <- samps[,(17+length(test.iso[!test.iso$site %in% "BON",]$iWUE)):(16+length(test.iso[!test.iso$site %in% "BON",]$iWUE)+length(iWUEprobe$MAP.probe))]
 #iWUEp.samps  <- samps[,5:(4+length(test.iso[!test.iso$site %in% "BON",]$iWUE))]

 
 # get differences between past and modern:
hdi( (( alpha.samps[,2]-alpha.samps[,1] )/alpha.samps[,2])*100)
hdi( (( alpha.samps[,4]-alpha.samps[,3] )/alpha.samps[,2])*100)
 
saveRDS(alpha.samps, "outputs/growth_model/iWUE_MAP_TMAX_dbh/alpha_intercept_samps.rds")

 #------------------ plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(iWUE.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(value),
                                                  ci.hi = quantile(value,0.975),
                                                 ci.lo = quantile(value,0.025))
Yp.summary$Observed <- test.iso[!test.iso$site %in% "BON",]$iWUE

pred.obs <- summary(lm(colMeans(Yp.samps)~ test.iso[!test.iso$site %in% "BON",]$iWUE))

# this does a poor job representing iWUE values by itself, but explains som of the variation
p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=120, y=175)

# note fairly poor model fit
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/pred_vs_obs.png")
p.o.plot
dev.off()

# ----------------- Plot average predicted difference in iWUE between ageclasses--------------------
Yp.samps <- data.frame(iWUE.samps) 
Yp.m <- melt(Yp.samps)

obs.wue <- test.iso[!test.iso$site %in% "BON",]
obs.wue$num <- 1:length(Yp.samps)
obs.wue$variable <- paste0("iWUE.p.", obs.wue$num, ".")

obs.preds <- left_join(obs.wue, Yp.m, by = "variable")
WUE.age <- obs.preds %>% group_by(ageclass) %>% summarise(mean = mean(value, na.rm = TRUE), 
                                               Ci.low = quantile(value,0.025, na.rm = TRUE),
                                               Ci.high = quantile(value,0.975, na.rm = TRUE), 
                                               hdi.low = hdi(value, na.rm = TRUE)[1],
                                               hdi.high = hdi(value,na.rm = TRUE)[2])


# save obs.wue for use later:

saveRDS(obs.wue, "outputs/growth_model/iWUE_MAP_TMAX_dbh/WUE_preds.rds")

# ----------------- Plot intercepts/params ---------------------

png("outputs/growth_model/iWUE_MAP_TMAX_dbh/marginal_alphas_v3_iWUE.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Savanna")
hist(alpha.samps[,2], main = "alpha Modern-Savanna")
hist(alpha.samps[,3],  main = "alpha Past-Forest")
hist(alpha.samps[,4],  main = "alpha Modern-Forest")

dev.off()


png("outputs/growth_model/iWUE_MAP_TMAX_dbh/marginal_alphas_v3_iWUE.png")
par(mfrow=c(3,2))
hist(beta.samps[,1], main = "alpha Past-Savanna")
hist(beta.samps[,2], main = "alpha Modern-Savanna")
hist(beta.samps[,3],  main = "alpha Past-Forest")
hist(beta.samps[,4],  main = "alpha Modern-Forest")

dev.off()

# -----------plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c("Past-Forest", "Modern-Forest", "Past-Savanna", "Modern-Savanna")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("iWUE")


ggplot(a.m, aes(variable, value, fill = variable))+geom_boxplot(alpha = 0.5)+theme_black()+ylab("frequency")+xlab("iWUE")

a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
a.mplots <-ggplot(a.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.5)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_bw(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',

"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))


# for MAP:
b <- data.frame(beta.samps)
colnames(b) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

b$num <- rownames(b)
b.m <- melt(b, id.vars=c("num"))
b.mplots <-ggplot(b.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated Precip Sensitivity")+theme_bw(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))


# for Tmax:
b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <-ggplot(b2.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated Tmax Sensitivity")+theme_bw(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))

# for DBH:
b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0(c(unique(train$struct.cohort)[order(unique(train$struct.cohort.code))])))

b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <-ggplot(b3.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated Tmax Sensitivity")+theme_bw(base_size = 16)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))

# calculate dot plots
a.mean <- apply(as.matrix(a[,1:4]), 2, mean)
a.lower <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
a.upper <- apply(as.matrix(a[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.a <- data.frame(a.mean, a.lower, a.upper)
plot.dat.a$class <- row.names(plot.dat.a)
plot.dat.a$class <- factor(plot.dat.a$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.a$ageclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.a$ageclass <- factor(plot.dat.a$ageclass, levels = c("Past", "Modern"))
plot.dat.a$forestclass <- ifelse(plot.dat.a$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


a.dots.2 <- ggplot(plot.dat.a, aes(x = a.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("iWUE")+facet_wrap(~forestclass)+xlim(100, 160)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/param_marginal_distn_bycohort_struct_v3_iWUE_random_slopes.png")
a.dots.2
dev.off()

# dot plot for MAP
b.mean <- apply(as.matrix(b[,1:4]), 2, mean)
b.lower <- apply(as.matrix(b[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b.upper <- apply(as.matrix(b[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b <- data.frame(b.mean, b.lower, b.upper)
plot.dat.b$class <- row.names(plot.dat.b)
plot.dat.b$class <- factor(plot.dat.b$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.b$ageclass <- ifelse(plot.dat.b$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.b$ageclass <- factor(plot.dat.b$ageclass, levels = c("Past", "Modern"))
plot.dat.b$forestclass <- ifelse(plot.dat.b$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


b.dots.2 <- ggplot(plot.dat.b, aes(x = b.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b.lower, xmax = b.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("effect on iWUE")+facet_wrap(~forestclass)+xlim(-0.25, 10)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_Precip_impact.png")
b.dots.2
dev.off()

# dot plot for Tmax
b2.mean <- apply(as.matrix(b2[,1:4]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- row.names(plot.dat.b2)
plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))




plot.dat.b2$ageclass <- ifelse(plot.dat.b2$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.b2$ageclass <- factor(plot.dat.b2$ageclass, levels = c("Past", "Modern"))
plot.dat.b2$forestclass <- ifelse(plot.dat.b2$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


b2.dots.2 <- ggplot(plot.dat.b2, aes(x = b2.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("effect on iWUE")+facet_wrap(~forestclass)+xlim(-7, 4)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_TMAX_impact.png")
b2.dots.2
dev.off()




# dot plot for DBH
b3.mean <- apply(as.matrix(b3[,1:4]), 2, mean)
b3.lower <- apply(as.matrix(b3[,1:4]), 2, function(x) quantile(x, probs = c(0.025)))
b3.upper <- apply(as.matrix(b3[,1:4]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b3 <- data.frame(b3.mean, b3.lower, b3.upper)
plot.dat.b3$class <- row.names(plot.dat.b3)
plot.dat.b3$class <- factor(plot.dat.b3$class, levels = c("Past-Forest", "Past-Savanna", "Modern-Forest", "Modern-Savanna"))



plot.dat.b3$ageclass <- ifelse(plot.dat.b3$class %in% c("Past-Savanna", "Past-Forest"), "Past", "Modern")
plot.dat.b3$ageclass <- factor(plot.dat.b3$ageclass, levels = c("Past", "Modern"))
plot.dat.b3$forestclass <- ifelse(plot.dat.b3$class %in% c("Past-Savanna", "Modern-Savanna"), "Savanna", "Forest")


b3.dots.2 <- ggplot(plot.dat.b3, aes(x = b3.mean, y = ageclass, color = ageclass, size = 2))+geom_errorbarh( xmin = b3.lower, xmax = b3.upper, size = 2,height = 0)+geom_point()+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank())+xlab("effect on iWUE")+facet_wrap(~forestclass)+xlim(-2,15)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_DBH_impact.png")
b3.dots.2
dev.off()




# ---------- make marginal plots of probed data -------------
# plot probed values of tree growth predictions:



Yprobe <- data.frame(iWUEp.samps)
colnames(Yprobe) <- 1:length(Yprobe)
probe.m <- melt(Yprobe)
 
colnames(probe.m) <- c("num", "iWUEpred")

iWUEprobe$num <- 1:length(iWUEprobe[,1])
#colnames(full.p) <- c("MA","SP06", "DBH","Log_lag_RWI_1", "struct.cohort", "num")

# summarize by structure + cohort class only:
iWUEprobe$num <- as.factor(as.character(iWUEprobe$num))
probtest <- dplyr::inner_join(probe.m, iWUEprobe, by=c("num"))

prob <- probtest


struc.conversion <- data.frame(struct.cohort.probe = 1:4, cohort = c(paste0(c(unique(train.iso$struct.cohort)))))
 struc.conversion$ageclass <- ifelse(struc.conversion$cohort %in% c("Past-Forest", "Past-Savanna"), "Past", "Modern")

 prob <- left_join(prob, struc.conversion, by  = "struct.cohort.probe")

 preds_ci <- prob %>% group_by( MAP.probe, T.probe, DBH.probe,  struct.cohort.probe) %>% dplyr::summarise(meanY = mean(iWUEpred),
                                                                            Ci.low = quantile(iWUEpred, 0.025), Ci.high = quantile(iWUEpred, 0.975))


 # convert to unscaled data:
 prob$MAP <- round(unscale(prob$MAP.probe, MAP.scaled))
 prob$Tmax <- round(unscale(prob$T.probe, T.scaled))
 prob$DBH <- round(unscale(prob$DBH.probe, DBH.scaled))

 #--------------- plot marginal effects of climate and DBH on iWUE ----------------

 

 
 # Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, ageclass) %>% summarise(meanY = mean(iWUEpred),                                                                           Ci.low = quantile(iWUEpred, 0.05), Ci.high = quantile(iWUEpred, 0.95))

Y_MAP_marg <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = ageclass)) + geom_line()+#geom_smooth(data = preds_ci_mod_past_MAP, aes(x = MAP, y = meanY, se = FALSE)) + 
  geom_ribbon(data = preds_ci_mod_past_MAP,aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+ scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("iWUE") +xlab("Total Annual Precipitation (mm)")+theme_bw()


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax,ageclass) %>% summarise(meanY = mean(iWUEpred),
                                                                            Ci.low = quantile(iWUEpred, 0.05), Ci.high = quantile(iWUEpred, 0.95))

Y_Tmax_marg <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) +  ylab("iWUE") +xlab("Max. Temp. (DegF)")+theme_bw()

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH,ageclass) %>% summarise(meanY = mean(iWUEpred),
                                                                            Ci.low = quantile(iWUEpred, 0.05), Ci.high = quantile(iWUEpred, 0.95))

Y_DBH_marg <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = ageclass))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, colour = NA)+scale_color_manual (values = c("Modern" = "red", "Past" = "blue")) + ylab("iWUE") + xlab("Tree DBH (cm)")+theme_bw()


png(height = 7, width = 4, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/marginal_post_predictive_effects_ageclass.png")
legend <- get_legend(Y_MAP_marg)
plts <- plot_grid(Y_MAP_marg+theme(legend.position = "none"), Y_Tmax_marg+theme(legend.position = "none"), Y_DBH_marg+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.35))
dev.off()


# --------------plot marginal effects for each stand structure and cohort class:
# plot marginal effects of climate and previous years growth 
# Marginal MAP effect:
preds_ci_mod_past_MAP <- prob %>% group_by( MAP, cohort) %>% summarise(meanY = mean(iWUEpred),
                                                                            Ci.low = quantile(iWUEpred, 0.05), Ci.high = quantile(iWUEpred, 0.95))

Y_MAP_marg_c <- ggplot(preds_ci_mod_past_MAP, aes(MAP,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_MAP, aes(x = MAP, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ylab("iWUE")+xlab("Total Precipitation")


# marginal TMAX effect
preds_ci_mod_past_Tmax <- prob %>% group_by( Tmax, cohort) %>% summarise(meanY = mean(iWUEpred),
                                                                            Ci.low = quantile(iWUEpred, 0.05), Ci.high = quantile(iWUEpred, 0.95))

Y_Tmax_marg_c <- ggplot(preds_ci_mod_past_Tmax, aes(Tmax,meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_Tmax, aes(x = Tmax, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ ylab("iWUE")+xlab("Max. Temperature (DegF)")

# marginal DBH effect
preds_ci_mod_past_DBH <- prob %>% group_by( DBH, cohort) %>% summarise(meanY = mean(iWUEpred),
                                                                            Ci.low = quantile(iWUEpred, 0.05), Ci.high = quantile(iWUEpred, 0.95))

Y_DBH_marg_c <- ggplot(preds_ci_mod_past_DBH, aes(DBH, meanY, color = cohort))+geom_line()+geom_ribbon(data = preds_ci_mod_past_DBH, aes(x = DBH, ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, colour = NA)+scale_color_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571')) +scale_fill_manual(values = c("Past-Savanna"='#a6611a',
"Modern-Savanna"='#dfc27d',
"Modern-Forest"='#c7eae5',
"Past-Forest"='#018571'))+ylab("iWUE")+xlab("Tree DBH (cm)")

png(height = 7, width = 5, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/marginal_post_predictive_effects_ageclassXStruct.png")
legend <- get_legend(Y_MAP_marg_c)
plts <- plot_grid(Y_MAP_marg_c+theme(legend.position = "none"), Y_Tmax_marg_c+theme(legend.position = "none"), Y_DBH_marg_c+theme(legend.position = "none"), align = "v", ncol = 1)
plot_grid(plts, legend, ncol = 2, rel_widths = c(1, 0.45))
dev.off()



#------------ plot iWUE responses to cliamte conditional on DBH and other climate:
preds_ci_all <- prob %>% group_by(DBH, MAP, Tmax, struct.cohort.probe, cohort) %>% dplyr::summarise(meanY = mean(iWUEpred),
                                                                            Ci.low = quantile(iWUEpred, 0.05), Ci.high = quantile(iWUEpred, 0.95))

preds_ci_all_age <- prob %>% group_by(DBH, MAP, Tmax, ageclass) %>% dplyr::summarise(meanY = mean(iWUEpred),
                                                                            Ci.low = quantile(iWUEpred, 0.05), Ci.high = quantile(iWUEpred, 0.95))



# --------filter select some DBH values and low and high temps by cohort and stucture class ----


prob_select <- preds_ci_all %>% dplyr::filter(DBH == 16 | DBH == 48 | DBH == 79 , Tmax == 72 | Tmax == 90  ) 


prob_select$DBH<- as.numeric(prob_select$DBH)
prob_select$Tmax<- as.numeric(prob_select$Tmax)


Drought.resp.DBH.temp.cohort <- ggplot(prob_select, aes(MAP, meanY, color = cohort))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = cohort), alpha = 0.25, linetype = "dashed", colour = NA)+scale_fill_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+scale_color_manual(values = c("Past-Savanna"='#a6611a',"Modern-Savanna"='#dfc27d',"Modern-Forest"='#c7eae5',"Past-Forest"='#018571'))+facet_grid(vars(DBH), vars(Tmax),labeller = label_both)+ylab("iWUE")+xlab("Precipitation index")+theme_bw()


# output the above plots to PNG:
png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/MAP_response_high_temp_low_high_DBH_cohortXstruct.png")
Drought.resp.DBH.temp.cohort 
dev.off()

# --------filter select some DBH values and low and high temps by cohort/age class ----

prob_select <- preds_ci_all_age %>% dplyr::filter(DBH == 16 | DBH == 48 | DBH == 79 , Tmax == 72 | Tmax == 90  ) 


prob_select$DBH<- as.numeric(prob_select$DBH)
prob_select$Tmax<- as.numeric(prob_select$Tmax)


Drought.resp.DBH.temp.age <- ggplot(prob_select, aes(MAP, meanY, color = ageclass))+geom_line()+geom_ribbon(aes(ymin = Ci.low, ymax = Ci.high, fill = ageclass), alpha = 0.25, linetype = "dashed", colour = NA)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+scale_fill_manual(values = c("Past"='blue',"Modern"='red'))+facet_grid(vars(DBH), vars(Tmax), labeller=label_both)+ylab("iWUE")+xlab("Precipitation index")+theme_bw()

png(height = 10, width = 8, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/MAP_response_high_temp_low_high_DBH_ageclass.png")
Drought.resp.DBH.temp.age
dev.off()
```


# MAP, TMAX, and dbh model for iWUE, but by ageclass:
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
iWUE_MAP_tmax_dbh_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model for iWUE:
iWUE[i]   ~ dnorm(iWUEfunc[i], inv.var) # where Yi is already log transformed

# function g()
iWUEfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*MAP_scaled[i] + beta3[struct.cohort[i]]*TMAX_scaled[i] + beta4[struct.cohort[i]]*DBH_scaled[i]

}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
}



# use normal hyperpriors for each hyperparamters 

mu_beta1 ~ dnorm(0, 0.1)
mu_beta2 ~ dnorm(0, 0.1)
mu_beta3 ~ dnorm(0, 0.1)
mu_beta4 ~ dnorm(0, 0.1)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)

inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)

inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)

inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)

# Non-informative Prior for the inverse population variances

inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)


# Predict test data
for(i in 1:np){
# process model for iWUE:
iWUE.p[i]   ~ dnorm(iWUEfunc.p[i], inv.var) # where Yi is already log transformed

# function g()
iWUEfunc.p[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*MAP_scaled.p[i]+ beta3[struct.cohort.p[i]]*TMAX_scaled.p[i]+ beta4[struct.cohort.p[i]]*DBH_scaled.p[i]

}


# Probe values
for(i in 1:nprobe){
# process model for iWUE:
iWUE.probe[i]   ~ dnorm(iWUEfunc.probe[i], inv.var) # where Yi is already log transformed

# function g()
iWUEfunc.probe[i] <- beta1[struct.cohort.probe[i]] + beta2[struct.cohort.probe[i]]*MAP_scaled.probe[i]+ beta3[struct.cohort.probe[i]]*TMAX_scaled.probe[i]+ beta4[struct.cohort.probe[i]]*DBH_scaled.probe[i]

}

}"


# create probe to generate posterior predictions:
MAP.probe <- seq(range(full.iso$MAP.scaled)[1], range(full.iso$MAP.scaled)[2], by = 1)
T.probe <- seq(range(full.iso$T.scaled)[1], range(full.iso$T.scaled)[2], by = 1)
DBH.probe <- seq(range(full.iso$DBH.scaled)[1], range(full.iso$T.scaled)[2], by = 1)

iWUEprobe <- expand.grid(MAP.probe = MAP.probe, T.probe = T.probe, DBH.probe = DBH.probe, age.probe = 1:2)

if(!"age.code" %in% colnames(train.iso)){
  train.iso$age.code <- ifelse(train.iso$ageclass %in% "Modern", 1, 2)
  test.iso$age.code <- ifelse(test.iso$ageclass %in% "Modern", 1, 2)
}


iWUE_map_tmax <- jags.model(textConnection(iWUE_MAP_tmax_dbh_re), 
                    data = list(iWUE = train.iso[!train.iso$site %in% "BON",]$iWUE, n=length(train.iso[!train.iso$site %in% "BON",]$iWUE), 
                                struct.cohort = as.numeric(train.iso[!train.iso$site %in% "BON",]$age.code), 
                                SF = unique(train.iso[!train.iso$site %in% "BON",]$age.code),
                                MAP_scaled = train.iso[!train.iso$site %in% "BON",]$MAP.scaled, TMAX_scaled = train.iso[!train.iso$site %in% "BON",]$T.scaled, 
                                DBH_scaled = train.iso[!train.iso$site %in% "BON",]$DBH.scaled, 
                                np = length(test.iso[!test.iso$site %in% "BON",]$site), 
                                struct.cohort.p = as.numeric(test.iso[!test.iso$site %in% "BON",]$age.code), 
                                MAP_scaled.p = test.iso[!test.iso$site %in% "BON",]$MAP.scaled, TMAX_scaled.p = test.iso[!test.iso$site %in% "BON",]$T.scaled, 
                                DBH_scaled.p = test.iso[!test.iso$site %in% "BON",]$DBH.scaled, 
                                nprobe = length(iWUEprobe$MAP.probe),
                                MAP_scaled.probe = iWUEprobe$MAP.probe,
                                TMAX_scaled.probe = iWUEprobe$T.probe, 
                                DBH_scaled.probe = iWUEprobe$DBH.probe,
                                struct.cohort.probe = iWUEprobe$age.probe), n.chains = 3, n.adapt = 100)

update(iWUE_map_tmax, 1000); # Burnin for 1000 samples to start, then go higher later


iWUE_map_tmax.re <- coda.samples(iWUE_map_tmax, 
                     variable.names=c("beta1", "beta2","beta3","beta4","mu_beta1","mu_beta2","mu_beta3","mu_beta4", "iWUE.p", "iWUE.probe"), 
                    n.chains = 3, n.iter = 20000, thin = 15)

#summary( iWUE_map_tmax.re )
#plot(iWUE.meaniWUE_map_tmax.re )

#gelman.diag(iWUE_map_tmax.re )
#acfplot(iWUE_map_tmax.re )

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- iWUE_map_tmax.re [[1]]
 saveRDS(samps, "outputs/growth_model/iWUE_MAP_TMAX_dbh_cohort/samps.iWUE_nobon.rds")
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 #iWUEpred <- samps
 alpha.samps  <- samps[,1:2]
 beta.samps  <- samps[,3:4]
 beta2.samps  <- samps[,5:6]
 beta3.samps  <- samps[,7:8]
 params <- samps[,1:8]
 saveRDS(params, "outputs/growth_model/iWUE_MAP_TMAX_dbh_cohort/params.iWUE_nobon_ageclass.rds")
 iWUE.samps  <- samps[,9:(8+length(test.iso[!test.iso$site %in% "BON",]$iWUE))]
 #iWUEp.samps  <- samps[,(17+length(test.iso[!test.iso$site %in% "BON",]$iWUE)):(16+length(test.iso[!test.iso$site %in% "BON",]$iWUE)+length(iWUEprobe$MAP.probe))]
 #iWUEp.samps  <- samps[,5:(4+length(test.iso[!test.iso$site %in% "BON",]$iWUE))]

 
 # get differences between past and modern:
hdi( (( alpha.samps[,1]-alpha.samps[,2] )/alpha.samps[,2])*100)
alpha.diff <- ((alpha.samps[,1]-alpha.samps[,2] )/alpha.samps[,2])*100

wue.pct.diff <- data.frame(
  pct.change = mean(alpha.diff),
  Ci.low = quantile(alpha.diff, 0.025), 
  Ci.high = quantile(alpha.diff, 0.975), 
  median = median(alpha.diff), 
  hdi.low = hdi(alpha.diff)[1], 
  hdi.high = hdi(alpha.diff)[2])





saveRDS(alpha.samps, "outputs/growth_model/iWUE_MAP_TMAX_dbh_cohort/alpha_intercept_samps.rds")

 #------------------ plot predicted vs observed and assess model fit:
Yp.samps <- data.frame(iWUE.samps) 
Yp.m <- melt(Yp.samps)
Yp.summary <- Yp.m %>% group_by(variable) %>% dplyr::summarise(Predicted = mean(value),
                                                  ci.hi = quantile(value,0.975),
                                                 ci.lo = quantile(value,0.025))
Yp.summary$Observed <- test.iso[!test.iso$site %in% "BON",]$iWUE

pred.obs <- summary(lm(colMeans(Yp.samps)~ test.iso[!test.iso$site %in% "BON",]$iWUE))

# this does a poor job representing iWUE values by itself, but explains som of the variation
p.o.plot <- ggplot(Yp.summary, aes(Observed, Predicted))+geom_point(color = "black", size = 0.5)+geom_errorbar(data = Yp.summary,aes(ymin=ci.lo, ymax=ci.hi), color = "grey", alpha = 0.5)+geom_point(data = Yp.summary, aes(Observed, Predicted), color = "black", size = 0.5)+geom_abline(aes(slope = 1, intercept = 0), color = "red", linetype = "dashed")+geom_text(data=data.frame(pred.obs$r.squared), aes( label = paste("R^2: ", pred.obs$r.squared, sep="")),parse=T,x=120, y=175)

# note fairly poor model fit
png(width = 6, height = 5, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/pred_vs_obs.png")
p.o.plot
dev.off()

# ----------------- Plot average predicted difference in iWUE between ageclasses--------------------
Yp.samps <- data.frame(iWUE.samps) 
Yp.m <- melt(Yp.samps)

obs.wue <- test.iso[!test.iso$site %in% "BON",]
obs.wue$num <- 1:length(Yp.samps)
obs.wue$variable <- paste0("iWUE.p.", obs.wue$num, ".")

obs.preds <- left_join(obs.wue, Yp.m, by = "variable")
WUE.age <- obs.preds %>% group_by(ageclass) %>% summarise(mean = mean(value, na.rm = TRUE), 
                                               Ci.low = quantile(value,0.025, na.rm = TRUE),
                                               Ci.high = quantile(value,0.975, na.rm = TRUE), 
                                               hdi.low = hdi(value, na.rm = TRUE)[1],
                                               hdi.high = hdi(value,na.rm = TRUE)[2])


# save obs.wue for use later:

saveRDS(obs.wue, "outputs/growth_model/iWUE_MAP_TMAX_dbh/WUE_preds.rds")


# -----------plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c("Modern", "Past")))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+ylab("frequency")+xlab("iWUE")


ggplot(a.m, aes(variable, value, fill = variable))+geom_boxplot(alpha = 0.5)+theme_bw()+ylab("frequency")+xlab("d13C")

a <- data.frame(alpha.samps)
colnames(a) <- c(paste0(c("Modern", "Past")))




# for MAP:
b <- data.frame(beta.samps)
colnames(b) <- c(paste0(c("Modern", "Past")))

b$num <- rownames(b)
b.m <- melt(b, id.vars=c("num"))
b.mplots <-ggplot(b.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated Precip Sensitivity")+theme_bw(base_size = 16)+scale_fill_manual(values = c("Past"='blue',"Modern"='red'))


# for Tmax:
b2 <- data.frame(beta2.samps)
colnames(b2) <-c(paste0(c("Modern", "Past")))

b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <-ggplot(b2.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated Tmax Sensitivity")+theme_bw(base_size = 16)

# for DBH:
b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0(c("Modern", "Past")))

b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <-ggplot(b3.m, aes(value, 1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE)+theme_bw()+xlab("Estimated DBH Sensitivity")+theme_bw(base_size = 16)+scale_fill_manual(values = c("Past"='blue',"Modern"='red'))

# calculate dot plots
a.mean <- apply(as.matrix(a[,1:2]), 2, mean)
a.lower <- apply(as.matrix(a[,1:2]), 2, function(x) quantile(x, probs = c(0.025)))
a.upper <- apply(as.matrix(a[,1:2]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.a <- data.frame(a.mean, a.lower, a.upper)
plot.dat.a$class <- row.names(plot.dat.a)
plot.dat.a$class <- factor(plot.dat.a$class, levels = c(paste0(c( "Past", "Modern"))))


a.dots.2.wue <- ggplot(plot.dat.a, aes(x = a.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 2,height = 0)+geom_point()+theme_bw(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+xlim(115, 165)+theme(legend.position = "none", axis.title.x = element_blank(), panel.grid = element_blank())+ xlab(expression(paste("Baseline iWUE")))

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_cohort.png")
a.dots.2.wue
dev.off()

# dot plot for MAP
b.mean <- apply(as.matrix(b[,1:2]), 2, mean)
b.lower <- apply(as.matrix(b[,1:2]), 2, function(x) quantile(x, probs = c(0.025)))
b.upper <- apply(as.matrix(b[,1:2]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b <- data.frame(b.mean, b.lower, b.upper)
plot.dat.b$class <- row.names(plot.dat.b)
plot.dat.b$class <- factor(plot.dat.b$class, levels = c(paste0(c("Past", "Modern"))))




b.dots.2.wue <- ggplot(plot.dat.b, aes(x = b.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b.lower, xmax = b.upper, size = 2,height = 0)+geom_point()+theme_bw(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank(), panel.grid = element_blank())+ xlab("Precip effect on iWUE")+geom_vline(xintercept = 0, linetype = "dashed")+xlim(-5,5)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_Precip_impact.png")
b.dots.2.wue
dev.off()




# dot plot for Tmax
b2.mean <- apply(as.matrix(b2[,1:2]), 2, mean)
b2.lower <- apply(as.matrix(b2[,1:2]), 2, function(x) quantile(x, probs = c(0.025)))
b2.upper <- apply(as.matrix(b2[,1:2]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b2 <- data.frame(b2.mean, b2.lower, b2.upper)
plot.dat.b2$class <- c("Modern", "Past")
plot.dat.b2$class <- factor(plot.dat.b2$class, levels = c("Past",  "Modern"))




b2.dots.2.wue <- ggplot(plot.dat.b2, aes(x = b2.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b2.lower, xmax = b2.upper, size = 2,height = 0)+geom_point()+theme_bw(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank(), panel.grid = element_blank())+ xlab(expression(paste("Tmax effect on iWUE")))+geom_vline(xintercept = 0, linetype = "dashed")+xlim( -7.5, 2.7)

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/param_marginal_distn_bycohort_v3_iwue_random_slopes_TMAX_impact.png")
b2.dots.2.wue
dev.off()



# dot plot for DBH
b3.mean <- apply(as.matrix(b3[,1:2]), 2, mean)
b3.lower <- apply(as.matrix(b3[,1:2]), 2, function(x) quantile(x, probs = c(0.025)))
b3.upper <- apply(as.matrix(b3[,1:2]), 2, function(x) quantile(x, probs = c(0.975)))

## Combine both estimates
plot.dat.b3 <- data.frame(b3.mean, b3.lower, b3.upper)
plot.dat.b3$class <- row.names(plot.dat.b3)
plot.dat.b3$class <- factor(plot.dat.b3$class, levels = c("Past",  "Modern"))



b3.dots.2.wue <- ggplot(plot.dat.b3, aes(x = b3.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = b3.lower, xmax = b3.upper, size = 2,height = 0)+geom_point()+theme_bw(base_size = 18)+scale_color_manual(values = c("Past"='blue',"Modern"='red'))+coord_flip()+theme(legend.position = "none", axis.title.x = element_blank(), panel.grid = element_blank())+xlim(-0.5, 18)+ xlab(expression(paste("DBH effect on iWUE")))+geom_vline(xintercept = 0, linetype = "dashed")

png(width = 5, height = 4, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes_DBH_impact.png")
b3.dots.2.wue
dev.off()

png(width = 4, height = 14, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/param_marginal_distn_bycohort_d13_all_dotplots_wue.png")
plot_grid(a.dots.2.wue, b.dots.2.wue, b2.dots.2.wue, b3.dots.2.wue, ncol = 1,align = "hv", labels = "AUTO")
dev.off()



png(width = 8, height = 14, units = "in", res = 300, "outputs/growth_model/iWUE_MAP_TMAX_dbh/param_marginal_distn_bycohort_d13_all_dotplots_wue_d13.png")
plot_grid(a.dots.2.wue, a.dots.2,
          b.dots.2.wue, b.dots.2,
          b2.dots.2.wue, b2.dots.2,
          b3.dots.2.wue, b3.dots.2, ncol = 2,align = "hv", labels = "AUTO")
dev.off()

```




# more complicated iWUE models::

# adding a prediction for stable isotopes (d13C) from tree growth predictions
```{r}
# this model is specified in basically the same as the site level model, but we replace site with "cohort"
d13_model_structure_x_cohort_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){
# process model for growth:
Y[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed

# function g()
gfunc[i] <- beta1 + beta2[struct.cohort[i]]*DI.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i]+ beta4[struct.cohort[i]]*jul.VPDmax[i] + beta5[struct.cohort[i]]*iWUE[i] # use Drought index as a scaled variable 

# if there is d13 data, then use Y[i] to predict
#if(d13index[i]){
 # process model for d13C:
 #Y[i]   ~ dnorm(d13func[i], inv.var13) # where Yi is already log transformed
 #d13func[i] <- beta1 + beta2[struct.cohort[i]]*DI.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i] #+ beta4[struct.cohort[i]]*RWI[i] + beta5[struct.cohort[i]]*jul.VPDmax[i]
#}


#res[i] <- Y[i] - gfunc[i]   
#emp.new[i] ~ dnorm(gfunc[i], sigma)
#res.new[i] <- emp.new[i] - gfunc[i]
}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
#beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
# if we assume WUE is known for each group:
#mu_beta2[s] <- gamma1 * exp(-v*iWUE[s])
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
beta5[s] ~ dnorm(mu_beta5, inv_beta5)
}


#gamma1 ~ dgamma(0.001, 0.001)
#v ~ dgamma(0.001, 0.001)

# model for stable isotopes:
#for(d in 1:n.d13){

  # process model for growth:
 # Y.d13[d]   ~ dnorm(gfuncd13[d], inv.var) # Model Yi using estimated parameter distributions 

  # function g()
  #gfuncd13[d] <- beta1[struct.cohort.d13[d]] + beta2[struct.cohort.d13[d]]*DI.scaled.d13[d] +         #  beta3[struct.cohort.d13[d]]*DBH.scaled.d13[d]   # use Drought index as a scaled variable 

 # process model for d13C:
 #d13[d]   ~ dnorm(d13func[d], inv.var13) # where Yi is already log transformed
 #d13func[d] <- beta.d131 + beta.d132*Y[d]

#}



# use normal hyperpriors for each hyperparamters 
beta1 ~ dnorm(0, 0.01)
#mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)
mu_beta4 ~ dunif(-2, 2)
mu_beta5 ~ dunif(-2, 2)
#beta.d131 ~ dnorm(0, 2)
#beta.d132 ~ dnorm(0,2)

#inv_beta1   ~ dgamma(0.01, 0.01)
#sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)

#inv.var13 ~ dgamma(0.01, 0.01)
#sigma_13 <- 1/sqrt(inv.var13)


# Non-informative Prior for the inverse population variances

#alpha_ref ~ dnorm(0,0.1)
inv.var   ~ dgamma(0.001, 0.001)
sigma     <- 1/sqrt(inv.var)






}"


# read in the d13 data:


d13 <- read.csv("outputs/stable_isotopes/merged_d13_growth.csv")
d13 <- d13[!is.na(d13$DBH),]
Y.d13 <- log(d13$RWI)
Y.iwue <- d13$iWUE
#DI <- as.vector( full.ghcn$JJA.pdsi )
ageclass.d13 <- as.numeric( d13$ageclass)
Age.d13 <- as.numeric( d13$Age)
n.d13     <- length(d13$RWI)
DBH.d13 <- d13$DBH
d13$DBH.scaled = as.vector(scale(d13$DBH, center = TRUE, scale = TRUE))
d13$DI.scaled = as.vector(scale(d13$JJA.pdsi, center = TRUE, scale = TRUE))
site.d13 <- d13$site
SpecCode.d13 <- d13$SpecCode
plot.d13 <- unique(d13$site)
#need to define site level structures:
structure <- data.frame(site = c("AVO","BON","COR",  "ENG",  "GLA",  "GLL1", "GLL2", "GLL3","GLL4", "HIC",  "MOU",  "PLE",  "PVC",  "STC",  "TOW", "UNC" ),
                        structure = c("Forest", "Savanna", "Forest", "Forest", "Savanna", "Forest", "Savanna", "Savanna", "Forest", "Savanna", "Forest","Savanna", "Savanna", "Savanna", "Forest", "Savanna"))



#full.ghcn <- merge(full.ghcn, structure, by = "site")

full.ghcn$struct.cohort <- paste0(full.ghcn$ageclass,"-", full.ghcn$structure)
full.ghcn$struct.cohort.code <- ifelse(full.ghcn$struct.cohort %in% "Past-Forest", 1,
       ifelse(full.ghcn$struct.cohort %in% "Modern-Forest", 2, 
               ifelse(full.ghcn$struct.cohort %in% "Past-Savanna", 3,
                     ifelse(full.ghcn$struct.cohort %in% "Modern-Savanna", 4,"NA" ))))

full.ghcn <- merge(full.ghcn, d13[,c("site", "ID", "year","Cor.d13C.suess", "iWUE")], by = c("site", "ID", "year"), all.x = TRUE)
# read in VPD data and merge with full data:
full.prism <- read.csv("outputs/data/full_det_prism_rwi.csv")
full.ghcn <- merge(full.ghcn, full.prism[,c("year", "site", "ID", "VPDmax", "jja.VPDmax", "BAL", "jul.BAL", "jul.VPDmax")], by = c("year", "site", "ID"))
full.ghcn$jul.VPDmax.scaled <- as.numeric(scale(full.ghcn$jul.VPDmax))
full.ghcn$iWUE.scaled <- as.numeric(scale(full.ghcn$iWUE))
d13index <- !is.na(full.ghcn$Cor.d13C.suess)
# generate fake data to predict on:
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  struct.cohort= 1:4)
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:





 Xp <- full.probe
 np <- length(Xp$Var1)
n = length(full.ghcn$Cor.d13C.suess)


# split into testing and training:
library(caTools)
full.iso <- full.ghcn[!is.na(full.ghcn$iWUE),]
#full.iso <- full.ghcn
iWUE.med<- full.iso %>% group_by(struct.cohort, struct.cohort.code) %>% summarise(iWUEmean = median(iWUE, na.rm =TRUE))
msk <- sample.split( full.iso, SplitRatio = 3/4, group = NULL )

train <- full.iso[msk,]
test <- full.iso[!msk,]

d13.model.by_structure_x_cohort <- jags.model(textConnection(d13_model_structure_x_cohort_re), 
                    data = list(Y = full.iso$RWI, n=length(full.iso$RWI), DI.scaled = full.iso$DI.scaled, DBH.scaled = full.iso$DBH.scaled, jul.VPDmax = full.iso$jul.VPDmax.scaled, iWUE = full.iso$iWUE.scaled, struct.cohort = as.numeric(train$struct.cohort.code), SF = unique(full.iso$struct.cohort.code)), n.chains = 3, n.adapt = 100)

update(d13.model.by_structure_x_cohort, 1000); # Burnin for 1000 samples to start, then go higher later


d13.structure.cohort.re <- coda.samples(d13.model.by_structure_x_cohort, 
                     variable.names=c("beta1", "beta2","beta3", "beta4", "beta5","sigma_beta2","sigma_beta3", "sigma_beta4","sigma_beta5"), 
                    n.chains = 3, n.iter = 200000, thin = 15)

summary(d13.structure.cohort.re)
plot(d13.structure.cohort.re)

gelman.diag(d13.structure.cohort.re)
acfplot(d13.structure.cohort.re)

#Extract the samples for each parameter for a basic exploration of effects

 samps       <- d13.structure.cohort.re[[1]]
 saveRDS(samps, "outputs/growth_model/d13_reg_struct_x_cohort/samps.wue.rds")
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 #d13pred <- samps
 alpha.samps  <- samps[,1]
 beta2.samps <- samps[,2:5]
 beta3.samps <- samps[,6:9]
 beta4.samps <- samps[,10:13]
 beta5.samps <- samps[,14:17]
 sigma.samps <- samps[,16]
 #sigma13.samps <- samps[,15]
 sigma_betas <- samps[,17:21]
 d13pred <- samps[,18:8228]
 #betad131.samps <- samps[,1]
 #betad132.samps <- samps[,2]

# plot marginal distributions of each parameter:
png("outputs/growth_model/d13_reg_struct_x_cohort/marginal_d13_sigmas_v3_iWUE.png")
par(mfrow=c(2,2))
#hist(betad131.samps, main = "alpha d13")
#hist(betad132.samps, main = "beta d13")
hist(sigma.samps, main = "sigma")
dev.off()

png("outputs/growth_model/d13_reg_struct_x_cohort/marginal_alphas_v3_iWUE.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Savanna")
hist(alpha.samps[,2], main = "alpha Modern-Savanna")
hist(alpha.samps[,3],  main = "alpha Past-Forest")
hist(alpha.samps[,4],  main = "alpha Modern-Forest")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/d13_reg_struct_x_cohort/marginal_beta1s_v3_IWUE.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta2 Past-Savanna")
hist(beta3.samps[,2], main = "beta2 Modern-Savanna")
hist(beta4.samps[,3],  main = "beta2 Past-Forest")
hist(beta2.samps[,4],  main = "beta2 Modern-Forest")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/d13_reg_struct_x_cohort/marginal_beta2s_v3_iwue.png")
par(mfrow=c(3,2))
hist(beta3.samps[,1], main = "beta3 Past-Savanna")
hist(beta3.samps[,2], main = "beta3 Modern-Savanna")
hist(beta3.samps[,3],  main = "beta3 Past-Forest")
hist(beta3.samps[,4],  main = "beta3 Modern-Forest")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0("alpha-",c(unique(full.ghcn$struct.cohort))))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0("beta2-",c(unique(full.ghcn$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()


b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0("beta3-",c(unique(full.ghcn$struct.cohort))))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(paste0("beta3-",c(unique(full.ghcn$struct.cohort))))
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()

b5 <- data.frame(beta5.samps)
colnames(b5) <- c(paste0("beta5-",c(unique(full.ghcn$struct.cohort))))
b5$num <- rownames(b5)
b5.m <- melt(b5, id.vars=c("num"))
b5.mplots <- ggplot(b5.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()



library(cowplot)
png(width = 4, height = 8, units = "in", res = 300, "outputs/growth_model/d13_reg_struct_x_cohort/param_marginal_distn_bycohort_struct_v3_iwue_random_slopes.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots, b4.mplots, b5.mplots, ncol = 1)
dev.off()


#predict the 
# Compute the posterior mean for the plug-in predictions  

 beta1.mn  <- colMeans(beta1.samps)
 beta2.mn  <- colMeans(beta2.samps)
 sigma.mn <- mean(sigma.samps)
 alpha1.mn <- colMeans(alpha.samps) 
beta131.mn <- mean(betad131.samps) 
beta132.mn <- mean(betad132.samps) 


# Plot the plug-in Posterior predictive denisty using "fake data"
# want to plaot posteror predictive distributions:
 
# can probe either within the JAGS model or in R after the model runs:
 # specify "x probe" values for DBH + DI:
 #xprobe <- matrix(rep(-2.102618, 3.321394))
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  struct.cohort= 1:4)
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:





 Xp <- full.probe
 np <- length(Xp$Var1)
 ypred <- list()

 d13pred <- list()
 for(j in 1:np){

   # PPD
   #plot(density(Yp.samps[,j]),xlab="Y",main="PPD")

   
   mu <- alpha1.mn[Xp[j,3]] + beta1.mn[Xp[j,3]]*Xp[j,1] + beta2.mn[Xp[j,3]]*Xp[j,2]   # use
   
   ypred[[j]]  <- rnorm(np, mu, sigma.mn)

   # make a prediction of d13 based on MU:
   
   
   
   d13func <- beta131.mn + beta132.mn*ypred[[j]]   # use
   d13pred[[j]]  <- d13func
   # Truth
   #abline(v=Y[j],col=3,lwd=2)

   #legend("topright",c("PPD","Plug-in","Truth"),col=1:3,lty=1,inset=0.05)
}

ypred.df <- do.call(rbind, ypred)
d13pred.df <- do.call(rbind, d13pred)
#ypred.yp.df <- do.call(rbind, ypred.yp)
png("outputs/growth_model/d13_reg_struct_x_cohort/predicted_y_d13.png")
par(mfrow = c(1,2))
plot(density(ypred.df), main = "Ypred, line = Ydata")
abline(v = mean(Y), col = "red")

plot(density(d13pred.df), main = "d13pred, line = d13data")
abline(v= mean(d13$Cor.d13C.suess), col = "red")
dev.off()

# need to calculate pvalues

pval113.d <- mean(d13pred.df > d13$Cor.d13C.suess) 


Xp$MeanY <- exp(rowMeans(ypred.df))
Xp$Meand13<- rowMeans(d13pred.df)# get the means of the posterior to plot the overall effects of 
Xp$struct.cohort <- ifelse(Xp$struct.cohort == 1, "Past-Forest",  
                       ifelse(Xp$struct.cohort == 2, "Modern-Forest",
                               ifelse(Xp$struct.cohort == 3, "Past-Savanna", 
                                       ifelse(Xp$struct.cohort == 4, "Modern-Savanna", NA))))
#DBH + DI on predicted growth

# Todo: unscale Drought and DBH indices

#png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_drought_struct_x_cohort.png")
ggplot(Xp, aes(Var1,MeanY, color = as.factor(struct.cohort)))+geom_point()+xlab("Drought Index")+ylab("predicted growth")
#dev.off()

#png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var2,MeanY,color = as.factor(struct.cohort)))+geom_point()+xlab("DBH Index")+ylab("predicted growth")
#dev.off()

#png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_drought_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~as.factor(struct.cohort))
#dev.off()






#png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_drought_struct_x_cohort.png")
ggplot(Xp, aes(Var1,Meand13, color = as.factor(struct.cohort)))+geom_point()+xlab("Drought Index")+ylab("predicted growth")+stat_smooth(method = "lm")
#dev.off()

#png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var2, Meand13, color = as.factor(struct.cohort)))+geom_point()+xlab("DBH Index")+ylab("predicted d13")+stat_smooth(method = "lm")
#dev.off()

#png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_drought_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = Meand13))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~as.factor(struct.cohort))
#dev.off()



```

```{r}
d13only_model_structure_x_cohort_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){

 d13[i]   ~ dnorm(d13func[i], inv.var13) # where Yi is already log transformed
 d13func[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i] + beta4[struct.cohort[i]]*VPD.max.scaled[i]

}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)
}




# use normal hyperpriors for each hyperparamters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)
mu_beta4 ~ dunif(-2, 2)
mu_beta5 ~ dunif(-2, 2)
beta.d131 ~ dnorm(0, 2)
beta.d132 ~ dnorm(0,2)

inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)

# Non-informative Prior for the inverse population variances
inv.var13 ~ dgamma(0.01, 0.01)
sigma_13 <- 1/sqrt(inv.var13)


# Prediction using testing data
for(i in 1:np){

 d13.p[i]   ~ dnorm(d13func.p[i], inv.var13) # where Yi is already log transformed
 d13func.p[i] <- beta1[struct.cohort.p[i]] + beta2[struct.cohort.p[i]]*DI.scaled.p[i] + beta3[struct.cohort.p[i]]*DBH.scaled.p[i] + beta4[struct.cohort.p[i]]*VPD.max.scaled.p[i]

}

}"


# read in the d13 data:


d13 <- read.csv("outputs/stable_isotopes/merged_d13_growth.csv")
d13 <- d13[!is.na(d13$DBH),]
Y.d13 <- log(d13$RWI)
#DI <- as.vector( full.ghcn$JJA.pdsi )
ageclass.d13 <- as.numeric( d13$ageclass)
Age.d13 <- as.numeric( d13$Age)
n.d13     <- length(d13$RWI)
DBH.d13 <- d13$DBH
d13$DBH.scaled = as.vector(scale(d13$DBH, center = TRUE, scale = TRUE))
d13$DI.scaled = as.vector(scale(d13$JJA.pdsi, center = TRUE, scale = TRUE))
site.d13 <- d13$site
SpecCode.d13 <- d13$SpecCode
plot.d13 <- unique(d13$site)
#need to define site level structures:
structure <- data.frame(site = c("AVO","BON","COR",  "ENG",  "GLA",  "GLL1", "GLL2", "GLL3","GLL4", "HIC",  "MOU",  "PLE",  "PVC",  "STC",  "TOW", "UNC" ),
                        structure = c("Forest", "Savanna", "Forest", "Forest", "Savanna", "Forest", "Savanna", "Savanna", "Forest", "Savanna", "Forest","Savanna", "Savanna", "Savanna", "Forest", "Savanna"))



#full.ghcn <- merge(full.ghcn, structure, by = "site")

full.ghcn$struct.cohort <- paste0(full.ghcn$ageclass,"-", full.ghcn$structure)
full.ghcn$struct.cohort.code <- ifelse(full.ghcn$struct.cohort %in% "Past-Forest", 1,
       ifelse(full.ghcn$struct.cohort %in% "Modern-Forest", 2, 
               ifelse(full.ghcn$struct.cohort %in% "Past-Savanna", 3,
                     ifelse(full.ghcn$struct.cohort %in% "Modern-Savanna", 4,"NA" ))))

full.ghcn <- merge(full.ghcn, d13[,c("site", "ID", "year","Cor.d13C.suess", "iWUE")], by = c("site", "ID", "year"), all.x = TRUE)

d13index <- !is.na(full.ghcn$Cor.d13C.suess)
# generate fake data to predict on:
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  struct.cohort= 1:4)
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:





 Xp <- full.probe
 np <- length(Xp$Var1)


d13.model.only.by_structure_x_cohort <- jags.model(textConnection(d13only_model_structure_x_cohort_re), 
                    data = list( n=length(train$DI.scaled), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled, struct.cohort = as.numeric(train$struct.cohort.code), SF = unique(train$struct.cohort.code), d13 = train$iWUE, VPD.max.scaled= train$jul.VPDmax.scaled, np=length(test$DI.scaled), DI.scaled.p = test$DI.scaled, DBH.scaled.p = test$DBH.scaled, struct.cohort.p = as.numeric(test$struct.cohort.code),  VPD.max.scaled.p= test$jul.VPDmax.scaled), n.chains = 3, n.adapt = 100)

update(d13.model.only.by_structure_x_cohort, 1000); # Burnin for 1000 samples to start, then go higher later


d13.model.only.by_structure_x_cohort <- coda.samples(d13.model.only.by_structure_x_cohort, 
                     variable.names=c("beta1", "beta2","beta3","beta4", "sigma_beta1", "sigma_beta2","sigma_beta3", "sigma_beta4", "d13.p"), 
                    n.chains = 3, n.iter = 20000, thin = 10)

summary(d13.model.only.by_structure_x_cohort)
plot(d13.model.only.by_structure_x_cohort)

gelman.diag(d13.model.only.by_structure_x_cohort)
acfplot(d13.model.only.by_structure_x_cohort)

#Extract the samples for each parameter for a basic exploration of effects

samps       <- d13.model.only.by_structure_x_cohort[[1]]
saveRDS(samps,"outputs/growth_model/wue_reg_struct_x_cohort/samps.rds")
plot(d13.model.only.by_structure_x_cohort)

 
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 alpha.samps  <- samps[,1:4]
 beta2.samps <- samps[,5:8]
 beta3.samps <- samps[,9:12]
 beta4.samps <- samps[,13:16]
 iWUEpred.samps <- samps[,17:2801]
 #sigma13.samps <- samps[,15]
 #sigma_betas <- samps[,16:18]

 #betad131.samps <- samps[,1]
 #betad132.samps <- samps[,2]


png("outputs/growth_model/wue_reg_struct_x_cohort/marginal_alphas_v3.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Savanna")
hist(alpha.samps[,2], main = "alpha Modern-Savanna")
hist(alpha.samps[,3],  main = "alpha Past-Forest")
hist(alpha.samps[,4],  main = "alpha Modern-Forest")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/wue_reg_struct_x_cohort/marginal_beta1s_v3.png")
par(mfrow=c(3,2))
hist(beta1.samps[,1], main = "beta2 Past-Savanna")
hist(beta1.samps[,2], main = "beta2 Modern-Savanna")
hist(beta1.samps[,3],  main = "beta2 Past-Forest")
hist(beta1.samps[,4],  main = "beta2 Modern-Forest")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/wue_reg_struct_x_cohort/marginal_beta2s_v3.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta3 Past-Savanna")
hist(beta2.samps[,2], main = "beta3 Modern-Savanna")
hist(beta2.samps[,3],  main = "beta3 Past-Forest")
hist(beta2.samps[,4],  main = "beta3 Modern-Forest")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0("alpha-",c(unique(train$struct.cohort))))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()++xlab("Intercepts for iWUE")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0("beta2-",c(unique(train$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("effect of Summer Drought")


b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0("beta3-",c(unique(train$struct.cohort))))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("effect of Tree DBH")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(paste0("beta4-",c(unique(train$struct.cohort))))
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("effect of July VPD")


library(cowplot)
png(width = 4, height = 8, units = "in", res = 300, "outputs/growth_model/wue_reg_struct_x_cohort/param_marginal_distn_bycohort_struct_v3.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, ncol = 1)
dev.off()


# Compute the posterior mean for the plug-in predictions  

 beta1.mn  <- colMeans(beta1.samps)
 beta2.mn  <- colMeans(beta2.samps)
 sigma.mn <- mean(sigma.samps)
 alpha1.mn <- colMeans(alpha.samps) 
beta131.mn <- mean(betad131.samps) 
beta132.mn <- mean(betad132.samps) 


# Plot the plug-in Posterior predictive denisty using "fake data"
# want to plaot posteror predictive distributions:
 
# can probe either within the JAGS model or in R after the model runs:
 # specify "x probe" values for DBH + DI:
 #xprobe <- matrix(rep(-2.102618, 3.321394))
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 VPDprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,VPDprobe,  struct.cohort= 1:4)
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:





 Xp <- full.probe
 np <- length(Xp$Var1)
 ypred <- list()

 d13pred <- list()
 for(j in 1:np){

   # PPD
   #plot(density(Yp.samps[,j]),xlab="Y",main="PPD")

   
   mu <- alpha1.mn[Xp[j,3]] + beta1.mn[Xp[j,3]]*Xp[j,1] + beta2.mn[Xp[j,3]]*Xp[j,2]   # use
   
   ypred[[j]]  <- rnorm(np, mu, sigma.mn)

   # make a prediction of d13 based on MU:
   
   
   
   d13func <- beta131.mn + beta132.mn*ypred[[j]]   # use
   d13pred[[j]]  <- d13func
   # Truth
   #abline(v=Y[j],col=3,lwd=2)

   #legend("topright",c("PPD","Plug-in","Truth"),col=1:3,lty=1,inset=0.05)
}

ypred.df <- do.call(rbind, ypred)
d13pred.df <- do.call(rbind, d13pred)
#ypred.yp.df <- do.call(rbind, ypred.yp)
png("outputs/growth_model/d13_reg_struct_x_cohort/predicted_y_d13.png")
par(mfrow = c(1,2))
plot(density(ypred.df), main = "Ypred, line = Ydata")
abline(v = mean(Y), col = "red")

plot(density(d13pred.df), main = "d13pred, line = d13data")
abline(v= mean(d13$Cor.d13C.suess), col = "red")
dev.off()

# need to calculate pvalues

pval113.d <- mean(d13pred.df > d13$Cor.d13C.suess) 


Xp$MeanY <- exp(rowMeans(ypred.df))
Xp$Meand13<- rowMeans(d13pred.df)# get the means of the posterior to plot the overall effects of 
Xp$struct.cohort <- ifelse(Xp$struct.cohort == 1, "Past-Forest",  
                       ifelse(Xp$struct.cohort == 2, "Modern-Forest",
                               ifelse(Xp$struct.cohort == 3, "Past-Savanna", 
                                       ifelse(Xp$struct.cohort == 4, "Modern-Savanna", NA))))
#DBH + DI on predicted growth

# Todo: unscale Drought and DBH indices

#png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_drought_struct_x_cohort.png")
ggplot(Xp, aes(Var1,MeanY, color = as.factor(struct.cohort)))+geom_point()+xlab("Drought Index")+ylab("predicted growth")
#dev.off()

#png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var2,MeanY,color = as.factor(struct.cohort)))+geom_point()+xlab("DBH Index")+ylab("predicted growth")
#dev.off()

#png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_drought_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~as.factor(struct.cohort))
#dev.off()






#png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_drought_struct_x_cohort.png")
ggplot(Xp, aes(Var1,Meand13, color = as.factor(struct.cohort)))+geom_point()+xlab("Drought Index")+ylab("predicted growth")+stat_smooth(method = "lm")
#dev.off()

#png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var2, Meand13, color = as.factor(struct.cohort)))+geom_point()+xlab("DBH Index")+ylab("predicted d13")+stat_smooth(method = "lm")
#dev.off()

#png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_drought_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = Meand13))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~as.factor(struct.cohort))
#dev.off()



```
# cohort only model:

```{r}
d13only_model_cohort_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){

 d13[i]   ~ dnorm(d13func[i], inv.var) # where Yi is already log transformed
 d13func[i] <- beta1[cohort[i]]

}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
}


# use normal hyperpriors for each hyperparamters 
mu_beta1 ~ dunif(-2, 2)


inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)


# Non-informative Prior for the inverse population variances
inv.var ~ dgamma(0.01, 0.01)
sigma <- 1/sqrt(inv.var)


# Prediction using testing data
for(i in 1:np){

 d13.p[i]   ~ dnorm(d13func.p[i], inv.var) # where Yi is already log transformed
 d13func.p[i] <- beta1[cohort.p[i]] 

}

}"


# read in the d13 data:


d13 <- read.csv("outputs/stable_isotopes/merged_d13_growth.csv")
d13 <- d13[!is.na(d13$DBH),]
Y.d13 <- log(d13$RWI)
#DI <- as.vector( full.ghcn$JJA.pdsi )
ageclass.d13 <- as.numeric( d13$ageclass)
Age.d13 <- as.numeric( d13$Age)
n.d13     <- length(d13$RWI)
DBH.d13 <- d13$DBH
d13$DBH.scaled = as.vector(scale(d13$DBH, center = TRUE, scale = TRUE))
d13$DI.scaled = as.vector(scale(d13$JJA.pdsi, center = TRUE, scale = TRUE))
site.d13 <- d13$site
SpecCode.d13 <- d13$SpecCode
plot.d13 <- unique(d13$site)

#need to define site level structures:
structure <- data.frame(site = c("AVO","BON","COR",  "ENG",  "GLA",  "GLL1", "GLL2", "GLL3","GLL4", "HIC",  "MOU",  "PLE",  "PVC",  "STC",  "TOW", "UNC" ),
                        structure = c("Forest", "Savanna", "Forest", "Forest", "Savanna", "Forest", "Savanna", "Savanna", "Forest", "Savanna", "Forest","Savanna", "Savanna", "Savanna", "Forest", "Savanna"))



#full.ghcn <- merge(full.ghcn, structure, by = "site")

full.ghcn$struct.cohort <- paste0(full.ghcn$ageclass,"-", full.ghcn$structure)
full.ghcn$struct.cohort.code <- ifelse(full.ghcn$struct.cohort %in% "Past-Forest", 1,
       ifelse(full.ghcn$struct.cohort %in% "Modern-Forest", 2, 
               ifelse(full.ghcn$struct.cohort %in% "Past-Savanna", 3,
                     ifelse(full.ghcn$struct.cohort %in% "Modern-Savanna", 4,"NA" ))))

full.ghcn <- merge(full.ghcn, d13[,c("site", "ID", "year","Cor.d13C.suess", "iWUE")], by = c("site", "ID", "year"), all.x = TRUE)


d13.model.only.by_cohort <- jags.model(textConnection(d13only_model_cohort_re), 
                    data = list( n=length(full.iso$DI.scaled), cohort = as.numeric(full.iso$ageclass), SF = unique(full.iso$ageclass), d13 = full.iso$Cor.d13C.suess,  np=length(test$DI.scaled),  cohort.p = as.numeric(test$ageclass)), n.chains = 3, n.adapt = 100)

update(d13.model.only.by_cohort, 1000); # Burnin for 1000 samples to start, then go higher later


d13.model.only.by_structure_x_cohort <- coda.samples(d13.model.only.by_cohort, 
                     variable.names=c("beta1","sigma", "d13.p"), 
                    n.chains = 3, n.iter = 20000, thin = 10)

summary(d13.model.only.by_structure_x_cohort)
plot(d13.model.only.by_structure_x_cohort)

gelman.diag(d13.model.only.by_structure_x_cohort)
acfplot(d13.model.only.by_structure_x_cohort)

#Extract the samples for each parameter for a basic exploration of effects

samps       <- d13.model.only.by_structure_x_cohort[[1]]
saveRDS(samps,"outputs/growth_model/d13_reg_cohort/samps.rds")
plot(d13.model.only.by_structure_x_cohort)

 
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 d13.samps <- samps[,1:length(test$site)]
 alpha.samps  <- samps[,1:2]
 


png("outputs/growth_model/d13_reg_cohort/marginal_alphas_v3.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Savanna")
hist(alpha.samps[,2], main = "alpha Modern-Savanna")

dev.off()




# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c("Modern", "Past")
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Intercepts for iWUE")


a.mplots <-ggplot(a.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.05)+theme_bw()+xlab("Estimated Drought Sensitivity")+theme_black(base_size = 18)+scale_fill_manual(values = c("Past"='#d73027',
"Modern"='#4575b4'))

a.mean <- apply(as.matrix(a[,1:2]), 2, mean)
a.lower <- apply(as.matrix(a[,1:2]), 2, function(x) quantile(x, probs = c(0.05)))
a.upper <- apply(as.matrix(a[,1:2]), 2, function(x) quantile(x, probs = c(0.95)))

## Combine both estimates
plot.dat.a <- data.frame(a.mean, a.lower, a.upper)
plot.dat.a$class <- row.names(plot.dat.a)
plot.dat.a$class <- factor(plot.dat.a$class, levels = c("Past", "Modern"))
a.dots <- ggplot(plot.dat.a, aes(x = a.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 2,height = 0)+geom_point()+xlim(-26, -22)+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='#d73027',
"Modern"='#4575b4'))+coord_flip()+theme(legend.position = "none")+xlab("d13C")

png(height = 5, width = 8, units = "in", res = 300, "outputs/growth_model/d13_reg_cohort/drougt_beta_marginal_distn_bycohort.png")
plot_grid(a.dots+xlim(-26,-22), a.mplots+coord_flip()+xlim(-26,-22)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()))
dev.off()


```
```{r}
iwueonly_model_cohort_re <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){

 d13[i]   ~ dnorm(d13func[i], inv.var) # where Yi is already log transformed
 d13func[i] <- beta1[cohort[i]]

}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
}


# use normal hyperpriors for each hyperparamters 
mu_beta1 ~ dunif(-2, 2)


inv_beta1   ~ dgamma(0.1, 0.1)
sigma_beta1 <- 1/sqrt(inv_beta1)


# Non-informative Prior for the inverse population variances
inv.var ~ dgamma(0.01, 0.01)
sigma <- 1/sqrt(inv.var)


# Prediction using testing data
for(i in 1:np){

 d13.p[i]   ~ dnorm(d13func.p[i], inv.var) # where Yi is already log transformed
 d13func.p[i] <- beta1[cohort.p[i]] 

}

}"


# read in the d13 data:


d13 <- read.csv("outputs/stable_isotopes/merged_d13_growth.csv")
d13 <- d13[!is.na(d13$DBH),]
Y.d13 <- log(d13$RWI)
#DI <- as.vector( full.ghcn$JJA.pdsi )
ageclass.d13 <- as.numeric( d13$ageclass)
Age.d13 <- as.numeric( d13$Age)
n.d13     <- length(d13$RWI)
DBH.d13 <- d13$DBH
d13$DBH.scaled = as.vector(scale(d13$DBH, center = TRUE, scale = TRUE))
d13$DI.scaled = as.vector(scale(d13$JJA.pdsi, center = TRUE, scale = TRUE))
site.d13 <- d13$site
SpecCode.d13 <- d13$SpecCode
plot.d13 <- unique(d13$site)
#need to define site level structures:
structure <- data.frame(site = c("AVO","BON","COR",  "ENG",  "GLA",  "GLL1", "GLL2", "GLL3","GLL4", "HIC",  "MOU",  "PLE",  "PVC",  "STC",  "TOW", "UNC" ),
                        structure = c("Forest", "Savanna", "Forest", "Forest", "Savanna", "Forest", "Savanna", "Savanna", "Forest", "Savanna", "Forest","Savanna", "Savanna", "Savanna", "Forest", "Savanna"))



#full.ghcn <- merge(full.ghcn, structure, by = "site")

full.ghcn$struct.cohort <- paste0(full.ghcn$ageclass,"-", full.ghcn$structure)
full.ghcn$struct.cohort.code <- ifelse(full.ghcn$struct.cohort %in% "Past-Forest", 1,
       ifelse(full.ghcn$struct.cohort %in% "Modern-Forest", 2, 
               ifelse(full.ghcn$struct.cohort %in% "Past-Savanna", 3,
                     ifelse(full.ghcn$struct.cohort %in% "Modern-Savanna", 4,"NA" ))))

full.ghcn <- merge(full.ghcn, d13[,c("site", "ID", "year","Cor.d13C.suess", "iWUE")], by = c("site", "ID", "year"), all.x = TRUE)


iwue.model.only.by_cohort <- jags.model(textConnection(iwueonly_model_cohort_re), 
                    data = list( n=length(full.iso$DI.scaled), cohort = as.numeric(full.iso$ageclass), SF = unique(full.iso$ageclass), d13 = full.iso$iWUE,  np=length(test$DI.scaled),  cohort.p = as.numeric(test$ageclass)), n.chains = 3, n.adapt = 100)

update(iwue.model.only.by_cohort, 1000); # Burnin for 1000 samples to start, then go higher later


iwue.model.only <- coda.samples(iwue.model.only.by_cohort, 
                     variable.names=c("beta1","sigma", "d13.p"), 
                    n.chains = 3, n.iter = 20000, thin = 10)

summary(iwue.model.only )
plot(iwue.model.only )

gelman.diag(iwue.model.only )
acfplot(iwue.model.only )

#Extract the samples for each parameter for a basic exploration of effects

samps       <- iwue.model.only[[1]]
saveRDS(samps,"outputs/growth_model/iwue_reg_cohort/samps.rds")
plot(d13.model.only.by_structure_x_cohort)

 
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 d13.samps <- samps[,1:length(test$site)]
 alpha.samps  <- samps[,1:2]
 


png("outputs/growth_model/iwue_reg_cohort/marginal_alphas_v3.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Savanna")
hist(alpha.samps[,2], main = "alpha Modern-Savanna")

dev.off()




# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c("Modern", "Past")
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("Estimated iWUE")


a.mplots <-ggplot(a.m, aes(value,1, fill = variable))+stat_density_ridges(alpha = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975), bandwidth  = 0.5)+theme_bw()+xlab("Estimated iWUE")+theme_black(base_size = 18)+scale_fill_manual(values = c("Past"='#d73027',
"Modern"='#4575b4'))

a.mean <- apply(as.matrix(a[,1:2]), 2, mean)
a.lower <- apply(as.matrix(a[,1:2]), 2, function(x) quantile(x, probs = c(0.05)))
a.upper <- apply(as.matrix(a[,1:2]), 2, function(x) quantile(x, probs = c(0.95)))

## Combine both estimates
plot.dat.a <- data.frame(a.mean, a.lower, a.upper)
plot.dat.a$class <- row.names(plot.dat.a)
plot.dat.a$class <- factor(plot.dat.a$class, levels = c("Past", "Modern"))
a.dots <- ggplot(plot.dat.a, aes(x = a.mean, y = class, color = class, size = 2))+geom_errorbarh( xmin = a.lower, xmax = a.upper, size = 2,height = 0)+geom_point()+xlim(115, 160)+theme_black(base_size = 18)+scale_color_manual(values = c("Past"='#d73027',
"Modern"='#4575b4'))+coord_flip()+theme(legend.position = "none")+xlab("iWUE")

png(height = 5, width = 8, units = "in", res = 300, "outputs/growth_model/iwue_reg_cohort/drougt_beta_marginal_distn_bycohort.png")
plot_grid(a.dots+xlim(115, 160), a.mplots+coord_flip()+xlim(115, 160)+ylab("frequency")+theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()))
dev.off()


```


# model growth and response to climate as a function of WUE:

```{r}
wue_model_structure_x_cohort_re_plot_effects <- "model{

# for each the overall population include re for sites:

# Likelihood
for(i in 1:n){

 iWUE[i]   ~ dnorm(gfunc[i], inv.var) # where Yi is already log transformed
 gfunc[i] <- beta1[struct.cohort[i]] + beta2[struct.cohort[i]]*DI.scaled[i] + beta3[struct.cohort[i]]*DBH.scaled[i] + beta4[struct.cohort[i]]*VPD.max.scaled[i] 

}


# Assume normal priors for betas, but generate a beta + alpha for each ageclass
for(s in 1:length(SF)){
beta1[s] ~ dnorm(mu_beta1, inv_beta1)
beta2[s] ~ dnorm(mu_beta2, inv_beta2)
beta3[s] ~ dnorm(mu_beta3, inv_beta3)
beta4[s] ~ dnorm(mu_beta4, inv_beta4)

#mu_beta2[s] <- gam*exp(v*iWUE.dist[s])
#iWUE.dist[s] ~ dnorm(iWUE.data[s], sigma.WUE[s])

#gam ~ dnorm(0, 0.01)
#v ~ dnorm(0, 0.01)

}


#gam ~ dnorm(0, 0.01)
#v ~ dnorm(0, 0.01)

# use normal hyperpriors for each hyperparamters 
mu_beta1 ~ dunif(-2, 2)
mu_beta2 ~ dunif(-2, 2)
mu_beta3 ~ dunif(-2, 2)
mu_beta4 ~ dunif(-2, 2)
mu_beta5 ~ dunif(-2, 2)


inv_beta1   ~ dgamma(0.01, 0.01)
sigma_beta1 <- 1/sqrt(inv_beta1)
inv_beta2   ~ dgamma(0.01, 0.01)
sigma_beta2 <- 1/sqrt(inv_beta2)
inv_beta3   ~ dgamma(0.01, 0.01)
sigma_beta3 <- 1/sqrt(inv_beta3)
inv_beta4   ~ dgamma(0.01, 0.01)
sigma_beta4 <- 1/sqrt(inv_beta4)
inv_beta5   ~ dgamma(0.01, 0.01)
sigma_beta5 <- 1/sqrt(inv_beta5)

# Non-informative Prior for the inverse population variances
inv.var ~ dgamma(0.01, 0.01)
sigma <- 1/sqrt(inv.var)




}"


# read in the d13 data:


d13 <- read.csv("outputs/stable_isotopes/merged_d13_growth.csv")
d13 <- d13[!is.na(d13$DBH),]
Y.d13 <- log(d13$RWI)
#DI <- as.vector( full.ghcn$JJA.pdsi )
ageclass.d13 <- as.numeric( d13$ageclass)
Age.d13 <- as.numeric( d13$Age)
n.d13     <- length(d13$RWI)
DBH.d13 <- d13$DBH
d13$DBH.scaled = as.vector(scale(d13$DBH, center = TRUE, scale = TRUE))
d13$DI.scaled = as.vector(scale(d13$JJA.pdsi, center = TRUE, scale = TRUE))
site.d13 <- d13$site
SpecCode.d13 <- d13$SpecCode
plot.d13 <- unique(d13$site)


iwue.df<- full.ghcn %>% group_by(struct.cohort, struct.cohort.code) %>% summarise(iWUE.dat = median(iWUE, na.rm=TRUE), iwue.sd = sd(iWUE, na.rm = TRUE))

train.df <- merge(iwue.df, train, by = c("struct.cohort", "struct.cohort.code"))
#need to define site level structures:
structure <- data.frame(site = c("AVO","BON","COR",  "ENG",  "GLA",  "GLL1", "GLL2", "GLL3","GLL4", "HIC",  "MOU",  "PLE",  "PVC",  "STC",  "TOW", "UNC" ),
                        structure = c("Forest", "Savanna", "Forest", "Forest", "Savanna", "Forest", "Savanna", "Savanna", "Forest", "Savanna", "Forest","Savanna", "Savanna", "Savanna", "Forest", "Savanna"))



#full.ghcn <- merge(full.ghcn, structure, by = "site")

full.ghcn$struct.cohort <- paste0(full.ghcn$ageclass,"-", full.ghcn$structure)
full.ghcn$struct.cohort.code <- ifelse(full.ghcn$struct.cohort %in% "Past-Forest", 1,
       ifelse(full.ghcn$struct.cohort %in% "Modern-Forest", 2, 
               ifelse(full.ghcn$struct.cohort %in% "Past-Savanna", 3,
                     ifelse(full.ghcn$struct.cohort %in% "Modern-Savanna", 4,"NA" ))))

full.ghcn <- merge(full.ghcn, d13[,c("site", "ID", "year","Cor.d13C.suess", "iWUE")], by = c("site", "ID", "year"), all.x = TRUE)

d13index <- !is.na(full.ghcn$Cor.d13C.suess)
# generate fake data to predict on:
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  struct.cohort= 1:4)
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:





 Xp <- full.probe
 np <- length(Xp$Var1)


d13.model.only.by_structure_x_cohort <- jags.model(textConnection(growth_wue_model_structure_x_cohort_re), 
                    data = list( n=length(train$DI.scaled), DI.scaled = train$DI.scaled, DBH.scaled = train$DBH.scaled, struct.cohort = as.numeric(train$struct.cohort.code), SF = unique(train$struct.cohort.code), Y = log(train$RWI), VPD.max.scaled= train$jul.VPDmax.scaled, iWUE.data = train.df$iWUE.dat, sigma.WUE = train.df$iwue.sd ), n.chains = 3, n.adapt = 100)

update(growth_wue_model_structure_x_cohort_re, 100); # Burnin for 1000 samples to start, then go higher later


d13.model.only.by_structure_x_cohort <- coda.samples(growth_wue_model_structure_x_cohort_re, 
                     variable.names=c("beta1", "beta2","beta3","beta4", "sigma_beta1", "sigma_beta2","sigma_beta3", "sigma_beta4", "v", "gam", "mu_beta2"), 
                    n.chains = 3, n.iter = 20000, thin = 10)

summary(d13.model.only.by_structure_x_cohort)
plot(d13.model.only.by_structure_x_cohort)

gelman.diag(d13.model.only.by_structure_x_cohort)
acfplot(d13.model.only.by_structure_x_cohort)

#Extract the samples for each parameter for a basic exploration of effects

samps       <- d13.model.only.by_structure_x_cohort[[1]]
saveRDS(samps,"outputs/growth_model/wue_reg_struct_x_cohort/samps.rds")
plot(d13.model.only.by_structure_x_cohort)

 
 #Yp.samps <- samps[,1:660] # one alpha for each of 16 sites
 alpha.samps  <- samps[,1:4]
 beta2.samps <- samps[,5:8]
 beta3.samps <- samps[,9:12]
 beta4.samps <- samps[,13:16]
 sigma.samps <- samps[,17:20]
 #sigma13.samps <- samps[,15]
 #sigma_betas <- samps[,16:18]

 #betad131.samps <- samps[,1]
 #betad132.samps <- samps[,2]


png("outputs/growth_model/wue_reg_struct_x_cohort/marginal_alphas_v3.png")
par(mfrow=c(3,2))
hist(alpha.samps[,1], main = "alpha Past-Savanna")
hist(alpha.samps[,2], main = "alpha Modern-Savanna")
hist(alpha.samps[,3],  main = "alpha Past-Forest")
hist(alpha.samps[,4],  main = "alpha Modern-Forest")
hist(sigma_betas[,1], main = "sigma alpha")
dev.off()

png("outputs/growth_model/wue_reg_struct_x_cohort/marginal_beta1s_v3.png")
par(mfrow=c(3,2))
hist(beta1.samps[,1], main = "beta2 Past-Savanna")
hist(beta1.samps[,2], main = "beta2 Modern-Savanna")
hist(beta1.samps[,3],  main = "beta2 Past-Forest")
hist(beta1.samps[,4],  main = "beta2 Modern-Forest")
hist(sigma_betas[,2], main = "sigma beta2")
dev.off()

png("outputs/growth_model/wue_reg_struct_x_cohort/marginal_beta2s_v3.png")
par(mfrow=c(3,2))
hist(beta2.samps[,1], main = "beta3 Past-Savanna")
hist(beta2.samps[,2], main = "beta3 Modern-Savanna")
hist(beta2.samps[,3],  main = "beta3 Past-Forest")
hist(beta2.samps[,4],  main = "beta3 Modern-Forest")
hist(sigma_betas[,3], main = "sigma beta3")
dev.off()


# plot marginal distributions of cohort + structure specific parameters:
a <- data.frame(alpha.samps)
colnames(a) <- c(paste0("alpha-",c(unique(train$struct.cohort))))
a$num <- rownames(a)
a.m <- melt(a, id.vars=c("num"))
alpha.mplots <- ggplot(a.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()++xlab("Intercepts for iWUE")


b2 <- data.frame(beta2.samps)
colnames(b2) <- c(paste0("beta2-",c(unique(train$struct.cohort))))
b2$num <- rownames(b2)
b2.m <- melt(b2, id.vars=c("num"))
b2.mplots <- ggplot(b2.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("effect of Summer Drought")


b3 <- data.frame(beta3.samps)
colnames(b3) <- c(paste0("beta3-",c(unique(train$struct.cohort))))
b3$num <- rownames(b3)
b3.m <- melt(b3, id.vars=c("num"))
b3.mplots <- ggplot(b3.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("effect of Tree DBH")

b4 <- data.frame(beta4.samps)
colnames(b4) <- c(paste0("beta4-",c(unique(train$struct.cohort))))
b4$num <- rownames(b4)
b4.m <- melt(b4, id.vars=c("num"))
b4.mplots <- ggplot(b4.m, aes(value, fill = variable))+geom_density(alpha = 0.5)+theme_bw()+xlab("effect of July VPD")


library(cowplot)
png(width = 4, height = 8, units = "in", res = 300, "outputs/growth_model/wue_reg_struct_x_cohort/param_marginal_distn_bycohort_struct_v3.png")
plot_grid(alpha.mplots, b2.mplots, b3.mplots,b4.mplots, ncol = 1)
dev.off()


# Compute the posterior mean for the plug-in predictions  

 beta1.mn  <- colMeans(beta1.samps)
 beta2.mn  <- colMeans(beta2.samps)
 sigma.mn <- mean(sigma.samps)
 alpha1.mn <- colMeans(alpha.samps) 
beta131.mn <- mean(betad131.samps) 
beta132.mn <- mean(betad132.samps) 


# Plot the plug-in Posterior predictive denisty using "fake data"
# want to plaot posteror predictive distributions:
 
# can probe either within the JAGS model or in R after the model runs:
 # specify "x probe" values for DBH + DI:
 #xprobe <- matrix(rep(-2.102618, 3.321394))
 DIprobe <- seq(range(DI.scaled)[1], range(DI.scaled)[2], by = 0.5)
 DBHprobe <- seq(range(DBH.scaled)[1], range(DBH.scaled)[2], by = 0.5)
 
 # something like:
full.probe <- expand.grid(DIprobe, DBHprobe,  struct.cohort= 1:4)
 # use these vals to get ypred
 # compare y pred to y acutal
 # for each value of DI and DBH and site, find the predicted growth based on the model:





 Xp <- full.probe
 np <- length(Xp$Var1)
 ypred <- list()

 d13pred <- list()
 for(j in 1:np){

   # PPD
   #plot(density(Yp.samps[,j]),xlab="Y",main="PPD")

   
   mu <- alpha1.mn[Xp[j,3]] + beta1.mn[Xp[j,3]]*Xp[j,1] + beta2.mn[Xp[j,3]]*Xp[j,2]   # use
   
   ypred[[j]]  <- rnorm(np, mu, sigma.mn)

   # make a prediction of d13 based on MU:
   
   
   
   d13func <- beta131.mn + beta132.mn*ypred[[j]]   # use
   d13pred[[j]]  <- d13func
   # Truth
   #abline(v=Y[j],col=3,lwd=2)

   #legend("topright",c("PPD","Plug-in","Truth"),col=1:3,lty=1,inset=0.05)
}

ypred.df <- do.call(rbind, ypred)
d13pred.df <- do.call(rbind, d13pred)
#ypred.yp.df <- do.call(rbind, ypred.yp)
png("outputs/growth_model/d13_reg_struct_x_cohort/predicted_y_d13.png")
par(mfrow = c(1,2))
plot(density(ypred.df), main = "Ypred, line = Ydata")
abline(v = mean(Y), col = "red")

plot(density(d13pred.df), main = "d13pred, line = d13data")
abline(v= mean(d13$Cor.d13C.suess), col = "red")
dev.off()

# need to calculate pvalues

pval113.d <- mean(d13pred.df > d13$Cor.d13C.suess) 


Xp$MeanY <- exp(rowMeans(ypred.df))
Xp$Meand13<- rowMeans(d13pred.df)# get the means of the posterior to plot the overall effects of 
Xp$struct.cohort <- ifelse(Xp$struct.cohort == 1, "Past-Forest",  
                       ifelse(Xp$struct.cohort == 2, "Modern-Forest",
                               ifelse(Xp$struct.cohort == 3, "Past-Savanna", 
                                       ifelse(Xp$struct.cohort == 4, "Modern-Savanna", NA))))
#DBH + DI on predicted growth

# Todo: unscale Drought and DBH indices

#png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_drought_struct_x_cohort.png")
ggplot(Xp, aes(Var1,MeanY, color = as.factor(struct.cohort)))+geom_point()+xlab("Drought Index")+ylab("predicted growth")
#dev.off()

#png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var2,MeanY,color = as.factor(struct.cohort)))+geom_point()+xlab("DBH Index")+ylab("predicted growth")
#dev.off()

#png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_drought_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = MeanY))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~as.factor(struct.cohort))
#dev.off()






#png(height = 4, width = 6, units = "in", res = 200,filename= "/Users/kah/Documents/TreeRings/outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_drought_struct_x_cohort.png")
ggplot(Xp, aes(Var1,Meand13, color = as.factor(struct.cohort)))+geom_point()+xlab("Drought Index")+ylab("predicted growth")+stat_smooth(method = "lm")
#dev.off()

#png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var2, Meand13, color = as.factor(struct.cohort)))+geom_point()+xlab("DBH Index")+ylab("predicted d13")+stat_smooth(method = "lm")
#dev.off()

#png(height = 4, width = 6, units = "in", res = 200,"outputs/growth_model/basic_reg_struct_x_cohort_re/Ypred_by_drought_DBH_struct_x_cohort.png")
ggplot(Xp, aes(Var1, Var2, fill = Meand13))+geom_raster()+xlab("Drought Index")+ylab("DBH Index")+scale_fill_distiller(palette = "BrBG", direction = -1)+facet_wrap(~as.factor(struct.cohort))
#dev.off()



```








